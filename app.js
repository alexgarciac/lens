!function t(e,i,n){function s(o,a){if(!i[o]){if(!e[o]){var l="function"==typeof require&&require;if(!a&&l)return l(o,!0);if(r)return r(o,!0);var u=new Error("Cannot find module '"+o+"'");throw u.code="MODULE_NOT_FOUND",u}var c=i[o]={exports:{}};e[o][0].call(c.exports,function(t){var i=e[o][1][t];return s(i?i:t)},c,c.exports,t,e,i,n)}return i[o].exports}for(var r="function"==typeof require&&require,o=0;o<n.length;o++)s(n[o]);return s}({1:[function(t,e,i){"use strict";function n(t,e){o.call(this,t,e),this.handleApplicationKeyCombos=this.handleApplicationKeyCombos.bind(this),this.actions({switchState:this.switchState,switchContext:this.switchContext,toggleBibItem:this.toggleBibItem})}var s=t("substance/util/helpers"),r=t("substance/util/oo"),o=t("substance/ui/Controller"),a=t("./packages/bibliography/CrossrefSearch"),l=t("substance/ui/Component"),u=l.$$,c=t("substance/util/jquery"),h=t("substance/ui/i18n");h.instance.load(t("substance/i18n/en")),h.instance.load(t("./i18n/en")),n.Prototype=function(){this.toggleBibItem=function(t){this.state.bibItemId===t.id?this.setState({contextId:"bib-items"}):this.setState({contextId:"bib-items",bibItemId:t.id})},this.getChildContext=function(){var t=o.prototype.getChildContext.call(this);return s.extend(t,{bibSearchEngines:[new a],i18n:h.instance,embedResolver:function(t,e){c.get("http://iframe.ly/api/iframely?url="+encodeURIComponent(t)+"&api_key=712fe98e864c79e054e2da").success(function(t){e(null,t.html)}).error(function(t){e(t)})}})},this.getInitialState=function(){return{contextId:"toc"}},this.switchState=function(t,e){e=e||{},this.setState(t),e.restoreSelection&&this.restoreSelection()},this.switchContext=function(t,e){e=e||{},this.setState({contextId:t}),e.restoreSelection&&this.restoreSelection()},this.restoreSelection=function(){var t=this.getSurface("body");t.rerenderDomSelection()},this._panelPropsFromState=function(t){var e=s.omit(t,"contextId");return e.doc=this.props.doc,e},this.getActivePanelElement=function(){var t=this.componentRegistry.get(this.state.contextId);return t?u(t,this._panelPropsFromState(this.state)).ref("contextPanel"):void console.warn("Could not find component for contextId:",this.state.contextId)},this.uploadFile=function(t,e){if(this.props.onUploadFile)return this.props.onUploadFile(t,e);var i=window.URL.createObjectURL(t);e(null,i)},this.renderContextPanel=function(){var t=this.getActivePanelElement();return t?u("div").append(t):u("div").append("No panels are registered")},this.handleStateUpdate=function(t){function e(t){if(t.citationId){var e=i.get(t.citationId).targets;return[t.citationId].concat(e)}if(t.bibItemId){var n=Object.keys(i.citationsIndex.get(t.bibItemId));return n}return[]}var i=this.getDocument(),n=e(t);setTimeout(function(){i.setHighlights(n)},0)}},r.inherit(n,o),e.exports=n},{"./i18n/en":6,"./packages/bibliography/CrossrefSearch":330,"substance/i18n/en":53,"substance/ui/Component":279,"substance/ui/Controller":284,"substance/ui/i18n":309,"substance/util/helpers":315,"substance/util/jquery":316,"substance/util/oo":317}],2:[function(t,e,i){"use strict";function n(t,e){r.call(this,t,e),this.connect(this,{"citation:selected":this.onCitationSelected})}var s=t("substance/util/oo"),r=t("./LensController"),o=t("substance/ui/ContextToggles"),a=t("substance/ui/ContentPanel"),l=t("substance/ui/StatusBar"),u=t("./packages/bibliography/BibliographyComponent"),c=t("substance/ui/ContainerAnnotator"),h=t("./packages/reader/Cover"),p=t("substance/ui/Component"),d=p.$$,f={controller:{commands:[t("substance/ui/UndoCommand"),t("substance/ui/RedoCommand"),t("substance/ui/SaveCommand")],components:{paragraph:t("substance/packages/paragraph/ParagraphComponent"),heading:t("substance/packages/heading/HeadingComponent"),blockquote:t("substance/packages/blockquote/BlockquoteComponent"),codeblock:t("substance/packages/codeblock/CodeblockComponent"),embed:t("substance/packages/embed/EmbedComponent"),image:t("substance/packages/image/ImageComponent"),table:t("substance/packages/table/TableComponent"),"image-figure":t("substance/packages/figure/FigureComponent"),"table-figure":t("substance/packages/figure/FigureComponent"),"bib-item-citation":t("./packages/citations/CitationComponent"),"image-figure-citation":t("./packages/citations/CitationComponent"),"table-figure-citation":t("./packages/citations/CitationComponent"),toc:t("substance/ui/TocPanel"),cite:t("./packages/citations/CitePanel"),"bib-items":t("./packages/bibliography/BibItemsPanel"),"cite-bib-item":t("./packages/citations/CitePanel"),"cite-image-figure":t("./packages/citations/CitePanel"),"cite-table-figure":t("./packages/citations/CitePanel"),"bib-item-entry":t("./packages/bibliography/BibItemEntry"),"image-figure-entry":t("./packages/figures/ImageFigureEntry"),"table-figure-entry":t("./packages/figures/TableFigureEntry")}},main:{commands:[]},cover:{commands:[]},panelOrder:["toc","bib-items"],containerId:"main",isEditable:!1};n.Prototype=function(){this["static"]={config:f},this.onCitationSelected=function(t){return this.state.citationId===t.id?void this.setState({contextId:"toc"}):void("bib-item-citation"===t.type?this.setState({contextId:"bib-items",citationId:t.id}):this.setState({contextId:"toc",citationId:t.id}))},this.dispose=function(){r.prototype.dispose.call(this),this.disconnect(this)},this.render=function(){var t=this.props.doc,e=this.getConfig(),i=d("div").addClass("lc-reader sc-controller");return i.append(d("div").ref("workspace").addClass("le-workspace").append(d("div").ref("main").addClass("le-main").append(d(a).append(d(h,{name:"cover",commands:e.cover.commands}).ref("coverView"),d("div").ref("main").addClass("document-content").append(d(c,{name:"main",containerId:"main",editable:!1,commands:e.main.commands}).ref("mainAnnotator")),d(u).ref("bib")).ref("content")),d("div").ref("resource").addClass("le-resource").append(d(o,{panelOrder:e.panelOrder,contextId:this.state.contextId}).ref("context-toggles"),this.renderContextPanel()))),i.append(d(l,{doc:t}).ref("statusBar")),i}},s.inherit(n,r),e.exports=n},{"./LensController":1,"./packages/bibliography/BibItemEntry":324,"./packages/bibliography/BibItemsPanel":325,"./packages/bibliography/BibliographyComponent":327,"./packages/citations/CitationComponent":337,"./packages/citations/CitePanel":338,"./packages/figures/ImageFigureEntry":343,"./packages/figures/TableFigureEntry":346,"./packages/reader/Cover":349,"substance/packages/blockquote/BlockquoteComponent":232,"substance/packages/codeblock/CodeblockComponent":235,"substance/packages/embed/EmbedComponent":239,"substance/packages/figure/FigureComponent":245,"substance/packages/heading/HeadingComponent":249,"substance/packages/image/ImageComponent":254,"substance/packages/paragraph/ParagraphComponent":262,"substance/packages/table/TableComponent":268,"substance/ui/Component":279,"substance/ui/ContainerAnnotator":280,"substance/ui/ContentPanel":282,"substance/ui/ContextToggles":283,"substance/ui/RedoCommand":291,"substance/ui/SaveCommand":293,"substance/ui/StatusBar":297,"substance/ui/TocPanel":303,"substance/ui/UndoCommand":306,"substance/util/oo":317}],3:[function(t,e,i){"use strict";function n(t,e){r.call(this,t,e)}var s=t("substance/util/oo"),r=t("./LensController"),o=t("substance/ui/ContextToggles"),a=t("substance/ui/ContentPanel"),l=t("substance/ui/StatusBar"),u=t("./packages/bibliography/BibliographyComponent"),c=t("./packages/writer/CoverEditor"),h=t("./packages/writer/ContentToolbar"),p=t("substance/ui/ContainerEditor"),d=t("substance/model/documentHelpers"),f=t("substance/ui/Component"),m=f.$$,g={controller:{commands:[t("substance/ui/UndoCommand"),t("substance/ui/RedoCommand"),t("substance/ui/SaveCommand")],components:{paragraph:t("substance/packages/paragraph/ParagraphComponent"),heading:t("substance/packages/heading/HeadingComponent"),blockquote:t("substance/packages/blockquote/BlockquoteComponent"),codeblock:t("substance/packages/codeblock/CodeblockComponent"),embed:t("substance/packages/embed/EmbedComponent"),image:t("substance/packages/image/ImageComponent"),table:t("substance/packages/table/TableComponent"),"image-figure":t("substance/packages/figure/FigureComponent"),"table-figure":t("substance/packages/figure/FigureComponent"),"bib-item-citation":t("./packages/citations/CitationComponent"),"image-figure-citation":t("./packages/citations/CitationComponent"),"table-figure-citation":t("./packages/citations/CitationComponent"),toc:t("substance/ui/TocPanel"),cite:t("./packages/citations/CitePanel"),"bib-items":t("./packages/bibliography/BibItemsPanel"),"cite-bib-item":t("./packages/citations/CitePanel"),"cite-image-figure":t("./packages/citations/CitePanel"),"cite-table-figure":t("./packages/citations/CitePanel"),"bib-item-entry":t("./packages/bibliography/BibItemEntry"),"image-figure-entry":t("./packages/figures/ImageFigureEntry"),"table-figure-entry":t("./packages/figures/TableFigureEntry")}},main:{commands:[t("substance/ui/SelectAllCommand"),t("substance/packages/embed/EmbedCommand"),t("substance/packages/paragraph/MakeParagraphCommand"),t("substance/packages/heading/MakeHeading1Command"),t("substance/packages/heading/MakeHeading2Command"),t("substance/packages/heading/MakeHeading3Command"),t("substance/packages/blockquote/MakeBlockquoteCommand"),t("substance/packages/codeblock/MakeCodeblockCommand"),t("substance/packages/text/SwitchTextTypeCommand"),t("substance/packages/strong/StrongCommand"),t("substance/packages/emphasis/EmphasisCommand"),t("substance/packages/link/LinkCommand"),t("substance/packages/figure/InsertFigureCommand"),t("./packages/bibliography/BibItemCitationCommand"),t("./packages/figures/ImageFigureCitationCommand")],textTypes:[{type:"heading",level:1},{type:"heading",level:2},{type:"heading",level:3},{type:"codeblock"}]},cover:{commands:[t("substance/packages/emphasis/EmphasisCommand")]},panelOrder:["toc","bib-items"],containerId:"main",isEditable:!0};n.Prototype=function(){this["static"]={config:g},this.render=function(){var t=this.props.doc,e=this.getConfig(),i=m("div").addClass("lc-writer sc-controller");return i.append(m("div").ref("workspace").addClass("le-workspace").append(m("div").ref("main").addClass("le-main").append(m(h).ref("toolbar"),m(a).append(m(c,{name:"cover",commands:e.cover.commands}).ref("coverEditor"),m("div").ref("main").addClass("document-content").append(m(p,{name:"main",containerId:e.containerId,editable:!1,commands:e.main.commands}).ref("mainEditor")),m(u).ref("bib")).ref("content")),m("div").ref("resource").addClass("le-resource").append(m(o,{panelOrder:e.panelOrder,contextId:this.state.contextId}).ref("context-toggles"),this.renderContextPanel()))),i.append(m(l,{doc:t}).ref("statusBar")),i},this.onSelectionChanged=function(t,e){function i(e){return d.getAnnotationsForSelection(n,t,e,"main")[0]}if("main"===e.name&&!t.isNull()&&t.isPropertySelection()&&!t.equals(this.prevSelection)){this.prevSelection=t;var n=e.getDocument(),s=i("citation");if(s&&s.getSelection().equals(t)){var r=s.type.replace("-citation","").replace("_","-");this.setState({contextId:"cite-"+r,citationType:r,citationId:s.id})}else"toc"!==this.state.contextId&&this.setState({contextId:"toc"})}}},s.inherit(n,r),e.exports=n},{"./LensController":1,"./packages/bibliography/BibItemCitationCommand":321,"./packages/bibliography/BibItemEntry":324,"./packages/bibliography/BibItemsPanel":325,"./packages/bibliography/BibliographyComponent":327,"./packages/citations/CitationComponent":337,"./packages/citations/CitePanel":338,"./packages/figures/ImageFigureCitationCommand":341,"./packages/figures/ImageFigureEntry":343,"./packages/figures/TableFigureEntry":346,"./packages/writer/ContentToolbar":350,"./packages/writer/CoverEditor":351,"substance/model/documentHelpers":93,"substance/packages/blockquote/BlockquoteComponent":232,"substance/packages/blockquote/MakeBlockquoteCommand":233,"substance/packages/codeblock/CodeblockComponent":235,"substance/packages/codeblock/MakeCodeblockCommand":236,"substance/packages/embed/EmbedCommand":238,"substance/packages/embed/EmbedComponent":239,"substance/packages/emphasis/EmphasisCommand":242,"substance/packages/figure/FigureComponent":245,"substance/packages/figure/InsertFigureCommand":246,"substance/packages/heading/HeadingComponent":249,"substance/packages/heading/MakeHeading1Command":250,"substance/packages/heading/MakeHeading2Command":251,"substance/packages/heading/MakeHeading3Command":252,"substance/packages/image/ImageComponent":254,"substance/packages/link/LinkCommand":256,"substance/packages/paragraph/MakeParagraphCommand":260,"substance/packages/paragraph/ParagraphComponent":262,"substance/packages/strong/StrongCommand":264,"substance/packages/table/TableComponent":268,"substance/packages/text/SwitchTextTypeCommand":272,"substance/ui/Component":279,"substance/ui/ContainerEditor":281,"substance/ui/ContentPanel":282,"substance/ui/ContextToggles":283,"substance/ui/RedoCommand":291,"substance/ui/SaveCommand":293,"substance/ui/SelectAllCommand":296,"substance/ui/StatusBar":297,"substance/ui/TocPanel":303,"substance/ui/UndoCommand":306,"substance/util/oo":317}],4:[function(t,e,i){"use strict";function n(){r.Root.apply(this,arguments),this.backend=new a}var s=t("substance/util/oo"),r=t("substance/ui/Component"),o=r.$$,a=t("./backend"),l=t("substance/util/jquery"),u=t("../LensWriter"),c=t("../LensReader");n.Prototype=function(){this.openReader=function(){this.extendState({mode:"read"})},this.openWriter=function(){this.extendState({mode:"write"})},this.render=function(){var t=o("div").addClass("app");if(t.append(o("div").addClass("menu").append(o("button").addClass("write"===this.state.mode?"active":"").on("click",this.openWriter).append("Write"),o("button").addClass("read"===this.state.mode?"active":"").on("click",this.openReader).append("Read"))),this.state.doc){var e;e="write"===this.state.mode?o(u,{doc:this.state.doc,onUploadFile:function(t,e){console.log("custom file upload handler in action...");var i=window.URL.createObjectURL(t);e(null,i)},onSave:function(t,e,i){console.log("custom save handler in action...",t.toXml()),i(null)}}).ref("writer"):o(c,{doc:this.state.doc}).ref("reader"),t.append(o("div").addClass("context").append(e))}return t},this.didMount=function(){this.backend.getDocument("sample",function(t,e){this.setState({mode:"write",doc:e})}.bind(this))}},s.inherit(n,r),l(function(){r.mount(o(n),l("#container"))})},{"../LensReader":2,"../LensWriter":3,"./backend":5,"substance/ui/Component":279,"substance/util/jquery":316,"substance/util/oo":317}],5:[function(t,e,i){var n=t("../model/LensArticle"),s=t("substance/util/oo"),r=t("substance/util/jquery"),o=function(){};o.Prototype=function(){this._request=function(t,e,i,n){var s={type:t,url:e,contentType:"application/json; charset=UTF-8",success:function(t){n(null,t)},error:function(t){console.error(t),n(t.responseText)}};i&&(s.data=JSON.stringify(i));var o=localStorage.getItem("session");if(o){var a=JSON.parse(o).token;s.beforeSend=function(t){t.setRequestHeader("Authorization","Bearer "+a)}}r.ajax(s)},this.getDocument=function(t,e){this._request("GET","data/example-doc.xml",null,function(t,i){t&&(console.error(t),e(t));var s=n.fromXml(i);window.doc=s,e(null,s)})},this.saveDocument=function(t,e){e("Not supported in dev version")},this.uploadFigure=function(t,e){var i=window.URL.createObjectURL(t);e(null,i)}},s.initClass(o),e.exports=o},{"../model/LensArticle":11,"substance/util/jquery":316,"substance/util/oo":317}],6:[function(t,e,i){e.exports={enter_search_term:"Enter search term",choose_referenced_items:"Choose referenced items",no_items_found:"No items found.",add_references:"Add references",figure:"Figure",insert:"Insert",cite:"Cite",bib_item:"Reference",manage:"Manage",add_reference:"Add References","bib-items":"References","embed-src":"Embed URL"}},{}],7:[function(t,e,i){function n(){n["super"].call(this,{schema:o})}var s=t("lodash/collection/forEach"),r=t("substance/model/HtmlExporter"),o=t("./articleSchema"),a=t("substance/util/oo"),l=t("substance/util/jquery");n.Prototype=function(){this.convert=function(t,e){this.initialize(t,e);var i=this.createHtmlDocument(),n=i.find("head");n.append(l("<!-- title is only there to calm down the validator. do not edit -->")).append(l("<title>🐰</title>")).append(l('<meta charset="utf-8" />'));var s=i.find("body");return s.append(this.header()),s.append(this.main()),["<!DOCTYPE html>",'<html lang="en">',i.find("html").html(),"</html>"].join("")},this.header=function(){var t=this.state.doc,e=l("<header>"),i=t.get("article-meta");e.append(i.toHtml(this));var n=t.getIndex("type").get("image-figure");s(n,function(t){e.append(t.toHtml(this))},this);var r=t.getIndex("type").get("table-figure");s(r,function(t){e.append(t.toHtml(this))},this);var o=t.getIndex("type").get("bib-item");return s(o,function(t){e.append(t.toHtml(this))},this),e},this.main=function(){var t=this.state.doc,e=t.get("main"),i=l("<main>").append(this.convertContainer(e));return i}},a.inherit(n,r),e.exports=n},{"./articleSchema":12,"lodash/collection/forEach":14,"substance/model/HtmlExporter":70,"substance/util/jquery":316,"substance/util/oo":317}],8:[function(t,e,i){function n(){n["super"].call(this,{schema:o})}var s=t("substance/util/oo"),r=t("substance/model/HtmlImporter"),o=t("./articleSchema");n.Prototype=function(){this.convert=function(t,e){this.initialize(e,t);var i=t.find("meta");if(!i.length)throw new Error("meta is mandatory");var n=t.find("resources");if(!n.length)throw new Error("resources is mandatory");var s=t.find("body");if(!s.length)throw new Error("body is mandatory");this.meta(i),this.resources(n),this.body(s),this.finish()},this.meta=function(t){this.convertElement(t)},this.resources=function(t){var e=this;t.children().each(function(){var t=e.$(this);e.convertElement(t)})},this.body=function(t){this.convertContainer(t,"main")}},s.inherit(n,r),e.exports=n},{"./articleSchema":12,"substance/model/HtmlImporter":71,"substance/util/oo":317}],9:[function(t,e,i){function n(){n["super"].call(this,{schema:l})}var s=t("substance/util/helpers"),r=t("substance/util/oo"),o=t("substance/util/jquery"),a=t("substance/model/HtmlExporter"),l=t("./articleSchema");n.Prototype=function(){this.convert=function(t,e){this.initialize(t,e);var i=this.createXmlDocument(),n=i.find("article");n.append(this.meta()),n.append(this.resources()),n.append(this.body());var s=(new window.XMLSerializer).serializeToString(i[0]);return window.res=s,s=s.replace("http://www.w3.org/1999/xhtml","http://substance.io/science-article/0.1.0")},this.meta=function(){var t=this.state.doc,e=t.get("article-meta");return e.toHtml(this)},this.resources=function(){var t=this.state.doc,e=o("<resources>"),i=t.getIndex("type").get("image-figure");s.each(i,function(t){e.append(t.toHtml(this))},this);var n=t.getIndex("type").get("table-figure");s.each(n,function(t){e.append(t.toHtml(this))},this);var r=t.getIndex("type").get("bib-item");return s.each(r,function(t){e.append(t.toHtml(this))},this),e},this.body=function(){var t=this.state.doc,e=t.get("main"),i=this.convertContainer(e),n=o("<body>").append(i);return n}},r.inherit(n,a),e.exports=n},{"./articleSchema":12,"substance/model/HtmlExporter":70,"substance/util/helpers":315,"substance/util/jquery":316,"substance/util/oo":317}],10:[function(t,e,i){function n(t,e,i,n){this.doc=t,this.containerId=e,this.itemType=i,this.labelPrefix=n,this.doc.connect(this,{"operation:applied":this.onOperationApplied})}var s=t("substance/util/helpers"),r=t("substance/util/oo");n.Prototype=function(){this.dispose=function(){this.doc.disconnect(this)},this.getDocument=function(){return this.doc},this.determineItems=function(){var t=this.doc,e=t.get(this.containerId),i=t.getIndex("type").get(this.itemType),n=[];s.each(i,function(t){var i,s=e.getPosition(t.id);s>=0?i=!0:(i=!1,s=Number.MAX_VALUE),n.push({pos:s,item:t,isShown:i})}),n=s.sortBy(n,"pos");var r=0;return s.each(n,function(t){t.isShown?t.index=r++:t.index=-1}),n},this.createItemLabel=function(t){return t.index<0?this.labelPrefix+" ?":[this.labelPrefix,t.index+1].join(" ")},this.createCitationLabel=function(t){var e,i=t.citation,n=i.targets,r=[],o=this.doc;s.each(n,function(t){var i=o.get(t),n=this.items.indexOf(i);if(0>n)return console.error("citation target not found: ",t),void(e=t);var s=this._items[n];if(s.index<0)return console.error("citation target does not have a label: ",t),void(e=t);var a=s.index+1;r.push(a)},this),r.sort();var a;return a=0===r.length?this.labelPrefix+" ???":[this.labelPrefix,r.join(", ")].join(" ")},this.updateItemLabels=function(){s.each(this._items,function(t){var e=this.createItemLabel(t);t.item.setLabel(e)},this)},this.updateCitationLabels=function(){s.each(this._citations,function(t){var e=this.createCitationLabel(t);t.citation.setLabel(e)},this)},this.determineCitations=function(){var t=this.doc,e=t.getIndex("type").get(this.itemType+"-citation"),i=t.get(this.containerId),n=s.map(e,function(t){var e=i.getAddress(t.path);return{citation:t,address:e}});return n.sort(function(t,e){return e>t?-1:t>e?1:t.citation.startOffset-e.citation.startOffset}),n},this.update=function(){this._items=this.determineItems(),this.items=s.pluck(this._items,"item"),this._citations=this.determineCitations(),this.citations=s.pluck(this._citations,"citation"),this.updateItemLabels(),this.updateCitationLabels()},this.getItems=function(){return this.items},this.onOperationApplied=function(t){if(t.path[0]===this.containerId){if("set"===t.type)return this.update();if("update"===t.type){var e=t.diff.val,i=this.doc.get(e);if(!i)return;if(i.type===this.itemType)return this.update();if("include"===i.type){if(i=i.getIncludedNode(),!i)return;if(i.type===this.itemType)return this.update()}}}}},r.initClass(n),e.exports=n},{"substance/util/helpers":315,"substance/util/oo":317}],11:[function(t,e,i){var n=t("./articleSchema"),s=t("substance/util/helpers"),r=t("substance/util/oo"),o=t("substance/util/jquery"),a=t("substance/model/Document"),l=t("substance/model/data/NodeIndex"),u=t("./ArticleHtmlImporter"),c=t("./ArticleHtmlExporter"),h=t("./ArticleXmlExporter"),p=t("../packages/bibliography/CiteprocCompiler"),d=t("../packages/bibliography/Bibliography"),f=t("./Collection"),m=function(){m["super"].call(this,n)};m.Prototype=function(){this.initialize=function(){this["super"].initialize.apply(this,arguments),this.create({type:"container",id:"main",nodes:[]}),this.citeprocCompiler=new p,this.collections={"bib-item":new d(this,"main"),"image-figure":new f(this,"main","image-figure","Figure"),"table-figure":new f(this,"main","table-figure","Table")},this.includesIndex=this.addIndex("includes",l.create({type:"include",property:"nodeId"})),this.bibItemByGuidIndex=this.addIndex("bibItemByGuid",l.create({type:"bib-item",property:"guid"})),this.citationsIndex=this.addIndex("citations",l.create({type:"citation",property:"targets"}))},this.documentDidLoad=function(){m["super"].prototype.documentDidLoad.call(this),this.isClipboard()||s.each(this.collections,function(t){t.update()})},this.toXml=function(){return(new h).convert(this)},this.toHtml=function(){return(new c).convert(this)},this.propertyToHtml=function(t){return(new c).convertProperty(this,t)},this.getDocumentMeta=function(){return this.get("article-meta")},this.getTOCNodes=function(){var t=[],e=this.get("main").nodes;return s.each(e,function(e){var i=this.get(e);"heading"===i.type&&t.push(i)},this),t},this.getCiteprocCompiler=function(){return this.citeprocCompiler},this.getBibliography=function(){return this.collections["bib-item"]},this.getFiguresCollection=function(){return this.collections["image-figure"]},this.getTablesCollection=function(){return this.collections["table-figure"]},this.getCollection=function(t){return this.collections[t]},this.getTitle=function(){return this.get("article-meta").title},this.deleteFigure=function(t){this.transaction(function(e,i){var n=s.map(this.citationsIndex.get(t));s.each(n,function(t){e["delete"](t.id)});var r=s.map(e.getIndex("includes").get(t));return s.each(r,function(t){e.get("main").hide(t.id),e["delete"](t.id)}),e["delete"](t),i})},this.deleteBibItem=function(t){this.transaction(function(e,i){var n=s.map(e.getIndex("citations").get(t));return s.each(n,function(t){e["delete"](t.id)}),e["delete"](t),i})}},r.inherit(m,a),m.XML_TEMPLATE=['<article xmlns="http://substance.io/science-article/0.1.0" lang="en">',"<meta>","<title>Enter title</title>","<abstract>Enter abstract</abstract>","</meta>","<resources></resources>","<body>",'<p id="p1">Enter your article here.</p>',"</body>","</article>"].join(""),m.fromHtml=function(t){var e;if("undefined"==typeof window)e=o(t);else{var i=new window.DOMParser,n=i.parseFromString(t,"text/xml");e=o(n)}var s=new m;return(new u).convert(e,s),s.documentDidLoad(),s},m.fromXml=function(t){if(s.isString(t)){var e=new window.DOMParser;t=e.parseFromString(t,"text/xml")}var i=o(t),n=new m;return(new u).convert(i,n),n.documentDidLoad(),n},m.ArticleHtmlImporter=u,e.exports=m},{"../packages/bibliography/Bibliography":326,"../packages/bibliography/CiteprocCompiler":328,"./ArticleHtmlExporter":7,"./ArticleHtmlImporter":8,"./ArticleXmlExporter":9,"./Collection":10,"./articleSchema":12,"substance/model/Document":65,"substance/model/data/NodeIndex":88,"substance/util/helpers":315,"substance/util/jquery":316,"substance/util/oo":317}],12:[function(t,e,i){var n=t("substance/model/DocumentSchema"),s=t("substance/packages/paragraph/Paragraph"),r=t("substance/packages/heading/Heading"),o=t("substance/packages/codeblock/Codeblock"),a=t("substance/packages/blockquote/Blockquote"),l=t("substance/packages/embed/Embed"),u=t("substance/packages/image/Image"),c=t("substance/packages/list/List"),h=t("substance/packages/list/ListItem"),p=t("substance/packages/table/Table"),d=t("substance/packages/table/TableSection"),f=t("substance/packages/table/TableRow"),m=t("substance/packages/table/TableCell"),g=t("substance/packages/emphasis/Emphasis"),b=t("substance/packages/strong/Strong"),y=t("substance/packages/link/Link"),v=t("substance/packages/figure/Figure"),_=t("../packages/figures/ImageFigure"),x=t("../packages/figures/TableFigure"),C=t("../packages/figures/TableFigureCitation"),w=t("../packages/figures/ImageFigureCitation"),S=t("../packages/bibliography/BibItem"),T=t("../packages/bibliography/BibItemCitation"),E=t("../packages/metadata/Author"),I=t("../packages/metadata/ArticleMeta"),N=new n("scientific-article","0.2.0");N.getDefaultTextType=function(){return"paragraph"},N.addNodes([I,s,r,o,a,l,g,b,y,u,E,v,_,p,d,f,m,x,w,C,T,c,h,S]),e.exports=N},{"../packages/bibliography/BibItem":319,"../packages/bibliography/BibItemCitation":320,"../packages/figures/ImageFigure":339,"../packages/figures/ImageFigureCitation":340,"../packages/figures/TableFigure":344,"../packages/figures/TableFigureCitation":345,"../packages/metadata/ArticleMeta":347,"../packages/metadata/Author":348,"substance/model/DocumentSchema":68,"substance/packages/blockquote/Blockquote":231,"substance/packages/codeblock/Codeblock":234,"substance/packages/embed/Embed":237,"substance/packages/emphasis/Emphasis":241,"substance/packages/figure/Figure":244,"substance/packages/heading/Heading":248,"substance/packages/image/Image":253,"substance/packages/link/Link":255,"substance/packages/list/List":258,"substance/packages/list/ListItem":259,"substance/packages/paragraph/Paragraph":261,"substance/packages/strong/Strong":263,"substance/packages/table/Table":266,"substance/packages/table/TableCell":267,"substance/packages/table/TableRow":270,"substance/packages/table/TableSection":271}],13:[function(t,e,i){},{}],14:[function(t,e,i){function n(t,e,i){return"function"==typeof e&&"undefined"==typeof i&&a(t)?s(t,e):r(t,o(e,i,3))}var s=t("../internal/arrayEach"),r=t("../internal/baseEach"),o=t("../internal/bindCallback"),a=t("../lang/isArray");e.exports=n},{"../internal/arrayEach":16,"../internal/baseEach":19,"../internal/bindCallback":31,"../lang/isArray":44}],15:[function(t,e,i){function n(t,e,i){var n=a(t)?s:o;return e=r(e,i,3),n(t,e)}var s=t("../internal/arrayMap"),r=t("../internal/baseCallback"),o=t("../internal/baseMap"),a=t("../lang/isArray");e.exports=n},{"../internal/arrayMap":17,"../internal/baseCallback":18,"../internal/baseMap":25,"../lang/isArray":44}],16:[function(t,e,i){function n(t,e){for(var i=-1,n=t.length;++i<n&&e(t[i],i,t)!==!1;);return t}e.exports=n},{}],17:[function(t,e,i){function n(t,e){for(var i=-1,n=t.length,s=Array(n);++i<n;)s[i]=e(t[i],i,t);return s}e.exports=n},{}],18:[function(t,e,i){function n(t,e,i){var n=typeof t;return"function"==n?"undefined"!=typeof e&&u(t)?a(t,e,i):t:null==t?l:"object"==n?s(t):"undefined"==typeof e?o(t+""):r(t+"",e)}var s=t("./baseMatches"),r=t("./baseMatchesProperty"),o=t("./baseProperty"),a=t("./bindCallback"),l=t("../utility/identity"),u=t("./isBindable");e.exports=n},{"../utility/identity":52,"./baseMatches":26,"./baseMatchesProperty":27,"./baseProperty":28,"./bindCallback":31,"./isBindable":35}],19:[function(t,e,i){function n(t,e){var i=t?t.length:0;if(!r(i))return s(t,e);for(var n=-1,a=o(t);++n<i&&e(a[n],n,a)!==!1;);return t}var s=t("./baseForOwn"),r=t("./isLength"),o=t("./toObject");e.exports=n},{"./baseForOwn":21,"./isLength":37,"./toObject":42}],20:[function(t,e,i){function n(t,e,i){for(var n=-1,r=s(t),o=i(t),a=o.length;++n<a;){var l=o[n];if(e(r[l],l,r)===!1)break}return t}var s=t("./toObject");e.exports=n},{"./toObject":42}],21:[function(t,e,i){function n(t,e){return s(t,e,r)}var s=t("./baseFor"),r=t("../object/keys");e.exports=n},{"../object/keys":48,"./baseFor":20}],22:[function(t,e,i){function n(t,e,i,r,o,a){if(t===e)return 0!==t||1/t==1/e;var l=typeof t,u=typeof e;return"function"!=l&&"object"!=l&&"function"!=u&&"object"!=u||null==t||null==e?t!==t&&e!==e:s(t,e,n,i,r,o,a)}var s=t("./baseIsEqualDeep");e.exports=n},{"./baseIsEqualDeep":23}],23:[function(t,e,i){function n(t,e,i,n,p,m,g){var b=a(t),y=a(e),v=c,_=c;b||(v=f.call(t),v==u?v=h:v!=h&&(b=l(t))),y||(_=f.call(e),_==u?_=h:_!=h&&(y=l(e)));var x=v==h,C=_==h,w=v==_;if(w&&!b&&!x)return r(t,e,v);var S=x&&d.call(t,"__wrapped__"),T=C&&d.call(e,"__wrapped__");if(S||T)return i(S?t.value():t,T?e.value():e,n,p,m,g);if(!w)return!1;m||(m=[]),g||(g=[]);for(var E=m.length;E--;)if(m[E]==t)return g[E]==e;m.push(t),g.push(e);var I=(b?s:o)(t,e,i,n,p,m,g);return m.pop(),g.pop(),I}var s=t("./equalArrays"),r=t("./equalByTag"),o=t("./equalObjects"),a=t("../lang/isArray"),l=t("../lang/isTypedArray"),u="[object Arguments]",c="[object Array]",h="[object Object]",p=Object.prototype,d=p.hasOwnProperty,f=p.toString;e.exports=n},{"../lang/isArray":44,"../lang/isTypedArray":47,"./equalArrays":32,"./equalByTag":33,"./equalObjects":34}],24:[function(t,e,i){function n(t,e,i,n,r){var a=e.length;if(null==t)return!a;for(var l=-1,u=!r;++l<a;)if(u&&n[l]?i[l]!==t[e[l]]:!o.call(t,e[l]))return!1;for(l=-1;++l<a;){var c=e[l];if(u&&n[l])var h=o.call(t,c);else{var p=t[c],d=i[l];h=r?r(p,d,c):void 0,"undefined"==typeof h&&(h=s(d,p,r,!0))}if(!h)return!1}return!0}var s=t("./baseIsEqual"),r=Object.prototype,o=r.hasOwnProperty;e.exports=n},{"./baseIsEqual":22}],25:[function(t,e,i){function n(t,e){var i=[];return s(t,function(t,n,s){i.push(e(t,n,s))}),i}var s=t("./baseEach");e.exports=n},{"./baseEach":19}],26:[function(t,e,i){function n(t){var e=o(t),i=e.length;if(1==i){var n=e[0],a=t[n];if(r(a))return function(t){return null!=t&&t[n]===a&&l.call(t,n)}}for(var u=Array(i),c=Array(i);i--;)a=t[e[i]],u[i]=a,c[i]=r(a);return function(t){return s(t,e,u,c)}}var s=t("./baseIsMatch"),r=t("./isStrictComparable"),o=t("../object/keys"),a=Object.prototype,l=a.hasOwnProperty;e.exports=n},{"../object/keys":48,"./baseIsMatch":24,"./isStrictComparable":39}],27:[function(t,e,i){function n(t,e){return r(e)?function(i){return null!=i&&i[t]===e}:function(i){return null!=i&&s(e,i[t],null,!0)}}var s=t("./baseIsEqual"),r=t("./isStrictComparable");e.exports=n},{"./baseIsEqual":22,"./isStrictComparable":39}],28:[function(t,e,i){function n(t){return function(e){return null==e?void 0:e[t]}}e.exports=n},{}],29:[function(t,e,i){
var n=t("../utility/identity"),s=t("./metaMap"),r=s?function(t,e){return s.set(t,e),t}:n;e.exports=r},{"../utility/identity":52,"./metaMap":40}],30:[function(t,e,i){function n(t){return"string"==typeof t?t:null==t?"":t+""}e.exports=n},{}],31:[function(t,e,i){function n(t,e,i){if("function"!=typeof t)return s;if("undefined"==typeof e)return t;switch(i){case 1:return function(i){return t.call(e,i)};case 3:return function(i,n,s){return t.call(e,i,n,s)};case 4:return function(i,n,s,r){return t.call(e,i,n,s,r)};case 5:return function(i,n,s,r,o){return t.call(e,i,n,s,r,o)}}return function(){return t.apply(e,arguments)}}var s=t("../utility/identity");e.exports=n},{"../utility/identity":52}],32:[function(t,e,i){function n(t,e,i,n,s,r,o){var a=-1,l=t.length,u=e.length,c=!0;if(l!=u&&!(s&&u>l))return!1;for(;c&&++a<l;){var h=t[a],p=e[a];if(c=void 0,n&&(c=s?n(p,h,a):n(h,p,a)),"undefined"==typeof c)if(s)for(var d=u;d--&&(p=e[d],!(c=h&&h===p||i(h,p,n,s,r,o))););else c=h&&h===p||i(h,p,n,s,r,o)}return!!c}e.exports=n},{}],33:[function(t,e,i){function n(t,e,i){switch(i){case s:case r:return+t==+e;case o:return t.name==e.name&&t.message==e.message;case a:return t!=+t?e!=+e:0==t?1/t==1/e:t==+e;case l:case u:return t==e+""}return!1}var s="[object Boolean]",r="[object Date]",o="[object Error]",a="[object Number]",l="[object RegExp]",u="[object String]";e.exports=n},{}],34:[function(t,e,i){function n(t,e,i,n,r,a,l){var u=s(t),c=u.length,h=s(e),p=h.length;if(c!=p&&!r)return!1;for(var d,f=-1;++f<c;){var m=u[f],g=o.call(e,m);if(g){var b=t[m],y=e[m];g=void 0,n&&(g=r?n(y,b,m):n(b,y,m)),"undefined"==typeof g&&(g=b&&b===y||i(b,y,n,r,a,l))}if(!g)return!1;d||(d="constructor"==m)}if(!d){var v=t.constructor,_=e.constructor;if(v!=_&&"constructor"in t&&"constructor"in e&&!("function"==typeof v&&v instanceof v&&"function"==typeof _&&_ instanceof _))return!1}return!0}var s=t("../object/keys"),r=Object.prototype,o=r.hasOwnProperty;e.exports=n},{"../object/keys":48}],35:[function(t,e,i){function n(t){var e=!(o.funcNames?t.name:o.funcDecomp);if(!e){var i=u.call(t);o.funcNames||(e=!a.test(i)),e||(e=l.test(i)||r(t),s(t,e))}return e}var s=t("./baseSetData"),r=t("../lang/isNative"),o=t("../support"),a=/^\s*function[ \n\r\t]+\w/,l=/\bthis\b/,u=Function.prototype.toString;e.exports=n},{"../lang/isNative":45,"../support":51,"./baseSetData":29}],36:[function(t,e,i){function n(t,e){return t=+t,e=null==e?s:e,t>-1&&t%1==0&&e>t}var s=Math.pow(2,53)-1;e.exports=n},{}],37:[function(t,e,i){function n(t){return"number"==typeof t&&t>-1&&t%1==0&&s>=t}var s=Math.pow(2,53)-1;e.exports=n},{}],38:[function(t,e,i){function n(t){return t&&"object"==typeof t||!1}e.exports=n},{}],39:[function(t,e,i){function n(t){return t===t&&(0===t?1/t>0:!s(t))}var s=t("../lang/isObject");e.exports=n},{"../lang/isObject":46}],40:[function(t,e,i){(function(i){var n=t("../lang/isNative"),s=n(s=i.WeakMap)&&s,r=s&&new s;e.exports=r}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../lang/isNative":45}],41:[function(t,e,i){function n(t){for(var e=l(t),i=e.length,n=i&&t.length,c=n&&a(n)&&(r(t)||u.nonEnumArgs&&s(t)),p=-1,d=[];++p<i;){var f=e[p];(c&&o(f,n)||h.call(t,f))&&d.push(f)}return d}var s=t("../lang/isArguments"),r=t("../lang/isArray"),o=t("./isIndex"),a=t("./isLength"),l=t("../object/keysIn"),u=t("../support"),c=Object.prototype,h=c.hasOwnProperty;e.exports=n},{"../lang/isArguments":43,"../lang/isArray":44,"../object/keysIn":49,"../support":51,"./isIndex":36,"./isLength":37}],42:[function(t,e,i){function n(t){return s(t)?t:Object(t)}var s=t("../lang/isObject");e.exports=n},{"../lang/isObject":46}],43:[function(t,e,i){function n(t){var e=r(t)?t.length:void 0;return s(e)&&l.call(t)==o||!1}var s=t("../internal/isLength"),r=t("../internal/isObjectLike"),o="[object Arguments]",a=Object.prototype,l=a.toString;e.exports=n},{"../internal/isLength":37,"../internal/isObjectLike":38}],44:[function(t,e,i){var n=t("../internal/isLength"),s=t("./isNative"),r=t("../internal/isObjectLike"),o="[object Array]",a=Object.prototype,l=a.toString,u=s(u=Array.isArray)&&u,c=u||function(t){return r(t)&&n(t.length)&&l.call(t)==o||!1};e.exports=c},{"../internal/isLength":37,"../internal/isObjectLike":38,"./isNative":45}],45:[function(t,e,i){function n(t){return null==t?!1:c.call(t)==o?h.test(u.call(t)):r(t)&&a.test(t)||!1}var s=t("../string/escapeRegExp"),r=t("../internal/isObjectLike"),o="[object Function]",a=/^\[object .+?Constructor\]$/,l=Object.prototype,u=Function.prototype.toString,c=l.toString,h=RegExp("^"+s(c).replace(/toString|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");e.exports=n},{"../internal/isObjectLike":38,"../string/escapeRegExp":50}],46:[function(t,e,i){function n(t){var e=typeof t;return"function"==e||t&&"object"==e||!1}e.exports=n},{}],47:[function(t,e,i){function n(t){return r(t)&&s(t.length)&&A[k.call(t)]||!1}var s=t("../internal/isLength"),r=t("../internal/isObjectLike"),o="[object Arguments]",a="[object Array]",l="[object Boolean]",u="[object Date]",c="[object Error]",h="[object Function]",p="[object Map]",d="[object Number]",f="[object Object]",m="[object RegExp]",g="[object Set]",b="[object String]",y="[object WeakMap]",v="[object ArrayBuffer]",_="[object Float32Array]",x="[object Float64Array]",C="[object Int8Array]",w="[object Int16Array]",S="[object Int32Array]",T="[object Uint8Array]",E="[object Uint8ClampedArray]",I="[object Uint16Array]",N="[object Uint32Array]",A={};A[_]=A[x]=A[C]=A[w]=A[S]=A[T]=A[E]=A[I]=A[N]=!0,A[o]=A[a]=A[v]=A[l]=A[u]=A[c]=A[h]=A[p]=A[d]=A[f]=A[m]=A[g]=A[b]=A[y]=!1;var O=Object.prototype,k=O.toString;e.exports=n},{"../internal/isLength":37,"../internal/isObjectLike":38}],48:[function(t,e,i){var n=t("../internal/isLength"),s=t("../lang/isNative"),r=t("../lang/isObject"),o=t("../internal/shimKeys"),a=s(a=Object.keys)&&a,l=a?function(t){if(t)var e=t.constructor,i=t.length;return"function"==typeof e&&e.prototype===t||"function"!=typeof t&&i&&n(i)?o(t):r(t)?a(t):[]}:o;e.exports=l},{"../internal/isLength":37,"../internal/shimKeys":41,"../lang/isNative":45,"../lang/isObject":46}],49:[function(t,e,i){function n(t){if(null==t)return[];l(t)||(t=Object(t));var e=t.length;e=e&&a(e)&&(r(t)||u.nonEnumArgs&&s(t))&&e||0;for(var i=t.constructor,n=-1,c="function"==typeof i&&i.prototype===t,p=Array(e),d=e>0;++n<e;)p[n]=n+"";for(var f in t)d&&o(f,e)||"constructor"==f&&(c||!h.call(t,f))||p.push(f);return p}var s=t("../lang/isArguments"),r=t("../lang/isArray"),o=t("../internal/isIndex"),a=t("../internal/isLength"),l=t("../lang/isObject"),u=t("../support"),c=Object.prototype,h=c.hasOwnProperty;e.exports=n},{"../internal/isIndex":36,"../internal/isLength":37,"../lang/isArguments":43,"../lang/isArray":44,"../lang/isObject":46,"../support":51}],50:[function(t,e,i){function n(t){return t=s(t),t&&o.test(t)?t.replace(r,"\\$&"):t}var s=t("../internal/baseToString"),r=/[.*+?^${}()|[\]\/\\]/g,o=RegExp(r.source);e.exports=n},{"../internal/baseToString":30}],51:[function(t,e,i){(function(i){var n=t("./lang/isNative"),s=/\bthis\b/,r=Object.prototype,o=(o=i.window)&&o.document,a=r.propertyIsEnumerable,l={};!function(t){l.funcDecomp=!n(i.WinRTError)&&s.test(function(){return this}),l.funcNames="string"==typeof Function.name;try{l.dom=11===o.createDocumentFragment().nodeType}catch(e){l.dom=!1}try{l.nonEnumArgs=!a.call(arguments,1)}catch(e){l.nonEnumArgs=!0}}(0,0),e.exports=l}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./lang/isNative":45}],52:[function(t,e,i){function n(t){return t}e.exports=n},{}],53:[function(t,e,i){e.exports={switch_text:"Switch text",hyperlink:"Hyperlink","delete":"Delete",emphasis:"Emphasis",strong:"Strong",redo:"Redo",undo:"Undo",save:"Save",untitled:"Untitled",manage:"Manage",toc:"Contents"}},{}],54:[function(t,e,i){"use strict";function n(t){r.call(this),this.schema=t,this.AUTO_ATTACH=!0,this.FOR_CLIPBOARD=!1,this.data=new a(t,{didCreateNode:s.bind(this._didCreateNode,this),didDeleteNode:s.bind(this._didDeleteNode,this)})}var s=t("../util/helpers"),r=t("../util/EventEmitter"),o=t("../util/oo"),a=t("./data/IncrementalData"),l=t("./Selection"),u=t("./PropertySelection"),c=t("./ContainerSelection"),h=t("./TableSelection"),p=t("./documentHelpers");n.Prototype=function(){this.isTransaction=function(){return!1},this.isClipboard=function(){return this.FOR_CLIPBOARD},this.newInstance=function(){throw new Error("Must be implemented in subclass.")},this.initialize=function(){},this.addIndex=function(t,e){return this.data.addIndex(t,e)},this.getIndex=function(t){return this.data.getIndex(t)},this.getNodes=function(){return this.data.nodes},this._setAutoAttach=function(t){this.AUTO_ATTACH=t},this._setForClipboard=function(t){this.FOR_CLIPBOARD=t},this._resetContainers=function(){var t=this.getIndex("type").get("container");s.each(t,function(t){t.reset()})},this._create=function(t){var e=this.data.create(t);return this._updateContainers(e),e},this._delete=function(t){var e=this.data["delete"](t);return this._updateContainers(e),e},this._update=function(t,e){var i=this.data.update(t,e);return this._updateContainers(i),i},this._set=function(t,e){var i=this.data.set(t,e);return this._updateContainers(i),i},this.documentDidLoad=function(){},this.getSchema=function(){return this.schema},this.get=function(t){return this.data.get(t)},this.getNodes=function(){return this.data.getNodes()},this.addIndex=function(t,e){return this.data.addIndex(t,e)},this.getIndex=function(t){return this.data.getIndex(t)},this.loadSeed=function(t){s.each(this.data.nodes,function(t){this["delete"](t.id)},this),this._setAutoAttach(!1),s.each(t.nodes,function(t){this.create(t)},this),this._setAutoAttach(!0),s.each(this.data.nodes,function(t){t.attach(this)},this),this.documentDidLoad()},this.getTextForSelection=function(t){return p.getTextForSelection(this,t)},this.toJSON=function(){var t={};return s.each(this.getNodes(),function(e){t[e.id]=e.toJSON()}),{schema:[this.schema.name,this.schema.version],nodes:t}},this.create=function(t){throw new Error("Method is abstract.")},this["delete"]=function(t){throw new Error("Method is abstract.")},this.set=function(t,e){throw new Error("Method is abstract.")},this.update=function(t,e){throw new Error("Method is abstract.")},this.setText=function(t,e,i){var n,s=this.getIndex("annotations").get(t);for(n=0;n<s.length;n++)this["delete"](s[n].id);for(this.set(t,e),n=0;n<i.length;n++)this.create(i[n])},this.createSelection=function(t){if(!t)return l.nullSelection;switch(t.type){case"property":return new u(t).attach(this);case"container":return new c(t).attach(this);case"table":return new h(t).attach(this);default:throw new Error("Unsupported selection type",t.type)}},this._didCreateNode=function(t){this.AUTO_ATTACH&&t.attach(this)},this._didDeleteNode=function(t){t.detach(this)},this._updateContainers=function(t){var e=this.getIndex("type").get("container");s.each(e,function(e){e.update(t)})}},o.inherit(n,r),e.exports=n},{"../util/EventEmitter":310,"../util/helpers":315,"../util/oo":317,"./ContainerSelection":63,"./PropertySelection":74,"./Selection":76,"./TableSelection":77,"./data/IncrementalData":85,"./documentHelpers":93}],55:[function(t,e,i){"use strict";var n=t("../util/helpers"),s=t("../util/oo"),r=t("../util/PathAdapter"),o=t("./ContainerAnnotation"),a=t("./data/NodeIndex"),l=function(t){this.doc=t,this.byPath=new r.Arrays,this.byId={}};l.Prototype=function(){this.select=function(t){return t instanceof o},this.reset=function(t){this.byPath.clear(),this.byId={},this._initialize(t)},this.get=function(t,e){var i=this.byPath.get(t)||[];if(!n.isArray(i)){var s=[];this.byPath._traverse(i,[],function(t,e){s=s.concat(e)}),i=s}return e?n.filter(i,function(t){return t.container===e}):i.slice(0)},this.create=function(t){var e=t.getStartAnchor(),i=t.getEndAnchor();this.byPath.add(e.path,e),this.byPath.add(i.path,i),this.byId[t.id]=t},this["delete"]=function(t){var e=t.getStartAnchor(),i=t.getEndAnchor();this.byPath.remove(e.path,e),this.byPath.remove(i.path,i),delete this.byId[t.id]},this.update=function(t,e,i,n){if(this.select(t)){var s=null;if("startPath"===e[1])s=t.getStartAnchor();else{if("endPath"!==e[1])return;s=t.getEndAnchor()}this.byPath.remove(n,s),this.byPath.add(s.path,s)}}},s.inherit(l,a),e.exports=l},{"../util/PathAdapter":313,"../util/helpers":315,"../util/oo":317,"./ContainerAnnotation":62,"./data/NodeIndex":88}],56:[function(t,e,i){"use strict";var n=t("../util/jquery"),s=t("../util/helpers"),r=t("./DocumentNode"),o=r.extend({displayName:"Annotation",name:"annotation",properties:{path:["array","string"],startOffset:"number",endOffset:"number"},canSplit:function(){return!0},getSelection:function(){return this.getDocument().createSelection({type:"property",path:this.path,startOffset:this.startOffset,endOffset:this.endOffset})},updateRange:function(t,e){if(!e.isPropertySelection())throw new Error("Cannot change to ContainerAnnotation.");s.isEqual(this.startPath,e.start.path)||t.set([this.id,"path"],e.start.path),this.startOffset!==e.start.offset&&t.set([this.id,"startOffset"],e.start.offset),this.endOffset!==e.end.offset&&t.set([this.id,"endOffset"],e.end.offset)},getText:function(){var t=this.getDocument();if(!t)return console.warn("Trying to use an Annotation which is not attached to the document."),"";var e=t.get(this.path);return e.substring(this.startOffset,this.endOffset)}});o["static"].isInline=!0,o["static"].toHtml=function(t,e,i){var s=t.id,r=t.constructor["static"].tagName||"span",o=n("<"+r+">").attr("id",s).append(i);return o},Object.defineProperties(o.prototype,{startPath:{get:function(){return this.path}},endPath:{get:function(){return this.path}}}),e.exports=o},{"../util/helpers":315,"../util/jquery":316,"./DocumentNode":67}],57:[function(t,e,i){"use strict";var n=t("../util/helpers"),s=t("../util/oo"),r=t("../util/PathAdapter"),o=t("./Annotation"),a=t("./data/NodeIndex"),l=function(){this.byPath=new r,this.byType=new r};l.Prototype=function(){this.property="path",this.select=function(t){return t instanceof o},this.reset=function(t){this.byPath.clear(),this.byType.clear(),this._initialize(t)},this.get=function(t,e,i,s){var r=this.byPath.get(t)||{};if(n.isString(t)||1===t.length){var o=r;r=[],n.each(o,function(t){r=r.concat(n.map(t,function(t){return t}))})}else r=n.map(r,function(t){return t});return null!=e&&(r=n.filter(r,l.filterByRange(e,i))),s&&(r=n.filter(r,l.filterByType(s))),r},this.create=function(t){this.byType.set([t.type,t.id],t),this.byPath.set(t.path.concat([t.id]),t)},this["delete"]=function(t){this.byType["delete"]([t.type,t.id]),this.byPath["delete"](t.path.concat([t.id]))},this.update=function(t,e,i,n){this.select(t)&&e[1]===this.property&&(this["delete"]({id:t.id,type:t.type,path:n}),this.create(t))}},s.inherit(l,a),l.filterByRange=function(t,e){return function(i){var n=i.startOffset,s=i.endOffset,r=s>=t;return null!=e&&(r=r&&e>=n),r}},l.filterByType=function(t){return function(e){return e.isInstanceOf(t)}},e.exports=l},{"../util/PathAdapter":313,"../util/helpers":315,"../util/oo":317,"./Annotation":56,"./data/NodeIndex":88}],58:[function(t,e,i){"use strict";var n=t("../util/helpers"),s=t("../util/oo"),r=1,o=-1,a=-2,l=function(t){n.extend(this,t)};l.Prototype=function(){var t=function(t,e){if(t.pos<e.pos)return-1;if(t.pos>e.pos)return 1;if(t.id===e.id)return e.mode-t.mode;if(t.mode<e.mode)return-1;if(t.mode>e.mode)return 1;if(t.mode===r){if(t.level<e.level)return-1;if(t.level>e.level)return 1}if(t.mode===o){if(t.level>e.level)return-1;if(t.level<e.level)return 1}return 0},e=function(t){var e=[];return n.each(t,function(t){if(t.zeroWidth)e.push({pos:t.offset,mode:a,id:t.id,level:Number.MAX_VALUE,type:"anchor",node:t});else{var i=1e3;t.constructor["static"]&&t.constructor["static"].level&&(i=t.constructor["static"].level),e.push({pos:t.startOffset,mode:r,level:i,id:t.id,type:t.type,node:t}),e.push({pos:t.endOffset,mode:o,level:i,id:t.id,type:t.type,node:t})}}),e};this.onText=function(){},this.onEnter=function(){return null},this.onExit=function(){},this.enter=function(t,e){return this.onEnter(t,e)},this.exit=function(t,e,i){this.onExit(t,e,i)},this.createText=function(t,e){e.length>0&&this.onText(t,e)},this.start=function(i,n,s){var l=this,u=e.call(this,s);u.sort(t.bind(this));for(var c=[{context:i,entry:null}],h=0,p=0;p<u.length;p++){var d=u[p];this.createText(c[c.length-1].context,n.substring(h,d.pos)),h=d.pos;var f,m;if(d.mode===r||d.mode===a){for(f=1;f<c.length&&!(d.level<c[f].entry.level);f++);for(m=c.length-1;m>=f;m--)this.exit(c[m].entry,c[m].context,c[m-1].context);for(c.splice(f,0,{entry:d}),m=f;m<c.length;m++)c[m].context=l.enter(c[m].entry,c[m-1].context)}if(d.mode===o||d.mode===a){for(f=1;f<c.length&&c[f].entry.node!==d.node;f++);for(m=c.length-1;m>=f;m--)this.exit(c[m].entry,c[m].context,c[m-1].context);for(c.splice(f,1),m=f;m<c.length;m++)c[m].context=l.enter(c[m].entry,c[m-1].context)}}this.createText(i,n.substring(h))}},s.initClass(l),e.exports=l},{"../util/helpers":315,"../util/oo":317}],59:[function(t,e,i){"use strict";function n(){n["super"].call(this)}var s=t("../util/oo"),r=t("./HtmlExporter");n.Prototype=function(){this.convert=function(t,e){this.initialize(t,e);var i=this.createHtmlDocument(),n=t.get("clipboard_content");return i.find("body").append(this.convertContainer(n)),i.find("html").html()}},s.inherit(n,r),e.exports=n},{"../util/oo":317,"./HtmlExporter":70}],60:[function(t,e,i){"use strict";function n(t){if(!t.schema)throw new Error("Missing argument: config.schema is required.");r.extend(t,{trimWhitespaces:!0,REMOVE_INNER_WS:!0}),n["super"].call(this,t)}var s=t("../util/jquery"),r=t("../util/helpers"),o=t("../util/oo"),a=t("./HtmlImporter"),l=t("./transform/copySelection").CLIPBOARD_CONTAINER_ID;n.Prototype=function(){this.convert=function(t,e){this.initialize(e,t);var i=t.find("body");i=this.sanitizeBody(i),this.convertContainer(i,l),this.finish()},this.sanitizeBody=function(t){var e=t.find("b > p");return e.length&&(t=s(e[0].parentNode)),t},this.checkQuality=function(t){var e=t.find("body");return e.children("b").children("p").length?!0:e.children("p").length?!0:e.find("* p").length?!1:e.children("a,b,i,strong,italic").length?!0:!1}},o.inherit(n,a),e.exports=n},{"../util/helpers":315,"../util/jquery":316,"../util/oo":317,"./HtmlImporter":71,"./transform/copySelection":95}],61:[function(t,e,i){"use strict";function n(){a.apply(this,arguments),u.call(this,"nodes"),this.components=[],this.nodeComponents={},this.byPath=new o({})}var s=t("../util/helpers"),r=t("../util/oo"),o=t("../util/PathAdapter"),a=t("./DocumentNode"),l=t("./ContainerAnnotation"),u=t("./ParentNodeMixin");n.Prototype=function(){s.extend(this,u.prototype),this.properties={nodes:["array","id"]},this.didAttach=function(){this.reset()},this.getPosition=function(t){var e=this.nodes.indexOf(t);return e},this.show=function(t,e){var i=this.getDocument();null==e&&(e=this.nodes.length),i.update([this.id,"nodes"],{insert:{offset:e,value:t}})},this.hide=function(t){var e=this.getDocument(),i=this.nodes.indexOf(t);i>=0&&e.update([this.id,"nodes"],{"delete":{offset:i}})},this.getAddress=function(t){var e=this.getDocument(),i=t[0],n=t[1],s=e.get(i),r=s.getComponents().indexOf(n);if(0>r)throw new Error("Can not resolve index for property "+n);for(var o,a,l=[r];s.hasParent();){if(o=s.getParent(),a=o.getChildIndex(s),0>a)throw new Error("Can not resolve index for child node "+s.id+" and parent "+o.id);l.unshift(a),s=o}var u=this.getPosition(s.id);if(0>u)throw new Error("Can not resolve index of node "+s.id);return l.unshift(u),l},this.getPath=function(t){return this.getPathForAddress(t)},this._getNodeChain=function(t){var e=this.getDocument();if(t.length<2)throw new Error("Property addresses have a length of >= 2");var i,n=[],s=this.nodes[t[0]];if(2===t.length)i=e.get(s),n.push(i);else{i=e.get(s),n.push(i);for(var r=1;i&&r<t.length-1;r++)i=i.getChildAt(t[r]),n.push(i)}if(0===n.length)throw new Error("Could not resolve address: "+t.toString());return n},this._getNodeForAddress=function(t){return s.last(this._getNodeChain(t))},this.getPathForAddress=function(t){var e=this._getNodeForAddress(t),i=e.getComponents(),n=i[s.last(t)];if(!n)throw new Error("No property with index "+s.last(t)+" in node "+JSON.stringify(e.toJSON()));var r=[e.id,n];return r},this.getNextAddress=function(t){var e,i,n,r=this.getDocument();if(2===t.length)return e=this.nodes[t[0]],i=r.get(e),n=i.getComponents(),n.length>1&&t[1]<n.length-1?[t[0],t[1]+1]:t[0]<this.nodes.length-1?(e=this.nodes[t[0]+1],[t[0]+1].concat(this._getFirstAddress(r.get(e)))):null;var o=this._getNodeChain(t);i=s.last(o),n=i.getComponents();var a;if(n.length>1&&s.last(t)<n.length-1)return a=t.slice(0),a[a.length-1]++,a;var l,u;o.unshift(this);for(var c=o.length-2;c>=0&&(l=o[c],u=t[c],!(u<l.getChildCount()-1));c--)i=l;if(0>c)return null;var h=u+1,p=l.getChildAt(h),d=this._getFirstAddress(p);return a=t.slice(0,c).concat([h]).concat(d)},this.getPreviousAddress=function(t){var e,i,n=this.getDocument();if(2===t.length)return t[1]>0?[t[0],t[1]-1]:t[0]>0?(e=this.nodes[t[0]-1],i=n.get(e),[t[0]-1].concat(this._getLastAddress(i))):null;var r=this._getNodeChain(t);i=s.last(r);var o;if(s.last(t)>0)return o=t.slice(0),o[o.length-1]--,o;r.unshift(this);for(var a=r.length-2;a>=0&&!(t[a]>0);a--);if(0>a)return null;var l=r[a],u=t[a]-1,c=l.getChildAt(u),h=this._getLastAddress(c);return o=t.slice(0,a).concat([u]).concat(h)},this._getFirstAddress=function(t){for(var e=[];t.hasChildren();)e.push(0),t=t.getChildAt(0);return e.push(0),e},this._getLastAddress=function(t){for(var e=[];t.hasChildren();){var i=t.getChildCount()-1;e.push(i),t=t.getChildAt(i)}return e.push(t.getComponents().length-1),e},this.getFirstAddress=function(t){t||(t=this.getChildAt(0));var e=this.getChildIndex(t);return 0>e?(console.warn("Container.getLastAddress(): Illegal argument. Could not find node position."),null):[e].concat(this._getFirstAddress(t))},this.getFirstPath=function(t){var e=this.getFirstAddress(t);return e?this.getPath(e):null},this.getLastAddress=function(t){t||(t=this.getChildAt(this.length-1));var e=this.getChildIndex(t);return 0>e?(console.warn("Container.getLastAddress(): Illegal argument. Could not find node position."),null):[e].concat(this._getLastAddress(t))},this.getLastPath=function(t){var e=this.getLastAddress(t);return e?this.getPath(e):null},this.getAddressRange=function(t,e){if(t>e){var i=t;t=e,e=i}var n=[t];if(e>t)for(var s=t;e>s;)s=this.getNextAddress(s),n.push(s);return n},this.getPathRange=function(t,e){var i=this.getAddress(t),n=this.getAddress(e),r=this.getAddressRange(i,n);return s.map(r,this.getPathForAddress,this)},this.getNextPath=function(t){var e=this.getAddress(t),i=this.getNextAddress(e);return i?this.getPath(i):null},this.getPreviousPath=function(t){var e=this.getAddress(t),i=this.getPreviousAddress(e);return i?this.getPath(i):null},this.getAddressesForNode=function(t){var e=this.getChildIndex(t),i=[e].concat(this._getFirstAddress(t)),n=[e].concat(this._getLastAddress(t));return this.getAddressRange(i,n)},this.getPathsForNode=function(t){var e=this.getAddressesForNode(t);return s.map(e,this.getPathForAddress,this)},this.getComponents=function(){return console.error("DEPRECATED: this API will be removed."),this.components},this.getComponent=function(t){console.error("DEPRECATED: this API will be removed.");var e=this.byPath.get(t);return e},this.getComponentsForRange=function(t){console.error("DEPRECATED: this API will be removed.");var e=[],i=this.byPath.get(t.start.path),n=this.byPath.get(t.end.path),s=i.getIndex(),r=n.getIndex();e.push(i);for(var o=s+1;r>=o;o++)e.push(this.getComponentAt(o));return e},this.getComponentAt=function(t){return console.error("DEPRECATED: this API will be removed."),this.components[t]},this.getFirstComponent=function(){return console.error("DEPRECATED: this API will be removed."),this.components[0]},this.getLastComponent=function(){return console.error("DEPRECATED: this API will be removed."),s.last(this.components)},this.getComponentsForNode=function(t){console.error("DEPRECATED: this API will be removed.");var e=this.nodeComponents[t];return e?e.components.slice(0):void 0},this.getNodeForComponentPath=function(t){console.error("DEPRECATED: this API will be removed.");var e=this.getComponent(t);if(!e)return null;var i=e.rootId;return this.getDocument().get(i)},this.getAnnotationFragments=function(t){var e=[],i=t.getDocument(),n=t,r=n.getStartAnchor(),o=n.getEndAnchor();if(s.isEqual(r.path,o.path))e.push(new l.Fragment(n,r.path,"property"));else{var a=i.get(r.path),u=this.getComponent(r.path),c=this.getComponent(o.path);if(!u||!c)throw new Error("Could not find components of AbstractContainerAnnotation");e.push(new l.Fragment(n,r.path,"start"));for(var h=u.idx+1;h<c.idx;h++){var p=this.getComponentAt(h);a=i.get(p.path),e.push(new l.Fragment(n,p.path,"inner"))}e.push(new l.Fragment(n,o.path,"end"))}return e},this.reset=function(){this.byPath=new o;var e=this.getDocument(),i=[];s.each(this.nodes,function(n){var s=e.get(n);i=i.concat(t(s))},this),this.components=[],this.nodeComponents={},this._insertComponentsAt(0,i),this._updateComponentPositions(0)},this.update=function(t){if("create"!==t.type&&"delete"!==t.type)if(t.path[0]===this.id&&"nodes"===t.path[1])if("set"===t.type)this.reset();else{var e=t.diff;if(e.isInsert()){var i=this._handleInsert(e.getValue(),e.getOffset());this._updateComponentPositions(i)}else{if(!e.isDelete())throw new Error("Illegal state");var n=this._handleDelete(e.getValue());this._updateComponentPositions(n)}}else"update"===t.type&&"items"===t.path[1]&&this.updateNode(t.path[0])},this.updateNode=function(e){var i=this.getDocument().get(e),n=this._handleDelete(e),s=t(i);this._insertComponentsAt(n,s),this._updateComponentPositions(n)},this._insertComponentsAt=function(t,e){for(var i=this.components[t-1],s=this.components[t],r=this.nodeComponents,o=this.byPath,a=0;a<e.length;a++){var l=e[a],u=l.rootId,c=r[u];c||(c=new n.NodeComponent(u),r[u]=c),l.parentNode=c,0===a&&i?(i.next=l,l.previous=i):a>0&&(l.previous=e[a-1],e[a-1].next=l),c.components.push(l),o.set(l.path,l)}s&&(e[e.length-1].next=s,s.previous=e[e.length-1]),this.components.splice.apply(this.components,[t,0].concat(e))},this._updateComponentPositions=function(t){for(var e=t;e<this.components.length;e++)this.components[e].idx=e},this._handleInsert=function(e,i){var n,s=this.getDocument(),r=s.get(e),o=this.nodes.length;if(i===o-1)n=this.components.length;else{var a=this.nodes[i+1],l=this.nodeComponents[a].components[0];n=l.getIndex()}var u=t(r);return this._insertComponentsAt(n,u),n},this._handleDelete=function(t){for(var e=this.nodeComponents[t],i=e.components,n=e.components[0].getIndex(),r=s.last(i).getIndex(),o=0;o<i.length;o++){var a=i[o];this.byPath["delete"](a.path)}return delete this.nodeComponents[t],this.components.splice(n,r-n+1),this.components.length>n&&(this.components[n].previous=this.components[n-1]),n>0&&(this.components[n-1].next=this.components[n]),n};var t=function(e,i){i=i||e;for(var r,o=[],a=e.getComponents(),l=0;l<a.length;l++){var u=a[l],c=e.getPropertyType(u);if("string"===c){var h=[e.id,u];o.push(new n.Component(h,i.id))}else if("id"===c){var p=e[u];r=e.getDocument().get(p),o=o.concat(t(r,i))}else{if(!s.isEqual(c,["array","id"]))throw new Error("Not yet implemented.");for(var d=e[u],f=0;f<d.length;f++)r=e.getDocument().get(d[f]),o=o.concat(t(r,i))}}return o}},r.inherit(n,a),n["static"].name="container",Object.defineProperties(n.prototype,{length:{get:function(){return this.nodes.length},set:function(){throw new Error("container.length is read-only.")}}}),n.Component=function(t,e){this.path=t,this.rootId=e,this.idx=-1,this.parentNode=null,this.previous=null,this.next=null},n.Component.Prototype=function(){this.getPath=function(){return this.path},this.hasPrevious=function(){return!!this.previous},this.getPrevious=function(){return this.previous},this.hasNext=function(){return!!this.next},this.getNext=function(){return this.next},this.getIndex=function(){return this.idx},this.getParentNode=function(){return this.parentNode}},r.initClass(n.Component),n.NodeComponent=function(t){this.id=t,this.components=[]},r.initClass(n.NodeComponent),e.exports=n},{"../util/PathAdapter":313,"../util/helpers":315,"../util/oo":317,"./ContainerAnnotation":62,"./DocumentNode":67,"./ParentNodeMixin":72}],62:[function(t,e,i){"use strict";var n=t("../util/helpers"),s=t("../util/oo"),r=t("../util/EventEmitter"),o=t("./DocumentNode"),a=t("./Selection"),l=o.extend({displayName:"ContainerAnnotation",name:"container-annotation",properties:{container:"string",startPath:["array","string"],startOffset:"number",endPath:["array","string"],endOffset:"number"},getStartAnchor:function(){return this._startAnchor||(this._startAnchor=new l.Anchor(this,"isStart")),this._startAnchor},getEndAnchor:function(){return this._endAnchor||(this._endAnchor=new l.Anchor(this)),this._endAnchor},getStartPath:function(){return this.startPath},getEndPath:function(){return this.endPath},getStartOffset:function(){return this.startOffset},getEndOffset:function(){return this.endOffset},getSelection:function(){var t=this.getDocument();return t?t.createSelection({type:"container",containerId:this.container,startPath:this.startPath,startOffset:this.startOffset,endPath:this.endPath,endOffset:this.endOffset}):(console.warn("Trying to use a ContainerAnnotation which is not attached to the document."),a.nullSelection())},getText:function(){var t=this.getDocument();return t?t.getTextForSelection(this.getSelection()):(console.warn("Trying to use a ContainerAnnotation which is not attached to the document."),"")},updateRange:function(t,e){if(!e.isContainerSelection())throw new Error("Cannot change to ContainerAnnotation.");n.isEqual(this.startPath,e.start.path)||t.set([this.id,"startPath"],e.start.path),this.startOffset!==e.start.offset&&t.set([this.id,"startOffset"],e.start.offset),n.isEqual(this.endPath,e.end.path)||t.set([this.id,"endPath"],e.end.path),this.endOffset!==e.end.offset&&t.set([this.id,"endOffset"],e.end.offset)},setHighlighted:function(t){this.highlighted!==t&&(this.highlighted=t,this.emit("highlighted",t),n.each(this.fragments,function(e){e.emit("highlighted",t)}))},getFragments:function(){var t=[],e=this.getDocument(),i=e.get(this.container),s=i.getPathRange(this.startPath,this.endPath);if(1===s.length)t.push(new l.Fragment(this,s[0],"property"));else if(s.length>1){t.push(new l.Fragment(this,s[0],"start")),t.push(new l.Fragment(this,n.last(s),"end"));for(var r=1;r<s.length-1;r++)t.push(new l.Fragment(this,s[r],"inner"))}return t}});l.Anchor=function(t,e){r.call(this),this.type="container-annotation-anchor",this.anno=t,this.node=t,this.id=t.id,this.container=t.container,this.isStart=!!e,Object.freeze(this)},l.Anchor.Prototype=function(){n.extend(this,r.prototype),this.zeroWidth=!0,this.getTypeNames=function(){return[this.type]}},s.initClass(l.Anchor),l.Fragment=function(t,e,i){r.call(this),this.type="container-annotation-fragment",this.anno=t,this.id=t.id,this.path=e,this.mode=i},l.Fragment.Prototype=function(){n.extend(this,r.prototype),this.getTypeNames=function(){return[this.type]}},s.initClass(l.Fragment),Object.defineProperties(l.Fragment.prototype,{startOffset:{get:function(){return"start"===this.mode||"property"===this.mode?this.anno.startOffset:0},set:function(){throw new Error("Immutable!")}},endOffset:{get:function(){var t=this.anno.getDocument(),e=t.get(this.path),i=e.length;return"end"===this.mode||"property"===this.mode?this.anno.endOffset:i},set:function(){throw new Error("Immutable!")}},highlighted:{get:function(){return this.anno.highlighted},set:function(){throw new Error("Immutable!")}}}),l.Fragment["static"].level=Number.MAX_VALUE,Object.defineProperties(l.Anchor.prototype,{path:{get:function(){return this.isStart?this.node.startPath:this.node.endPath},set:function(){throw new Error("Immutable!")}},offset:{get:function(){return this.isStart?this.node.startOffset:this.node.endOffset;
},set:function(){throw new Error("Immutable!")}}}),e.exports=l},{"../util/EventEmitter":310,"../util/helpers":315,"../util/oo":317,"./DocumentNode":67,"./Selection":76}],63:[function(t,e,i){"use strict";function n(t){var e=t.containerId,i=t.startPath,n=t.endPath||t.startPath,s=t.startOffset,o=t.endOffset||t.startOffset;if(!e||!i||!r.isNumber(s))throw new Error("Invalid arguments: `containerId`, `startPath` and `startOffset` are mandatory");this.containerId=e,this.range=new l(new u(i,s),new u(n,o)),this.reverse=t.reverse,this._internal={},Object.freeze(this)}var s=t("../util/oo"),r=t("../util/helpers"),o=t("./PropertySelection"),a=t("./Selection"),l=t("./Range"),u=t("./Coordinate");n.Prototype=function(){this.toJSON=function(){return{type:"container",containerId:this.containerId,startPath:this.startPath,startOffset:this.startOffset,endPath:this.endPath,endOffset:this.endOffset,reverse:this.reverse}},this.attach=function(t){return this._internal.doc=t,this},this.isPropertySelection=function(){return!1},this.isContainerSelection=function(){return!0},this.toString=function(){return"ContainerSelection("+JSON.stringify(this.range.start.path)+":"+this.range.start.offset+" -> "+JSON.stringify(this.range.end.path)+":"+this.range.end.offset+(this.reverse?", reverse":"")+")"},this.getContainer=function(){return this.getDocument().get(this.containerId)},this.expand=function(t){var e=this._coordinates(this),n=this._coordinates(t),s=e.start,r=n.start,o=e.end,a=n.end,l={start:{address:s.address,offset:s.offset},end:{address:o.address,offset:o.offset}};return s.address>r.address?(l.start.address=r.address,l.start.offset=r.offset):s.address<r.address||(l.start.offset=Math.min(s.offset,r.offset)),o.address<a.address?(l.end.address=a.address,l.end.offset=a.offset):o.address>a.address||(l.end.offset=Math.max(o.offset,a.offset)),i(this,l)},this.truncate=function(n){var s=this._coordinates(this),r=this._coordinates(n),o={};if(t(r.start,s.start,"strict"))o.start=s.start,o.end=r.end;else if(t(s.end,r.end,"strict"))o.start=r.start,o.end=s.end;else if(e(s.start,r.start)){if(e(s.end,r.end))return a.nullSelection;o.start=r.end,o.end=s.end}else{if(!e(s.end,r.end))throw new Error("Could not determine coordinates for truncate. Check input");o.start=s.start,o.end=r.start}return i(this,o)},this.isInsideOf=function(e,i){if(e.isNull())return!1;var n=this._coordinates(this),s=this._coordinates(e);return t(s.start,n.start,i)&&t(n.end,s.end,i)},this.contains=function(e){var i=this._coordinates(this),n=this._coordinates(e);return t(i.start,n.start)&&t(n.end,i.end)},this.includesWithOneBoundary=function(i){var n=this._coordinates(this),s=this._coordinates(i);return e(n.start,s.start)&&t(s.end,n.end)||e(n.end,s.end)&&t(n.start,s.start)},this.overlaps=function(e){var i=this._coordinates(this),n=this._coordinates(e);return!(t(i.end,n.start)||t(n.end,i.start))},this.isLeftAlignedWith=function(t){var i=this._coordinates(this),n=this._coordinates(t);return e(i.start,n.start)},this.isRightAlignedWith=function(t){var i=this._coordinates(this),n=this._coordinates(t);return e(i.end,n.end)},this.splitIntoPropertySelections=function(){for(var t=[],e=this.getContainer(),i=this.range,n=e.getPathRange(i.start.path,i.end.path),s=e.getDocument(),r=0;r<n.length;r++){var o,a,l=n[r];o=0===r?this.startOffset:0,a=r===n.length-1?this.endOffset:s.get(l).length,t.push(s.createSelection({type:"property",path:l,startOffset:o,endOffset:a}))}return t},this.getFragments=function(){var t=this.splitIntoPropertySelections(),e=r.map(t,function(t){return new a.Fragment("selection-fragment",t.path,t.startOffset,t.endOffset)});return e},this._coordinates=function(t){if(t._internal.containerRange)return t._internal.containerRange;var e,i=this.getContainer(),s=t.getRange(),r=i.getAddress(s.start.path);e=t.isCollapsed()?r:i.getAddress(s.end.path);var o={start:{address:r,offset:s.start.offset},end:{address:e,offset:s.end.offset}};return t instanceof n&&(t._internal.containerRange=o),o};var t=function(t,e,i){return t.address<e.address?!0:t.address>e.address?!1:t.offset>e.offset?!1:i&&t.offset===e.offset?!1:!0},e=function(t,e){return r.isEqual(t.address,e.address)&&t.offset===e.offset},i=function(t,e){var i=t.getContainer();e.start.path=i.getPathForAddress(e.start.address),e.end.path=i.getPathForAddress(e.end.address);var s=new n({containerId:t.containerId,startPath:e.start.path,startOffset:e.start.offset,endPath:e.end.path,endOffset:e.end.offset}),r=t._internal.doc;return r?s.attach(r):console.warn("No document attached to selection"),s}},s.inherit(n,o),Object.defineProperties(n.prototype,{path:{get:function(){throw new Error("ContainerSelection has no path property. Use startPath and endPath instead")},set:function(){throw new Error("immutable.")}},startPath:{get:function(){return this.range.start.path},set:function(){throw new Error("immutable.")}},endPath:{get:function(){return this.range.end.path},set:function(){throw new Error("immutable.")}}}),e.exports=n},{"../util/helpers":315,"../util/oo":317,"./Coordinate":64,"./PropertySelection":74,"./Range":75,"./Selection":76}],64:[function(t,e,i){"use strict";function n(t,e,i){if(this.path=t,this.offset=e,this.after=i,!r.isArray(t))throw new Error("Invalid arguments: path should be an array.");if(!r.isNumber(e)||0>e)throw new Error("Invalid arguments: offset must be a positive number.");Object.isFrozen(t)||Object.freeze(t),Object.freeze(this)}var s=t("../util/oo"),r=t("../util/helpers");n.Prototype=function(){this.equals=function(t){return t===this||r.isArrayEqual(t.path,this.path)&&t.offset===this.offset},this.withCharPos=function(t){return new n(this.path,t)},this.getNodeId=function(){return this.path[0]},this.getPath=function(){return this.path},this.getOffset=function(){return this.offset}},s.initClass(n),e.exports=n},{"../util/helpers":315,"../util/oo":317}],65:[function(t,e,i){"use strict";function n(t){o.call(this,t),this.__id__=m++,this.addIndex("type",a.create({property:"type"})),this.addIndex("annotations",new l),this.addIndex("container-annotation-anchors",new u),this.done=[],this.undone=[],this.eventProxies={path:new p(this)},this.initialize(),this.stage=new c(this),this.isTransacting=!1,this.FORCE_TRANSACTIONS=!1,this.connect(this,{"document:changed":this.updateEventProxies})}var s=t("../util/helpers"),r=t("../util/oo"),o=t("./AbstractDocument"),a=t("./data/NodeIndex"),l=t("./AnnotationIndex"),u=t("./AnchorIndex"),c=t("./TransactionDocument"),h=t("./DocumentChange"),p=t("./PathEventProxy"),d=t("./ClipboardImporter"),f=t("./ClipboardExporter"),m=0;n.Prototype=function(){this.isTransaction=function(){return!1},this.newInstance=function(){var t=this.constructor;return new t(this.schema)},this.fromSnapshot=function(t){var e=this.newInstance();return e.loadSeed(t),e},this.documentDidLoad=function(){this.stage.reset(),this.done=[],this.FORCE_TRANSACTIONS=!0},this.clear=function(){var t=this;this.transaction(function(e){s.each(t.data.nodes,function(t){e["delete"](t.id)})}),this.documentDidLoad()},this.getEventProxy=function(t){return this.eventProxies[t]},this.transaction=function(t,e,i){if(1===arguments.length&&(i=arguments[0],e={},t={}),2===arguments.length?(i=arguments[1],e={}):e=e||{},!s.isFunction(i))throw new Error("Document.transaction() requires a transformation function.");var n=this.startTransaction(s.clone(t));try{var r=i(n,t);r||(r={});var o={};for(var a in t)r[a]?o[a]=r[a]:o[a]=t[a];this.isTransacting&&n.save(o,e)}finally{n.finish()}},this.startTransaction=function(t){if(this.isTransacting)throw new Error("Nested transactions are not supported.");return this.isTransacting=!0,this.stage.before=t||{},this.emit("transaction:started",this.stage),this.stage},this.create=function(t){if(this.FORCE_TRANSACTIONS)throw new Error("Use a transaction!");return this.isTransacting?this.stage.create(t):(this.stage&&this.stage.create(t),this._create(t)),this.data.get(t.id)},this["delete"]=function(t){if(this.FORCE_TRANSACTIONS)throw new Error("Use a transaction!");this.isTransacting?this.stage["delete"](t):(this.stage&&this.stage["delete"](t),this._delete(t))},this.set=function(t,e){if(this.FORCE_TRANSACTIONS)throw new Error("Use a transaction!");return this.isTransacting?this.stage.set(t,e):(this.stage&&this.stage.set(t,e),this._set(t,e))},this.update=function(t,e){if(this.FORCE_TRANSACTIONS)throw new Error("Use a transaction!");return this.isTransacting?this.stage.update(t,e):(this.stage&&this.stage.update(t,e),this._update(t,e))},this.undo=function(){var t=this.done.pop();if(t){var e=t.invert();this._apply(e),this.undone.push(e),this._notifyChangeListeners(e,{replay:!0})}else console.error("No change can be undone.")},this.redo=function(){var t=this.undone.pop();if(t){var e=t.invert();this._apply(e),this.done.push(e),this._notifyChangeListeners(e,{replay:!0})}else console.error("No change can be redone.")},this.getDocumentMeta=function(){return this.get("document")},this.getClipboardImporter=function(){return new d({schema:this.getSchema()})},this.getClipboardExporter=function(){return new f},this.getHighlights=function(){return this._highlights},this.setHighlights=function(t){var e=this._highlights;e&&s.each(e,function(t){var e=this.get(t);e&&e.setHighlighted(!1)},this),s.each(t,function(t){var e=this.get(t);e.setHighlighted(!0)},this),this._highlights=t,this.emit("highlights:updated",t)},this._setAutoAttach=function(t){n["super"].prototype._setAutoAttach.call(this,t),this.stage._setAutoAttach(t)},this._saveTransaction=function(t,e,i){if(!this.isTransacting)throw new Error("Not in a transaction.");this.isTransacting=!1;var n=this.stage.getOperations();if(n.length>0){var s=new h(n,t,e);this._apply(s,"skipStage"),this.done.push(s),this.undone=[],this._notifyChangeListeners(s,i)}},this._cancelTransaction=function(){if(!this.isTransacting)throw new Error("Not in a transaction.");this.isTransacting=!1},this._apply=function(t,e){if(this.isTransacting)throw new Error("Can not replay a document change during transaction.");"skipStage"!==e&&this.stage.apply(t),s.each(t.ops,function(t){this.data.apply(t),this._updateContainers(t),this.emit("operation:applied",t)},this)},this._notifyChangeListeners=function(t,e){e=e||{},this.emit("document:changed",t,e,this)},this.updateEventProxies=function(t,e){s.each(this.eventProxies,function(i){i.onDocumentChanged(t,e,this)},this)}},r.inherit(n,o),Object.defineProperty(n.prototype,"id",{get:function(){return this.getDocumentMeta().guid},set:function(){throw new Error("Id is an immutable property.")}}),e.exports=n},{"../util/helpers":315,"../util/oo":317,"./AbstractDocument":54,"./AnchorIndex":55,"./AnnotationIndex":57,"./ClipboardExporter":59,"./ClipboardImporter":60,"./DocumentChange":66,"./PathEventProxy":73,"./TransactionDocument":80,"./data/NodeIndex":88}],66:[function(t,e,i){"use strict";function n(t,e,i){this.id=o(),this.ops=t.slice(0),this.before=e,this.after=i,this.updated=null,this.created=null,this.deleted=null,this._init(),Object.freeze(this),Object.freeze(this.ops),Object.freeze(this.before),Object.freeze(this.after)}var s=t("../util/oo"),r=t("../util/PathAdapter"),o=t("../util/uuid");n.Prototype=function(){this._init=function(){var t,e=this.ops,i={},n={},s=new r.Arrays;for(t=0;t<e.length;t++){var o=e[t];"create"===o.type&&(i[o.val.id]=o.val,delete n[o.val.id]),"delete"===o.type&&(delete i[o.val.id],delete s[o.val.id],n[o.val.id]=o.val),("set"===o.type||"update"===o.type)&&s.add(o.path,o)}this.created=i,this.deleted=n,this.updated=s},this.isAffected=function(t){return!!this.updated.get(t)},this.isUpdated=this.isAffected,this.invert=function(){for(var t=[],e=this.ops.length-1;e>=0;e--)t.push(this.ops[e].invert());var i=this.after,s=this.before;return new n(t,i,s)},this.traverse=function(t,e){this.updated.traverse(function(){t.apply(e,arguments)})},this.getUpdates=function(t){return this.updated.get(t)||[]},this.getCreated=function(){return this.created},this.getDeleted=function(){return this.deleted}},s.initClass(n),e.exports=n},{"../util/PathAdapter":313,"../util/oo":317,"../util/uuid":318}],67:[function(t,e,i){"use strict";var n=t("../util/jquery"),s=t("../util/helpers"),r=t("./data/Node"),o=r.extend({displayName:"DocumentNode",name:"node",attach:function(t){this.document=t,this.didAttach(t)},detach:function(){var t=this.document;s.each(this.constructor.schema,function(e,i){t.getEventProxy("path").remove([this.id,i],this)}),this.document=null,this.didDetach(t)},didAttach:function(){},didDetach:function(){},isAttached:function(){return null!==this.document},getDocument:function(){return this.document},hasParent:function(){return!!this.parent},getParent:function(){return this.document.get(this.parent)},hasChildren:function(){return!1},getChildIndex:function(t){return-1},getChildAt:function(t){return null},getChildCount:function(){return 0},getRoot:function(){for(var t=this;t.hasParent();)t=t.getParent();return t},getComponents:function(){var t=this.constructor["static"].components||[];return 0===t.length&&console.warn("Contract: a node must define its editable properties.",this.constructor["static"].name),t},getPropertyNameAt:function(t){var e=this.constructor["static"].components||[];return e[t]},setHighlighted:function(t){this.highlighted!==t&&(this.highlighted=t,this.emit("highlighted",t))},isExternal:function(){return this.constructor["static"].external},toHtml:function(t,e){return this.constructor["static"].toHtml(this,t,e)},connect:function(t,e){s.each(e,function(t,e){var i=/([a-zA-Z_0-9]+):changed/.exec(e);if(i){var n=i[1];this.constructor["static"].schema[n]&&this.getDocument().getEventProxy("path").add([this.id,n],this,this._onPropertyChange.bind(this,n))}},this),r.prototype.connect.apply(this,arguments)},disconnect:function(){r.prototype.disconnect.apply(this,arguments)},_onPropertyChange:function(t){var e=[t+":changed"].concat(Array.prototype.slice.call(arguments,1));this.emit.apply(this,e)}});o["static"].toHtml=function(t,e){var i=n("<div itemscope>").attr("data-id",t.id).attr("data-type",t.type);return s.each(t.properties,function(s,r){var o=n("<div>").attr("itemprop",r);"string"===t.getPropertyType?o[0].appendChild(e.annotatedText([t.id,r])):o.text(s),i.append(o)}),i},o["static"].external=!1,e.exports=o},{"../util/helpers":315,"../util/jquery":316,"./data/Node":86}],68:[function(t,e,i){"use strict";function n(t,e){n["super"].call(this,t,e)}var s=t("../util/oo"),r=t("./data/Schema"),o=t("./DocumentNode"),a=t("./Annotation"),l=t("./Container"),u=t("./ContainerAnnotation");n.Prototype=function(){this.getDefaultTextType=function(){throw new Error("DocumentSchema.getDefaultTextType() is abstract and must be overridden.")},this.isAnnotationType=function(t){var e=this.getNodeClass(t);return e&&e.prototype instanceof a},this.getBuiltIns=function(){return[o,a,l,u]}},s.inherit(n,r),e.exports=n},{"../util/oo":317,"./Annotation":56,"./Container":61,"./ContainerAnnotation":62,"./DocumentNode":67,"./data/Schema":91}],69:[function(t,e,i){"use strict";function n(){this._merge={},this._mergeComponents={},this._break={}}var s=t("../util/oo");n.Prototype=function(){this.defineMerge=function(t,e,i){return this._merge[t]||(this._merge[t]={}),this._merge[t][e]=i,this},this.canMerge=function(t,e){return this._merge[t]&&this._merge[t][e]},this.getMerger=function(t,e){return this._merge[t][e]},this.defineComponentMerge=function(t,e){this._mergeComponents[t]=e},this.canMergeComponents=function(t){return this._mergeComponents[t]},this.getComponentMerger=function(t){return this._mergeComponents[t]},this.defineBreak=function(t,e){return this._break[t]=e,this},this.canBreak=function(t){return this._break[t]},this.getBreaker=function(t){return this._break[t]}},s.initClass(n),e.exports=n},{"../util/oo":317}],70:[function(t,e,i){"use strict";function n(t){this.config=t||{},this.state=null}var s=t("../util/oo"),r=t("./Annotator"),o="undefined"!=typeof window,a=t("../util/jquery");n.Prototype=function(){this.convert=function(t,e){throw new Error("Method is abstract.")},this.getNodeConverter=function(t){return t.constructor},this.convertProperty=function(t,e,i){this.initialize(t,i);var n=a("<div>").append(this.annotatedText(e));return n.html()},this.initialize=function(t,e){e={}||e,this.state={doc:t,options:e}},this.convertNode=function(t){var e=this.getNodeConverter(t);return e["static"].toHtml(t,this)},this.convertContainer=function(t){for(var e=this.state,i=t.nodes,n=[],s=0;s<i.length;s++){var r=e.doc.get(i[s]),o=this.convertNode(r);if(!o||!this.isElementNode(o[0]))throw new Error("Contract: Node.static.toHtml() must return a DOM element. NodeType: "+r.type);o.attr("id",r.id),n.push(o)}return n},this.annotatedText=function(t){var e=this,i=this.state.doc,n=i.getIndex("annotations").get(t),s=i.get(t),o=new r;o.onText=function(t,e){t.children.push(e)},o.onEnter=function(t){var e=t.node;return{annotation:e,children:[]}},o.onExit=function(t,i,n){var s=i.annotation,r=e.getNodeConverter(s),o=r["static"].toHtml(s,e,i.children);if(!o||!e.isElementNode(o[0]))throw new Error("Contract: Annotation.toHtml() must return a DOM element.");o.attr("id",s.id),n.children.push(o)};var a={children:[]};return o.start(a,s,n),a.children},this.isElementNode=function(t){return o?t.nodeType===window.Node.ELEMENT_NODE:"tag"===t.type},this.createHtmlDocument=function(){var t="<!DOCTYPE html><html><head></head><body></body></html>";if(o){var e=new window.DOMParser,i=e.parseFromString(t,"text/html");return a(i)}var n=a.load(t).root();return n},this.getDocument=function(){return this.state.doc},this.createXmlDocument=function(){var t='<article xmlns="http://www.w3.org/1999/xhtml"></article>';if(o){var e=new window.DOMParser,i=e.parseFromString(t,"text/xml");return a(i)}var n=a.load(t).root();return n}},s.initClass(n),e.exports=n},{"../util/jquery":316,"../util/oo":317,"./Annotator":58}],71:[function(t,e,i){"use strict";function n(t){this.config=t||{},this.nodeTypesByName={},this.nodeTypes=[],this.blockTypes=[],this.inlineTypes=[],this.config.schema&&this.config.schema.each(function(t){this.defineNodeImporter(t)},this),this.$=s}var s=t("../util/jquery"),r=t("../util/helpers"),o=t("../util/uuid"),a="undefined"!=typeof window;n.Prototype=function(){this.defineNodeImporter=function(t){t["static"].matchElement&&(this.nodeTypes.push(t),this.nodeTypesByName[t["static"].name]=t,t["static"].blockType?this.blockTypes.push(t):t["static"].isInline&&this.inlineTypes.push(t))},this.defaultConverter=function(t,e){console.warn("This element is not handled by the converters you provided. This is the default implementation which just skips conversion. Override HtmlImporter.defaultConverter(el, converter) to change this behavior.",this.$toStr(t));var i=this.state.doc.getSchema().getDefaultTextType(),n=this.nodeTypesByName[i];if(!n)throw new Error("Could not class for default text type",i);var s=n["static"].fromHtml(t,e);return s&&(s.type=i),s},this.initialize=function(t,e){var i={doc:t,$root:e,inlineNodes:[],trimWhitespaces:!!this.config.trimWhitespaces,stack:[],lastChar:"",skipTypes:{},ignoreAnnotations:!1};this.state=i},this.convert=function(t,e){throw new Error("This method is abstract.")},this.convertContainer=function(t,e){var i=this.state,s=i.doc,r=s.get(e);i.containerNode=r;for(var a=new n.ChildNodeIterator(t[0]);a.hasNext();){var l,u=a.next(),c=this.$(u),h=this._getBlockTypeForElement(c);if(h){if(l=h["static"].fromHtml(c,this),!l)throw new Error("Contract: a Node's fromHtml() method must return a node",this.$toStr(c));l.type=h["static"].name,l.id=l.id||c.attr("id")||o(l.type),s.create(l),r.show(l.id)}else if(this.isCommentNode(u));else if(this.isTextNode(u)){var p=c.text();if(/^\s*$/.exec(p))continue;a.back(),this.wrapInlineElementsIntoBlockElement(a)}else if(this.isElementNode(u)){var d=this._getInlineTypeForElement(c);d||"span"===this.getTagName(u)?(a.back(),this.wrapInlineElementsIntoBlockElement(a)):this.createDefaultBlockElement(c)}}},this.finish=function(){for(var t=this.state.doc,e=0;e<this.state.inlineNodes.length;e++){var i=this.state.inlineNodes[e];t.create(i)}},this.convertProperty=function(t,e,i){var n=this.$("<div>").html(i);this.initialize(t,n);var s=this.annotatedText(n,e);t.setText(e,s,this.state.inlineNodes)},this.convertElement=function(t,e){var i=this.state.doc,n=this._getNodeTypeForElement(t);if(!n)throw new Error("Could not find a node class associated to element:"+this.$toStr(t));var s=n["static"].fromHtml(t,this);return s.type=n["static"].name,s.id=s.id||this.defaultId(t,s.type),r.extend(s,e),i.create(s)},this.getDocument=function(){return this.state.doc},this.getTagName=function(t){return t.tagName?t.tagName.toLowerCase():""},this.isTextNode=function(t){return a?t.nodeType===window.Node.TEXT_NODE:"text"===t.type},this.isElementNode=function(t){return a?t.nodeType===window.Node.ELEMENT_NODE:"tag"===t.type},this.isCommentNode=function(t){return a?t.nodeType===window.Node.COMMENT_NODE:"comment"===t.type},this.wrapInlineElementsIntoBlockElement=function(t){for(var e=this.state,i=e.doc,n=e.containerNode,s=this.$("<div>");t.hasNext();){var r=t.next(),o=this.$(r),a=this._getBlockTypeForElement(o);if(a){t.back();break}s.append(o.clone())}var l=this.defaultConverter(s,this);if(l){if(!l.type)throw new Error("Contract: Html.defaultConverter() must return a node with type.");l.id=l.id||this.nextId(l.type),i.create(l),n.show(l.id)}},this.createDefaultBlockElement=function(t){var e=this.state,i=e.doc,n=e.containerNode,s=this.defaultConverter(t,this);if(s){if(!s.type)throw new Error("Contract: Html.defaultConverter() must return a node with type.",this.$toStr(t));s.id=s.id||this.defaultId(t,s.type),i.create(s),n.show(s.id)}},this.annotatedText=function(t,e){var i=this.state;if(e){if(i.stack.length>0)throw new Error("Contract: it is not allowed to bind a new call annotatedText to a path while the previous has not been completed.",this.$toStr(t));i.stack=[{path:e,offset:0,text:""}]}else if(0===i.stack.length)throw new Error("Contract: HtmlImporter.annotatedText() requires 'path' for non-reentrant call.",this.$toStr(t));this.state.lastChar="";var s=new n.ChildNodeIterator(t[0]),r=this._annotatedText(s);return e&&i.stack.pop(),r},this.plainText=function(t){var e=this.state,i=t.text();if(e.stack.length>0){var n=r.last(e.stack);n.offset+=i.length,n.text+=n.text.concat(i)}return i},this.customText=function(t){var e=this.state;if(e.stack.length>0){var i=r.last(e.stack);i.offset+=t.length,i.text+=i.text.concat(t)}return t},this.nextId=function(t){return o(t)},this.trimTextContent=function(t){var e,i,n=t[0].childNodes,s=n[0],o=r.last(n);return s&&"text"===this._getDomNodeType(s)&&(e=s.textContent,i=this.trimLeft(e),s.textContent=i),o&&"text"===this._getDomNodeType(o)&&(e=o.textContent,i=this.trimRight(e),o.textContent=i),t},this.warning=function(t){console.warn("[HtmlImporter] "+t)},this.error=function(t){console.error("[HtmlImporter] "+t)},this.defaultId=function(t,e){for(var i=t.attr("id")||this.nextId(e);this.state.doc.get(i);)i=this.nextId(e);return i},this._annotatedText=function(t){var e=this.state,i=r.last(e.stack);if(!i)throw new Error("Illegal state: context is null.");for(;t.hasNext();){var n=t.next(),s=this.$(n),o="";if(this.isTextNode(n))o=this._prepareText(e,s.text()),o.length&&(i.text=i.text.concat(o),i.offset+=o.length);else{if(this.isCommentNode(n))continue;if(this.isElementNode(n)){var a=this._getInlineTypeForElement(s);if(!a){var l=this._getInlineTypeForElement(s);if(l)throw new Error("Expected inline element. Found block element:",this.$toStr(s));console.warn("Unsupported inline element. We will not create an annotation for it, but process its children to extract annotated text.",this.$toStr(s)),this.annotatedText(s);continue}var u,c=i.offset;if(a["static"].fromHtml){if(e.stack.push({path:i.path,offset:c,text:""}),u=a["static"].fromHtml(s,this),!u)throw new Error("Contract: a Node's fromHtml() method must return a node",this.$toStr(s));a["static"].external&&this.customText("​");var h=e.stack.pop();i.offset=h.offset,i.text=i.text.concat(h.text)}else u={},this.annotatedText(s);var p=i.offset;u.type=a["static"].name,u.id=u.id||this.nextId(u.type),u.startOffset=c,u.endOffset=p,u.path=i.path.slice(0),e.inlineNodes.push(u)}else console.warn("Unknown element type. Taking plain text.",this.$toStr(s)),o=this._prepareText(e,s.text()),i.text=i.text.concat(o),i.offset+=o.length}}return i.text},this._getBlockTypeForElement=function(t){if(!t[0].tagName)return null;for(var e=0;e<this.blockTypes.length;e++)if(this.blockTypes[e]["static"].matchElement(t))return this.blockTypes[e]},this._getInlineTypeForElement=function(t){for(var e=0;e<this.inlineTypes.length;e++)if(this.inlineTypes[e]["static"].matchElement(t))return this.inlineTypes[e]},this._getNodeTypeForElement=function(t){for(var e=0;e<this.nodeTypes.length;e++)if(this.nodeTypes[e]["static"].matchElement(t))return this.nodeTypes[e]},this._getDomNodeType=function(t){if(this.isTextNode(t))return"text";if(this.isCommentNode(t))return"comment";if(t.tagName)return t.tagName.toLowerCase();throw new Error("Unknown node type")};var t=/^\s+/g,e=/^\s*/g,i=/\s+$/g,l=/\s+/g,u=" ",c=/[\t\n\r]+/g;this._prepareText=function(n,s){if(!n.trimWhitespaces)return s;var r=u;return s=s.replace(c,u),s=n.lastChar===u?s.replace(e,r):s.replace(t,r),s=s.replace(i,r),this.config.REMOVE_INNER_WS&&(s=s.replace(l,u)),n.lastChar=s[s.length-1]||n.lastChar,s},this.trimLeft=function(e){return e.replace(t,"")},this.trimRight=function(t){return t.replace(i,"")},this.$toStr=function(t){var e=t.clone();return e.empty(),s("<p>").append(e).html()}},n.prototype=new n.Prototype,n.ChildNodeIterator=function(t){this.nodes=t.childNodes,this.length=this.nodes.length,this.pos=-1},n.ChildNodeIterator.Prototype=function(){this.hasNext=function(){return this.pos<this.length-1},this.next=function(){return this.pos+=1,this.nodes[this.pos]},this.back=function(){return this.pos>=0&&(this.pos-=1),this}},n.ChildNodeIterator.prototype=new n.ChildNodeIterator.Prototype,e.exports=n},{"../util/helpers":315,"../util/jquery":316,"../util/uuid":318}],72:[function(t,e,i){"use strict";function n(t){this._childrenProperty=t}var s=t("../util/oo");n.Prototype=function(){this.hasChildren=function(){return!0},this.getChildIndex=function(t){return this[this._childrenProperty].indexOf(t.id)},this.getChildAt=function(t){return this.getDocument().get(this[this._childrenProperty][t])},this.getChildCount=function(){return this[this._childrenProperty].length}},s.initClass(n),e.exports=n},{"../util/oo":317}],73:[function(t,e,i){"use strict";var n=t("../util/helpers"),s=t("../util/oo"),r=t("../util/PathAdapter"),o=function(t){this.listeners=new r,this._list=[],this.doc=t};o.Prototype=function(){this.onDocumentChanged=function(t,e,i){function s(e,i){t.deleted[e[0]]||a.add(e,i)}function r(t,e,n,r){for(var o=i.get(t),a=o.getPathRange(e,n),l=0;l<a.length;l++)s(a[l],r)}var o=this.listeners,a=t.updated;n.each(t.ops,function(t){if("create"!==t.type&&"delete"!==t.type||!t.val.path&&!t.val.startPath)if("set"!==t.type||"path"!==t.path[1]&&"startPath"!==t.path[1]&&"endPath"!==t.path[1]){if("set"===t.type&&("startOffset"===t.path[1]||"endOffset"===t.path[1])){var e=this.doc.get(t.path[0]);e&&(e.path?s(e.path,t):r(e.container,e.startPath,e.endPath,t))}}else s(t.val,t),s(t.original,t);else t.val.path?s(t.val.path,t):t.val.startPath&&r(t.val.container,t.val.startPath,t.val.endPath,t)},this),t.traverse(function(s){var r=s.concat(["listeners"]),a=o.get(r);n.each(a,function(n){n.method.call(n.listener,t,e,i)})},this)},this.add=function(t,e,i){var n=t.concat(["listeners"]),s=this.listeners.get(n);if(s||(s=[],this.listeners.set(n,s)),!i)throw new Error("Invalid argument: expected function but got "+i);s.push({method:i,listener:e})},this.connect=function(t,e,i){this.add(e,t,i)},this.remove=function(t,e){var i=t.concat(["listeners"]),n=this.listeners.get(i);if(n)for(var s=0;s<n.length;s++)if(n[s].listener===e)return void n.splice(s,1)},this.disconnect=function(t,e){this.remove(e,t)}},s.initClass(o),e.exports=o},{"../util/PathAdapter":313,"../util/helpers":315,"../util/oo":317}],74:[function(t,e,i){"use strict";function n(t){var e=t.path,i=t.startOffset,n=t.endOffset||t.startOffset;if(!e||!s.isNumber(i))throw new Error("Invalid arguments: `path` and `startOffset` are mandatory");this.range=new l(new a(e,i),new a(e,n)),this.reverse=t.reverse,this._internal={},Object.freeze(this)}var s=t("../util/helpers"),r=t("../util/oo"),o=t("./Selection"),a=t("./Coordinate"),l=t("./Range");n.Prototype=function(){s.extend(this,o.prototype),this.toJSON=function(){return{type:"property",path:this.path,startOffset:this.startOffset,endOffset:this.endOffset,reverse:this.reverse}},this.getDocument=function(){var t=this._internal.doc;if(!t)throw new Error("Selection is not attached to a document.");return t},this.attach=function(t){return this._internal.doc=t,this},this.isNull=function(){return!1},this.getRanges=function(){return[this.range]},this.getRange=function(){return this.range},this.isCollapsed=function(){return this.range.isCollapsed()},this.isReverse=function(){return this.reverse},this.isPropertySelection=function(){return!0},this.isMultiSeletion=function(){return!1},this.equals=function(t){return o.prototype.equals.call(this,t)&&!t.isTableSelection()&&this.range.equals(t.range)},this.collapse=function(t){var e;return e="left"===t?this.range.start:this.range.end,this.createWithNewRange(e.offset,e.offset)},this.getPath=function(){return this.range.start.path},this.getStartOffset=function(){return this.range.start.offset},this.getEndOffset=function(){return this.range.end.offset},this.toString=function(){return["PropertySelection(",JSON.stringify(this.range.start.path),", ",this.range.start.offset," -> ",this.range.end.offset,this.reverse?", reverse":"",this.range.start.after?", after":"",")"].join("")},this.isInsideOf=function(t,e){return t.isNull()?!1:t.isContainerSelection()?t.contains(this):e?s.isEqual(this.path,t.path)&&this.start.offset>t.start.offset&&this.end.offset<t.end.offset:s.isEqual(this.path,t.path)&&this.start.offset>=t.start.offset&&this.end.offset<=t.end.offset},this.contains=function(t,e){return t.isNull()?!1:t.isContainerSelection()?t.isInsideOf(this):e?s.isEqual(this.path,t.path)&&this.start.offset<t.start.offset&&this.end.offset>t.end.offset:s.isEqual(this.path,t.path)&&this.start.offset<=t.start.offset&&this.end.offset>=t.end.offset},this.overlaps=function(t,e){return t.isNull()?!1:t.isContainerSelection()?t.overlaps(this):s.isEqual(this.getPath(),t.getPath())?e?!(this.startOffset>=t.endOffset||this.endOffset<=t.startOffset):!(this.startOffset>t.endOffset||this.endOffset<t.startOffset):!1},this.isRightAlignedWith=function(t){return t.isNull()?!1:t.isContainerSelection()?t.isRightAlignedWith(this):s.isEqual(this.getPath(),t.getPath())&&this.getEndOffset()===t.getEndOffset()},this.isLeftAlignedWith=function(t){return t.isNull()?!1:t.isContainerSelection()?t.isLeftAlignedWith(this):s.isEqual(this.getPath(),t.getPath())&&this.getStartOffset()===t.getStartOffset()},this.expand=function(t){if(t.isNull())return this;if(t.isContainerSelection())return t.expand(this);if(!s.isEqual(this.path,t.path))throw new Error("Can not expand PropertySelection to a different property.");var e=Math.min(this.startOffset,t.startOffset),i=Math.max(this.endOffset,t.endOffset);return this.createWithNewRange(e,i)},this.createWithNewRange=function(t,e){return new n({path:this.path,startOffset:t,endOffset:e})},this.truncate=function(t){if(t.isNull())return this;if(!s.isEqual(this.start.path,t.start.path)||!s.isEqual(this.end.path,t.end.path))throw new Error("Can not expand PropertySelection to a different property.");var e,i;return this.startOffset===t.startOffset?(e=t.endOffset,i=this.endOffset):this.endOffset===t.endOffset&&(e=this.startOffset,i=t.startOffset),this.createWithNewRange(e,i)},this._coordinates=function(){return this},this.getFragments=function(){return this.isCollapsed()?[new o.Fragment("cursor",this.path,this.startOffset)]:[new o.Fragment("selection-fragment",this.path,this.startOffset,this.endOffset)];
}},r.inherit(n,o),Object.defineProperties(n.prototype,{start:{get:function(){return this.range.start},set:function(){throw new Error("immutable.")}},end:{get:function(){return this.range.end},set:function(){throw new Error("immutable.")}},path:{get:function(){return this.range.start.path},set:function(){throw new Error("immutable.")}},startOffset:{get:function(){return this.range.start.offset},set:function(){throw new Error("immutable.")}},endOffset:{get:function(){return this.range.end.offset},set:function(){throw new Error("immutable.")}},collapsed:{get:function(){return this.isCollapsed()},set:function(){throw new Error("immutable.")}}}),e.exports=n},{"../util/helpers":315,"../util/oo":317,"./Coordinate":64,"./Range":75,"./Selection":76}],75:[function(t,e,i){"use strict";var n=t("../util/oo"),s=function(t,e){this.start=t,this.end=e,Object.freeze(this)};s.Prototype=function(){this.isCollapsed=function(){return this.start.equals(this.end)},this.equals=function(t){return this===t?!0:this.start.equals(t.start)&&this.end.equals(t.end)}},n.initClass(s),e.exports=s},{"../util/oo":317}],76:[function(t,e,i){"use strict";function n(){}var s=t("../util/helpers"),r=t("../util/oo"),o=t("../util/EventEmitter");n.Prototype=function(){this.getRanges=function(){return[]},this.isNull=function(){return!1},this.isMultiSeletion=function(){return!1},this.isPropertySelection=function(){return!1},this.isContainerSelection=function(){return!1},this.isTableSelection=function(){return!1},this.isCollapsed=function(){return!0},this.isReverse=function(){return!1},this.equals=function(t){return this===t?!0:t?this.isNull()!==t.isNull()?!1:!0:!1},this.toString=function(){return"null"}},r.initClass(n);var a=function(){};a.Prototype=function(){this.isNull=function(){return!0}},r.inherit(a,n),n.nullSelection=Object.freeze(new a),n.Fragment=function(t,e,i,n){o.call(this),this.type=t,this.path=e,this.startOffset=i,this.endOffset=n||i},n.Fragment.Prototype=function(){s.extend(this,o.prototype)},r.initClass(n.Fragment),e.exports=n},{"../util/EventEmitter":310,"../util/helpers":315,"../util/oo":317}],77:[function(t,e,i){"use strict";function n(t){if(this.tableId=t.tableId,t.rectangle?this.rectangle=t.rectangle:this.rectangle=new n.Rectangle(t.startRow,t.startCol,t.endRow,t.endCol),!this.tableId)throw new Error("Invalid arguments. `tableId` is mandatory.");this._internal={},Object.freeze(this)}var s=t("../util/oo"),r=t("./Selection");n.Prototype=function(){this.isPropertySelection=function(){return!1},this.isTableSelection=function(){return!0},this.isSingleCell=function(){return this.rectangle.isSingleCell()},this.getTableId=function(){return this.tableId},this.getRectangle=function(){return this.rectangle},this.equals=function(t){return r.prototype.equals.call(this,t)&&!t.isTableSelection()&&this.startRow===t.startRow&&this.endRow===t.endRow&&this.startCol===t.startCol&&this.ednCol===t.endCol},this.toString=function(){var t=this.rectangle;return"T[("+t.start.row+","+t.start.col+"), ("+t.end.row+", "+t.end.col+")]"},this.attach=function(t){return this._internal.doc=t,this}},s.inherit(n,r),Object.defineProperties(n.prototype,{startRow:{get:function(){return this.rectangle.start.row}},endRow:{get:function(){return this.rectangle.end.row}},startCol:{get:function(){return this.rectangle.start.col}},endCol:{get:function(){return this.rectangle.end.col}}}),n.Rectangle=function(t,e,i,n){var s=Math.min(t,i),r=Math.max(t,i),o=Math.min(e,n),a=Math.max(e,n);this.start={row:s,col:o},this.end={row:r,col:a},Object.freeze(this.start),Object.freeze(this.end),Object.freeze(this)},n.Rectangle.prototype.isSingleCell=function(){return this.start.row===this.end.row&&this.start.col===this.end.col},e.exports=n},{"../util/oo":317,"./Selection":76}],78:[function(t,e,i){"use strict";var n=t("./DocumentNode"),s=n.extend({displayName:"TextNode",name:"text",properties:{content:"string"},getTextPath:function(){return[this.id,"content"]},getText:function(){return this.content}});s["static"].components=["content"],e.exports=s},{"./DocumentNode":67}],79:[function(t,e,i){"use strict";function n(t,e){if(!t)throw new Error("Illegal arguments: doc is mandatory.");this.doc=t,this.containerId=e,this.records={},this.fragments={},this.selectionFragments=[],this.doc.connect(this,{"document:changed":this.onDocumentChange},{priority:-1}),this._initialize()}var s,r,o=t("../util/oo"),a=t("../util/helpers"),l=t("./ContainerAnnotation"),u=t("./data/TextOperation");n.Prototype=function(){function t(){var t=Object.create({get:function(e){var i=t[e];return i||(i=new r(e),t[e]=i),i}});return t}this.dispose=function(){this.doc.disconnect(this)},this._initializeFragment=function(t){var e=t.path,i=this.records[e];i||(i=new s(e),this.records[e]=i),i.fragments[t.id]=t},this._initialize=function(){this.hasContainer()&&a.each(this.doc.getNodes(),function(t){if(t.isInstanceOf("container-annotation")&&t.container===this.containerId){var e=t;a.each(e.getFragments(),this._initializeFragment,this)}},this)},this.hasContainer=function(){return!!this.containerId},this.renderSelection=function(t){var e=t.getFragments();a.each(e,function(t){var e=this.records[t.path];e&&(e.fragments[t.type]=t,e.property&&e.property.setFragments(a.values(e.fragments)))},this),this.selectionFragments=e},this.removeSelection=function(){0!==this.selectionFragments.length&&(a.each(this.selectionFragments,function(t){var e=this.records[t.path];e&&(delete e.fragments[t.type],e.property&&e.property.setFragments(a.values(e.fragments)))},this),this.selectionFragments=[])},this.registerProperty=function(t){var e=t.getPath(),i=this.records[e];if(i&&i.property&&i.property!==t)throw new Error("Property already registered.");i||(i=new s(e),this.records[e]=i),i.property=t},this.unregisterProperty=function(t){var e=t.getPath(),i=this.records[e];if(!i)return void console.warn("No property registered for path "+e.toString());if(i.property!==t)throw new Error("Registered property is different for path "+e.toString());i.property=null},this.getFragments=function(t){var e=this.records[t];return e?a.values(e.fragments):[]},this.onDocumentChange=function(t){var e=this._record(t);this._dispatch(e,t)},this._record=function(e){for(var i=t(),n=0;n<e.ops.length;n++){var s=e.ops[n];"update"===s.type&&s.diff instanceof u||"set"===s.type&&a.isString(s.val)?this._recordTextChange(i,s):("create"!==s.type&&"delete"!==s.type||!s.val.path)&&("set"!==s.type||"path"!==s.path[1])?("create"!==s.type&&"delete"!==s.type||!s.val.startPath)&&("update"!==s.type&&"set"!==s.type||"startPath"!==s.path[1]&&"endPath"!==s.path[1])?"update"!==s.type&&"set"!==s.type||"startOffset"!==s.path[1]&&"endOffset"!==s.path[1]||this._recordMixedAnnoChange(i,s):this._recordContainerAnnoChange(i,s):this._recordAnnoChange(i,s)}return i},this._recordTextChange=function(t,e){t.get(e.path).rerender=!0},this._recordMixedAnnoChange=function(t,e){var i=this.doc,n=i.get(e.path[0]);n&&(n instanceof l?this._recordContainerAnnoChange(t,e):this._recordAnnoChange(t,e))},this._recordAnnoChange=function(t,e){var i=this.doc;if("create"===e.type||"delete"===e.type)t.get(e.val.path).rerender=!0;else if("set"===e.type&&"path"===e.path[1])t.get(e.original).rerender=!0,t.get(e.val).rerender=!0;else if("set"===e.type&&("startOffset"===e.path[1]||"endOffset"===e.path[1])){var n=i.get(e.path[0]);n&&(t.get(n.path).rerender=!0)}},this._recordContainerAnnoChange=function(t,e){var i,n,s,r,o=this.doc;if("create"===e.type)for(s=o.get(e.val.id),n=s.getFragments(),r=0;r<n.length;r++)i=t.get(n[r].path),i.didAddFragment(n[r]);else if("delete"===e.type)for(n=this.fragments[e.val.id],r=0;r<n.length;r++)i=t.get(n[r].path),i.didRemoveFragment(n[r]);else if("set"===e.type)if("startPath"===e.path[1],0)"startOffset"===e.path[1]?(s=o.get(e.path[0]),t.get(s.startPath).rerender=!0):"endOffset"===e.path[1]&&(s=o.get(e.path[0]),t.get(s.endPath).rerender=!0);else{for(s=o.get(e.path[0]),n=this.fragments[s.id]||[],r=0;r<n.length;r++)i=t.get(n[r].path),i.didRemoveFragment(n[r]);for(n=s.getFragments(),r=0;r<n.length;r++)i=t.get(n[r].path),i.didAddFragment(n[r])}},this._dispatch=function(t,e){for(var i in t)if(t.hasOwnProperty(i)&&this.records[i]){var n=t[i];if(!e.deleted[n.path[0]]){var s=this.records[i];if(s){var r=!1,o=s.fragments,l=a.extend({},o);if(n.removedFragments){for(var u in n.removedFragments)delete l[u];s.fragments=l,r=!0}n.addedFragments&&(a.extend(l,n.addedFragments),s.fragments=l,r=!0),r?s.property.setFragments(a.values(s.fragments)):n.rerender&&s.property.update()}else console.warn("TextPropertyManager: something is fishy here. Saw a change, but don't know property:",i)}}}},o.initClass(n);var s=function(t){this.path=t,this.property=null,this.fragments={}};o.initClass(s);var r=function(t){this.path=t,this.rerender=!1,this.addedFragments=null,this.removedFragments=null};r.Prototype=function(){this.didAddFragment=function(t){this.addedFragments||(this.addedFragments={}),this.addedFragments[t.id]=t},this.didRemoveFragment=function(t){this.removedFragments||(this.removedFragments={}),this.removedFragments[t.id]=t}},o.initClass(r),e.exports=n},{"../util/helpers":315,"../util/oo":317,"./ContainerAnnotation":62,"./data/TextOperation":92}],80:[function(t,e,i){"use strict";function n(t){o.call(this,t.schema),this.__id__="TX_"+a++,this.document=t,this.ops=[],this.before={},s.each(t.data.indexes,function(t,e){this.data.addIndex(e,t.clone())},this),this.loadSeed(t.toJSON())}var s=t("../util/helpers"),r=t("../util/oo"),o=t("./AbstractDocument"),a=0;n.Prototype=function(){this.isTransaction=function(){return!0},this.reset=function(){this.ops=[],this.before={},this._resetContainers()},this.create=function(t){var e=this.data.create(t);if(e)return this.document.isTransacting&&this.ops.push(e),this.data.get(t.id)},this["delete"]=function(t){var e=this.data["delete"](t);if(e)return this.document.isTransacting&&this.ops.push(e),e},this.set=function(t,e){var i=this.data.set(t,e);if(i)return this._updateContainers(i),this.document.isTransacting&&this.ops.push(i),i},this.update=function(t,e){var i=this.data.update(t,e);if(i)return this._updateContainers(i),this.document.isTransacting&&this.ops.push(i),i},this.save=function(t,e){var i=this.before,n=s.extend({},i,t);this.document._saveTransaction(i,n,e),this.reset()},this.cancel=function(){for(var t=this.ops.length-1;t>=0;t--)this.data.apply(this.ops[t].invert());this.document._cancelTransaction(),this.reset()},this.finish=function(){this.document.isTransacting&&this.cancel()},this.cleanup=this.finish,this.getOperations=function(){return this.ops},this.apply=function(t){s.each(t.ops,function(t){this.data.apply(t),this._updateContainers(t)},this)},this.getIndex=function(t){return this.data.getIndex(t)},this._didCreateNode=function(t){t.document=this},this._didDeleteNode=function(t){t.document=null},this.createSelection=function(){return this.document.createSelection.apply(this,arguments)},this.getSchema=function(){return this.schema}},r.inherit(n,o),e.exports=n},{"../util/helpers":315,"../util/oo":317,"./AbstractDocument":54}],81:[function(t,e,i){"use strict";var n=t("../util/helpers"),s=function(t,e,i,s){if(i){var r=t.getIndex("annotations"),o=r.get(e.path);n.each(o,function(n){if(!s||!s[n.id]){var r=e.offset,o=n.startOffset,a=n.endOffset,l=o,u=a;(o>r||r===o)&&(l+=i),(a>r||r===a&&!n.isExternal())&&(u+=i),l!==o&&t.set([n.id,"startOffset"],l),u!==a&&t.set([n.id,"endOffset"],u)}}),r=t.getIndex("container-annotation-anchors");var a=r.get(e.path);n.each(a,function(n){var s=e.offset,r=n.offset,o=!1;if((r>s||s===r&&!e.after)&&(r+=i,o=!0),o){var a=n.isStart?"startOffset":"endOffset";t.set([n.id,a],r)}})}},r=function(t,e,i,s,r){if(i!==s){var o,a=t.getIndex("annotations"),l=a.get(e),u=s-i;r&&(o={}),n.each(l,function(e){var n=i,a=s,l=e.startOffset,c=e.endOffset,h=l,p=c;l>=a?(h-=u,p-=u,t.set([e.id,"startOffset"],h),t.set([e.id,"endOffset"],p)):(l>=n&&(h=l-Math.min(a-n,l-n)),c>=n&&(p=c-Math.min(a-n,c-n)),l!==c&&h===p?r&&n===i&&a===s?o[e.id]=e:t["delete"](e.id):(l!==h&&t.set([e.id,"startOffset"],h),c!==p&&t.set([e.id,"endOffset"],p)))}),a=t.getIndex("container-annotation-anchors");var c=a.get(e),h=[];return n.each(c,function(e){h.push(e.id);var n=i,r=s,o=e.offset,a=!1;if(o>=r)o-=u,a=!0;else if(o>=n){var l=o-Math.min(r-n,o-n);o!==l&&(o=l,a=!0)}if(a){var c=e.isStart?"startOffset":"endOffset";t.set([e.id,c],o)}}),n.each(n.uniq(h),function(e){var i=t.get(e),n=i.getSelection();n.isCollapsed()&&(console.log("...deleting container annotation because it has collapsed"+e),t["delete"](e))}),o}},o=function(t,e,i,s,r){var o=t.getIndex("annotations"),a=o.get(e,i);n.each(a,function(e){var o,a,l=i>e.startOffset&&i<e.endOffset,u=e.startOffset,c=e.endOffset;if(l){if(e.canSplit()){var h=n.clone(e.properties);h.id=n.uuid(e.type+"_"),h.startOffset=r,h.endOffset=r+e.endOffset-i,h.path=s,t.create(h)}o=e.startOffset,a=i,a===o?t["delete"](e.id):(o!==u&&t.set([e.id,"startOffset"],o),a!==c&&t.set([e.id,"endOffset"],a))}else e.startOffset>=i&&(o=r+e.startOffset-i,a=r+e.endOffset-i,t.set([e.id,"path"],s),t.set([e.id,"startOffset"],o),t.set([e.id,"endOffset"],a))}),o=t.getIndex("container-annotation-anchors");var l=o.get(e),u=[];n.each(l,function(e){u.push(e.id);var n=e.offset;if(n>=i){var o=e.isStart?"startPath":"endPath",a=e.isStart?"startOffset":"endOffset";t.set([e.id,o],s),t.set([e.id,a],r+e.offset-i)}}),n.each(n.uniq(u),function(e){var i=t.get(e),n=i.getSelection();n.isCollapsed()&&(console.log("...deleting container annotation because it has collapsed"+e),t["delete"](e))})};e.exports={insertedText:s,deletedText:r,transferAnnotations:o}},{"../util/helpers":315}],82:[function(t,e,i){"use strict";function n(t,e){t.pos===e.pos?e.pos+=1:t.pos<e.pos?e.pos+=1:t.pos+=1}function s(t,e){return t.pos===e.pos?(e.type=c,void(t.type=c)):void(t.pos<e.pos?e.pos-=1:t.pos-=1)}function r(t,e){if(t.type===h){var i=t;t=e,e=i}t.pos<=e.pos?e.pos+=1:t.pos-=1}var o=t("../../util/helpers"),a=t("../../util/oo"),l=t("./Operation"),u=t("./Conflict"),c="NOP",h="delete",p="insert",d=function(t){if(l.call(this),!t||null==t.type)throw new Error("Illegal argument: insufficient data.");if(this.type=t.type,this.type!==c){if(this.type!==p&&this.type!==h)throw new Error("Illegal type.");if(this.pos=t.pos,this.val=t.val,!o.isNumber(this.pos)||this.pos<0)throw new Error("Illegal argument: expecting positive number as pos.")}};d.fromJSON=function(t){return new d(t)},d.Prototype=function(){this.apply=function(t){if(this.type===c)return t;if(this.type===p){if(t.length<this.pos)throw new Error("Provided array is too small.");return t.splice(this.pos,0,this.val),t}if(t.length<this.pos)throw new Error("Provided array is too small.");if(!o.isEqual(t[this.pos],this.val))throw Error("Unexpected value at position "+this.pos+". Expected "+this.val+", found "+t[this.pos]);return t.splice(this.pos,1),t},this.clone=function(){var t={type:this.type,pos:this.pos,val:o.deepclone(this.val)};return new d(t)},this.invert=function(){var t=this.toJSON();return this.type===c?t.type=c:this.type===p?t.type=h:t.type=p,new d(t)},this.hasConflict=function(t){return d.hasConflict(this,t)},this.toJSON=function(){var t={type:this.type};return this.type===c?t:(t.pos=this.pos,t.val=o.deepclone(this.val),t)},this.isInsert=function(){return this.type===p},this.isDelete=function(){return this.type===h},this.getOffset=function(){return this.pos},this.getValue=function(){return this.val},this.isNOP=function(){return this.type===c},this.toString=function(){return["(",this.isInsert()?"+":"-",",",this.getOffset(),",'",this.getValue(),"')"].join("")}},a.inherit(d,l);var f=function(t,e){return t.type===c||e.type===c?!1:t.type===p&&e.type===p?t.pos===e.pos:!1},m=function(t,e,i){if(i=i||{},i["no-conflict"]&&f(t,e))throw new u(t,e);return i.inplace||(t=t.clone(),e=e.clone()),t.type===c||e.type===c||(t.type===p&&e.type===p?n(t,e):t.type===h&&e.type===h?s(t,e):r(t,e)),[t,e]};d.transform=m,d.hasConflict=f,d.Insert=function(t,e){return new d({type:p,pos:t,val:e})},d.Delete=function(t,e){return new d({type:h,pos:t,val:e})},d.NOP=c,d.DELETE=h,d.INSERT=p,e.exports=d},{"../../util/helpers":315,"../../util/oo":317,"./Conflict":83,"./Operation":90}],83:[function(t,e,i){"use strict";function n(t,e){Error.call(this,"Conflict: "+JSON.stringify(t)+" vs "+JSON.stringify(e)),this.a=t,this.b=e}n.prototype=Error.prototype,e.exports=n},{}],84:[function(t,e,i){"use strict";function n(t,e){a.call(this),this.schema=t,this.nodes=new o,this.indexes={},e=e||{},this.didCreateNode=e.didCreateNode||function(){},this.didDeleteNode=e.didDeleteNode||function(){}}var s=t("../../util/helpers"),r=t("../../util/oo"),o=t("../../util/PathAdapter"),a=t("../../util/EventEmitter");n.Prototype=function(){this.get=function(t){if(!t)throw new Error("Path or id required");return this.nodes.get(t)},this.getNodes=function(){return this.nodes},this.create=function(t){var e=this.schema.getNodeFactory().create(t.type,t);if(!e)throw new Error("Illegal argument: could not create node for data:",t);if(this.contains(e.id))throw new Error("Node already exists: "+e.id);if(!e.id||!e.type)throw new Error("Node id and type are mandatory.");return this.nodes[e.id]=e,s.each(this.indexes,function(t){t.select(e)&&t.create(e)}),this.didCreateNode(e),e},this["delete"]=function(t){var e=this.nodes[t];return delete this.nodes[t],this.didDeleteNode(e),s.each(this.indexes,function(t){t.select(e)&&t["delete"](e)}),e},this.set=function(t,e){var i=this.get(t[0]),n=this.nodes.get(t);return this.nodes.set(t,e),s.each(this.indexes,function(s){s.select(i)&&s.update(i,t,e,n)}),n},this.update=function(t,e){var i,n=this.nodes.get(t);if(e.isOperation)i=e.apply(n);else{var r,o,a,l;if(s.isString(n))if(e["delete"])r=e["delete"].start,o=e["delete"].end,i=n.split("").splice(r,o-r).join("");else{if(!e.insert)throw new Error("Diff is not supported:",JSON.stringify(e));a=e.insert.offset,l=e.insert.value,i=[n.substring(0,a),l,n.substring(a)].join("")}else{if(!s.isArray(n))throw new Error("Diff is not supported:",JSON.stringify(e));if(i=n.slice(0),e["delete"])a=e["delete"].offset,i.splice(a,1);else{if(!e.insert)throw new Error("Diff is not supported:",JSON.stringify(e));a=e.insert.offset,l=e.insert.value,i.splice(a,0,l)}}}this.nodes.set(t,i);var u=this.get(t[0]);return s.each(this.indexes,function(e){e.select(u)&&e.update(u,t,n,i)}),n},this.toJSON=function(){return{schema:[this.schema.id,this.schema.version],nodes:s.deepclone(this.nodes)}},this.contains=function(t){return!!this.nodes[t]},this.reset=function(){this.nodes=new o},this.addIndex=function(t,e){return this.indexes[t]&&console.error("Index with name %s already exists.",t),e.reset(this),this.indexes[t]=e,e},this.getIndex=function(t){return this.indexes[t]}},r.inherit(n,a),e.exports=n},{"../../util/EventEmitter":310,"../../util/PathAdapter":313,"../../util/helpers":315,"../../util/oo":317}],85:[function(t,e,i){"use strict";var n=t("../../util/oo"),s=t("../../util/helpers"),r=t("./Data"),o=t("./ObjectOperation"),a=t("./ArrayOperation"),l=t("./TextOperation"),u=function(t,e){u["super"].call(this,t,e)};u.Prototype=function(){this.create=function(t){var e=o.Create([t.id],t);return this.apply(e),e},this["delete"]=function(t){var e=null,i=this.get(t);if(i){var n=i.toJSON();e=o.Delete([t],n),this.apply(e)}return e},this.update=function(t,e){var i=this._getDiffOp(t,e),n=o.Update(t,i);return this.apply(n),n},this.set=function(t,e){var i=this.get(t),n=o.Set(t,i,e);return this.apply(n),n},this.apply=function(t){if(t.type!==o.NOP){if(t.type===o.CREATE)this["super"].create.call(this,s.deepclone(t.val));else if(t.type===o.DELETE)this["super"]["delete"].call(this,t.val.id);else if(t.type===o.UPDATE){var e=this.get(t.path),i=t.diff;if("array"===t.propertyType)i instanceof a||(i=a.fromJSON(i)),i.apply(e);else{if("string"!==t.propertyType)throw new Error("Unsupported type for operational update.");i instanceof l||(i=l.fromJSON(i));var n=i.apply(e);this["super"].set.call(this,t.path,n)}}else{if(t.type!==o.SET)throw new Error("Illegal state.");this["super"].set.call(this,t.path,t.val)}this.emit("operation:applied",t,this)}},this._getDiffOp=function(t,e){var i=null;if(e.isOperation)i=e;else{var n,r,o,u,c=this.get(t);if(null===c||void 0===c)throw new Error("Property has not been initialized: "+JSON.stringify(t));s.isString(c)?e["delete"]?(n=e["delete"].start,r=e["delete"].end,i=l.Delete(n,c.substring(n,r))):e.insert&&(o=e.insert.offset,u=e.insert.value,i=l.Insert(o,u)):s.isArray(c)&&(e["delete"]?(o=e["delete"].offset,i=a.Delete(o,c[o])):e.insert&&(o=e.insert.offset,u=e.insert.value,i=a.Insert(o,u)))}if(!i)throw new Error("Unsupported diff: "+JSON.stringify(e));return i}},n.inherit(u,r),e.exports=u},{"../../util/helpers":315,"../../util/oo":317,"./ArrayOperation":82,"./Data":84,"./ObjectOperation":89,"./TextOperation":92}],86:[function(t,e,i){"use strict";function n(t){a.call(this),this.properties=r.extend({},this.getDefaultProperties(),t),this.properties.type=this.constructor["static"].name,this.properties.id=this.properties.id||o(this.properties.type),this.didInitialize()}var s=t("../../util/oo"),r=t("../../util/helpers"),o=t("../../util/uuid"),a=t("../../util/EventEmitter");n.Prototype=function(){this.properties={type:"string",id:"string"},this.didInitialize=function(){},this.toJSON=function(){return this.properties},this.getDefaultProperties=function(){},this.isInstanceOf=function(t){return n.isInstanceOf(this.constructor,t)},this.getTypeNames=function(){for(var t=[],e=this.constructor["static"];e&&"node"!==e.name;)t.push(e.name),e=Object.getPrototypeOf(e);return t},this.getPropertyType=function(t){var e=this.constructor["static"].schema;return e[t]}},s.inherit(n,a),n["static"].name="node",n["static"].readOnlyProperties=["type","id"],n.isInstanceOf=function(t,e){for(var i=t["static"];i&&"node"!==i.name;){if(i&&i.name===e)return!0;i=Object.getPrototypeOf(i)}return!1},n["static"].isInstanceOf=n.isInstanceOf;var l=function(t,e,i){var n,s;n=function(){return this.properties[e]},s=i?function(){throw new Error("Property "+e+" is readonly!")}:function(t){return this.properties[e]=t,this};var r={get:n,set:s};Object.defineProperty(t,e,r)},u=function(t){var e=t.prototype;if(t["static"].schema)for(var i=Object.keys(t["static"].schema),n=0;n<i.length;n++){var s=i[n];if(!e.hasOwnProperty(s)){var r=t["static"].readOnlyProperties&&t["static"].readOnlyProperties.indexOf(s)>0;l(e,s,r)}}},c=function(t){var e=t["static"].schema,i=Object.getPrototypeOf(t["static"]),n=i.schema;n&&(t["static"].schema=r.extend(Object.create(n),e))},h=function(t,e){e?e.properties&&(t["static"].schema=e.properties):t.prototype.hasOwnProperty("properties")&&(t["static"].schema=t.prototype.properties),u(t),c(t),t.type=t["static"].name};n["static"].initNodeClass=h,s.makeExtensible(n,{name:!0,displayName:!0,properties:!0},h),h(n),e.exports=n},{"../../util/EventEmitter":310,"../../util/helpers":315,"../../util/oo":317,"../../util/uuid":318}],87:[function(t,e,i){"use strict";function n(){r.call(this)}var s=t("../../util/oo"),r=t("../../util/Factory"),o=t("./Node");n.Prototype=function(){this.register=function(t){var e=t["static"]&&t["static"].name;if("string"!=typeof e||""===e)throw new Error("Node names must be strings and must not be empty");if(!(t.prototype instanceof o))throw new Error("Nodes must be subclasses of Substance.Data.Node");if(this.contains(e))throw new Error("Node class is already registered: "+e);this.add(e,t)}},s.inherit(n,r),e.exports=n},{"../../util/Factory":311,"../../util/oo":317,"./Node":86}],88:[function(t,e,i){"use strict";var n=t("../../util/helpers"),s=t("../../util/oo"),r=t("../../util/PathAdapter"),o=function(){this.index=new r};o.Prototype=function(){this.reset=function(t){this.index.clear(),this._initialize(t)},this._initialize=function(t){n.each(t.getNodes(),function(t){this.select(t)&&this.create(t)},this)},this.property="id",this.select=function(t){return this.type?t.isInstanceOf(this.type):!0},this.get=function(t){return t?this.index.get(t)||{}:this.getAll()},this.getAll=function(){var t={};return n.each(this.index,function(e){n.extend(t,e)}),t},this.create=function(t){var e=t[this.property];n.isArray(e)||(e=[e]),n.each(e,function(e){this.index.set([e,t.id],t)},this)},this["delete"]=function(t){var e=t[this.property];n.isArray(e)||(e=[e]),n.each(e,function(e){this.index["delete"]([e,t.id])},this)},this.update=function(t,e,i,s){if(this.select(t)&&e[1]===this.property){var r=s;n.isArray(r)||(r=[r]),n.each(r,function(e){this.index["delete"]([e,t.id])},this),r=i,n.isArray(r)||(r=[r]),n.each(r,function(e){this.index.set([e,t.id],t)},this)}},this.clone=function(){var t=this.constructor,e=new t;return e}},s.initClass(o),o.create=function(t){var e=n.extend(new o,t);return e.clone=function(){return o.create(t)},e},e.exports=o},{"../../util/PathAdapter":313,"../../util/helpers":315,"../../util/oo":317}],89:[function(t,e,i){"use strict";var n=t("../../util/helpers"),s=t("../../util/oo"),r=t("../../util/PathAdapter"),o=t("./Operation"),a=t("./TextOperation"),l=t("./ArrayOperation"),u=t("./Conflict"),c="NOP",h="create",p="delete",d="update",f="set",m=function(t){if(o.call(this),!t)throw new Error("Data of ObjectOperation is missing.");if(!t.type)throw new Error("Invalid data: type is mandatory.");if(this.type=t.type,t.type!==c){if(this.path=t.path,!t.path)throw new Error("Invalid data: path is mandatory.");if(this.type===h||this.type===p){if(!t.val)throw new Error("Invalid data: value is missing.");this.val=t.val}else if(this.type===d){if(!t.diff)throw new Error("Invalid data: diff is mandatory for update operation.");if(this.diff=t.diff,t.diff instanceof a)this.propertyType="string";else{if(!(t.diff instanceof l))throw new Error("Invalid data: diff must be a TextOperation or an ArrayOperation.");this.propertyType="array"}}else{if(this.type!==f)throw new Error("Invalid type: "+t.type);this.val=t.val,this.original=t.original}}};m.fromJSON=function(t){if(t=n.deepclone(t),"update"===t.type)switch(t.propertyType){case"string":t.diff=a.fromJSON(t.diff);break;case"array":t.diff=l.fromJSON(t.diff);break;default:throw new Error("Unsupported update diff:"+JSON.stringify(t.diff))}var e=new m(t);return e},m.Prototype=function(){this.apply=function(t){if(this.type===c)return t;var e;if(e=t instanceof r?t:new r(t),this.type===h)return e.set(this.path,n.deepclone(this.val)),t;if(this.type===p)e["delete"](this.path,"strict");else if(this.type===d){var i,s=this.diff,o=e.get(this.path);i=s instanceof l?s.apply(o):s.apply(o),e.set(this.path,i)}else e.set(this.path,n.deepclone(this.val));return t},this.clone=function(){var t={type:this.type,path:this.path};return this.val&&(t.val=n.deepclone(this.val)),this.diff&&(t.diff=this.diff.clone()),new m(t)},this.isNOP=function(){return this.type===c?!0:this.type===d?this.diff.isNOP():void 0},this.isCreate=function(){return this.type===h},this.isDelete=function(){return this.type===p},this.isUpdate=function(){return this.type===d},this.isSet=function(){return this.type===f},this.invert=function(){if(this.type===c)return new m({type:c});var t=new m(this);if(this.type===h)t.type=p;else if(this.type===p)t.type=h;else if(this.type===d){var e;e=this.diff instanceof a?a.fromJSON(this.diff.toJSON()).invert():l.fromJSON(this.diff.toJSON()).invert(),t.diff=e}else t.val=this.original,t.original=this.val;return t},this.hasConflict=function(t){return m.hasConflict(this,t)},this.toJSON=function(){if(this.type===c)return{type:c};var t={type:this.type,path:this.path};return this.type===h||this.type===p?t.val=this.val:this.type===d?(this.diff instanceof l?t.propertyType="array":t.propertyType="string",t.diff=this.diff.toJSON()):(t.val=this.val,t.original=this.original),t},this.getType=function(){return this.type},this.getPath=function(){return this.path},this.getValue=function(){return this.val},this.toString=function(){switch(this.type){case h:return["(+,",JSON.stringify(this.path),JSON.stringify(this.val),")"].join("");case p:return["(-,",JSON.stringify(this.path),JSON.stringify(this.val),")"].join("");case d:return["(>>,",JSON.stringify(this.path),this.propertyType,this.diff.toString(),")"].join("");case f:return["(=,",JSON.stringify(this.path),this.val,this.original,")"].join("")}}},s.inherit(m,o);var g=function(t,e){return t.type===c||e.type===c?!1:n.isEqual(t.path,e.path)},b=function(t,e){t.type=c,e.type=c},y=function(){throw new Error("Can not transform two concurring creates of the same property")},v=function(){throw new Error("Illegal state: can not create and delete a value at the same time.")},_=function(t,e,i){if(t.type!==p)return _(e,t,!0);var n;n="string"===e.propertyType?a.fromJSON(e.diff):l.fromJSON(e.diff),i?(t.val=n.apply(t.val),e.type=c):(t.type=c,e.type=h,e.val=n.apply(t.val))},x=function(){throw new Error("Can not transform a concurring create and update of the same property")},C=function(t,e){var i,n,s;"string"===e.propertyType?(i=a.fromJSON(t.diff),n=a.fromJSON(e.diff),s=a.transform(i,n,{inplace:!0})):(i=l.fromJSON(t.diff),n=l.fromJSON(e.diff),s=l.transform(i,n,{inplace:!0})),t.diff=s[0],e.diff=s[1]},w=function(){throw new Error("Illegal state: can not create and set a value at the same time.")},S=function(t,e,i){return t.type!==p?S(e,t,!0):void(i?(t.val=e.val,e.type=c):(t.type=c,e.type=h,e.original=void 0))},T=function(){throw new Error("Unresolvable conflict: update + set.")},E=function(t,e){t.type=c,e.original=t.val},I=0,N=1,A=2,O=4,k=8,P={};P[c]=I,P[h]=N,P[p]=A,P[d]=O,P[f]=k;var D=[];D[A|A]=b,D[A|N]=v,D[A|O]=_,D[N|N]=y,D[N|O]=x,D[O|O]=C,D[N|k]=w,D[A|k]=S,D[O|k]=T,D[k|k]=E;var R=function(t,e,i){if(i=i||{},i["no-conflict"]&&g(t,e))throw new u(t,e);if(i.inplace||(t=t.clone(),e=e.clone()),t.isNOP()||e.isNOP())return[t,e];var s=n.isEqual(t.path,e.path);return s&&D[P[t.type]|P[e.type]](t,e),[t,e]};m.transform=R,m.hasConflict=g,m.Create=function(t,e){var i;return i=n.isString(t)?[t]:t,new m({type:h,path:i,val:e})},m.Delete=function(t,e){var i;return i=n.isString(t)?[t]:t,new m({type:p,path:i,val:e})},m.Update=function(t,e){var i;if(e instanceof a)i="string";else{if(!(e instanceof l))throw new Error("Unsupported type for operational changes");i="array"}return new m({type:d,path:t,diff:e})},m.Set=function(t,e,i){return new m({type:f,path:t,val:n.deepclone(i),original:n.deepclone(e)})},m.NOP=c,m.CREATE=h,m.DELETE=p,m.UPDATE=d,m.SET=f,e.exports=m},{"../../util/PathAdapter":313,"../../util/helpers":315,"../../util/oo":317,"./ArrayOperation":82,"./Conflict":83,"./Operation":90,"./TextOperation":92}],90:[function(t,e,i){"use strict";function n(){}var s=t("../../util/oo");n.Prototype=function(){this.isOperation=!0},s.initClass(n),e.exports=n},{"../../util/oo":317}],91:[function(t,e,i){"use strict";function n(t,e){this.name=t,this.version=e,this.nodeFactory=new a,this.tocTypes=[],this.addNodes(this.getBuiltIns())}var s=t("../../util/helpers"),r=t("../../util/oo"),o=t("./Node"),a=t("./NodeFactory");n.Prototype=function(){function t(t){var e={};return t["static"].hasOwnProperty("schema")&&(e.properties=s.clone(t["static"].schema)),e}this.addNodes=function(t){if(t)for(var e=0;e<t.length;e++){var i=t[e];this.nodeFactory.register(i),i["static"].tocType&&this.tocTypes.push(i["static"].name)}},this.getNodeClass=function(t){return this.nodeFactory.get(t)},this.getNodeFactory=function(){return this.nodeFactory},this.toJSON=function(){var e={id:this.name,version:this.version,types:{}};return this.nodeFactory.each(function(i,n){e.types[n]=t(i)}),e},this.createNode=function(t,e){var i=this.nodeFactory.create(t,e);return i},this.getBuiltIns=function(){return[o]},this.isInstanceOf=function(t,e){var i=this.getNodeClass(t);return i?o["static"].isInstanceOf(i,e):!1},this.each=function(){this.nodeFactory.each.apply(this.nodeFactory,arguments)},this.getTocTypes=function(){return this.tocTypes},this.getDefaultTextType=function(){throw new Error("Schmema.prototype.getDefaultTextType() must be overridden.")}},r.initClass(n),e.exports=n},{"../../util/helpers":315,"../../util/oo":317,"./Node":86,"./NodeFactory":87}],92:[function(t,e,i){"use strict";function n(t){if(c.call(this),
!t||void 0===t.type||void 0===t.pos||void 0===t.str)throw new Error("Illegal argument: insufficient data.");if(this.type=t.type,this.pos=t.pos,this.str=t.str,!this.isInsert()&&!this.isDelete())throw new Error("Illegal type.");if(!l.isString(this.str))throw new Error("Illegal argument: expecting string.");if(!l.isNumber(this.pos)||this.pos<0)throw new Error("Illegal argument: expecting positive number as pos.")}function s(t,e){t.pos===e.pos?e.pos+=t.str.length:t.pos<e.pos?e.pos+=t.str.length:t.pos+=e.str.length}function r(t,e,i){if(t.pos>e.pos)return r(e,t,!i);if(t.pos===e.pos&&t.str.length>e.str.length)return r(e,t,!i);if(e.pos<t.pos+t.str.length){var n=e.pos-t.pos,s=t.str.length-n,o=n+e.str.length;t.str=t.str.slice(0,n)+t.str.slice(o),e.str=e.str.slice(s),e.pos-=n}else e.pos-=t.str.length}function o(t,e){if(t.type===d)return o(e,t);if(t.pos<=e.pos)e.pos+=t.str.length;else if(t.pos>=e.pos+e.str.length)t.pos-=e.str.length;else{var i=t.pos-e.pos;e.str=e.str.slice(0,i)+t.str+e.str.slice(i),t.str=""}}var a,l=t("../../util/helpers"),u=t("../../util/oo"),c=t("./Operation"),h=t("./Conflict"),p="+",d="-";n.fromJSON=function(t){return new n(t)},n.Prototype=function(){this.apply=function(t){if(this.isEmpty())return t;if(this.type===p){if(t.length<this.pos)throw new Error("Provided string is too short.");return t.splice?t.splice(this.pos,0,this.str):t.slice(0,this.pos).concat(this.str).concat(t.slice(this.pos))}if(t.length<this.pos+this.str.length)throw new Error("Provided string is too short.");return t.splice?t.splice(this.pos,this.str.length):t.slice(0,this.pos).concat(t.slice(this.pos+this.str.length))},this.clone=function(){return new n(this)},this.isNOP=function(){return"NOP"===this.type||0===this.str.length},this.isInsert=function(){return this.type===p},this.isDelete=function(){return this.type===d},this.getLength=function(){return this.str.length},this.invert=function(){var t={type:this.isInsert()?"-":"+",pos:this.pos,str:this.str};return new n(t)},this.hasConflict=function(t){return a(this,t)},this.isEmpty=function(){return 0===this.str.length},this.toJSON=function(){return{type:this.type,pos:this.pos,str:this.str}},this.toString=function(){return["(",this.isInsert()?"+":"-",",",this.pos,",'",this.str,"')"].join("")}},u.inherit(n,c),a=function(t,e){if(t.type===p&&e.type===p)return t.pos===e.pos;if(t.type===d&&e.type===d)return!(t.pos>=e.pos+e.str.length||e.pos>=t.pos+t.str.length);var i,n;return t.type===d?(i=t,n=e):(i=e,n=t),n.pos>=i.pos&&n.pos<i.pos+i.str.length};var f=function(t,e,i){if(i=i||{},i["no-conflict"]&&a(t,e))throw new h(t,e);return i.inplace||(t=t.clone(),e=e.clone()),t.type===p&&e.type===p?s(t,e):t.type===d&&e.type===d?r(t,e,!0):o(t,e),[t,e]};n.transform=function(){return f.apply(null,arguments)},n.Insert=function(t,e){return new n({type:p,pos:t,str:e})},n.Delete=function(t,e){return new n({type:d,pos:t,str:e})},n.INSERT=p,n.DELETE=d,e.exports=n},{"../../util/helpers":315,"../../util/oo":317,"./Conflict":83,"./Operation":90}],93:[function(t,e,i){"use strict";var n=t("../util/helpers"),s=t("./AnnotationIndex"),r={};r.isContainerAnnotation=function(t,e){var i=t.getSchema();return i.isInstanceOf(e,"container-annotation")},r.getPropertyAnnotationsForSelection=function(t,e,i){i=i||{};var r,o,a,l;return e.isPropertySelection()?(o=e.getPath(),a=e.getStartOffset(),l=e.getEndOffset(),r=t.getIndex("annotations").get(o,a,l),i.type&&(r=n.filter(r,s.filterByType(i.type))),r):[]},r.getContainerAnnotationsForSelection=function(t,e,i,s){if(!i)return[];var r;return r=s.type?t.getIndex("type").get(s.type):t.getIndex("container-annotation-anchors").byId,r=n.filter(r,function(t){var i=t.getSelection();return e.overlaps(i)})},r.getAnnotationsForSelection=function(t,e,i,n){var s,o=r.isContainerAnnotation(t,i);if(o){var a=t.get(n);s=r.getContainerAnnotationsForSelection(t,e,a,{type:i})}else s=r.getPropertyAnnotationsForSelection(t,e,{type:i});return s},r.getTextForSelection=function(t,e){var i,n=[];if(!e||e.isNull())return"";if(e.isPropertySelection())i=t.get(e.start.path),n.push(i.substring(e.start.offset,e.end.offset));else if(e.isContainerSelection())for(var s=t.get(e.containerId),r=e.range,o=s.getPathRange(r.start.path,r.end.path),a=0;a<o.length;a++){var l=o[a];i=t.get(l),1===o.length?n.push(i.substring(e.start.offset,e.end.offset)):0===a?n.push(i.substring(e.start.offset)):a===o.length-1?n.push(i.substring(0,e.end.offset)):n.push(i)}return n.join("")},e.exports=r},{"../util/helpers":315,"./AnnotationIndex":57}],94:[function(t,e,i){"use strict";function n(t,e){if(!e.selection)throw new Error("Argument 'selection' is mandatory.");if(!e.containerId)throw new Error("Argument 'containerId' is mandatory.");e.selection.isCollapsed()||(e=o(t,e));var i=e.selection.getRange(),n=t.get(i.start.path[0]),r=e.editingBehavior;if(n.isInstanceOf("text"))return s(t,e);if(r&&r.canBreak(n.type)){var a=r.getBreaker(n.type);return a.call(a,t,e)}return console.info("Breaking is not supported for node type %s.",n.type),e}function s(t,e){var i=e.selection,n=e.containerId;if(!i.isPropertySelection())throw new Error("Expected property selection.");var s,o=i.getRange(),l=o.start.path,u=o.start.offset,c=t.get(l[0]),h=c.content,p=t.get(n),d=p.getChildIndex(c),f=r(c.type),m=[f,"content"];return 0===u?(s=t.create({id:f,type:c.type,content:""}),p.show(f,d),i=t.createSelection({type:"property",path:l,startOffset:0})):(s=t.create({id:f,type:t.getSchema().getDefaultTextType(),content:h.substring(u)}),u<h.length&&(a.transferAnnotations(t,l,u,[f,"content"],0),t.update(l,{"delete":{start:u,end:h.length}})),p.show(f,d+1),i=t.createSelection({type:"property",path:m,startOffset:0})),e.selection=i,e.node=s,e}var r=t("../../util/uuid"),o=t("./deleteSelection"),a=t("../annotationHelpers");e.exports=n},{"../../util/uuid":318,"../annotationHelpers":81,"./deleteSelection":100}],95:[function(t,e,i){"use strict";var n=t("../../util/helpers"),s=t("../annotationHelpers"),r=function(t,e){var i=e.selection;return i.isNull()?e.doc=null:i.isPropertySelection()||n.isEqual(i.start.path,i.end.path)?e.doc=o(t,i):i.isContainerSelection()?e.doc=a(t,i):(console.error("Copy is not yet supported for selection type."),e.doc=null),e},o=function(t,e){var i=t.newInstance();i._setForClipboard(!0);var s=e.start.path,o=e.start.offset,a=e.end.offset,l=t.get(s),u=i.get(r.CLIPBOARD_CONTAINER_ID);u||(u=i.create({type:"container",id:r.CLIPBOARD_CONTAINER_ID,nodes:[]})),i.create({type:t.schema.getDefaultTextType(),id:"text",content:l.substring(o,a)}),u.show("text");var c=t.getIndex("annotations").get(s,o,a);return n.each(c,function(t){var e=n.deepclone(t.toJSON());e.path=["text","content"],e.startOffset=Math.max(o,t.startOffset)-o,e.endOffset=Math.min(a,t.endOffset)-o,i.create(e)}),i},a=function(t,e){var i=t.newInstance();i._setForClipboard(!0);var o,a,l=t.getIndex("annotations"),u=t.get(e.containerId),c=i.create({type:"container",id:r.CLIPBOARD_CONTAINER_ID,nodes:[]}),h={},p=u.getAddress(e.start.path),d=u.getAddress(e.end.path);for(o=p[0];o<=d[0];o++){a=u.getChildAt(o);var f=a.id;h[f]||(h[f]=i.create(a.toJSON()),c.show(f)),a.hasChildren();for(var m=u.getPathsForNode(a),g=0;g<m.length;g++)for(var b=l.get(m[g]),y=0;y<b.length;y++)i.create(n.deepclone(b[y].toJSON()))}var v,_;a=u.getChildAt(p[0]);var x=u.getAddressesForNode(a);for(o=0;o<x.length;o++){if(!(x[o]<p)){e.start.offset>0&&(_=u.getPathForAddress(x[o]),v=t.get(_),i.update(_,{"delete":{start:0,end:e.start.offset}}),s.deletedText(i,_,0,e.start.offset));break}_=u.getPathForAddress(x[o]),i.set(_,"")}for(a=u.getChildAt(d[0]),x=u.getAddressesForNode(a),o=x.length-1;o>=0;o--){if(_=u.getPathForAddress(x[o]),!(x[o]>d)){v=t.get(_),e.end.offset<v.length&&(i.update(_,{"delete":{start:e.end.offset,end:v.length}}),s.deletedText(i,_,e.end.offset,v.length));break}i.set(_,"")}return i};r.CLIPBOARD_CONTAINER_ID="clipboard_content",e.exports=r},{"../../util/helpers":315,"../annotationHelpers":81}],96:[function(t,e,i){"use strict";function n(t,e){var i,n=e.selection,s=e.annotationType,o=e.annotationData;n.isPropertySelection()?i=[]:n.isContainerSelection()&&(i=n.splitIntoPropertySelections());for(var a=0;a<i.length;a++){var l={id:r.uuid(s),type:s};r.extend(l,o),l.path=i[a].getPath(),l.startOffset=i[a].getStartOffset(),l.endOffset=i[a].getEndOffset(),t.create(l)}}function s(t,e){var i=e.selection,s=e.annotationType,a=e.annotationData,l=e.containerId;if(!i)throw new Error("selection is required.");if(!s)throw new Error("annotationType is required");if(i.isContainerSelection()&&!l)throw new Error("containerId must be provided for container selections");if(e.splitContainerSelections&&i.isContainerSelection())return n(t,e);var u={id:r.uuid(s),type:s};if(r.extend(u,a),o.isContainerAnnotation(t,s))u.startPath=i.start.path,u.endPath=i.end.path,u.container=l;else{if(!i.isPropertySelection())throw new Error("Illegal state: can not apply ContainerSelection");u.path=i.getPath()}return u.startOffset=i.getStartOffset(),u.endOffset=i.getEndOffset(),e.result=t.create(u),e}var r=t("../../util/helpers"),o=t("../documentHelpers");e.exports=s},{"../../util/helpers":315,"../documentHelpers":93}],97:[function(t,e,i){"use strict";function n(t,e){var i=e.selection;if(!i)throw new Error("selection is required.");if(i.isContainerSelection()&&!e.containerId)throw new Error("containerId must be provided for container selections");var n=s.getAnnotationsForSelection(t,i,e.annotationType,e.containerId),r=n[0].id;return t["delete"](r),e.result=r,e}var s=t("../documentHelpers");e.exports=n},{"../documentHelpers":93}],98:[function(t,e,i){"use strict";var n=t("../../util/helpers"),s=t("./merge"),r=t("./updateAnnotations"),o=function(t,e){var i,o,a=e.selection,l=e.direction,u=a.getRange();if(!a.isCollapsed())throw new Error('Selection must be collapsed for transformation "deleteCharacter"');var c=t.get(u.start.path);if(0===u.start.offset&&"left"===l||u.start.offset===c.length&&"right"===l){var h=s(t,n.extend({},e,{selection:a,containerId:e.containerId,path:u.start.path,direction:l}));a=h.selection}else{i="left"===l?u.start.offset-1:u.start.offset,o=i+1;var p=t.update(u.start.path,{"delete":{start:i,end:o}});r(t,{op:p}),a=t.createSelection({type:"property",path:u.start.path,startOffset:i})}return e.selection=a,e};e.exports=o},{"../../util/helpers":315,"./merge":105,"./updateAnnotations":110}],99:[function(t,e,i){"use strict";function n(t,e){if(!e.nodeId)throw new Error("Parameter `nodeId` is mandatory.");var i,n=e.nodeId,r=t.getIndex("annotations").get(n);for(i=0;i<r.length;i++)t["delete"](r[i].id);var o=t.getIndex("container-annotation-anchors").get(n);for(i=0;i<o.length;i++){var a=o[i],l=t.get(a.container);if(t.get(a.id)){var u=l.getAddress(a.path),c=u[0];if(a.isStart)if(c<l.length-1){var h=l.getChildAt(c+1),p=l.getFirstAddress(h);t.set([a.id,"startPath"],l.getPath(p)),t.set([a.id,"startOffset"],0)}else t["delete"](a.id);else if(c>0){var d=l.getChildAt(c-1),f=l.getLastAddress(d),m=l.getPath(f),g=t.get(m).length;t.set([a.id,"endPath"],m),t.set([a.id,"endOffset"],g)}else t["delete"](a.id)}}return s.each(t.getIndex("type").get("container"),function(t){t.hide(n)}),t["delete"](n),e}var s=t("../../util/helpers");e.exports=n},{"../../util/helpers":315}],100:[function(t,e,i){"use strict";function n(t,e){var i=e.selection;return e=i.isCollapsed()?u(t,e):i.isPropertySelection()?s(t,e):r(t,e)}function s(t,e){var i=e.selection.getRange(),n=i.start.path,s=i.start.offset,r=i.end.offset,o=t.update(n,{"delete":{start:s,end:r}});return p(t,{op:o}),e.selection=t.createSelection({type:"property",path:n,startOffset:s}),e}function r(t,e){var i,n,s,r=e.selection,u=r.containerId,p=r.getRange(),d=a(t,r);e.selection=null;for(var f=t.get(u),m=f.getPosition(d[0].node.id),g=d.length-1;g>=0;g--)i=d[g],n=i.node,i.isFully?c(t,l.extend({},e,{nodeId:n.id})):o(t,l.extend({},e,{nodeSel:i}));if(d[0].isFully){e.selection=null;for(var b=1;b<d.length;b++)if(i=d[b],!i.isFully){e.selection=t.createSelection({type:"property",path:i.paths[0],startOffset:0});break}null===e.selection&&(s=t.getSchema().getDefaultTextType(),n={type:s,id:l.uuid(s),content:""},t.create(n),f.show(n.id,m),e.selection=t.createSelection({type:"property",path:[n.id,"content"],startOffset:0}))}else e.selection=t.createSelection({type:"property",path:p.start.path,startOffset:p.start.offset});if(d.length>1){var y=d[0],v=d[d.length-1];if(y.isFully||v.isFully);else{var _=l.last(v.paths),x=h(t,l.extend({},e,{selection:e.selection,containerId:u,path:_,direction:"left"}));e.selection=x.selection}}return f=t.get(u),0===f.nodes.length&&(s=t.getSchema().getDefaultTextType(),n={type:s,id:l.uuid(s),content:""},t.create(n),f.show(n.id,0),e.selection=t.createSelection({type:"property",path:[n.id,"content"],startOffset:0})),e}function o(t,e){for(var i=e.nodeSel,n=i.paths,r=n.length,o=0;r>o;o++){var a=n[o],u=0,c=t.get(a).length;0===o&&(u=i.startOffset),o===r-1&&(c=i.endOffset),s(t,l.extend({},e,{selection:t.createSelection({type:"property",path:a,startOffset:u,endOffset:c})}))}}function a(t,e){for(var i=[],n={},s=e.getRange(),r=t.get(e.containerId),o=r.getAddressRange(r.getAddress(s.start.path),r.getAddress(s.end.path)),a=0;a<o.length;a++){var l=o[a],u=r.getChildAt(l[0]);if(!u)throw new Error("Illegal state: expecting a component to have a proper root node id set.");var c,h=u.id;n[h]||(c={node:u,isFully:!0,addresses:[],paths:[]},n[h]=c,i.push(c)),c=n[h],c.addresses.push(l),c.paths.push(r.getPath(l))}var p=o[0],d=o[o.length-1],f=r.getPreviousAddress(p),m=r.getPreviousAddress(d),g=i[0],b=i[i.length-1],y=t.get(r.getPath(p)).length,v=t.get(r.getPath(d)).length;return(s.start.offset>0||f&&f[0]===p[0])&&(g.isFully=!1,g.startOffset=s.start.offset,1===i.length?g.endOffset=s.end.offset:g.endOffset=y),i.length>1&&(s.end.offset<v||m&&m[0]===d[0])&&(b.isFully=!1,b.startOffset=0,b.endOffset=s.end.offset),i}var l=t("../../util/helpers"),u=t("./deleteCharacter"),c=t("./deleteNode"),h=t("./merge"),p=t("./updateAnnotations");e.exports=n},{"../../util/helpers":315,"./deleteCharacter":98,"./deleteNode":99,"./merge":105,"./updateAnnotations":110}],101:[function(t,e,i){"use strict";function n(t,e){var i=e.selection;if(!i)throw new Error("selection is required.");if(!e.annotationType)throw new Error("annotationType is required");if(i.isContainerSelection()&&!e.containerId)throw new Error("containerId must be provided for container selections");var n=s.getAnnotationsForSelection(t,i,e.annotationType,e.containerId),r=n[0],o=r.getSelection(),a=o.expand(i);return r.updateRange(t,a),e.result=r,e}var s=t("../documentHelpers");e.exports=n},{"../documentHelpers":93}],102:[function(t,e,i){"use strict";function n(t,e){var i=e.selection;if(!i)throw new Error("selection is required.");if(!e.annotationType)throw new Error("annotationType is required");if(i.isContainerSelection()&&!e.containerId)throw new Error("containerId must be provided for container selections");var n=r.getAnnotationsForSelection(t,i,e.annotationType,e.containerId);return s.each(n,function(t){i=i.expand(t.getSelection())}),s.each(n,function(e){t["delete"](e.id)}),e.selection=i,o(t,e)}var s=t("../../util/helpers"),r=t("../documentHelpers"),o=t("./createAnnotation");e.exports=n},{"../../util/helpers":315,"../documentHelpers":93,"./createAnnotation":96}],103:[function(t,e,i){"use strict";function n(t,e){var i=e.selection,n=e.node;if(!e.containerId)throw new Error("containerId is mandatory");if(!e.selection)throw new Error("selection is mandatory");if(!e.node)throw new Error("node is mandatory");var o,a=e.containerId,l=t.get(a);i.isCollapsed()||(o=s(t,e),i=o.selection),o=r(t,e),i=o.selection,t.get(n.id)||(n=t.create(n)),n=t.get(n.id);var u=l.getAddress(i.start.path),c=u[0];l.show(n.id,c);var h=l.getFirstPath(n);return h&&(e.selection=t.createSelection({type:"property",path:h,startOffset:0})),e}var s=t("./deleteSelection"),r=t("./breakNode");e.exports=n},{"./breakNode":94,"./deleteSelection":100}],104:[function(t,e,i){"use strict";var n=t("./replaceText"),s=t("./updateAnnotations"),r=function(t,e){var i=e.selection,r=e.text;if(!i)throw new Error("Argument `selection` is mandatory for transformation `insertText`.");if(!r)throw new Error("Argument `text` is mandatory for transformation `insertText`.");if(!i.isPropertySelection()&&!i.isContainerSelection())throw new Error("Selection must be property or container selection.");if(!i.isCollapsed())return n(t,e);var o=i.getRange();void 0===t.get(o.start.path)&&t.set(o.start.path,"");var a=t.update(o.start.path,{insert:{offset:o.start.offset,value:r}});return s(t,{op:a}),e.selection=t.createSelection({type:"property",path:o.start.path,startOffset:o.start.offset+r.length}),e};e.exports=r},{"./replaceText":107,"./updateAnnotations":110}],105:[function(t,e,i){"use strict";function n(t,e,i){if(t){if(t.canMerge(e.type,i.type))return t.getMerger(e.type,i.type);if(e.isInstanceOf("text")&&t.canMerge("textish",i.type))return t.getMerger("textish",i.type);if(i.isInstanceOf("text")&&t.canMerge(e.type,"textish"))return t.getMerger(e.type,"textish")}return e.isInstanceOf("text")&&i.isInstanceOf("text")?l:(console.info("No merge behavior defined for %s <- %s",e.type,i.type),null)}var s=t("../../util/helpers"),r=t("../annotationHelpers"),o=function(t,e){var i=e.containerId,n=e.path,r=e.direction;if(!i||!n||!r)throw new Error("Insufficient arguments! mandatory fields: `containerId`, `path`, `direction`");var o,l=t.get(i),u=l.getAddress(n);if("right"===r){var c=l.getNextAddress(u);c&&(o=a(t,s.extend({},e,{containerId:i,firstAddress:u,secondAddress:c})),e.selection=o.selection)}else if("left"===r){var h=l.getPreviousAddress(u);h&&(o=a(t,s.extend({},e,{containerId:i,firstAddress:h,secondAddress:u})),e.selection=o.selection)}return e},a=function(t,e){var i,r=t.get(e.containerId),o=e.firstAddress,a=e.secondAddress,l=r.getChildAt(o[0]),u=r.getChildAt(a[0]),c=e.editingBehavior;if(l===u){if(c&&c.canMergeComponents(l.type))return i=c.getComponentMerger(l.type),i.call(this,t,s.extend({},e,{node:l,firstAddress:o,secondAddress:a}))}else if(i=n(e.editingBehavior,l,u))return i.call(this,t,s.extend({},e,{containerId:e.containerId,first:l,second:u}));return e},l=function(t,e){var i,n=e.containerId,s=e.first,o=e.second,a=t.get(n),l=s.getTextPath(),u=s.getText(),c=u.length,h=o.getTextPath(),p=o.getText();return 0===c?(a.hide(l[0]),t["delete"](l[0]),i=t.createSelection({type:"property",path:h,startOffset:0})):(t.update(l,{insert:{offset:c,value:p}}),r.transferAnnotations(t,h,0,l,c),a.hide(h[0]),t["delete"](h[0]),i=t.createSelection({type:"property",path:l,startOffset:c})),e.selection=i,e};e.exports=o},{"../../util/helpers":315,"../annotationHelpers":81}],106:[function(t,e,i){"use strict";var n=t("../../util/helpers"),s=t("../../util/uuid"),r=t("../annotationHelpers"),o=t("./deleteSelection"),a=t("./insertText"),l=t("./breakNode"),u=t("./copySelection").CLIPBOARD_CONTAINER_ID,c=function(t,e){if(e.selection.isNull())return console.error("Can not paste, without selection."),e;if(e.text&&!e.doc)return a(t,e);var i=e.doc;if(!e.selection.isCollapsed()){var n=o(t,e);e.selection=n.selection}var s=i.get(u).nodes;if(s.length>0){var r=i.get(s[0]);return 1===s.length&&r.isInstanceOf("text")?h(t,e):p(t,e)}return e},h=function(t,e){var i=e.doc,o=e.selection,a=i.get(u).nodes,l=[a[0],"content"],c=i.get(l),h=i.getIndex("annotations").get(l),p=o.start.path,d=o.start.offset;return t.update(p,{insert:{offset:d,value:c}}),r.insertedText(t,o.start,c.length),o=t.createSelection({type:"property",path:o.start.path,startOffset:o.start.offset+c.length}),n.each(h,function(e){var i=e.toJSON();i.path=p.slice(0),i.startOffset+=d,i.endOffset+=d,t.get(i.id)&&(i.id=s(i.type)),t.create(i)}),e.selection=o,e},p=function(t,e){var i,r=e.doc,o=e.containerId,a=e.selection,c=t.get(o),h=a.start.path,p=c.getAddress(h),d=c.getNextAddress(p);if(d&&d[0]===p[0]||t.get(h).length!==a.start.offset){var f=l(t,e);a=f.selection,i=p[0]}else i=p[0]+1;0>i&&console.error("Could not find insertion position in ContainerNode.");for(var m=r.get(u).nodes,g=r.getIndex("annotations"),b=[],y=0;y<m.length;y++){var v=m[y],_=r.get(v).toJSON();t.get(v)&&(_.id=s(_.type)),t.create(_),c.show(_.id,i++),b.push(_);for(var x=g.get(v),C=0;C<x.length;C++){var w=x[C].toJSON();_.id!==v&&(w.path[0]=_.id),t.get(w.id)&&(w.id=s(w.type)),t.create(w)}}if(0===b.length)return e;var S=c.getLastPath(n.last(b)),T=t.get(S).length;return a=t.createSelection({type:"property",path:S,startOffset:T}),e.selection=a,e};e.exports=c},{"../../util/helpers":315,"../../util/uuid":318,"../annotationHelpers":81,"./breakNode":94,"./copySelection":95,"./deleteSelection":100,"./insertText":104}],107:[function(t,e,i){"use strict";function n(t,e){var i=e.selection;return i.isPropertySelection()?r(t,e):s(t,e)}function s(t,e){var i=a(t,o.extend({},e,{direction:"right"})),n=i.selection,s=n.getRange(),r=e.text,u=t.update(s.start.path,{insert:{offset:s.start.offset,value:r}});return l(t,{op:u}),e.selection=t.createSelection({type:"property",path:s.start.path,startOffset:s.start.offset+r.length}),e}function r(t,e){var i=e.text,n=e.selection.getRange(),s=n.start.path,r=n.start.offset,a=n.end.offset,u=r+i.length,c=t.update(s,{"delete":{start:r,end:a}}),h=l(t,{op:c,replaceTextSupport:!0}),p=h.ignoredAnnotations;return c=t.update(n.start.path,{insert:{offset:n.start.offset,value:i}}),l(t,{op:c,ignoredAnnotations:p}),o.each(p,function(e){t.set([e.id,"endOffset"],u)}),e.selection=t.createSelection({type:"property",path:s,startOffset:u}),e}var o=t("../../util/helpers"),a=t("./deleteSelection"),l=t("./updateAnnotations");e.exports=n},{"../../util/helpers":315,"./deleteSelection":100,"./updateAnnotations":110}],108:[function(t,e,i){"use strict";function n(t,e){var i=e.selection;if(!i.isPropertySelection())return console.error("Selection must be a PropertySelection."),e;var n=i.getPath()[0],a=e.data,l=t.get(n),u=i.path;if(!l.isInstanceOf("text"))return console.warn("Trying to use switchTextType on a non text node. Skipping."),e;var c=s.extend({id:s.uuid(a.type),type:a.type,content:l.content},a),h=[c.id,"content"];t.create(c),r.transferAnnotations(t,u,0,h,0);var p=t.get(e.containerId),d=p.getPosition(n);return d>=0&&(p.hide(n),p.show(c.id,d)),o(t,{nodeId:l.id}),e.selection=t.createSelection({type:"property",path:h,startOffset:i.startOffset,endOffset:i.endOffset}),e}var s=t("../../util/helpers"),r=t("../annotationHelpers"),o=t("./deleteNode");e.exports=n},{"../../util/helpers":315,"../annotationHelpers":81,"./deleteNode":99}],109:[function(t,e,i){"use strict";function n(t,e){var i=e.selection;if(!i)throw new Error("selection is required.");if(!e.annotationType)throw new Error("annotationType is required");if(i.isContainerSelection()&&!e.containerId)throw new Error("containerId must be provided for container selections");var n=s.getAnnotationsForSelection(t,i,e.annotationType,e.containerId),r=n[0],o=r.getSelection(),a=o.truncate(i);return r.updateRange(t,a),e.result=r,e}var s=t("../documentHelpers");e.exports=n},{"../documentHelpers":93}],110:[function(t,e,i){"use strict";function n(t,e){var i=e.op;if(!i.isUpdate())throw new Error("Only text updates are supported.");var n=i.diff;return n.isInsert()?s(t,e):n.isDelete()?r(t,e):e}function s(t,e){var i=e.op,n=i.diff;return o.insertedText(t,new a(i.getPath(),n.pos),n.getLength(),e.ignoredAnnotations),e}function r(t,e){var i=e.op,n=i.diff,s=o.deletedText(t,i.getPath(),n.pos,n.pos+n.getLength(),e.replaceTextSupport);return e.replaceTextSupport&&(e.ignoredAnnotations=s),e}var o=t("../annotationHelpers"),a=t("../Coordinate");e.exports=n},{"../Coordinate":64,"../annotationHelpers":81}],111:[function(t,e,i){!function(t,i){"object"==typeof e&&"object"==typeof e.exports?e.exports=t.document?i(t,!0):function(t){if(!t.document)throw new Error("jQuery requires a window with a document");return i(t)}:i(t)}("undefined"!=typeof window?window:this,function(t,e){function i(t){var e="length"in t&&t.length,i=Z.type(t);return"function"===i||Z.isWindow(t)?!1:1===t.nodeType&&e?!0:"array"===i||0===e||"number"==typeof e&&e>0&&e-1 in t}function n(t,e,i){if(Z.isFunction(e))return Z.grep(t,function(t,n){return!!e.call(t,n,t)!==i});if(e.nodeType)return Z.grep(t,function(t){return t===e!==i});if("string"==typeof e){if(at.test(e))return Z.filter(e,t,i);e=Z.filter(e,t)}return Z.grep(t,function(t){return G.call(e,t)>=0!==i})}function s(t,e){for(;(t=t[e])&&1!==t.nodeType;);return t}function r(t){var e=ft[t]={};return Z.each(t.match(dt)||[],function(t,i){e[i]=!0}),e}function o(){Q.removeEventListener("DOMContentLoaded",o,!1),t.removeEventListener("load",o,!1),Z.ready()}function a(){Object.defineProperty(this.cache={},0,{get:function(){return{}}}),this.expando=Z.expando+a.uid++}function l(t,e,i){var n;if(void 0===i&&1===t.nodeType)if(n="data-"+e.replace(_t,"-$1").toLowerCase(),i=t.getAttribute(n),"string"==typeof i){try{i="true"===i?!0:"false"===i?!1:"null"===i?null:+i+""===i?+i:vt.test(i)?Z.parseJSON(i):i}catch(s){}yt.set(t,e,i)}else i=void 0;return i}function u(){return!0}function c(){return!1}function h(){try{return Q.activeElement}catch(t){}}function p(t,e){return Z.nodeName(t,"table")&&Z.nodeName(11!==e.nodeType?e:e.firstChild,"tr")?t.getElementsByTagName("tbody")[0]||t.appendChild(t.ownerDocument.createElement("tbody")):t}function d(t){return t.type=(null!==t.getAttribute("type"))+"/"+t.type,t}function f(t){var e=Lt.exec(t.type);return e?t.type=e[1]:t.removeAttribute("type"),t}function m(t,e){for(var i=0,n=t.length;n>i;i++)bt.set(t[i],"globalEval",!e||bt.get(e[i],"globalEval"))}function g(t,e){var i,n,s,r,o,a,l,u;if(1===e.nodeType){if(bt.hasData(t)&&(r=bt.access(t),o=bt.set(e,r),u=r.events)){delete o.handle,o.events={};for(s in u)for(i=0,n=u[s].length;n>i;i++)Z.event.add(e,s,u[s][i])}yt.hasData(t)&&(a=yt.access(t),l=Z.extend({},a),yt.set(e,l))}}function b(t,e){var i=t.getElementsByTagName?t.getElementsByTagName(e||"*"):t.querySelectorAll?t.querySelectorAll(e||"*"):[];return void 0===e||e&&Z.nodeName(t,e)?Z.merge([t],i):i}function y(t,e){var i=e.nodeName.toLowerCase();"input"===i&&St.test(t.type)?e.checked=t.checked:("input"===i||"textarea"===i)&&(e.defaultValue=t.defaultValue)}function v(e,i){var n,s=Z(i.createElement(e)).appendTo(i.body),r=t.getDefaultComputedStyle&&(n=t.getDefaultComputedStyle(s[0]))?n.display:Z.css(s[0],"display");return s.detach(),r}function _(t){var e=Q,i=Bt[t];return i||(i=v(t,e),"none"!==i&&i||(qt=(qt||Z("<iframe frameborder='0' width='0' height='0'/>")).appendTo(e.documentElement),e=qt[0].contentDocument,e.write(),e.close(),i=v(t,e),qt.detach()),Bt[t]=i),i}function x(t,e,i){var n,s,r,o,a=t.style;return i=i||Ht(t),i&&(o=i.getPropertyValue(e)||i[e]),i&&(""!==o||Z.contains(t.ownerDocument,t)||(o=Z.style(t,e)),$t.test(o)&&Ut.test(e)&&(n=a.width,s=a.minWidth,r=a.maxWidth,a.minWidth=a.maxWidth=a.width=o,o=i.width,a.width=n,a.minWidth=s,a.maxWidth=r)),void 0!==o?o+"":o}function C(t,e){return{get:function(){return t()?void delete this.get:(this.get=e).apply(this,arguments)}}}function w(t,e){if(e in t)return e;for(var i=e[0].toUpperCase()+e.slice(1),n=e,s=Kt.length;s--;)if(e=Kt[s]+i,e in t)return e;return n}function S(t,e,i){var n=Vt.exec(e);return n?Math.max(0,n[1]-(i||0))+(n[2]||"px"):e}function T(t,e,i,n,s){for(var r=i===(n?"border":"content")?4:"width"===e?1:0,o=0;4>r;r+=2)"margin"===i&&(o+=Z.css(t,i+Ct[r],!0,s)),n?("content"===i&&(o-=Z.css(t,"padding"+Ct[r],!0,s)),"margin"!==i&&(o-=Z.css(t,"border"+Ct[r]+"Width",!0,s))):(o+=Z.css(t,"padding"+Ct[r],!0,s),"padding"!==i&&(o+=Z.css(t,"border"+Ct[r]+"Width",!0,s)));return o}function E(t,e,i){var n=!0,s="width"===e?t.offsetWidth:t.offsetHeight,r=Ht(t),o="border-box"===Z.css(t,"boxSizing",!1,r);if(0>=s||null==s){if(s=x(t,e,r),(0>s||null==s)&&(s=t.style[e]),$t.test(s))return s;n=o&&(J.boxSizingReliable()||s===t.style[e]),s=parseFloat(s)||0}return s+T(t,e,i||(o?"border":"content"),n,r)+"px"}function I(t,e){for(var i,n,s,r=[],o=0,a=t.length;a>o;o++)n=t[o],n.style&&(r[o]=bt.get(n,"olddisplay"),i=n.style.display,e?(r[o]||"none"!==i||(n.style.display=""),""===n.style.display&&wt(n)&&(r[o]=bt.access(n,"olddisplay",_(n.nodeName)))):(s=wt(n),"none"===i&&s||bt.set(n,"olddisplay",s?i:Z.css(n,"display"))));for(o=0;a>o;o++)n=t[o],n.style&&(e&&"none"!==n.style.display&&""!==n.style.display||(n.style.display=e?r[o]||"":"none"));return t}function N(t,e,i,n,s){return new N.prototype.init(t,e,i,n,s)}function A(){return setTimeout(function(){Jt=void 0}),Jt=Z.now()}function O(t,e){var i,n=0,s={height:t};for(e=e?1:0;4>n;n+=2-e)i=Ct[n],s["margin"+i]=s["padding"+i]=t;return e&&(s.opacity=s.width=t),s}function k(t,e,i){for(var n,s=(ie[e]||[]).concat(ie["*"]),r=0,o=s.length;o>r;r++)if(n=s[r].call(i,e,t))return n}function P(t,e,i){var n,s,r,o,a,l,u,c,h=this,p={},d=t.style,f=t.nodeType&&wt(t),m=bt.get(t,"fxshow");i.queue||(a=Z._queueHooks(t,"fx"),null==a.unqueued&&(a.unqueued=0,l=a.empty.fire,a.empty.fire=function(){a.unqueued||l()}),a.unqueued++,h.always(function(){h.always(function(){a.unqueued--,Z.queue(t,"fx").length||a.empty.fire()})})),1===t.nodeType&&("height"in e||"width"in e)&&(i.overflow=[d.overflow,d.overflowX,d.overflowY],u=Z.css(t,"display"),c="none"===u?bt.get(t,"olddisplay")||_(t.nodeName):u,"inline"===c&&"none"===Z.css(t,"float")&&(d.display="inline-block")),i.overflow&&(d.overflow="hidden",h.always(function(){d.overflow=i.overflow[0],d.overflowX=i.overflow[1],d.overflowY=i.overflow[2]}));for(n in e)if(s=e[n],Yt.exec(s)){if(delete e[n],r=r||"toggle"===s,s===(f?"hide":"show")){if("show"!==s||!m||void 0===m[n])continue;f=!0}p[n]=m&&m[n]||Z.style(t,n)}else u=void 0;if(Z.isEmptyObject(p))"inline"===("none"===u?_(t.nodeName):u)&&(d.display=u);else{m?"hidden"in m&&(f=m.hidden):m=bt.access(t,"fxshow",{}),r&&(m.hidden=!f),f?Z(t).show():h.done(function(){Z(t).hide()}),h.done(function(){var e;bt.remove(t,"fxshow");for(e in p)Z.style(t,e,p[e])});for(n in p)o=k(f?m[n]:0,n,h),n in m||(m[n]=o.start,f&&(o.end=o.start,o.start="width"===n||"height"===n?1:0))}}function D(t,e){var i,n,s,r,o;for(i in t)if(n=Z.camelCase(i),s=e[n],r=t[i],Z.isArray(r)&&(s=r[1],r=t[i]=r[0]),i!==n&&(t[n]=r,delete t[i]),o=Z.cssHooks[n],o&&"expand"in o){r=o.expand(r),delete t[n];for(i in r)i in t||(t[i]=r[i],e[i]=s)}else e[n]=s}function R(t,e,i){var n,s,r=0,o=ee.length,a=Z.Deferred().always(function(){delete l.elem}),l=function(){if(s)return!1;for(var e=Jt||A(),i=Math.max(0,u.startTime+u.duration-e),n=i/u.duration||0,r=1-n,o=0,l=u.tweens.length;l>o;o++)u.tweens[o].run(r);return a.notifyWith(t,[u,r,i]),1>r&&l?i:(a.resolveWith(t,[u]),!1)},u=a.promise({elem:t,props:Z.extend({},e),opts:Z.extend(!0,{specialEasing:{}},i),originalProperties:e,originalOptions:i,startTime:Jt||A(),duration:i.duration,tweens:[],createTween:function(e,i){var n=Z.Tween(t,u.opts,e,i,u.opts.specialEasing[e]||u.opts.easing);return u.tweens.push(n),n},stop:function(e){var i=0,n=e?u.tweens.length:0;if(s)return this;for(s=!0;n>i;i++)u.tweens[i].run(1);return e?a.resolveWith(t,[u,e]):a.rejectWith(t,[u,e]),this}}),c=u.props;for(D(c,u.opts.specialEasing);o>r;r++)if(n=ee[r].call(u,t,c,u.opts))return n;return Z.map(c,k,u),Z.isFunction(u.opts.start)&&u.opts.start.call(t,u),Z.fx.timer(Z.extend(l,{elem:t,anim:u,queue:u.opts.queue})),u.progress(u.opts.progress).done(u.opts.done,u.opts.complete).fail(u.opts.fail).always(u.opts.always)}function j(t){return function(e,i){"string"!=typeof e&&(i=e,e="*");var n,s=0,r=e.toLowerCase().match(dt)||[];if(Z.isFunction(i))for(;n=r[s++];)"+"===n[0]?(n=n.slice(1)||"*",(t[n]=t[n]||[]).unshift(i)):(t[n]=t[n]||[]).push(i)}}function L(t,e,i,n){function s(a){var l;return r[a]=!0,Z.each(t[a]||[],function(t,a){var u=a(e,i,n);return"string"!=typeof u||o||r[u]?o?!(l=u):void 0:(e.dataTypes.unshift(u),s(u),!1)}),l}var r={},o=t===ve;return s(e.dataTypes[0])||!r["*"]&&s("*")}function F(t,e){var i,n,s=Z.ajaxSettings.flatOptions||{};for(i in e)void 0!==e[i]&&((s[i]?t:n||(n={}))[i]=e[i]);return n&&Z.extend(!0,t,n),t}function M(t,e,i){for(var n,s,r,o,a=t.contents,l=t.dataTypes;"*"===l[0];)l.shift(),void 0===n&&(n=t.mimeType||e.getResponseHeader("Content-Type"));if(n)for(s in a)if(a[s]&&a[s].test(n)){l.unshift(s);break}if(l[0]in i)r=l[0];else{
for(s in i){if(!l[0]||t.converters[s+" "+l[0]]){r=s;break}o||(o=s)}r=r||o}return r?(r!==l[0]&&l.unshift(r),i[r]):void 0}function q(t,e,i,n){var s,r,o,a,l,u={},c=t.dataTypes.slice();if(c[1])for(o in t.converters)u[o.toLowerCase()]=t.converters[o];for(r=c.shift();r;)if(t.responseFields[r]&&(i[t.responseFields[r]]=e),!l&&n&&t.dataFilter&&(e=t.dataFilter(e,t.dataType)),l=r,r=c.shift())if("*"===r)r=l;else if("*"!==l&&l!==r){if(o=u[l+" "+r]||u["* "+r],!o)for(s in u)if(a=s.split(" "),a[1]===r&&(o=u[l+" "+a[0]]||u["* "+a[0]])){o===!0?o=u[s]:u[s]!==!0&&(r=a[0],c.unshift(a[1]));break}if(o!==!0)if(o&&t["throws"])e=o(e);else try{e=o(e)}catch(h){return{state:"parsererror",error:o?h:"No conversion from "+l+" to "+r}}}return{state:"success",data:e}}function B(t,e,i,n){var s;if(Z.isArray(e))Z.each(e,function(e,s){i||Se.test(t)?n(t,s):B(t+"["+("object"==typeof s?e:"")+"]",s,i,n)});else if(i||"object"!==Z.type(e))n(t,e);else for(s in e)B(t+"["+s+"]",e[s],i,n)}function U(t){return Z.isWindow(t)?t:9===t.nodeType&&t.defaultView}var $=[],H=$.slice,z=$.concat,V=$.push,G=$.indexOf,W={},X=W.toString,K=W.hasOwnProperty,J={},Q=t.document,Y="2.1.4",Z=function(t,e){return new Z.fn.init(t,e)},tt=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,et=/^-ms-/,it=/-([\da-z])/gi,nt=function(t,e){return e.toUpperCase()};Z.fn=Z.prototype={jquery:Y,constructor:Z,selector:"",length:0,toArray:function(){return H.call(this)},get:function(t){return null!=t?0>t?this[t+this.length]:this[t]:H.call(this)},pushStack:function(t){var e=Z.merge(this.constructor(),t);return e.prevObject=this,e.context=this.context,e},each:function(t,e){return Z.each(this,t,e)},map:function(t){return this.pushStack(Z.map(this,function(e,i){return t.call(e,i,e)}))},slice:function(){return this.pushStack(H.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(t){var e=this.length,i=+t+(0>t?e:0);return this.pushStack(i>=0&&e>i?[this[i]]:[])},end:function(){return this.prevObject||this.constructor(null)},push:V,sort:$.sort,splice:$.splice},Z.extend=Z.fn.extend=function(){var t,e,i,n,s,r,o=arguments[0]||{},a=1,l=arguments.length,u=!1;for("boolean"==typeof o&&(u=o,o=arguments[a]||{},a++),"object"==typeof o||Z.isFunction(o)||(o={}),a===l&&(o=this,a--);l>a;a++)if(null!=(t=arguments[a]))for(e in t)i=o[e],n=t[e],o!==n&&(u&&n&&(Z.isPlainObject(n)||(s=Z.isArray(n)))?(s?(s=!1,r=i&&Z.isArray(i)?i:[]):r=i&&Z.isPlainObject(i)?i:{},o[e]=Z.extend(u,r,n)):void 0!==n&&(o[e]=n));return o},Z.extend({expando:"jQuery"+(Y+Math.random()).replace(/\D/g,""),isReady:!0,error:function(t){throw new Error(t)},noop:function(){},isFunction:function(t){return"function"===Z.type(t)},isArray:Array.isArray,isWindow:function(t){return null!=t&&t===t.window},isNumeric:function(t){return!Z.isArray(t)&&t-parseFloat(t)+1>=0},isPlainObject:function(t){return"object"!==Z.type(t)||t.nodeType||Z.isWindow(t)?!1:t.constructor&&!K.call(t.constructor.prototype,"isPrototypeOf")?!1:!0},isEmptyObject:function(t){var e;for(e in t)return!1;return!0},type:function(t){return null==t?t+"":"object"==typeof t||"function"==typeof t?W[X.call(t)]||"object":typeof t},globalEval:function(t){var e,i=eval;t=Z.trim(t),t&&(1===t.indexOf("use strict")?(e=Q.createElement("script"),e.text=t,Q.head.appendChild(e).parentNode.removeChild(e)):i(t))},camelCase:function(t){return t.replace(et,"ms-").replace(it,nt)},nodeName:function(t,e){return t.nodeName&&t.nodeName.toLowerCase()===e.toLowerCase()},each:function(t,e,n){var s,r=0,o=t.length,a=i(t);if(n){if(a)for(;o>r&&(s=e.apply(t[r],n),s!==!1);r++);else for(r in t)if(s=e.apply(t[r],n),s===!1)break}else if(a)for(;o>r&&(s=e.call(t[r],r,t[r]),s!==!1);r++);else for(r in t)if(s=e.call(t[r],r,t[r]),s===!1)break;return t},trim:function(t){return null==t?"":(t+"").replace(tt,"")},makeArray:function(t,e){var n=e||[];return null!=t&&(i(Object(t))?Z.merge(n,"string"==typeof t?[t]:t):V.call(n,t)),n},inArray:function(t,e,i){return null==e?-1:G.call(e,t,i)},merge:function(t,e){for(var i=+e.length,n=0,s=t.length;i>n;n++)t[s++]=e[n];return t.length=s,t},grep:function(t,e,i){for(var n,s=[],r=0,o=t.length,a=!i;o>r;r++)n=!e(t[r],r),n!==a&&s.push(t[r]);return s},map:function(t,e,n){var s,r=0,o=t.length,a=i(t),l=[];if(a)for(;o>r;r++)s=e(t[r],r,n),null!=s&&l.push(s);else for(r in t)s=e(t[r],r,n),null!=s&&l.push(s);return z.apply([],l)},guid:1,proxy:function(t,e){var i,n,s;return"string"==typeof e&&(i=t[e],e=t,t=i),Z.isFunction(t)?(n=H.call(arguments,2),s=function(){return t.apply(e||this,n.concat(H.call(arguments)))},s.guid=t.guid=t.guid||Z.guid++,s):void 0},now:Date.now,support:J}),Z.each("Boolean Number String Function Array Date RegExp Object Error".split(" "),function(t,e){W["[object "+e+"]"]=e.toLowerCase()});var st=function(t){function e(t,e,i,n){var s,r,o,a,l,u,h,d,f,m;if((e?e.ownerDocument||e:B)!==P&&k(e),e=e||P,i=i||[],a=e.nodeType,"string"!=typeof t||!t||1!==a&&9!==a&&11!==a)return i;if(!n&&R){if(11!==a&&(s=yt.exec(t)))if(o=s[1]){if(9===a){if(r=e.getElementById(o),!r||!r.parentNode)return i;if(r.id===o)return i.push(r),i}else if(e.ownerDocument&&(r=e.ownerDocument.getElementById(o))&&M(e,r)&&r.id===o)return i.push(r),i}else{if(s[2])return Y.apply(i,e.getElementsByTagName(t)),i;if((o=s[3])&&x.getElementsByClassName)return Y.apply(i,e.getElementsByClassName(o)),i}if(x.qsa&&(!j||!j.test(t))){if(d=h=q,f=e,m=1!==a&&t,1===a&&"object"!==e.nodeName.toLowerCase()){for(u=T(t),(h=e.getAttribute("id"))?d=h.replace(_t,"\\$&"):e.setAttribute("id",d),d="[id='"+d+"'] ",l=u.length;l--;)u[l]=d+p(u[l]);f=vt.test(t)&&c(e.parentNode)||e,m=u.join(",")}if(m)try{return Y.apply(i,f.querySelectorAll(m)),i}catch(g){}finally{h||e.removeAttribute("id")}}}return I(t.replace(lt,"$1"),e,i,n)}function i(){function t(i,n){return e.push(i+" ")>C.cacheLength&&delete t[e.shift()],t[i+" "]=n}var e=[];return t}function n(t){return t[q]=!0,t}function s(t){var e=P.createElement("div");try{return!!t(e)}catch(i){return!1}finally{e.parentNode&&e.parentNode.removeChild(e),e=null}}function r(t,e){for(var i=t.split("|"),n=t.length;n--;)C.attrHandle[i[n]]=e}function o(t,e){var i=e&&t,n=i&&1===t.nodeType&&1===e.nodeType&&(~e.sourceIndex||W)-(~t.sourceIndex||W);if(n)return n;if(i)for(;i=i.nextSibling;)if(i===e)return-1;return t?1:-1}function a(t){return function(e){var i=e.nodeName.toLowerCase();return"input"===i&&e.type===t}}function l(t){return function(e){var i=e.nodeName.toLowerCase();return("input"===i||"button"===i)&&e.type===t}}function u(t){return n(function(e){return e=+e,n(function(i,n){for(var s,r=t([],i.length,e),o=r.length;o--;)i[s=r[o]]&&(i[s]=!(n[s]=i[s]))})})}function c(t){return t&&"undefined"!=typeof t.getElementsByTagName&&t}function h(){}function p(t){for(var e=0,i=t.length,n="";i>e;e++)n+=t[e].value;return n}function d(t,e,i){var n=e.dir,s=i&&"parentNode"===n,r=$++;return e.first?function(e,i,r){for(;e=e[n];)if(1===e.nodeType||s)return t(e,i,r)}:function(e,i,o){var a,l,u=[U,r];if(o){for(;e=e[n];)if((1===e.nodeType||s)&&t(e,i,o))return!0}else for(;e=e[n];)if(1===e.nodeType||s){if(l=e[q]||(e[q]={}),(a=l[n])&&a[0]===U&&a[1]===r)return u[2]=a[2];if(l[n]=u,u[2]=t(e,i,o))return!0}}}function f(t){return t.length>1?function(e,i,n){for(var s=t.length;s--;)if(!t[s](e,i,n))return!1;return!0}:t[0]}function m(t,i,n){for(var s=0,r=i.length;r>s;s++)e(t,i[s],n);return n}function g(t,e,i,n,s){for(var r,o=[],a=0,l=t.length,u=null!=e;l>a;a++)(r=t[a])&&(!i||i(r,n,s))&&(o.push(r),u&&e.push(a));return o}function b(t,e,i,s,r,o){return s&&!s[q]&&(s=b(s)),r&&!r[q]&&(r=b(r,o)),n(function(n,o,a,l){var u,c,h,p=[],d=[],f=o.length,b=n||m(e||"*",a.nodeType?[a]:a,[]),y=!t||!n&&e?b:g(b,p,t,a,l),v=i?r||(n?t:f||s)?[]:o:y;if(i&&i(y,v,a,l),s)for(u=g(v,d),s(u,[],a,l),c=u.length;c--;)(h=u[c])&&(v[d[c]]=!(y[d[c]]=h));if(n){if(r||t){if(r){for(u=[],c=v.length;c--;)(h=v[c])&&u.push(y[c]=h);r(null,v=[],u,l)}for(c=v.length;c--;)(h=v[c])&&(u=r?tt(n,h):p[c])>-1&&(n[u]=!(o[u]=h))}}else v=g(v===o?v.splice(f,v.length):v),r?r(null,o,v,l):Y.apply(o,v)})}function y(t){for(var e,i,n,s=t.length,r=C.relative[t[0].type],o=r||C.relative[" "],a=r?1:0,l=d(function(t){return t===e},o,!0),u=d(function(t){return tt(e,t)>-1},o,!0),c=[function(t,i,n){var s=!r&&(n||i!==N)||((e=i).nodeType?l(t,i,n):u(t,i,n));return e=null,s}];s>a;a++)if(i=C.relative[t[a].type])c=[d(f(c),i)];else{if(i=C.filter[t[a].type].apply(null,t[a].matches),i[q]){for(n=++a;s>n&&!C.relative[t[n].type];n++);return b(a>1&&f(c),a>1&&p(t.slice(0,a-1).concat({value:" "===t[a-2].type?"*":""})).replace(lt,"$1"),i,n>a&&y(t.slice(a,n)),s>n&&y(t=t.slice(n)),s>n&&p(t))}c.push(i)}return f(c)}function v(t,i){var s=i.length>0,r=t.length>0,o=function(n,o,a,l,u){var c,h,p,d=0,f="0",m=n&&[],b=[],y=N,v=n||r&&C.find.TAG("*",u),_=U+=null==y?1:Math.random()||.1,x=v.length;for(u&&(N=o!==P&&o);f!==x&&null!=(c=v[f]);f++){if(r&&c){for(h=0;p=t[h++];)if(p(c,o,a)){l.push(c);break}u&&(U=_)}s&&((c=!p&&c)&&d--,n&&m.push(c))}if(d+=f,s&&f!==d){for(h=0;p=i[h++];)p(m,b,o,a);if(n){if(d>0)for(;f--;)m[f]||b[f]||(b[f]=J.call(l));b=g(b)}Y.apply(l,b),u&&!n&&b.length>0&&d+i.length>1&&e.uniqueSort(l)}return u&&(U=_,N=y),m};return s?n(o):o}var _,x,C,w,S,T,E,I,N,A,O,k,P,D,R,j,L,F,M,q="sizzle"+1*new Date,B=t.document,U=0,$=0,H=i(),z=i(),V=i(),G=function(t,e){return t===e&&(O=!0),0},W=1<<31,X={}.hasOwnProperty,K=[],J=K.pop,Q=K.push,Y=K.push,Z=K.slice,tt=function(t,e){for(var i=0,n=t.length;n>i;i++)if(t[i]===e)return i;return-1},et="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",it="[\\x20\\t\\r\\n\\f]",nt="(?:\\\\.|[\\w-]|[^\\x00-\\xa0])+",st=nt.replace("w","w#"),rt="\\["+it+"*("+nt+")(?:"+it+"*([*^$|!~]?=)"+it+"*(?:'((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\"|("+st+"))|)"+it+"*\\]",ot=":("+nt+")(?:\\((('((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\")|((?:\\\\.|[^\\\\()[\\]]|"+rt+")*)|.*)\\)|)",at=new RegExp(it+"+","g"),lt=new RegExp("^"+it+"+|((?:^|[^\\\\])(?:\\\\.)*)"+it+"+$","g"),ut=new RegExp("^"+it+"*,"+it+"*"),ct=new RegExp("^"+it+"*([>+~]|"+it+")"+it+"*"),ht=new RegExp("="+it+"*([^\\]'\"]*?)"+it+"*\\]","g"),pt=new RegExp(ot),dt=new RegExp("^"+st+"$"),ft={ID:new RegExp("^#("+nt+")"),CLASS:new RegExp("^\\.("+nt+")"),TAG:new RegExp("^("+nt.replace("w","w*")+")"),ATTR:new RegExp("^"+rt),PSEUDO:new RegExp("^"+ot),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+it+"*(even|odd|(([+-]|)(\\d*)n|)"+it+"*(?:([+-]|)"+it+"*(\\d+)|))"+it+"*\\)|)","i"),bool:new RegExp("^(?:"+et+")$","i"),needsContext:new RegExp("^"+it+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+it+"*((?:-\\d)?\\d*)"+it+"*\\)|)(?=[^-]|$)","i")},mt=/^(?:input|select|textarea|button)$/i,gt=/^h\d$/i,bt=/^[^{]+\{\s*\[native \w/,yt=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,vt=/[+~]/,_t=/'|\\/g,xt=new RegExp("\\\\([\\da-f]{1,6}"+it+"?|("+it+")|.)","ig"),Ct=function(t,e,i){var n="0x"+e-65536;return n!==n||i?e:0>n?String.fromCharCode(n+65536):String.fromCharCode(n>>10|55296,1023&n|56320)},wt=function(){k()};try{Y.apply(K=Z.call(B.childNodes),B.childNodes),K[B.childNodes.length].nodeType}catch(St){Y={apply:K.length?function(t,e){Q.apply(t,Z.call(e))}:function(t,e){for(var i=t.length,n=0;t[i++]=e[n++];);t.length=i-1}}}x=e.support={},S=e.isXML=function(t){var e=t&&(t.ownerDocument||t).documentElement;return e?"HTML"!==e.nodeName:!1},k=e.setDocument=function(t){var e,i,n=t?t.ownerDocument||t:B;return n!==P&&9===n.nodeType&&n.documentElement?(P=n,D=n.documentElement,i=n.defaultView,i&&i!==i.top&&(i.addEventListener?i.addEventListener("unload",wt,!1):i.attachEvent&&i.attachEvent("onunload",wt)),R=!S(n),x.attributes=s(function(t){return t.className="i",!t.getAttribute("className")}),x.getElementsByTagName=s(function(t){return t.appendChild(n.createComment("")),!t.getElementsByTagName("*").length}),x.getElementsByClassName=bt.test(n.getElementsByClassName),x.getById=s(function(t){return D.appendChild(t).id=q,!n.getElementsByName||!n.getElementsByName(q).length}),x.getById?(C.find.ID=function(t,e){if("undefined"!=typeof e.getElementById&&R){var i=e.getElementById(t);return i&&i.parentNode?[i]:[]}},C.filter.ID=function(t){var e=t.replace(xt,Ct);return function(t){return t.getAttribute("id")===e}}):(delete C.find.ID,C.filter.ID=function(t){var e=t.replace(xt,Ct);return function(t){var i="undefined"!=typeof t.getAttributeNode&&t.getAttributeNode("id");return i&&i.value===e}}),C.find.TAG=x.getElementsByTagName?function(t,e){return"undefined"!=typeof e.getElementsByTagName?e.getElementsByTagName(t):x.qsa?e.querySelectorAll(t):void 0}:function(t,e){var i,n=[],s=0,r=e.getElementsByTagName(t);if("*"===t){for(;i=r[s++];)1===i.nodeType&&n.push(i);return n}return r},C.find.CLASS=x.getElementsByClassName&&function(t,e){return R?e.getElementsByClassName(t):void 0},L=[],j=[],(x.qsa=bt.test(n.querySelectorAll))&&(s(function(t){D.appendChild(t).innerHTML="<a id='"+q+"'></a><select id='"+q+"-\f]' msallowcapture=''><option selected=''></option></select>",t.querySelectorAll("[msallowcapture^='']").length&&j.push("[*^$]="+it+"*(?:''|\"\")"),t.querySelectorAll("[selected]").length||j.push("\\["+it+"*(?:value|"+et+")"),t.querySelectorAll("[id~="+q+"-]").length||j.push("~="),t.querySelectorAll(":checked").length||j.push(":checked"),t.querySelectorAll("a#"+q+"+*").length||j.push(".#.+[+~]")}),s(function(t){var e=n.createElement("input");e.setAttribute("type","hidden"),t.appendChild(e).setAttribute("name","D"),t.querySelectorAll("[name=d]").length&&j.push("name"+it+"*[*^$|!~]?="),t.querySelectorAll(":enabled").length||j.push(":enabled",":disabled"),t.querySelectorAll("*,:x"),j.push(",.*:")})),(x.matchesSelector=bt.test(F=D.matches||D.webkitMatchesSelector||D.mozMatchesSelector||D.oMatchesSelector||D.msMatchesSelector))&&s(function(t){x.disconnectedMatch=F.call(t,"div"),F.call(t,"[s!='']:x"),L.push("!=",ot)}),j=j.length&&new RegExp(j.join("|")),L=L.length&&new RegExp(L.join("|")),e=bt.test(D.compareDocumentPosition),M=e||bt.test(D.contains)?function(t,e){var i=9===t.nodeType?t.documentElement:t,n=e&&e.parentNode;return t===n||!(!n||1!==n.nodeType||!(i.contains?i.contains(n):t.compareDocumentPosition&&16&t.compareDocumentPosition(n)))}:function(t,e){if(e)for(;e=e.parentNode;)if(e===t)return!0;return!1},G=e?function(t,e){if(t===e)return O=!0,0;var i=!t.compareDocumentPosition-!e.compareDocumentPosition;return i?i:(i=(t.ownerDocument||t)===(e.ownerDocument||e)?t.compareDocumentPosition(e):1,1&i||!x.sortDetached&&e.compareDocumentPosition(t)===i?t===n||t.ownerDocument===B&&M(B,t)?-1:e===n||e.ownerDocument===B&&M(B,e)?1:A?tt(A,t)-tt(A,e):0:4&i?-1:1)}:function(t,e){if(t===e)return O=!0,0;var i,s=0,r=t.parentNode,a=e.parentNode,l=[t],u=[e];if(!r||!a)return t===n?-1:e===n?1:r?-1:a?1:A?tt(A,t)-tt(A,e):0;if(r===a)return o(t,e);for(i=t;i=i.parentNode;)l.unshift(i);for(i=e;i=i.parentNode;)u.unshift(i);for(;l[s]===u[s];)s++;return s?o(l[s],u[s]):l[s]===B?-1:u[s]===B?1:0},n):P},e.matches=function(t,i){return e(t,null,null,i)},e.matchesSelector=function(t,i){if((t.ownerDocument||t)!==P&&k(t),i=i.replace(ht,"='$1']"),x.matchesSelector&&R&&(!L||!L.test(i))&&(!j||!j.test(i)))try{var n=F.call(t,i);if(n||x.disconnectedMatch||t.document&&11!==t.document.nodeType)return n}catch(s){}return e(i,P,null,[t]).length>0},e.contains=function(t,e){return(t.ownerDocument||t)!==P&&k(t),M(t,e)},e.attr=function(t,e){(t.ownerDocument||t)!==P&&k(t);var i=C.attrHandle[e.toLowerCase()],n=i&&X.call(C.attrHandle,e.toLowerCase())?i(t,e,!R):void 0;return void 0!==n?n:x.attributes||!R?t.getAttribute(e):(n=t.getAttributeNode(e))&&n.specified?n.value:null},e.error=function(t){throw new Error("Syntax error, unrecognized expression: "+t)},e.uniqueSort=function(t){var e,i=[],n=0,s=0;if(O=!x.detectDuplicates,A=!x.sortStable&&t.slice(0),t.sort(G),O){for(;e=t[s++];)e===t[s]&&(n=i.push(s));for(;n--;)t.splice(i[n],1)}return A=null,t},w=e.getText=function(t){var e,i="",n=0,s=t.nodeType;if(s){if(1===s||9===s||11===s){if("string"==typeof t.textContent)return t.textContent;for(t=t.firstChild;t;t=t.nextSibling)i+=w(t)}else if(3===s||4===s)return t.nodeValue}else for(;e=t[n++];)i+=w(e);return i},C=e.selectors={cacheLength:50,createPseudo:n,match:ft,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(t){return t[1]=t[1].replace(xt,Ct),t[3]=(t[3]||t[4]||t[5]||"").replace(xt,Ct),"~="===t[2]&&(t[3]=" "+t[3]+" "),t.slice(0,4)},CHILD:function(t){return t[1]=t[1].toLowerCase(),"nth"===t[1].slice(0,3)?(t[3]||e.error(t[0]),t[4]=+(t[4]?t[5]+(t[6]||1):2*("even"===t[3]||"odd"===t[3])),t[5]=+(t[7]+t[8]||"odd"===t[3])):t[3]&&e.error(t[0]),t},PSEUDO:function(t){var e,i=!t[6]&&t[2];return ft.CHILD.test(t[0])?null:(t[3]?t[2]=t[4]||t[5]||"":i&&pt.test(i)&&(e=T(i,!0))&&(e=i.indexOf(")",i.length-e)-i.length)&&(t[0]=t[0].slice(0,e),t[2]=i.slice(0,e)),t.slice(0,3))}},filter:{TAG:function(t){var e=t.replace(xt,Ct).toLowerCase();return"*"===t?function(){return!0}:function(t){return t.nodeName&&t.nodeName.toLowerCase()===e}},CLASS:function(t){var e=H[t+" "];return e||(e=new RegExp("(^|"+it+")"+t+"("+it+"|$)"))&&H(t,function(t){return e.test("string"==typeof t.className&&t.className||"undefined"!=typeof t.getAttribute&&t.getAttribute("class")||"")})},ATTR:function(t,i,n){return function(s){var r=e.attr(s,t);return null==r?"!="===i:i?(r+="","="===i?r===n:"!="===i?r!==n:"^="===i?n&&0===r.indexOf(n):"*="===i?n&&r.indexOf(n)>-1:"$="===i?n&&r.slice(-n.length)===n:"~="===i?(" "+r.replace(at," ")+" ").indexOf(n)>-1:"|="===i?r===n||r.slice(0,n.length+1)===n+"-":!1):!0}},CHILD:function(t,e,i,n,s){var r="nth"!==t.slice(0,3),o="last"!==t.slice(-4),a="of-type"===e;return 1===n&&0===s?function(t){return!!t.parentNode}:function(e,i,l){var u,c,h,p,d,f,m=r!==o?"nextSibling":"previousSibling",g=e.parentNode,b=a&&e.nodeName.toLowerCase(),y=!l&&!a;if(g){if(r){for(;m;){for(h=e;h=h[m];)if(a?h.nodeName.toLowerCase()===b:1===h.nodeType)return!1;f=m="only"===t&&!f&&"nextSibling"}return!0}if(f=[o?g.firstChild:g.lastChild],o&&y){for(c=g[q]||(g[q]={}),u=c[t]||[],d=u[0]===U&&u[1],p=u[0]===U&&u[2],h=d&&g.childNodes[d];h=++d&&h&&h[m]||(p=d=0)||f.pop();)if(1===h.nodeType&&++p&&h===e){c[t]=[U,d,p];break}}else if(y&&(u=(e[q]||(e[q]={}))[t])&&u[0]===U)p=u[1];else for(;(h=++d&&h&&h[m]||(p=d=0)||f.pop())&&((a?h.nodeName.toLowerCase()!==b:1!==h.nodeType)||!++p||(y&&((h[q]||(h[q]={}))[t]=[U,p]),h!==e)););return p-=s,p===n||p%n===0&&p/n>=0}}},PSEUDO:function(t,i){var s,r=C.pseudos[t]||C.setFilters[t.toLowerCase()]||e.error("unsupported pseudo: "+t);return r[q]?r(i):r.length>1?(s=[t,t,"",i],C.setFilters.hasOwnProperty(t.toLowerCase())?n(function(t,e){for(var n,s=r(t,i),o=s.length;o--;)n=tt(t,s[o]),t[n]=!(e[n]=s[o])}):function(t){return r(t,0,s)}):r}},pseudos:{not:n(function(t){var e=[],i=[],s=E(t.replace(lt,"$1"));return s[q]?n(function(t,e,i,n){for(var r,o=s(t,null,n,[]),a=t.length;a--;)(r=o[a])&&(t[a]=!(e[a]=r))}):function(t,n,r){return e[0]=t,s(e,null,r,i),e[0]=null,!i.pop()}}),has:n(function(t){return function(i){return e(t,i).length>0}}),contains:n(function(t){return t=t.replace(xt,Ct),function(e){return(e.textContent||e.innerText||w(e)).indexOf(t)>-1}}),lang:n(function(t){return dt.test(t||"")||e.error("unsupported lang: "+t),t=t.replace(xt,Ct).toLowerCase(),function(e){var i;do if(i=R?e.lang:e.getAttribute("xml:lang")||e.getAttribute("lang"))return i=i.toLowerCase(),i===t||0===i.indexOf(t+"-");while((e=e.parentNode)&&1===e.nodeType);return!1}}),target:function(e){var i=t.location&&t.location.hash;return i&&i.slice(1)===e.id},root:function(t){return t===D},focus:function(t){return t===P.activeElement&&(!P.hasFocus||P.hasFocus())&&!!(t.type||t.href||~t.tabIndex)},enabled:function(t){return t.disabled===!1},disabled:function(t){return t.disabled===!0},checked:function(t){var e=t.nodeName.toLowerCase();return"input"===e&&!!t.checked||"option"===e&&!!t.selected},selected:function(t){return t.parentNode&&t.parentNode.selectedIndex,t.selected===!0},empty:function(t){for(t=t.firstChild;t;t=t.nextSibling)if(t.nodeType<6)return!1;return!0},parent:function(t){return!C.pseudos.empty(t)},header:function(t){return gt.test(t.nodeName)},input:function(t){return mt.test(t.nodeName)},button:function(t){var e=t.nodeName.toLowerCase();return"input"===e&&"button"===t.type||"button"===e},text:function(t){var e;return"input"===t.nodeName.toLowerCase()&&"text"===t.type&&(null==(e=t.getAttribute("type"))||"text"===e.toLowerCase())},first:u(function(){return[0]}),last:u(function(t,e){return[e-1]}),eq:u(function(t,e,i){return[0>i?i+e:i]}),even:u(function(t,e){for(var i=0;e>i;i+=2)t.push(i);return t}),odd:u(function(t,e){for(var i=1;e>i;i+=2)t.push(i);return t}),lt:u(function(t,e,i){for(var n=0>i?i+e:i;--n>=0;)t.push(n);return t}),gt:u(function(t,e,i){for(var n=0>i?i+e:i;++n<e;)t.push(n);return t})}},C.pseudos.nth=C.pseudos.eq;for(_ in{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})C.pseudos[_]=a(_);for(_ in{submit:!0,reset:!0})C.pseudos[_]=l(_);return h.prototype=C.filters=C.pseudos,C.setFilters=new h,T=e.tokenize=function(t,i){var n,s,r,o,a,l,u,c=z[t+" "];if(c)return i?0:c.slice(0);for(a=t,l=[],u=C.preFilter;a;){(!n||(s=ut.exec(a)))&&(s&&(a=a.slice(s[0].length)||a),l.push(r=[])),n=!1,(s=ct.exec(a))&&(n=s.shift(),r.push({value:n,type:s[0].replace(lt," ")}),a=a.slice(n.length));for(o in C.filter)!(s=ft[o].exec(a))||u[o]&&!(s=u[o](s))||(n=s.shift(),r.push({value:n,type:o,matches:s}),a=a.slice(n.length));if(!n)break}return i?a.length:a?e.error(t):z(t,l).slice(0)},E=e.compile=function(t,e){var i,n=[],s=[],r=V[t+" "];if(!r){for(e||(e=T(t)),i=e.length;i--;)r=y(e[i]),r[q]?n.push(r):s.push(r);r=V(t,v(s,n)),r.selector=t}return r},I=e.select=function(t,e,i,n){var s,r,o,a,l,u="function"==typeof t&&t,h=!n&&T(t=u.selector||t);if(i=i||[],1===h.length){if(r=h[0]=h[0].slice(0),r.length>2&&"ID"===(o=r[0]).type&&x.getById&&9===e.nodeType&&R&&C.relative[r[1].type]){if(e=(C.find.ID(o.matches[0].replace(xt,Ct),e)||[])[0],!e)return i;u&&(e=e.parentNode),t=t.slice(r.shift().value.length)}for(s=ft.needsContext.test(t)?0:r.length;s--&&(o=r[s],!C.relative[a=o.type]);)if((l=C.find[a])&&(n=l(o.matches[0].replace(xt,Ct),vt.test(r[0].type)&&c(e.parentNode)||e))){if(r.splice(s,1),t=n.length&&p(r),!t)return Y.apply(i,n),i;break}}return(u||E(t,h))(n,e,!R,i,vt.test(t)&&c(e.parentNode)||e),i},x.sortStable=q.split("").sort(G).join("")===q,x.detectDuplicates=!!O,k(),x.sortDetached=s(function(t){return 1&t.compareDocumentPosition(P.createElement("div"))}),s(function(t){return t.innerHTML="<a href='#'></a>","#"===t.firstChild.getAttribute("href")})||r("type|href|height|width",function(t,e,i){return i?void 0:t.getAttribute(e,"type"===e.toLowerCase()?1:2)}),x.attributes&&s(function(t){return t.innerHTML="<input/>",t.firstChild.setAttribute("value",""),""===t.firstChild.getAttribute("value")})||r("value",function(t,e,i){return i||"input"!==t.nodeName.toLowerCase()?void 0:t.defaultValue}),s(function(t){return null==t.getAttribute("disabled")})||r(et,function(t,e,i){var n;return i?void 0:t[e]===!0?e.toLowerCase():(n=t.getAttributeNode(e))&&n.specified?n.value:null}),e}(t);Z.find=st,Z.expr=st.selectors,Z.expr[":"]=Z.expr.pseudos,Z.unique=st.uniqueSort,Z.text=st.getText,Z.isXMLDoc=st.isXML,Z.contains=st.contains;var rt=Z.expr.match.needsContext,ot=/^<(\w+)\s*\/?>(?:<\/\1>|)$/,at=/^.[^:#\[\.,]*$/;Z.filter=function(t,e,i){var n=e[0];return i&&(t=":not("+t+")"),1===e.length&&1===n.nodeType?Z.find.matchesSelector(n,t)?[n]:[]:Z.find.matches(t,Z.grep(e,function(t){return 1===t.nodeType}))},Z.fn.extend({find:function(t){var e,i=this.length,n=[],s=this;if("string"!=typeof t)return this.pushStack(Z(t).filter(function(){for(e=0;i>e;e++)if(Z.contains(s[e],this))return!0}));for(e=0;i>e;e++)Z.find(t,s[e],n);return n=this.pushStack(i>1?Z.unique(n):n),n.selector=this.selector?this.selector+" "+t:t,n},filter:function(t){return this.pushStack(n(this,t||[],!1))},not:function(t){return this.pushStack(n(this,t||[],!0))},is:function(t){return!!n(this,"string"==typeof t&&rt.test(t)?Z(t):t||[],!1).length}});var lt,ut=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]*))$/,ct=Z.fn.init=function(t,e){var i,n;if(!t)return this;if("string"==typeof t){if(i="<"===t[0]&&">"===t[t.length-1]&&t.length>=3?[null,t,null]:ut.exec(t),!i||!i[1]&&e)return!e||e.jquery?(e||lt).find(t):this.constructor(e).find(t);if(i[1]){if(e=e instanceof Z?e[0]:e,Z.merge(this,Z.parseHTML(i[1],e&&e.nodeType?e.ownerDocument||e:Q,!0)),ot.test(i[1])&&Z.isPlainObject(e))for(i in e)Z.isFunction(this[i])?this[i](e[i]):this.attr(i,e[i]);return this}return n=Q.getElementById(i[2]),n&&n.parentNode&&(this.length=1,this[0]=n),this.context=Q,this.selector=t,this}return t.nodeType?(this.context=this[0]=t,this.length=1,this):Z.isFunction(t)?"undefined"!=typeof lt.ready?lt.ready(t):t(Z):(void 0!==t.selector&&(this.selector=t.selector,this.context=t.context),Z.makeArray(t,this))};ct.prototype=Z.fn,lt=Z(Q);var ht=/^(?:parents|prev(?:Until|All))/,pt={children:!0,contents:!0,next:!0,prev:!0};Z.extend({dir:function(t,e,i){for(var n=[],s=void 0!==i;(t=t[e])&&9!==t.nodeType;)if(1===t.nodeType){if(s&&Z(t).is(i))break;n.push(t)}return n},sibling:function(t,e){for(var i=[];t;t=t.nextSibling)1===t.nodeType&&t!==e&&i.push(t);return i}}),Z.fn.extend({has:function(t){var e=Z(t,this),i=e.length;return this.filter(function(){for(var t=0;i>t;t++)if(Z.contains(this,e[t]))return!0})},closest:function(t,e){for(var i,n=0,s=this.length,r=[],o=rt.test(t)||"string"!=typeof t?Z(t,e||this.context):0;s>n;n++)for(i=this[n];i&&i!==e;i=i.parentNode)if(i.nodeType<11&&(o?o.index(i)>-1:1===i.nodeType&&Z.find.matchesSelector(i,t))){r.push(i);break}return this.pushStack(r.length>1?Z.unique(r):r)},index:function(t){return t?"string"==typeof t?G.call(Z(t),this[0]):G.call(this,t.jquery?t[0]:t):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(t,e){return this.pushStack(Z.unique(Z.merge(this.get(),Z(t,e))))},addBack:function(t){return this.add(null==t?this.prevObject:this.prevObject.filter(t))}}),Z.each({parent:function(t){var e=t.parentNode;return e&&11!==e.nodeType?e:null},parents:function(t){return Z.dir(t,"parentNode")},parentsUntil:function(t,e,i){return Z.dir(t,"parentNode",i)},next:function(t){return s(t,"nextSibling")},prev:function(t){return s(t,"previousSibling")},nextAll:function(t){return Z.dir(t,"nextSibling")},prevAll:function(t){return Z.dir(t,"previousSibling")},nextUntil:function(t,e,i){return Z.dir(t,"nextSibling",i)},prevUntil:function(t,e,i){return Z.dir(t,"previousSibling",i)},siblings:function(t){return Z.sibling((t.parentNode||{}).firstChild,t)},children:function(t){return Z.sibling(t.firstChild)},contents:function(t){return t.contentDocument||Z.merge([],t.childNodes)}},function(t,e){Z.fn[t]=function(i,n){var s=Z.map(this,e,i);return"Until"!==t.slice(-5)&&(n=i),n&&"string"==typeof n&&(s=Z.filter(n,s)),this.length>1&&(pt[t]||Z.unique(s),ht.test(t)&&s.reverse()),this.pushStack(s)}});var dt=/\S+/g,ft={};Z.Callbacks=function(t){t="string"==typeof t?ft[t]||r(t):Z.extend({},t);var e,i,n,s,o,a,l=[],u=!t.once&&[],c=function(r){for(e=t.memory&&r,i=!0,a=s||0,s=0,o=l.length,n=!0;l&&o>a;a++)if(l[a].apply(r[0],r[1])===!1&&t.stopOnFalse){e=!1;break}n=!1,l&&(u?u.length&&c(u.shift()):e?l=[]:h.disable())},h={add:function(){if(l){var i=l.length;!function r(e){Z.each(e,function(e,i){var n=Z.type(i);"function"===n?t.unique&&h.has(i)||l.push(i):i&&i.length&&"string"!==n&&r(i)})}(arguments),n?o=l.length:e&&(s=i,c(e))}return this},remove:function(){return l&&Z.each(arguments,function(t,e){for(var i;(i=Z.inArray(e,l,i))>-1;)l.splice(i,1),n&&(o>=i&&o--,a>=i&&a--)}),this},has:function(t){return t?Z.inArray(t,l)>-1:!(!l||!l.length)},empty:function(){return l=[],o=0,this},disable:function(){return l=u=e=void 0,this},disabled:function(){return!l},lock:function(){return u=void 0,e||h.disable(),this},locked:function(){return!u},fireWith:function(t,e){return!l||i&&!u||(e=e||[],e=[t,e.slice?e.slice():e],n?u.push(e):c(e)),this},fire:function(){return h.fireWith(this,arguments),this},fired:function(){return!!i}};return h},Z.extend({Deferred:function(t){var e=[["resolve","done",Z.Callbacks("once memory"),"resolved"],["reject","fail",Z.Callbacks("once memory"),"rejected"],["notify","progress",Z.Callbacks("memory")]],i="pending",n={state:function(){return i},always:function(){return s.done(arguments).fail(arguments),this},then:function(){var t=arguments;return Z.Deferred(function(i){Z.each(e,function(e,r){var o=Z.isFunction(t[e])&&t[e];s[r[1]](function(){var t=o&&o.apply(this,arguments);t&&Z.isFunction(t.promise)?t.promise().done(i.resolve).fail(i.reject).progress(i.notify):i[r[0]+"With"](this===n?i.promise():this,o?[t]:arguments)})}),t=null}).promise()},promise:function(t){return null!=t?Z.extend(t,n):n}},s={};return n.pipe=n.then,Z.each(e,function(t,r){var o=r[2],a=r[3];n[r[1]]=o.add,a&&o.add(function(){i=a},e[1^t][2].disable,e[2][2].lock),s[r[0]]=function(){return s[r[0]+"With"](this===s?n:this,arguments),this},s[r[0]+"With"]=o.fireWith}),n.promise(s),t&&t.call(s,s),s},when:function(t){var e,i,n,s=0,r=H.call(arguments),o=r.length,a=1!==o||t&&Z.isFunction(t.promise)?o:0,l=1===a?t:Z.Deferred(),u=function(t,i,n){return function(s){i[t]=this,n[t]=arguments.length>1?H.call(arguments):s,n===e?l.notifyWith(i,n):--a||l.resolveWith(i,n)}};if(o>1)for(e=new Array(o),i=new Array(o),n=new Array(o);o>s;s++)r[s]&&Z.isFunction(r[s].promise)?r[s].promise().done(u(s,n,r)).fail(l.reject).progress(u(s,i,e)):--a;return a||l.resolveWith(n,r),l.promise()}});var mt;Z.fn.ready=function(t){return Z.ready.promise().done(t),this},Z.extend({isReady:!1,readyWait:1,holdReady:function(t){t?Z.readyWait++:Z.ready(!0)},ready:function(t){(t===!0?--Z.readyWait:Z.isReady)||(Z.isReady=!0,t!==!0&&--Z.readyWait>0||(mt.resolveWith(Q,[Z]),Z.fn.triggerHandler&&(Z(Q).triggerHandler("ready"),Z(Q).off("ready"))))}}),Z.ready.promise=function(e){return mt||(mt=Z.Deferred(),"complete"===Q.readyState?setTimeout(Z.ready):(Q.addEventListener("DOMContentLoaded",o,!1),t.addEventListener("load",o,!1))),mt.promise(e)},Z.ready.promise();var gt=Z.access=function(t,e,i,n,s,r,o){var a=0,l=t.length,u=null==i;if("object"===Z.type(i)){s=!0;for(a in i)Z.access(t,e,a,i[a],!0,r,o)}else if(void 0!==n&&(s=!0,Z.isFunction(n)||(o=!0),u&&(o?(e.call(t,n),e=null):(u=e,e=function(t,e,i){return u.call(Z(t),i)})),e))for(;l>a;a++)e(t[a],i,o?n:n.call(t[a],a,e(t[a],i)));return s?t:u?e.call(t):l?e(t[0],i):r};Z.acceptData=function(t){return 1===t.nodeType||9===t.nodeType||!+t.nodeType},a.uid=1,a.accepts=Z.acceptData,a.prototype={key:function(t){if(!a.accepts(t))return 0;var e={},i=t[this.expando];if(!i){i=a.uid++;try{e[this.expando]={value:i},Object.defineProperties(t,e)}catch(n){e[this.expando]=i,Z.extend(t,e)}}return this.cache[i]||(this.cache[i]={}),i},set:function(t,e,i){var n,s=this.key(t),r=this.cache[s];if("string"==typeof e)r[e]=i;else if(Z.isEmptyObject(r))Z.extend(this.cache[s],e);else for(n in e)r[n]=e[n];return r},get:function(t,e){var i=this.cache[this.key(t)];return void 0===e?i:i[e]},access:function(t,e,i){var n;return void 0===e||e&&"string"==typeof e&&void 0===i?(n=this.get(t,e),void 0!==n?n:this.get(t,Z.camelCase(e))):(this.set(t,e,i),void 0!==i?i:e)},remove:function(t,e){var i,n,s,r=this.key(t),o=this.cache[r];if(void 0===e)this.cache[r]={};else{Z.isArray(e)?n=e.concat(e.map(Z.camelCase)):(s=Z.camelCase(e),e in o?n=[e,s]:(n=s,n=n in o?[n]:n.match(dt)||[])),i=n.length;for(;i--;)delete o[n[i]]}},hasData:function(t){return!Z.isEmptyObject(this.cache[t[this.expando]]||{})},discard:function(t){t[this.expando]&&delete this.cache[t[this.expando]]}};var bt=new a,yt=new a,vt=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,_t=/([A-Z])/g;Z.extend({hasData:function(t){return yt.hasData(t)||bt.hasData(t)},data:function(t,e,i){return yt.access(t,e,i)},removeData:function(t,e){yt.remove(t,e)},_data:function(t,e,i){return bt.access(t,e,i)},_removeData:function(t,e){bt.remove(t,e)}}),Z.fn.extend({data:function(t,e){var i,n,s,r=this[0],o=r&&r.attributes;if(void 0===t){if(this.length&&(s=yt.get(r),1===r.nodeType&&!bt.get(r,"hasDataAttrs"))){for(i=o.length;i--;)o[i]&&(n=o[i].name,
0===n.indexOf("data-")&&(n=Z.camelCase(n.slice(5)),l(r,n,s[n])));bt.set(r,"hasDataAttrs",!0)}return s}return"object"==typeof t?this.each(function(){yt.set(this,t)}):gt(this,function(e){var i,n=Z.camelCase(t);if(r&&void 0===e){if(i=yt.get(r,t),void 0!==i)return i;if(i=yt.get(r,n),void 0!==i)return i;if(i=l(r,n,void 0),void 0!==i)return i}else this.each(function(){var i=yt.get(this,n);yt.set(this,n,e),-1!==t.indexOf("-")&&void 0!==i&&yt.set(this,t,e)})},null,e,arguments.length>1,null,!0)},removeData:function(t){return this.each(function(){yt.remove(this,t)})}}),Z.extend({queue:function(t,e,i){var n;return t?(e=(e||"fx")+"queue",n=bt.get(t,e),i&&(!n||Z.isArray(i)?n=bt.access(t,e,Z.makeArray(i)):n.push(i)),n||[]):void 0},dequeue:function(t,e){e=e||"fx";var i=Z.queue(t,e),n=i.length,s=i.shift(),r=Z._queueHooks(t,e),o=function(){Z.dequeue(t,e)};"inprogress"===s&&(s=i.shift(),n--),s&&("fx"===e&&i.unshift("inprogress"),delete r.stop,s.call(t,o,r)),!n&&r&&r.empty.fire()},_queueHooks:function(t,e){var i=e+"queueHooks";return bt.get(t,i)||bt.access(t,i,{empty:Z.Callbacks("once memory").add(function(){bt.remove(t,[e+"queue",i])})})}}),Z.fn.extend({queue:function(t,e){var i=2;return"string"!=typeof t&&(e=t,t="fx",i--),arguments.length<i?Z.queue(this[0],t):void 0===e?this:this.each(function(){var i=Z.queue(this,t,e);Z._queueHooks(this,t),"fx"===t&&"inprogress"!==i[0]&&Z.dequeue(this,t)})},dequeue:function(t){return this.each(function(){Z.dequeue(this,t)})},clearQueue:function(t){return this.queue(t||"fx",[])},promise:function(t,e){var i,n=1,s=Z.Deferred(),r=this,o=this.length,a=function(){--n||s.resolveWith(r,[r])};for("string"!=typeof t&&(e=t,t=void 0),t=t||"fx";o--;)i=bt.get(r[o],t+"queueHooks"),i&&i.empty&&(n++,i.empty.add(a));return a(),s.promise(e)}});var xt=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,Ct=["Top","Right","Bottom","Left"],wt=function(t,e){return t=e||t,"none"===Z.css(t,"display")||!Z.contains(t.ownerDocument,t)},St=/^(?:checkbox|radio)$/i;!function(){var t=Q.createDocumentFragment(),e=t.appendChild(Q.createElement("div")),i=Q.createElement("input");i.setAttribute("type","radio"),i.setAttribute("checked","checked"),i.setAttribute("name","t"),e.appendChild(i),J.checkClone=e.cloneNode(!0).cloneNode(!0).lastChild.checked,e.innerHTML="<textarea>x</textarea>",J.noCloneChecked=!!e.cloneNode(!0).lastChild.defaultValue}();var Tt="undefined";J.focusinBubbles="onfocusin"in t;var Et=/^key/,It=/^(?:mouse|pointer|contextmenu)|click/,Nt=/^(?:focusinfocus|focusoutblur)$/,At=/^([^.]*)(?:\.(.+)|)$/;Z.event={global:{},add:function(t,e,i,n,s){var r,o,a,l,u,c,h,p,d,f,m,g=bt.get(t);if(g)for(i.handler&&(r=i,i=r.handler,s=r.selector),i.guid||(i.guid=Z.guid++),(l=g.events)||(l=g.events={}),(o=g.handle)||(o=g.handle=function(e){return typeof Z!==Tt&&Z.event.triggered!==e.type?Z.event.dispatch.apply(t,arguments):void 0}),e=(e||"").match(dt)||[""],u=e.length;u--;)a=At.exec(e[u])||[],d=m=a[1],f=(a[2]||"").split(".").sort(),d&&(h=Z.event.special[d]||{},d=(s?h.delegateType:h.bindType)||d,h=Z.event.special[d]||{},c=Z.extend({type:d,origType:m,data:n,handler:i,guid:i.guid,selector:s,needsContext:s&&Z.expr.match.needsContext.test(s),namespace:f.join(".")},r),(p=l[d])||(p=l[d]=[],p.delegateCount=0,h.setup&&h.setup.call(t,n,f,o)!==!1||t.addEventListener&&t.addEventListener(d,o,!1)),h.add&&(h.add.call(t,c),c.handler.guid||(c.handler.guid=i.guid)),s?p.splice(p.delegateCount++,0,c):p.push(c),Z.event.global[d]=!0)},remove:function(t,e,i,n,s){var r,o,a,l,u,c,h,p,d,f,m,g=bt.hasData(t)&&bt.get(t);if(g&&(l=g.events)){for(e=(e||"").match(dt)||[""],u=e.length;u--;)if(a=At.exec(e[u])||[],d=m=a[1],f=(a[2]||"").split(".").sort(),d){for(h=Z.event.special[d]||{},d=(n?h.delegateType:h.bindType)||d,p=l[d]||[],a=a[2]&&new RegExp("(^|\\.)"+f.join("\\.(?:.*\\.|)")+"(\\.|$)"),o=r=p.length;r--;)c=p[r],!s&&m!==c.origType||i&&i.guid!==c.guid||a&&!a.test(c.namespace)||n&&n!==c.selector&&("**"!==n||!c.selector)||(p.splice(r,1),c.selector&&p.delegateCount--,h.remove&&h.remove.call(t,c));o&&!p.length&&(h.teardown&&h.teardown.call(t,f,g.handle)!==!1||Z.removeEvent(t,d,g.handle),delete l[d])}else for(d in l)Z.event.remove(t,d+e[u],i,n,!0);Z.isEmptyObject(l)&&(delete g.handle,bt.remove(t,"events"))}},trigger:function(e,i,n,s){var r,o,a,l,u,c,h,p=[n||Q],d=K.call(e,"type")?e.type:e,f=K.call(e,"namespace")?e.namespace.split("."):[];if(o=a=n=n||Q,3!==n.nodeType&&8!==n.nodeType&&!Nt.test(d+Z.event.triggered)&&(d.indexOf(".")>=0&&(f=d.split("."),d=f.shift(),f.sort()),u=d.indexOf(":")<0&&"on"+d,e=e[Z.expando]?e:new Z.Event(d,"object"==typeof e&&e),e.isTrigger=s?2:3,e.namespace=f.join("."),e.namespace_re=e.namespace?new RegExp("(^|\\.)"+f.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,e.result=void 0,e.target||(e.target=n),i=null==i?[e]:Z.makeArray(i,[e]),h=Z.event.special[d]||{},s||!h.trigger||h.trigger.apply(n,i)!==!1)){if(!s&&!h.noBubble&&!Z.isWindow(n)){for(l=h.delegateType||d,Nt.test(l+d)||(o=o.parentNode);o;o=o.parentNode)p.push(o),a=o;a===(n.ownerDocument||Q)&&p.push(a.defaultView||a.parentWindow||t)}for(r=0;(o=p[r++])&&!e.isPropagationStopped();)e.type=r>1?l:h.bindType||d,c=(bt.get(o,"events")||{})[e.type]&&bt.get(o,"handle"),c&&c.apply(o,i),c=u&&o[u],c&&c.apply&&Z.acceptData(o)&&(e.result=c.apply(o,i),e.result===!1&&e.preventDefault());return e.type=d,s||e.isDefaultPrevented()||h._default&&h._default.apply(p.pop(),i)!==!1||!Z.acceptData(n)||u&&Z.isFunction(n[d])&&!Z.isWindow(n)&&(a=n[u],a&&(n[u]=null),Z.event.triggered=d,n[d](),Z.event.triggered=void 0,a&&(n[u]=a)),e.result}},dispatch:function(t){t=Z.event.fix(t);var e,i,n,s,r,o=[],a=H.call(arguments),l=(bt.get(this,"events")||{})[t.type]||[],u=Z.event.special[t.type]||{};if(a[0]=t,t.delegateTarget=this,!u.preDispatch||u.preDispatch.call(this,t)!==!1){for(o=Z.event.handlers.call(this,t,l),e=0;(s=o[e++])&&!t.isPropagationStopped();)for(t.currentTarget=s.elem,i=0;(r=s.handlers[i++])&&!t.isImmediatePropagationStopped();)(!t.namespace_re||t.namespace_re.test(r.namespace))&&(t.handleObj=r,t.data=r.data,n=((Z.event.special[r.origType]||{}).handle||r.handler).apply(s.elem,a),void 0!==n&&(t.result=n)===!1&&(t.preventDefault(),t.stopPropagation()));return u.postDispatch&&u.postDispatch.call(this,t),t.result}},handlers:function(t,e){var i,n,s,r,o=[],a=e.delegateCount,l=t.target;if(a&&l.nodeType&&(!t.button||"click"!==t.type))for(;l!==this;l=l.parentNode||this)if(l.disabled!==!0||"click"!==t.type){for(n=[],i=0;a>i;i++)r=e[i],s=r.selector+" ",void 0===n[s]&&(n[s]=r.needsContext?Z(s,this).index(l)>=0:Z.find(s,this,null,[l]).length),n[s]&&n.push(r);n.length&&o.push({elem:l,handlers:n})}return a<e.length&&o.push({elem:this,handlers:e.slice(a)}),o},props:"altKey bubbles cancelable ctrlKey currentTarget eventPhase metaKey relatedTarget shiftKey target timeStamp view which".split(" "),fixHooks:{},keyHooks:{props:"char charCode key keyCode".split(" "),filter:function(t,e){return null==t.which&&(t.which=null!=e.charCode?e.charCode:e.keyCode),t}},mouseHooks:{props:"button buttons clientX clientY offsetX offsetY pageX pageY screenX screenY toElement".split(" "),filter:function(t,e){var i,n,s,r=e.button;return null==t.pageX&&null!=e.clientX&&(i=t.target.ownerDocument||Q,n=i.documentElement,s=i.body,t.pageX=e.clientX+(n&&n.scrollLeft||s&&s.scrollLeft||0)-(n&&n.clientLeft||s&&s.clientLeft||0),t.pageY=e.clientY+(n&&n.scrollTop||s&&s.scrollTop||0)-(n&&n.clientTop||s&&s.clientTop||0)),t.which||void 0===r||(t.which=1&r?1:2&r?3:4&r?2:0),t}},fix:function(t){if(t[Z.expando])return t;var e,i,n,s=t.type,r=t,o=this.fixHooks[s];for(o||(this.fixHooks[s]=o=It.test(s)?this.mouseHooks:Et.test(s)?this.keyHooks:{}),n=o.props?this.props.concat(o.props):this.props,t=new Z.Event(r),e=n.length;e--;)i=n[e],t[i]=r[i];return t.target||(t.target=Q),3===t.target.nodeType&&(t.target=t.target.parentNode),o.filter?o.filter(t,r):t},special:{load:{noBubble:!0},focus:{trigger:function(){return this!==h()&&this.focus?(this.focus(),!1):void 0},delegateType:"focusin"},blur:{trigger:function(){return this===h()&&this.blur?(this.blur(),!1):void 0},delegateType:"focusout"},click:{trigger:function(){return"checkbox"===this.type&&this.click&&Z.nodeName(this,"input")?(this.click(),!1):void 0},_default:function(t){return Z.nodeName(t.target,"a")}},beforeunload:{postDispatch:function(t){void 0!==t.result&&t.originalEvent&&(t.originalEvent.returnValue=t.result)}}},simulate:function(t,e,i,n){var s=Z.extend(new Z.Event,i,{type:t,isSimulated:!0,originalEvent:{}});n?Z.event.trigger(s,null,e):Z.event.dispatch.call(e,s),s.isDefaultPrevented()&&i.preventDefault()}},Z.removeEvent=function(t,e,i){t.removeEventListener&&t.removeEventListener(e,i,!1)},Z.Event=function(t,e){return this instanceof Z.Event?(t&&t.type?(this.originalEvent=t,this.type=t.type,this.isDefaultPrevented=t.defaultPrevented||void 0===t.defaultPrevented&&t.returnValue===!1?u:c):this.type=t,e&&Z.extend(this,e),this.timeStamp=t&&t.timeStamp||Z.now(),void(this[Z.expando]=!0)):new Z.Event(t,e)},Z.Event.prototype={isDefaultPrevented:c,isPropagationStopped:c,isImmediatePropagationStopped:c,preventDefault:function(){var t=this.originalEvent;this.isDefaultPrevented=u,t&&t.preventDefault&&t.preventDefault()},stopPropagation:function(){var t=this.originalEvent;this.isPropagationStopped=u,t&&t.stopPropagation&&t.stopPropagation()},stopImmediatePropagation:function(){var t=this.originalEvent;this.isImmediatePropagationStopped=u,t&&t.stopImmediatePropagation&&t.stopImmediatePropagation(),this.stopPropagation()}},Z.each({mouseenter:"mouseover",mouseleave:"mouseout",pointerenter:"pointerover",pointerleave:"pointerout"},function(t,e){Z.event.special[t]={delegateType:e,bindType:e,handle:function(t){var i,n=this,s=t.relatedTarget,r=t.handleObj;return(!s||s!==n&&!Z.contains(n,s))&&(t.type=r.origType,i=r.handler.apply(this,arguments),t.type=e),i}}}),J.focusinBubbles||Z.each({focus:"focusin",blur:"focusout"},function(t,e){var i=function(t){Z.event.simulate(e,t.target,Z.event.fix(t),!0)};Z.event.special[e]={setup:function(){var n=this.ownerDocument||this,s=bt.access(n,e);s||n.addEventListener(t,i,!0),bt.access(n,e,(s||0)+1)},teardown:function(){var n=this.ownerDocument||this,s=bt.access(n,e)-1;s?bt.access(n,e,s):(n.removeEventListener(t,i,!0),bt.remove(n,e))}}}),Z.fn.extend({on:function(t,e,i,n,s){var r,o;if("object"==typeof t){"string"!=typeof e&&(i=i||e,e=void 0);for(o in t)this.on(o,e,i,t[o],s);return this}if(null==i&&null==n?(n=e,i=e=void 0):null==n&&("string"==typeof e?(n=i,i=void 0):(n=i,i=e,e=void 0)),n===!1)n=c;else if(!n)return this;return 1===s&&(r=n,n=function(t){return Z().off(t),r.apply(this,arguments)},n.guid=r.guid||(r.guid=Z.guid++)),this.each(function(){Z.event.add(this,t,n,i,e)})},one:function(t,e,i,n){return this.on(t,e,i,n,1)},off:function(t,e,i){var n,s;if(t&&t.preventDefault&&t.handleObj)return n=t.handleObj,Z(t.delegateTarget).off(n.namespace?n.origType+"."+n.namespace:n.origType,n.selector,n.handler),this;if("object"==typeof t){for(s in t)this.off(s,e,t[s]);return this}return(e===!1||"function"==typeof e)&&(i=e,e=void 0),i===!1&&(i=c),this.each(function(){Z.event.remove(this,t,i,e)})},trigger:function(t,e){return this.each(function(){Z.event.trigger(t,e,this)})},triggerHandler:function(t,e){var i=this[0];return i?Z.event.trigger(t,e,i,!0):void 0}});var Ot=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/gi,kt=/<([\w:]+)/,Pt=/<|&#?\w+;/,Dt=/<(?:script|style|link)/i,Rt=/checked\s*(?:[^=]|=\s*.checked.)/i,jt=/^$|\/(?:java|ecma)script/i,Lt=/^true\/(.*)/,Ft=/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g,Mt={option:[1,"<select multiple='multiple'>","</select>"],thead:[1,"<table>","</table>"],col:[2,"<table><colgroup>","</colgroup></table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:[0,"",""]};Mt.optgroup=Mt.option,Mt.tbody=Mt.tfoot=Mt.colgroup=Mt.caption=Mt.thead,Mt.th=Mt.td,Z.extend({clone:function(t,e,i){var n,s,r,o,a=t.cloneNode(!0),l=Z.contains(t.ownerDocument,t);if(!(J.noCloneChecked||1!==t.nodeType&&11!==t.nodeType||Z.isXMLDoc(t)))for(o=b(a),r=b(t),n=0,s=r.length;s>n;n++)y(r[n],o[n]);if(e)if(i)for(r=r||b(t),o=o||b(a),n=0,s=r.length;s>n;n++)g(r[n],o[n]);else g(t,a);return o=b(a,"script"),o.length>0&&m(o,!l&&b(t,"script")),a},buildFragment:function(t,e,i,n){for(var s,r,o,a,l,u,c=e.createDocumentFragment(),h=[],p=0,d=t.length;d>p;p++)if(s=t[p],s||0===s)if("object"===Z.type(s))Z.merge(h,s.nodeType?[s]:s);else if(Pt.test(s)){for(r=r||c.appendChild(e.createElement("div")),o=(kt.exec(s)||["",""])[1].toLowerCase(),a=Mt[o]||Mt._default,r.innerHTML=a[1]+s.replace(Ot,"<$1></$2>")+a[2],u=a[0];u--;)r=r.lastChild;Z.merge(h,r.childNodes),r=c.firstChild,r.textContent=""}else h.push(e.createTextNode(s));for(c.textContent="",p=0;s=h[p++];)if((!n||-1===Z.inArray(s,n))&&(l=Z.contains(s.ownerDocument,s),r=b(c.appendChild(s),"script"),l&&m(r),i))for(u=0;s=r[u++];)jt.test(s.type||"")&&i.push(s);return c},cleanData:function(t){for(var e,i,n,s,r=Z.event.special,o=0;void 0!==(i=t[o]);o++){if(Z.acceptData(i)&&(s=i[bt.expando],s&&(e=bt.cache[s]))){if(e.events)for(n in e.events)r[n]?Z.event.remove(i,n):Z.removeEvent(i,n,e.handle);bt.cache[s]&&delete bt.cache[s]}delete yt.cache[i[yt.expando]]}}}),Z.fn.extend({text:function(t){return gt(this,function(t){return void 0===t?Z.text(this):this.empty().each(function(){(1===this.nodeType||11===this.nodeType||9===this.nodeType)&&(this.textContent=t)})},null,t,arguments.length)},append:function(){return this.domManip(arguments,function(t){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var e=p(this,t);e.appendChild(t)}})},prepend:function(){return this.domManip(arguments,function(t){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var e=p(this,t);e.insertBefore(t,e.firstChild)}})},before:function(){return this.domManip(arguments,function(t){this.parentNode&&this.parentNode.insertBefore(t,this)})},after:function(){return this.domManip(arguments,function(t){this.parentNode&&this.parentNode.insertBefore(t,this.nextSibling)})},remove:function(t,e){for(var i,n=t?Z.filter(t,this):this,s=0;null!=(i=n[s]);s++)e||1!==i.nodeType||Z.cleanData(b(i)),i.parentNode&&(e&&Z.contains(i.ownerDocument,i)&&m(b(i,"script")),i.parentNode.removeChild(i));return this},empty:function(){for(var t,e=0;null!=(t=this[e]);e++)1===t.nodeType&&(Z.cleanData(b(t,!1)),t.textContent="");return this},clone:function(t,e){return t=null==t?!1:t,e=null==e?t:e,this.map(function(){return Z.clone(this,t,e)})},html:function(t){return gt(this,function(t){var e=this[0]||{},i=0,n=this.length;if(void 0===t&&1===e.nodeType)return e.innerHTML;if("string"==typeof t&&!Dt.test(t)&&!Mt[(kt.exec(t)||["",""])[1].toLowerCase()]){t=t.replace(Ot,"<$1></$2>");try{for(;n>i;i++)e=this[i]||{},1===e.nodeType&&(Z.cleanData(b(e,!1)),e.innerHTML=t);e=0}catch(s){}}e&&this.empty().append(t)},null,t,arguments.length)},replaceWith:function(){var t=arguments[0];return this.domManip(arguments,function(e){t=this.parentNode,Z.cleanData(b(this)),t&&t.replaceChild(e,this)}),t&&(t.length||t.nodeType)?this:this.remove()},detach:function(t){return this.remove(t,!0)},domManip:function(t,e){t=z.apply([],t);var i,n,s,r,o,a,l=0,u=this.length,c=this,h=u-1,p=t[0],m=Z.isFunction(p);if(m||u>1&&"string"==typeof p&&!J.checkClone&&Rt.test(p))return this.each(function(i){var n=c.eq(i);m&&(t[0]=p.call(this,i,n.html())),n.domManip(t,e)});if(u&&(i=Z.buildFragment(t,this[0].ownerDocument,!1,this),n=i.firstChild,1===i.childNodes.length&&(i=n),n)){for(s=Z.map(b(i,"script"),d),r=s.length;u>l;l++)o=i,l!==h&&(o=Z.clone(o,!0,!0),r&&Z.merge(s,b(o,"script"))),e.call(this[l],o,l);if(r)for(a=s[s.length-1].ownerDocument,Z.map(s,f),l=0;r>l;l++)o=s[l],jt.test(o.type||"")&&!bt.access(o,"globalEval")&&Z.contains(a,o)&&(o.src?Z._evalUrl&&Z._evalUrl(o.src):Z.globalEval(o.textContent.replace(Ft,"")))}return this}}),Z.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(t,e){Z.fn[t]=function(t){for(var i,n=[],s=Z(t),r=s.length-1,o=0;r>=o;o++)i=o===r?this:this.clone(!0),Z(s[o])[e](i),V.apply(n,i.get());return this.pushStack(n)}});var qt,Bt={},Ut=/^margin/,$t=new RegExp("^("+xt+")(?!px)[a-z%]+$","i"),Ht=function(e){return e.ownerDocument.defaultView.opener?e.ownerDocument.defaultView.getComputedStyle(e,null):t.getComputedStyle(e,null)};!function(){function e(){o.style.cssText="-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;display:block;margin-top:1%;top:1%;border:1px;padding:1px;width:4px;position:absolute",o.innerHTML="",s.appendChild(r);var e=t.getComputedStyle(o,null);i="1%"!==e.top,n="4px"===e.width,s.removeChild(r)}var i,n,s=Q.documentElement,r=Q.createElement("div"),o=Q.createElement("div");o.style&&(o.style.backgroundClip="content-box",o.cloneNode(!0).style.backgroundClip="",J.clearCloneStyle="content-box"===o.style.backgroundClip,r.style.cssText="border:0;width:0;height:0;top:0;left:-9999px;margin-top:1px;position:absolute",r.appendChild(o),t.getComputedStyle&&Z.extend(J,{pixelPosition:function(){return e(),i},boxSizingReliable:function(){return null==n&&e(),n},reliableMarginRight:function(){var e,i=o.appendChild(Q.createElement("div"));return i.style.cssText=o.style.cssText="-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box;display:block;margin:0;border:0;padding:0",i.style.marginRight=i.style.width="0",o.style.width="1px",s.appendChild(r),e=!parseFloat(t.getComputedStyle(i,null).marginRight),s.removeChild(r),o.removeChild(i),e}}))}(),Z.swap=function(t,e,i,n){var s,r,o={};for(r in e)o[r]=t.style[r],t.style[r]=e[r];s=i.apply(t,n||[]);for(r in e)t.style[r]=o[r];return s};var zt=/^(none|table(?!-c[ea]).+)/,Vt=new RegExp("^("+xt+")(.*)$","i"),Gt=new RegExp("^([+-])=("+xt+")","i"),Wt={position:"absolute",visibility:"hidden",display:"block"},Xt={letterSpacing:"0",fontWeight:"400"},Kt=["Webkit","O","Moz","ms"];Z.extend({cssHooks:{opacity:{get:function(t,e){if(e){var i=x(t,"opacity");return""===i?"1":i}}}},cssNumber:{columnCount:!0,fillOpacity:!0,flexGrow:!0,flexShrink:!0,fontWeight:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{"float":"cssFloat"},style:function(t,e,i,n){if(t&&3!==t.nodeType&&8!==t.nodeType&&t.style){var s,r,o,a=Z.camelCase(e),l=t.style;return e=Z.cssProps[a]||(Z.cssProps[a]=w(l,a)),o=Z.cssHooks[e]||Z.cssHooks[a],void 0===i?o&&"get"in o&&void 0!==(s=o.get(t,!1,n))?s:l[e]:(r=typeof i,"string"===r&&(s=Gt.exec(i))&&(i=(s[1]+1)*s[2]+parseFloat(Z.css(t,e)),r="number"),null!=i&&i===i&&("number"!==r||Z.cssNumber[a]||(i+="px"),J.clearCloneStyle||""!==i||0!==e.indexOf("background")||(l[e]="inherit"),o&&"set"in o&&void 0===(i=o.set(t,i,n))||(l[e]=i)),void 0)}},css:function(t,e,i,n){var s,r,o,a=Z.camelCase(e);return e=Z.cssProps[a]||(Z.cssProps[a]=w(t.style,a)),o=Z.cssHooks[e]||Z.cssHooks[a],o&&"get"in o&&(s=o.get(t,!0,i)),void 0===s&&(s=x(t,e,n)),"normal"===s&&e in Xt&&(s=Xt[e]),""===i||i?(r=parseFloat(s),i===!0||Z.isNumeric(r)?r||0:s):s}}),Z.each(["height","width"],function(t,e){Z.cssHooks[e]={get:function(t,i,n){return i?zt.test(Z.css(t,"display"))&&0===t.offsetWidth?Z.swap(t,Wt,function(){return E(t,e,n)}):E(t,e,n):void 0},set:function(t,i,n){var s=n&&Ht(t);return S(t,i,n?T(t,e,n,"border-box"===Z.css(t,"boxSizing",!1,s),s):0)}}}),Z.cssHooks.marginRight=C(J.reliableMarginRight,function(t,e){return e?Z.swap(t,{display:"inline-block"},x,[t,"marginRight"]):void 0}),Z.each({margin:"",padding:"",border:"Width"},function(t,e){Z.cssHooks[t+e]={expand:function(i){for(var n=0,s={},r="string"==typeof i?i.split(" "):[i];4>n;n++)s[t+Ct[n]+e]=r[n]||r[n-2]||r[0];return s}},Ut.test(t)||(Z.cssHooks[t+e].set=S)}),Z.fn.extend({css:function(t,e){return gt(this,function(t,e,i){var n,s,r={},o=0;if(Z.isArray(e)){for(n=Ht(t),s=e.length;s>o;o++)r[e[o]]=Z.css(t,e[o],!1,n);return r}return void 0!==i?Z.style(t,e,i):Z.css(t,e)},t,e,arguments.length>1)},show:function(){return I(this,!0)},hide:function(){return I(this)},toggle:function(t){return"boolean"==typeof t?t?this.show():this.hide():this.each(function(){wt(this)?Z(this).show():Z(this).hide()})}}),Z.Tween=N,N.prototype={constructor:N,init:function(t,e,i,n,s,r){this.elem=t,this.prop=i,this.easing=s||"swing",this.options=e,this.start=this.now=this.cur(),this.end=n,this.unit=r||(Z.cssNumber[i]?"":"px")},cur:function(){var t=N.propHooks[this.prop];return t&&t.get?t.get(this):N.propHooks._default.get(this)},run:function(t){var e,i=N.propHooks[this.prop];return this.options.duration?this.pos=e=Z.easing[this.easing](t,this.options.duration*t,0,1,this.options.duration):this.pos=e=t,this.now=(this.end-this.start)*e+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),i&&i.set?i.set(this):N.propHooks._default.set(this),this}},N.prototype.init.prototype=N.prototype,N.propHooks={_default:{get:function(t){var e;return null==t.elem[t.prop]||t.elem.style&&null!=t.elem.style[t.prop]?(e=Z.css(t.elem,t.prop,""),e&&"auto"!==e?e:0):t.elem[t.prop]},set:function(t){Z.fx.step[t.prop]?Z.fx.step[t.prop](t):t.elem.style&&(null!=t.elem.style[Z.cssProps[t.prop]]||Z.cssHooks[t.prop])?Z.style(t.elem,t.prop,t.now+t.unit):t.elem[t.prop]=t.now}}},N.propHooks.scrollTop=N.propHooks.scrollLeft={set:function(t){t.elem.nodeType&&t.elem.parentNode&&(t.elem[t.prop]=t.now)}},Z.easing={linear:function(t){return t},swing:function(t){return.5-Math.cos(t*Math.PI)/2}},Z.fx=N.prototype.init,Z.fx.step={};var Jt,Qt,Yt=/^(?:toggle|show|hide)$/,Zt=new RegExp("^(?:([+-])=|)("+xt+")([a-z%]*)$","i"),te=/queueHooks$/,ee=[P],ie={"*":[function(t,e){var i=this.createTween(t,e),n=i.cur(),s=Zt.exec(e),r=s&&s[3]||(Z.cssNumber[t]?"":"px"),o=(Z.cssNumber[t]||"px"!==r&&+n)&&Zt.exec(Z.css(i.elem,t)),a=1,l=20;if(o&&o[3]!==r){r=r||o[3],s=s||[],o=+n||1;do a=a||".5",o/=a,Z.style(i.elem,t,o+r);while(a!==(a=i.cur()/n)&&1!==a&&--l)}return s&&(o=i.start=+o||+n||0,i.unit=r,i.end=s[1]?o+(s[1]+1)*s[2]:+s[2]),i}]};Z.Animation=Z.extend(R,{tweener:function(t,e){Z.isFunction(t)?(e=t,t=["*"]):t=t.split(" ");for(var i,n=0,s=t.length;s>n;n++)i=t[n],ie[i]=ie[i]||[],ie[i].unshift(e)},prefilter:function(t,e){e?ee.unshift(t):ee.push(t)}}),Z.speed=function(t,e,i){var n=t&&"object"==typeof t?Z.extend({},t):{complete:i||!i&&e||Z.isFunction(t)&&t,duration:t,easing:i&&e||e&&!Z.isFunction(e)&&e};return n.duration=Z.fx.off?0:"number"==typeof n.duration?n.duration:n.duration in Z.fx.speeds?Z.fx.speeds[n.duration]:Z.fx.speeds._default,(null==n.queue||n.queue===!0)&&(n.queue="fx"),n.old=n.complete,n.complete=function(){Z.isFunction(n.old)&&n.old.call(this),n.queue&&Z.dequeue(this,n.queue)},n},Z.fn.extend({fadeTo:function(t,e,i,n){return this.filter(wt).css("opacity",0).show().end().animate({opacity:e},t,i,n)},animate:function(t,e,i,n){var s=Z.isEmptyObject(t),r=Z.speed(e,i,n),o=function(){var e=R(this,Z.extend({},t),r);(s||bt.get(this,"finish"))&&e.stop(!0)};return o.finish=o,s||r.queue===!1?this.each(o):this.queue(r.queue,o)},stop:function(t,e,i){var n=function(t){var e=t.stop;delete t.stop,e(i)};return"string"!=typeof t&&(i=e,e=t,t=void 0),e&&t!==!1&&this.queue(t||"fx",[]),this.each(function(){var e=!0,s=null!=t&&t+"queueHooks",r=Z.timers,o=bt.get(this);if(s)o[s]&&o[s].stop&&n(o[s]);else for(s in o)o[s]&&o[s].stop&&te.test(s)&&n(o[s]);for(s=r.length;s--;)r[s].elem!==this||null!=t&&r[s].queue!==t||(r[s].anim.stop(i),e=!1,r.splice(s,1));(e||!i)&&Z.dequeue(this,t)})},finish:function(t){return t!==!1&&(t=t||"fx"),this.each(function(){var e,i=bt.get(this),n=i[t+"queue"],s=i[t+"queueHooks"],r=Z.timers,o=n?n.length:0;for(i.finish=!0,Z.queue(this,t,[]),s&&s.stop&&s.stop.call(this,!0),e=r.length;e--;)r[e].elem===this&&r[e].queue===t&&(r[e].anim.stop(!0),r.splice(e,1));for(e=0;o>e;e++)n[e]&&n[e].finish&&n[e].finish.call(this);delete i.finish})}}),Z.each(["toggle","show","hide"],function(t,e){var i=Z.fn[e];Z.fn[e]=function(t,n,s){return null==t||"boolean"==typeof t?i.apply(this,arguments):this.animate(O(e,!0),t,n,s)}}),Z.each({slideDown:O("show"),slideUp:O("hide"),slideToggle:O("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(t,e){Z.fn[t]=function(t,i,n){return this.animate(e,t,i,n)}}),Z.timers=[],Z.fx.tick=function(){var t,e=0,i=Z.timers;for(Jt=Z.now();e<i.length;e++)t=i[e],t()||i[e]!==t||i.splice(e--,1);i.length||Z.fx.stop(),Jt=void 0},Z.fx.timer=function(t){Z.timers.push(t),t()?Z.fx.start():Z.timers.pop()},Z.fx.interval=13,Z.fx.start=function(){Qt||(Qt=setInterval(Z.fx.tick,Z.fx.interval))},Z.fx.stop=function(){clearInterval(Qt),Qt=null},Z.fx.speeds={slow:600,fast:200,_default:400},Z.fn.delay=function(t,e){return t=Z.fx?Z.fx.speeds[t]||t:t,e=e||"fx",this.queue(e,function(e,i){var n=setTimeout(e,t);i.stop=function(){clearTimeout(n)}})},function(){var t=Q.createElement("input"),e=Q.createElement("select"),i=e.appendChild(Q.createElement("option"));t.type="checkbox",J.checkOn=""!==t.value,J.optSelected=i.selected,e.disabled=!0,J.optDisabled=!i.disabled,t=Q.createElement("input"),t.value="t",t.type="radio",J.radioValue="t"===t.value}();var ne,se,re=Z.expr.attrHandle;Z.fn.extend({attr:function(t,e){return gt(this,Z.attr,t,e,arguments.length>1)},removeAttr:function(t){return this.each(function(){Z.removeAttr(this,t)})}}),Z.extend({attr:function(t,e,i){var n,s,r=t.nodeType;if(t&&3!==r&&8!==r&&2!==r)return typeof t.getAttribute===Tt?Z.prop(t,e,i):(1===r&&Z.isXMLDoc(t)||(e=e.toLowerCase(),n=Z.attrHooks[e]||(Z.expr.match.bool.test(e)?se:ne)),void 0===i?n&&"get"in n&&null!==(s=n.get(t,e))?s:(s=Z.find.attr(t,e),null==s?void 0:s):null!==i?n&&"set"in n&&void 0!==(s=n.set(t,i,e))?s:(t.setAttribute(e,i+""),i):void Z.removeAttr(t,e))},removeAttr:function(t,e){var i,n,s=0,r=e&&e.match(dt);if(r&&1===t.nodeType)for(;i=r[s++];)n=Z.propFix[i]||i,Z.expr.match.bool.test(i)&&(t[n]=!1),t.removeAttribute(i)},attrHooks:{type:{set:function(t,e){if(!J.radioValue&&"radio"===e&&Z.nodeName(t,"input")){var i=t.value;return t.setAttribute("type",e),i&&(t.value=i),e}}}}}),se={set:function(t,e,i){return e===!1?Z.removeAttr(t,i):t.setAttribute(i,i),i}},Z.each(Z.expr.match.bool.source.match(/\w+/g),function(t,e){var i=re[e]||Z.find.attr;re[e]=function(t,e,n){var s,r;return n||(r=re[e],re[e]=s,s=null!=i(t,e,n)?e.toLowerCase():null,re[e]=r),s}});var oe=/^(?:input|select|textarea|button)$/i;Z.fn.extend({prop:function(t,e){return gt(this,Z.prop,t,e,arguments.length>1)},removeProp:function(t){return this.each(function(){delete this[Z.propFix[t]||t]})}}),Z.extend({propFix:{"for":"htmlFor","class":"className"},prop:function(t,e,i){var n,s,r,o=t.nodeType;if(t&&3!==o&&8!==o&&2!==o)return r=1!==o||!Z.isXMLDoc(t),r&&(e=Z.propFix[e]||e,s=Z.propHooks[e]),void 0!==i?s&&"set"in s&&void 0!==(n=s.set(t,i,e))?n:t[e]=i:s&&"get"in s&&null!==(n=s.get(t,e))?n:t[e]},propHooks:{tabIndex:{get:function(t){return t.hasAttribute("tabindex")||oe.test(t.nodeName)||t.href?t.tabIndex:-1}}}}),J.optSelected||(Z.propHooks.selected={get:function(t){var e=t.parentNode;return e&&e.parentNode&&e.parentNode.selectedIndex,null}}),Z.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){Z.propFix[this.toLowerCase()]=this});var ae=/[\t\r\n\f]/g;Z.fn.extend({addClass:function(t){var e,i,n,s,r,o,a="string"==typeof t&&t,l=0,u=this.length;if(Z.isFunction(t))return this.each(function(e){Z(this).addClass(t.call(this,e,this.className))});if(a)for(e=(t||"").match(dt)||[];u>l;l++)if(i=this[l],n=1===i.nodeType&&(i.className?(" "+i.className+" ").replace(ae," "):" ")){for(r=0;s=e[r++];)n.indexOf(" "+s+" ")<0&&(n+=s+" ");o=Z.trim(n),i.className!==o&&(i.className=o)}return this},removeClass:function(t){var e,i,n,s,r,o,a=0===arguments.length||"string"==typeof t&&t,l=0,u=this.length;if(Z.isFunction(t))return this.each(function(e){Z(this).removeClass(t.call(this,e,this.className))});if(a)for(e=(t||"").match(dt)||[];u>l;l++)if(i=this[l],n=1===i.nodeType&&(i.className?(" "+i.className+" ").replace(ae," "):"")){for(r=0;s=e[r++];)for(;n.indexOf(" "+s+" ")>=0;)n=n.replace(" "+s+" "," ");o=t?Z.trim(n):"",i.className!==o&&(i.className=o)}return this},toggleClass:function(t,e){var i=typeof t;return"boolean"==typeof e&&"string"===i?e?this.addClass(t):this.removeClass(t):Z.isFunction(t)?this.each(function(i){Z(this).toggleClass(t.call(this,i,this.className,e),e)}):this.each(function(){if("string"===i)for(var e,n=0,s=Z(this),r=t.match(dt)||[];e=r[n++];)s.hasClass(e)?s.removeClass(e):s.addClass(e);else(i===Tt||"boolean"===i)&&(this.className&&bt.set(this,"__className__",this.className),this.className=this.className||t===!1?"":bt.get(this,"__className__")||"")})},hasClass:function(t){for(var e=" "+t+" ",i=0,n=this.length;n>i;i++)if(1===this[i].nodeType&&(" "+this[i].className+" ").replace(ae," ").indexOf(e)>=0)return!0;return!1}});var le=/\r/g;Z.fn.extend({val:function(t){var e,i,n,s=this[0];{if(arguments.length)return n=Z.isFunction(t),this.each(function(i){var s;1===this.nodeType&&(s=n?t.call(this,i,Z(this).val()):t,null==s?s="":"number"==typeof s?s+="":Z.isArray(s)&&(s=Z.map(s,function(t){return null==t?"":t+""})),e=Z.valHooks[this.type]||Z.valHooks[this.nodeName.toLowerCase()],e&&"set"in e&&void 0!==e.set(this,s,"value")||(this.value=s))});if(s)return e=Z.valHooks[s.type]||Z.valHooks[s.nodeName.toLowerCase()],e&&"get"in e&&void 0!==(i=e.get(s,"value"))?i:(i=s.value,"string"==typeof i?i.replace(le,""):null==i?"":i)}}}),Z.extend({valHooks:{option:{get:function(t){var e=Z.find.attr(t,"value");return null!=e?e:Z.trim(Z.text(t))}},select:{get:function(t){for(var e,i,n=t.options,s=t.selectedIndex,r="select-one"===t.type||0>s,o=r?null:[],a=r?s+1:n.length,l=0>s?a:r?s:0;a>l;l++)if(i=n[l],(i.selected||l===s)&&(J.optDisabled?!i.disabled:null===i.getAttribute("disabled"))&&(!i.parentNode.disabled||!Z.nodeName(i.parentNode,"optgroup"))){if(e=Z(i).val(),r)return e;o.push(e)}return o},set:function(t,e){for(var i,n,s=t.options,r=Z.makeArray(e),o=s.length;o--;)n=s[o],(n.selected=Z.inArray(n.value,r)>=0)&&(i=!0);return i||(t.selectedIndex=-1),r}}}}),Z.each(["radio","checkbox"],function(){Z.valHooks[this]={set:function(t,e){return Z.isArray(e)?t.checked=Z.inArray(Z(t).val(),e)>=0:void 0}},J.checkOn||(Z.valHooks[this].get=function(t){return null===t.getAttribute("value")?"on":t.value})}),Z.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error contextmenu".split(" "),function(t,e){Z.fn[e]=function(t,i){return arguments.length>0?this.on(e,null,t,i):this.trigger(e)}}),Z.fn.extend({hover:function(t,e){return this.mouseenter(t).mouseleave(e||t)},bind:function(t,e,i){return this.on(t,null,e,i)},unbind:function(t,e){return this.off(t,null,e)},delegate:function(t,e,i,n){return this.on(e,t,i,n)},undelegate:function(t,e,i){return 1===arguments.length?this.off(t,"**"):this.off(e,t||"**",i)}});var ue=Z.now(),ce=/\?/;Z.parseJSON=function(t){return JSON.parse(t+"")},Z.parseXML=function(t){var e,i;if(!t||"string"!=typeof t)return null;try{i=new DOMParser,e=i.parseFromString(t,"text/xml")}catch(n){e=void 0}return(!e||e.getElementsByTagName("parsererror").length)&&Z.error("Invalid XML: "+t),e};var he=/#.*$/,pe=/([?&])_=[^&]*/,de=/^(.*?):[ \t]*([^\r\n]*)$/gm,fe=/^(?:about|app|app-storage|.+-extension|file|res|widget):$/,me=/^(?:GET|HEAD)$/,ge=/^\/\//,be=/^([\w.+-]+:)(?:\/\/(?:[^\/?#]*@|)([^\/?#:]*)(?::(\d+)|)|)/,ye={},ve={},_e="*/".concat("*"),xe=t.location.href,Ce=be.exec(xe.toLowerCase())||[];Z.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:xe,type:"GET",isLocal:fe.test(Ce[1]),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":_e,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/xml/,html:/html/,json:/json/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":Z.parseJSON,"text xml":Z.parseXML},flatOptions:{url:!0,context:!0}},
ajaxSetup:function(t,e){return e?F(F(t,Z.ajaxSettings),e):F(Z.ajaxSettings,t)},ajaxPrefilter:j(ye),ajaxTransport:j(ve),ajax:function(t,e){function i(t,e,i,o){var l,c,b,y,_,C=e;2!==v&&(v=2,a&&clearTimeout(a),n=void 0,r=o||"",x.readyState=t>0?4:0,l=t>=200&&300>t||304===t,i&&(y=M(h,x,i)),y=q(h,y,x,l),l?(h.ifModified&&(_=x.getResponseHeader("Last-Modified"),_&&(Z.lastModified[s]=_),_=x.getResponseHeader("etag"),_&&(Z.etag[s]=_)),204===t||"HEAD"===h.type?C="nocontent":304===t?C="notmodified":(C=y.state,c=y.data,b=y.error,l=!b)):(b=C,(t||!C)&&(C="error",0>t&&(t=0))),x.status=t,x.statusText=(e||C)+"",l?f.resolveWith(p,[c,C,x]):f.rejectWith(p,[x,C,b]),x.statusCode(g),g=void 0,u&&d.trigger(l?"ajaxSuccess":"ajaxError",[x,h,l?c:b]),m.fireWith(p,[x,C]),u&&(d.trigger("ajaxComplete",[x,h]),--Z.active||Z.event.trigger("ajaxStop")))}"object"==typeof t&&(e=t,t=void 0),e=e||{};var n,s,r,o,a,l,u,c,h=Z.ajaxSetup({},e),p=h.context||h,d=h.context&&(p.nodeType||p.jquery)?Z(p):Z.event,f=Z.Deferred(),m=Z.Callbacks("once memory"),g=h.statusCode||{},b={},y={},v=0,_="canceled",x={readyState:0,getResponseHeader:function(t){var e;if(2===v){if(!o)for(o={};e=de.exec(r);)o[e[1].toLowerCase()]=e[2];e=o[t.toLowerCase()]}return null==e?null:e},getAllResponseHeaders:function(){return 2===v?r:null},setRequestHeader:function(t,e){var i=t.toLowerCase();return v||(t=y[i]=y[i]||t,b[t]=e),this},overrideMimeType:function(t){return v||(h.mimeType=t),this},statusCode:function(t){var e;if(t)if(2>v)for(e in t)g[e]=[g[e],t[e]];else x.always(t[x.status]);return this},abort:function(t){var e=t||_;return n&&n.abort(e),i(0,e),this}};if(f.promise(x).complete=m.add,x.success=x.done,x.error=x.fail,h.url=((t||h.url||xe)+"").replace(he,"").replace(ge,Ce[1]+"//"),h.type=e.method||e.type||h.method||h.type,h.dataTypes=Z.trim(h.dataType||"*").toLowerCase().match(dt)||[""],null==h.crossDomain&&(l=be.exec(h.url.toLowerCase()),h.crossDomain=!(!l||l[1]===Ce[1]&&l[2]===Ce[2]&&(l[3]||("http:"===l[1]?"80":"443"))===(Ce[3]||("http:"===Ce[1]?"80":"443")))),h.data&&h.processData&&"string"!=typeof h.data&&(h.data=Z.param(h.data,h.traditional)),L(ye,h,e,x),2===v)return x;u=Z.event&&h.global,u&&0===Z.active++&&Z.event.trigger("ajaxStart"),h.type=h.type.toUpperCase(),h.hasContent=!me.test(h.type),s=h.url,h.hasContent||(h.data&&(s=h.url+=(ce.test(s)?"&":"?")+h.data,delete h.data),h.cache===!1&&(h.url=pe.test(s)?s.replace(pe,"$1_="+ue++):s+(ce.test(s)?"&":"?")+"_="+ue++)),h.ifModified&&(Z.lastModified[s]&&x.setRequestHeader("If-Modified-Since",Z.lastModified[s]),Z.etag[s]&&x.setRequestHeader("If-None-Match",Z.etag[s])),(h.data&&h.hasContent&&h.contentType!==!1||e.contentType)&&x.setRequestHeader("Content-Type",h.contentType),x.setRequestHeader("Accept",h.dataTypes[0]&&h.accepts[h.dataTypes[0]]?h.accepts[h.dataTypes[0]]+("*"!==h.dataTypes[0]?", "+_e+"; q=0.01":""):h.accepts["*"]);for(c in h.headers)x.setRequestHeader(c,h.headers[c]);if(h.beforeSend&&(h.beforeSend.call(p,x,h)===!1||2===v))return x.abort();_="abort";for(c in{success:1,error:1,complete:1})x[c](h[c]);if(n=L(ve,h,e,x)){x.readyState=1,u&&d.trigger("ajaxSend",[x,h]),h.async&&h.timeout>0&&(a=setTimeout(function(){x.abort("timeout")},h.timeout));try{v=1,n.send(b,i)}catch(C){if(!(2>v))throw C;i(-1,C)}}else i(-1,"No Transport");return x},getJSON:function(t,e,i){return Z.get(t,e,i,"json")},getScript:function(t,e){return Z.get(t,void 0,e,"script")}}),Z.each(["get","post"],function(t,e){Z[e]=function(t,i,n,s){return Z.isFunction(i)&&(s=s||n,n=i,i=void 0),Z.ajax({url:t,type:e,dataType:s,data:i,success:n})}}),Z._evalUrl=function(t){return Z.ajax({url:t,type:"GET",dataType:"script",async:!1,global:!1,"throws":!0})},Z.fn.extend({wrapAll:function(t){var e;return Z.isFunction(t)?this.each(function(e){Z(this).wrapAll(t.call(this,e))}):(this[0]&&(e=Z(t,this[0].ownerDocument).eq(0).clone(!0),this[0].parentNode&&e.insertBefore(this[0]),e.map(function(){for(var t=this;t.firstElementChild;)t=t.firstElementChild;return t}).append(this)),this)},wrapInner:function(t){return Z.isFunction(t)?this.each(function(e){Z(this).wrapInner(t.call(this,e))}):this.each(function(){var e=Z(this),i=e.contents();i.length?i.wrapAll(t):e.append(t)})},wrap:function(t){var e=Z.isFunction(t);return this.each(function(i){Z(this).wrapAll(e?t.call(this,i):t)})},unwrap:function(){return this.parent().each(function(){Z.nodeName(this,"body")||Z(this).replaceWith(this.childNodes)}).end()}}),Z.expr.filters.hidden=function(t){return t.offsetWidth<=0&&t.offsetHeight<=0},Z.expr.filters.visible=function(t){return!Z.expr.filters.hidden(t)};var we=/%20/g,Se=/\[\]$/,Te=/\r?\n/g,Ee=/^(?:submit|button|image|reset|file)$/i,Ie=/^(?:input|select|textarea|keygen)/i;Z.param=function(t,e){var i,n=[],s=function(t,e){e=Z.isFunction(e)?e():null==e?"":e,n[n.length]=encodeURIComponent(t)+"="+encodeURIComponent(e)};if(void 0===e&&(e=Z.ajaxSettings&&Z.ajaxSettings.traditional),Z.isArray(t)||t.jquery&&!Z.isPlainObject(t))Z.each(t,function(){s(this.name,this.value)});else for(i in t)B(i,t[i],e,s);return n.join("&").replace(we,"+")},Z.fn.extend({serialize:function(){return Z.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var t=Z.prop(this,"elements");return t?Z.makeArray(t):this}).filter(function(){var t=this.type;return this.name&&!Z(this).is(":disabled")&&Ie.test(this.nodeName)&&!Ee.test(t)&&(this.checked||!St.test(t))}).map(function(t,e){var i=Z(this).val();return null==i?null:Z.isArray(i)?Z.map(i,function(t){return{name:e.name,value:t.replace(Te,"\r\n")}}):{name:e.name,value:i.replace(Te,"\r\n")}}).get()}}),Z.ajaxSettings.xhr=function(){try{return new XMLHttpRequest}catch(t){}};var Ne=0,Ae={},Oe={0:200,1223:204},ke=Z.ajaxSettings.xhr();t.attachEvent&&t.attachEvent("onunload",function(){for(var t in Ae)Ae[t]()}),J.cors=!!ke&&"withCredentials"in ke,J.ajax=ke=!!ke,Z.ajaxTransport(function(t){var e;return J.cors||ke&&!t.crossDomain?{send:function(i,n){var s,r=t.xhr(),o=++Ne;if(r.open(t.type,t.url,t.async,t.username,t.password),t.xhrFields)for(s in t.xhrFields)r[s]=t.xhrFields[s];t.mimeType&&r.overrideMimeType&&r.overrideMimeType(t.mimeType),t.crossDomain||i["X-Requested-With"]||(i["X-Requested-With"]="XMLHttpRequest");for(s in i)r.setRequestHeader(s,i[s]);e=function(t){return function(){e&&(delete Ae[o],e=r.onload=r.onerror=null,"abort"===t?r.abort():"error"===t?n(r.status,r.statusText):n(Oe[r.status]||r.status,r.statusText,"string"==typeof r.responseText?{text:r.responseText}:void 0,r.getAllResponseHeaders()))}},r.onload=e(),r.onerror=e("error"),e=Ae[o]=e("abort");try{r.send(t.hasContent&&t.data||null)}catch(a){if(e)throw a}},abort:function(){e&&e()}}:void 0}),Z.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/(?:java|ecma)script/},converters:{"text script":function(t){return Z.globalEval(t),t}}}),Z.ajaxPrefilter("script",function(t){void 0===t.cache&&(t.cache=!1),t.crossDomain&&(t.type="GET")}),Z.ajaxTransport("script",function(t){if(t.crossDomain){var e,i;return{send:function(n,s){e=Z("<script>").prop({async:!0,charset:t.scriptCharset,src:t.url}).on("load error",i=function(t){e.remove(),i=null,t&&s("error"===t.type?404:200,t.type)}),Q.head.appendChild(e[0])},abort:function(){i&&i()}}}});var Pe=[],De=/(=)\?(?=&|$)|\?\?/;Z.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var t=Pe.pop()||Z.expando+"_"+ue++;return this[t]=!0,t}}),Z.ajaxPrefilter("json jsonp",function(e,i,n){var s,r,o,a=e.jsonp!==!1&&(De.test(e.url)?"url":"string"==typeof e.data&&!(e.contentType||"").indexOf("application/x-www-form-urlencoded")&&De.test(e.data)&&"data");return a||"jsonp"===e.dataTypes[0]?(s=e.jsonpCallback=Z.isFunction(e.jsonpCallback)?e.jsonpCallback():e.jsonpCallback,a?e[a]=e[a].replace(De,"$1"+s):e.jsonp!==!1&&(e.url+=(ce.test(e.url)?"&":"?")+e.jsonp+"="+s),e.converters["script json"]=function(){return o||Z.error(s+" was not called"),o[0]},e.dataTypes[0]="json",r=t[s],t[s]=function(){o=arguments},n.always(function(){t[s]=r,e[s]&&(e.jsonpCallback=i.jsonpCallback,Pe.push(s)),o&&Z.isFunction(r)&&r(o[0]),o=r=void 0}),"script"):void 0}),Z.parseHTML=function(t,e,i){if(!t||"string"!=typeof t)return null;"boolean"==typeof e&&(i=e,e=!1),e=e||Q;var n=ot.exec(t),s=!i&&[];return n?[e.createElement(n[1])]:(n=Z.buildFragment([t],e,s),s&&s.length&&Z(s).remove(),Z.merge([],n.childNodes))};var Re=Z.fn.load;Z.fn.load=function(t,e,i){if("string"!=typeof t&&Re)return Re.apply(this,arguments);var n,s,r,o=this,a=t.indexOf(" ");return a>=0&&(n=Z.trim(t.slice(a)),t=t.slice(0,a)),Z.isFunction(e)?(i=e,e=void 0):e&&"object"==typeof e&&(s="POST"),o.length>0&&Z.ajax({url:t,type:s,dataType:"html",data:e}).done(function(t){r=arguments,o.html(n?Z("<div>").append(Z.parseHTML(t)).find(n):t)}).complete(i&&function(t,e){o.each(i,r||[t.responseText,e,t])}),this},Z.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(t,e){Z.fn[e]=function(t){return this.on(e,t)}}),Z.expr.filters.animated=function(t){return Z.grep(Z.timers,function(e){return t===e.elem}).length};var je=t.document.documentElement;Z.offset={setOffset:function(t,e,i){var n,s,r,o,a,l,u,c=Z.css(t,"position"),h=Z(t),p={};"static"===c&&(t.style.position="relative"),a=h.offset(),r=Z.css(t,"top"),l=Z.css(t,"left"),u=("absolute"===c||"fixed"===c)&&(r+l).indexOf("auto")>-1,u?(n=h.position(),o=n.top,s=n.left):(o=parseFloat(r)||0,s=parseFloat(l)||0),Z.isFunction(e)&&(e=e.call(t,i,a)),null!=e.top&&(p.top=e.top-a.top+o),null!=e.left&&(p.left=e.left-a.left+s),"using"in e?e.using.call(t,p):h.css(p)}},Z.fn.extend({offset:function(t){if(arguments.length)return void 0===t?this:this.each(function(e){Z.offset.setOffset(this,t,e)});var e,i,n=this[0],s={top:0,left:0},r=n&&n.ownerDocument;if(r)return e=r.documentElement,Z.contains(e,n)?(typeof n.getBoundingClientRect!==Tt&&(s=n.getBoundingClientRect()),i=U(r),{top:s.top+i.pageYOffset-e.clientTop,left:s.left+i.pageXOffset-e.clientLeft}):s},position:function(){if(this[0]){var t,e,i=this[0],n={top:0,left:0};return"fixed"===Z.css(i,"position")?e=i.getBoundingClientRect():(t=this.offsetParent(),e=this.offset(),Z.nodeName(t[0],"html")||(n=t.offset()),n.top+=Z.css(t[0],"borderTopWidth",!0),n.left+=Z.css(t[0],"borderLeftWidth",!0)),{top:e.top-n.top-Z.css(i,"marginTop",!0),left:e.left-n.left-Z.css(i,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){for(var t=this.offsetParent||je;t&&!Z.nodeName(t,"html")&&"static"===Z.css(t,"position");)t=t.offsetParent;return t||je})}}),Z.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(e,i){var n="pageYOffset"===i;Z.fn[e]=function(s){return gt(this,function(e,s,r){var o=U(e);return void 0===r?o?o[i]:e[s]:void(o?o.scrollTo(n?t.pageXOffset:r,n?r:t.pageYOffset):e[s]=r)},e,s,arguments.length,null)}}),Z.each(["top","left"],function(t,e){Z.cssHooks[e]=C(J.pixelPosition,function(t,i){return i?(i=x(t,e),$t.test(i)?Z(t).position()[e]+"px":i):void 0})}),Z.each({Height:"height",Width:"width"},function(t,e){Z.each({padding:"inner"+t,content:e,"":"outer"+t},function(i,n){Z.fn[n]=function(n,s){var r=arguments.length&&(i||"boolean"!=typeof n),o=i||(n===!0||s===!0?"margin":"border");return gt(this,function(e,i,n){var s;return Z.isWindow(e)?e.document.documentElement["client"+t]:9===e.nodeType?(s=e.documentElement,Math.max(e.body["scroll"+t],s["scroll"+t],e.body["offset"+t],s["offset"+t],s["client"+t])):void 0===n?Z.css(e,i,o):Z.style(e,i,n,o)},e,r?n:void 0,r,null)}})}),Z.fn.size=function(){return this.length},Z.fn.andSelf=Z.fn.addBack,"function"==typeof define&&define.amd&&define("jquery",[],function(){return Z});var Le=t.jQuery,Fe=t.$;return Z.noConflict=function(e){return t.$===Z&&(t.$=Fe),e&&t.jQuery===Z&&(t.jQuery=Le),Z},typeof e===Tt&&(t.jQuery=t.$=Z),Z})},{}],112:[function(t,e,i){function n(t){for(var e=-1,i=t?t.length:0,n=-1,s=[];++e<i;){var r=t[e];r&&(s[++n]=r)}return s}e.exports=n},{}],113:[function(t,e,i){function n(t,e,i){var n=-1,r=t?t.length:0;for(e=s(e,i,3);++n<r;)if(e(t[n],n,t))return n;return-1}var s=t("../internal/baseCallback");e.exports=n},{"../internal/baseCallback":138}],114:[function(t,e,i){function n(t){return t?t[0]:void 0}e.exports=n},{}],115:[function(t,e,i){function n(){for(var t=[],e=-1,i=arguments.length,n=[],u=s,c=!0;++e<i;){var h=arguments[e];(l(h)||a(h))&&(t.push(h),n.push(c&&h.length>=120?o(e&&h):null))}i=t.length;var p=t[0],d=-1,f=p?p.length:0,m=[],g=n[0];t:for(;++d<f;)if(h=p[d],(g?r(g,h):u(m,h))<0){for(e=i;--e;){var b=n[e];if((b?r(b,h):u(t[e],h))<0)continue t}g&&g.push(h),m.push(h)}return m}var s=t("../internal/baseIndexOf"),r=t("../internal/cacheIndexOf"),o=t("../internal/createCache"),a=t("../lang/isArguments"),l=t("../lang/isArray");e.exports=n},{"../internal/baseIndexOf":152,"../internal/cacheIndexOf":169,"../internal/createCache":177,"../lang/isArguments":208,"../lang/isArray":209}],116:[function(t,e,i){function n(t){var e=t?t.length:0;return e?t[e-1]:void 0}e.exports=n},{}],117:[function(t,e,i){function n(){return r(s(arguments,!1,!0))}var s=t("../internal/baseFlatten"),r=t("../internal/baseUniq");e.exports=n},{"../internal/baseFlatten":148,"../internal/baseUniq":165}],118:[function(t,e,i){function n(t,e,i,n){var l=t?t.length:0;return l?(null!=e&&"boolean"!=typeof e&&(n=i,i=o(t,e,n)?null:e,e=!1),i=null==i?i:s(i,n,3),e?a(t,i):r(t,i)):[]}var s=t("../internal/baseCallback"),r=t("../internal/baseUniq"),o=t("../internal/isIterateeCall"),a=t("../internal/sortedUniq");e.exports=n},{"../internal/baseCallback":138,"../internal/baseUniq":165,"../internal/isIterateeCall":192,"../internal/sortedUniq":204}],119:[function(t,e,i){function n(t){return s(t,r(arguments,1))}var s=t("../internal/baseDifference"),r=t("../internal/baseSlice");e.exports=n},{"../internal/baseDifference":144,"../internal/baseSlice":162}],120:[function(t,e,i){function n(t,e,i){var n=a(t)?s:o;return e=r(e,i,3),n(t,e)}var s=t("../internal/arrayFilter"),r=t("../internal/baseCallback"),o=t("../internal/baseFilter"),a=t("../lang/isArray");e.exports=n},{"../internal/arrayFilter":135,"../internal/baseCallback":138,"../internal/baseFilter":146,"../lang/isArray":209}],121:[function(t,e,i){function n(t,e,i){if(l(t)){var n=a(t,e,i);return n>-1?t[n]:void 0}return e=s(e,i,3),o(t,e,r)}var s=t("../internal/baseCallback"),r=t("../internal/baseEach"),o=t("../internal/baseFind"),a=t("../array/findIndex"),l=t("../lang/isArray");e.exports=n},{"../array/findIndex":113,"../internal/baseCallback":138,"../internal/baseEach":145,"../internal/baseFind":147,"../lang/isArray":209}],122:[function(t,e,i){arguments[4][14][0].apply(i,arguments)},{"../internal/arrayEach":134,"../internal/baseEach":145,"../internal/bindCallback":167,"../lang/isArray":209,dup:14}],123:[function(t,e,i){function n(t,e,i){var n=t?t.length:0;return o(n)||(t=l(t),n=t.length),n?(i="number"==typeof i?0>i?u(n+i,0):i||0:0,"string"==typeof t||!r(t)&&a(t)?n>i&&t.indexOf(e,i)>-1:s(t,e,i)>-1):!1}var s=t("../internal/baseIndexOf"),r=t("../lang/isArray"),o=t("../internal/isLength"),a=t("../lang/isString"),l=t("../object/values"),u=Math.max;e.exports=n},{"../internal/baseIndexOf":152,"../internal/isLength":193,"../lang/isArray":209,"../lang/isString":217,"../object/values":224}],124:[function(t,e,i){var n=t("../internal/createAggregator"),s=n(function(t,e,i){t[i]=e});e.exports=s},{"../internal/createAggregator":174}],125:[function(t,e,i){arguments[4][15][0].apply(i,arguments)},{"../internal/arrayMap":136,"../internal/baseCallback":138,"../internal/baseMap":157,"../lang/isArray":209,dup:15}],126:[function(t,e,i){function n(t,e){return r(t,s(e))}var s=t("../internal/baseProperty"),r=t("./map");e.exports=n},{"../internal/baseProperty":160,"./map":125}],127:[function(t,e,i){function n(t,e,i){var n=-1,c=t?t.length:0,h=u(c)?Array(c):[];return i&&l(t,e,i)&&(e=null),e=s(e,i,3),r(t,function(t,i,s){h[++n]={criteria:e(t,i,s),index:n,value:t}}),o(h,a)}var s=t("../internal/baseCallback"),r=t("../internal/baseEach"),o=t("../internal/baseSortBy"),a=t("../internal/compareAscending"),l=t("../internal/isIterateeCall"),u=t("../internal/isLength");e.exports=n},{"../internal/baseCallback":138,"../internal/baseEach":145,"../internal/baseSortBy":163,"../internal/compareAscending":171,"../internal/isIterateeCall":192,"../internal/isLength":193}],128:[function(t,e,i){var n=t("../lang/isNative"),s=n(s=Date.now)&&s,r=s||function(){return(new Date).getTime()};e.exports=r},{"../lang/isNative":214}],129:[function(t,e,i){function n(t,e){var i=a;if(arguments.length>2){var u=s(arguments,2),c=o(u,n.placeholder);i|=l}return r(t,i,e,u,c)}var s=t("../internal/baseSlice"),r=t("../internal/createWrapper"),o=t("../internal/replaceHolders"),a=1,l=32;n.placeholder={},e.exports=n},{"../internal/baseSlice":162,"../internal/createWrapper":181,"../internal/replaceHolders":201}],130:[function(t,e,i){function n(t,e,i){function n(){g&&clearTimeout(g),p&&clearTimeout(p),p=g=b=void 0}function l(){var i=e-(r()-f);if(0>=i||i>e){p&&clearTimeout(p);var n=b;p=g=b=void 0,n&&(y=r(),d=t.apply(m,h),g||p||(h=m=null))}else g=setTimeout(l,i)}function u(){g&&clearTimeout(g),p=g=b=void 0,(_||v!==e)&&(y=r(),d=t.apply(m,h),g||p||(h=m=null))}function c(){if(h=arguments,f=r(),m=this,b=_&&(g||!x),v===!1)var i=x&&!g;else{p||x||(y=f);var n=v-(f-y),s=0>=n||n>v;s?(p&&(p=clearTimeout(p)),y=f,d=t.apply(m,h)):p||(p=setTimeout(u,n))}return s&&g?g=clearTimeout(g):g||e===v||(g=setTimeout(l,e)),i&&(s=!0,d=t.apply(m,h)),!s||g||p||(h=m=null),d}var h,p,d,f,m,g,b,y=0,v=!1,_=!0;if("function"!=typeof t)throw new TypeError(o);if(e=0>e?0:+e||0,i===!0){var x=!0;_=!1}else s(i)&&(x=i.leading,v="maxWait"in i&&a(+i.maxWait||0,e),_="trailing"in i?i.trailing:_);return c.cancel=n,c}var s=t("../lang/isObject"),r=t("../date/now"),o="Expected a function",a=Math.max;e.exports=n},{"../date/now":128,"../lang/isObject":216}],131:[function(t,e,i){function n(t,e){return s(t,e,arguments,2)}var s=t("../internal/baseDelay");e.exports=n},{"../internal/baseDelay":143}],132:[function(t,e,i){(function(i){function n(t){var e=t?t.length:0;for(this.data={hash:a(null),set:new o};e--;)this.push(t[e])}var s=t("./cachePush"),r=t("../lang/isNative"),o=r(o=i.Set)&&o,a=r(a=Object.create)&&a;n.prototype.push=s,e.exports=n}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../lang/isNative":214,"./cachePush":170}],133:[function(t,e,i){function n(t,e){var i=-1,n=t.length;for(e||(e=Array(n));++i<n;)e[i]=t[i];return e}e.exports=n},{}],134:[function(t,e,i){arguments[4][16][0].apply(i,arguments)},{dup:16}],135:[function(t,e,i){function n(t,e){for(var i=-1,n=t.length,s=-1,r=[];++i<n;){var o=t[i];e(o,i,t)&&(r[++s]=o)}return r}e.exports=n},{}],136:[function(t,e,i){arguments[4][17][0].apply(i,arguments)},{dup:17}],137:[function(t,e,i){function n(t,e,i){var n=r(e);if(!i)return s(e,t,n);for(var o=-1,a=n.length;++o<a;){var l=n[o],u=t[l],c=i(u,e[l],l,t,e);(c===c?c===u:u!==u)&&("undefined"!=typeof u||l in t)||(t[l]=c)}return t}var s=t("./baseCopy"),r=t("../object/keys");e.exports=n},{"../object/keys":221,"./baseCopy":141}],138:[function(t,e,i){arguments[4][18][0].apply(i,arguments)},{"../utility/identity":229,"./baseMatches":158,"./baseMatchesProperty":159,"./baseProperty":160,"./bindCallback":167,"./isBindable":190,dup:18}],139:[function(t,e,i){function n(t,e,i,m,g,b,y){var _;if(i&&(_=g?i(t,m,g):i(t)),"undefined"!=typeof _)return _;if(!p(t))return t;var x=h(t);if(x){if(_=l(t),!e)return s(t,_)}else{var w=q.call(t),S=w==v;if(w!=C&&w!=f&&(!S||g))return F[w]?u(t,w,e):g?t:{};if(_=c(S?{}:t),!e)return o(t,_,d(t))}b||(b=[]),y||(y=[]);for(var T=b.length;T--;)if(b[T]==t)return y[T];return b.push(t),y.push(_),(x?r:a)(t,function(s,r){_[r]=n(s,e,i,r,t,b,y)}),_}var s=t("./arrayCopy"),r=t("./arrayEach"),o=t("./baseCopy"),a=t("./baseForOwn"),l=t("./initCloneArray"),u=t("./initCloneByTag"),c=t("./initCloneObject"),h=t("../lang/isArray"),p=t("../lang/isObject"),d=t("../object/keys"),f="[object Arguments]",m="[object Array]",g="[object Boolean]",b="[object Date]",y="[object Error]",v="[object Function]",_="[object Map]",x="[object Number]",C="[object Object]",w="[object RegExp]",S="[object Set]",T="[object String]",E="[object WeakMap]",I="[object ArrayBuffer]",N="[object Float32Array]",A="[object Float64Array]",O="[object Int8Array]",k="[object Int16Array]",P="[object Int32Array]",D="[object Uint8Array]",R="[object Uint8ClampedArray]",j="[object Uint16Array]",L="[object Uint32Array]",F={};F[f]=F[m]=F[I]=F[g]=F[b]=F[N]=F[A]=F[O]=F[k]=F[P]=F[x]=F[C]=F[w]=F[T]=F[D]=F[R]=F[j]=F[L]=!0,F[y]=F[v]=F[_]=F[S]=F[E]=!1;var M=Object.prototype,q=M.toString;e.exports=n},{"../lang/isArray":209,"../lang/isObject":216,"../object/keys":221,"./arrayCopy":133,"./arrayEach":134,"./baseCopy":141,"./baseForOwn":151,"./initCloneArray":187,"./initCloneByTag":188,"./initCloneObject":189}],140:[function(t,e,i){function n(t,e){if(t!==e){var i=t===t,n=e===e;if(t>e||!i||"undefined"==typeof t&&n)return 1;if(e>t||!n||"undefined"==typeof e&&i)return-1}return 0}e.exports=n},{}],141:[function(t,e,i){function n(t,e,i){i||(i=e,e={});for(var n=-1,s=i.length;++n<s;){var r=i[n];e[r]=t[r]}return e}e.exports=n},{}],142:[function(t,e,i){(function(i){var n=t("../lang/isObject"),s=function(){function t(){}return function(e){if(n(e)){t.prototype=e;var s=new t;t.prototype=null}return s||i.Object()}}();e.exports=s}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../lang/isObject":216}],143:[function(t,e,i){function n(t,e,i,n){if("function"!=typeof t)throw new TypeError(r);return setTimeout(function(){t.apply(void 0,s(i,n))},e)}var s=t("./baseSlice"),r="Expected a function";e.exports=n},{"./baseSlice":162}],144:[function(t,e,i){function n(t,e){var i=t?t.length:0,n=[];if(!i)return n;var a=-1,l=s,u=!0,c=u&&e.length>=200?o(e):null,h=e.length;c&&(l=r,u=!1,e=c);t:for(;++a<i;){var p=t[a];if(u&&p===p){for(var d=h;d--;)if(e[d]===p)continue t;n.push(p)}else l(e,p)<0&&n.push(p)}return n}var s=t("./baseIndexOf"),r=t("./cacheIndexOf"),o=t("./createCache");e.exports=n},{"./baseIndexOf":152,"./cacheIndexOf":169,"./createCache":177}],145:[function(t,e,i){arguments[4][19][0].apply(i,arguments)},{"./baseForOwn":151,"./isLength":193,"./toObject":205,dup:19}],146:[function(t,e,i){function n(t,e){var i=[];return s(t,function(t,n,s){e(t,n,s)&&i.push(t)}),i}var s=t("./baseEach");e.exports=n},{"./baseEach":145}],147:[function(t,e,i){function n(t,e,i,n){var s;return i(t,function(t,i,r){return e(t,i,r)?(s=n?i:t,!1):void 0}),s}e.exports=n},{}],148:[function(t,e,i){function n(t,e,i,l){for(var u=(l||0)-1,c=t.length,h=-1,p=[];++u<c;){var d=t[u];if(a(d)&&o(d.length)&&(r(d)||s(d))){e&&(d=n(d,e,i));var f=-1,m=d.length;for(p.length+=m;++f<m;)p[++h]=d[f]}else i||(p[++h]=d)}return p}var s=t("../lang/isArguments"),r=t("../lang/isArray"),o=t("./isLength"),a=t("./isObjectLike");e.exports=n},{"../lang/isArguments":208,"../lang/isArray":209,"./isLength":193,"./isObjectLike":194}],149:[function(t,e,i){arguments[4][20][0].apply(i,arguments)},{"./toObject":205,dup:20}],150:[function(t,e,i){function n(t,e){return s(t,e,r)}var s=t("./baseFor"),r=t("../object/keysIn");e.exports=n},{"../object/keysIn":222,"./baseFor":149}],151:[function(t,e,i){arguments[4][21][0].apply(i,arguments)},{"../object/keys":221,"./baseFor":149,dup:21}],152:[function(t,e,i){function n(t,e,i){if(e!==e)return s(t,i);for(var n=(i||0)-1,r=t.length;++n<r;)if(t[n]===e)return n;return-1}var s=t("./indexOfNaN");e.exports=n},{"./indexOfNaN":186}],153:[function(t,e,i){arguments[4][22][0].apply(i,arguments)},{"./baseIsEqualDeep":154,dup:22}],154:[function(t,e,i){arguments[4][23][0].apply(i,arguments)},{"../lang/isArray":209,"../lang/isTypedArray":218,"./equalArrays":182,"./equalByTag":183,"./equalObjects":184,dup:23}],155:[function(t,e,i){function n(t){return"function"==typeof t||!1}e.exports=n},{}],156:[function(t,e,i){arguments[4][24][0].apply(i,arguments)},{"./baseIsEqual":153,dup:24}],157:[function(t,e,i){arguments[4][25][0].apply(i,arguments)},{"./baseEach":145,dup:25}],158:[function(t,e,i){arguments[4][26][0].apply(i,arguments)},{"../object/keys":221,"./baseIsMatch":156,"./isStrictComparable":195,dup:26}],159:[function(t,e,i){arguments[4][27][0].apply(i,arguments)},{"./baseIsEqual":153,"./isStrictComparable":195,dup:27}],160:[function(t,e,i){arguments[4][28][0].apply(i,arguments)},{dup:28}],161:[function(t,e,i){arguments[4][29][0].apply(i,arguments)},{"../utility/identity":229,"./metaMap":197,dup:29}],162:[function(t,e,i){function n(t,e,i){var n=-1,s=t.length;e=null==e?0:+e||0,0>e&&(e=-e>s?0:s+e),i="undefined"==typeof i||i>s?s:+i||0,0>i&&(i+=s),s=e>i?0:i-e>>>0,e>>>=0;for(var r=Array(s);++n<s;)r[n]=t[n+e];return r}e.exports=n},{}],163:[function(t,e,i){function n(t,e){var i=t.length;for(t.sort(e);i--;)t[i]=t[i].value;return t}e.exports=n},{}],164:[function(t,e,i){arguments[4][30][0].apply(i,arguments)},{dup:30}],165:[function(t,e,i){function n(t,e){var i=-1,n=s,a=t.length,l=!0,u=l&&a>=200,c=u?o():null,h=[];c?(n=r,l=!1):(u=!1,c=e?[]:h);t:for(;++i<a;){var p=t[i],d=e?e(p,i,t):p;if(l&&p===p){for(var f=c.length;f--;)if(c[f]===d)continue t;e&&c.push(d),h.push(p)}else n(c,d)<0&&((e||u)&&c.push(d),h.push(p))}return h}var s=t("./baseIndexOf"),r=t("./cacheIndexOf"),o=t("./createCache");e.exports=n},{"./baseIndexOf":152,"./cacheIndexOf":169,"./createCache":177}],166:[function(t,e,i){function n(t,e){for(var i=-1,n=e.length,s=Array(n);++i<n;)s[i]=t[e[i]];return s}e.exports=n},{}],167:[function(t,e,i){arguments[4][31][0].apply(i,arguments)},{"../utility/identity":229,dup:31}],168:[function(t,e,i){(function(i){function n(t){return a.call(t,0)}var s=t("../utility/constant"),r=t("../lang/isNative"),o=r(o=i.ArrayBuffer)&&o,a=r(a=o&&new o(0).slice)&&a,l=Math.floor,u=r(u=i.Uint8Array)&&u,c=function(){try{var t=r(t=i.Float64Array)&&t,e=new t(new o(10),0,1)&&t}catch(n){}return e}(),h=c?c.BYTES_PER_ELEMENT:0;a||(n=o&&u?function(t){var e=t.byteLength,i=c?l(e/h):0,n=i*h,s=new o(e);if(i){var r=new c(s,0,i);r.set(new c(t,0,i))}return e!=n&&(r=new u(s,n),r.set(new u(t,n))),s}:s(null)),e.exports=n}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../lang/isNative":214,"../utility/constant":228}],169:[function(t,e,i){function n(t,e){var i=t.data,n="string"==typeof e||s(e)?i.set.has(e):i.hash[e];return n?0:-1}var s=t("../lang/isObject");e.exports=n},{"../lang/isObject":216}],170:[function(t,e,i){function n(t){var e=this.data;"string"==typeof t||s(t)?e.set.add(t):e.hash[t]=!0}var s=t("../lang/isObject");e.exports=n},{"../lang/isObject":216}],171:[function(t,e,i){function n(t,e){return s(t.criteria,e.criteria)||t.index-e.index}var s=t("./baseCompareAscending");e.exports=n},{"./baseCompareAscending":140}],172:[function(t,e,i){function n(t,e,i){for(var n=i.length,r=-1,o=s(t.length-n,0),a=-1,l=e.length,u=Array(o+l);++a<l;)u[a]=e[a];for(;++r<n;)u[i[r]]=t[r];for(;o--;)u[a++]=t[r++];return u}var s=Math.max;e.exports=n},{}],173:[function(t,e,i){function n(t,e,i){for(var n=-1,r=i.length,o=-1,a=s(t.length-r,0),l=-1,u=e.length,c=Array(a+u);++o<a;)c[o]=t[o];for(var h=o;++l<u;)c[h+l]=e[l];for(;++n<r;)c[h+i[n]]=t[o++];return c}var s=Math.max;e.exports=n},{}],174:[function(t,e,i){function n(t,e){return function(i,n,a){var l=e?e():{};if(n=s(n,a,3),o(i))for(var u=-1,c=i.length;++u<c;){var h=i[u];t(l,h,n(h,u,i),i)}else r(i,function(e,i,s){t(l,e,n(e,i,s),s)});return l}}var s=t("./baseCallback"),r=t("./baseEach"),o=t("../lang/isArray");e.exports=n},{"../lang/isArray":209,"./baseCallback":138,"./baseEach":145}],175:[function(t,e,i){function n(t){return function(){var e=arguments.length,i=arguments[0];if(2>e||null==i)return i;if(e>3&&r(arguments[1],arguments[2],arguments[3])&&(e=2),e>3&&"function"==typeof arguments[e-2])var n=s(arguments[--e-1],arguments[e--],5);else e>2&&"function"==typeof arguments[e-1]&&(n=arguments[--e]);for(var o=0;++o<e;){var a=arguments[o];a&&t(i,a,n)}return i}}var s=t("./bindCallback"),r=t("./isIterateeCall");e.exports=n},{"./bindCallback":167,"./isIterateeCall":192}],176:[function(t,e,i){function n(t,e){function i(){return(this instanceof i?n:t).apply(e,arguments)}var n=s(t);return i}var s=t("./createCtorWrapper");e.exports=n},{"./createCtorWrapper":178}],177:[function(t,e,i){(function(i){var n=t("./SetCache"),s=t("../utility/constant"),r=t("../lang/isNative"),o=r(o=i.Set)&&o,a=r(a=Object.create)&&a,l=a&&o?function(t){return new n(t)}:s(null);e.exports=l}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../lang/isNative":214,"../utility/constant":228,"./SetCache":132}],178:[function(t,e,i){function n(t){return function(){var e=s(t.prototype),i=t.apply(e,arguments);return r(i)?i:e}}var s=t("./baseCreate"),r=t("../lang/isObject");e.exports=n},{"../lang/isObject":216,"./baseCreate":142}],179:[function(t,e,i){function n(t,e,i,v,_,x,C,w,S,T){function E(){for(var p=arguments.length,d=p,f=Array(p);d--;)f[d]=arguments[d];if(v&&(f=r(f,v,_)),x&&(f=o(f,x,C)),O||P){var b=E.placeholder,j=u(f,b);if(p-=j.length,T>p){var L=w?s(w):null,F=y(T-p,0),M=O?j:null,q=O?null:j,B=O?f:null,U=O?null:f;e|=O?m:g,e&=~(O?g:m),k||(e&=~(c|h));var $=n(t,e,i,B,M,U,q,L,S,F);return $.placeholder=b,$}}var H=N?i:this;return A&&(t=H[R]),w&&(f=l(f,w)),I&&S<f.length&&(f.length=S),(this instanceof E?D||a(t):t).apply(H,f)}var I=e&b,N=e&c,A=e&h,O=e&d,k=e&p,P=e&f,D=!A&&a(t),R=t;return E}var s=t("./arrayCopy"),r=t("./composeArgs"),o=t("./composeArgsRight"),a=t("./createCtorWrapper"),l=t("./reorder"),u=t("./replaceHolders"),c=1,h=2,p=4,d=8,f=16,m=32,g=64,b=256,y=Math.max;e.exports=n},{"./arrayCopy":133,"./composeArgs":172,"./composeArgsRight":173,"./createCtorWrapper":178,"./reorder":200,"./replaceHolders":201}],180:[function(t,e,i){function n(t,e,i,n){function o(){for(var e=-1,s=arguments.length,r=-1,u=n.length,c=Array(s+u);++r<u;)c[r]=n[r];for(;s--;)c[r++]=arguments[++e];return(this instanceof o?l:t).apply(a?i:this,c)}var a=e&r,l=s(t);return o}var s=t("./createCtorWrapper"),r=1;e.exports=n},{"./createCtorWrapper":178}],181:[function(t,e,i){function n(t,e,i,n,b,y,v,_){var x=e&p;if(!x&&"function"!=typeof t)throw new TypeError(m);var C=n?n.length:0;if(C||(e&=~(d|f),n=b=null),C-=b?b.length:0,e&f){var w=n,S=b;n=b=null}var T=!x&&l(t),E=[t,e,i,n,b,w,S,y,v,_];if(T&&T!==!0&&(u(E,T),e=E[1],_=E[9]),E[9]=null==_?x?0:t.length:g(_-C,0)||0,e==h)var I=r(E[0],E[2]);else I=e!=d&&e!=(h|d)||E[4].length?o.apply(void 0,E):a.apply(void 0,E);var N=T?s:c;return N(I,E)}var s=t("./baseSetData"),r=t("./createBindWrapper"),o=t("./createHybridWrapper"),a=t("./createPartialWrapper"),l=t("./getData"),u=t("./mergeData"),c=t("./setData"),h=1,p=2,d=32,f=64,m="Expected a function",g=Math.max;e.exports=n},{"./baseSetData":161,"./createBindWrapper":176,"./createHybridWrapper":179,"./createPartialWrapper":180,"./getData":185,"./mergeData":196,"./setData":202}],182:[function(t,e,i){arguments[4][32][0].apply(i,arguments)},{dup:32}],183:[function(t,e,i){arguments[4][33][0].apply(i,arguments)},{dup:33}],184:[function(t,e,i){arguments[4][34][0].apply(i,arguments)},{"../object/keys":221,dup:34}],185:[function(t,e,i){var n=t("./metaMap"),s=t("../utility/noop"),r=n?function(t){return n.get(t)}:s;e.exports=r},{"../utility/noop":230,"./metaMap":197}],186:[function(t,e,i){function n(t,e,i){for(var n=t.length,s=i?e||n:(e||0)-1;i?s--:++s<n;){var r=t[s];if(r!==r)return s}return-1}e.exports=n},{}],187:[function(t,e,i){function n(t){var e=t.length,i=new t.constructor(e);return e&&"string"==typeof t[0]&&r.call(t,"index")&&(i.index=t.index,i.input=t.input),i}var s=Object.prototype,r=s.hasOwnProperty;e.exports=n},{}],188:[function(t,e,i){function n(t,e,i){var n=t.constructor;switch(e){case c:return s(t);case r:case o:return new n(+t);case h:case p:case d:case f:case m:case g:case b:case y:case v:var x=t.buffer;return new n(i?s(x):x,t.byteOffset,t.length);case a:case u:return new n(t);case l:var C=new n(t.source,_.exec(t));C.lastIndex=t.lastIndex}return C}var s=t("./bufferClone"),r="[object Boolean]",o="[object Date]",a="[object Number]",l="[object RegExp]",u="[object String]",c="[object ArrayBuffer]",h="[object Float32Array]",p="[object Float64Array]",d="[object Int8Array]",f="[object Int16Array]",m="[object Int32Array]",g="[object Uint8Array]",b="[object Uint8ClampedArray]",y="[object Uint16Array]",v="[object Uint32Array]",_=/\w*$/;
e.exports=n},{"./bufferClone":168}],189:[function(t,e,i){function n(t){var e=t.constructor;return"function"==typeof e&&e instanceof e||(e=Object),new e}e.exports=n},{}],190:[function(t,e,i){arguments[4][35][0].apply(i,arguments)},{"../lang/isNative":214,"../support":227,"./baseSetData":161,dup:35}],191:[function(t,e,i){arguments[4][36][0].apply(i,arguments)},{dup:36}],192:[function(t,e,i){function n(t,e,i){if(!o(i))return!1;var n=typeof e;if("number"==n)var a=i.length,l=r(a)&&s(e,a);else l="string"==n&&e in i;if(l){var u=i[e];return t===t?t===u:u!==u}return!1}var s=t("./isIndex"),r=t("./isLength"),o=t("../lang/isObject");e.exports=n},{"../lang/isObject":216,"./isIndex":191,"./isLength":193}],193:[function(t,e,i){arguments[4][37][0].apply(i,arguments)},{dup:37}],194:[function(t,e,i){arguments[4][38][0].apply(i,arguments)},{dup:38}],195:[function(t,e,i){arguments[4][39][0].apply(i,arguments)},{"../lang/isObject":216,dup:39}],196:[function(t,e,i){function n(t,e){var i=t[1],n=e[1],g=i|n,b=d|p,y=l|u,v=b|y|c|h,_=i&d&&!(n&d),x=i&p&&!(n&p),C=(x?t:e)[7],w=(_?t:e)[8],S=!(i>=p&&n>y||i>y&&n>=p),T=g>=b&&v>=g&&(p>i||(x||_)&&C.length<=w);if(!S&&!T)return t;n&l&&(t[2]=e[2],g|=i&l?0:c);var E=e[3];if(E){var I=t[3];t[3]=I?r(I,E,e[4]):s(E),t[4]=I?a(t[3],f):s(e[4])}return E=e[5],E&&(I=t[5],t[5]=I?o(I,E,e[6]):s(E),t[6]=I?a(t[5],f):s(e[6])),E=e[7],E&&(t[7]=s(E)),n&d&&(t[8]=null==t[8]?e[8]:m(t[8],e[8])),null==t[9]&&(t[9]=e[9]),t[0]=e[0],t[1]=g,t}var s=t("./arrayCopy"),r=t("./composeArgs"),o=t("./composeArgsRight"),a=t("./replaceHolders"),l=1,u=2,c=4,h=16,p=128,d=256,f="__lodash_placeholder__",m=Math.min;e.exports=n},{"./arrayCopy":133,"./composeArgs":172,"./composeArgsRight":173,"./replaceHolders":201}],197:[function(t,e,i){arguments[4][40][0].apply(i,arguments)},{"../lang/isNative":214,dup:40}],198:[function(t,e,i){function n(t,e){t=s(t);for(var i=-1,n=e.length,r={};++i<n;){var o=e[i];o in t&&(r[o]=t[o])}return r}var s=t("./toObject");e.exports=n},{"./toObject":205}],199:[function(t,e,i){function n(t,e){var i={};return s(t,function(t,n,s){e(t,n,s)&&(i[n]=t)}),i}var s=t("./baseForIn");e.exports=n},{"./baseForIn":150}],200:[function(t,e,i){function n(t,e){for(var i=t.length,n=o(e.length,i),a=s(t);n--;){var l=e[n];t[n]=r(l,i)?a[l]:void 0}return t}var s=t("./arrayCopy"),r=t("./isIndex"),o=Math.min;e.exports=n},{"./arrayCopy":133,"./isIndex":191}],201:[function(t,e,i){function n(t,e){for(var i=-1,n=t.length,r=-1,o=[];++i<n;)t[i]===e&&(t[i]=s,o[++r]=i);return o}var s="__lodash_placeholder__";e.exports=n},{}],202:[function(t,e,i){var n=t("./baseSetData"),s=t("../date/now"),r=150,o=16,a=function(){var t=0,e=0;return function(i,a){var l=s(),u=o-(l-e);if(e=l,u>0){if(++t>=r)return i}else t=0;return n(i,a)}}();e.exports=a},{"../date/now":128,"./baseSetData":161}],203:[function(t,e,i){arguments[4][41][0].apply(i,arguments)},{"../lang/isArguments":208,"../lang/isArray":209,"../object/keysIn":222,"../support":227,"./isIndex":191,"./isLength":193,dup:41}],204:[function(t,e,i){function n(t,e){for(var i,n=-1,s=t.length,r=-1,o=[];++n<s;){var a=t[n],l=e?e(a,n,t):a;n&&i===l||(i=l,o[++r]=a)}return o}e.exports=n},{}],205:[function(t,e,i){arguments[4][42][0].apply(i,arguments)},{"../lang/isObject":216,dup:42}],206:[function(t,e,i){function n(t,e,i,n){return e&&"boolean"!=typeof e&&o(t,e,i)?e=!1:"function"==typeof e&&(n=i,i=e,e=!1),i="function"==typeof i&&r(i,n,1),s(t,e,i)}var s=t("../internal/baseClone"),r=t("../internal/bindCallback"),o=t("../internal/isIterateeCall");e.exports=n},{"../internal/baseClone":139,"../internal/bindCallback":167,"../internal/isIterateeCall":192}],207:[function(t,e,i){function n(t,e,i){return e="function"==typeof e&&r(e,i,1),s(t,!0,e)}var s=t("../internal/baseClone"),r=t("../internal/bindCallback");e.exports=n},{"../internal/baseClone":139,"../internal/bindCallback":167}],208:[function(t,e,i){arguments[4][43][0].apply(i,arguments)},{"../internal/isLength":193,"../internal/isObjectLike":194,dup:43}],209:[function(t,e,i){arguments[4][44][0].apply(i,arguments)},{"../internal/isLength":193,"../internal/isObjectLike":194,"./isNative":214,dup:44}],210:[function(t,e,i){function n(t){return t===!0||t===!1||s(t)&&a.call(t)==r||!1}var s=t("../internal/isObjectLike"),r="[object Boolean]",o=Object.prototype,a=o.toString;e.exports=n},{"../internal/isObjectLike":194}],211:[function(t,e,i){function n(t){if(null==t)return!0;var e=t.length;return a(e)&&(r(t)||u(t)||s(t)||l(t)&&o(t.splice))?!e:!c(t).length}var s=t("./isArguments"),r=t("./isArray"),o=t("./isFunction"),a=t("../internal/isLength"),l=t("../internal/isObjectLike"),u=t("./isString"),c=t("../object/keys");e.exports=n},{"../internal/isLength":193,"../internal/isObjectLike":194,"../object/keys":221,"./isArguments":208,"./isArray":209,"./isFunction":213,"./isString":217}],212:[function(t,e,i){function n(t,e,i,n){if(i="function"==typeof i&&r(i,n,3),!i&&o(t)&&o(e))return t===e;var a=i?i(t,e):void 0;return"undefined"==typeof a?s(t,e,i):!!a}var s=t("../internal/baseIsEqual"),r=t("../internal/bindCallback"),o=t("../internal/isStrictComparable");e.exports=n},{"../internal/baseIsEqual":153,"../internal/bindCallback":167,"../internal/isStrictComparable":195}],213:[function(t,e,i){(function(i){var n=t("../internal/baseIsFunction"),s=t("./isNative"),r="[object Function]",o=Object.prototype,a=o.toString,l=s(l=i.Uint8Array)&&l,u=n(/x/)||l&&!n(l)?function(t){return a.call(t)==r}:n;e.exports=u}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../internal/baseIsFunction":155,"./isNative":214}],214:[function(t,e,i){arguments[4][45][0].apply(i,arguments)},{"../internal/isObjectLike":194,"../string/escapeRegExp":226,dup:45}],215:[function(t,e,i){function n(t){return"number"==typeof t||s(t)&&a.call(t)==r||!1}var s=t("../internal/isObjectLike"),r="[object Number]",o=Object.prototype,a=o.toString;e.exports=n},{"../internal/isObjectLike":194}],216:[function(t,e,i){arguments[4][46][0].apply(i,arguments)},{dup:46}],217:[function(t,e,i){function n(t){return"string"==typeof t||s(t)&&a.call(t)==r||!1}var s=t("../internal/isObjectLike"),r="[object String]",o=Object.prototype,a=o.toString;e.exports=n},{"../internal/isObjectLike":194}],218:[function(t,e,i){arguments[4][47][0].apply(i,arguments)},{"../internal/isLength":193,"../internal/isObjectLike":194,dup:47}],219:[function(t,e,i){var n=t("../internal/baseAssign"),s=t("../internal/createAssigner"),r=s(n);e.exports=r},{"../internal/baseAssign":137,"../internal/createAssigner":175}],220:[function(t,e,i){e.exports=t("./assign")},{"./assign":219}],221:[function(t,e,i){arguments[4][48][0].apply(i,arguments)},{"../internal/isLength":193,"../internal/shimKeys":203,"../lang/isNative":214,"../lang/isObject":216,dup:48}],222:[function(t,e,i){arguments[4][49][0].apply(i,arguments)},{"../internal/isIndex":191,"../internal/isLength":193,"../lang/isArguments":208,"../lang/isArray":209,"../lang/isObject":216,"../support":227,dup:49}],223:[function(t,e,i){function n(t,e,i){if(null==t)return{};if("function"!=typeof e){var n=s(o(arguments,!1,!1,1),String);return u(t,r(l(t),n))}return e=a(e,i,3),c(t,function(t,i,n){return!e(t,i,n)})}var s=t("../internal/arrayMap"),r=t("../internal/baseDifference"),o=t("../internal/baseFlatten"),a=t("../internal/bindCallback"),l=t("./keysIn"),u=t("../internal/pickByArray"),c=t("../internal/pickByCallback");e.exports=n},{"../internal/arrayMap":136,"../internal/baseDifference":144,"../internal/baseFlatten":148,"../internal/bindCallback":167,"../internal/pickByArray":198,"../internal/pickByCallback":199,"./keysIn":222}],224:[function(t,e,i){function n(t){return s(t,r(t))}var s=t("../internal/baseValues"),r=t("./keys");e.exports=n},{"../internal/baseValues":166,"./keys":221}],225:[function(t,e,i){function n(t){return t=s(t),t&&t.charAt(0).toUpperCase()+t.slice(1)}var s=t("../internal/baseToString");e.exports=n},{"../internal/baseToString":164}],226:[function(t,e,i){arguments[4][50][0].apply(i,arguments)},{"../internal/baseToString":164,dup:50}],227:[function(t,e,i){arguments[4][51][0].apply(i,arguments)},{"./lang/isNative":214,dup:51}],228:[function(t,e,i){function n(t){return function(){return t}}e.exports=n},{}],229:[function(t,e,i){arguments[4][52][0].apply(i,arguments)},{dup:52}],230:[function(t,e,i){function n(){}e.exports=n},{}],231:[function(t,e,i){"use strict";var n=t("../../util/jquery"),s=t("../../model/TextNode"),r=s.extend({displayName:"Blockquote",name:"blockquote"});r["static"].blockType=!0,r["static"].matchElement=function(t){return t.is("blockquote")},r["static"].fromHtml=function(t,e){var i=e.defaultId(t,"blockquote"),n={id:i,content:""};return n.content=e.annotatedText(t,[i,"content"]),n},r["static"].toHtml=function(t,e){var i=t.id,s=n("<blockquote>").attr("id",i);return s.append(e.annotatedText([i,"content"])),s},e.exports=r},{"../../model/TextNode":78,"../../util/jquery":316}],232:[function(t,e,i){"use strict";function n(){r.apply(this,arguments)}var s=t("../../util/oo"),r=t("../../ui/Component"),o=r.$$,a=t("../../ui/TextPropertyComponent");n.Prototype=function(){this.getClassNames=function(){return"content-node blockquote"},this.render=function(){return o("div").addClass(this.getClassNames()).attr("data-id",this.props.node.id).append(o(a,{path:[this.props.node.id,"content"]}))}},s.inherit(n,r),e.exports=n},{"../../ui/Component":279,"../../ui/TextPropertyComponent":302,"../../util/oo":317}],233:[function(t,e,i){"use strict";var n=t("../text/SwitchTextTypeCommand"),s=n.extend({"static":{name:"makeBlockquote",textTypeName:"Blockquote",nodeData:{type:"blockquote"}}});e.exports=s},{"../text/SwitchTextTypeCommand":272}],234:[function(t,e,i){"use strict";var n=t("../../util/jquery"),s=t("../../model/TextNode"),r=s.extend({displayName:"Codeblock",name:"codeblock"});r["static"].blockType=!0,r["static"].matchElement=function(t){return t.is("pre")},r["static"].fromHtml=function(t,e){var i=t.find("code"),n=e.defaultId(t,"codeblock"),s={id:n,content:""};return s.content=e.annotatedText(i,[n,"content"]),s},r["static"].toHtml=function(t,e){var i=t.id,s=n("<pre>").attr("id",i),r=n("<code>");return r.append(e.annotatedText([i,"content"])),s.append(r),s},e.exports=r},{"../../model/TextNode":78,"../../util/jquery":316}],235:[function(t,e,i){"use strict";function n(){r.apply(this,arguments)}var s=t("../../util/oo"),r=t("../../ui/Component"),o=r.$$,a=t("../../ui/TextPropertyComponent");n.Prototype=function(){this.getClassNames=function(){return"content-node codeblock"},this.render=function(){return o("div").addClass(this.getClassNames()).attr("data-id",this.props.node.id).append(o(a,{path:[this.props.node.id,"content"]}))}},s.inherit(n,r),e.exports=n},{"../../ui/Component":279,"../../ui/TextPropertyComponent":302,"../../util/oo":317}],236:[function(t,e,i){"use strict";var n=t("../text/SwitchTextTypeCommand"),s=n.extend({"static":{name:"makeCodeblock",textTypeName:"Codeblock",nodeData:{type:"codeblock"}}});e.exports=s},{"../text/SwitchTextTypeCommand":272}],237:[function(t,e,i){"use strict";var n=t("../../util/jquery"),s=t("../../model/DocumentNode"),r=s.extend({displayName:"Embed",name:"embed",properties:{src:"string",html:"string"}});r["static"].blockType=!0,r["static"].matchElement=function(t){return t.is("embed")},r["static"].fromHtml=function(t,e){var i=e.defaultId(t,"embed"),n={id:i,src:t.attr("src"),html:t.html()};return n},r["static"].toHtml=function(t,e){var i=n("<embed>").attr("id",t.id).attr("src",t.src);return i.html(t.html),i},e.exports=r},{"../../model/DocumentNode":67,"../../util/jquery":316}],238:[function(t,e,i){"use strict";var n=t("../../util/uuid"),s=t("../../ui/SurfaceCommand"),r=s.extend({"static":{name:"embed"},getCommandState:function(){var t=this.getSelection(),e={disabled:!0,active:!1};return t&&!t.isNull()&&t.isPropertySelection()&&(e.disabled=!1),e},execute:function(t){var e=this.getCommandState(),i=this.getSurface();return e.disabled?void 0:(i.transaction(function(e,s){var r=e.create({id:n("embed"),type:"embed",src:t.src,html:t.html}),o={id:n("image-figure"),type:"image-figure",content:r.id,title:"Enter title",caption:"Enter caption"};return i.insertNode(e,{selection:s.selection,node:o})}),{status:"embed-created"})}});e.exports=r},{"../../ui/SurfaceCommand":299,"../../util/uuid":318}],239:[function(t,e,i){"use strict";function n(){r.apply(this,arguments)}var s=t("../../util/oo"),r=t("../../ui/Component"),o=r.$$;n.Prototype=function(){this.getClassNames=function(){return"content-node sc-embed"},this.render=function(){var t,e=this.props.node;return t=e.src&&e.html?o("div").html(e.html):o("div").append(o("input").attr({type:"text",value:"http://"}).ref("src")),o("div").addClass(this.getClassNames()).attr("data-id",this.props.node.id).append(t)}},s.inherit(n,r),e.exports=n},{"../../ui/Component":279,"../../util/oo":317}],240:[function(t,e,i){var n=t("../../ui/SurfaceTool"),s=t("../../util/helpers"),r=t("../../ui/Component"),o=r.$$,a=r.extend({onSave:function(t){t.preventDefault(),this.props.tool.createEmbed(this.refs.url.$el.val())},render:function(){var t=o("div").addClass("prompt shadow border fill-white");return t.append([o("div").addClass("prompt-title").append(this.i18n.t("embed-src")),o("input").attr({type:"text",placeholder:"https://vimeo.com/142254284",value:""}).ref("url").on("change",this.onSave)]),t}}),l=n.extend({"static":{name:"embed",command:"embed"},onClick:function(){var t=s.extend({},this.state,{showPrompt:!this.state.showPrompt});this.setState(t)},createEmbed:function(t){var e=this.getSurface(),i=this.constructor["static"].command,n=this.context.embedResolver;n(t,function(n,s){e.executeCommand(i,{src:t,html:s})})},render:function(){var t=this.props.title||s.capitalize(this.getName());this.state.mode&&(t=[s.capitalize(this.state.mode),t].join(" "));var e=o("div").addClass("embed prompt tool");this.state.disabled&&e.addClass("disabled");var i=o("button").addClass("button").attr("title",t).on("click",this.onClick);if(i.append(this.props.children),e.append(i),this.state.showPrompt){var n=o(a,{tool:this});e.append(n)}return e}});e.exports=l},{"../../ui/Component":279,"../../ui/SurfaceTool":301,"../../util/helpers":315}],241:[function(t,e,i){"use strict";var n=t("../../model/Annotation"),s=n.extend({name:"emphasis",displayName:"Emphasis",splitContainerSelections:!0});s["static"].tagName="em",s["static"].matchElement=function(t){return t.is("em,i")},e.exports=s},{"../../model/Annotation":56}],242:[function(t,e,i){"use strict";var n=t("../../ui/AnnotationCommand"),s=n.extend({"static":{name:"emphasis",annotationType:"emphasis"}});e.exports=s},{"../../ui/AnnotationCommand":274}],243:[function(t,e,i){"use strict";var n=t("../../ui/AnnotationTool"),s=n.extend({"static":{name:"emphasis",command:"emphasis"}});e.exports=s},{"../../ui/AnnotationTool":276}],244:[function(t,e,i){var n=t("../../util/jquery"),s=t("../../model/DocumentNode"),r=s.extend({name:"figure",properties:{title:"string",caption:"string",content:"id"},setLabel:function(t){this.label=t,this.emit("label",t)},setText:function(t){this.text=t},didInitialize:function(){this.guid=this.id},getContentNode:function(){return this.document.get(this.content)}});r["static"].components=["title","caption"],r["static"].fromHtml=function(t,e){var i=e.defaultId(t,"fig"),s={id:i,title:"",caption:""};return t.children().each(function(){var t=n(this),r=t[0].tagName.toLowerCase();switch(r){case"title":case"caption":s[r]=e.annotatedText(t,[i,r])}}),s},r["static"].toHtml=function(t,e,i){var s=e.id,r=n("<"+t+">").attr("id",s),o=n("<title>").append(i.annotatedText([s,"title"])),a=e.getContentNode().toHtml(i),l=n("<caption>").append(i.annotatedText([s,"caption"]));return r.append(o,a,l)},e.exports=r},{"../../model/DocumentNode":67,"../../util/jquery":316}],245:[function(t,e,i){"use strict";function n(){r.apply(this,arguments)}var s=t("../../util/oo"),r=t("../../ui/Component"),o=t("../../ui/TextPropertyComponent"),a=r.$$;n.Prototype=function(){this.render=function(){var t=this.context.componentRegistry,e=this.props.node.getContentNode(),i=t.get(e.type),n=a("div").addClass("content-node figure clearfix "+this.props.node.type).attr("data-id",this.props.node.id);return n.append(a("div").addClass("label").attr("contenteditable",!1).append(this.props.node.label)),n.append(a(o,{tagName:"div",path:[this.props.node.id,"title"]}).addClass("title")),n.append(a("div").addClass("figure-content").attr("contenteditable",!1).append(a(i,{doc:this.props.doc,node:e}))),n.append(a("div").addClass("description small").append(a(o,{tagName:"div",path:[this.props.node.id,"caption"]}).addClass("caption"))),n}},s.inherit(n,r),e.exports=n},{"../../ui/Component":279,"../../ui/TextPropertyComponent":302,"../../util/oo":317}],246:[function(t,e,i){"use strict";var n=t("../../util/uuid"),s=t("../../ui/SurfaceCommand"),r=t("../../util/jquery"),o=s.extend({"static":{name:"insertFigure"},getCommandState:function(){var t=this.getSelection(),e={disabled:!0,active:!1};return t&&!t.isNull()&&t.isPropertySelection()&&(e.disabled=!1),e},execute:function(){var t=this.getCommandState(),e=this.getSurface(),i=e.getController();if(!t.disabled){var s=e.$el,o=r('<input type="file" id="file_input" style="opacity: 0;">');return s.append(o),o.click(),o.on("change",function(){var t=o[0].files[0];o.remove(),i.uploadFile(t,function(t,i){var s={selection:e.getSelection()};e.transaction(s,function(t,s){var r=t.create({id:n("image"),type:"image",src:i,previewSrc:i}),o={id:n("image-figure"),type:"image-figure",content:r.id,title:"Enter title",caption:"Enter caption"};return e.insertNode(t,{selection:s.selection,node:o})})})}.bind(this)),{status:"file-upload-process-started"}}}});e.exports=o},{"../../ui/SurfaceCommand":299,"../../util/jquery":316,"../../util/uuid":318}],247:[function(t,e,i){var n=t("../../ui/SurfaceTool"),s=n.extend({"static":{name:"insertFigure",command:"insertFigure"}});e.exports=s},{"../../ui/SurfaceTool":301}],248:[function(t,e,i){"use strict";var n=t("../../util/jquery"),s=t("../../model/TextNode"),r=s.extend({name:"heading",displayName:"Heading",properties:{level:"number"}});r["static"].blockType=!0,r["static"].tocType=!0,r["static"].matchElement=function(t){return/^h\d$/.exec(t[0].tagName.toLowerCase())},r["static"].fromHtml=function(t,e){var i=e.defaultId(t,"heading"),n={id:i,level:parseInt(""+t[0].tagName[1],10),content:""};return n.content=e.annotatedText(t,[i,"content"]),n},r["static"].toHtml=function(t,e){var i=t.id,s=n("<h"+t.level+">");return s.append(e.annotatedText([i,"content"])),s},e.exports=r},{"../../model/TextNode":78,"../../util/jquery":316}],249:[function(t,e,i){"use strict";function n(){r.apply(this,arguments)}var s=t("../../util/oo"),r=t("../../ui/Component"),o=r.$$,a=t("../../ui/TextPropertyComponent");n.Prototype=function(){this.render=function(){return o("div").addClass("sc-heading sm-level-"+this.props.node.level).attr("data-id",this.props.node.id).append(o(a,{path:[this.props.node.id,"content"]}))}},s.inherit(n,r),e.exports=n},{"../../ui/Component":279,"../../ui/TextPropertyComponent":302,"../../util/oo":317}],250:[function(t,e,i){"use strict";var n=t("../text/SwitchTextTypeCommand"),s=n.extend({"static":{name:"makeHeading1",textTypeName:"Heading 1",nodeData:{type:"heading",level:1}}});e.exports=s},{"../text/SwitchTextTypeCommand":272}],251:[function(t,e,i){"use strict";var n=t("../text/SwitchTextTypeCommand"),s=n.extend({"static":{name:"makeHeading2",textTypeName:"Heading 2",nodeData:{type:"heading",level:2}}});e.exports=s},{"../text/SwitchTextTypeCommand":272}],252:[function(t,e,i){"use strict";var n=t("../text/SwitchTextTypeCommand"),s=n.extend({"static":{name:"makeHeading3",textTypeName:"Heading 3",nodeData:{type:"heading",level:3}}});e.exports=s},{"../text/SwitchTextTypeCommand":272}],253:[function(t,e,i){var n=t("../../util/jquery"),s=t("../../model/DocumentNode"),r=s.extend({name:"image",properties:{src:"string",previewSrc:"string"}});r["static"].matchElement=function(t){return t.is("img")},r["static"].fromHtml=function(t,e){var i=e.defaultId(t,"img"),n={id:i,src:t.attr("src"),previewSrc:t.attr("data-preview-src")};return n},r["static"].toHtml=function(t){var e=n("<img>").attr("id",t.id).attr("src",t.src).attr("data-preview-src",t.previewSrc);return e},e.exports=r},{"../../model/DocumentNode":67,"../../util/jquery":316}],254:[function(t,e,i){"use strict";function n(){r.apply(this,arguments)}var s=t("../../util/oo"),r=t("../../ui/Component"),o=r.$$;n.Prototype=function(){this.initialize=function(){var t=this.props.doc;t.connect(this,{"document:changed":this.handleDocumentChange})},this.dispose=function(){var t=this.props.doc;t.disconnect(this)},this.render=function(){return o("img").addClass("image").attr({"data-id":this.props.node.id,contentEditable:!1,src:this.props.node.src})},this.handleDocumentChange=function(t){t.isAffected([this.props.node.id,"src"])&&this.rerender()}},s.inherit(n,r),e.exports=n},{"../../ui/Component":279,"../../util/oo":317}],255:[function(t,e,i){"use strict";var n=t("../../model/Annotation"),s=n.extend({name:"link",displayName:"Link",properties:{url:"string",title:"string"}});s["static"].tagName="a",s["static"].matchElement=function(t){return t.is("a")},s["static"].fromHtml=function(t,e){var i={url:t.attr("href"),title:t.attr("title")};return e.annotatedText(t),i},s["static"].toHtml=function(t,e,i){var s=n["static"].toHtml(t,e,i);return s.attr("href",t.url),s.attr("title",t.title),s},e.exports=s},{"../../model/Annotation":56}],256:[function(t,e,i){"use strict";var n=t("../../ui/AnnotationCommand"),s=n.extend({getAnnotationData:function(){return{url:"",title:""}},canEdit:function(t,e){return 1===t.length},"static":{name:"link",annotationType:"link"}});e.exports=s},{"../../ui/AnnotationCommand":274}],257:[function(t,e,i){"use strict";function n(){a.apply(this,arguments);var t=this.getController();t.connect(this,{"command:executed":this.onCommandExecuted})}var s=t("../../util/oo"),r=t("../../ui/Component"),o=r.$$,a=t("../../ui/AnnotationTool"),l=t("../../util/helpers"),u=r.extend({onSave:function(t){t.preventDefault(),this.props.tool.updateLink({url:this.refs.url.$el.val()})},didMount:function(){},onDelete:function(t){t.preventDefault(),this.props.tool.deleteLink()},render:function(){var t=this.props.link,e=o("div").addClass("prompt shadow border fill-white");return e.append([o("div").addClass("prompt-title").append(this.i18n.t("hyperlink")),o("input").attr({type:"text",placeholder:"http://your-website.com",value:t.url}).ref("url").htmlProp("autofocus",!0).on("change",this.onSave),o("a").attr({href:"#"}).addClass("delete-link").append(this.i18n.t("delete")).on("click",this.onDelete)]),e}});n.Prototype=function(){this["static"]={name:"link",command:"link"},this.dispose=function(){var t=this.getController();t.disconnect(this)},this.onCommandExecuted=function(t,e){e===this["static"].command&&l.includes(["edit","create"],t.mode)&&this.togglePrompt()},this.togglePrompt=function(){var t=l.extend({},this.state,{showPrompt:!this.state.showPrompt});this.setState(t)},this.updateLink=function(t){var e=this.getLink();this.getSurface().transaction(function(i){i.set([e.id,"url"],t.url),i.set([e.id,"title"],t.title)})},this.deleteLink=function(){var t=this.getLink();this.getSurface().transaction(function(e){e["delete"](t.id)}),this.togglePrompt()},this.getLink=function(){return this.getDocument().get(this.state.annotationId)},this.render=function(){var t=this.props.title||l.capitalize(this.getName());this.state.mode&&(t=[l.capitalize(this.state.mode),t].join(" "));var e=o("div").addClass("link tool prompt");this.state.disabled&&e.addClass("disabled"),"edit"===this.state.mode&&e.addClass("active"),this.state.mode&&e.addClass(this.state.mode);var i=o("button").addClass("button").attr("title",t).on("click",this.onClick);if(i.append(this.props.children),e.append(i),"edit"===this.state.mode&&this.state.showPrompt){var n=this.getLink(),s=o(u,{link:n,tool:this});e.append(s)}return e}},s.inherit(n,a),e.exports=n},{"../../ui/AnnotationTool":276,"../../ui/Component":279,"../../util/helpers":315,"../../util/oo":317}],258:[function(t,e,i){"use strict";var n=t("../../util/helpers"),s=t("../../util/jquery"),r=t("../../model/DocumentNode"),o=t("./ListItem"),a=t("../../model/ParentNodeMixin"),l=r.extend(a.prototype,{displayName:"List",name:"list",properties:{ordered:"boolean",items:["array","id"]},didInitialize:function(){a.call(this,"items")},getItems:function(){var t=this.getDocument();return n.map(this.items,function(e){return t.get(e)},this)},removeItem:function(t){var e=this.getDocument(),i=this.items.indexOf(t);if(!(i>=0))throw new Error("List item is not a child of this list: "+t);e.update([this.id,"items"],{"delete":{offset:i}})},insertItemAt:function(t,e){var i=this.getDocument();i.update([this.id,"items"],{insert:{offset:t,value:e}})}});l["static"].components=["items"],l["static"].blockType=!0,l["static"].matchElement=function(t){return t.is("ul,ol")},l["static"].fromHtml=function(t,e){function i(t,e){for(var i=[[]],r=i[0],o=e.firstChild;o;o=o.nextSibling){var a=t._getDomNodeType(o);if("ol"===a||"ul"===a)r=o,i.push(r);else{if(/^\s*$/.exec(s(o).text()))continue;n.isArray(r)||(r=[],i.push(r)),r.push(o)}}return i}function r(t){for(var r="ol"===n.last(h),l=i(e,t),p=0;p<l.length;p++){var d=l[p];if(n.isArray(d)){var f=s("<span>").append(d);e.trimTextContent(f);var m=o["static"].fromHtml(f,e);m.ordered=r,m.level=c,e.getDocument().create(m),u.items.push(m.id)}else a(d)}}function a(t){c++,h.push(e._getDomNodeType(t));for(var i=t.firstChild;i;i=i.nextSibling){var n=e._getDomNodeType(i);"li"===n?r(i):("ol"==n||"ul"===n)&&a(i)}c--,h.pop()}var l=e.defaultId(t,"list"),u={id:l,items:[]},c=0,h=[];return a(t[0]),u},l["static"].toHtml=function(t,e){return l["static"].render(t,{createElement:function(t){return s("<"+t+">")},createAnnotatedTextNode:function(t){return e.annotatedText(t)}})},l["static"].render=function(t,e){var i=t.ordered?"ol":"ul",n=t.id,s=t.getItems(),r=e.createElement(i);r.attr("data-id",n);for(var o,a=r,l=[a],u=1,c=0;c<s.length;c++){var h=s[c];if(h.level===u);else if(h.level>u){var p=h.ordered?"ol":"ul";for(o=u;o<h.level;o++){var d=e.createElement(p);a.append(d),a=d,l.push(a),u++}}else{for(o=u;o>h.level;o--)l.pop(),u--;a=l[l.length-1]}a.append(e.createElement("li").addClass("content-node list-item").attr("data-id",h.id).append(e.createAnnotatedTextNode([h.id,"content"])))}return r},Object.defineProperties(l.prototype,{itemNodes:{get:function(){return this.getItems()}}}),e.exports=l},{"../../model/DocumentNode":67,"../../model/ParentNodeMixin":72,"../../util/helpers":315,"../../util/jquery":316,"./ListItem":259}],259:[function(t,e,i){"use strict";var n=t("../../util/jquery"),s=t("../../model/DocumentNode"),r=s.extend({displayName:"ListItem",name:"list-item",properties:{parent:"id",level:"number",ordered:"bool",content:"string"}});r["static"].components=["content"],r["static"].defaultProperties={level:1,orderered:!1,content:""},r["static"].fromHtml=function(t,e){var i=t.data("level")||1,n=e.defaultId(t,"li"),s={id:n,type:"list-item",level:i,ordered:!1,content:""};return s.content=e.annotatedText(t,[n,"content"]),s},r["static"].toHtml=function(t,e){var i=t.id,s=n("<li>").attr("id",t.id).data("level",t.level).append(e.annotatedText([i,"content"]));return s},e.exports=r},{"../../model/DocumentNode":67,"../../util/jquery":316}],260:[function(t,e,i){"use strict";var n=t("../text/SwitchTextTypeCommand"),s=n.extend({"static":{name:"paragraph",textTypeName:"Paragraph",nodeData:{type:"paragraph"}}});e.exports=s},{"../text/SwitchTextTypeCommand":272}],261:[function(t,e,i){"use strict";var n=t("../../util/jquery"),s=t("../../model/TextNode"),r=s.extend({displayName:"Paragraph",name:"paragraph"});r["static"].blockType=!0,r["static"].matchElement=function(t){return t.is("p")},r["static"].fromHtml=function(t,e){var i=e.defaultId(t,"p"),n={id:i,content:""};return n.content=e.annotatedText(t,[i,"content"]),n},r["static"].toHtml=function(t,e){var i=t.id,s=n("<p>").attr("id",i);return s.append(e.annotatedText([i,"content"])),s},e.exports=r},{"../../model/TextNode":78,"../../util/jquery":316}],262:[function(t,e,i){"use strict";function n(){r.apply(this,arguments)}var s=t("../../util/oo"),r=t("../../ui/Component"),o=r.$$,a=t("../../ui/TextPropertyComponent");n.Prototype=function(){this.getClassNames=function(){return"content-node paragraph"},this.render=function(){return o("div").addClass(this.getClassNames()).attr("data-id",this.props.node.id).append(o(a,{path:[this.props.node.id,"content"]}))}},s.inherit(n,r),e.exports=n},{"../../ui/Component":279,"../../ui/TextPropertyComponent":302,"../../util/oo":317}],263:[function(t,e,i){"use strict";var n=t("../../model/Annotation"),s=n.extend({displayName:"Strong",name:"strong",splitContainerSelections:!0});s["static"].tagName="strong",s["static"].matchElement=function(t){return t.is("strong,b")},e.exports=s},{"../../model/Annotation":56}],264:[function(t,e,i){"use strict";var n=t("../../ui/AnnotationCommand"),s=n.extend({"static":{name:"strong",annotationType:"strong"}});e.exports=s},{"../../ui/AnnotationCommand":274}],265:[function(t,e,i){"use strict";var n=t("../../ui/AnnotationTool"),s=n.extend({"static":{name:"strong",command:"strong"}});e.exports=s},{"../../ui/AnnotationTool":276}],266:[function(t,e,i){"use strict";var n=t("../../util/jquery"),s=t("../../util/oo"),r=t("../../util/helpers"),o=t("../../model/DocumentNode"),a=t("./TableMatrix"),l=t("../../model/ParentNodeMixin"),u=o.extend(l.prototype,{displayName:"Table",name:"table",matrix:null,properties:{sections:["array","id"]},didInitialize:function(){l.call(this,"sections")},getSections:function(){var t=this.getDocument();return r.map(this.sections,function(e){return t.get(e)},this)},getSectionAt:function(t){var e=this.getDocument(),i=this.sections[t];return i?e.get(i):null},attach:function(){this["super"].attach.apply(this,arguments)},getMatrix:function(){return this.matrix||(this.matrix=new a(this),this.matrix.update()),this.matrix},getIterator:function(){return new u.CellIterator(this)},getSize:function(t){var e=this.matrix.getSize();return"row"===t?e[0]:"col"===t?e[1]:e}});u["static"].components=["sections"],u["static"].defaultProperties={sections:[]},u["static"].blockType=!0,u["static"].matchElement=function(t){return t.is("table")},u["static"].fromHtml=function(t,e){var i=e.defaultId(t,"table"),s={id:i,sections:[]};if(r.each(["thead","tbody","tfoot"],function(n){var r=t.find(n);if(r.length){var o=e.convertElement(r,{parent:i});s.sections.push(o.id)}}),0===s.sections.length){var o={id:e.nextId("tbody"),parent:i,type:"table-section",sectionType:"body",rows:[]};t.find("tr").each(function(){var t=n(this),s=e.convertElement(t,{parent:i});o.rows.push(s.id)}),e.getDocument().create(o),s.sections.push(o.id)}return s},u["static"].toHtml=function(t,e){var i=t.id,s=n("<table>").attr("id",i);return r.each(t.getSections(),function(t){s.append(t.toHtml(e))}),s},Object.defineProperties(u.prototype,{rowNodes:{get:function(){return this.getRows()}}}),u.CellIterator=function(t){this.table=t,this.__it={sectionIndex:-1,rowIndex:-1,rowNode:null,cellIndex:-1,cellNode:null,sectionNode:null,finished:!1},this.onNewSection=function(){},this.onNewRow=function(){}},u.CellIterator.Prototype=function(){this.next=function(){if(this.__it.finished)throw new Error("TableCellIterator has no more cells left.");return this.nextCell(this.__it),this.__it.finished?null:this.__it.cellNode},this.nextSection=function(t){t.sectionIndex++,t.sectionNode=this.table.getSectionAt(t.sectionIndex),t.sectionNode?(t.rowIndex=0,t.rowNode=t.sectionNode.getRowAt(0),this.onNewSection(t.sectionNode)):t.finished=!0},this.nextRow=function(t){for(t.rowIndex++,t.sectionNode&&(t.rowNode=t.sectionNode.getRowAt(t.rowIndex));!t.rowNode&&!t.finished;)this.nextSection(t);t.rowNode&&(t.cellIndex=0,t.cellNode=t.rowNode.getCellAt(0),this.onNewRow(t.rowNode))},this.nextCell=function(t){for(t.cellNode&&(t.cellIndex++,t.cellNode=t.rowNode.getCellAt(t.cellIndex));!t.cellNode&&!t.finished;)this.nextRow(t);
}},s.initClass(u.CellIterator),e.exports=u},{"../../model/DocumentNode":67,"../../model/ParentNodeMixin":72,"../../util/helpers":315,"../../util/jquery":316,"../../util/oo":317,"./TableMatrix":269}],267:[function(t,e,i){"use strict";var n=t("../../util/jquery"),s=t("../../model/DocumentNode"),r=s.extend({displayName:"TableCell",name:"table-cell",properties:{parent:"id",cellType:"string",colspan:"number",rowspan:"number",content:"string"},getSpan:function(t){return"col"===t?this.colspan||1:"row"===t?this.rowspan||1:void 0}});r["static"].components=["content"],r["static"].defaultProperties={cellType:"td",content:""},r["static"].matchElement=function(t){return t.is("th, td")},r["static"].fromHtml=function(t,e){var i=e.defaultId(t,"tcell"),n={id:i,content:""};t.is("th")?n.cellType="head":n.cellType="data";var s=t.attr("colspan");s&&(n.colspan=parseInt(s,10));var r=t.attr("rowspan");return r&&(n.rowspan=parseInt(r,10)),n.content=e.annotatedText(t,[i,"content"]),n},r["static"].toHtml=function(t,e){var i=t.id,s="head"===t.cellType?"th":"td",r=n("<"+s+">").attr("id","id").append(e.annotatedText([i,"content"]));return r},Object.defineProperties(r.prototype,{isData:{get:function(){return"data"===this.cellType}}}),e.exports=r},{"../../model/DocumentNode":67,"../../util/jquery":316}],268:[function(t,e,i){"use strict";function n(){a.apply(this,arguments),this.context.surface.connect(this,{"selection:changed":this.onSelectionChange})}var s=t("../../util/helpers"),r=t("../../util/jquery"),o=t("../../util/oo"),a=t("../../ui/Component"),l=t("../../ui/TextPropertyComponent"),u=t("../../model/TableSelection"),c=a.$$;n.Prototype=function(){this.dispose=function(){this.context.surface.disconnect(this)},this.getInitialState=function(){return{mode:"table"}},this.render=function(){var t=c("table").addClass("content-node table").attr({"data-id":this.props.node.id,contentEditable:!1});return"table"===this.state.mode?t.addClass("table-editing-mode"):"cell"===this.state.mode&&t.addClass("cell-editing-mode"),this.props.node.getMatrix(),t.append(this.renderTableContent()),t},this.renderTableContent=function(){var t=[];return s.each(this.props.node.getSections(),function(e){var i=c("t"+e.sectionType).key(e.id);s.each(e.getRows(),function(t){var e=c("tr").attr({"data-id":t.id,contentEditable:!1});s.each(t.getCells(),function(t){var i=c("head"===t.cellType?"th":"td").attr({"data-id":t.id,"data-row":t.rowIdx,"data-col":t.colIdx}).on("mousedown",this.onMouseDown).on("doubleclick",this.onDoubleClick);t.colspan&&i.attr("colspan",t.colspan),t.rowspan&&i.attr("rowspan",t.rowspan),"cell"===this.state.mode&&t.rowIdx===this.state.row&&t.colIdx===this.state.col&&i.attr("contentEditable",!0),i.append(c(l,{path:[t.id,"content"]})),e.append(i)},this),i.append(e)},this),t.push(i)},this),t},this.onDoubleClick=function(t){t.preventDefault(),t.stopPropagation();var e=this.context.surface,i=r(t.currentTarget),n=i.data("id");this.setState({mode:"cell",cellId:n,row:i.data("row"),col:i.data("col")},function(){var t=e.getDocument(),i=[n,"content"],s=t.get(i);e.setSelection({type:"property",path:i,startOffset:s.length})})},this.onMouseDown=function(t){var e=this.$el,i=this.context.surface,n=i.getDocument(),s=this.props.node.id,o=this,a=r(t.currentTarget);if("cell"!==this.state.mode||this.state.cellId!==a.data("id")){t.preventDefault(),t.stopPropagation();var l=a,c=a,h=new u.Rectangle(l.data("row"),l.data("col"),c.data("row"),c.data("col")),p=function(t){c=r(t.currentTarget),h=new u.Rectangle(l.data("row"),l.data("col"),c.data("row"),c.data("col")),o._updateSelection(h)};e.on("mouseenter","th,td",p),r(window).one("mouseup",function(t){t.stopPropagation(),t.preventDefault(),e.off("mouseenter","th,td",p);var r=n.createSelection({type:"table",tableId:s,rectangle:h});i.setSelection(r)})}},this.onSelectionChange=function(t){var e=this.props.node,i=e.id;if(this.hasSelection&&this._clearSelection(),"cell"===this.state.mode){if(!t.isPropertySelection()||t.start.path[0]!==this.state.cellId){var n=this;this.setState({mode:"table"},function(){t.isTableSelection()&&t.getTableId()===i&&n._updateSelection(t.rectangle)})}}else t.isTableSelection()&&t.getTableId()===i&&this._updateSelection(t.rectangle)},this._updateSelection=function(t){var e=this.$el,i=e.find("th,td");i.each(function(){var e=r(this),i=e.data("row"),n=e.data("col");i>=t.start.row&&i<=t.end.row&&n>=t.start.col&&n<=t.end.col?e.addClass("selected"):e.removeClass("selected")}),this.hasSelection=!0},this._clearSelection=function(){var t=this.$el,e=t.find("th,td");e.removeClass("selected"),this.hasSelection=!1}},o.inherit(n,a),e.exports=n},{"../../model/TableSelection":77,"../../ui/Component":279,"../../ui/TextPropertyComponent":302,"../../util/helpers":315,"../../util/jquery":316,"../../util/oo":317}],269:[function(t,e,i){function n(t){this.tableNode=t,this._matrix=null,this._rowNodes=null}var s=t("../../util/oo");n.Prototype=function(){this.invalidate=function(){this._matrix=null,this._rowNodes=null},this.update=function(){var t,e,i,s,r,o,a,l,u=[],c=[],h=this.tableNode.getIterator(),p=-1,d=-1;for(h.onNewRow=function(t){p++,d=-1,u[p]=u[p]||[],c.push(t)};null!==(t=h.next());){for(d++;u[p][d];)d++;if(e=new n.Cell(t,p,d),t.rowIdx=p,t.colIdx=d,u[p][d]=e,i=t.getSpan("row"),s=t.getSpan("col"),1!==i||1!==s)for(r=0;i>r;r++)for(o=0;s>o;o++)(0!==r||0!==o)&&(a=p+r,l=d+o,u[a]=u[a]||[],u[a][l]=new n.Placeholder(e,a,l))}this._matrix=u,this._rowNodes=c},this.getCell=function(t,e){var i=this.getMatrix();return i[t][e]},this.getColumn=function(t){var e,i,n=this.getMatrix();for(e=[],i=0;i<n.length;i++)e.push(n[i][t]);return e},this.getRow=function(t){var e=this.getMatrix();return e[t]},this.getRowNode=function(t){var e=this.getRowNodes();return e[t]},this.getMatrix=function(){return this._matrix||this.update(),this._matrix},this.getRowNodes=function(){return this._rowNodes||this.update(),this._rowNodes},this.getRectangle=function(t,e){var i,s,r,o,a,l;return(i=this.lookupCell(t))?(s=t===e?i:this.lookupCell(e),r=Math.min(i.row,s.row),o=Math.max(i.row,s.row),a=Math.min(i.col,s.col),l=Math.max(i.col,s.col),new n.Rectangle(r,a,o,l)):null},this.getCellsForRectangle=function(t){var e,i,n,s,r;for(n=[],s={},e=t.start.row;e<=t.end.row;e++)for(i=t.start.col;i<=t.end.col;i++)r=this.getCell(e,i),"placeholder"===r.type&&(r=r.owner),s[r.key]||(n.push(r),s[r.key]=!0);return n},this.getBoundingRectangle=function(t){var e,i,s;if(t=n.Rectangle.copy(t),e=this.getCellsForRectangle(t),!e||0===e.length)return null;for(s=0;s<e.length;s++)i=e[s],t.start.row=Math.min(t.start.row,i.row),t.start.col=Math.min(t.start.col,i.col),t.end.row=Math.max(t.end.row,i.row+i.node.getSpan("row")-1),t.end.col=Math.max(t.end.col,i.col+i.node.getSpan("col")-1);return t},this.getSize=function(){var t=this.getMatrix();return 0===t.length?{rows:0,cols:0}:{rows:t.length,cols:t[0].length}},this.lookupCell=function(t){var e,i,n,s,r=this.getMatrix(),o=this.getRowNodes();if(e=o.indexOf(t.parent),0>e)return null;for(n=null,s=r[e],i=0;i<s.length&&(n=s[i],n.node!==t);i++);return n},this.findClosestCell=function(t){var e,i,n=this.getMatrix();for(i=n[t.row],e=t.col;e>=0;e--)if("cell"===i[e].type)return i[e];for(e=t.col+1;e<i.length;e++)if("cell"===i[e].type)return i[e];return null}},s.initClass(n),n.Cell=function(t,e,i){this.type="cell",this.node=t,this.row=e,this.col=i,this.key=e+"_"+i},n.Cell.sortDescending=function(t,e){return t.row!==e.row?e.row-t.row:e.col-t.col},n.Placeholder=function(t,e,i){n.Cell.call(this,t.node,e,i),this.type="placeholder",this.owner=t},s.inherit(n.Placeholder,n.Cell),n.Rectangle=function(t,e,i,n){this.start={row:t,col:e},this.end={row:i,col:n}},n.Rectangle.copy=function(t){return new n.Rectangle(t.start.row,t.start.col,t.end.row,t.end.col)},e.exports=n},{"../../util/oo":317}],270:[function(t,e,i){"use strict";var n=t("../../util/helpers"),s=t("../../util/jquery"),r=t("../../model/DocumentNode"),o=t("../../model/ParentNodeMixin"),a=r.extend(o.prototype,{displayName:"TableRow",name:"table-row",properties:{parent:"id",cells:["array","id"]},didInitialize:function(){o.call(this,"cells")},getCells:function(){var t=this.getDocument();return n.map(this.cells,function(e){return t.get(e)},this)},getCellAt:function(t){var e=this.getDocument(),i=this.cells[t];return i?e.get(i):null}});a["static"].components=["cells"],a["static"].defaultProperties={cells:[]},a["static"].matchElement=function(t){return t.is("tr")},a["static"].fromHtml=function(t,e){var i=e.defaultId(t,"tr"),n={id:i,cells:[]};return t.find("th,td").each(function(){var t=s(this),r=e.convertElement(t,{parent:i});n.cells.push(r.id)}),n},a["static"].toHtml=function(t,e){var i=t.id,r=s("<tr>").attr("id",i);return n.each(t.getCells(),function(t){r.append(t.toHtml(e))}),r},Object.defineProperties(a.prototype,{cellNodes:{get:function(){return this.getCells()}}}),e.exports=a},{"../../model/DocumentNode":67,"../../model/ParentNodeMixin":72,"../../util/helpers":315,"../../util/jquery":316}],271:[function(t,e,i){"use strict";var n=t("../../util/helpers"),s=t("../../util/jquery"),r=t("../../model/DocumentNode"),o=t("../../model/ParentNodeMixin"),a=r.extend(o.prototype,{displayName:"TableSection",name:"table-section",properties:{parent:"id",rows:["array","id"],sectionType:"string"},didInitialize:function(){o.call(this,"rows")},getRows:function(){var t=this.getDocument();return n.map(this.rows,function(e){return t.get(e)},this)},getRowAt:function(t){var e=this.getDocument(),i=this.rows[t];return i?e.get(i):null}});a["static"].components=["rows"],a["static"].defaultProperties={sectionType:"tbody",rows:[]},a["static"].matchElement=function(t){return t.is("thead, tbody, tfoot")},a["static"].fromHtml=function(t,e){var i=t[0].tagName.toLowerCase(),n=i.substring(1),r=e.defaultId(t,i),o={id:r,sectionType:n,rows:[]};return t.find("tr").each(function(){var t=s(this),i=e.convertElement(t,{parent:r});o.rows.push(i.id)}),o},a["static"].toHtml=function(t,e){var i=t.id,r=s("<t"+t.sectionType+">").attr("id",i);return n.each(t.getRows(),function(t){r.append(t.toHtml(e))}),r},Object.defineProperties(a.prototype,{cellNodes:{get:function(){return this.getCells()}}}),e.exports=a},{"../../model/DocumentNode":67,"../../model/ParentNodeMixin":72,"../../util/helpers":315,"../../util/jquery":316}],272:[function(t,e,i){"use strict";var n=t("../../util/oo"),s=t("../../ui/SurfaceCommand"),r=t("../../util/helpers"),o=function(t){s.call(this,t)};o.Prototype=function(){this["static"]={name:"switchTextType"},this.getSelection=function(){return this.getSurface().getSelection()},this.getNodeData=function(){return this.constructor["static"].nodeData},this.getTextTypeName=function(){return this.constructor["static"].textTypeName},this.getTextCommands=function(){var t=this.getSurface();return t.getTextCommands()},this.isTextType=function(t){var e=!1,i=this.getTextCommands();return r.each(i,function(i){i.constructor["static"].nodeData.type===t&&(e=!0)}),e},this.getContext=function(t,e){return t.id===e[0]?e[1]:t.type},this.getCommandName=function(t){if(this.isTextType(t.type)){var e="make"+r.capitalize(t.type);return"heading"===t.type&&(e+=t.level),e}},this.getCommandState=function(){var t=this.getSelection(),e=this.getSurface(),i={disabled:!1,sel:t};if(!e.isEnabled()||t.isNull())i.disabled=!0;else if(t.isTableSelection())i.disabled=!0,i.currentContext="table";else if(t.isContainerSelection())i.disabled=!0,i.currentContext="container";else{var n=this.getDocument(),s=t.getPath(),r=n.get(s[0]);if(r){var o,a=this.getCommandName(r),l=r.getRoot(),u=this.getContext(l,s),c=this.getTextCommands(),h=c[a];o=h?c[a].constructor["static"].textTypeName:u?u:"No selection",i.label=o,i.currentContext=u,i.currentCommand=a}else i.disabled=!0}return i},this.execute=function(){var t=this.getNodeData(),e=this.getSurface();return e.transaction(function(i,n){return n.data=t,e.switchType(i,n)}),t}},n.inherit(o,s),e.exports=o},{"../../ui/SurfaceCommand":299,"../../util/helpers":315,"../../util/oo":317}],273:[function(t,e,i){"use strict";function n(){a.apply(this,arguments),this.context.toolManager.registerTool(this)}var s=t("../../util/oo"),r=t("../../ui/Component"),o=r.$$,a=t("../../ui/SurfaceTool"),l=t("../../util/helpers");n.Prototype=function(){this["static"]={name:"switchTextType",command:"switchTextType"},this.getInitialState=function(){var t=this.context.toolManager.getCommandState(this);return t},this.getTextCommands=function(){var t=this.getSurface();return!this.textCommands&&t&&(this.textCommands=t.getTextCommands()),this.textCommands||{}},this.dispose=function(){this.context.toolManager.unregisterTool(this)},this.render=function(){var t=this.getTextCommands(),e=o("div").addClass("text-tool-component select");this.state.open&&e.addClass("open"),this.state.disabled&&e.addClass("disabled"),e.append(o("button").addClass("toggle small").attr("href","#").attr("title",this.props.title).append(this.state.label).on("click",this.toggleAvailableTextTypes));var i=o("div").addClass("options shadow border fill-white");return l.each(t,function(t,e){var n=o("button").addClass("option "+e).attr("data-type",e).append(t.constructor["static"].textTypeName).on("click",this.handleClick);i.append(n)},this),e.append(i),e},this.handleClick=function(t){t.preventDefault(),this.executeCommand(t.currentTarget.dataset.type)},this.executeCommand=function(t){this.getSurface().executeCommand(t)},this.toggleAvailableTextTypes=function(t){t.preventDefault(),t.stopPropagation(),this.state.disabled||this.toggleDropdown()},this.toggleDropdown=function(){this.extendState({open:!this.state.open})}},s.inherit(n,a),e.exports=n},{"../../ui/Component":279,"../../ui/SurfaceTool":301,"../../util/helpers":315,"../../util/oo":317}],274:[function(t,e,i){"use strict";var n=t("../util/oo"),s=t("./SurfaceCommand"),r=t("../model/documentHelpers"),o=t("../model/transform/createAnnotation"),a=t("../model/transform/fuseAnnotation"),l=t("../model/transform/expandAnnotation"),u=t("../model/transform/truncateAnnotation"),c=t("../model/transform/deleteAnnotation"),h=function(t){s.call(this,t)};h.Prototype=function(){this.getAnnotationType=function(){if(this.constructor["static"].annotationType)return this.constructor["static"].annotationType;throw new Error("Contract: AnnotationCommand.static.annotationType should be associated to a document annotation type.")},this.getAnnotationData=function(){return{}},this.isDisabled=function(t,e){if(e.isNull())return!0;var i=this.getAnnotationType(),n=this.getDocument();return!r.isContainerAnnotation(n,i)&&!e.isPropertySelection()},this.canEdit=function(){return!1},this.canCreate=function(t,e){return 0===t.length&&!e.isCollapsed()},this.canFuse=function(t,e){return t.length>=2&&!e.isCollapsed()},this.canDelete=function(t,e){if(1!==t.length)return!1;var i=t[0].getSelection();return e.isInsideOf(i)},this.canExpand=function(t,e){if(1!==t.length)return!1;var i=t[0].getSelection();return e.overlaps(i)&&!e.isInsideOf(i)},this.canTruncate=function(t,e){if(1!==t.length)return!1;var i=t[0].getSelection();return(e.isLeftAlignedWith(i)||e.isRightAlignedWith(i))&&!e.equals(i)&&!e.isCollapsed()},this.getAnnotationsForSelection=function(){var t=this.getSelection(),e=this.getDocument(),i=this.getContainerId(),n=this.getAnnotationType(),s=r.getAnnotationsForSelection(e,t,n,i);return s},this.execute=function(){var t=this.getAnnotationsForSelection(),e=this.getSelection();return this.isDisabled(t,e)?!1:this.canCreate(t,e)?this.executeCreate():this.canFuse(t,e)?this.executeFuse():this.canTruncate(t,e)?this.executeTruncate():this.canExpand(t,e)?this.executeExpand():this.canEdit(t,e)?this.executeEdit(t,e):this.canDelete(t,e)?this.executeDelete():!1},this.getCommandState=function(){var t=this.getSelection(),e=this.getAnnotationsForSelection(),i={disabled:!1,active:!1,mode:null};return this.isDisabled(e,t)?i.disabled=!0:this.canCreate(e,t)?i.mode="create":this.canFuse(e,t)?i.mode="fusion":this.canTruncate(e,t)?(i.active=!0,i.mode="truncate"):this.canExpand(e,t)?i.mode="expand":this.canEdit(e,t)?(i.mode="edit",i.annotationId=e[0].id,i.active=!0):this.canDelete(e,t)?(i.active=!0,i.mode="delete"):i.disabled=!0,i},this.applyTransform=function(t){var e,i=this.getSurface(),n=this.getSelection(),s=this;return n.isNull()?void 0:(i.transaction({selection:n},function(i,n){return n.annotationType=s.getAnnotationType(),n.annotationData=s.getAnnotationData(),n.splitContainerSelections=!1,n.containerId=s.getContainerId(),n=t(i,n),e=n.result,n}),e)},this.executeEdit=function(){var t=this.getAnnotationsForSelection();return{mode:"edit",anno:t[0],readyOnly:!0}},this.executeCreate=function(){var t=this.applyTransform(o);return{mode:"create",anno:t}},this.executeFuse=function(){var t=this.applyTransform(a);return{mode:"fuse",anno:t}},this.executeTruncate=function(){var t=this.applyTransform(u);return{mode:"truncate",anno:t}},this.executeExpand=function(){var t=this.applyTransform(l);return{mode:"expand",anno:t}},this.executeDelete=function(){var t=this.applyTransform(c);return{mode:"delete",annoId:t}}},n.inherit(h,s),e.exports=h},{"../model/documentHelpers":93,"../model/transform/createAnnotation":96,"../model/transform/deleteAnnotation":97,"../model/transform/expandAnnotation":101,"../model/transform/fuseAnnotation":102,"../model/transform/truncateAnnotation":109,"../util/oo":317,"./SurfaceCommand":299}],275:[function(t,e,i){"use strict";function n(){r.apply(this,arguments)}var s=t("../util/oo"),r=t("./Component"),o=r.$$;n.Prototype=function(){this.render=function(){var t=o("span").attr("data-id",this.props.node.id).addClass(this.getClassNames());return this.props.node.highlighted&&t.addClass("highlighted"),t.append(this.props.children),t},this.getClassNames=function(){var t=[];this.props.node.getTypeNames&&(t=this.props.node.getTypeNames());var e=t.join(" ");return this.props.classNames&&(e+=" "+this.props.classNames.join(" ")),e.replace(/_/g,"-")},this.didMount=function(){var t=this.props.node;t.connect(this,{highlighted:this.onHighlightedChanged})},this.dispose=function(){var t=this.props.node;t.disconnect(this)},this.onHighlightedChanged=function(){this.props.node.highlighted?this.$el.addClass("highlighted"):this.$el.removeClass("highlighted")}},s.inherit(n,r),e.exports=n},{"../util/oo":317,"./Component":279}],276:[function(t,e,i){"use strict";function n(){a.apply(this,arguments)}var s=t("../util/oo"),r=t("./Component"),o=r.$$,a=t("./SurfaceTool"),l=t("../util/helpers");n.Prototype=function(){this.render=function(){var t=this.props.title||l.capitalize(this.getName());this.state.mode&&(t=[l.capitalize(this.state.mode),t].join(" "));var e=o("button").attr("title",t).addClass("button tool").on("click",this.onClick);return this.state.disabled&&e.addClass("disabled"),this.state.active&&e.addClass("active"),this.state.mode&&e.addClass(this.state.mode),e.append(this.props.children),e}},s.inherit(n,a),e.exports=n},{"../util/helpers":315,"../util/oo":317,"./Component":279,"./SurfaceTool":301}],277:[function(t,e,i){"use strict";var n=t("../util/jquery"),s=t("../util/helpers"),r=t("../util/oo"),o=function(t,e,i){this.controller=t,this.htmlImporter=e,this.htmlExporter=i,this._contentDoc=null,this._contentText="",this._onKeyDown=s.bind(this.onKeyDown,this),this._onCopy=s.bind(this.onCopy,this),this._onCut=s.bind(this.onCut,this),this.isIe=-1!=window.navigator.userAgent.toLowerCase().indexOf("msie")||-1!=window.navigator.userAgent.toLowerCase().indexOf("trident"),this.isFF=window.navigator.userAgent.toLowerCase().indexOf("firefox")>-1,this.isIe?(this._beforePasteShim=s.bind(this.beforePasteShim,this),this._pasteShim=s.bind(this.pasteShim,this)):this._onPaste=s.bind(this.onPaste,this)};o.Prototype=function(){this.getSurface=function(){return this.controller.getFocusedSurface()},this.attach=function(t){this.el=window.document.createElement("div"),this.$el=n(this.el),this.$el.prop("contenteditable","true").addClass("clipboard"),t.appendChild(this.el),t.addEventListener("keydown",this._onKeyDown,!1),t.addEventListener("copy",this._onCopy,!1),t.addEventListener("cut",this._onCut,!1),this.isIe?(t.addEventListener("beforepaste",this._beforePasteShim,!1),t.addEventListener("paste",this._pasteShim,!1)):t.addEventListener("paste",this._onPaste,!1)},this.detach=function(t){this.$el.remove(),t.removeEventListener("keydown",this._onKeyDown,!1),t.removeEventListener("copy",this._onCopy,!1),t.removeEventListener("cut",this._onCut,!1),this.isIe?(t.removeEventListener("beforepaste",this._beforePasteShim,!1),t.removeEventListener("paste",this._pasteShim,!1)):t.removeEventListener("paste",this._onPaste,!1)},this.onCopy=function(t){if(this._copySelection(),t.clipboardData&&this._contentDoc){var e=this.htmlExporter.convert(this._contentDoc);this._contentDoc.__id__=s.uuid();var i=this._contentDoc.toJSON();i.__id__=this._contentDoc.__id__,t.clipboardData.setData("application/substance",JSON.stringify(i)),t.clipboardData.setData("text/plain",n(e).text()),t.clipboardData.setData("text/html",e),t.preventDefault()}},this.onCut=function(t){t.preventDefault(),this.onCopy(t);var e=this.getSurface();e&&e.transaction(function(t,i){return e["delete"](t,i)})},this.pasteSubstanceData=function(t){var e=this.getSurface();if(e){var i=e.getDocument(),n=i.newInstance();n._setForClipboard(!0),n.loadSeed(JSON.parse(t));var s="",r=n.get("clipboard_content");if(r.length>0){var o=r.getFirstPath(),a=r.getLastPath(),l=n.get(a).length,u=i.createSelection({type:"container",containerId:"clipboard_content",startPath:o,startOffset:0,endPath:a,endOffset:l});s=n.getTextForSelection(u)}e.transaction(function(t,i){return i.text=s,i.doc=n,e.paste(t,i)})}},this.pasteHtml=function(t){var e=this.getSurface();if(e){var i=e.getLogger(),s=e.getDocument();try{var r=s.newInstance();r._setForClipboard(!0),r.get("clipboard_content")||r.create({id:"clipboard_content",type:"container",nodes:[]}),this.htmlImporter.convert(n(t),r),e.transaction(function(i,n){return n.text=t.body.textContent,n.doc=r,e.paste(i,n)})}catch(o){console.error(o),i.error(o)}}},this.onPaste=function(t){var e=t.clipboardData,i=this.getSurface();if(i&&i.isNativeFocused){for(var r={},o=0;o<e.types.length;o++)r[e.types[o]]=!0;if(this.isFF&&!r["application/substance"]&&!r["text/html"])return this.beforePasteShim(),i.rerenderSelection(),void this.pasteShim();if(t.preventDefault(),t.stopPropagation(),r["application/substance"])return this.pasteSubstanceData(e.getData("application/substance"));if(r["text/html"]){var a=e.getData("text/html"),l=(new window.DOMParser).parseFromString(a,"text/html");if(this.htmlImporter.checkQuality(n(l)))return this.pasteHtml(l)}var u=e.getData("text/plain");if(i.isContainerEditor()){var c=i.getDocument(),h=c.getSchema().getDefaultTextType();i.transaction(function(t,e){var n=u.split(/\s*\n\s*\n/),r=c.newInstance();r._setForClipboard(!0);for(var o=r.create({type:"container",id:"clipboard_content",nodes:[]}),a=0;a<n.length;a++){var l=r.create({id:s.uuid(h),type:h,content:n[a]});o.show(l.id)}return e.doc=r,i.paste(t,e)})}else i.transaction(function(t,e){return e.text=u.split("").join(""),i.insertText(t,e)})}},this.beforePasteShim=function(){var t=this.getSurface();if(t){this.$el.focus();var e=document.createRange();e.selectNodeContents(this.el);var i=window.getSelection();i.removeAllRanges(),i.addRange(e)}},this.pasteShim=function(){this.$el.empty();var t=this,e=this.getSurface();if(e){var i=e.getSelection();setTimeout(function(){e.selection=i;var n=t.$el.html();n=["<html><head></head><body>",n,"</body></html>"].join(""),t.$el.empty();var s=(new window.DOMParser).parseFromString(n,"text/html");return t.pasteHtml(s)},0)}},this.onKeyDown=function(t){88===t.keyCode&&(t.metaKey||t.ctrlKey)||(86===t.keyCode&&(t.metaKey||t.ctrlKey)?this.handlePaste():67===t.keyCode&&(t.metaKey||t.ctrlKey))},this.handleCut=function(){var t=window.getSelection(),e=t.getRangeAt(0),i=e.cloneContents();this.el.innerHTML="",this.el.appendChild(i),this._copySelection();var n=this.getSurface();if(n){try{n["delete"]()}catch(s){return console.error(s),void this.logger.error(s)}var r=window.document.createRange();r.selectNodeContents(this.el),t.removeAllRanges(),t.addRange(r),window.setTimeout(function(){n.rerenderDomSelection()},10)}},this.handlePaste=function(){},this.handleCopy=function(){},this._copySelection=function(){var t=window.getSelection();this._contentText="",this._contentDoc=null;var e=this.getSurface(),i=e.getSelection(),n=e.getDocument();if(t.rangeCount>0&&!i.isCollapsed()){var s=t.getRangeAt(0);this._contentText=s.toString(),this._contentDoc=e.copy(n,i)}else this._contentDoc=null,this._contentText=""}},r.initClass(o),e.exports=o},{"../util/helpers":315,"../util/jquery":316,"../util/oo":317}],278:[function(t,e,i){"use strict";var n=t("../util/oo"),s=function(){};s.Prototype=function(){this.execute=function(){throw new Error("execute must be implemented by custom commands")}},n.initClass(s),e.exports=s},{"../util/oo":317}],279:[function(t,e,i){"use strict";function n(t,e){if(f.call(this),!t&&"root"!==t)throw new Error("Contract: every component needs to have a parent.");this.__id__=m++,e=e||{},this.refs={},this.parent=t,this.children=[],this.context=this._getContext(),this._ref=e._ref,this._htmlParams=u(e),this._setProps(e.props),this._setState(this.getInitialState()),this.actionHandlers={},this.$el=null,this.el=null,this._data={attributes:{},style:{},handlers:{},props:{},children:[]},this.didInitialize&&(console.warn("Component.didInitialize() has been deprecated. Use Component.initialize() instead."),this.didInitialize(this.props,this.state)),this.initialize()}function s(){this._ref=null,this.attributes={},this.htmlProps={},this.style={},this.handlers={},this.props={},this.children=[]}function r(t){s.call(this),this.type="element",this.tagName=t}function o(t){s.call(this),this.type="component",this.ComponentClass=t}var a,l,u,c=t("../util/jquery"),h=t("../util/oo"),p=t("../util/helpers"),d=t("./i18n"),f=t("../util/EventEmitter"),m=0;n.Prototype=function(){this.getChildContext=function(){return this.childContext||{}},this.initialize=function(t,e){},this.getInitialState=function(){return{}},this.getParent=function(){return"root"!==this.parent?this.parent:null},this.render=function(){return n.$$("div")},this.shouldRerender=function(t,e){return!0},this.rerender=function(){this._render(this.render())},this.triggerDidMount=function(t){t||(t=n.isMounted(this)),t&&(this.children.forEach(function(t){t.triggerDidMount(!0)}),this.__didMountTriggered__||(this.didMount(),this.__didMountTriggered__=!0))},this.didMount=function(){},this.unmount=function(){return this.triggerDispose(),this.$el.remove(),this.__didMountTriggered__=!1,this},this.isMounted=function(){return n.isMounted(this)},this.triggerDispose=function(){p.each(this.children,function(t){t.triggerDispose()}),this.dispose()},this.dispose=function(){},this.send=function(t){for(var e=this;e;){if(e.actionHandlers[t])return e.actionHandlers[t].apply(e,Array.prototype.slice.call(arguments,1));e=e.getParent()}throw new Error("No component handled action: "+t)},this.actions=function(t){p.each(t,function(t,e){var i=t.bind(this);this.actionHandlers[e]=i},this)},this.setState=function(t){var e=this.shouldRerender(this.getProps(),t);this.willUpdateState(t),this._setState(t),this.didUpdateState(),e&&this.rerender()},this.extendState=function(t){t=p.extend({},this.state,t),this.setState(t)},this.getState=function(){return this.state},this.willUpdateState=function(t){},this.didUpdateState=function(){},this.setProps=function(t){var e=this.shouldRerender(t,this.getState());this.willReceiveProps(t),this._setProps(t),this.didReceiveProps(),e&&this.rerender()},this.extendProps=function(t){var e=p.extend({},this.props,t);this.setProps(e)},this.getProps=function(){return this.props},this.willReceiveProps=function(t){},this.didReceiveProps=function(){},this.didRender=function(){},this.addClass=function(t){return this._data.addClass(t),this.$el&&this.$el.addClass(t),this},this.removeClass=function(t){return this._data.removeClass(t),this.$el&&this.$el.removeClass(t),this},this.toggleClass=function(t){return this._data.toggleClass(t),this.$el&&this.$el.toggleClass(t),this},this.attr=function(){return 1===arguments.length&&p.isString(arguments[0])?this.$el.attr(arguments[0]):(this._data.attr.apply(this._data,arguments),this.$el&&this.$el.attr.apply(this.$el,arguments),this)},this.removeAttr=function(){return this._data.removeAttr.apply(this._data,arguments),this.$el&&this.$el.removeAttr.apply(this.$el,arguments),this},this.val=function(t){return 0===arguments.length?this.$el.val():(this._data.val(t),void(this.$el&&this.$el.val(t)))},this.hasClass=function(t){return this.$el?this.$el.hasClass(t):!1},this.text=function(){return 0===arguments.length?this.$el?this.$el.text():"":(this.empty(),void this.append(arguments[0]))},this.htmlProp=function(){return 1===arguments.length&&p.isString(arguments[0])?this.$el.prop(arguments[0]):(this._data.htmlProp.apply(this._data,arguments),this.$el&&this.$el.prop.apply(this.$el,arguments),this)},this.removeHtmlProp=function(){return this._data.removeHtmlProp.apply(this._data,arguments),this.$el&&this.$el.removeProp.apply(this.$el,arguments),this},this.css=function(t){return 2===arguments.length?(this._data.css(arguments[0],arguments[1]),this.$el.css(arguments[0],arguments[1])):t&&(this._data.css(t),this.$el.css(t)),this},this.append=function(t){var e=this._compileComponent(t,{refs:this.refs});return this._data.append(t),this.$el.append(e.$el),this.children.push(e),e.triggerDidMount(),this},this.insertAt=function(t,e){var i=this._compileComponent(e,{refs:this.refs});return this._data.insertAt(t,e),t>this.children.length-1?(this.$el.append(i.$el),this.children.push(i)):(i.$el.insertBefore(this.children[t].$el),this.children.splice(t,0,i)),i.triggerDidMount(),this},this.removeAt=function(t){return this._data.removeAt(t),this.children[t].unmount(),this.children.splice(t,1),this},this.empty=function(){this._data.children=[],this.$el.empty();for(var t=0;t<this.children.length;t++)this.children[t].unmount();return this.children=[],this};var t=function(t){for(var e={},i=0;i<t.length;i++){var n=t[i],s=n._ref;s&&(e[s]=n)}return e};this._createElement=function(t,e){var i=c("<"+t.tagName+">");return i.addClass(this._htmlParams.classNames),i.addClass(t.classNames),i.attr(this._htmlParams.attributes),i.attr(t.attributes),i.prop(this._htmlParams.htmlProps),i.prop(t.htmlProps),i.css(this._htmlParams.style),t.style&&i.css(t.style),p.each(t.handlers,function(t,n){i.on(n,t.bind(e.owner))},this),i},this._updateElement=function(t,e,i){var n=this.$el,s=e.classNames,r=t.classNames;s!==r&&(n.removeClass(s),n.addClass(r));var o=e.attributes,a=t.attributes;if(!p.isEqual(o,a)){var l=Object.keys(o);n.removeAttr(l.join(" ")),n.attr(a)}var u=e.htmlProps,c=t.htmlProps;if(!p.isEqual(u,c)){var h=Object.keys(u);n.removeProp(h.join(" ")),n.prop(c)}return p.isEqual(e.style,t.style)||t.style&&n.css(t.style),p.isEqual(e.handlers,t.handlers)||(p.each(e.handlers,function(t,e){n.off(e)}),p.each(t.handlers,function(t,e){n.on(e,t.bind(i.owner))},this)),n},this._render=function(e,i){function s(t,e){t.triggerDispose(),t.$el.replaceWith(e.$el[0])}function r(t,e){if(t instanceof n.Container)t._render(e,i);else{var s=u(e);t._updateElement(s,t._htmlParams),t._htmlParams=s,t.setProps(e.props)}}if(!e)throw new Error("Nothing to render. Make sure your render method returns a virtual element: "+this.displayName);if("element"!==e.type){if(e instanceof c)throw new Error("Your render() method accidently return a jQuery instance instead of a VirtualComponent created $$.");throw new Error("Component.render() must return one html element: e.g., $$('div')")}i||(i={owner:this,refs:{}});var o=this._data;if(!this.$el)return this.$el=this._createElement(e,i),this.el=this.$el[0],void this._renderFromScratch(e,i);if(this._updateElement(e,o,i),this._no_refs_)return void this._renderFromScratch(e,i);var a=this.$el[0],l=n.isMounted(this),h=o.children,d=e.children;if(p.isEqual(h,d))return void(this._data=e);for(var f=t(o.children,"old"),m=t(e.children),g=0,b=0,y=0,v=this.children,_=[];b<h.length||y<d.length;){
var x=a.childNodes[g],C=h[b],w=d[y],S=null,T=v[b];if(!C){for(var E=y;E<d.length;E++)S=this._compileComponent(d[E],i),this.$el.append(S.$el),_.push(S),S.triggerDidMount(l);break}if(!w){for(var I=b;I<h.length;I++)v[I].unmount();break}if(x!==T.$el[0])throw new Error("Assertion failed: DOM structure is not as expected.");var N=w._ref,A=C._ref;if(A&&N)if(A===N)S=T,r(S,w),g++,b++,y++;else if(!f[N]&&m[A])S=this._compileComponent(w,i),S.$el.insertBefore(x),S.triggerDidMount(l),g++,y++;else{if(f[N]||m[A]){if(f[N]&&!m[A]){T.unmount(),b++;continue}throw f[N]&&m[A]?new Error("Swapping positions of persisted components not supported!"):new Error("Assertion failed: should not reach this statement.")}S=this._compileComponent(w,i),s(T,S),S.triggerDidMount(l),g++,y++,b++}else if(N){if(f[N]){T.unmount(),b++;continue}S=this._compileComponent(w,i),s(T,S),S.triggerDidMount(l),g++,b++,y++}else A?(S=this._compileComponent(w,i),m[A]?S.$el.insertBefore(x):(s(T,S),b++),S.triggerDidMount(l),g++,y++):("text"===w.type&&"text"===C.type&&w.props.text===C.props.text?S=T:(S=this._compileComponent(w,i),s(T,S),S.triggerDidMount(l)),g++,b++,y++);S._ref&&(i.refs[S._ref]=S),_.push(S)}Object.keys(i.refs).length>0?delete this._no_refs_:this._no_refs_=!0,this.children=_,this.refs=p.clone(i.refs),this._data=e,this.didRender()},this._renderFromScratch=function(t,e){for(var i=0;i<this.children.length;i++)this.children[i].unmount();for(var s=n.isMounted(this),r=[],o=0;o<t.children.length;o++)if(t.children[o]instanceof l)this.$el.html(t.children[o].html),r=[];else{var a=this._compileComponent(t.children[o],e);a.triggerDidMount(s),this.$el.append(a.$el),r.push(a)}Object.keys(e.refs).length>0?delete this._no_refs_:this._no_refs_=!0,this.refs=e.refs,this.children=r,this._data=t,this.didRender()},this._compileComponent=function(t,e){return n._render(t,{scope:e,context:this})},this._getContext=function(){var t=this.getParent();if(t){var e=p.extend({},t.context);return t.getChildContext?p.extend(e,t.getChildContext()):e}return{}},this._setProps=function(t){this.props=t||{},Object.freeze(this.props)},this._setState=function(t){this.state=t||{},Object.freeze(this.state)}},h.inherit(n,f),d.mixin(n),u=function(t){return{classNames:t.classNames||"",attributes:t.attributes||{},htmlProps:t.htmlProps||{},style:t.style||{}}},n.Root=function(t){n.call(this,"root",t)},h.inherit(n.Root,n),n.Container=function(t,e){n.call(this,t,e)},n.Container.Prototype=function(){},h.inherit(n.Container,n),n.HtmlElement=function(t,e,i){this.tagName=e,n.Container.call(this,t,i)},h.inherit(n.HtmlElement,n.Container),n.Text=function(t,e){n.call(this,t),this.text=e},n.Text.Prototype=function(){this._render=function(){if(this.$el)this.$el[0].textContent=this.text;else{var t=document.createTextNode(this.text);this.el=t,this.$el=c(t)}}},h.inherit(n.Text,n),s.Prototype=function(){this.key=function(t){return console.info("DEPRECATED: Use ref instead. Note that when you assign a ref, the component do incremental rerendering."),this.ref(t)},this.ref=function(t){return this._ref=t,this},this.append=function(){var t,e=this._getChildren();if(1===arguments.length){var i=arguments[0];if(!i)return this;p.isArray(i)?(t=i,n.$$.prepareChildren(t),Array.prototype.push.apply(e,t)):p.isString(i)?e.push(new a(i)):e.push(i)}else t=Array.prototype.slice.call(arguments,0),n.$$.prepareChildren(t),Array.prototype.push.apply(e,t);return this},this._getChildren=function(){return this.children},this.insertAt=function(t,e){return this.children.splice(t,0,e),this},this.removeAt=function(t){return this.children.splice(t,1),this},this.addClass=function(t){return this.classNames||(this.classNames=""),this.classNames+=" "+t,this},this.removeClass=function(t){this.classNames||(this.classNames="");var e=this.classNames.split(/\s+/);return e=p.without(e,t),this.classNames=e.join(" "),this},this.toggleClass=function(t){var e=this.classNames.split(/\s+/);return e.indexOf(t)>=0?e=p.without(e,t):e.push(t),this.classNames=e.join(" "),this},this.addProps=function(t){return console.log("DEPRECATED: Use setProps() or extendProps()"),p.extend(this.props,t),this},this.setProps=function(t){return this.props=t,this},this.extendProps=function(t){return p.extend(this.props,t),this},this.attr=function(t){return 2===arguments.length?this.attributes[arguments[0]]=arguments[1]:p.extend(this.attributes,t),this},this.removeAttr=function(t){return p.isString(t)?delete this.attributes[t]:this.attributes=p.omit(this.attributes,t),this},this.htmlProp=function(t){return 2===arguments.length?this.htmlProps[arguments[0]]=arguments[1]:p.extend(this.htmlProps,t),this},this.removeHtmlProp=function(){return p.isString(arguments[0])?delete this.htmlProps[arguments[0]]:this.htmlProps=p.omit(this.htmlProps,arguments[0]),this},this.val=function(t){return this.htmlProps.value=t,this},this.on=function(t,e){if(2!==arguments.length||!p.isString(t)||!p.isFunction(e))throw new Error("Illegal arguments for $$.on(event, handler).");return this.handlers[t]=e,this},this.off=function(t,e){if(2!==arguments.length||!p.isString(t)||!p.isFunction(e))throw new Error("Illegal arguments for $$.on(event, handler).");return delete this.handlers[t],this},this.css=function(t){return this.style||(this.style={}),2===arguments.length?this.style[arguments[0]]=arguments[1]:p.extend(this.style,t),this},this.html=function(t){return this.children=[],this.children.push(new l(t)),this},this._render=function(){return n._render(this)}},h.initClass(s),h.inherit(r,s),o.Prototype=function(){this._getChildren=function(){return this.props.children||(this.props.children=[]),this.props.children}},h.inherit(o,s),a=function(t){s.call(this),this.type="text",this.props={text:t}},l=function(t){this.type="html",this.html=t},n.$$=function(){var t=null;if(p.isString(arguments[0])){if(1!==arguments.length)throw new Error("Illegal usage of Component.$$.");t=new r(arguments[0])}else{if(!(p.isFunction(arguments[0])&&arguments[0].prototype instanceof n))throw void 0===arguments[0]?new Error("Provided Component was undefined."):new Error("Illegal usage of Component.$$.");if(arguments.length<1||arguments.length>2)throw new Error("Illegal usage of Component.$$.");t=new o(arguments[0]),2===arguments.length&&t.setProps(arguments[1])}return t},n.$$.prepareChildren=function(t){for(var e=0;e<t.length;e++)p.isString(t[e])&&(t[e]=new a(t[e]))},n._render=function(t,e){var i;e=e||{};var s=e.scope||{context:null,refs:{}},r=e.context||"root";switch(t.type){case"text":i=new n.Text(r,t.props.text),i._render();break;case"element":i=new n.HtmlElement(r,t.tagName,t),i._render(t,s);break;case"component":i=new t.ComponentClass(r,t),i._render(i.render());break;case"html":throw new Error("$$.html() can not be used in combination with other composition methods.");default:throw new Error("Unsupported component type: "+t.type)}return t._ref&&(s.refs[t._ref]=i),i},n.mount=function(t,e){if(t instanceof o)t=n._render(t);else{if(!(t instanceof n))throw new Error("component must be of type Component or VirtualComponent");t._render(t.render())}if(!e)throw new Error("An element is needed for mounting.");return c(e).append(t.$el),t.triggerDidMount(),t},n.isMounted=function(t){var e;if(!t.$el)return!1;for(e=t.$el[0];e;){if(9===e.nodeType)return!0;e=e.parentNode}return!1},n.VirtualTextNode=a,e.exports=n},{"../util/EventEmitter":310,"../util/helpers":315,"../util/jquery":316,"../util/oo":317,"./i18n":309}],280:[function(t,e,i){"use strict";function n(){a.apply(this,arguments)}var s=t("../util/oo"),r=t("../util/helpers"),o=t("./Component"),a=t("./ContainerEditor"),l=o.$$;n.Prototype=function(){this.render=function(){var t=this.getDocument(),e=t.get(this.props.containerId),i=l("div").addClass("surface container-node "+e.id).attr({spellCheck:!1,"data-id":e.id,contenteditable:!1});return r.each(e.nodes,function(t){i.append(this._renderNode(t))},this),i}},s.inherit(n,a),e.exports=n},{"../util/helpers":315,"../util/oo":317,"./Component":279,"./ContainerEditor":281}],281:[function(t,e,i){"use strict";function n(){a.apply(this,arguments),this.textPropertyManager.dispose();var t=this.getDocument();if(!r.isString(this.props.containerId))throw new Error("Illegal argument: Expecting containerId.");this.editingBehavior=new c,this.textPropertyManager=new u(t,this.props.containerId),t.connect(this,{"document:changed":this.onDocumentChange})}var s=t("../util/oo"),r=t("../util/helpers"),o=t("./Component"),a=t("./FormEditor"),l=t("./UnsupportedNode"),u=t("../model/TextPropertyManager"),c=t("../model/EditingBehavior"),h=t("../model/transform/deleteSelection"),p=t("../model/transform/breakNode"),d=t("../model/transform/insertNode"),f=t("../model/transform/switchTextType"),m=t("../model/transform/paste"),g=o.$$;n.Prototype=function(){this.dispose=function(){a.prototype.dispose.call(this);var t=this.getDocument();t.disconnect(this)},this.render=function(){var t=this.getDocument(),e=t.get(this.props.containerId),i=g("div").addClass("surface container-node "+e.id).attr({spellCheck:!1,"data-id":e.id,contenteditable:!0});return r.each(e.nodes,function(t){i.append(this._renderNode(t))},this),i},this.onDocumentChange=function(t){if(t.isAffected([this.props.containerId,"nodes"]))for(var e=0;e<t.ops.length;e++){var i=t.ops[e];if("update"===i.type&&i.path[0]===this.props.containerId){var n=i.diff;"insert"===n.type?this._insertNodeAt(n.getOffset(),n.getValue()):"delete"===n.type&&this._removeNodeAt(n.getOffset())}}},this._insertNodeAt=function(t,e){var i=this._renderNode(e);this.insertAt(t,i)},this._removeNodeAt=function(t){this.removeAt(t)},this._renderNode=function(t){var e=this.getDocument(),i=e.get(t),n=this.context.componentRegistry,s=n.get(i.type);return s||(console.error("Could not resolve a component for type: "+i.type),s=l),g(s,{doc:e,node:i})},this.extendBehavior=function(t){t.register(this.editingBehavior)},this.isContainerEditor=function(){return!0},this.getContainerId=function(){return this.props.containerId},this.getContainer=function(){return this.getDocument().get(this.getContainerId())},this["delete"]=function(t,e){return this._prepareArgs(e),h(t,e)},this["break"]=function(t,e){return this._prepareArgs(e),e.selection.isPropertySelection()||e.selection.isContainerSelection()?p(t,e):void 0},this.insertNode=function(t,e){return this._prepareArgs(e),e.selection.isPropertySelection()||e.selection.isContainerSelection()?d(t,e):void 0},this.switchType=function(t,e){return this._prepareArgs(e),e.selection.isPropertySelection()?f(t,e):void 0},this.selectAll=function(t){var e=t.get(this.containerId),i=e.getFirstPath(),n=e.getLastPath(),s=t.get(n);return t.createSelection({type:"container",containerId:this.containerId,startPath:i,startOffset:0,endPath:n,endOffset:s.length})},this.paste=function(t,e){return this._prepareArgs(e),e.selection.isPropertySelection()||e.selection.isContainerSelection()?m(t,e):void 0},this._prepareArgs=function(t){t.containerId=this.getContainerId(),t.editingBehavior=this.editingBehavior}},s.inherit(n,a),e.exports=n},{"../model/EditingBehavior":69,"../model/TextPropertyManager":79,"../model/transform/breakNode":94,"../model/transform/deleteSelection":100,"../model/transform/insertNode":103,"../model/transform/paste":106,"../model/transform/switchTextType":108,"../util/helpers":315,"../util/oo":317,"./Component":279,"./FormEditor":289,"./UnsupportedNode":308}],282:[function(t,e,i){"use strict";function n(){u.apply(this,arguments);var t=this.getDocument();t.connect(this,{"document:changed":this.onDocumentChange,"toc:entry-selected":this.onTocEntrySelected,"highlights:updated":this.onHighlightsUpdated},-1)}var s=t("../util/jquery"),r=t("../util/helpers"),o=t("../util/oo"),a=t("./Component"),l=a.$$,u=t("./Panel"),c=t("./Scrollbar");n.Prototype=function(){this.dispose=function(){var t=this.getDocument();t.disconnect(this)},this.getDocument=function(){return this.context.controller.getDocument()},this.render=function(){var t=this.context.controller,e=this.getDocument(),i=l("div").addClass("panel content-panel-component");return i.append(l(c,{panel:this,contextId:t.state.contextId,highlights:e.getHighlights()}).ref("scrollbar").attr("id","content-scrollbar")),i.append(l("div").ref("scanline").addClass("scanline")),i.append(l("div").ref("panelContent").addClass("panel-content").append(l("div").addClass("panel-content-inner").append(this.props.children)).on("scroll",this.onScroll)),i},this.onHighlightsUpdated=function(t){var e=this.context.controller;this.refs.scrollbar.extendProps({highlights:t,contextId:e.state.contextId})},this.onDocumentChange=function(){this.refs.scrollbar.updatePositions()},this.onTocEntrySelected=function(t){this.scrollToNode(t)},this.onScroll=function(){this.markActiveTOCEntry()},this.markActiveTOCEntry=function(){var t=this.refs.panelContent.$el,e=this.getContentHeight(),i=this.getPanelHeight(),n=this.getScrollPosition(),o=n+i,a=n,l=2*o-e,u=Math.max(a,l);s(".scanline").css({top:u-n+"px"});var c=t.find(".content-node.heading");if(0!==c.length){var h=r.first(c).dataset.id;c.each(function(){u>=s(this).position().top&&(h=this.dataset.id)});var p=this.getDocument();p.emit("toc:entry-focused",h)}}},o.inherit(n,u),e.exports=n},{"../util/helpers":315,"../util/jquery":316,"../util/oo":317,"./Component":279,"./Panel":290,"./Scrollbar":295}],283:[function(t,e,i){"use strict";function n(){a.apply(this,arguments)}var s=t("../util/jquery"),r=t("../util/helpers"),o=t("../util/oo"),a=t("./Component"),l=a.$$;n.Prototype=function(){this.render=function(){var t=this.props.panelOrder,e=this.props.contextId,i=l("div").addClass("sc-context-toggles");return r.each(t,function(t){var n=l("a").addClass("se-context-toggle").attr({href:"#","data-id":t}).on("click",this.onContextToggleClick);t===e&&n.addClass("sm-active"),n.append(l("span").addClass("label").append(" "+this.i18n.t(t))),i.append(n)},this),i},this.onContextToggleClick=function(t){t.preventDefault();var e=s(t.currentTarget).attr("data-id");this.send("switchContext",e)}},o.inherit(n,a),e.exports=n},{"../util/helpers":315,"../util/jquery":316,"../util/oo":317,"./Component":279}],284:[function(t,e,i){"use strict";function n(){if(o.apply(this,arguments),!this.props.doc)throw new Error("Controller requires a Substance document instance");this.surfaces={},this.focusedSurface=null,this.stack=[],this.logger=new c;var t=this.getConfig();this._initializeComponentRegistry(t.controller.components),this._initializeCommandRegistry(t.controller.commands),this.clipboard=new a(this,this.props.doc.getClipboardImporter(),this.props.doc.getClipboardExporter()),this.toolManager=new l(this),this._initialize(this.props),this.handleStateUpdate(this.state)}var s=t("../util/oo"),r=t("../util/helpers"),o=t("./Component"),a=t("./Clipboard"),l=t("./ToolManager"),u=t("../util/Registry"),c=t("../util/Logger"),h=t("../model/Selection"),p=t("./i18n");p.instance.load(t("../i18n/en")),n.Prototype=function(){this.didMount=function(){this.$el.on("keydown",this.handleApplicationKeyCombos),this.clipboard.attach(this.$el[0])},this.dispose=function(){this.$el.off("keydown"),this.props.doc&&this._dispose()},this._dispose=function(){this.props.doc.disconnect(this),this.clipboard.detach(this.$el[0])},this.willReceiveProps=function(t){this.props.doc&&t.doc!==this.props.doc&&(this._dispose(),this.empty(),this._initialize(t))},this._initialize=function(t){var e=t.doc;e.connect(this,{"document:changed":this.onDocumentChanged,"transaction:started":this.onTransactionStarted},{priority:-20})},this.getConfig=function(){return this.constructor["static"].config||this.props.config},this.getChildContext=function(){return{config:this.getConfig(),controller:this,componentRegistry:this.componentRegistry,toolManager:this.toolManager,i18n:p.instance}},this.getToolManager=function(){return this.toolManager},this._initializeComponentRegistry=function(t){var e=new u;r.each(t,function(t,i){e.add(i,t)}),this.componentRegistry=e},this._initializeCommandRegistry=function(t){var e=new u;r.each(t,function(t){var i=new t(this);e.add(t["static"].name,i)},this),this.commandRegistry=e},this.getCommand=function(t){return this.commandRegistry.get(t)},this.executeCommand=function(t){var e=this.getCommand(t);if(!e)return void console.warn("command",t,"not registered on controller");var i=e.execute();i?this.emit("command:executed",i,t,e):void 0===i&&console.warn("command ",t,"must return either an info object or true when handled or false when not handled")},this.getLogger=function(){return this.logger},this.getClipboard=function(){return this.clipboard},this.getDocument=function(){return this.props.doc},this.getSurface=function(t){return t?this.surfaces[t]:(console.warn("Deprecated: Use getFocusedSurface. Always provide a name for getSurface otherwise."),this.getFocusedSurface())},this.getFocusedSurface=function(){return this.focusedSurface},this.getSelection=function(){var t=this.getSurface();return t?t.getSelection():h.nullSelection},this.getContainerId=function(){var t=this.getSurface();return t?t.getContainerId():void 0},this.registerSurface=function(t){t.connect(this,{"selection:changed":this._onSelectionChanged,"command:executed":this._onCommandExecuted}),this.surfaces[t.getName()]=t},this.unregisterSurface=function(t){t.disconnect(this),delete this.surfaces[t.getName()],t&&this.focusedSurface===t&&(this.focusedSurface=null)},this.hasSurfaces=function(){return Object.keys(this.surfaces).length>0},this.didFocus=function(t){this.focusedSurface&&t!==this.focusedSurface&&this.focusedSurface.setFocused(!1),this.focusedSurface=t},this.transaction=function(){var t=this.getFocusedSurface();if(!t)throw new Error("No focused surface!");t.transaction.apply(t,arguments)},this.onTransactionStarted=function(t){},this.handleApplicationKeyCombos=function(t){var e=!1;return 27===t.keyCode?(this.setState(this.getInitialState()),e=!0):83===t.keyCode&&(t.metaKey||t.ctrlKey)&&(this.executeCommand("save"),e=!0),e?(t.preventDefault(),t.stopPropagation(),!0):void 0},this.handleStateUpdate=function(){},this.willUpdateState=function(t){this.handleStateUpdate(t)},this.onDocumentChanged=function(t,e){if(e.replay){var i=t.after.selection,n=t.after.surfaceId;if(n){var s=this.surfaces[n];s?(this.focusedSurface!==s&&this.didFocus(s),s.setSelection(i)):console.warn("No surface with name",n)}t.after.state&&this.setState(t.after.state)}var r=this.getDocument();r.__dirty=!0;var o=this.getLogger();o.info("Unsaved changes")},this.onSelectionChanged=function(t,e){},this.onCommandExecuted=function(t,e,i){},this._onSelectionChanged=function(t,e){this.emit("selection:changed",t,e),this.onSelectionChanged(t,e)},this._onCommandExecuted=function(t,e,i){this.emit("command:executed",t,e,i),this.onCommandExecuted(t,e,i)},this.pushState=function(){var t={surface:this.focusedSurface,selection:null};this.focusedSurface&&(t.selection=this.focusedSurface.getSelection()),this.focusedSurface=null,this.stack.push(t)},this.popState=function(){var t=this.stack.pop();t&&t.surface&&(t.surface.setFocused(!0),t.surface.setSelection(t.selection))},this.saveDocument=function(){var t=this.getDocument(),e=this.getLogger();if(t.__dirty&&!t.__isSaving)if(e.info("Saving ..."),t.__isSaving=!0,this.props.onSave){var i=[];this.props.onSave(t,i,function(i){t.__isSaving=!1,i?e.error(i.message||i.toString()):(t.__dirty=!1,this.emit("document:saved"),e.info("No changes"))}.bind(this))}else e.error("Document saving is not handled at the moment. Make sure onSave is passed in the props")},this.render=function(){throw new Error("Controller.prototype.render is abstract. You need to define your own controller component")}},s.inherit(n,o),e.exports=n},{"../i18n/en":53,"../model/Selection":76,"../util/Logger":312,"../util/Registry":314,"../util/helpers":315,"../util/oo":317,"./Clipboard":277,"./Component":279,"./ToolManager":305,"./i18n":309}],285:[function(t,e,i){"use strict";var n=t("../util/oo"),s=t("./Command"),r=function(t){this.controller=t};r.Prototype=function(){this.getController=function(){return this.controller},this.getDocument=function(){return this.controller.getDocument()},this.execute=function(){throw new Error("execute must be implemented by custom commands")}},n.inherit(r,s),e.exports=r},{"../util/oo":317,"./Command":278}],286:[function(t,e,i){"use strict";function n(){if(o.apply(this,arguments),!this.context.controller)throw new Error("No controller context found.")}var s=t("../util/oo"),r=t("./Component"),o=t("./Tool"),a=r.$$;n.Prototype=function(){this.getDocument=function(){return this.context.controller.getDocument()},this.onClick=function(t){t.preventDefault(),this.state.disabled||this.performAction()},this.render=function(){var t=this.props.title||this.i18n.t(this.constructor["static"].name),e=a("button").attr("title",t).addClass("button tool").on("click",this.onClick);return this.state.disabled&&e.addClass("disabled"),this.state.active&&e.addClass("active"),this.state.mode&&e.addClass(this.state.mode),e.append(this.props.children),e}},s.inherit(n,o),e.exports=n},{"../util/oo":317,"./Component":279,"./Tool":304}],287:[function(t,e,i){"use strict";function n(){o.apply(this,arguments)}var s=t("../util/jquery"),r=t("../util/oo"),o=t("./Component"),a=o.$$;n.Prototype=function(){this.getInitialState=function(){return{open:!1}},this.render=function(){var t=a("div").addClass("dropdown");return this.state.open&&t.addClass("open"),t.append(a("button").ref("toggle").addClass("toggle").attr("title",this.props.title).append(this.props.label).on("click",this.handleDropdownToggle),a("div").ref("options").addClass("options shadow border fill-white").append(this.props.children)),t},this.handleClick=function(t){t.preventDefault()},this.handleDropdownToggle=function(t){t.preventDefault();var e=this.state.open,i=this;e||(this.setState({open:!this.state.open}),setTimeout(function(){s(window).one("click",function(t){i.close()})},0))},this.close=function(){this.setState({open:!1})}},r.inherit(n,o),e.exports=n},{"../util/jquery":316,"../util/oo":317,"./Component":279}],288:[function(t,e,i){"use strict";function n(){r.Container.apply(this,arguments)}var s=t("../util/oo"),r=t("./Component"),o=r.$$;n.Prototype=function(){this.render=function(){return o("i").addClass("fa "+this.props.icon)}},s.inherit(n,r.Container),e.exports=n},{"../util/oo":317,"./Component":279}],289:[function(t,e,i){"use strict";function n(){o.apply(this,arguments);var t=this.getDocument();this.textPropertyManager=new a(t)}var s=t("../util/oo"),r=t("../util/helpers"),o=t("./Surface"),a=t("../model/TextPropertyManager"),l=t("../model/transform/insertText"),u=t("../model/transform/deleteSelection"),c=t("../model/transform/copySelection"),h=t("./Component"),p=h.$$;n.Prototype=function(){this.dispose=function(){o.prototype.dispose.call(this)},this.isContainerEditor=function(){return!1},this.render=function(){var t=this.getDocument(),e=t.get(this.props.containerId),i=p("div").addClass("container-node "+e.id).attr({spellCheck:!1,"data-id":e.id,contenteditable:!0});return r.each(e.nodes,function(t){i.append(this._renderNode(t))},this),i},this.selectAll=function(t,e){var i=e;if(!i.isNull()&&i.isPropertySelection()){var n=i.start.path,s=t.get(n);return t.createSelection({type:"property",path:n,startOffset:0,endOffset:s.length})}},this.insertText=function(t,e){return e.selection.isPropertySelection()||e.selection.isContainerSelection()?l(t,e):void 0},this["delete"]=function(t,e){return u(t,e)},this["break"]=function(t,e){return this.softBreak(t,e)},this.softBreak=function(t,e){return e.text="\n",this.insertText(t,e)},this.copy=function(t,e){var i=c(t,{selection:e});return i.doc},this.paste=function(t,e){return e.text?this.insertText(t,e):void 0}},s.inherit(n,o),e.exports=n},{"../model/TextPropertyManager":79,"../model/transform/copySelection":95,"../model/transform/deleteSelection":100,"../model/transform/insertText":104,"../util/helpers":315,"../util/oo":317,"./Component":279,"./Surface":298}],290:[function(t,e,i){"use strict";function n(){o.apply(this,arguments)}var s=t("../util/jquery"),r=t("../util/oo"),o=t("./Component"),a=o.$$;n.Prototype=function(){this.render=function(){return a("div").addClass("panel").append(a("div").addClass("panel-content").append("YOUR_PANEL_CONTENT"))},this.getController=function(){return this.context.controller},this.getDocument=function(){return this.props.doc},this.getPanelContentElement=function(){return this.refs.panelContent.$el[0]},this.getScrollableContainer=function(){return this.refs.panelContent.$el[0]},this.getContentHeight=function(){var t=0,e=this.getPanelContentElement();return s(e).children().each(function(){t+=s(this).outerHeight()}),t},this.getPanelHeight=function(){var t=this.getPanelContentElement();return s(t).height()},this.getScrollPosition=function(){var t=this.getPanelContentElement();return s(t).scrollTop()},this.getPanelOffsetForElement=function(t){var e=s(t).position().top;return e},this.scrollToNode=function(t){var e=this.getScrollableContainer(),i=s(e).find("*[data-id="+t+"]")[0];i?s(e).scrollTop(this.getPanelOffsetForElement(i)):console.warn(t,"not found in scrollable container")}},r.inherit(n,o),e.exports=n},{"../util/jquery":316,"../util/oo":317,"./Component":279}],291:[function(t,e,i){"use strict";var n=t("./ControllerCommand"),s=n.extend({"static":{name:"redo"},getCommandState:function(){var t=this.getDocument();return{disabled:0===t.undone.length,active:!1}},execute:function(){var t=this.getDocument();return t.undone.length>0?(t.redo(),!0):!1}});e.exports=s},{"./ControllerCommand":285}],292:[function(t,e,i){"use strict";var n=t("./ControllerTool"),s=n.extend({"static":{name:"redo",command:"redo"}});e.exports=s},{"./ControllerTool":286}],293:[function(t,e,i){"use strict";var n=t("./ControllerCommand"),s=n.extend({"static":{name:"save"},getCommandState:function(){var t=this.getDocument();return{disabled:!t.__dirty,active:!1}},execute:function(){return this.getController().saveDocument(),{status:"saving-process-started"}}});e.exports=s},{"./ControllerCommand":285}],294:[function(t,e,i){"use strict";var n=t("./ControllerTool"),s=n.extend({"static":{name:"save",command:"save"}});e.exports=s},{"./ControllerTool":286}],295:[function(t,e,i){"use strict";function n(){o.apply(this,arguments),this.onMouseUp=this.onMouseUp.bind(this),this.onMouseMove=this.onMouseMove.bind(this)}var s=t("../util/jquery"),r=t("../util/oo"),o=t("./Component"),a=o.$$;n.Prototype=function(){this.didMount=function(){setTimeout(function(){this.updatePositions()}.bind(this)),s(window).on("resize",this.rerender.bind(this));var t=this.props.panel,e=t.getPanelContentElement();s(e).on("scroll",this.onScroll.bind(this))},this.dispose=function(){s(window).off("resize")},this.didRender=function(){this.isMounted()&&this.updatePositions()},this.render=function(){var t=a("div").addClass("scrollbar-component "+this.props.contextId).on("mousedown",this.onMouseDown);if(t.append(a("div").ref("thumb").addClass("thumb")),this.props.highlights){var e=this.props.highlights.map(function(t){return a("div").ref(t).addClass("highlight")});t.append(a("div").ref("highlights").addClass("highlights").append(e))}return t},this.onScroll=function(){this.updatePositions()},this.updatePositions=function(){var t=this.props.panel,e=t.getPanelContentElement(),i=t.getContentHeight(),r=t.getPanelHeight(),o=t.getScrollPosition();this.factor=i/r,this.refs.thumb.css({top:o/this.factor,height:r/this.factor}),this.props.highlights&&this.props.highlights.forEach(function(t){var i=s(e).find("*[data-id="+t+"]");if(i.length){var r=i.position().top/this.factor,o=i.outerHeight(!0)/this.factor;o<n.overlayMinHeight&&(o=n.overlayMinHeight);var a=this.refs[t];a?this.refs[t].css({top:r,height:o}):console.warn("no ref found for highlight",t)}}.bind(this))},this.onMouseDown=function(t){t.stopPropagation(),t.preventDefault(),this._mouseDown=!0,s(window).on("mousemove",this.onMouseMove),s(window).on("mouseup",this.onMouseUp);var e=this.$el.offset().top,i=t.pageY-e,n=this.refs.thumb.$el;t.target!==n[0]?(this.offset=n.height()/2,this.onMouseMove(t)):this.offset=i-n.position().top},this.onMouseUp=function(){this._mouseDown=!1,s(window).off("mousemove",this.onMouseMove),s(window).off("mouseup",this.onMouseUp)},this.onMouseMove=function(t){if(this._mouseDown){var e=this.props.panel,i=e.getPanelContentElement(),n=this.$el.offset().top,r=t.pageY-n,o=(r-this.offset)*this.factor;this.scrollTop=s(i).scrollTop(o)}}},r.inherit(n,o),n.overlayMinHeight=2,e.exports=n},{"../util/jquery":316,"../util/oo":317,"./Component":279}],296:[function(t,e,i){"use strict";var n=t("./SurfaceCommand"),s=n.extend({"static":{name:"selectAll"},execute:function(){var t=this.getSurface();if(t){var e=t.selectAll(t.getDocument(),t.getSelection());return t.setSelection(e),!0}return console.warn("selectAll command can not be applied since there is no focused surface"),!1}});e.exports=s},{"./SurfaceCommand":299}],297:[function(t,e,i){"use strict";function n(){r.apply(this,arguments);var t=this.context.controller,e=t.getLogger();e.connect(this,{"messages:updated":this.handleStatusUpdate})}var s=t("../util/oo"),r=t("./Component"),o=r.$$,a={error:"fa-exclamation-circle",info:"fa-info",progress:"fa-exchange",success:"fa-check-circle"};n.Prototype=function(){this.render=function(){var t=this.props.doc.getDocumentMeta(),e=t?t.title:this.i18n.t("untitled"),i=this.state.message,n=o("div").addClass("status-bar-component fill-light");return n.append(o("div").addClass("document-status").append(e)),i&&(n.addClass(i.type),n.append(o("div").addClass("notifications").append(o("div").addClass("icon").append(o("i").addClass("fa "+a[i.type]))),o("div").addClass("message").append(i.message))),n},this.handleStatusUpdate=function(t){var e=t.pop();this.setState({message:e})}},s.inherit(n,r),e.exports=n},{"../util/oo":317,"./Component":279}],298:[function(t,e,i){"use strict";function n(){h.apply(this,arguments);var t=this.getController(),e=this.getDocument();if(!t)throw new Error("Surface needs a valid controller");if(!e)throw new Error("No doc provided");if(!this.props.name)throw new Error("No name provided");this.name=this.props.name,this.selection=u.nullSelection,this.element=null,this.$element=null,this.surfaceSelection=null,this.$=r,this.$window=this.$(window),this.$document=this.$(window.document),this.dragging=!1,this._onMouseUp=s.bind(this.onMouseUp,this),this._onMouseDown=s.bind(this.onMouseDown,this),this._onMouseMove=s.bind(this.onMouseMove,this),this._onKeyDown=s.bind(this.onKeyDown,this),this._onTextInput=s.bind(this.onTextInput,this),this._onTextInputShim=s.bind(this.onTextInputShim,this),this._onCompositionStart=s.bind(this.onCompositionStart,this),this._onDomMutations=s.bind(this.onDomMutations,this),this.domObserver=new window.MutationObserver(this._onDomMutations),this.domObserverConfig={subtree:!0,characterData:!0},this.skipNextObservation=!1,this._onNativeFocus=s.bind(this.onNativeFocus,this),this._onNativeBlur=s.bind(this.onNativeBlur,this),this.enabled=!0,this.frozen=!1,this.$caret=r("<span>").addClass("surface-caret"),this.isIE=n.detectIE(),this.isFF=window.navigator.userAgent.toLowerCase().indexOf("firefox")>-1,this.undoEnabled=!0,this._initializeCommandRegistry(this.props.commands),t.registerSurface(this)}var s=t("../util/helpers"),r=t("../util/jquery"),o=t("../util/oo"),a=t("../util/Registry"),l=t("./SurfaceSelection"),u=t("../model/Document"),c=t("../model/Selection"),h=t("./Component");n.Prototype=function(){this.didMount=function(){this.attach(this.el)},this.dispose=function(){this.setSelection(null),this.textPropertyManager.dispose(),this.detach(),this.getController().unregisterSurface(this)},this.getChildContext=function(){return{surface:this}},this._initializeCommandRegistry=function(t){var e=new a;s.each(t,function(t){var i=new t(this);e.add(t["static"].name,i)},this),this.commandRegistry=e},this.getCommand=function(t){return this.commandRegistry.get(t)},this.executeCommand=function(t,e){var i=this.getCommand(t);if(!i)return void console.warn("command",t,"not registered on controller");var n=i.execute(e);n?this.emit("command:executed",n,t,i):void 0===n&&console.warn("command ",t,"must return either an info object or true when handled or false when not handled");
},this.getTextCommands=function(){var t={};return this.commandRegistry.each(function(e){e.constructor["static"].textTypeName&&(t[e.constructor["static"].name]=e)}),t},this.getName=function(){return this.name},this.getElement=function(){return this.element},this.getController=function(){return this.context.controller},this.getDocument=function(){return this.context.controller.getDocument()},this.attach=function(t){if(!t)throw new Error("Illegal argument: Surface element is required. was "+t);if(this.attached)throw new Error("Surface is already attached to element: "+t);var e=this.getDocument();this.element=t,this.$element=r(t),this.surfaceSelection=new l(t,e,this.getContainer()),this.$element.addClass("surface"),this.attachKeyboard(),this.$element.on("mousedown",this._onMouseDown),this.$element.on("dragstart",this.onDragStart),this.$element.on("focus",this._onNativeFocus),this.$element.on("blur",this._onNativeBlur),this.domObserver.observe(t,this.domObserverConfig),this.attached=!0},this.getContainer=function(){},this.getContainerId=function(){},this.attachKeyboard=function(){this.$element.on("keydown",this._onKeyDown),this.element.addEventListener&&this.element.addEventListener("compositionstart",this._onCompositionStart,!1),window.TextEvent&&!this.isIE?this.element.addEventListener("textInput",this._onTextInput,!1):this.$element.on("keypress",this._onTextInputShim)},this.detach=function(){var t=this.getDocument();this.domObserver.disconnect(),t.disconnect(this),this.$element.off("mousedown",this._onMouseDown),this.$element.off("dragstart",this.onDragStart),this.detachKeyboard(),this.$element.removeClass("surface"),this.element=null,this.$element=null,this.surfaceSelection=null,this.attached=!1},this.detachKeyboard=function(){this.$element.off("keydown",this._onKeyDown),this.element.addEventListener&&this.element.removeEventListener("compositionstart",this._onCompositionStart,!1),window.TextEvent&&!this.isIE?this.element.removeEventListener("textInput",this._onTextInput,!1):this.$element.off("keypress",this._onTextInputShim)},this.isAttached=function(){return this.attached},this.enable=function(){this.enableContentEditable&&this.$element.prop("contentEditable","true"),this.enabled=!0},this.isEnabled=function(){return this.enabled},this.disable=function(){this.enableContentEditable&&this.$element.removeAttr("contentEditable"),this.enabled=!1},this.freeze=function(){console.log("Freezing surface..."),this.enableContentEditable&&this.$element.removeAttr("contentEditable"),this.$element.addClass("frozen"),this.domObserver.disconnect(),this.frozen=!0},this.unfreeze=function(){this.frozen&&(console.log("Unfreezing surface..."),this.enableContentEditable&&this.$element.prop("contentEditable","true"),this.$element.removeClass("frozen"),this.domObserver.observe(this.element,this.domObserverConfig),this.frozen=!1)},this.onKeyDown=function(t){if(!this.frozen&&229!==t.which){switch(t.keyCode){case n.Keys.LEFT:case n.Keys.RIGHT:return this.handleLeftOrRightArrowKey(t);case n.Keys.UP:case n.Keys.DOWN:return this.handleUpOrDownArrowKey(t);case n.Keys.ENTER:return this.handleEnterKey(t);case n.Keys.SPACE:return this.handleSpaceKey(t);case n.Keys.BACKSPACE:case n.Keys.DELETE:return this.handleDeleteKey(t)}var e=!1;(t.ctrlKey||t.metaKey)&&65===t.keyCode?(this.executeCommand("selectAll"),e=!0):this.undoEnabled&&90===t.keyCode&&(t.metaKey||t.ctrlKey)?(t.shiftKey?this.getController().executeCommand("redo"):this.getController().executeCommand("undo"),e=!0):66===t.keyCode&&(t.metaKey||t.ctrlKey)?(this.executeCommand("strong"),e=!0):73===t.keyCode&&(t.metaKey||t.ctrlKey)?(this.executeCommand("emphasis"),e=!0):76===t.keyCode&&(t.metaKey||t.ctrlKey)&&(this.executeCommand("link"),e=!0),e&&(t.preventDefault(),t.stopPropagation())}},this.transaction=function(t,e){var i={surfaceId:this.getName(),selection:this.getSelection()};if(!s.isFunction(arguments[0])&&arguments.length>=2){var n=arguments[0];i=s.extend(i,n),t=arguments[1],e=arguments[2]}var r;this.getDocument().transaction(i,function(n,s){s.selection=i.selection;var o=t.call(e,n,s);return r=o||{},r.selection||(r.selection=i.selection),r.surfaceId=i.surfaceId,r}),this.setSelection(r.selection)},this.onTextInput=function(t){this.frozen||t.data&&(t.preventDefault(),t.stopPropagation(),this.skipNextObservation=!0,this.transaction(function(e,i){return this.surfaceSelection.clear(),this.insertText(e,{selection:i.selection,text:t.data})},this),this.rerenderDomSelection())},this.onCompositionStart=function(){this.skipNextObservation=!0},this.onTextInputShim=function(t){if(!this.frozen&&!(0===t.which||0===t.charCode||t.keyCode===n.Keys.TAB||t.keyCode===n.Keys.ESCAPE||t.metaKey||!!t.ctrlKey^!!t.altKey)){var e=String.fromCharCode(t.which);return this.skipNextObservation=!0,t.shiftKey||(e=e.toLowerCase()),e.length>0?(this.transaction(function(t,i){return this.surfaceSelection.clear(),this.insertText(t,{selection:i.selection,text:e})},this),this.rerenderDomSelection(),t.preventDefault(),void t.stopPropagation()):(t.preventDefault(),void t.stopPropagation())}},this.handleLeftOrRightArrowKey=function(t){var e=this;window.setTimeout(function(){var i={direction:t.keyCode===n.Keys.LEFT?"left":"right"};e._updateModelSelection(i)})},this.handleUpOrDownArrowKey=function(t){var e=this;window.setTimeout(function(){var i={direction:t.keyCode===n.Keys.UP?"left":"right"};e._updateModelSelection(i)})},this.handleSpaceKey=function(t){t.preventDefault(),t.stopPropagation(),this.transaction(function(t,e){return this.surfaceSelection.clear(),this.insertText(t,{selection:e.selection,text:" "})},this),this.rerenderDomSelection()},this.handleEnterKey=function(t){t.preventDefault(),t.shiftKey?this.transaction(function(t,e){return this.softBreak(t,e)},this):this.transaction(function(t,e){return this["break"](t,e)},this),this.rerenderDomSelection()},this.handleDeleteKey=function(t){t.preventDefault();var e=t.keyCode===n.Keys.BACKSPACE?"left":"right";this.transaction(function(t,i){return this["delete"](t,{selection:i.selection,direction:e})},this),this.rerenderDomSelection()},this.onMouseDown=function(t){this.frozen&&this.unfreeze(),1===t.which&&(this.skipNextFocusEvent=!0,this.dragging=!0,this.$document.one("mouseup",this._onMouseUp))},this.onMouseUp=function(){this.dragging=!1,this.setFocused(!0);var t=this;setTimeout(function(){if(t.surfaceSelection){var e=t.surfaceSelection.getSelection();t.textPropertyManager.removeSelection(),t.setSelection(e)}})},this.setFocused=function(t){!this.isFocused&&t||this.isFocused&&!t&&this.textPropertyManager.removeSelection(),this.isFocused=t,this.isFocused&&this.getController().didFocus(this)},this.onMouseMove=function(){this.dragging},this.onDomMutations=function(){return this.skipNextObservation?void(this.skipNextObservation=!1):void console.info("We want to enable a DOM MutationObserver which catches all changes made by native interfaces (such as spell corrections, etc). Lookout for this message and try to set Surface.skipNextObservation=true when you know that you will mutate the DOM.")},this.onDragStart=function(t){t.preventDefault(),t.stopPropagation()},this.getSelection=function(){return this.selection},this.setSelection=function(t){t?!s.isObject(t)||t instanceof c||(t=this.getDocument().createSelection(t)):t=c.nullSelection,this._setModelSelection(t)&&this.rerenderDomSelection(),!t.isNull()&&this.$element&&this.$element.focus()},this.rerenderDomSelection=function(){if(this.surfaceSelection){var t=this.surfaceSelection,e=this.getSelection();t.setSelection(e)}},this.getDomNodeForId=function(t){return this.element.querySelector("*[data-id="+t+"]")},this._updateModelSelection=function(t){this._setModelSelection(this.surfaceSelection.getSelection(t))},this.onNativeBlur=function(){this.textPropertyManager.renderSelection(this.selection),this.isNativeFocused=!1,this.skipNextFocusEvent=!1},this.onNativeFocus=function(){this.isNativeFocused=!0,window.setTimeout(function(){if(!this.skipNextFocusEvent)if(this.isFocused)this.textPropertyManager.removeSelection(),this.rerenderDomSelection();else{var t=this.surfaceSelection.getSelection();this.setFocused(!0),this.setSelection(t)}}.bind(this))},this._setModelSelection=function(t){return t=t||u.nullSelection,this.selection=t,this.emit("selection:changed",t,this),!0},this.getLogger=function(){return this.logger},this.placeCaretElement=function(){var t=this.getSelection();if(t.isNull())throw new Error("Selection is null.");var e=this.$caret;e.empty().remove();var i=this.surfaceSelection._findDomPosition(t.start.path,t.start.offset);if(i.node.nodeType===window.Node.TEXT_NODE){var n=i.node;if(n.length===i.offset)e.insertAfter(n);else{var s=window.getSelection(),o=window.document.createRange(),a=n.textContent,l=window.document.createDocumentFragment(),u=window.document.createTextNode(a.substring(0,i.offset));l.appendChild(u),l.appendChild(e[0]),l.appendChild(document.createTextNode(a.substring(i.offset))),r(n).replaceWith(l),o.setStart(u,i.offset),s.removeAllRanges(),s.addRange(o)}}else i.node.appendChild(e[0]);return e},this.removeCaretElement=function(){this.$caret.remove()},this.updateCaretElement=function(){this.$caret.remove(),this.placeCaretElement()},this.getTextPropertyManager=function(){return this.textPropertyManager}},o.inherit(n,h),n.Keys={UNDEFINED:0,BACKSPACE:8,DELETE:46,LEFT:37,RIGHT:39,UP:38,DOWN:40,ENTER:13,END:35,HOME:36,TAB:9,PAGEUP:33,PAGEDOWN:34,ESCAPE:27,SHIFT:16,SPACE:32},n.detectIE=function(){var t=window.navigator.userAgent,e=t.indexOf("MSIE ");if(e>0)return parseInt(t.substring(e+5,t.indexOf(".",e)),10);var i=t.indexOf("Trident/");if(i>0){var n=t.indexOf("rv:");return parseInt(t.substring(n+3,t.indexOf(".",n)),10)}var s=t.indexOf("Edge/");return s>0?parseInt(t.substring(s+5,t.indexOf(".",s)),10):!1},e.exports=n},{"../model/Document":65,"../model/Selection":76,"../util/Registry":314,"../util/helpers":315,"../util/jquery":316,"../util/oo":317,"./Component":279,"./SurfaceSelection":300}],299:[function(t,e,i){"use strict";var n=t("../util/oo"),s=t("./Command"),r=function(t){this.surface=t};r.Prototype=function(){this.getSurface=function(){return this.surface},this.getSelection=function(){var t=this.getSurface();return t.getSelection()},this.getContainerId=function(){var t=this.getSurface();return t.getContainerId()},this.getDocument=function(){var t=this.getSurface();return t.getDocument()},this.execute=function(){throw new Error("execute must be implemented by custom commands")}},n.inherit(r,s),e.exports=r},{"../util/oo":317,"./Command":278}],300:[function(t,e,i){"use strict";function n(t,e,i){this.element=t,this.doc=e,this.container=i,this.state=new n.State}var s=t("../util/helpers"),r=t("../util/jquery"),o=t("../util/oo"),a=t("../model/Document"),l=t("../model/Range"),u=t("../model/Coordinate");n.Prototype=function(){function t(t,e){var i=t.compareDocumentPosition(e);return i&window.document.DOCUMENT_POSITION_FOLLOWING?-1:i&window.document.DOCUMENT_POSITION_PRECEDING?1:0}this._pullState=function(e,i,s,r,o,a){if(a=a||{},!s||!e)return void(this.state=null);var l,u;o?(l=this.getModelCoordinate(e,i,a),u=l):(l=this.getModelCoordinate(e,i,a),u=this.getModelCoordinate(s,r,a));var c=!1;if(!o&&s&&e){var h=t(u.el,l.el);c=0>h||0===h&&u.offset<l.offset}if(c){var p=u;u=l,l=p}this.state=new n.State(o,c,l,u)},this.getModelCoordinate=function(t,e,i){for(var s=t,o=null;s;){if(s.dataset&&s.dataset.path){o=s;break}if(r(s).is(".content-node")&&0===e){var a=r(s).find("[data-path]");if(a.length)return new n.Coordinate(a[0],0)}s=s.parentNode}if(!o)return this.searchForCoordinate(t,e,i);var l=this._computeCharPosition(o,t,e);return new n.Coordinate(o,l)},this._computeCharPosition=function(t,e,i){function n(t){if(e===t)return o+=i,!0;if(t.nodeType===window.Node.TEXT_NODE)o+=t.textContent.length;else if(t.nodeType===window.Node.ELEMENT_NODE){if(r(t).data("external"))return o+=1,!1;for(var s=t.firstChild;s;s=s.nextSibling)if(n(s))return!0}return!1}function s(t){var e=t.nodeType;if(e===window.Node.TEXT_NODE)return t.textContent.length;if(e===window.Node.ELEMENT_NODE){if(r(t).data("external"))return 1;for(var i=0,n=t.firstChild;n;n=n.nextSibling)i+=s(n);return i}return 0}var o=0,a=!1;if(e===t){for(var l=t.firstChild,u=0;i>u&&l;u++)o+=s(l),l=l.nextSibling;a=!0}else a=n(t);return a?o:(console.error("Could not find char position."),0)},this.searchForCoordinate=function(e,i,s){var r,o,a,l,u,c=this.element.querySelectorAll("*[data-path]");for(o=0,a=c.length-1,l=t(c[o],e),u=t(c[a],e);;){var h=a-o+1;if(0>u){r=a;break}if(l>0){r=o;break}if(2>=h){r=a;break}var p=o+Math.floor(h/2),d=t(c[p],e);0>d?(o=p,l=d):(a=p,u=d)}var f;return"left"===s.direction?(r=Math.max(0,r-1),f=c[r].textContent.length):f=0>u?c[r].textContent.length:0,new n.Coordinate(c[r],f)},this._getSelection=function(t,e,i,n,r){if(this._pullState(t,e,i,n,r),!this.state)return a.nullSelection;var o,c,h,p,d,f,m,g,b=this.doc,y=this.state.start,v=this.state.end,_=new l(new u(y.path,y.offset),new u(v.path,v.offset));return s.isEqual(y.path,v.path)?b.createSelection({type:"property",path:y.path,startOffset:y.offset,endOffset:v.offset,reverse:this.state.reverse}):(o=b.get(y.path[0]),c=b.get(v.path[0]),h=o.getRoot(),p=c.getRoot(),"table"===h.type&&h.id===p.id?(h.getMatrix(),d=o.rowIdx,f=o.colIdx,m=c.rowIdx,g=c.colIdx,b.createSelection({type:"table",tableId:h.id,startRow:d,startCol:f,endRow:m,endCol:g})):b.createSelection({type:"container",containerId:this.container.id,startPath:_.start.path,startOffset:_.start.offset,endPath:_.end.path,endOffset:_.end.offset,reverse:this.state.reverse}))},this.getSelection=function(){var t=window.getSelection(),e=this._getSelection(t.anchorNode,t.anchorOffset,t.focusNode,t.focusOffset,t.collapsed);return e};var e=function(t,i){if(t.nodeType===document.TEXT_NODE){var n=t.textContent.length;return i>n?{node:null,offset:i-n}:{node:t,offset:i,boundary:n===i}}if(t.nodeType===document.ELEMENT_NODE){if(r(t).data("external"))return{node:null,offset:i-1};if(!t.firstChild&&0===i)return{node:t,offset:0};for(var s=t.firstChild;s;s=s.nextSibling){var o=e(s,i);if(o.node)return o;i=o.offset}}return{node:null,offset:i}};this._getDomPosition=function(t,i){var n='*[data-path="'+t.join(".")+'"]',s=this.element.querySelector(n);if(!s)return console.warn("Could not find DOM element for path",t),null;var r=e(s,i);return r.node?r:null},this.setSelection=function(t){var e=window.getSelection();if(t.isNull()||t.isTableSelection())return this.clear();var i=t.getRange(),s=this._getDomPosition(i.start.path,i.start.offset);if(!s)return this.clear();var r;return(r=i.isCollapsed()?s:this._getDomPosition(i.end.path,i.end.offset))?(e.removeAllRanges(),i=window.document.createRange(),t.isReverse()?(i.setStart(r.node,r.offset),e.addRange(i),e.extend(s.node,s.offset)):(i.setStart(s.node,s.offset),i.setEnd(r.node,r.offset),e.addRange(i)),void(this.state=new n.State(t.isCollapsed(),t.isReverse(),i.start,i.end))):this.clear()},this.clear=function(){var t=window.getSelection();t.removeAllRanges(),this.state=null}},o.initClass(n),n.State=function(t,e,i,n){this.collapsed=t,this.reverse=e,this.start=i,this.end=n,Object.freeze(this)},n.Coordinate=function(t,e){this.el=t,this.offset=e,this.path=t.dataset.path.split(".")},e.exports=n},{"../model/Coordinate":64,"../model/Document":65,"../model/Range":75,"../util/helpers":315,"../util/jquery":316,"../util/oo":317}],301:[function(t,e,i){"use strict";function n(){r.apply(this,arguments)}var s=t("../util/oo"),r=t("./Tool"),o=t("../util/helpers"),a=t("./Component"),l=a.$$;n.Prototype=function(){this.getCommand=function(){var t=this.getController(),e=t.getFocusedSurface();if(e){var i=this.constructor["static"].command;if(i)return e.getCommand(i);throw new Error("Contract: AnnotationTool.static.command should be associated to a supported command.")}},this.dispose=function(){var t=this.getController();t.disconnect(this)},this.getSurface=function(){return this.getController().getFocusedSurface()},this.getDocument=function(){return this.getController().getDocument()},this.getContainer=function(){var t=this.getSurface();return t?t.getContainer():void 0},this.onClick=function(t){t.preventDefault(),this.state.disabled||this.performAction()},this.performAction=function(){var t=this.getSurface();t.executeCommand(this.constructor["static"].command)},this.render=function(){var t=this.props.title||this.i18n.t(this.getName());this.state.mode&&(t=[o.capitalize(this.state.mode),t].join(" "));var e=l("button").attr("title",t).addClass("button tool").on("click",this.onClick);return this.state.disabled&&e.addClass("disabled"),this.state.active&&e.addClass("active"),e.append(this.props.children),e}},s.inherit(n,r),e.exports=n},{"../util/helpers":315,"../util/oo":317,"./Component":279,"./Tool":304}],302:[function(t,e,i){"use strict";function n(){r.apply(this,arguments)}var s=t("../util/oo"),r=t("./Component"),o=r.$$,a=t("../model/Annotator"),l=t("./AnnotationComponent");n.Prototype=function(){this.initialize=function(){this.getTextPropertyManager().registerProperty(this)},this.dispose=function(){this.getTextPropertyManager().unregisterProperty(this)},this.getInitialState=function(){return{fragments:this.getTextPropertyManager().getFragments(this.props.path)}},this.render=function(){var t=this.context.componentRegistry,e=this.getDocument(),i=this.getPath(),n=e.get(i)||"",s=this.getAnnotations(),r=o(this.props.tagName||"span").addClass("sc-text-property").attr({"data-path":this.props.path.join("."),spellCheck:!1}).css({whiteSpace:"pre-wrap"}),u=new a,c={};return u.onText=function(t,e){e&&e.length>0&&t.append(e)},u.onEnter=function(i){var n=i.node,s=n.id;c[s]||(c[s]=0),c[s]=c[s]+1;var r=t.get(n.type);if(r||(r=l),"cursor"===n.type)return o("span").addClass("se-cursor");var a=o(r,{doc:e,node:n});return"container-annotation-fragment"===n.type?(a.addClass(n.anno.getTypeNames().join(" ").replace(/_/g,"-")),a.addClass("se-annotation-fragment")):"container-annotation-anchor"===n.type?(a.addClass(n.anno.getTypeNames().join(" ").replace(/_/g,"-")),a.addClass("se-anchor"),a.addClass(n.isStart?"start-anchor":"end-anchor")):"cursor"===n.type?a.addClass("se-cursor"):"selection-fragment"===n.type&&a.addClass("se-selection-fragment"),a},u.onExit=function(t,e,i){i.append(e)},u.start(r,n,s),r.append(o("br")),r},this.getAnnotations=function(){var t=this.getDocument(),e=t.getIndex("annotations").get(this.props.path);return this.state.fragments&&(e=e.concat(this.state.fragments)),e},this.getContainer=function(){return this.getSurface().getContainer()},this.getController=function(){return this.context.controller},this.getDocument=function(){return this.getController().getDocument()},this.getPath=function(){return this.props.path},this.getElement=function(){return this.$el[0]},this.getSurface=function(){return this.context.surface},this.setFragments=function(t){this.extendState({fragments:t})},this.update=function(){this.rerender()},this.getTextPropertyManager=function(){return this.getSurface().getTextPropertyManager()}},s.inherit(n,r),e.exports=n},{"../model/Annotator":58,"../util/oo":317,"./AnnotationComponent":275,"./Component":279}],303:[function(t,e,i){"use strict";function n(){l.apply(this,arguments);var t=this.getDocument();t.connect(this,{"app:toc-entry:changed":this.setActiveTocEntry,"document:changed":this.handleDocumentChange})}var s=t("../util/helpers"),r=t("../util/oo"),o=t("./Component"),a=o.$$,l=t("./Panel");n.Prototype=function(){this.getInitialState=function(){var t=this.props.doc,e=t.getTOCNodes();return{tocNodes:e,activeNode:e.length>0?e[0].id:null}},this.dispose=function(){var t=this.getDocument();t.disconnect(this)},this.render=function(){var t=a("div").addClass("panel toc-panel-component"),e=a("div").addClass("toc-entries"),i=this.state;return s.each(i.tocNodes,function(t){var n=t.level,s=a("a").addClass("toc-entry").addClass("level-"+n).attr({href:"#","data-id":t.id}).on("click",this.handleClick).append(t.content);i.activeNode===t.id&&s.addClass("active"),e.append(s)},this),t.append(e),t},this.handleDocumentChange=function(t){for(var e=this.getDocument(),i=!1,n=e.getSchema().getTocTypes(),r=0;r<t.ops.length;r++){var o,a=t.ops[r];if(a.isCreate()||a.isDelete()){var l=a.getValue();if(o=l.type,s.includes(n,o)){i=!0;break}}else{var u=a.path[0],c=e.get(u);if(c&&s.includes(n,c.type)){i=!0;break}}}return i?this.setState({tocNodes:e.getTOCNodes()}):void 0},this.setActiveTocEntry=function(t){this.setState({activeNode:t})},this.handleClick=function(t){var e=t.currentTarget.dataset.id;t.preventDefault();var i=this.getDocument();i.emit("toc:entry-selected",e)}},r.inherit(n,l),n.contextId="toc",n.icon="fa-align-left",e.exports=n},{"../util/helpers":315,"../util/oo":317,"./Component":279,"./Panel":290}],304:[function(t,e,i){"use strict";function n(){r.apply(this,arguments),this.context.toolManager.registerTool(this)}var s=t("../util/oo"),r=t("./Component");n.Prototype=function(){this.getInitialState=function(){var t=this.context.toolManager.getCommandState(this);return t},this.dispose=function(){this.context.toolManager.unregisterTool(this)},this.getController=function(){return this.context.controller},this.getName=function(){var t=this.constructor["static"].name;if(t)return t;throw new Error("Contract: Tool.static.name must have a value")},this.performAction=function(){var t=this.getController();t.executeCommand(this.constructor["static"].command)},this.render=function(){throw new Error("render is abstract.")}},s.inherit(n,r),e.exports=n},{"../util/oo":317,"./Component":279}],305:[function(t,e,i){"use strict";function n(t){if(!t)throw new Error("Illegal arguments: controller is mandatory.");this.controller=t,this.tools=[];var e=this.controller.getDocument();e.connect(this,{"document:changed":this.updateTools},{priority:-2}),this.controller.connect(this,{"selection:changed":this.updateTools,"document:saved":this.updateTools})}var s=t("../util/oo"),r=t("./ControllerTool"),o=t("./SurfaceTool"),a=t("lodash/array/without"),l={disabled:!0,active:!1};n.Prototype=function(){this.dispose=function(){var t=this.controller.getDocument();this.controller.disconnect(this),t.disconnect(this)},this.getCommandState=function(t){var e=this.getCommand(t);return e?e.getCommandState():l},this.registerTool=function(t){this.tools.push(t)},this.unregisterTool=function(t){this.tools=a(this.tools,t)},this.getCommand=function(t){var e=t.constructor["static"].command;if(t instanceof o){var i=this.controller.getFocusedSurface();return i?i.getCommand(e):!1}return t instanceof r?this.controller.getCommand(e):void 0},this.updateTools=function(){this.tools.forEach(function(t){var e=this.getCommandState(t);t.setState(e)}.bind(this))}},s.initClass(n),e.exports=n},{"../util/oo":317,"./ControllerTool":286,"./SurfaceTool":301,"lodash/array/without":119}],306:[function(t,e,i){"use strict";var n=t("./ControllerCommand"),s=n.extend({"static":{name:"undo"},getCommandState:function(){var t=this.getDocument();return{disabled:0===t.done.length,active:!1}},execute:function(){var t=this.getDocument();return t.done.length>0?(t.undo(),!0):!1}});e.exports=s},{"./ControllerCommand":285}],307:[function(t,e,i){"use strict";var n=t("./ControllerTool"),s=n.extend({"static":{name:"undo",command:"undo"}});e.exports=s},{"./ControllerTool":286}],308:[function(t,e,i){"use strict";function n(){r.apply(this,arguments)}var s=t("../util/oo"),r=t("./Component"),o=r.$$;n.Prototype=function(){this.render=function(){return o("pre").addClass("content-node unsupported").attr({"data-id":this.props.node.id,contentEditable:!1}).append(JSON.stringify(this.props.node.properties,null,2))}},s.inherit(n,r),e.exports=n},{"../util/oo":317,"./Component":279}],309:[function(t,e,i){"use strict";function n(){this.map={}}var s=t("../util/oo"),r=t("../util/helpers");n.Prototype=function(){this.t=function(t){return this.map[t]?this.map[t]:t},this.load=function(t){r.extend(this.map,t)}},s.initClass(n),n.mixin=function(t){Object.defineProperty(t.prototype,"i18n",{get:function(){return this.context&&this.context.i18n?this.context.i18n:n.instance}})},n.instance=new n,e.exports=n},{"../util/helpers":315,"../util/oo":317}],310:[function(t,e,i){"use strict";function n(){this.__events__={}}var s=t("./oo");n.Prototype=function(){function t(t,e){if("string"==typeof t){if(void 0===e||null===e)throw new Error('Method name "'+t+'" has no context.');if(!(t in e))throw new Error('Method not found: "'+t+'"');if("function"!=typeof e[t])throw new Error('Property "'+t+'" is not a function')}else if("function"!=typeof t)throw new Error("Invalid callback. Function or method name expected.")}function e(t,e){return e.priority-t.priority}this._on=function(e,i,n,s){var r;return t(i,n),r=this.__events__.hasOwnProperty(e)?this.__events__[e]:this.__events__[e]=[],r.push({method:i,context:n||null,priority:s}),this},this._off=function(e,i,n){var s,r;if(1===arguments.length)return delete this.__events__[e],this;if(t(i,n),!(e in this.__events__&&this.__events__[e].length))return this;for(arguments.length<3&&(n=null),r=this.__events__[e],s=r.length;s--;)r[s].method===i&&r[s].context===n&&r.splice(s,1);return 0===r.length&&delete this.__events__[e],this},this._connect=function(t,i,n){var s=0;3===arguments.length&&(s=n.priority||s);for(var r in i){var o=i[r];this._on(r,o,t,s)}return this.__events__[r].sort(e),this},this._disconnect=function(t){var e,i,n;for(i in this.__events__)for(n=this.__events__[i],e=n.length;e--;)n[e]&&n[e].context===t&&this._off(i,n[e].method,t);return this},this.emit=function(t){if(t in this.__events__){for(var e=this.__events__[t].slice(),i=Array.prototype.slice.call(arguments,1),n=0,s=e.length;s>n;n++){var r=e[n];r.method.apply(r.context,i)}return!0}return!1},this.connect=function(t,e,i){return this._connect.apply(this,arguments)},this.disconnect=function(t){return this._disconnect(t)},this.on=function(t,i,n,s){var r=0;4===arguments.length&&(r=s.priority||r),this._on(t,i,n,r),this.__events__[t].sort(e)},this.off=function(t,e,i){return this._off.apply(this,arguments)}},s.initClass(n),e.exports=n},{"./oo":317}],311:[function(t,e,i){"use strict";function n(){n["super"].call(this)}var s=t("./oo"),r=t("./Registry");n.Prototype=function(){this.create=function(t){var e=this.get(t);if(!e)throw new Error("No class registered by that name: "+t);var i=Array.prototype.slice.call(arguments,1),n=Object.create(e.prototype);return e.apply(n,i),n}},s.inherit(n,r),e.exports=n},{"./Registry":314,"./oo":317}],312:[function(t,e,i){"use strict";var n=t("./EventEmitter"),s=t("./oo"),r=function(){n.call(this),this.messages=[]};r.Prototype=function(){this.addMessage=function(t){this.messages.push(t),this.emit("messages:updated",this.messages)},this.log=function(t){this.addMessage({type:"info",message:t})},this.error=function(t){this.addMessage({type:"error",message:t})},this.warn=this.log,this.info=this.log,this.clearMessages=function(){this.messages=[],this.emit("messages:updated",this.messages)}},s.inherit(r,n),e.exports=r},{"./EventEmitter":310,"./oo":317}],313:[function(t,e,i){"use strict";function n(t){t&&(this.root=t)}var s=t("./helpers"),r=t("./oo");n.Prototype=function(){this.childrenScope=!1,this.getRoot=function(){return this.root||this},this._resolve=function(t,e){for(var i=t.length-1,n=this.getRoot(),s=0;i>s;s++){var r=t[s];if(void 0===n[r]){if(!e)return void 0;n[r]={},this.childrenScope&&(n[r].children={})}n=n[r],this.childrenScope&&(n=n.children)}return n},this.get=function(t){if(s.isString(t))return this[t];if(t&&0!==t.length){var e=t[t.length-1],i=this._resolve(t);return i?i[e]:void 0}return this.getRoot()},this.set=function(t,e){if(s.isString(t))this[t]=e;else{var i=t[t.length-1];this._resolve(t,!0)[i]=e}},this["delete"]=function(t,e){if(s.isString(t))delete this[t];else{var i=t[t.length-1],n=this._resolve(t);if(e&&!n||!n[i])throw new Error("Invalid path.");delete n[i]}},this.clear=function(){var t=this.getRoot();for(var e in t)t.hasOwnProperty(e)&&delete t[e]},this._traverse=function(t,e,i,n){for(var s in t)if(t.hasOwnProperty(s)&&"__values__"!==s){var r=e.concat([s]);i.call(n,r,t[s]),this._traverse(t[s],r,i,n)}},this.traverse=function(t,e){this._traverse(this.getRoot(),[],t,e)}},r.initClass(n),n.Arrays=function(){n.apply(this,arguments)},n.Arrays.Prototype=function(){this.get=function(t){if(s.isString(t))return this[t];if(t&&0!==t.length){var e=t[t.length-1],i=this._resolve(t);return i&&i[e]?i[e].__values__:void 0}return this.getRoot()},this.add=function(t,e){var i=t[t.length-1],n=this._resolve(t,!0);n[i]||(n[i]={__values__:[]});var s=n[i].__values__;s.push(e)},this.remove=function(t,e){var i=this.get(t);i?s.deleteFromArray(i,e):console.warn("Warning: trying to remove a value for an unknown path.",t,e)},this.removeAll=function(t){var e=this.get(t);e.splice(0,e.length)},this.set=function(){throw new Error("This method is not available for PathAdapter.Arrays")},this._traverse=function(t,e,i,n){for(var s in t)if(t.hasOwnProperty(s))if("__values__"===s)i.call(n,e,t.__values__);else{var r=e.concat([s]);this._traverse(t[s],r,i,n)}}},r.inherit(n.Arrays,n),e.exports=n},{"./helpers":315,"./oo":317}],314:[function(t,e,i){"use strict";function n(){this.entries={},this.names=[]}var s=t("./oo");n.Prototype=function(){this.contains=function(t){return!!this.entries[t]},this.add=function(t,e){this.contains(t)&&this.remove(t),this.entries[t]=e,this.names.push(t)},this.remove=function(t){var e=this.names.indexOf(t);e>=0&&this.names.splice(e,1),delete this.entries[t]},this.clear=function(){this.names=[],this.entries=[]},this.get=function(t){var e=this.entries[t];return e},this.each=function(t,e){for(var i=0;i<this.names.length;i++){var n=this.names[i],s=t.call(e,this.entries[n],n);if(s===!1)break}}},s.initClass(n),e.exports=n},{"./oo":317}],315:[function(t,e,i){"use strict";var n={};n.isEqual=t("lodash/lang/isEqual"),n.isObject=t("lodash/lang/isObject"),n.isArray=t("lodash/lang/isArray"),n.isString=t("lodash/lang/isString"),n.isNumber=t("lodash/lang/isNumber"),n.isBoolean=t("lodash/lang/isBoolean"),n.isFunction=t("lodash/lang/isFunction"),n.cloneDeep=t("lodash/lang/cloneDeep"),n.clone=t("lodash/lang/clone"),n.isEmpty=t("lodash/lang/isEmpty"),n.bind=t("lodash/function/bind"),n.delay=t("lodash/function/delay"),n.debounce=t("lodash/function/debounce"),n.extend=t("lodash/object/extend"),n.omit=t("lodash/object/omit"),n.values=t("lodash/object/values"),n.last=t("lodash/array/last"),n.first=t("lodash/array/first"),n.compact=t("lodash/array/compact"),n.uniq=t("lodash/array/uniq"),n.intersection=t("lodash/array/intersection"),n.union=t("lodash/array/union"),n.without=t("lodash/array/without"),n.each=t("lodash/collection/forEach"),n.filter=t("lodash/collection/filter"),n.includes=t("lodash/collection/includes"),n.find=t("lodash/collection/find"),n.map=t("lodash/collection/map"),n.pluck=t("lodash/collection/pluck"),n.indexBy=t("lodash/collection/indexBy"),n.sortBy=t("lodash/collection/sortBy"),n.capitalize=t("lodash/string/capitalize"),n.isArrayEqual=function(t,e){if(t===e)return!0;if(null===t||null===e)return!1;if(t.length!=e.length)return!1;for(var i=0;i<t.length;++i)if(t[i]!==e[i])return!1;return!0},n.deleteFromArray=function(t,e){for(var i=0;i<t.length;i++)t[i]===e&&(t.splice(i,1),i--)},n.deepclone=function(t){return null===t||void 0===t?t:n.isFunction(t.clone)?t.clone():n.deepclone(t)},n.deepclone=n.cloneDeep,n.getRelativeOffset=function(t,e){var i=t.offset(),n=e.offset();return i.left-=n.left,i.top-=n.top,i},n.uuid=t("./uuid"),e.exports=n},{"./uuid":318,"lodash/array/compact":112,"lodash/array/first":114,"lodash/array/intersection":115,"lodash/array/last":116,"lodash/array/union":117,"lodash/array/uniq":118,"lodash/array/without":119,"lodash/collection/filter":120,"lodash/collection/find":121,"lodash/collection/forEach":122,"lodash/collection/includes":123,"lodash/collection/indexBy":124,"lodash/collection/map":125,"lodash/collection/pluck":126,"lodash/collection/sortBy":127,"lodash/function/bind":129,"lodash/function/debounce":130,"lodash/function/delay":131,"lodash/lang/clone":206,"lodash/lang/cloneDeep":207,
"lodash/lang/isArray":209,"lodash/lang/isBoolean":210,"lodash/lang/isEmpty":211,"lodash/lang/isEqual":212,"lodash/lang/isFunction":213,"lodash/lang/isNumber":215,"lodash/lang/isObject":216,"lodash/lang/isString":217,"lodash/object/extend":220,"lodash/object/omit":223,"lodash/object/values":224,"lodash/string/capitalize":225}],316:[function(t,e,i){var n="undefined"!=typeof window,s=null;if(n)e.exports=t("jquery");else{if(!s){var r=t("cheerio");s=r.load("",{decodeEntities:!1})}e.exports=s}},{cheerio:13,jquery:111}],317:[function(t,e,i){"use strict";function n(t,e,i){e=e||{},t["static"]||o.initClass(t),t["static"]._makeExtendFunction=function(t){return r.bind(l,null,t,e,i)},t["static"]._afterClassInitHook=function(t){var n=t.prototype;for(var s in n)n.hasOwnProperty(s)&&("static"!==s?n.hasOwnProperty(s)&&s in e&&(t["static"][s]=n[s]):r.extend(t["static"],n["static"]));i&&i(t)},t.extend=t["static"]._makeExtendFunction(t)}var s,r=t("./helpers"),o={},a={name:!0,displayName:!0},l=function(t,e,i,n){if(arguments.length>4){var o=Array.prototype.slice.call(arguments,3);n=r.extend.apply(null,o)}var a=function(){this.__className__=n.displayName||n.name,t.apply(this,arguments),this.init&&(console.log("DEPRECATED: we want to drop this built-in hook in favor of a custom hook."),this.init.apply(this,arguments))};n.displayName?a.displayName=n.displayName:n.name&&(a.displayName=n.name),s(a,t);for(var l in n)if(n.hasOwnProperty(l)){if("static"===l){r.extend(a["static"],n["static"]);continue}l in e?a["static"][l]=n[l]:a.prototype[l]=n[l]}return i&&i(a,n),a};o.makeExtensible=n;var u=function(t){!t.Prototype||t.prototype instanceof t.Prototype||(t.prototype=new t.Prototype,t.prototype.constructor=t),t["static"]=t["static"]||{}};o.initClass=function(t){u(t),n(t,a)},s=function(t,e){if(t.prototype instanceof e)throw new Error("Target already inherits from origin");var i=t.prototype.constructor,s=t.Prototype;t["super"]=e,s?(s.prototype=e.prototype,t.prototype=new s,t.prototype.constructor=t):t.prototype=Object.create(e.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),t.prototype["super"]=e.prototype,u(e),t["static"]=Object.create(e["static"]),t["static"]._makeExtendFunction?t.extend=t["static"]._makeExtendFunction(t):n(t,a)},o.inherit=function(t,e){s(t,e),t["static"]._afterClassInitHook&&t["static"]._afterClassInitHook(t)},o.mixin=function(t,e){var i,n=e.prototype;e.Prototype&&(n=new e.Prototype);for(i in n)"constructor"!==i&&n.hasOwnProperty(i)&&(t.prototype[i]=n[i]);if(o.initClass(t),e["static"])for(i in e["static"])e["static"].hasOwnProperty(i)&&(t["static"][i]=e["static"][i]);else o.initClass(e)},e.exports=o},{"./helpers":315}],318:[function(t,e,i){e.exports=function(t,e){t&&"_"!==t[t.length-1]&&(t=t.concat("_"));var i,n="0123456789abcdefghijklmnopqrstuvwxyz".split(""),s=[],r=16;if(e=e||32)for(i=0;e>i;i++)s[i]=n[0|Math.random()*r];else{var o;for(s[8]=s[13]=s[18]=s[23]="-",s[14]="4",i=0;36>i;i++)s[i]||(o=0|16*Math.random(),s[i]=n[19==i?3&o|8:o])}return(t?t:"")+s.join("")}},{}],319:[function(t,e,i){var n=t("substance/util/jquery"),s=t("substance/model/DocumentNode"),r=s.extend({name:"bib-item",properties:{source:"string",format:"string"},setLabel:function(t){this.label=t,this.emit("label",t)},setText:function(t){this.text=t},didInitialize:function(){"citeproc"===this.format?(this.data=JSON.parse(this.source),this.guid=this.data.DOI||this.data.ISSN||this.id):(this.data=this.source,this.guid=this.id)},didAttach:function(t){t.isTransaction()||t.isClipboard()||this.updateCollection(t)},didDetach:function(t){t.isTransaction()||t.isClipboard()||this.updateCollection(t)},updateCollection:function(t){var e=t.getCollection(this.type);e&&e.update()}});r["static"].citationType="bib-item-citation",r["static"].matchElement=function(t){return t.is("bib")},r["static"].fromHtml=function(t,e){var i=e.defaultId(t,"bib"),n={id:i,source:"",format:""};return n.format="citeproc",n.source=t.text(),n},r["static"].toHtml=function(t){var e=t.id,i=n("<bib>").attr("format","citeproc").attr("id",e).text(JSON.stringify(t.data));return i},e.exports=r},{"substance/model/DocumentNode":67,"substance/util/jquery":316}],320:[function(t,e,i){var n=t("../citations/Citation"),s=n.extend({name:"bib-item-citation",getItemType:function(){return"bib-item"}});s["static"].matchElement=function(t){return t.is(s["static"].tagName)&&"bib"===t.attr("data-rtype")},s["static"].fromHtml=function(t,e){return n["static"].fromHtml(t,e)},s["static"].toHtml=function(t,e){var i=n["static"].toHtml(t,e);return i.attr("data-rtype","bib"),i},e.exports=s},{"../citations/Citation":335}],321:[function(t,e,i){"use strict";var n=t("../citations/CitationCommand"),s=n.extend({"static":{name:"bibItemCitation",annotationType:"bib-item-citation"}});e.exports=s},{"../citations/CitationCommand":336}],322:[function(t,e,i){"use strict";var n=t("substance/ui/AnnotationTool"),s=n.extend({"static":{name:"Bibliographic Citation",command:"bibItemCitation"}});e.exports=s},{"substance/ui/AnnotationTool":276}],323:[function(t,e,i){function n(){r.apply(this,arguments)}var s=t("substance/util/oo"),r=t("substance/ui/Component"),o=r.$$,a=t("substance/ui/FontAwesomeIcon");n.Prototype=function(){this.toggleFocus=function(){this.send("toggleBibItem",this.props.node)},this.render=function(){var t=o("div").addClass("se-bib-item").attr("data-id",this.props.node.id);return this.props.highlighted&&t.addClass("se-highlighted"),t.append(o("div").addClass("se-label").append(this.props.node.label)),t.append(o("button").addClass("se-focus-toggle").append(o(a,{icon:"fa-eye"})," Focus").on("click",this.toggleFocus)),t.append(o("div").addClass("se-text").append(this.props.node.text)),t}},s.inherit(n,r),e.exports=n},{"substance/ui/Component":279,"substance/ui/FontAwesomeIcon":288,"substance/util/oo":317}],324:[function(t,e,i){"use strict";function n(){r.apply(this,arguments),this.props.node.connect(this,{label:this.onLabelChanged})}var s=t("substance/util/oo"),r=t("substance/ui/Component"),o=r.$$;n.Prototype=function(){this.dispose=function(){this.props.node.disconnect(this)},this.render=function(){var t=o("div").addClass("bib-item border-bottom pad item small clearfix").attr("data-id",this.props.node.id);return t.on("click",this.onClick),t.on("mousedown",this.onMouseDown),this.props.active&&t.addClass("active"),this.props.node.label&&t.append(o("div").addClass("label").append(this.props.node.label)),t.append(o("div").addClass("text").append(this.props.node.text)),t},this.onClick=function(t){t.preventDefault(),t.stopPropagation()},this.onMouseDown=function(t){t.preventDefault(),this.props.handleSelection(this.props.node.id)},this.onLabelChanged=function(){this.rerender()}},s.inherit(n,r),e.exports=n},{"substance/ui/Component":279,"substance/util/oo":317}],325:[function(t,e,i){"use strict";function n(){r.apply(this,arguments);var t=this.props.doc;this.bibliography=t.getCollection("bib-item"),this.bibliography.connect(this,{"bibliography:updated":this.rerender})}var s=t("substance/util/oo"),r=t("substance/ui/Panel"),o=t("substance/ui/Component"),a=t("./BibItemComponent"),l=o.$$,u=o.extend({render:function(){var t=l("div").addClass("se-bibliography-summary");t.append(l("p").append("Your bibliography has ",l("strong").append(this.props.bibItems.length.toString()," references")," in total."));var e=this.context.config;return e.isEditable&&t.append(l("p").append(l("a").attr({href:"#"}).append("Add references"))),t}});n.Prototype=function(){this.dispose=function(){this.bibliography.disconnect()},this.didMount=function(){var t=this.getFirstActiveBibItemId();t&&this.scrollToNode(t)},this.getFirstActiveBibItemId=function(){var t=this.props.doc;if(this.props.bibItemId)return this.props.bibItemId;if(this.props.citationId){var e=t.get(this.props.citationId);return e.targets[0]}},this.isHighlighted=function(t){var e=this.props.doc;if(this.props.bibItemId===t.id)return!0;if(this.props.citationId){var i=e.get(this.props.citationId);if(i.targets&&i.targets.indexOf(t.id)>=0)return!0}return!1},this.render=function(){var t=this.bibliography.getItems(),e=l("div").addClass("sc-bib-items-panel panel"),i=l("div").addClass("panel-content").ref("panelContent");return i.append(l(u,{bibItems:t})),t.forEach(function(t){i.append(l(a,{node:t,highlighted:this.isHighlighted(t)}))}.bind(this)),e.append(i),e}},s.inherit(n,r),e.exports=n},{"./BibItemComponent":323,"substance/ui/Component":279,"substance/ui/Panel":290,"substance/util/oo":317}],326:[function(t,e,i){"use strict";function n(t,e){o.call(this),this.doc=t,this.containerId=e,this.bibitemsByGuid={},this._compileDebounced=s.debounce(this.compile.bind(this),50)}var s=t("substance/util/helpers"),r=t("substance/util/oo"),o=t("substance/util/EventEmitter");n.Prototype=function(){this.dispose=function(){this.doc.disconnect(this)},this.getDocument=function(){return this.doc},this.getCompiler=function(){return this.getDocument().getCiteprocCompiler()},this.compile=function(){var t=this.getDocument(),e=this.getCompiler(),i=t.get(this.containerId);e.clear();var n=t.getIndex("type").get("bib-item");this.bibitemsByGuid={},s.each(n,function(t){if("citeproc"!==t.format)throw new Error("Only 'citeproc' bibliographic items are supported right now.");var i=t.source,n=JSON.parse(i);n.id=t.id,e.addRecord(n),this.bibitemsByGuid[t.guid]=t},this);var r=t.getIndex("type").get("bib-item-citation"),o=s.map(r,function(t){var e=i.getAddress(t.path);return{citation:t,address:e}});o.sort(function(t,e){return e>t?-1:t>e?1:t.citation.startOffset-e.citation.startOffset}),s.each(o,function(t){var e=t.citation;if(e.targets.length>0){var i=s.filter(e.targets,function(t){var e=!!n[t];return e||console.error("No Bibitem found with id",t),e}),r=this.getCompiler().addCitation(i);e.setLabel(r.label)}else e.setLabel("???")},this);var a=this.getCompiler().makeBibliography();a=s.sortBy(a,"rank"),this.sortedBibItems=s.map(a,function(t){var e=n[t.id];return e.setLabel(t.label),e.setText(t.content),e},this),this.emit("bibliography:updated")},this.update=function(){this._compileDebounced()},this.makeBibliography=function(){return this.getCompiler().makeBibliography()},this.getBibItems=function(){for(var t=[],e=this.getCompiler().getSortedIds(),i=0;i<e.length;i++)t.push(this.doc.get(e[i]));return t},this.getCompiledItems=function(){return this.sortedBibItems},this.getItems=function(){return this.getCompiledItems()}},r.inherit(n,o),e.exports=n},{"substance/util/EventEmitter":310,"substance/util/helpers":315,"substance/util/oo":317}],327:[function(t,e,i){"use strict";function n(){o.apply(this,arguments)}var s=t("substance/util/helpers"),r=t("substance/util/oo"),o=t("substance/ui/Component"),a=o.$$;n.Prototype=function(){this.getDocument=function(){return this.context.controller.getDocument()},this.render=function(){var t=this.state;if(t.bibItems){var e=[a("div").addClass("content-node heading level-1").append("References")];return s.each(t.bibItems,function(t){t.label&&e.push(a("div").addClass("bib-item clearfix").append(a("div").addClass("label csl-left-margin").append(t.label),a("div").addClass("text csl-right-inline").append(t.text)))}),a("div").addClass("bibliography-component bib-items").append(e)}return a("div")},this.didMount=function(){var t=this.getDocument();this.bibliography=t.getCollection("bib-item"),this.bibliography.connect(this,{"bibliography:updated":this.update})},this.update=function(){var t=this.bibliography.getItems();this.setState({bibItems:t})}},r.inherit(n,o),e.exports=n},{"substance/ui/Component":279,"substance/util/helpers":315,"substance/util/oo":317}],328:[function(t,e,i){function n(t){this.config=t||new a,this.style=this.config.style,this.clear()}var s=t("substance/util/helpers"),r=t("substance/util/jquery"),o=t("./citeproc/citeproc").CSL,a=t("./CiteprocDefaultConfig");n.prototype.setStyle=function(t){this.style=t,this.clear()},n.prototype.clear=function(){this.engine=new o.Engine(this,this.style),this.data={},this.citationLabels={},this.count=0},n.prototype.addRecord=function(t){return t.id=t.id||"ITEM_"+this.count++,this.sanitizeData(t),this.data[t.id]=t,t.id},n.prototype.addCitation=function(t){s.isArray(t)||(t=[t]);for(var e={citationItems:[],properties:{}},i=0;i<t.length;i++)e.citationItems.push({id:t[i]});var n=this.engine.appendCitationCluster(e),r=n[0][0];e=this.engine.registry.citationreg.citationByIndex[r];var o=e.citationID,a=n[0][1];for(this.citationLabels[o]=a,i=1;i<n.length;i++)this.citationLabels[n[i][0]]=n[i][1];return{id:o,label:a}},n.prototype.getCitationCount=function(t){var e=this.engine.registry.citationreg.citationsByItemId[t];return e?e.length:0},n.prototype.makeBibliography=function(){var t,e,i,n,s,r,o,a={},l=[],u=this.engine.registry.citationreg.citationByIndex,c=[];for(e=0;e<u.length;e+=1)n=u[e],c.push([""+n.citationID,n.properties.noteIndex]);for(t=this.engine.registry.getSortedIds(),i=0;i<t.length;i++)o=t[i],s=this.engine.previewCitationCluster({citationItems:[{id:o}],properties:{}},c,[],"html"),r=this.renderReference(this.data[o]),a[o]={id:o,rank:i,citeCount:this.getCitationCount(o),label:s,content:r},l.push(a[o]);for(o in this.data)a[o]||(i+=1,r=this.renderReference(this.data[o]),a[o]={id:o,rank:i,citeCount:0,label:null,content:r},l.push(a[o]));return a},n.prototype.getSortedIds=function(){var t,e,i,n;for(t=this.engine.registry.getSortedIds(),e={},i=0;i<t.length;i++)e[t[i]]=!0;for(n in this.data)e[n]||(t.push(n),e[n]=!0);return t},n.prototype.renderReference=function(t){function e(t){if(t.search("csl-right-inline")>=0){var e=r("<div>").append(r(t)).find(".csl-right-inline");return e.html()}return t}function i(){a.sanitizeData(t);var e=new o.Engine({retrieveItem:function(){return t},retrieveLocale:function(t){return a.config.locale[t]}},a.style),i={citationItems:[{id:t.id}],properties:{}};e.appendCitationCluster(i);try{return e.makeBibliography()[1][0]}catch(n){return console.error(n),"Error: invalid citation data."}}var s,a=this;if(this.data[t.id])try{s=n.getBibliographyEntry.call(this.engine,t.id)}catch(l){s=i()}else s=i();return e(s)},n.getBibliographyEntry=function(t){var e,i,n,s,r,a,l;if(this.tmp.area="bibliography",this.tmp.last_rendered_name=!1,this.tmp.bibliography_errors=[],this.tmp.bibliography_pos=0,this.tmp.disambig_override=!0,this.tmp.just_looking=!0,e=this.retrieveItem(t),this.parallel.StartCitation([[{id:""+e.id},e]]),this.tmp.term_predecessor=!1,o.getCite.call(this,e),this.output.queue[0].blobs.length&&this.output.queue[0].blobs[0].blobs.length){for(s||!this.output.queue[0].blobs[0].blobs[0].strings?(i=this.output.queue[0].blobs,s=!1):i=this.output.queue[0].blobs[0].blobs,r=i.length-1;r>-1;r+=-1)if(i[r].blobs&&0!==i[r].blobs.length){var u,c=this.tmp.cite_locales[this.tmp.cite_locales.length-1];u=this.tmp.cite_affixes[this.tmp.area][c]?this.tmp.cite_affixes[this.tmp.area][c].suffix:this.bibliography.opt.layout_suffix,l=u.slice(0,1),l&&i[r].strings.suffix.slice(-1)===l&&(i[r].strings.suffix=i[r].strings.suffix.slice(0,-1)),i[r].strings.suffix+=u;break}i[0].strings.prefix=this.bibliography.opt.layout_prefix+i[0].strings.prefix}for(r=0,a=this.output.queue.length;a>r;r+=1)o.Output.Queue.purgeEmptyBlobs(this.output.queue[r]);for(r=0,a=this.output.queue.length;a>r;r+=1)this.output.adjust.upward(this.output.queue[r]),this.output.adjust.leftward(this.output.queue[r]),this.output.adjust.downward(this.output.queue[r],!0),this.output.adjust.fix(this.output.queue[r]);return n=this.output.string(this,this.output.queue)[0],n||(n="\n[CSL STYLE ERROR: reference with no printed form.]\n"),this.tmp.disambig_override=!1,this.tmp.just_looking=!1,n},n.prototype.retrieveItem=function(t){return this.data[t]},n.prototype.retrieveLocale=function(t){return this.config.locale[t]},n.prototype.sanitizeData=function(t){t["container-title"]=t["container-title"]||"",t.title=t.title||""},e.exports=n},{"./CiteprocDefaultConfig":329,"./citeproc/citeproc":331,"substance/util/helpers":315,"substance/util/jquery":316}],329:[function(t,e,i){function n(t){t=t||{},this.style=t.style||n.defaultStyle,this.locale=t.locale||n.defaultLocale}n.defaultStyleName="PLOS",n.defaultStyle='<?xml version="1.0" encoding="utf-8"?><style xmlns="http://purl.org/net/xbiblio/csl" class="in-text" version="1.0" demote-non-dropping-particle="sort-only" page-range-format="expanded" default-locale="en-US">  <info>    <title>Public Library of Science</title>    <title-short>PLOS</title-short>    <id>http://www.zotero.org/styles/plos</id>    <link href="http://www.zotero.org/styles/plos" rel="self"/>    <link href="http://journals.plos.org/plosbiology/guidelines.php" rel="documentation"/>    <author>      <name>Julian Onions</name>      <email>julian.onions@gmail.com</email>    </author>    <category citation-format="numeric"/>    <category field="science"/>    <summary>Public Library of Science Journal style.</summary>    <updated>2012-09-27T22:06:38+00:00</updated>    <rights license="http://creativecommons.org/licenses/by-sa/3.0/">This work is licensed under a Creative Commons Attribution-ShareAlike 3.0 License</rights>  </info>  <macro name="editor">    <names variable="editor" delimiter=", ">      <name name-as-sort-order="all" sort-separator=" " initialize-with="" delimiter=", " delimiter-precedes-last="always"/>      <label form="long" prefix=", "/>    </names>  </macro>  <macro name="author">    <names variable="author">      <name name-as-sort-order="all" sort-separator=" " initialize-with="" delimiter=", " delimiter-precedes-last="always"/>      <label form="long" prefix=", "/>      <substitute>        <names variable="editor"/>        <text variable="title"/>      </substitute>    </names>  </macro>  <macro name="access">    <group>      <choose>        <if variable="URL">          <text variable="URL" prefix="Available: " suffix="."/>          <group prefix=" " suffix=".">            <text term="accessed" text-case="capitalize-first" suffix=" "/>            <date variable="accessed">              <date-part name="day" suffix=" "/>              <date-part name="month" suffix=" "/>              <date-part name="year"/>            </date>          </group>        </if>        <else>          <text variable="DOI" prefix="doi:"/>        </else>      </choose>    </group>  </macro>  <macro name="publisher">    <group delimiter=": ">      <text variable="publisher-place"/>      <text variable="publisher"/>    </group>  </macro>  <macro name="year-date">    <choose>      <if variable="issued">        <date variable="issued">          <date-part name="year"/>        </date>      </if>      <else>        <text term="no date" form="short"/>      </else>    </choose>  </macro>  <macro name="edition">    <choose>      <if is-numeric="edition">        <group delimiter=" ">          <number variable="edition" form="ordinal"/>          <text term="edition" form="short"/>        </group>      </if>      <else>        <text variable="edition" suffix="."/>      </else>    </choose>  </macro>  <citation collapse="citation-number">    <sort>      <key variable="citation-number"/>    </sort>    <layout prefix="[" suffix="]" delimiter=",">      <text variable="citation-number"/>    </layout>  </citation>  <bibliography et-al-min="6" et-al-use-first="5" second-field-align="flush">    <layout suffix=".">      <text variable="citation-number" suffix=". "/>      <group delimiter=" ">        <text macro="author"/>        <text macro="year-date" prefix="(" suffix=")"/>        <text variable="title"/>      </group>      <choose>        <if type="book report" match="any">          <text variable="genre" prefix=". "/>          <group delimiter=" " prefix=". ">            <text macro="edition"/>            <text macro="editor"/>            <text macro="publisher" suffix="."/>            <group delimiter=" ">              <text variable="number-of-pages"/>              <text term="page" form="short" strip-periods="true"/>            </group>          </group>        </if>        <else-if type="chapter paper-conference" match="any">          <group prefix=". " delimiter=". " suffix=".">            <group delimiter=" ">              <text term="in" text-case="capitalize-first" suffix=":"/>              <text macro="editor"/>            </group>            <text variable="container-title"/>            <text variable="collection-title"/>          </group>          <group prefix=" " suffix="." delimiter=", ">            <text macro="publisher"/>            <text variable="volume" prefix="Vol. "/>          </group>          <group prefix=" ">            <label variable="page" suffix=" " form="short"/>            <text variable="page"/>          </group>        </else-if>        <else-if type="thesis">          <group delimiter=" " prefix=" ">            <text variable="genre" prefix="[" suffix="]."/>            <text macro="publisher"/>          </group>        </else-if>        <else>          <group delimiter=" " prefix=". ">            <text variable="container-title" form="short" strip-periods="true"/>            <text variable="volume"/>          </group>          <text variable="page" prefix=": "/>        </else>      </choose>      <text macro="access" prefix=". "/>    </layout>  </bibliography></style>',n.defaultLocale={"en-US":'<locale xml:lang="en" xmlns="http://purl.org/net/xbiblio/csl">  <style-options punctuation-in-quote="true"/>  <date form="text">    <date-part name="month" suffix=" "/>    <date-part name="day" suffix=", "/>    <date-part name="year"/>  </date>  <date form="numeric">    <date-part name="year"/>    <date-part name="month" form="numeric" prefix="-" range-delimiter="/"/>    <date-part name="day" prefix="-" range-delimiter="/"/>  </date>  <terms>    <term name="document-number-label">No.</term>    <term name="document-number-authority-suffix">Doc.</term>    <term name="un-sales-number-label">U.N. Sales No.</term>    <term name="collection-number-label">No.</term>    <term name="open-quote">“</term>    <term name="close-quote">”</term>    <term name="open-inner-quote">‘</term>    <term name="close-inner-quote">’</term>    <term name="ordinal-01">st</term>    <term name="ordinal-02">nd</term>    <term name="ordinal-03">rd</term>    <term name="ordinal-04">th</term>    <term name="long-ordinal-01">first</term>    <term name="long-ordinal-02">second</term>    <term name="long-ordinal-03">third</term>    <term name="long-ordinal-04">fourth</term>    <term name="long-ordinal-05">fifth</term>    <term name="long-ordinal-06">sixth</term>    <term name="long-ordinal-07">seventh</term>    <term name="long-ordinal-08">eighth</term>    <term name="long-ordinal-09">ninth</term>    <term name="long-ordinal-10">tenth</term>    <term name="at">at</term>    <term name="in">in</term>    <term name="ibid">ibid</term>    <term name="accessed">accessed</term>    <term name="retrieved">retrieved</term>    <term name="from">from</term>    <term name="forthcoming">forthcoming</term>    <term name="references">      <single>reference</single>      <multiple>references</multiple>    </term>    <term name="references" form="short">      <single>ref</single>      <multiple>refs</multiple>    </term>    <term name="no date">n.d.</term>    <term name="and">and</term>    <term name="et-al">et al.</term>    <term name="interview">interview</term>    <term name="letter">letter</term>    <term name="anonymous">anonymous</term>    <term name="anonymous" form="short">anon.</term>    <term name="and others">and others</term>    <term name="in press">in press</term>    <term name="online">online</term>    <term name="cited">cited</term>    <term name="internet">internet</term>    <term name="presented at">presented at the</term>    <term name="ad">AD</term>    <term name="bc">BC</term>    <term name="season-01">Spring</term>    <term name="season-02">Summer</term>    <term name="season-03">Autumn</term>    <term name="season-04">Winter</term>    <term name="with">with</term>        <!-- CATEGORIES -->    <term name="anthropology">anthropology</term>    <term name="astronomy">astronomy</term>    <term name="biology">biology</term>    <term name="botany">botany</term>    <term name="chemistry">chemistry</term>    <term name="engineering">engineering</term>    <term name="generic-base">generic base</term>    <term name="geography">geography</term>    <term name="geology">geology</term>    <term name="history">history</term>    <term name="humanities">humanities</term>    <term name="literature">literature</term>    <term name="math">math</term>    <term name="medicine">medicine</term>    <term name="philosophy">philosophy</term>    <term name="physics">physics</term>    <term name="psychology">psychology</term>    <term name="sociology">sociology</term>    <term name="science">science</term>    <term name="political_science">political science</term>    <term name="social_science">social science</term>    <term name="theology">theology</term>    <term name="zoology">zoology</term>        <!-- LONG LOCATOR FORMS -->    <term name="book">      <single>book</single>      <multiple>books</multiple>    </term>    <term name="chapter">      <single>chapter</single>      <multiple>chapters</multiple>    </term>    <term name="column">      <single>column</single>      <multiple>columns</multiple>    </term>    <term name="figure">      <single>figure</single>      <multiple>figures</multiple>    </term>    <term name="folio">      <single>folio</single>      <multiple>folios</multiple>    </term>    <term name="issue">      <single>number</single>      <multiple>numbers</multiple>    </term>    <term name="line">      <single>line</single>      <multiple>lines</multiple>    </term>    <term name="note">      <single>note</single>      <multiple>notes</multiple>    </term>    <term name="opus">      <single>opus</single>      <multiple>opera</multiple>    </term>    <term name="page">      <single>page</single>      <multiple>pages</multiple>    </term>    <term name="paragraph">      <single>paragraph</single>      <multiple>paragraph</multiple>    </term>    <term name="part">      <single>part</single>      <multiple>parts</multiple>    </term>    <term name="section">      <single>section</single>      <multiple>sections</multiple>    </term>    <term name="volume">      <single>volume</single>      <multiple>volumes</multiple>    </term>    <term name="edition">      <single>edition</single>      <multiple>editions</multiple>    </term>    <term name="verse">      <single>verse</single>      <multiple>verses</multiple>    </term>    <term name="sub verbo">      <single>sub verbo</single>      <multiple>s.vv</multiple>    </term>        <!-- SHORT LOCATOR FORMS -->    <term name="book" form="short">bk.</term>    <term name="chapter" form="short">chap.</term>    <term name="column" form="short">col.</term>    <term name="figure" form="short">fig.</term>    <term name="folio" form="short">f.</term>    <term name="issue" form="short">no.</term>    <term name="opus" form="short">op.</term>    <term name="page" form="short">      <single>p.</single>      <multiple>pp.</multiple>    </term>    <term name="paragraph" form="short">para.</term>    <term name="part" form="short">pt.</term>    <term name="section" form="short">sec.</term>    <term name="sub verbo" form="short">      <single>s.v.</single>      <multiple>s.vv.</multiple>    </term>    <term name="verse" form="short">      <single>v.</single>      <multiple>vv.</multiple>    </term>    <term name="volume" form="short">     <single>vol.</single>     <multiple>vols.</multiple>    </term>    <term name="edition">edition</term>    <term name="edition" form="short">ed.</term>        <!-- SYMBOL LOCATOR FORMS -->    <term name="paragraph" form="symbol">      <single>¶</single>      <multiple>¶¶</multiple>    </term>    <term name="section" form="symbol">      <single>§</single>      <multiple>§§</multiple>    </term>        <!-- LONG ROLE FORMS -->    <term name="author">      <single></single>      <multiple></multiple>    </term>    <term name="editor">      <single>editor</single>      <multiple>editors</multiple>    </term>    <term name="translator">      <single>translator</single>      <multiple>translators</multiple>    </term>        <!-- SHORT ROLE FORMS -->    <term name="author" form="short">      <single></single>      <multiple></multiple>    </term>    <term name="editor" form="short">      <single>ed.</single>      <multiple>eds.</multiple>    </term>    <term name="translator" form="short">      <single>tran.</single>      <multiple>trans.</multiple>    </term>        <!-- VERB ROLE FORMS -->    <term name="editor" form="verb">edited by</term>    <term name="translator" form="verb">translated by</term>    <term name="recipient" form="verb">to</term>    <term name="interviewer" form="verb">interview by</term>        <!-- SHORT VERB ROLE FORMS -->    <term name="editor" form="verb-short">ed.</term>    <term name="translator" form="verb-short">trans.</term>        <!-- LONG MONTH FORMS -->    <term name="month-01">January</term>    <term name="month-02">February</term>    <term name="month-03">March</term>    <term name="month-04">April</term>    <term name="month-05">May</term>    <term name="month-06">June</term>    <term name="month-07">July</term>    <term name="month-08">August</term>    <term name="month-09">September</term>    <term name="month-10">October</term>    <term name="month-11">November</term>    <term name="month-12">December</term>        <!-- SHORT MONTH FORMS -->    <term name="month-01" form="short">Jan.</term>    <term name="month-02" form="short">Feb.</term>    <term name="month-03" form="short">Mar.</term>    <term name="month-04" form="short">Apr.</term> <term name="month-05" form="short">May</term>    <term name="month-06" form="short">Jun.</term>    <term name="month-07" form="short">Jul.</term>    <term name="month-08" form="short">Aug.</term>    <term name="month-09" form="short">Sep.</term>    <term name="month-10" form="short">Oct.</term>    <term name="month-11" form="short">Nov.</term>    <term name="month-12" form="short">Dec.</term>  </terms></locale>'},e.exports=n},{}],330:[function(t,e,i){function n(){this.lastSearch="",this.lastResult=[],this.name="crossref",this.label="CrossRef"}var s=t("substance/util/jquery");n.resolveDOI=function(t){var e=s.Deferred();return/^http:/.exec(t)||(t="http://dx.doi.org/"+t),s.ajax(t,{type:"GET",crossDomain:!0,cache:!1,headers:{Accept:"application/citeproc+json"},success:function(t){e.resolve(t)},error:function(t,i,n){window.console.error("Could not retrieve data from cross-ref",i,n),e.rejectWith(null,n)}}),e},n.prototype.find=function(t,e){var i,r,o,a,l=s.Deferred(),u=this;return this.lastSearch===t?(a=this.lastResult,window.setTimeout(function(){a.forEach(function(t){l.notifyWith(e,[t])}),l.resolveWith(e)},0)):(this.lastSearch="",this.lastSearch=[],a=[],i=t.trim().toLowerCase().split(/\s+/),r=i.join("+"),o=0,s.ajax("http://search.crossref.org/dois",{data:{q:r,sort:"score"},success:function(i){function s(){if(o<i.length){var r=i[o++],c=n.resolveDOI(r.doi);c.done(function(t){"pending"===l.state()&&(a.push(t),l.notifyWith(e,[t]))}).always(function(){"pending"===l.state()&&s()})}else u.lastSearch=t,u.lastResult=a,l.resolveWith(e)}s()},error:function(t,i,n){l.rejectWith(e,[n])}})),l},e.exports=n},{"substance/util/jquery":316}],331:[function(t,e,n){Array.indexOf||(Array.prototype.indexOf=function(t){var e,i;for(e=0,i=this.length;i>e;e+=1)if(this[e]===t)return e;return-1});var s={PROCESSOR_VERSION:"1.0.542",CONDITION_LEVEL_TOP:1,CONDITION_LEVEL_BOTTOM:2,PLAIN_HYPHEN_REGEX:/(?:[^\\]-|\u2013)/,LOCATOR_LABELS_REGEXP:new RegExp("^((art|ch|Ch|subch|col|fig|l|n|no|op|p|pp|para|subpara|pt|r|sec|subsec|Sec|sv|sch|tit|vrs|vol)\\.)\\s+(.*)"),STATUTE_SUBDIV_GROUPED_REGEX:/((?:^| )(?:art|ch|Ch|subch|p|pp|para|subpara|pt|r|sec|subsec|Sec|sch|tit)\.)/g,STATUTE_SUBDIV_PLAIN_REGEX:/(?:(?:^| )(?:art|ch|Ch|subch|p|pp|para|subpara|pt|r|sec|subsec|Sec|sch|tit)\.)/,STATUTE_SUBDIV_STRINGS:{"art.":"article","bk.":"book","ch.":"chapter","Ch.":"Chapter",
"subch.":"subchapter","p.":"page","pp.":"page","para.":"paragraph","subpara.":"subparagraph","pt.":"part","r.":"rule","sec.":"section","subsec.":"subsection","Sec.":"Section","sch.":"schedule","tit.":"title","col.":"column","fig.":"figure","fol.":"folio","l.":"line","n.":"note","no.":"issue","op.":"opus","sv.":"sub-verbo","vrs.":"verse","vol.":"volume"},STATUTE_SUBDIV_STRINGS_REVERSE:{article:"art.",book:"bk.",chapter:"ch.",Chapter:"Ch.",subchapter:"subch.",page:"p.",paragraph:"para.",subparagraph:"subpara.",part:"pt.",rule:"r.",section:"sec.",subsection:"subsec.",Section:"Sec.",schedule:"sch.",title:"tit.",column:"col.",figure:"fig.",folio:"fol.",line:"l.",note:"n.",issue:"no.",opus:"op.","sub-verbo":"sv.","sub verbo":"sv.",verse:"vrs.",volume:"vol."},LOCATOR_LABELS_MAP:{art:"article",bk:"book",ch:"chapter",Ch:"Chapter",subch:"subchapter",col:"column",fig:"figure",fol:"folio",l:"line",n:"note",no:"issue",op:"opus",p:"page",pp:"page",para:"paragraph",subpara:"subparagraph",pt:"part",r:"rule",sec:"section",subsec:"subsection",Sec:"Section",sv:"sub-verbo",sch:"schedule",tit:"title",vrs:"verse",vol:"volume"},NestedBraces:[["(","["],[")","]"]],checkNestedBraceOpen:new RegExp(".*\\("),checkNestedBraceClose:new RegExp(".*\\)"),LangPrefsMap:{title:"titles","title-short":"titles","container-title":"journals","collection-title":"journals",publisher:"publishers",authority:"publishers","publisher-place":"places","event-place":"places",number:"number",edition:"number",issue:"number",volume:"number"},AbbreviationSegments:function(){this["container-title"]={},this["collection-title"]={},this["institution-entire"]={},this["institution-part"]={},this.nickname={},this.number={},this.title={},this.place={},this.hereinafter={},this.classic={},this["container-phrase"]={},this["title-phrase"]={}},GENDERS:["masculine","feminine"],ERROR_NO_RENDERED_FORM:1,PREVIEW:"Just for laughs.",ASSUME_ALL_ITEMS_REGISTERED:2,START:0,END:1,SINGLETON:2,SEEN:6,SUCCESSOR:3,SUCCESSOR_OF_SUCCESSOR:4,SUPPRESS:5,SINGULAR:0,PLURAL:1,LITERAL:!0,BEFORE:1,AFTER:2,DESCENDING:1,ASCENDING:2,ONLY_FIRST:1,ALWAYS:2,ONLY_LAST:3,FINISH:1,POSITION_FIRST:0,POSITION_SUBSEQUENT:1,POSITION_IBID:2,POSITION_IBID_WITH_LOCATOR:3,MARK_TRAILING_NAMES:!0,POSITION_TEST_VARS:["position","first-reference-note-number","near-note"],AREAS:["citation","citation_sort","bibliography","bibliography_sort"],MULTI_FIELDS:["event","publisher","publisher-place","event-place","title","container-title","collection-title","authority","edition","genre","title-short","medium","jurisdiction","archive","archive-place"],CITE_FIELDS:["first-reference-note-number","locator","locator-revision"],MINIMAL_NAME_FIELDS:["literal","family"],SWAPPING_PUNCTUATION:[".","!","?",":",","],TERMINAL_PUNCTUATION:[":",".",";","!","?"," "],NONE:0,NUMERIC:1,POSITION:2,COLLAPSE_VALUES:["citation-number","year","year-suffix"],DATE_PARTS:["year","month","day"],DATE_PARTS_ALL:["year","month","day","season"],DATE_PARTS_INTERNAL:["year","month","day","year_end","month_end","day_end"],NAME_PARTS:["family","given","dropping-particle","non-dropping-particle","suffix","literal"],DECORABLE_NAME_PARTS:["given","family","suffix"],DISAMBIGUATE_OPTIONS:["disambiguate-add-names","disambiguate-add-givenname","disambiguate-add-year-suffix"],GIVENNAME_DISAMBIGUATION_RULES:["all-names","all-names-with-initials","primary-name","primary-name-with-initials","by-cite"],NAME_ATTRIBUTES:["and","delimiter-precedes-last","delimiter-precedes-et-al","initialize-with","initialize","name-as-sort-order","sort-separator","et-al-min","et-al-use-first","et-al-subsequent-min","et-al-subsequent-use-first","form","prefix","suffix","delimiter"],PARALLEL_MATCH_VARS:["container-title"],PARALLEL_TYPES:["bill","gazette","regulation","legislation","legal_case","treaty","article-magazine","article-journal"],PARALLEL_COLLAPSING_MID_VARSET:["volume","issue","container-title","section","collection-number"],LOOSE:0,STRICT:1,TOLERANT:2,PREFIX_PUNCTUATION:/[.;:]\s*$/,SUFFIX_PUNCTUATION:/^\s*[.;:,\(\)]/,NUMBER_REGEXP:/(?:^\d+|\d+$)/,NAME_INITIAL_REGEXP:/^([A-Z\u0590-\u05ff\u0080-\u017f\u0400-\u042f\u0600-\u06ff\u0370\u0372\u0376\u0386\u0388-\u03ab\u03e2\u03e4\u03e6\u03e8\u03ea\u03ec\u03ee\u03f4\u03f7\u03fd-\u03ff])([a-zA-Z\u0080-\u017f\u0400-\u052f\u0600-\u06ff\u0370-\u03ff\u1f00-\u1fff]*|)/,ROMANESQUE_REGEXP:/[-0-9a-zA-Z\u0590-\u05d4\u05d6-\u05ff\u0080-\u017f\u0400-\u052f\u0370-\u03ff\u1f00-\u1fff\u0600-\u06ff\u200c\u200d\u200e\u0218\u0219\u021a\u021b\u202a-\u202e]/,ROMANESQUE_NOT_REGEXP:/[^a-zA-Z\u0590-\u05ff\u0080-\u017f\u0400-\u052f\u0370-\u03ff\u1f00-\u1fff\u0600-\u06ff\u200c\u200d\u200e\u0218\u0219\u021a\u021b\u202a-\u202e]/g,STARTSWITH_ROMANESQUE_REGEXP:/^[&a-zA-Z\u0590-\u05d4\u05d6-\u05ff\u0080-\u017f\u0400-\u052f\u0370-\u03ff\u1f00-\u1fff\u0600-\u06ff\u200c\u200d\u200e\u0218\u0219\u021a\u021b\u202a-\u202e]/,ENDSWITH_ROMANESQUE_REGEXP:/[.;:&a-zA-Z\u0590-\u05d4\u05d6-\u05ff\u0080-\u017f\u0400-\u052f\u0370-\u03ff\u1f00-\u1fff\u0600-\u06ff\u200c\u200d\u200e\u0218\u0219\u021a\u021b\u202a-\u202e]$/,ALL_ROMANESQUE_REGEXP:/^[a-zA-Z\u0590-\u05ff\u0080-\u017f\u0400-\u052f\u0370-\u03ff\u1f00-\u1fff\u0600-\u06ff\u200c\u200d\u200e\u0218\u0219\u021a\u021b\u202a-\u202e]+$/,VIETNAMESE_SPECIALS:/[\u00c0-\u00c3\u00c8-\u00ca\u00cc\u00cd\u00d2-\u00d5\u00d9\u00da\u00dd\u00e0-\u00e3\u00e8-\u00ea\u00ec\u00ed\u00f2-\u00f5\u00f9\u00fa\u00fd\u0101\u0103\u0110\u0111\u0128\u0129\u0168\u0169\u01a0\u01a1\u01af\u01b0\u1ea0-\u1ef9]/,VIETNAMESE_NAMES:/^(?:(?:[.AaBbCcDdEeGgHhIiKkLlMmNnOoPpQqRrSsTtUuVvXxYy \u00c0-\u00c3\u00c8-\u00ca\u00cc\u00cd\u00d2-\u00d5\u00d9\u00da\u00dd\u00e0-\u00e3\u00e8-\u00ea\u00ec\u00ed\u00f2-\u00f5\u00f9\u00fa\u00fd\u0101\u0103\u0110\u0111\u0128\u0129\u0168\u0169\u01a0\u01a1\u01af\u01b0\u1ea0-\u1ef9]{2,6})(\s+|$))+$/,NOTE_FIELDS_REGEXP:/\{:(?:[\-_a-z]+|[A-Z]+):[^\}]+\}/g,NOTE_FIELD_REGEXP:/\{:([\-_a-z]+|[A-Z]+):\s*([^\}]+)\}/,DISPLAY_CLASSES:["block","left-margin","right-inline","indent"],NAME_VARIABLES:["author","editor","translator","contributor","collection-editor","composer","container-author","director","editorial-director","interviewer","original-author","recipient"],NUMERIC_VARIABLES:["call-number","chapter-number","collection-number","edition","page","issue","locator","number","number-of-pages","number-of-volumes","volume","citation-number"],DATE_VARIABLES:["locator-date","issued","event-date","accessed","container","original-date","publication-date","original-date","available-date","submitted"],TAG_ESCAPE:function(t){var e,i,n,s,r;for(e=t.match(/((?:\"|\')|(?:(?:<span\s+class=\"no(?:case|decor)\">).*?(?:<\/span>|<\/?(?:i|sc|b)>)))/g),i=t.split(/(?:(?:\"|\')|(?:(?:<span\s+class=\"no(?:case|decor)\">).*?(?:<\/span>|<\/?(?:i|sc|b)>)))/g),r=[i[0]],s=1,n=i.length;n>s;s+=1)r.push(e[s-1]),r.push(i[s]);return i=r.slice()},TAG_USEALL:function(t){var e,i,n,s;for(e=[""],i=t.indexOf("<"),n=t.indexOf(">");i>-1&&n>-1;)s=i>n?i+1:n+1,n>i&&-1===t.slice(i+1,n).indexOf("<")?(e[e.length-1]+=t.slice(0,i),e.push(t.slice(i,n+1)),e.push(""),t=t.slice(s)):(e[e.length-1]+=t.slice(0,n+1),t=t.slice(s)),i=t.indexOf("<"),n=t.indexOf(">");return e[e.length-1]+=t,e},SKIP_WORDS:["about","above","across","afore","after","against","along","alongside","amid","amidst","among","amongst","anenst","apropos","apud","around","as","aside","astride","at","athwart","atop","barring","before","behind","below","beneath","beside","besides","between","beyond","but","by","circa","despite","down","during","except","for","forenenst","from","given","in","inside","into","lest","like","modulo","near","next","notwithstanding","of","off","on","onto","out","over","per","plus","pro","qua","sans","since","than","through"," thru","throughout","thruout","till","to","toward","towards","under","underneath","until","unto","up","upon","versus","vs.","v.","vs","v","via","vis-Ã -vis","with","within","without","according to","ahead of","apart from","as for","as of","as per","as regards","aside from","back to","because of","close to","due to","except for","far from","inside of","instead of","near to","next to","on to","out from","out of","outside of","prior to","pursuant to","rather than","regardless of","such as","that of","up to","where as","or","yet","so","for","and","nor","a","an","the","de","d'","von","van","c","et","ca"],FORMAT_KEY_SEQUENCE:["@strip-periods","@font-style","@font-variant","@font-weight","@text-decoration","@vertical-align","@quotes"],INSTITUTION_KEYS:["font-style","font-variant","font-weight","text-decoration","text-case"],SUFFIX_CHARS:"a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z",ROMAN_NUMERALS:[["","i","ii","iii","iv","v","vi","vii","viii","ix"],["","x","xx","xxx","xl","l","lx","lxx","lxxx","xc"],["","c","cc","ccc","cd","d","dc","dcc","dccc","cm"],["","m","mm","mmm","mmmm","mmmmm"]],CREATORS:["author","editor","contributor","translator","recipient","interviewer","composer","original-author","container-author","collection-editor"],LANGS:{"af-ZA":"Afrikaans","ar-AR":"Arabic","bg-BG":"Bulgarian","ca-AD":"Catalan","cs-CZ":"Czech","da-DK":"Danish","de-AT":"Austrian","de-CH":"German (CH)","de-DE":"German (DE)","el-GR":"Greek","en-GB":"English (GB)","en-US":"English (US)","es-ES":"Spanish","et-EE":"Estonian",eu:"European","fa-IR":"Persian","fi-FI":"Finnish","fr-CA":"French (CA)","fr-FR":"French (FR)","he-IL":"Hebrew","hr-HR":"Croatian","hu-HU":"Hungarian","is-IS":"Icelandic","it-IT":"Italian","ja-JP":"Japanese","km-KH":"Khmer","ko-KR":"Korean","lt-LT":"Lithuanian","lv-LV":"Latvian","mn-MN":"Mongolian","nb-NO":"Norwegian (BokmÃ¥l)","nl-NL":"Dutch","nn-NO":"Norwegian (Nynorsk)","pl-PL":"Polish","pt-BR":"Portuguese (BR)","pt-PT":"Portuguese (PT)","ro-RO":"Romanian","ru-RU":"Russian","sk-SK":"Slovak","sl-SI":"Slovenian","sr-RS":"Serbian","sv-SE":"Swedish","th-TH":"Thai","tr-TR":"Turkish","uk-UA":"Ukranian","vi-VN":"Vietnamese","zh-CN":"Chinese (CN)","zh-TW":"Chinese (TW)"},LANG_BASES:{af:"af_ZA",ar:"ar_AR",bg:"bg_BG",ca:"ca_AD",cs:"cs_CZ",da:"da_DK",de:"de_DE",el:"el_GR",en:"en_US",es:"es_ES",et:"et_EE",eu:"eu",fa:"fa_IR",fi:"fi_FI",fr:"fr_FR",he:"he_IL",hu:"hu_HU",is:"is_IS",it:"it_IT",ja:"ja_JP",km:"km_KH",ko:"ko_KR",lt:"lt_LT",mn:"mn_MN",nb:"nb_NO",nl:"nl_NL",nn:"nn-NO",pl:"pl_PL",pt:"pt_PT",ro:"ro_RO",ru:"ru_RU",sk:"sk_SK",sl:"sl_SI",sr:"sr_RS",sv:"sv_SE",th:"th_TH",tr:"tr_TR",uk:"uk_UA",vi:"vi_VN",zh:"zh_CN"},SUPERSCRIPTS:{"ª":"a","²":"2","³":"3","¹":"1","º":"o","ʰ":"h","ʱ":"ɦ","ʲ":"j","ʳ":"r","ʴ":"ɹ","ʵ":"ɻ","ʶ":"ʁ","ʷ":"w","ʸ":"y","ˠ":"ɣ","ˡ":"l","ˢ":"s","ˣ":"x","ˤ":"ʕ","ᴬ":"A","ᴭ":"Æ","ᴮ":"B","ᴰ":"D","ᴱ":"E","ᴲ":"Ǝ","ᴳ":"G","ᴴ":"H","ᴵ":"I","ᴶ":"J","ᴷ":"K","ᴸ":"L","ᴹ":"M","ᴺ":"N","ᴼ":"O","ᴽ":"Ȣ","ᴾ":"P","ᴿ":"R","ᵀ":"T","ᵁ":"U","ᵂ":"W","ᵃ":"a","ᵄ":"ɐ","ᵅ":"ɑ","ᵆ":"ᴂ","ᵇ":"b","ᵈ":"d","ᵉ":"e","ᵊ":"ə","ᵋ":"ɛ","ᵌ":"ɜ","ᵍ":"g","ᵏ":"k","ᵐ":"m","ᵑ":"ŋ","ᵒ":"o","ᵓ":"ɔ","ᵔ":"ᴖ","ᵕ":"ᴗ","ᵖ":"p","ᵗ":"t","ᵘ":"u","ᵙ":"ᴝ","ᵚ":"ɯ","ᵛ":"v","ᵜ":"ᴥ","ᵝ":"β","ᵞ":"γ","ᵟ":"δ","ᵠ":"φ","ᵡ":"χ","⁰":"0","ⁱ":"i","⁴":"4","⁵":"5","⁶":"6","⁷":"7","⁸":"8","⁹":"9","⁺":"+","⁻":"−","⁼":"=","⁽":"(","⁾":")","ⁿ":"n","℠":"SM","™":"TM","㆒":"一","㆓":"二","㆔":"三","㆕":"四","㆖":"上","㆗":"中","㆘":"下","㆙":"甲","㆚":"乙","㆛":"丙","㆜":"丁","㆝":"天","㆞":"地","㆟":"人","ˀ":"ʔ","ˁ":"ʕ","ۥ":"و","ۦ":"ي"},SUPERSCRIPTS_REGEXP:new RegExp("[ª²³¹ºʰʱʲʳʴʵʶʷʸˠˡˢˣˤᴬᴭᴮᴰᴱᴲᴳᴴᴵᴶᴷᴸᴹᴺᴼᴽᴾᴿᵀᵁᵂᵃᵄᵅᵆᵇᵈᵉᵊᵋᵌᵍᵏᵐᵑᵒᵓᵔᵕᵖᵗᵘᵙᵚᵛᵜᵝᵞᵟᵠᵡ⁰ⁱ⁴⁵⁶⁷⁸⁹⁺⁻⁼⁽⁾ⁿ℠™㆒㆓㆔㆕㆖㆗㆘㆙㆚㆛㆜㆝㆞㆟ˀˁۥۦ]","g"),locale:{},locale_opts:{},locale_dates:{}};if("undefined"!=typeof t&&"undefined"!=typeof e&&"exports"in e){var r=!0,o=t("./csl_nodejs_jsdom").CSL_NODEJS_JSDOM;n.CSL=s}s.TERMINAL_PUNCTUATION_REGEXP=new RegExp("^(["+s.TERMINAL_PUNCTUATION.slice(0,-1).join("")+"])(.*)"),s.CLOSURES=new RegExp(".*[\\]\\)]"),"object"==typeof console&&"function"==typeof console.log?(s.debug=function(t){console.log("CSL: "+t)},s.error=function(t){console.log("CSL error: "+t)}):(s.debug=function(){},s.error=function(t){throw"CSL error: "+t});var a;a="undefined"!=typeof r?o:"undefined"!=typeof CSL_E4X?CSL_E4X:"undefined"!=typeof CSL_JSON?CSL_JSON:CSL_CHROME,s.System={},s.System.Xml={Parsing:a},s.getSortCompare=function(t){if(s.stringCompare)return s.stringCompare;var e,i={sensitivity:"base",ignorePunctuation:!0,numeric:!0};t||(t="en-US"),e=function(e,n){return e.toLocaleLowerCase().localeCompare(n.toLocaleLowerCase(),t,i)};var n=function(t){return t.replace(/^[\[\]\'\"]*/g,"")},r=function(){return e("[x","x")?function(t,i){return e(n(t),n(i))}:!1},o=r(),a=function(t,i){return o?o(t,i):e(t,i)};return a},s.ambigConfigDiff=function(t,e){var i,n,s,r;if(t.names.length!==e.names.length)return 1;for(i=0,n=t.names.length;n>i;i+=1){if(t.names[i]!==e.names[i])return 1;for(s=0,r=t.givens[i];r>s;s+=1)if(t.givens[i][s]!==e.givens[i][s])return 1}return t.disambiguate!=e.disambiguate?1:t.year_suffix!==e.year_suffix?1:0},s.cloneAmbigConfig=function(t,e,i){var n,s,r,o,a,l={};for(l.names=[],l.givens=[],l.year_suffix=!1,l.disambiguate=!1,n=0,s=t.names.length;s>n;n+=1)a=t.names[n],l.names[n]=a;for(n=0,s=t.givens.length;s>n;n+=1){for(a=[],r=0,o=t.givens[n].length;o>r;r+=1)a.push(t.givens[n][r]);l.givens.push(a)}return e?(l.year_suffix=e.year_suffix,l.disambiguate=e.disambiguate):(l.year_suffix=t.year_suffix,l.disambiguate=t.disambiguate),l},s.getAmbigConfig=function(){var t,e;return t=this.tmp.disambig_request,t||(t=this.tmp.disambig_settings),e=s.cloneAmbigConfig(t)},s.getMaxVals=function(){return this.tmp.names_max.mystack.slice()},s.getMinVal=function(){return this.tmp["et-al-min"]},s.tokenExec=function(t,e,i){var n,s,r,o,a,l;l=!1,n=t.next,s=!1;var u=function(e){return e?(this.tmp.jump.replace("succeed"),t.succeed):(this.tmp.jump.replace("fail"),t.fail)};for(t.test&&(n=u.call(this,t.test(e,i))),a=t.execs.length,o=0;a>o;o+=1)r=t.execs[o],s=r.call(t,this,e,i),s&&(n=s);return n},s.expandMacro=function(t){var e,i,n,r;if(e=t.postponed_macro,this.build.macro_stack.indexOf(e)>-1)throw'CSL processor error: call to macro "'+e+'" would cause an infinite loop';this.build.macro_stack.push(e);var o=!1,a=!1;if(i=this.sys.xml.getNodesByName(this.cslXml,"macro",e),i.length&&(a=this.sys.xml.getAttributeValue(i[0],"cslid"),o=this.sys.xml.getAttributeValue(i[0],"macro-has-date")),o&&(r=function(t,e){t.tmp.extension&&(t.tmp["doing-macro-with-date"]=!0)},t.execs.push(r)),t.tokentype=s.START,t.cslid=a,s.Node.group.build.call(t,this,this[this.build.area].tokens,!0),!this.sys.xml.getNodeValue(i))throw'CSL style error: undefined macro "'+e+'"';var l=s.makeBuilder(this);l(i[0]),n=new s.Token("group",s.END),t.decorations&&(n.decorations=t.decorations.slice()),o&&(r=function(t,e){t.tmp.extension&&(t.tmp["doing-macro-with-date"]=!1)},n.execs.push(r)),s.Node.group.build.call(n,this,this[this.build.area].tokens,!0),this.build.macro_stack.pop()},s.XmlToToken=function(t,e){var i,n,r,o,a,l,u,c;if(i=t.sys.xml.nodename(this),!t.build.skip||t.build.skip===i){if(!i)return n=t.sys.xml.content(this),void(n&&(t.build.text=n));if(!s.Node[t.sys.xml.nodename(this)])throw'Undefined node name "'+i+'".';if(r=[],o=t.sys.xml.attributes(this),a=s.setDecorations.call(this,t,o),l=new s.Token(i,e),e!==s.END||"if"===i||"else-if"===i||"layout"===i){for(u in o)if(o.hasOwnProperty(u)){if(e===s.END&&"@language"!==u&&"@locale"!==u)continue;if(o.hasOwnProperty(u))if(s.Attributes[u])try{s.Attributes[u].call(l,t,""+o[u])}catch(h){throw s.error(h),"CSL processor error, "+u+" attribute: "+h}else s.debug('warning: undefined attribute "'+u+'" in style')}l.decorations=a}else e===s.END&&o["@variable"]&&(l.hasVariable=!0);c=t[t.build.area].tokens,s.Node[i].build.call(l,t,c)}},s.DateParser=function(){var t,e,i,n,r,o,a,l,u,c,h,p,d,f,m,g,b,y,v,_,x,C,w,S,T;for(t=[["明治",1867],["大正",1911],["昭和",1925],["平成",1988]],e={},w=t.length,a=0;w>a;a+=1)l=t[a][0],u=t[a][1],e[l]=u;for(S=[],a=0;w>a;a+=1)u=t[a][0],S.push(u);for(S=S.join("|"),i="(?:"+S+")(?:[0-9]+)",i=new RegExp(i),T="(?:"+S+")(?:[0-9]+)",T=new RegExp(T,"g"),r=/(\u6708|\u5E74)/g,n=/\u65E5/,o=/\u301c/g,c="(?:[?0-9]{1,2}%%NUMD%%){0,2}[?0-9]{4}(?![0-9])",h="[?0-9]{4}(?:%%NUMD%%[?0-9]{1,2}){0,2}(?![0-9])",p="[?0-9]{1,3}",d="[%%DATED%%]",f="[?~]",m="[a-zA-Z]+",g="("+h+"|"+c+"|"+p+"|"+d+"|"+f+"|"+m+")",b=new RegExp(g.replace(/%%NUMD%%/g,"-").replace(/%%DATED%%/g,"-")),y=new RegExp(g.replace(/%%NUMD%%/g,"-").replace(/%%DATED%%/g,"/")),v=new RegExp(g.replace(/%%NUMD%%/g,"/").replace(/%%DATED%%/g,"-")),_=[],x=[],w=_.length,a=0;w>a;a+=1)C=new RegExp(_[a]+".*"),x.push(C);this.mstrings="january february march april may june july august september october november december spring summer fall winter spring summer",this.mstrings=this.mstrings.split(" "),this.setOrderDayMonth=function(){this.monthguess=1,this.dayguess=0},this.setOrderMonthDay=function(){this.monthguess=0,this.dayguess=1},this.setOrderMonthDay(),this.resetMonths=function(){var t,e,i,n;for(this.msets=[],t=0,e=this.mstrings.length;e>t;t+=1)this.msets.push([this.mstrings[t]]);for(this.mabbrevs=[],t=0,e=this.msets.length;e>t;t+=1)for(this.mabbrevs.push([]),i=0,n=this.msets[t].length;n>i;i+=1)this.mabbrevs[t].push(this.msets[t][0].slice(0,3));for(this.mrexes=[],t=0,e=this.mabbrevs.length;e>t;t+=1)this.mrexes.push(new RegExp("(?:"+this.mabbrevs[t].join("|")+")"))},this.resetMonths(),this.addMonths=function(t){var e,i,n,r,o,a,l,u;if("string"==typeof t&&(t=t.split(/\s+/)),12!==t.length&&16!==t.length)return void s.debug("month [+season] list of "+t.length+", expected 12 or 16. Ignoring.");for(e=0,i=t.length;i>e;e+=1){var c=!1,h=!1,p=3,d={};for(n=0,r=this.mabbrevs.length;r>n;n+=1){if(d[n]={},n===e){for(o=0,a=this.mabbrevs[e].length;a>o;o+=1)if(this.mabbrevs[e][o]===t[e].slice(0,this.mabbrevs[e][o].length)){h=!0;break}}else for(o=0,a=this.mabbrevs[n].length;a>o;o+=1)if(c=this.mabbrevs[n][o].length,this.mabbrevs[n][o]===t[e].slice(0,c)){for(;this.msets[n][o].slice(0,c)===t[e].slice(0,c);){if(c>t[e].length||c>this.msets[n][o].length){s.debug("unable to disambiguate month string in date parser: "+t[e]);break}c+=1}p=c,d[n][o]=c}for(l in d)if(d.hasOwnProperty(l))for(u in d[l])d[l].hasOwnProperty(u)&&(c=d[l][u],l=parseInt(l,10),u=parseInt(u,10),this.mabbrevs[l][u]=this.msets[l][u].slice(0,c))}h||(this.msets[e].push(t[e]),this.mabbrevs[e].push(t[e].slice(0,p)))}for(this.mrexes=[],e=0,i=this.mabbrevs.length;i>e;e+=1)this.mrexes.push(new RegExp("(?:"+this.mabbrevs[e].join("|")+")"))},this.parse=function(t){var l,u,c,h,p,d,f,m,g,_,C,S,E,I,N,A,O,k,P,D,R,j,L,F,M,q,B,U,$,H;if(t&&(t=""+t,t=t.replace(/\s*[0-9]{2}:[0-9]{2}(?::[0-9]+)/,""),p=t.match(r))){if(t=t.replace(/\s+/,"","g"),t=t.replace(n,"","g"),t=t.replace(r,"-","g"),t=t.replace(o,"/","g"),t=t.replace("-/","/","g"),t=t.replace(/-$/,"","g"),L=t.split(i),c=[],j=t.match(T)){var z=[];for(a=0,w=j.length;w>a;a+=1)z=z.concat(j[a].match(/([^0-9]+)([0-9]+)/).slice(1));for(a=0,w=L.length;w>a;a+=1)c.push(L[a]),a!==w-1&&(F=2*a,c.push(z[F]),c.push(z[F+1]))}else c=L;for(h=c.length,a=1;h>a;a+=3)c[a+1]=e[c[a]]+parseInt(c[a+1],10),c[a]="";t=c.join(""),t=t.replace(/\s*-\s*$/,"").replace(/\s*-\s*\//,"/"),t=t.replace(/\.\s*$/,""),t=t.replace(/\.(?! )/,""),l=t.indexOf("/"),u=t.indexOf("-")}if(t=t.replace(/([A-Za-z])\./g,"$1"),d="",f="",m={},'"'===t.slice(0,1)&&'"'===t.slice(-1))return m.literal=t.slice(1,-1),m;for(l>-1&&u>-1?(g=t.split("/"),g.length>3?(_="-",C="/",c=t.split(v)):(_="/",C="-",c=t.split(y))):(t=t.replace("/","-"),_="-",C="-",c=t.split(b)),S=[],w=c.length,a=0;w>a;a+=1)P=c[a],p=P.match(/^\s*([\-\/]|[a-zA-Z]+|[\-~?0-9]+)\s*$/),p&&S.push(p[1]);for(E=S.indexOf(_),I=[],N=!1,E>-1?(I.push([0,E]),I.push([E+1,S.length]),N=!0):I.push([0,S.length]),A="",M=0,q=I.length;q>M;M+=1){for(D=I[M],O=S.slice(D[0],D[1]),B=0,U=O.length;U>B;B+=1)if(R=O[B],R.indexOf(C)>-1)this.parseNumericDate(m,C,A,R);else if(R.match(/[0-9]{4}/))m["year"+A]=R.replace(/^0*/,"");else{for(k=!1,$=0,H=this.mrexes.length;H>$;$+=1){if(R.toLocaleLowerCase().match(this.mrexes[$])){m["month"+A]=""+(parseInt($,10)+1),k=!0;break}k||(R.match(/^[0-9]+$/)&&(d=parseInt(R,10)),R.toLocaleLowerCase().match(/^bc/)&&d?(m["year"+A]=""+-1*d,d=""):R.toLocaleLowerCase().match(/^ad/)&&d&&(m["year"+A]=""+d,d=""))}for(k=!1,$=0,H=x.length;H>$;$+=1)if(R.toLocaleLowerCase().match(x[$])){m["season"+A]=""+(parseInt($,10)+1),k=!0;break}k||("~"===R||"?"===R||"c"===R||R.match(/^cir/)?m.circa="1":!R.toLocaleLowerCase().match(/(?:mic|tri|hil|eas)/)||m["season"+A]||(f=R))}d&&(m["day"+A]=d,d=""),f&&!m["season"+A]&&(m["season"+A]=f,f=""),A="_end"}if(N)for(B=0,U=s.DATE_PARTS_ALL.length;U>B;B+=1)P=s.DATE_PARTS_ALL[B],m[P]&&!m[P+"_end"]?m[P+"_end"]=m[P]:!m[P]&&m[P+"_end"]&&(m[P]=m[P+"_end"]);return m.year||(m={literal:t}),this.use_array&&this.toArray(m),m},this.returnAsArray=function(){this.use_array=!0},this.returnAsKeys=function(){this.use_array=!1},this.toArray=function(t){var e,i,n;t["date-parts"]=[],t["date-parts"].push([]);var s=0;for(e=0,i=3;i>e&&(n=["year","month","day"][e],t[n]);e+=1)s+=1,t["date-parts"][0].push(t[n]),delete t[n];for(t["date-parts"].push([]),e=0,i=s;i>e&&(n=["year_end","month_end","day_end"][e],t[n]);e+=1)t["date-parts"][1].push(t[n]),delete t[n];t["date-parts"][0].length!==t["date-parts"][1].length&&t["date-parts"].pop()},this.parseNumericDate=function(t,e,i,n){var s,r,o;for(s=n.split(e),r=0,o=s.length;o>r;r+=1)if(4===s[r].length){t["year"+i]=s[r].replace(/^0*/,""),s=r?s.slice(0,r):s.slice(1);break}for(r=0,o=s.length;o>r;r+=1)s[r]=parseInt(s[r],10);1===s.length||2===s.length&&!s[1]?t["month"+i]=""+s[0]:2===s.length&&(s[this.monthguess]>12?(t["month"+i]=""+s[this.dayguess],t["day"+i]=""+s[this.monthguess]):(t["month"+i]=""+s[this.monthguess],t["day"+i]=""+s[this.dayguess]))}},s.Engine=function(t,e,i,n){function r(t){var t=t.slice(),e=new RegExp("((?:[?!:]*\\s+|-|^)(?:"+t.join("|")+")(?=[!?:]*\\s+|-|$))");return e}var o,a;this.processor_version=s.PROCESSOR_VERSION,this.csl_version="1.0",this.sys=t,t.variableWrapper&&(s.VARIABLE_WRAPPER_PREPUNCT_REX=new RegExp("^(["+[" "].concat(s.SWAPPING_PUNCTUATION).join("")+"]*)(.*)")),this.sys.xml=new s.System.Xml.Parsing,"undefined"==typeof CSL_JSON&&"string"!=typeof e&&(e=""),s.getAbbreviation&&(this.sys.getAbbreviation=s.getAbbreviation),this.sys.stringCompare&&(s.stringCompare=this.sys.stringCompare),this.sys.AbbreviationSegments=s.AbbreviationSegments,this.parallel=new s.Parallel(this),this.transform=new s.Transform(this),this.setParseNames=function(t){this.opt["parse-names"]=t},this.opt=new s.Engine.Opt,this.tmp=new s.Engine.Tmp,this.build=new s.Engine.Build,this.fun=new s.Engine.Fun(this),this.configure=new s.Engine.Configure,this.citation_sort=new s.Engine.CitationSort,this.bibliography_sort=new s.Engine.BibliographySort,this.citation=new s.Engine.Citation(this),this.bibliography=new s.Engine.Bibliography,this.output=new s.Output.Queue(this),this.dateput=new s.Output.Queue(this),this.cslXml=this.sys.xml.makeXml(e),(this.opt.development_extensions.csl_reverse_lookup_support||this.sys.csl_reverse_lookup_support)&&(this.build.cslNodeId=0,this.setCslNodeIds=function(t,e){var i=this.sys.xml.children(t);this.sys.xml.setAttribute(t,"cslid",this.build.cslNodeId),this.opt.nodenames.push(e),this.build.cslNodeId+=1;for(var n=0,s=this.sys.xml.numberofnodes(i);s>n;n+=1)e=this.sys.xml.nodename(i[n]),e&&this.setCslNodeIds(i[n],e)},this.setCslNodeIds(this.cslXml,"style")),this.sys.xml.addMissingNameNodes(this.cslXml),this.sys.xml.addInstitutionNodes(this.cslXml),this.sys.xml.insertPublisherAndPlace(this.cslXml),this.sys.xml.flagDateMacros(this.cslXml),o=this.sys.xml.attributes(this.cslXml),"undefined"==typeof o["@sort-separator"]&&this.sys.xml.setAttribute(this.cslXml,"sort-separator",", "),this.opt["initialize-with-hyphen"]=!0,this.setStyleAttributes(),this.opt.xclass=t.xml.getAttributeValue(this.cslXml,"class"),this.opt.styleID=this.sys.xml.getStyleId(this.cslXml),this.opt.styleName=this.sys.xml.getStyleId(this.cslXml,!0),s.getSuppressJurisdictions&&(this.opt.suppressJurisdictions=s.getSuppressJurisdictions(this.opt.styleID)),i&&(i=i.replace("_","-")),this.opt["default-locale"][0]&&(this.opt["default-locale"][0]=this.opt["default-locale"][0].replace("_","-")),i&&n&&(this.opt["default-locale"]=[i]),i&&!n&&this.opt["default-locale"][0]&&(i=this.opt["default-locale"][0]),0===this.opt["default-locale"].length&&(i||(i="en-US"),this.opt["default-locale"].push("en-US")),i||(i=this.opt["default-locale"][0]),a=s.localeResolve(i),this.opt.lang=a.best,this.opt["default-locale"][0]=a.best,this.locale={},this.opt["default-locale-sort"]||(this.opt["default-locale-sort"]=this.opt["default-locale"][0]),this.localeConfigure(a),this.locale[this.opt.lang].opts["skip-words-regexp"]=r(this.locale[this.opt.lang].opts["skip-words"]),this.output.adjust=new s.Output.Queue.adjust(this.getOpt("punctuation-in-quote")),this.registry=new s.Registry(this),this.buildTokenLists("citation"),this.buildTokenLists("bibliography"),this.configureTokenLists(),this.disambiguate=new s.Disambiguation(this),this.splice_delimiter=!1,this.fun.dateparser=new s.DateParser,this.fun.flipflopper=new s.Util.FlipFlopper(this),this.setCloseQuotesArray(),this.fun.ordinalizer.init(this),this.fun.long_ordinalizer.init(this),this.fun.page_mangler=s.Util.PageRangeMangler.getFunction(this,"page"),this.fun.year_mangler=s.Util.PageRangeMangler.getFunction(this,"year"),this.setOutputFormat("html")},s.Engine.prototype.setCloseQuotesArray=function(){var t;t=[],t.push(this.getTerm("close-quote")),t.push(this.getTerm("close-inner-quote")),t.push('"'),t.push("'"),this.opt.close_quotes_array=t},s.makeBuilder=function(t){function e(e){s.XmlToToken.call(e,t,s.START)}function i(e){s.XmlToToken.call(e,t,s.END)}function n(e){s.XmlToToken.call(e,t,s.SINGLETON)}function r(o){var a;if(t.sys.xml.numberofnodes(t.sys.xml.children(o))){a=o,e(a);for(var l=0;l<t.sys.xml.numberofnodes(t.sys.xml.children(a));l+=1)o=t.sys.xml.children(a)[l],null!==t.sys.xml.nodename(o)&&("date"===t.sys.xml.nodename(o)&&(s.Util.fixDateNode.call(t,a,l,o),o=t.sys.xml.children(a)[l]),r(o,e,i,n));i(a)}else n(o)}return r},s.Engine.prototype.buildTokenLists=function(t){var e,i=s.makeBuilder(this);if(e=this.sys.xml.getNodesByName(this.cslXml,t),this.sys.xml.getNodeValue(e)){this.build.area=t;var n=e[0];i(n)}},s.Engine.prototype.setStyleAttributes=function(){var t,e,i;t={};var n=this.cslXml,r=this.cslXml.tagName?(""+this.cslXml.tagName).toLowerCase():"";if("style"!==r&&"cslstyle"!==r&&this.cslXml.getElementsByTagName)var n=this.cslXml.getElementsByTagName("style")[0];t.name=this.sys.xml.nodename(n),e=this.sys.xml.attributes(n);for(i in e)e.hasOwnProperty(i)&&s.Attributes[i].call(t,this,e[i])},s.Engine.prototype.getTerm=function(t,e,i,n,r,o){t&&t.match(/[A-Z]/)&&t===t.toUpperCase()&&(s.debug("Warning: term key is in uppercase form: "+t),t=t.toLowerCase());var a;a=o?this.opt["default-locale"][0]:this.opt.lang;var l=s.Engine.getField(s.LOOSE,this.locale[a].terms,t,e,i,n);if(l||"range-delimiter"!==t||(l="–"),"undefined"==typeof l){if(r===s.STRICT)throw'Error in getTerm: term "'+t+'" does not exist.';r===s.TOLERANT&&(l="")}return l&&(this.tmp.cite_renders_content=!0),l},s.Engine.prototype.getDate=function(t,e){var i;return i=e?this.opt["default-locale"]:this.opt.lang,this.locale[i].dates[t]?this.locale[i].dates[t]:!1},s.Engine.prototype.getOpt=function(t){return"undefined"!=typeof this.locale[this.opt.lang].opts[t]?this.locale[this.opt.lang].opts[t]:!1},s.Engine.prototype.getVariable=function(t,e,i,n){return s.Engine.getField(s.LOOSE,t,e,i,n)},s.Engine.prototype.getDateNum=function(t,e){return"undefined"==typeof t?0:t[e]},s.Engine.getField=function(t,e,i,n,r,o){var a,l,u,c,h,p;if(a="","undefined"==typeof e[i]){if(t===s.STRICT)throw'Error in getField: term "'+i+'" does not exist.';return void 0}for(p=o&&e[i][o]?e[i][o]:e[i],l=[],"symbol"===n?l=["symbol","short"]:"verb-short"===n?l=["verb-short","verb"]:"long"!==n&&(l=[n]),l=l.concat(["long"]),h=l.length,c=0;h>c;c+=1)if(u=l[c],"string"==typeof p||"number"==typeof p)a=p;else if("undefined"!=typeof p[u]){a="string"==typeof p[u]||"number"==typeof p[u]?p[u]:"number"==typeof r?p[u][r]:p[u][0];break}return a},s.Engine.prototype.configureTokenLists=function(){var t,e,i,n,r,o,a,l,u,c,h;for(t=["year","month","day"],u=s.AREAS.length,i=0;u>i;i+=1)for(e=s.AREAS[i],c=this[e].tokens.length-1,a=c;a>-1;a+=-1){if(n=this[e].tokens[a],"date"===n.name&&s.END===n.tokentype&&(r=[]),"date-part"===n.name&&n.strings.name)for(h=t.length,l=0;h>l;l+=1)o=t[l],o===n.strings.name&&r.push(n.strings.name);"date"===n.name&&s.START===n.tokentype&&(r.reverse(),n.dateparts=r),n.next=a+1,n.name&&s.Node[n.name].configure&&s.Node[n.name].configure.call(n,this,a)}return this.version=s.version,this.state},s.Engine.prototype.retrieveItems=function(t){var e;e=[];for(var i=0,n=t.length;n>i;i+=1)e.push(this.retrieveItem(""+t[i]));return e},s.ITERATION=0,s.Engine.prototype.retrieveItem=function(t){var e,i,n,r,o;if(this.opt.development_extensions.normalize_lang_keys_to_lowercase&&"boolean"==typeof this.opt.development_extensions.normalize_lang_keys_to_lowercase){for(var a=0,l=this.opt["default-locale"].length;l>a;a+=1)this.opt["default-locale"][a]=this.opt["default-locale"][a].toLowerCase();for(var a=0,l=this.opt["locale-translit"].length;l>a;a+=1)this.opt["locale-translit"][a]=this.opt["locale-translit"][a].toLowerCase();for(var a=0,l=this.opt["locale-translat"].length;l>a;a+=1)this.opt["locale-translat"][a]=this.opt["locale-translat"][a].toLowerCase();this.opt.development_extensions.normalize_lang_keys_to_lowercase=100}if(s.ITERATION+=1,e=this.sys.retrieveItem(""+t),this.opt.development_extensions.normalize_lang_keys_to_lowercase){if(e.multi){if(e.multi._keys)for(var u in e.multi._keys)for(var c in e.multi._keys[u])c!==c.toLowerCase()&&(e.multi._keys[u][c.toLowerCase()]=e.multi._keys[u][c],delete e.multi._keys[u][c]);if(e.multi.main)for(var u in e.multi.main)e.multi.main[u]=e.multi.main[u].toLowerCase()}for(var a=0,l=s.CREATORS.length;a>l;a+=1){var h=s.CREATORS[a];if(e[h]&&e[h].multi)for(var p=0,d=e[h].length;d>p;p+=1){var f=e[h][p];if(f.multi){if(f.multi._key)for(var c in f.multi._key)c!==c.toLowerCase()&&(f.multi._key[c.toLowerCase()]=f.multi._key[c],delete f.multi._key[c]);f.multi.main&&(f.multi.main=f.multi.main.toLowerCase())}}}}if(e.page){e["page-first"]=e.page;var m=""+e.page;i=m.split(/\s*(?:&|,|-|\u2013)\s*/),"\\"!==i[0].slice(-1)&&(e["page-first"]=i[0])}if(this.opt.development_extensions.field_hack&&e.note&&(i=e.note.match(s.NOTE_FIELDS_REGEXP))){for(n=0,r=i.length;r>n;n+=1){if(o=i[n].match(s.NOTE_FIELD_REGEXP),!e[o[1]]&&s.DATE_VARIABLES.indexOf(o[1])>-1)e[o[1]]={raw:o[2]};else if(!e[o[1]]&&s.NAME_VARIABLES.indexOf(o[1])>-1){e[o[1]]||(e[o[1]]=[]);var g=o[2].split(/\s*\|\|\s*/);1===g.length?e[o[1]].push({family:g[0],isInstitution:!0}):2===g.length&&e[o[1]].push({family:g[0],given:g[1]})}else e[o[1]]&&"type"!==o[1]||(e[o[1]]=o[2].replace(/^\s+/,"").replace(/\s+$/,""));e.note.replace(s.NOTE_FIELD_REGEXP,"")}}for(var a=1,l=s.DATE_VARIABLES.length;l>a;a+=1){var b=e[s.DATE_VARIABLES[a]];b&&(this.opt.development_extensions.raw_date_parsing&&b.raw&&(b=this.fun.dateparser.parse(b.raw)),e[s.DATE_VARIABLES[a]]=this.dateParseArray(b))}if(this.opt.development_extensions.static_statute_locator&&e.type&&["bill","gazette","legislation","treaty"].indexOf(e.type)>-1){var y,v=["type","title","jurisdiction","genre","volume","container-title"],_=[];for(a=0,l=v.length;l>a;a+=1)y=v[a],e[y]&&_.push(e[y]);for(v=["original-date","issued"],a=0,v.length;l>a;a+=1)if(y=v[a],e[y]&&e[y].year){var x=e[y].year;_.push(x);break}e.legislation_id=_.join("::")}if(e["title-short"]||(e["title-short"]=e.shortTitle),this.opt.development_extensions.main_title_from_short_title&&(e["title-main"]=e.title,e["title-sub"]=!1,e.title&&e["title-short"])){var C=e["title-short"];offset=C.length,e.title.slice(0,offset)===C&&e.title.slice(offset).match(/^\s*:/)&&(e["title-main"]=e.title.slice(0,offset).replace(/\s+$/,""),e["title-sub"]=e.title.slice(offset).replace(/^\s*:\s*/,""))}var w=["legal_case","legislation","gazette","regulation"].indexOf(e.type)>-1;if(!w&&e.title&&this.sys.getAbbreviation){var S=!1;e.jurisdiction||(S=!0);var T=this.transform.loadAbbreviation(e.jurisdiction,"title",e.title,e.type,!0);this.transform.abbrevs[T].title&&this.transform.abbrevs[T].title[e.title]&&(e["title-short"]=this.transform.abbrevs[T].title[e.title]);
}if(e["container-title-short"]=e.journalAbbreviation,e["container-title"]&&this.sys.getAbbreviation){var T=this.transform.loadAbbreviation(e.jurisdiction,"container-title",e["container-title"]);this.transform.abbrevs[T]["container-title"]&&this.transform.abbrevs[T]["container-title"][e["container-title"]]&&(e["container-title-short"]=this.transform.abbrevs[T]["container-title"][e["container-title"]])}return e},s.Engine.prototype.setOpt=function(t,e,i){"style"===t.name||"cslstyle"===t.name?this.opt[e]=i:["citation","bibliography"].indexOf(t.name)>-1?this[t.name].opt[e]=i:-1===["name-form","name-delimiter","names-delimiter"].indexOf(e)&&(t.strings[e]=i)},s.Engine.prototype.fixOpt=function(t,e,i){["citation","bibliography"].indexOf(t.name)>-1&&(this[t.name].opt[e]||"undefined"==typeof this.opt[e]||(this[t.name].opt[e]=this.opt[e])),("name"===t.name||"names"===t.name)&&"undefined"==typeof t.strings[i]&&"undefined"!=typeof this[this.build.root].opt[e]&&(t.strings[i]=this[this.build.root].opt[e])},s.Engine.prototype.remapSectionVariable=function(t){for(var e=0,i=t.length;i>e;e+=1){var n=t[e][0],r=t[e][1],o=!1;if(["bill","gazette","legislation","treaty"].indexOf(n.type)>-1){r.force_pluralism=0,r.label||(r.label="page");var a=["section","","",""];if(this.opt.development_extensions.static_statute_locator&&n.section?(l=n.section.replace(/^\s+/,"").replace(/\s+$/,"").split(/\s+/),s.STATUTE_SUBDIV_STRINGS[l[0]]?(a[0]=" "+l[0]+" ",a[1]=l.slice(1).join(" ")):(a[0]=" sec. ",a[1]=l.slice(0).join(" "))):this.opt.development_extensions.clobber_locator_if_no_statute_section&&(r.locator=void 0,r.label=void 0),r.locator){var l=r.locator.replace(/^\s+/,"").replace(/\s+$/,"").split(/\s+/);s.STATUTE_SUBDIV_STRINGS[l[0]]?(a[2]=" "+l[0]+" ",a[3]=l.slice(1).join(" ")):r.label?(a[2]=" "+s.STATUTE_SUBDIV_STRINGS_REVERSE[r.label]+" ",a[3]=l.slice(0).join(" ")):a[3]=l.join(" "),a[3]&&"&"===a[3].slice(0,1)&&(a[3]=" "+a[3])}if(a[2]||(a[2]=a[0]),a[3]){if(a[3].match(/^[^0-9a-zA-Z]/)){var u=a[3].split(/\s+/);a[0]===a[2]&&u[1]&&!s.STATUTE_SUBDIV_STRINGS[u[1].replace(/\s+/,"").replace(/\s+/,"")]&&(r.force_pluralism=1),a[2]=""}}else a[2]="";a[1]||(a[0]="");var o=a.join("");if(o=o.replace(/^\s+/,"").replace(/\s+$/,""))if(l=o.split(/\s+/),s.STATUTE_SUBDIV_STRINGS[l[0]]){for(var c=l.length-2;c>0;c+=-2)l[c]===l[0]&&(r.force_pluralism=1,l=l.slice(0,c).concat(l.slice(c+1)));r.label=s.STATUTE_SUBDIV_STRINGS[l[0]],r.locator=l.slice(1).join(" "),0===r.force_pluralism&&delete r.force_pluralism}else r.locator=l.slice(0).join(" ")}}},s.Engine.prototype.setNumberLabels=function(t){if(t.number&&["bill","gazette","legislation","treaty"].indexOf(t.type)>-1&&this.opt.development_extensions.static_statute_locator&&!this.tmp.shadow_numbers.number){this.tmp.shadow_numbers.number={},this.tmp.shadow_numbers.number.values=[],this.tmp.shadow_numbers.number.plural=0,this.tmp.shadow_numbers.number.numeric=!1,this.tmp.shadow_numbers.number.label=!1;var e=""+t.number;e=e.replace("\\","","g");var i=e.split(/\s/)[0],n=s.STATUTE_SUBDIV_STRINGS[i];if(n){var r=e.match(s.STATUTE_SUBDIV_GROUPED_REGEX),o=e.split(s.STATUTE_SUBDIV_PLAIN_REGEX);if(o.length>1){for(var a=[],l=1,u=o.length;u>l;l+=1){var c=r[l-1].replace(/^\s*/,"");a.push(c.replace("sec.","Sec.").replace("ch.","Ch.")),a.push(o[l].replace(/\s*$/,"").replace(/^\s*/,""))}e=a.join(" ")}else e=o[0];this.tmp.shadow_numbers.number.values.push(["Blob",e,!1]),this.tmp.shadow_numbers.number.numeric=!1}else this.tmp.shadow_numbers.number.values.push(["Blob",e,!1]),this.tmp.shadow_numbers.number.numeric=!0}},s.substituteOne=function(t){return function(e,i){return i?t.replace("%%STRING%%",i):""}},s.substituteTwo=function(t){return function(e){var i=t.replace("%%PARAM%%",e);return function(t,e){return e?i.replace("%%STRING%%",e):""}}},s.Mode=function(t){var e,i,n,r,o,a;e={},i=s.Output.Formats[t];for(n in i)if("@"===n.slice(0,1)){if(r=!1,o=i[n],a=n.split("/"),"string"==typeof o&&o.indexOf("%%STRING%%")>-1)r=o.indexOf("%%PARAM%%")>-1?s.substituteTwo(o):s.substituteOne(o);else if("boolean"!=typeof o||o){if("function"!=typeof o)throw"CSL.Compiler: Bad "+t+" config entry for "+n+": "+o;r=o}else r=s.Output.Formatters.passthrough;1===a.length?e[a[0]]=r:2===a.length&&(e[a[0]]||(e[a[0]]={}),e[a[0]][a[1]]=r)}else e[n]=i[n];return e},s.setDecorations=function(t,e){var i,n,r;i=[];for(r in s.FORMAT_KEY_SEQUENCE)n=s.FORMAT_KEY_SEQUENCE[r],e[n]&&(i.push([n,e[n]]),delete e[n]);return i},s.Engine.prototype.normalDecorIsOrphan=function(t,e){if("normal"===e[1]){var i,n=!1;i="citation"===this.tmp.area?[this.citation.opt.layout_decorations].concat(t.alldecor):t.alldecor;for(var s=i.length-1;s>-1;s+=-1)for(var r=i[s].length-1;r>-1;r+=-1)i[s][r][0]===e[0]&&"normal"!==i[s][r][1]&&(n=!0);if(!n)return!0}return!1},s.Engine.prototype.getCitationLabel=function(t){var e="",i=this.getTrigraphParams(),n=i[0],r=this.getTerm("reference","short",0);"undefined"==typeof r&&(r="reference"),r=r.replace(".",""),r=r.slice(0,1).toUpperCase()+r.slice(1);for(var o=0,a=s.CREATORS.length;a>o;o+=1){var l=s.CREATORS[o];if(t[l]){var u=t[l];n=u.length>i.length?i[i.length-1]:i[u.length-1];for(var c=0,h=u.length;h>c&&c!==n.authors.length;c+=1){var p=this.nameOutput.getName(u[c],"locale-translit",!0),d=p.name;d&&d.family?(r=d.family,r=r.replace(/^([ \'\u2019a-z]+\s+)/,"")):d&&d.literal&&(r=d.literal);var f=r.toLowerCase().match(/^(a\s+|the\s+|an\s+)/);if(f&&(r=r.slice(f[1].length)),r=r.replace(s.ROMANESQUE_NOT_REGEXP,"","g"),!r)break;r=r.slice(0,n.authors[c]),r.length>1?r=r.slice(0,1).toUpperCase()+r.slice(1).toLowerCase():1===r.length&&(r=r.toUpperCase()),e+=r}break}}var m="0000";return t.issued&&t.issued.year&&(m=""+t.issued.year),m=m.slice(-1*n.year),e+=m},s.Engine.prototype.getTrigraphParams=function(){var t=[],e=this.opt.trigraph.split(":");if(!this.opt.trigraph||"A"!==this.opt.trigraph.slice(0,1))throw"Bad trigraph definition: "+this.opt.trigraph;for(var i=0,n=e.length;n>i;i+=1){for(var s=e[i],r={authors:[],year:0},o=0,a=s.length;a>o;o+=1)switch(s.slice(o,o+1)){case"A":r.authors.push(1);break;case"a":r.authors[r.authors.length-1]+=1;break;case"0":r.year+=1;break;default:throw"Invalid character in trigraph definition: "+this.opt.trigraph}t.push(r)}return t},s.Engine.prototype.setOutputFormat=function(t){this.opt.mode=t,this.fun.decorate=s.Mode(t),this.output[t]||(this.output[t]={},this.output[t].tmp={})},s.Engine.prototype.getSortFunc=function(){return function(t,e){return t=t.split("-"),e=e.split("-"),t.length<e.length?1:t.length>e.length?-1:(t=t.slice(-1)[0],e=e.slice(-1)[0],t.length<e.length?1:t.length>e.length?-1:0)}},s.Engine.prototype.setLangTagsForCslSort=function(t){var e,i;if(t)for(this.opt["locale-sort"]=[],e=0,i=t.length;i>e;e+=1)this.opt["locale-sort"].push(t[e]);this.opt["locale-sort"].sort(this.getSortFunc())},s.Engine.prototype.setLangTagsForCslTransliteration=function(t){var e,i;if(this.opt["locale-translit"]=[],t)for(e=0,i=t.length;i>e;e+=1)this.opt["locale-translit"].push(t[e]);this.opt["locale-translit"].sort(this.getSortFunc())},s.Engine.prototype.setLangTagsForCslTranslation=function(t){var e,i;if(this.opt["locale-translat"]=[],t)for(e=0,i=t.length;i>e;e+=1)this.opt["locale-translat"].push(t[e]);this.opt["locale-translat"].sort(this.getSortFunc())},s.Engine.prototype.setLangPrefsForCites=function(t,e){var i=this.opt["cite-lang-prefs"];e||(e=function(t){return t.toLowerCase()});for(var n=["Persons","Institutions","Titles","Journals","Publishers","Places"],s=0,r=n.length;r>s;s+=1){var o=e(n[s]),a=n[s].toLowerCase();if(t[o]){for(var l=[];t[o].length>1;)l.push(t[o].pop());var u={orig:1,translit:2,translat:3};for(2===l.length&&u[l[0]]<u[l[1]]&&l.reverse();l.length;)t[o].push(l.pop());for(var c=i[a];c.length;)c.pop();for(var h=0,p=t[o].length;p>h;h+=1)c.push(t[o][h])}}},s.Engine.prototype.setLangPrefsForCiteAffixes=function(t){if(t&&48===t.length){for(var e,i=this.opt.citeAffixes,n=0,s=["persons","institutions","titles","journals","publishers","places"],r=["translit","orig","translit","translat"],o=0,a=s.length;a>o;o+=1)for(var l=0,u=r.length;u>l;l+=1)e="",n%8===4?i[s[o]]["locale-"+r[l]].prefix||i[s[o]]["locale-"+r[l]].suffix||(e=t[n]?t[n]:"",i[s[o]]["locale-"+r[l]].prefix=e,e=t[n]?t[n+1]:"",i[s[o]]["locale-"+r[l]].suffix=e):(e=t[n]?t[n]:"",i[s[o]]["locale-"+r[l]].prefix=e,e=t[n]?t[n+1]:"",i[s[o]]["locale-"+r[l]].suffix=e),n+=2;this.opt.citeAffixes=i}},s.Engine.prototype.setAutoVietnameseNamesOption=function(t){t?this.opt["auto-vietnamese-names"]=!0:this.opt["auto-vietnamese-names"]=!1},s.Engine.prototype.setAbbreviations=function(t){this.sys.setAbbreviations&&this.sys.setAbbreviations(t)},s.Engine.prototype.setSuppressTrailingPunctuation=function(t){this.citation.opt.suppressTrailingPunctuation=!!t},s.Output={},s.Output.Queue=function(t){this.levelname=["top"],this.state=t,this.queue=[],this.empty=new s.Token("empty");var e={};e.empty=this.empty,this.formats=new s.Stack(e),this.current=new s.Stack(this.queue)},s.Output.Queue.prototype.pop=function(){var t=this.current.value();return t.length?t.pop():t.blobs.pop()},s.Output.Queue.prototype.getToken=function(t){var e=this.formats.value()[t];return e},s.Output.Queue.prototype.mergeTokenStrings=function(t,e){var i,n,r,o;if(i=this.formats.value()[t],n=this.formats.value()[e],r=i,n){i||(i=new s.Token(t,s.SINGLETON),i.decorations=[]),r=new s.Token(t,s.SINGLETON),o="";for(o in i.strings)i.strings.hasOwnProperty(o)&&(r.strings[o]=i.strings[o]);for(o in n.strings)n.strings.hasOwnProperty(o)&&(r.strings[o]=n.strings[o]);r.decorations=i.decorations.concat(n.decorations)}return r},s.Output.Queue.prototype.addToken=function(t,e,i){var n,r;if(n=new s.Token("output"),"string"==typeof i&&(i=this.formats.value()[i]),i&&i.strings){for(r in i.strings)i.strings.hasOwnProperty(r)&&(n.strings[r]=i.strings[r]);n.decorations=i.decorations}"string"==typeof e&&(n.strings.delimiter=e),this.formats.value()[t]=n},s.Output.Queue.prototype.pushFormats=function(t){t||(t={}),t.empty=this.empty,this.formats.push(t)},s.Output.Queue.prototype.popFormats=function(t){this.formats.pop()},s.Output.Queue.prototype.startTag=function(t,e){var i={};this.state.tmp["doing-macro-with-date"]&&this.state.tmp.extension&&(e=this.empty,t="empty"),i[t]=e,this.pushFormats(i),this.openLevel(t)},s.Output.Queue.prototype.endTag=function(t){this.closeLevel(),this.popFormats()},s.Output.Queue.prototype.openLevel=function(t,e){var i,n;if("object"==typeof t)i=new s.Blob(void 0,t);else if("undefined"==typeof t)i=new s.Blob(void 0,this.formats.value().empty,"empty");else{if(!this.formats.value()||!this.formats.value()[t])throw'CSL processor error: call to nonexistent format token "'+t+'"';i=new s.Blob(void 0,this.formats.value()[t],t)}this.nestedBraces&&(i.strings.prefix=i.strings.prefix.replace(this.nestedBraces[0][0],this.nestedBraces[0][1]),i.strings.prefix=i.strings.prefix.replace(this.nestedBraces[1][0],this.nestedBraces[1][1]),i.strings.suffix=i.strings.suffix.replace(this.nestedBraces[0][0],this.nestedBraces[0][1]),i.strings.suffix=i.strings.suffix.replace(this.nestedBraces[1][0],this.nestedBraces[1][1])),n=this.current.value(),n.push(i),this.current.push(i)},s.Output.Queue.prototype.closeLevel=function(t){t&&t!==this.current.value().levelname&&s.error("Level mismatch error:  wanted "+t+" but found "+this.current.value().levelname),this.current.pop()},s.Output.Queue.prototype.append=function(t,e,i,n,r){var o,a,l,u=!0;if(i&&(n=!0),this.state.tmp["doing-macro-with-date"]&&!i){if("macro-with-date"!==e)return!1;"macro-with-date"===e&&(e="empty")}if("undefined"==typeof t)return!1;if("number"==typeof t&&(t=""+t),!i&&this.state.tmp.element_trace&&"suppress-me"===this.state.tmp.element_trace.value())return!1;if(a=!1,e?"literal"===e?(o=!0,u=!1):o="string"==typeof e?this.formats.value()[e]:e:o=this.formats.value().empty,!o)throw"CSL processor error: unknown format token name: "+e;if(o.strings&&"undefined"==typeof o.strings.delimiter&&(o.strings.delimiter=""),"string"==typeof t&&t.length&&(t=t.replace(/ ([:;?!\u00bb])/g," $1").replace(/\u00ab /g,"« "),this.last_char_rendered=t.slice(-1),t=t.replace(/\s+'/g,"  '").replace(/^'/g," '"),n?i&&(this.state.tmp.term_predecessor_name=!0):this.state.tmp.term_predecessor=!0),a=new s.Blob(t,o),this.nestedBraces&&(a.strings.prefix=a.strings.prefix.replace(this.nestedBraces[0][0],this.nestedBraces[0][1]),a.strings.prefix=a.strings.prefix.replace(this.nestedBraces[1][0],this.nestedBraces[1][1]),a.strings.suffix=a.strings.suffix.replace(this.nestedBraces[0][0],this.nestedBraces[0][1]),a.strings.suffix=a.strings.suffix.replace(this.nestedBraces[1][0],this.nestedBraces[1][1])),l=this.current.value(),"undefined"==typeof l&&0===this.current.mystack.length&&(this.current.mystack.push([]),l=this.current.value()),"string"==typeof a.blobs&&(n?i&&(this.state.tmp.term_predecessor_name=!0):this.state.tmp.term_predecessor=!0),i||this.state.parallel.AppendBlobPointer(l),"string"==typeof t){l.push(a),a.strings["text-case"]&&(a.blobs=s.Output.Formatters[a.strings["text-case"]](this.state,t)),this.state.tmp.strip_periods&&!r&&(a.blobs=a.blobs.replace(/\.([^a-z]|$)/g,"$1"));for(var c=a.decorations.length-1;c>-1;c+=-1)"@quotes"===a.decorations[c][0]&&"true"===a.decorations[c][1]&&(a.punctuation_in_quote=this.state.getOpt("punctuation-in-quote")),a.blobs.match(s.ROMANESQUE_REGEXP)||"@font-style"===a.decorations[c][0]&&(a.decorations=a.decorations.slice(0,c).concat(a.decorations.slice(c+1)));this.state.fun.flipflopper.init(t,a),this.state.fun.flipflopper.processTags()}else u?l.push(a):l.push(t);return!0},s.Output.Queue.prototype.string=function(t,e,i){var n,r,o,a,l,u=s.getSafeEscape(this.state),c=e.slice(),h=[];if(0===c.length)return h;var p="";i?p=i.strings.delimiter:(t.tmp.count_offset_characters=!1,t.tmp.offset_characters=0),i&&i.new_locale&&(i.old_locale=t.opt.lang,t.opt.lang=i.new_locale);var d,f,m,g;for(n=0,r=c.length;r>n;n+=1){if(d=c[n],d.strings.first_blob&&(t.tmp.count_offset_characters=d.strings.first_blob),"string"==typeof d.blobs){if("number"==typeof d.num)h.push(d);else if(d.blobs){l=u(d.blobs);var b=l.length;if(!t.tmp.suppress_decorations)for(o=0,a=d.decorations.length;a>o;o+=1)g=d.decorations[o],"@showid"!==g[0]&&(t.normalDecorIsOrphan(d,g)||(l=t.fun.decorate[g[0]][g[1]].call(d,t,l,g[2])));if(l&&l.length){if(l=u(d.strings.prefix,t.tmp.nestedBraces)+l+u(d.strings.suffix,t.tmp.nestedBraces),(t.opt.development_extensions.csl_reverse_lookup_support||t.sys.csl_reverse_lookup_support)&&!t.tmp.suppress_decorations)for(o=0,a=d.decorations.length;a>o;o+=1)g=d.decorations[o],"@showid"===g[0]&&(l=t.fun.decorate[g[0]][g[1]].call(d,t,l,g[2]));h.push(l),t.tmp.count_offset_characters&&(t.tmp.offset_characters+=b+d.strings.suffix.length+d.strings.prefix.length)}}}else if(d.blobs.length){var y=t.output.string(t,d.blobs,d);h=h.concat(y)}d.strings.first_blob&&(t.registry.registry[d.strings.first_blob].offset=t.tmp.offset_characters,t.tmp.count_offset_characters=!1)}for(n=0,r=h.length-1;r>n;n+=1)"number"!=typeof h[n].num||"number"!=typeof h[n+1].num||h[n+1].UGLY_DELIMITER_SUPPRESS_HACK||(h[n].strings.suffix=h[n].strings.suffix+(p?p:""),h[n+1].successor_prefix="",h[n+1].UGLY_DELIMITER_SUPPRESS_HACK=!0);var v=0;for(n=0,r=h.length;r>n;n+=1)"string"==typeof h[n]&&(v=parseInt(n,10)+1,n<h.length-1&&"object"==typeof h[n+1]&&(p&&!h[n+1].UGLY_DELIMITER_SUPPRESS_HACK&&(h[n]+=u(p)),h[n+1].UGLY_DELIMITER_SUPPRESS_HACK=!0));i&&(i.decorations.length||i.strings.suffix||i.strings.prefix)&&(v=h.length);var _=t.output.renderBlobs(h.slice(0,v),p,!0,i);if(_&&i&&(i.decorations.length||i.strings.suffix||i.strings.prefix)){if(!t.tmp.suppress_decorations)for(n=0,r=i.decorations.length;r>n;n+=1)g=i.decorations[n],["@cite","@bibliography","@display","@showid"].indexOf(g[0])>-1||t.normalDecorIsOrphan(d,g)||"string"==typeof _&&(_=t.fun.decorate[g[0]][g[1]].call(i,t,_,g[2]));if(l=_,f=i.strings.suffix,l&&l.length&&(m=i.strings.prefix,l=u(m,t.tmp.nestedBraces)+l+u(f,t.tmp.nestedBraces),t.tmp.count_offset_characters&&(t.tmp.offset_characters+=m.length+f.length)),_=l,!t.tmp.suppress_decorations)for(n=0,r=i.decorations.length;r>n;n+=1)g=i.decorations[n],-1!==["@cite","@bibliography","@display","@showid"].indexOf(g[0])&&"string"==typeof _&&(_=t.fun.decorate[g[0]][g[1]].call(i,t,_,g[2]))}var x=h.slice(v,h.length);return!x.length&&_?h=[_]:x.length&&!_?h=x:_&&x.length&&(h=[_].concat(x)),"undefined"==typeof i?(this.queue=[],this.current.mystack=[],this.current.mystack.push(this.queue),t.tmp.suppress_decorations&&(h=t.output.renderBlobs(h,void 0,!0))):"boolean"==typeof i&&(h=t.output.renderBlobs(h,void 0,!0)),i&&i.new_locale&&(t.opt.lang=i.old_locale),h},s.Output.Queue.prototype.clearlevel=function(){var t,e,i;for(t=this.current.value(),i=t.blobs.length,e=0;i>e;e+=1)t.blobs.pop()},s.Output.Queue.prototype.renderBlobs=function(t,e,i,n){var r,o,a,l,u,c,h,p,d,f,m,g;if(g=s.getSafeEscape(this.state),e||(e=""),r=this.state,o="",a=[],l="",h=t.length,"citation"===this.state.tmp.area&&!this.state.tmp.just_looking&&1===h&&"object"==typeof t[0]&&n)return t[0].strings.prefix=n.strings.prefix+t[0].strings.prefix,t[0].strings.suffix=t[0].strings.suffix+n.strings.suffix,t[0].decorations=t[0].decorations.concat(n.decorations),t[0].params=n.params,t[0];var b=!0;for(c=0;h>c;c+=1)t[c].checkNext?(t[c].checkNext(t[c+1],b),b=!1):b=!0;var y=!0;for(c=t.length-1;c>0;c+=-1)t[c].checkLast?y&&t[c].checkLast(t[c-1])&&(y=!1):y=!0;for(h=t.length,c=0;h>c;c+=1)if(u=t[c],o&&(l=e),"string"==typeof u)o+=g(l),o+=u,r.tmp.count_offset_characters&&(r.tmp.offset_characters+=l.length);else if(u.status!==s.SUPPRESS){f=u.formatter.format(u.num,u.gender);var v=f.replace(/<[^>]*>/g,"").length;this.append(f,"empty",!0);var _=this.pop(),x=r.tmp.count_offset_characters;if(f=this.string(r,[_],!1),r.tmp.count_offset_characters=x,u.strings["text-case"]&&(f=s.Output.Formatters[u.strings["text-case"]](this.state,f)),f&&this.state.tmp.strip_periods&&(f=f.replace(/\.([^a-z]|$)/g,"$1")),!r.tmp.suppress_decorations)for(d=u.decorations.length,p=0;d>p;p+=1)m=u.decorations[p],r.normalDecorIsOrphan(u,m)||(f=r.fun.decorate[m[0]][m[1]].call(u,r,f,m[2]));f=g(u.strings.prefix)+f+g(u.strings.suffix);var C="";u.status===s.END?C=g(u.range_prefix):u.status===s.SUCCESSOR?C=g(u.successor_prefix):u.status===s.START?C="":u.status===s.SEEN&&(C=g(u.splice_prefix)),o+=C,o+=f,r.tmp.count_offset_characters&&(r.tmp.offset_characters+=C.length+u.strings.prefix.length+v+u.strings.suffix.length)}return o},s.Output.Queue.purgeEmptyBlobs=function(t){if("object"==typeof t&&"object"==typeof t.blobs&&t.blobs.length)for(var e=t.blobs.length-1;e>-1;e--){s.Output.Queue.purgeEmptyBlobs(t.blobs[e]);var i=t.blobs[e];if(!i||!i.blobs||!i.blobs.length){for(var n=[];t.blobs.length-1>e;)n.push(t.blobs.pop());for(t.blobs.pop();n.length;)t.blobs.push(n.pop())}}},s.Output.Queue.adjust=function(t){function e(t){return"number"==typeof t.num||t.blobs&&1===t.blobs.length&&"number"==typeof t.blobs[0].num}function i(t){return"number"==typeof t.num?!0:t.blobs&&"object"==typeof t.blobs?i(t.blobs[t.blobs.length-1])?!0:void 0:!1}function n(t,e){var i=!1,n=["@font-style","@font-variant","@font-weight","@text-decoration","@vertical-align"];if(e&&n.push("@quotes"),t.decorations)for(var s=0,r=t.decorations.length;r>s;s++)if(n.indexOf(t.decorations[s][0])>-1){i=!0;break}return i}function s(t){if(t.decorations)for(var e=0,i=t.decorations.length;i>e;e++)if("@quotes"===t.decorations[e][0])return!0;return"object"!=typeof t.blobs?!1:s(t.blobs[t.blobs.length-1])?!0:!1}function r(t,e){if(!g[e])return!1;if("string"==typeof t.blobs)return t.blobs.slice(-1)===e?!0:!1;var i=t.blobs[t.blobs.length-1];if(i){var n=i.strings.suffix.slice(-1);return n?i.strings.suffix.slice(-1)==e?!0:!1:r(i,e)}return!1}function o(t,e,i,n,s){function r(){SecondStrings[n]=SecondStrings[n].slice(1)}function o(){FirstStrings[e]=FirstStrings[e].slice(0,-1)}function a(t){SecondStrings[n]=t+SecondStrings[n]}function l(t){FirstStrings[e]+=t}function u(){return v[m]}function c(){FirstStrings[e].slice(-1);return d[f]}function h(){var t=d[f][m];"string"==typeof t?(o(),r(),a(t)):(a(f),o())}function p(){var t=v[m][f];"string"==typeof t?(o(),r(),l(t)):(l(m),r())}FirstStrings="blobs"===e?t:t.strings,SecondStrings="blobs"===n?i:i.strings;var f=FirstStrings[e].slice(-1),m=SecondStrings[n].slice(0,1),g=s?o:r,b=s?c:u,y=s?h:p,_=f===m;_?g():b()&&y()}function a(t){if(t.blobs&&"string"==typeof t.blobs)return void(g[t.strings.suffix.slice(0,1)]&&t.strings.suffix.slice(0,1)===t.blobs.slice(-1)&&(t.strings.suffix=t.strings.suffix.slice(1)));if("object"==typeof t&&"object"==typeof t.blobs&&t.blobs.length)for(var e=n(t,!0),i=t.blobs.length-1;i>-1;i--){i===t.blobs.length-1;this.upward(t.blobs[i]);var s=t.strings,r=t.blobs[i].strings;if(0===i){" "===s.prefix.slice(-1)&&" "===r.prefix.slice(0,1)&&(r.prefix=r.prefix.slice(1));var o=r.prefix.slice(0,1);e||!b[o]||s.prefix||(s.prefix+=o,r.prefix=r.prefix.slice(1))}if(i===t.blobs.length-1){var o=r.suffix.slice(-1);!e&&[" "].indexOf(o)>-1&&(s.suffix.slice(0,1)!==o&&(s.suffix=o+s.suffix),r.suffix=r.suffix.slice(0,-1))}s.delimiter&&i>0&&b[s.delimiter.slice(-1)]&&s.delimiter.slice(-1)===r.prefix.slice(0,1)&&(r.prefix=r.prefix.slice(1))}}function l(t){if("object"==typeof t&&"object"==typeof t.blobs&&t.blobs.length)for(var e=t.blobs.length-1;e>-1;e--)if(this.leftward(t.blobs[e]),e<t.blobs.length-1&&!t.strings.delimiter){var i=t.blobs[e],s=i.strings.suffix.slice(-1),r=t.blobs[e+1],a=r.strings.prefix.slice(0,1),l=n(i)||n(r),u="number"==typeof s||"number"==typeof a;if(!l&&!u&&g[a]&&!u){var c=a===i.strings.suffix.slice(-1),h=!i.strings.suffix&&"string"==typeof i.blobs&&i.blobs.slice(-1)===a;c||h?r.strings.prefix=r.strings.prefix.slice(1):o(i,"suffix",r,"prefix")}}}function u(t,a){if(t.blobs&&"string"==typeof t.blobs)return void(g[t.strings.suffix.slice(0,1)]&&t.strings.suffix.slice(0,1)===t.blobs.slice(-1)&&(t.strings.suffix=t.strings.suffix.slice(1)));if("object"==typeof t&&"object"==typeof t.blobs&&t.blobs.length){for(var l=t.strings,u=!1,c=0,h=t.blobs.length;h>c;c++)if(e(t.blobs[c])){u=!0;break}if(!u&&l.delimiter&&g[l.delimiter.slice(0,1)]){for(var p=l.delimiter.slice(0,1),c=t.blobs.length-2;c>-1;c--){var d=t.blobs[c].strings;d.suffix+=p}l.delimiter=l.delimiter.slice(1)}for(var f=n(t,!0),c=(e(t),t.blobs.length-1);c>-1;c--){var m=t.blobs[c],d=t.blobs[c].strings,y=n(m,!0),v=e(m);if(c===t.blobs.length-1){if(!f||s(m)){var _=l.suffix.slice(0,1);g[_]&&(i(m)||(o(m,"suffix",t,"suffix"),"."===l.suffix.slice(0,1)&&(d.suffix+=l.suffix.slice(0,1),l.suffix=l.suffix.slice(1)))),"Â "===d.suffix.slice(-1)&&l.suffix.slice(0,1)&&(l.suffix=l.suffix.slice(1))}b[d.suffix.slice(0,1)]&&("string"==typeof m.blobs&&m.blobs.slice(-1)===d.suffix.slice(0,1)&&(d.suffix=d.suffix.slice(1)),d.suffix.slice(-1)===l.suffix.slice(0,1)&&(l.suffix=l.suffix.slice(0,-1))),r(t,t.strings.suffix.slice(0,1))&&(t.strings.suffix=t.strings.suffix.slice(1))}else if(l.delimiter)b[l.delimiter.slice(0,1)]&&l.delimiter.slice(0,1)===d.suffix.slice(-1)&&(t.blobs[c].strings.suffix=t.blobs[c].strings.suffix.slice(0,-1));else{var x=t.blobs[c+1].strings;e(m)||y||!b[d.suffix.slice(-1)]||d.suffix.slice(-1)!==x.prefix.slice(0,1)||(x.prefix=x.prefix.slice(1))}v||y||!g[d.suffix.slice(0,1)]||"string"!=typeof m.blobs||o(m,"blobs",m,"suffix"),this.downward(t.blobs[c])}}}function c(e){if("object"==typeof e&&"object"==typeof e.blobs&&e.blobs.length){for(var i,n=0,s=e.blobs.length;s>n;n++){for(var r=e.blobs[n],a=!1,l=0,u=r.decorations.length;u>l;l++){var c=r.decorations[l];"@quotes"===c[0]&&(a=!0)}if(a)if(t){var h=r.strings.suffix.slice(0,1);if("string"==typeof r.blobs)for(;f[h];)o(r,"blobs",r,"suffix"),h=r.strings.suffix.slice(0,1);else for(;f[h];)o(r.blobs[r.blobs.length-1],"suffix",r,"suffix"),h=r.strings.suffix.slice(0,1)}else if("string"==typeof r.blobs)for(var h=r.blobs.slice(-1);m[h];)o(r,"blobs",r,"suffix",!0),h=r.blobs.slice(-1);else for(var h=r.blobs[r.blobs.length-1].strings.suffix.slice(-1);m[h];)o(r.blobs[r.blobs.length-1],"suffix",r,"suffix",!0),h=r.blobs[r.blobs.length-1].strings.suffix.slice(-1);i=this.fix(e.blobs[n]),r.blobs&&"string"==typeof r.blobs&&(i=r.blobs.slice(-1))}return i}}var h={";":!0,":":!0},p={".":!0,"!":!0,"?":!0};this.upward=a,this.leftward=l,this.downward=u,this.fix=c;var d={"!":{".":"!","?":"!?",":":"!",",":"!,",";":"!;"},"?":{"!":"?!",".":"?",":":"?",",":"?,",";":"?;"},".":{"!":".!","?":".?",":":".:",",":".,",";":".;"},":":{"!":"!","?":"?",".":":",",":":,",";":":;"},",":{"!":",!","?":",?",":":",:",".":",.",";":",;"},";":{"!":"!","?":"?",":":";",",":";,",".":";"}},f={},m={},g={},b={};for(var y in d)g[y]=!0,b[y]=!0,h[y]||(f[y]=!0),p[y]||(m[y]=!0);b[" "]=!0,b["Â "]=!0;var v={};for(var y in d)for(var _ in d[y])v[_]||(v[_]={}),v[_][y]=d[y][_]},s.Engine.Opt=function(){this.has_disambiguate=!1,this.mode="html",this.dates={},this["locale-sort"]=[],this["locale-translit"]=[],this["locale-translat"]=[],this.citeAffixes={persons:{"locale-orig":{prefix:"",suffix:""},"locale-translit":{prefix:"",suffix:""},"locale-translat":{prefix:"",suffix:""}},institutions:{"locale-orig":{prefix:"",suffix:""},"locale-translit":{prefix:"",suffix:""},"locale-translat":{prefix:"",suffix:""}},titles:{"locale-orig":{prefix:"",suffix:""},"locale-translit":{prefix:"",suffix:""},"locale-translat":{prefix:"",suffix:""}},journals:{"locale-orig":{prefix:"",suffix:""},"locale-translit":{prefix:"",suffix:""},"locale-translat":{prefix:"",suffix:""}},publishers:{"locale-orig":{prefix:"",suffix:""},"locale-translit":{prefix:"",suffix:""},"locale-translat":{prefix:"",suffix:""}},places:{"locale-orig":{prefix:"",suffix:""},"locale-translit":{prefix:"",suffix:""},"locale-translat":{prefix:"",suffix:""}}},this["default-locale"]=[],this.update_mode=s.NONE,this.bib_mode=s.NONE,this.sort_citations=!1,this["et-al-min"]=0,this["et-al-use-first"]=1,this["et-al-use-last"]=!1,this["et-al-subsequent-min"]=!1,this["et-al-subsequent-use-first"]=!1,this["demote-non-dropping-particle"]="display-and-sort",this["parse-names"]=!0,this.citation_number_slug=!1,this.trigraph="Aaaa00:AaAa00:AaAA00:AAAA00",this.development_extensions={},this.development_extensions.field_hack=!0,this.development_extensions.locator_date_and_revision=!0,this.development_extensions.locator_parsing_for_plurals=!0,this.development_extensions.locator_label_parse=!0,this.development_extensions.raw_date_parsing=!0,this.development_extensions.clean_up_csl_flaws=!0,this.development_extensions.flip_parentheses_to_braces=!0,this.development_extensions.jurisdiction_subfield=!0,this.development_extensions.static_statute_locator=!1,this.development_extensions.csl_reverse_lookup_support=!1,this.development_extensions.clobber_locator_if_no_statute_section=!1,this.development_extensions.wrap_url_and_doi=!1,this.development_extensions.allow_force_lowercase=!1,this.development_extensions.handle_parallel_articles=!1,this.development_extensions.thin_non_breaking_space_html_hack=!1,this.development_extensions.apply_citation_wrapper=!1,this.development_extensions.main_title_from_short_title=!1,this.development_extensions.normalize_lang_keys_to_lowercase=!1,this.development_extensions.strict_text_case_locales=!1,this.development_extensions.rtl_support=!1,this.development_extensions.strict_page_numbers=!1,this.development_extensions.expect_and_symbol_form=!1,this.development_extensions.require_explicit_legal_case_title_short=!1,this.nodenames=[],this.gender={},this["cite-lang-prefs"]={persons:["orig"],institutions:["orig"],titles:["orig","translat"],journals:["translit"],publishers:["orig"],places:["orig"],number:["translat"]},this.has_layout_locale=!1},s.Engine.Tmp=function(){this.names_max=new s.Stack,this.names_base=new s.Stack,this.givens_base=new s.Stack,this.value=[],this.namepart_decorations={},this.namepart_type=!1,this.area="citation",this.root="citation",this.extension="",this.can_substitute=new s.Stack(0,s.LITERAL),this.element_rendered_ok=!1,this.element_trace=new s.Stack("style"),this.nameset_counter=0,this.group_context=new s.Stack([!1,!1,!1],s.LITERAL),this.term_predecessor=!1,this.jump=new s.Stack(0,s.LITERAL),this.decorations=new s.Stack,this.tokenstore_stack=new s.Stack,this.last_suffix_used="",this.last_names_used=[],this.last_years_used=[],this.years_used=[],this.names_used=[],this.taintedItemIDs={},this.taintedCitationIDs={},this.initialize_with=new s.Stack,this.disambig_request=!1,this["name-as-sort-order"]=!1,this.suppress_decorations=!1,this.disambig_settings=new s.AmbigConfig,this.bib_sort_keys=[],this.prefix=new s.Stack("",s.LITERAL),this.suffix=new s.Stack("",s.LITERAL),this.delimiter=new s.Stack("",s.LITERAL),this.cite_locales=[],this.cite_affixes={citation:!1,bibliography:!1,citation_sort:!1,bibliography_sort:!1},this.strip_periods=0,this.shadow_numbers={}},s.Engine.Fun=function(t){this.match=new s.Util.Match,this.suffixator=new s.Util.Suffixator(s.SUFFIX_CHARS),this.romanizer=new s.Util.Romanizer,this.ordinalizer=new s.Util.Ordinalizer(t),this.long_ordinalizer=new s.Util.LongOrdinalizer},s.Engine.Build=function(){this["alternate-term"]=!1,this.in_bibliography=!1,this.in_style=!1,this.skip=!1,this.postponed_macro=!1,this.layout_flag=!1,this.name=!1,this.form=!1,this.term=!1,this.macro={},this.macro_stack=[],this.text=!1,this.lang=!1,this.area="citation",this.root="citation",this.extension="",this.substitute_level=new s.Stack(0,s.LITERAL),this.names_level=0,this.render_nesting_level=0,this.render_seen=!1},s.Engine.Configure=function(){this.fail=[],this.succeed=[]},s.Engine.Citation=function(t){this.opt={},this.tokens=[],this.srt=new s.Registry.Comparifier(t,"citation_sort"),this.opt.collapse=[],this.opt["disambiguate-add-names"]=!1,this.opt["disambiguate-add-givenname"]=!1,this.opt["disambiguate-add-year-suffix"]=!1,this.opt["givenname-disambiguation-rule"]="by-cite",this.opt["near-note-distance"]=5,this.opt.topdecor=[],this.opt.layout_decorations=[],this.opt.layout_prefix="",this.opt.layout_suffix="",this.opt.layout_delimiter="",this.opt.sort_locales=[],this.opt.max_number_of_names=0,this.root="citation"},s.Engine.Bibliography=function(){this.opt={},this.tokens=[],this.opt.collapse=[],this.opt.topdecor=[],this.opt.layout_decorations=[],this.opt.layout_prefix="",this.opt.layout_suffix="",this.opt.layout_delimiter="",this.opt["line-spacing"]=1,this.opt["entry-spacing"]=1,this.opt.sort_locales=[],this.opt.max_number_of_names=0,this.root="bibliography"},s.Engine.BibliographySort=function(){this.tokens=[],this.opt={},this.opt.sort_directions=[],this.keys=[],this.opt.topdecor=[],this.root="bibliography"},s.Engine.CitationSort=function(){this.tokens=[],this.opt={},this.opt.sort_directions=[],this.keys=[],this.opt.topdecor=[],this.root="citation"},s.Engine.prototype.previewCitationCluster=function(t,e,i,n){var r=this.opt.mode;this.setOutputFormat(n);var o=this.processCitationCluster(t,e,i,s.PREVIEW);return this.setOutputFormat(r),o[1]},s.Engine.prototype.appendCitationCluster=function(t){for(var e=[],i=this.registry.citationreg.citationByIndex.length,n=0;i>n;n+=1){var s=this.registry.citationreg.citationByIndex[n];e.push([""+s.citationID,s.properties.noteIndex])}return this.processCitationCluster(t,e,[])[1]},s.Engine.prototype.processCitationCluster=function(t,e,i,n){var r,o,a,l,u,c,h,p,d,f,m,g,b,y,v,_;this.debug=!1,this.tmp.citation_errors=[];var x={bibchange:!1};this.setCitationId(t);var C,w,S;if(n===s.PREVIEW){C=this.registry.citationreg.citationByIndex.slice(),w=this.registry.reflist.slice();var T=e.concat([[""+t.citationID,t.properties.noteIndex]]).concat(i),E={},I=[];for(o=0,a=T.length;a>o;o+=1)for(r=this.registry.citationreg.citationById[T[o][0]],l=0,u=r.citationItems.length;u>l;l+=1)E[r.citationItems[l].id]=!0,I.push(""+r.citationItems[l].id);for(S={},o=0,a=w.length;a>o;o+=1)if(!E[w[o].id]){var N=this.registry.registry[w[o].id].ambig,A=this.registry.ambigcites[N];if(A)for(l=0,u=A.length;u>l;l+=1)S[A[l]]=s.cloneAmbigConfig(this.registry.registry[A[l]].disambig)}}this.tmp.taintedCitationIDs={};var O=[],k={};for(o=0,a=t.citationItems.length;a>o;o+=1){g={};for(f in t.citationItems[o])g[f]=t.citationItems[o][f];if(m=this.retrieveItem(""+g.id),
m.id&&this.transform.loadAbbreviation("default","hereinafter",m.id),this.remapSectionVariable([[m,g]]),this.opt.development_extensions.locator_date_and_revision&&g.locator){g.locator=""+g.locator;var P=g.locator.indexOf("|");if(P>-1){var D=g.locator;g.locator=D.slice(0,P),D=D.slice(P+1),v=D.match(/^([0-9]{4}-[0-9]{2}-[0-9]{2}).*/),v&&(g["locator-date"]=this.fun.dateparser.parse(v[1]),D=D.slice(v[1].length)),g["locator-revision"]=D.replace(/^\s+/,"").replace(/\s+$/,"")}}this.opt.development_extensions.locator_label_parse&&(!g.locator||-1!==["bill","gazette","legislation","treaty"].indexOf(m.type)||g.label&&"page"!==g.label||(v=s.LOCATOR_LABELS_REGEXP.exec(g.locator),v&&(g.label=s.LOCATOR_LABELS_MAP[v[2]],g.locator=v[3])));var R=[m,g];O.push(R),t.citationItems[o].item=m}t.sortedItems=O;var j=[];for(o=0,a=e.length;a>o;o+=1)r=e[o],this.registry.citationreg.citationById[r[0]].properties.noteIndex=r[1],j.push(this.registry.citationreg.citationById[r[0]]);for(j.push(t),o=0,a=i.length;a>o;o+=1)r=i[o],this.registry.citationreg.citationById[r[0]].properties.noteIndex=r[1],j.push(this.registry.citationreg.citationById[r[0]]);this.registry.citationreg.citationByIndex=j,this.registry.citationreg.citationsByItemId={},this.opt.update_mode===s.POSITION&&(y=[],b=[],_={});var L=[];for(o=0,a=j.length;a>o;o+=1){for(j[o].properties.index=o,l=0,u=j[o].sortedItems.length;u>l;l+=1)g=j[o].sortedItems[l],this.registry.citationreg.citationsByItemId[g[1].id]||(this.registry.citationreg.citationsByItemId[g[1].id]=[],L.push(""+g[1].id)),-1===this.registry.citationreg.citationsByItemId[g[1].id].indexOf(j[o])&&this.registry.citationreg.citationsByItemId[g[1].id].push(j[o]);this.opt.update_mode===s.POSITION&&(j[o].properties.noteIndex?b.push(j[o]):(j[o].properties.noteIndex=0,y.push(j[o])))}if(n!==s.ASSUME_ALL_ITEMS_REGISTERED&&this.updateItems(L),!this.opt.citation_number_sort&&O&&O.length>1&&this.citation_sort.tokens.length>0){for(o=0,a=O.length;a>o;o+=1)O[o][1].sortkeys=s.getSortKeys.call(this,O[o][0],"citation_sort");if(this.opt.grouped_sort&&!t.properties.unsorted){for(o=0,a=O.length;a>o;o+=1){var F=O[o][1].sortkeys;this.tmp.authorstring_request=!0;var M=this.registry.registry[O[o][0].id].disambig;this.tmp.authorstring_request=!0,s.getAmbiguousCite.call(this,O[o][0],M);var q=this.registry.authorstrings[O[o][0].id];this.tmp.authorstring_request=!1,O[o][1].sortkeys=[q].concat(F)}O.sort(this.citation.srt.compareCompositeKeys);var B=!1,U=!1,$=!1;for(o=0,a=O.length;a>o;o+=1)O[o][1].sortkeys[0]!==B&&($=O[o][1].sortkeys[0],U=O[o][1].sortkeys[1]),O[o][1].sortkeys[0]=""+U+o,B=$}t.properties.unsorted||O.sort(this.citation.srt.compareCompositeKeys)}var H;if(this.opt.update_mode===s.POSITION)for(o=0;2>o;o+=1){H=[y,b][o];var z={},V={};for(l=0,u=H.length;u>l;l+=1){var G=H[l];for(H[l].properties.noteIndex||(H[l].properties.noteIndex=0),H[l].properties.noteIndex=parseInt(H[l].properties.noteIndex,10),l>0&&H[l-1].properties.noteIndex>H[l].properties.noteIndex&&(_={},z={},V={}),c=0,h=G.sortedItems.length;h>c;c+=1)this.registry.registry[G.sortedItems[c][1].id].parallel||(_[G.properties.noteIndex]?_[G.properties.noteIndex]+=1:_[G.properties.noteIndex]=1);for(c=0,h=H[l].sortedItems.length;h>c;c+=1){g=H[l].sortedItems[c];var W=g[0].id,X=g[1].locator,K=g[1].label;g[0].legislation_id&&(W=g[0].legislation_id);var J;if(c>0&&(J=G.sortedItems[c-1][0].legislation_id?G.sortedItems[c-1][0].legislation_id:G.sortedItems[c-1][1].id),n!==s.PREVIEW||G.citationID==t.citationID){var Q={};if(Q.position=g[1].position,Q["first-reference-note-number"]=g[1]["first-reference-note-number"],Q["near-note"]=g[1]["near-note"],g[1]["first-reference-note-number"]=0,g[1]["near-note"]=!1,this.registry.citationreg.citationsByItemId[W]&&"note"===this.opt.xclass&&this.opt.has_disambiguate){var Y=this.registry.registry[W]["citation-count"],Z=this.registry.citationreg.citationsByItemId[W].length;if(this.registry.registry[W]["citation-count"]=this.registry.citationreg.citationsByItemId[W].length,"number"==typeof Y){var tt=2>Y,et=2>Z;if(tt!==et)for(var it=0,nt=this.registry.citationreg.citationsByItemId[W].length;nt>it;it++)k[this.registry.registry[W].ambig]=!0,this.tmp.taintedCitationIDs[this.registry.citationreg.citationsByItemId[W][it].citationID]=!0}else for(var it=0,nt=this.registry.citationreg.citationsByItemId[W].length;nt>it;it++)k[this.registry.registry[W].ambig]=!0,this.tmp.taintedCitationIDs[this.registry.citationreg.citationsByItemId[W][it].citationID]=!0}var st;if("undefined"==typeof z[W])z[W]=G.properties.noteIndex,this.registry.registry[W]&&(this.registry.registry[W]["first-reference-note-number"]=G.properties.noteIndex),V[W]=G.properties.noteIndex,g[1].position=s.POSITION_FIRST;else{var rt=!1,ot=!1;if(l>0&&(st=H[l-1].sortedItems.slice(-1)[0][1].id,H[l-1].sortedItems[0].slice(-1)[0].legislation_id&&(st=H[l-1].sortedItems[0].slice(-1)[0].legislation_id)),l>0&&0===parseInt(c,10)&&H[l-1].properties.noteIndex!==H[l].properties.noteIndex){var at=H[l-1].sortedItems,lt=!1,ut=H[l-1].sortedItems[0][0].id;for(H[l-1].sortedItems[0][0].legislation_id&&(ut=H[l-1].sortedItems[0][0].legislation_id),(ut==W&&H[l-1].properties.noteIndex>=H[l].properties.noteIndex-1||H[l-1].sortedItems[0][1].id==this.registry.registry[g[1].id].parallel)&&(1===_[H[l-1].properties.noteIndex]||0===H[l-1].properties.noteIndex)&&(lt=!0),p=0,d=at.slice(1).length;d>p;p+=1){var ct=at.slice(1)[p];this.registry.registry[ct[1].id].parallel&&this.registry.registry[ct[1].id].parallel!=this.registry.registry[ct[1].id]||(lt=!1)}lt?rt=!0:ot=!0}else c>0&&J==W?rt=!0:0===c&&H[l-1].properties.noteIndex==H[l].properties.noteIndex&&H[l-1].sortedItems.length&&st==W?rt=!0:ot=!0;var ht,pt,dt,ft,mt;if(rt&&(ht=c>0?G.sortedItems[c-1][1]:H[l-1].sortedItems[0][1],ht.locator?(dt=ht.label?ht.label:"",pt=""+ht.locator+dt):pt=ht.locator,X?(mt=K?K:"",ft=""+X+mt):ft=X),rt&&pt&&!ft&&(rt=!1,ot=!0),rt&&(!pt&&ft?g[1].position=s.POSITION_IBID_WITH_LOCATOR:pt||ft?pt&&ft===pt?g[1].position=s.POSITION_IBID:pt&&ft&&ft!==pt?g[1].position=s.POSITION_IBID_WITH_LOCATOR:(rt=!1,ot=!0):g[1].position=s.POSITION_IBID),ot&&(g[1].position=s.POSITION_SUBSEQUENT),(ot||rt)&&z[W]!=G.properties.noteIndex&&(g[1]["first-reference-note-number"]=z[W],this.registry.registry[W])){var gt=this.registry.citationreg.citationsByItemId[W][0].properties.noteIndex,bt=G.properties.noteIndex;this.registry.registry[W]["first-reference-note-number"]=gt>bt?bt:gt}}if(G.properties.noteIndex){var yt=parseInt(G.properties.noteIndex,10)-parseInt(V[W],10);g[1].position!==s.POSITION_FIRST&&yt<=this.citation.opt["near-note-distance"]&&(g[1]["near-note"]=!0),V[W]=G.properties.noteIndex}if(G.citationID!=t.citationID)for(p=0,d=s.POSITION_TEST_VARS.length;d>p;p+=1){var vt=s.POSITION_TEST_VARS[p];g[1][vt]!==Q[vt]&&("first-reference-note-number"===vt&&(k[this.registry.registry[W].ambig]=!0),this.tmp.taintedCitationIDs[G.citationID]=!0,"first-reference-note-number"===vt&&(this.tmp.taintedItemIDs[W]=!0))}this.sys.variableWrapper&&(g[1].index=G.properties.index,g[1].noteIndex=G.properties.noteIndex)}else"undefined"==typeof z[g[1].id]?(z[W]=G.properties.noteIndex,V[W]=G.properties.noteIndex):V[W]=G.properties.noteIndex}}}if(this.opt.citation_number_sort&&O&&O.length>1&&this.citation_sort.tokens.length>0){for(o=0,a=O.length;a>o;o+=1)O[o][1].sortkeys=s.getSortKeys.call(this,O[o][0],"citation_sort");t.properties.unsorted||O.sort(this.citation.srt.compareCompositeKeys)}for(f in this.tmp.taintedItemIDs)if(this.tmp.taintedItemIDs.hasOwnProperty(f)&&(H=this.registry.citationreg.citationsByItemId[f]))for(o=0,a=H.length;a>o;o+=1)this.tmp.taintedCitationIDs[H[o].citationID]=!0;var _t=[];if(n===s.PREVIEW){try{_t=this.process_CitationCluster.call(this,t.sortedItems,t.citationID)}catch(xt){s.error("Error running CSL processor for preview: "+xt)}for(this.registry.citationreg.citationByIndex=C,this.registry.citationreg.citationById={},o=0,a=C.length;a>o;o+=1)this.registry.citationreg.citationById[C[o].citationID]=C[o];var Ct=[];for(o=0,a=w.length;a>o;o+=1)Ct.push(""+w[o].id);this.updateItems(Ct);for(f in S)S.hasOwnProperty(f)&&(this.registry.registry[f].disambig=S[f])}else{for(var wt in k)this.disambiguate.run(wt,t);var St;for(f in this.tmp.taintedCitationIDs)if(f!=t.citationID){var Tt=this.registry.citationreg.citationById[f];this.tmp.citation_pos=Tt.properties.index,this.tmp.citation_note_index=Tt.properties.noteIndex,this.tmp.citation_id=""+Tt.citationID,St=[],St.push(Tt.properties.index),St.push(this.process_CitationCluster.call(this,Tt.sortedItems,Tt.citationID)),_t.push(St)}this.tmp.taintedItemIDs={},this.tmp.taintedCitationIDs={},this.tmp.citation_pos=t.properties.index,this.tmp.citation_note_index=t.properties.noteIndex,this.tmp.citation_id=""+t.citationID,St=[],St.push(e.length),St.push(this.process_CitationCluster.call(this,O,t.citationID)),_t.push(St),_t.sort(function(t,e){return t[0]>e[0]?1:t[0]<e[0]?-1:0})}return x.citation_errors=this.tmp.citation_errors.slice(),[x,_t]},s.Engine.prototype.process_CitationCluster=function(t,e){var i;return this.parallel.StartCitation(t),i=s.getCitationCluster.call(this,t,e)},s.Engine.prototype.makeCitationCluster=function(t){var e,i,n,r,o,a,l;for(e=[],o=t.length,r=0;o>r;r+=1){a={};for(var u in t[r])a[u]=t[r][u];if(l=this.retrieveItem(""+a.id),this.opt.development_extensions.locator_label_parse&&a.locator&&-1===["bill","gazette","legislation","treaty"].indexOf(l.type)&&(!a.label||"page"===a.label)){var c=s.LOCATOR_LABELS_REGEXP.exec(a.locator);c&&(a.label=s.LOCATOR_LABELS_MAP[c[2]],a.locator=c[3])}i=[l,a],e.push(i)}if(this.remapSectionVariable(e),e&&e.length>1&&this.citation_sort.tokens.length>0){for(o=e.length,r=0;o>r;r+=1)e[r][1].sortkeys=s.getSortKeys.call(this,e[r][0],"citation_sort");e.sort(this.citation.srt.compareCompositeKeys)}return this.tmp.citation_errors=[],this.parallel.StartCitation(e),n=s.getCitationCluster.call(this,e)},s.getAmbiguousCite=function(t,e,i){var n,r,o=this.tmp.group_context.value().slice();e?this.tmp.disambig_request=e:this.tmp.disambig_request=!1;var a={position:1};this.registry.registry[t.id]&&this.registry.citationreg.citationsByItemId&&this.registry.citationreg.citationsByItemId[t.id]&&this.registry.citationreg.citationsByItemId[t.id].length&&i&&"by-cite"===this.citation.opt["givenname-disambiguation-rule"]&&(a["first-reference-note-number"]=this.registry.registry[t.id]["first-reference-note-number"]),this.tmp.area="citation",n=this.parallel.use_parallels,this.parallel.use_parallels=!1,this.tmp.suppress_decorations=!0,this.tmp.just_looking=!0,s.getCite.call(this,t,a);for(var l=0,u=this.output.queue.length;u>l;l+=1)s.Output.Queue.purgeEmptyBlobs(this.output.queue[l]);if(this.opt.development_extensions.clean_up_csl_flaws)for(var c=0,h=this.output.queue.length;h>c;c+=1)this.output.adjust.upward(this.output.queue[c]),this.output.adjust.leftward(this.output.queue[c]),this.output.adjust.downward(this.output.queue[c]),this.output.adjust.fix(this.output.queue[c]);return r=this.output.string(this,this.output.queue),this.tmp.just_looking=!1,this.tmp.suppress_decorations=!1,this.parallel.use_parallels=n,this.tmp.group_context.replace(o,"literal"),r},s.getSpliceDelimiter=function(t,e){if(t&&!this.tmp.have_collapsed&&"string"==typeof this.citation.opt["after-collapse-delimiter"])this.tmp.splice_delimiter=this.citation.opt["after-collapse-delimiter"];else if(this.tmp.have_collapsed&&"in-text"===this.opt.xclass&&this.opt.update_mode!==s.NUMERIC)this.tmp.splice_delimiter=", ";else if(this.tmp.use_cite_group_delimiter)this.tmp.splice_delimiter=this.citation.opt.cite_group_delimiter;else if(this.tmp.cite_locales[e-1]){var i=this.tmp.cite_affixes[this.tmp.area][this.tmp.cite_locales[e-1]];i&&i.delimiter&&(this.tmp.splice_delimiter=i.delimiter)}return this.tmp.splice_delimiter||(this.tmp.splice_delimiter=""),this.tmp.splice_delimiter},s.getCitationCluster=function(t,e){var i,n,r,o,a,l,u,c,h,p,d,f,m,g,b,y,v,_,x;this.tmp.last_primary_names_string=!1,this.tmp.nestedBraces=!1,_=s.getSafeEscape(this),this.tmp.area="citation",i="",n=[],this.tmp.last_suffix_used="",this.tmp.last_names_used=[],this.tmp.last_years_used=[],this.tmp.backref_index=[],this.tmp.cite_locales=[];var C=!1;if("note"===this.opt.xclass&&this.citation.opt.suppressTrailingPunctuation&&(C=!0),e&&this.registry.citationreg.citationById[e].properties["suppress-trailing-punctuation"]&&(C=!0),"note"===this.opt.xclass){for(var w=[],S=!1,T=!1,E=!1,I=[],N=0,A=t.length;A>N;N+=1){var O=t[N][0].type,k=t[N][0].title,P=t[N][1].position,D=t[N][0].id;k&&"legal_case"===O&&D!==E&&P&&((k!==S||0===w.length)&&(I=[],w.push(I)),I.push(t[N][1])),S=k,T=P,E=D}for(N=0,A=w.length;A>N;N+=1)if(I=w[N],!(I.length<2)){var R=I.slice(-1)[0].locator;if(R)for(var j=0,L=I.length-1;L>j;j+=1)I[j].locator&&(R=!1);R&&(I[0].locator=R,delete I.slice(-1)[0].locator,I[0].label=I.slice(-1)[0].label,I.slice(-1)[0].label&&delete I.slice(-1)[0].label)}}for(r=[],o=t.length,a=0;o>a;a+=1){if(m=t[a][0],l=t[a][1],u=this.tmp.have_collapsed,c={},a>0?s.getCite.call(this,m,l,""+t[a-1][0].id):(this.tmp.term_predecessor=!1,s.getCite.call(this,m,l)),this.tmp.cite_renders_content||(x={citationID:""+this.tmp.citation_id,index:this.tmp.citation_pos,noteIndex:this.tmp.citation_note_index,itemID:""+m.id,citationItems_pos:a,error_code:s.ERROR_NO_RENDERED_FORM},this.tmp.citation_errors.push(x)),a===t.length-1&&this.parallel.ComposeSet(),c.splice_delimiter=s.getSpliceDelimiter.call(this,u,a),l&&l["author-only"]&&(this.tmp.suppress_decorations=!0),a>0){v=t[a-1][1];var F=v.suffix&&"."===v.suffix.slice(-1),M=!v.suffix&&l.prefix&&"."===l.prefix.slice(0,1);if(F||M){var q=c.splice_delimiter.indexOf(" ");q>-1&&!M?c.splice_delimiter=c.splice_delimiter.slice(q):c.splice_delimiter=""}}c.suppress_decorations=this.tmp.suppress_decorations,c.have_collapsed=this.tmp.have_collapsed,r.push(c)}this.tmp.has_purged_parallel=!1,this.parallel.PruneOutputQueue(this),h=0,f=this.output.queue.slice();var B=({strings:{suffix:this.citation.opt.layout_suffix,delimiter:this.citation.opt.layout_delimiter}},this.citation.opt.layout_suffix),U=this.tmp.cite_locales[this.tmp.cite_locales.length-1];U&&this.tmp.cite_affixes[this.tmp.area][U]&&this.tmp.cite_affixes[this.tmp.area][U].suffix&&(B=this.tmp.cite_affixes[this.tmp.area][U].suffix),s.TERMINAL_PUNCTUATION.slice(0,-1).indexOf(B.slice(0,1))>-1&&(B=B.slice(0,1));var $=this.citation.opt.layout_delimiter;$||($=""),s.TERMINAL_PUNCTUATION.slice(0,-1).indexOf($.slice(0,1))>-1&&($=$.slice(0,1));for(var H=B,N=0,A=this.output.queue.length;A>N;N+=1)s.Output.Queue.purgeEmptyBlobs(this.output.queue[N]);if(!this.tmp.suppress_decorations&&this.output.queue.length&&(this.opt.development_extensions.apply_citation_wrapper&&this.sys.wrapCitationEntry&&!this.tmp.just_looking&&"citation"===this.tmp.area||(C||(this.output.queue[this.output.queue.length-1].strings.suffix=H),this.output.queue[0].strings.prefix=this.citation.opt.layout_prefix)),this.opt.development_extensions.clean_up_csl_flaws)for(var j=0,L=this.output.queue.length;L>j;j+=1)this.output.adjust.upward(this.output.queue[j]),this.output.adjust.leftward(this.output.queue[j]),this.output.adjust.downward(this.output.queue[j]),this.tmp.last_chr=this.output.adjust.fix(this.output.queue[j]);for(a=0,o=f.length;o>a;a+=1){if(this.output.queue=[f[a]],this.tmp.suppress_decorations=r[a].suppress_decorations,this.tmp.splice_delimiter=r[a].splice_delimiter,f[a].parallel_delimiter&&(this.tmp.splice_delimiter=f[a].parallel_delimiter),this.tmp.have_collapsed=r[a].have_collapsed,p=this.output.string(this,this.output.queue),this.tmp.suppress_decorations=!1,"string"==typeof p)return this.tmp.suppress_decorations=!1,p;if("object"==typeof p&&0===p.length&&!l["suppress-author"])if(this.tmp.has_purged_parallel)p.push("");else{var z="[CSL STYLE ERROR: reference with no printed form.]",V=0===a?_(this.citation.opt.layout_prefix):"",G=a===f.length-1?_(this.citation.opt.layout_suffix):"";p.push(V+z+G)}if(n.length&&"string"==typeof p[0]){p.reverse();var W=p.pop();W&&","===W.slice(0,1)?n.push(W):"string"==typeof n.slice(-1)[0]&&","===n.slice(-1)[0].slice(-1)?n.push(" "+W):W&&n.push(_(this.tmp.splice_delimiter)+W)}else p.reverse(),d=p.pop(),"undefined"!=typeof d&&(n.length&&"string"==typeof n[n.length-1]&&(n[n.length-1]+=d.successor_prefix),n.push(d));for(g=p.length,b=0;g>b;b+=1)y=p[b],"string"!=typeof y?(d=p.pop(),"undefined"!=typeof d&&n.push(d)):n.push(_(this.tmp.splice_delimiter)+y);0!==n.length||t[a][1]["suppress-author"]||(h+=1)}if(i+=this.output.renderBlobs(n),i&&(this.output.nestedBraces=!1,!this.tmp.suppress_decorations))for(o=this.citation.opt.layout_decorations.length,a=0;o>a;a+=1)c=this.citation.opt.layout_decorations[a],"normal"!==c[1]&&(i=this.fun.decorate[c[0]][c[1]](this,i));return this.tmp.suppress_decorations=!1,i},s.getCite=function(t,e,i){var n,r;for(this.tmp.cite_renders_content=!1,this.parallel.StartCite(t,e,i),s.citeStart.call(this,t,e),n=0,this.nameOutput=new s.NameOutput(this,t,e);n<this[this.tmp.area].tokens.length;)n=s.tokenExec.call(this,this[this.tmp.area].tokens[n],t,e);return s.citeEnd.call(this,t,e),this.parallel.CloseCite(this),this.tmp.cite_renders_content||this.tmp.just_looking||"bibliography"===this.tmp.area&&(r={index:this.tmp.bibliography_pos,itemID:""+t.id,error_code:s.ERROR_NO_RENDERED_FORM},this.tmp.bibliography_errors.push(r)),""+t.id},s.citeStart=function(t,e){if(this.tmp.disambiguate_count=0,this.tmp.disambiguate_maxMax=0,this.tmp.same_author_as_previous_cite=!1,this.tmp.suppress_decorations?this.tmp.subsequent_author_substitute_ok=!1:this.tmp.subsequent_author_substitute_ok=!0,this.tmp.lastchr="","citation"===this.tmp.area&&this.citation.opt.collapse&&this.citation.opt.collapse.length?this.tmp.have_collapsed=!0:this.tmp.have_collapsed=!1,this.tmp.render_seen=!1,this.tmp.disambig_request&&!this.tmp.disambig_override?this.tmp.disambig_settings=this.tmp.disambig_request:this.registry.registry[t.id]&&!this.tmp.disambig_override?(this.tmp.disambig_request=this.registry.registry[t.id].disambig,this.tmp.disambig_settings=this.registry.registry[t.id].disambig):this.tmp.disambig_settings=new s.AmbigConfig,"citation"!==this.tmp.area&&this.registry.registry[t.id]&&(this.tmp.disambig_restore=s.cloneAmbigConfig(this.registry.registry[t.id].disambig),"bibliography"===this.tmp.area&&this.tmp.disambig_settings&&this.tmp.disambig_override&&(this.opt["disambiguate-add-names"]&&(this.tmp.disambig_settings.names=this.registry.registry[t.id].disambig.names.slice(),this.tmp.disambig_request.names=this.registry.registry[t.id].disambig.names.slice()),this.opt["disambiguate-add-givenname"]))){this.tmp.disambig_request=this.tmp.disambig_settings,this.tmp.disambig_settings.givens=this.registry.registry[t.id].disambig.givens.slice(),this.tmp.disambig_request.givens=this.registry.registry[t.id].disambig.givens.slice();for(var i=0,n=this.tmp.disambig_settings.givens.length;n>i;i+=1)this.tmp.disambig_settings.givens[i]=this.registry.registry[t.id].disambig.givens[i].slice();for(var i=0,n=this.tmp.disambig_request.givens.length;n>i;i+=1)this.tmp.disambig_request.givens[i]=this.registry.registry[t.id].disambig.givens[i].slice()}if(this.tmp.names_used=[],this.tmp.nameset_counter=0,this.tmp.years_used=[],this.tmp.names_max.clear(),this.tmp.splice_delimiter=this[this.tmp.area].opt.layout_delimiter,this.bibliography_sort.keys=[],this.citation_sort.keys=[],this.tmp.has_done_year_suffix=!1,this.tmp.last_cite_locale=!1,!this.tmp.just_looking&&e&&!e.position&&this.registry.registry[t.id]&&(this.tmp.disambig_restore=s.cloneAmbigConfig(this.registry.registry[t.id].disambig)),this.tmp.shadow_numbers={},this.setNumberLabels(t),this.tmp.first_name_string=!1,this.opt.development_extensions.flip_parentheses_to_braces&&e&&e.prefix){var r=s.checkNestedBraceOpen.exec(e.prefix),o=s.checkNestedBraceClose.exec(e.prefix);r?o?o[0].length<r[0].length?this.output.nestedBraces=s.NestedBraces:this.output.nestedBraces=!1:this.output.nestedBraces=s.NestedBraces:o&&(this.output.nestedBraces=!1)}},s.citeEnd=function(t,e){if(this.tmp.disambig_restore){this.registry.registry[t.id].disambig.names=this.tmp.disambig_restore.names.slice(),this.registry.registry[t.id].disambig.givens=this.tmp.disambig_restore.givens.slice();for(var i=0,n=this.registry.registry[t.id].disambig.givens.length;n>i;i+=1)this.registry.registry[t.id].disambig.givens[i]=this.tmp.disambig_restore.givens[i].slice()}if(this.tmp.disambig_restore=!1,e&&e.suffix?this.tmp.last_suffix_used=e.suffix:this.tmp.last_suffix_used="",this.tmp.last_years_used=this.tmp.years_used.slice(),this.tmp.last_names_used=this.tmp.names_used.slice(),this.tmp.cut_var=!1,this.tmp.disambig_request=!1,this.tmp.cite_locales.push(this.tmp.last_cite_locale),this.tmp.issued_date&&this.tmp.renders_collection_number){for(var r=[],i=this.tmp.issued_date.list.length-1;i>this.tmp.issued_date.pos;i+=-1)r.push(this.tmp.issued_date.list.pop());for(this.tmp.issued_date.list.pop(),i=r.length-1;i>-1;i+=-1)this.tmp.issued_date.list.push(r.pop());this.parallel.use_parallels&&(this.parallel.cite.issued=!1)}if(this.tmp.issued_date=!1,this.tmp.renders_collection_number=!1,this.opt.development_extensions.flip_parentheses_to_braces&&e&&e.suffix){var o=s.checkNestedBraceOpen.exec(e.suffix),a=s.checkNestedBraceClose.exec(e.suffix);a?o?o[0].length<a[0].length?this.output.nestedBraces=!1:this.output.nestedBraces=s.NestedBraces:this.output.nestedBraces=!1:o&&(this.output.nestedBraces=s.NestedBraces)}},s.Engine.prototype.makeBibliography=function(t){var e,i,n,r,o,a,l,u,c;if(e=!1,!this.bibliography.tokens.length)return!1;"string"==typeof t&&(this.opt.citation_number_slug=t,t=!1),i=s.getBibliographyEntries.call(this,t),u=i[0],c=i[1];var h=i[2];for(n={maxoffset:0,entryspacing:this.bibliography.opt["entry-spacing"],linespacing:this.bibliography.opt["line-spacing"],"second-field-align":!1,entry_ids:u,bibliography_errors:this.tmp.bibliography_errors.slice(),done:h},this.bibliography.opt["second-field-align"]&&(n["second-field-align"]=this.bibliography.opt["second-field-align"]),r=0,a=this.registry.reflist.length,l=0;a>l;l+=1)o=this.registry.reflist[l],o.offset>n.maxoffset&&(n.maxoffset=o.offset);return this.bibliography.opt.hangingindent&&(n.hangingindent=this.bibliography.opt.hangingindent),n.bibstart=this.fun.decorate.bibstart,n.bibend=this.fun.decorate.bibend,this.opt.citation_number_slug=!1,[n,c]},s.getBibliographyEntries=function(t){function e(t,e){return t===e?!0:!1}function i(t,i){for(f=i.length,m=0;f>m;m+=1)if(e(t,i[m]))return!0;return!1}function n(t,n){return"none"!==t&&t||n?"string"==typeof n?e(t,n):n?i(t,n):!1:!0}var r,o,a,l,u,c,h,p,d,f,m,g,b,y,v,_,x,C,w,S,T,E,I,N;r=[],E=[],this.tmp.area="bibliography",this.tmp.last_rendered_name=!1,this.tmp.bibliography_errors=[],this.tmp.bibliography_pos=0,o=t&&t.page_start&&t.page_length?this.registry.getSortedIds():this.retrieveItems(this.registry.getSortedIds()),this.tmp.disambig_override=!0,C={};var A;if(t&&t.page_start&&t.page_length&&(A=0,t.page_start!==!0))for(v=0,_=o.length;_>v&&(C[o[v]]=!0,t.page_start!=o[v]);v+=1);var O=[];for(v=0,_=o.length;_>v;v+=1){if(t&&t.page_start&&t.page_length){if(C[o[v]])continue;if(p=this.retrieveItem(o[v]),A===t.page_length)break}else if(p=o[v],C[p.id])continue;if(t){if(a=!0,t.include){for(a=!1,I=0,N=t.include.length;N>I;I+=1)if(d=t.include[I],n(d.value,p[d.field])){a=!0;break}}else if(t.exclude){for(l=!1,I=0,N=t.exclude.length;N>I;I+=1)if(d=t.exclude[I],n(d.value,p[d.field])){l=!0;break}l&&(a=!1)}else if(t.select){for(a=!1,u=!0,I=0,N=t.select.length;N>I;I+=1)d=t.select[I],n(d.value,p[d.field])||(u=!1);u&&(a=!0)}if(t.quash){for(u=!0,I=0,N=t.quash.length;N>I;I+=1)d=t.quash[I],n(d.value,p[d.field])||(u=!1);u&&(a=!1)}if(!a)continue}if(c=new s.Token("group",s.START),c.decorations=[["@bibliography","entry"]].concat(this.bibliography.opt.layout_decorations),this.output.startTag("bib_entry",c),p.system_id&&this.sys.embedBibliographyEntry?this.output.current.value().item_id=p.system_id:this.output.current.value().system_id=p.id,w=[[{id:""+p.id},p]],b=[],!this.registry.registry[p.id].master||t&&t.page_start&&t.page_length)this.registry.registry[p.id].siblings||(this.parallel.StartCitation(w),this.tmp.term_predecessor=!1,b.push(""+s.getCite.call(this,p)),t&&t.page_start&&t.page_length&&(A+=1));else{for(y=!0,this.parallel.StartCitation(w),this.output.queue[0].strings.delimiter=", ",this.tmp.term_predecessor=!1,b.push(""+s.getCite.call(this,p)),C[p.id]=!0,x=this.registry.registry[p.id].siblings,I=0,N=x.length;N>I;I+=1){var k=this.registry.registry[p.id].siblings[I];S=this.retrieveItem(k),b.push(""+s.getCite.call(this,S)),C[S.id]=!0}this.parallel.ComposeSet(),this.parallel.PruneOutputQueue()}if(E.push(""),this.tmp.bibliography_pos+=1,O.push(b),this.output.endTag("bib_entry"),this.output.queue[0].blobs.length&&this.output.queue[0].blobs[0].blobs.length){for(y||!this.output.queue[0].blobs[0].blobs[0].strings?(g=this.output.queue[0].blobs,y=!1):g=this.output.queue[0].blobs[0].blobs,I=g.length-1;I>-1;I+=-1)if(g[I].blobs&&0!==g[I].blobs.length){var P,D=this.tmp.cite_locales[this.tmp.cite_locales.length-1];P=this.tmp.cite_affixes[this.tmp.area][D]?this.tmp.cite_affixes[this.tmp.area][D].suffix:this.bibliography.opt.layout_suffix,T=P.slice(0,1),T&&g[I].strings.suffix.slice(-1)===T&&(g[I].strings.suffix=g[I].strings.suffix.slice(0,-1)),g[I].strings.suffix+=P;break}g[0].strings.prefix=this.bibliography.opt.layout_prefix+g[0].strings.prefix}for(var I=0,N=this.output.queue.length;N>I;I+=1)s.Output.Queue.purgeEmptyBlobs(this.output.queue[I]);for(var I=0,N=this.output.queue.length;N>I;I+=1)this.output.adjust.upward(this.output.queue[I]),this.output.adjust.leftward(this.output.queue[I]),this.output.adjust.downward(this.output.queue[I],!0),this.output.adjust.fix(this.output.queue[I]);h=this.output.string(this,this.output.queue)[0],h||(h="\n[CSL STYLE ERROR: reference with no printed form.]\n"),r.push(h)}var R=!1;if(t&&t.page_start&&t.page_length){var j=o.slice(-1)[0],L=O.slice(-1)[0];j&&L&&j!=L||(R=!0)}return this.tmp.disambig_override=!1,[O,r,R]},s.Engine.prototype.setCitationId=function(t,e){var i,n,s;if(i=!1,!t.citationID||e){for(n=Math.floor(1e14*Math.random());;){if(s=0,!this.registry.citationreg.citationById[n]){t.citationID=n.toString(32);break}s=!s&&5e13>n?1:-1,n+=1===s?1:-1}i=""+n}return this.registry.citationreg.citationById[t.citationID]=t,i},s.Engine.prototype.rebuildProcessorState=function(t,e,i){t||(t=[]),e||(e="html");for(var n={},r=[],o=0,a=t.length;a>o;o+=1)for(var l=0,u=t[o].citationItems.length;u>l;l+=1){var c=""+t[o].citationItems[l].id;n[c]||r.push(c),n[c]=!0}this.updateItems(r);var h=[],p=[],d=[],f=this.opt.mode;this.setOutputFormat(e);for(var o=0,a=t.length;a>o;o+=1){var m=this.processCitationCluster(t[o],h,p,s.ASSUME_ALL_ITEMS_REGISTERED);h.push([t[o].citationID,t[o].properties.noteIndex]);for(var l=0,u=m[1].length;u>l;l+=1){var g=m[1][l][0];d[g]=[h[g][0],h[g][1],m[1][l][1]]}}return this.updateUncitedItems(i),this.setOutputFormat(f),d},s.Engine.prototype.restoreProcessorState=function(t){var e,i,n,r,o,a,l,u,c,h;u=[],c=[],t||(t=[]);var p=[],d={};for(e=0,i=t.length;i>e;e+=1)d[t[e].citationID]&&this.setCitationId(t[e],!0),d[t[e].citationID]=!0,p.push(t[e].properties.index);var f=t.slice();for(f.sort(function(t,e){return t.properties.index<e.properties.index?-1:t.properties.index>e.properties.index?1:0}),e=0,i=f.length;i>e;e+=1)f[e].properties.index=e;for(e=0,i=f.length;i>e;e+=1){for(h=[],n=0,r=f[e].citationItems.length;r>n;n+=1)o=f[e].citationItems[n],"undefined"==typeof o.sortkeys&&(o.sortkeys=[]),a=this.retrieveItem(""+o.id),l=[a,o],h.push(l),f[e].citationItems[n].item=a,c.push(""+o.id);f[e].properties.unsorted||h.sort(this.citation.srt.compareCompositeKeys),f[e].sortedItems=h,this.registry.citationreg.citationById[f[e].citationID]=f[e]}for(this.updateItems(c),e=0,i=t.length;i>e;e+=1)u.push([""+t[e].citationID,t[e].properties.noteIndex]);var m=[];return t&&t.length?m=this.processCitationCluster(t[0],[],u.slice(1)):(this.registry=new s.Registry(this),this.tmp=new s.Engine.Tmp,this.disambiguate=new s.Disambiguation(this)),m},s.Engine.prototype.updateItems=function(t,e,i){var n=this.tmp.area;if(this.registry.init(t),i)for(var s in this.registry.ambigcites)this.registry.ambigsTouched[s]=!0;return this.registry.dodeletes(this.registry.myhash),this.registry.doinserts(this.registry.mylist),this.registry.dorefreshes(),this.registry.rebuildlist(),this.registry.setsortkeys(),this.registry.setdisambigs(),e||this.registry.sorttokens(),this.registry.renumber(),this.tmp.area=n,this.registry.getSortedIds()},s.Engine.prototype.updateUncitedItems=function(t,e){if(t||(t=[]),"object"==typeof t)if("undefined"==typeof t.length){var i=t;t=[];for(var n in i)t.push(n)}else if("number"==typeof t.length)for(var i={},s=0,r=t.length;r>s;s+=1)i[t[s]]=!0;return this.registry.init(t,!0),this.registry.dopurge(i),this.registry.doinserts(this.registry.mylist),this.registry.dorefreshes(),this.registry.rebuildlist(),this.registry.setsortkeys(),this.registry.setdisambigs(),e||this.registry.sorttokens(),this.registry.renumber(),this.registry.getSortedIds()},s.localeResolve=function(t,e){var i,n;return e||(e="en-US"),t||(t=e),i={},n=t.split(/[\-_]/),i.base=s.LANG_BASES[n[0]],"undefined"==typeof i.base?(s.debug("Warning: unknown locale "+t+", setting fallback to "+e),{base:e,best:t,bare:n[0]}):(1===n.length&&(i.generic=!0),1===n.length||"x"===n[1]?i.best=i.base.replace("_","-"):i.best=n.slice(0,2).join("-"),i.base=i.base.replace("_","-"),i.bare=n[0],i)},s.Engine.prototype.localeConfigure=function(t,e){var i;if(this.opt.development_extensions.normalize_lang_keys_to_lowercase&&(t.best=t.best.toLowerCase(),t.bare=t.bare.toLowerCase(),t.base=t.base.toLowerCase()),(!e||!this.locale[t.best])&&(i=this.sys.xml.makeXml(this.sys.retrieveLocale("en-US")),this.localeSet(i,"en-US",t.best),"en-US"!==t.best&&(t.base!==t.best&&(i=this.sys.xml.makeXml(this.sys.retrieveLocale(t.base)),this.localeSet(i,t.base,t.best)),i=this.sys.xml.makeXml(this.sys.retrieveLocale(t.best)),this.localeSet(i,t.best,t.best)),this.localeSet(this.cslXml,"",t.best),this.localeSet(this.cslXml,t.bare,t.best),t.base!==t.best&&this.localeSet(this.cslXml,t.base,t.best),this.localeSet(this.cslXml,t.best,t.best),"undefined"==typeof this.locale[t.best].terms["page-range-delimiter"]&&(["fr","pt"].indexOf(t.best.slice(0,2).toLowerCase())>-1?this.locale[t.best].terms["page-range-delimiter"]="-":this.locale[t.best].terms["page-range-delimiter"]="–"),"undefined"==typeof this.locale[t.best].terms["year-range-delimiter"]&&(this.locale[t.best].terms["year-range-delimiter"]="–"),"undefined"==typeof this.locale[t.best].terms["citation-range-delimiter"]&&(this.locale[t.best].terms["citation-range-delimiter"]="–"),this.opt.development_extensions.normalize_lang_keys_to_lowercase)){for(var n=["default-locale","locale-sort","locale-translit","locale-translat"],s=0,r=n.length;r>s;s+=1)for(var o=0,a=this.opt[n[s]].length;a>o;o+=1)this.opt[n[s]][o]=this.opt[n[s]][o].toLowerCase();this.opt.lang=this.opt.lang.toLowerCase()}},s.Engine.prototype.localeSet=function(t,e,i){var n,r,o,a,l,u,c,h,p,d,f,m,g,b,y,v;if(e=e.replace("_","-"),i=i.replace("_","-"),this.opt.development_extensions.normalize_lang_keys_to_lowercase&&(e=e.toLowerCase(),i=i.toLowerCase()),this.locale[i]||(this.locale[i]={},this.locale[i].terms={},this.locale[i].opts={},this.locale[i].opts["skip-words"]=s.SKIP_WORDS,this.locale[i].opts["leading-noise-words"]||(this.locale[i].opts["leading-noise-words"]=[]),this.locale[i].dates={},this.locale[i].ord={"1.0.1":!1,keys:{}},this.locale[i]["noun-genders"]={}),r=this.sys.xml.makeXml(),this.sys.xml.nodeNameIs(t,"locale"))r=t;else for(o=this.sys.xml.getNodesByName(t,"locale"),l=0,m=this.sys.xml.numberofnodes(o);m>l;l+=1)if(n=o[l],this.sys.xml.getAttributeValue(n,"lang","xml")===e){r=n;break}for(o=this.sys.xml.getNodesByName(r,"type"),y=0,v=this.sys.xml.numberofnodes(o);v>y;y+=1){var _=o[y],x=this.sys.xml.getAttributeValue(_,"name"),C=this.sys.xml.getAttributeValue(_,"gender");this.opt.gender[x]=C}var w=this.sys.xml.getNodesByName(r,"term","ordinal").length;if(w){
for(var S in this.locale[i].ord.keys)delete this.locale[i].terms[S];this.locale[i].ord={"1.0.1":!1,keys:{}}}o=this.sys.xml.getNodesByName(r,"term");var T={"last-digit":{},"last-two-digits":{},"whole-number":{}},E=!1,I={};for(l=0,m=this.sys.xml.numberofnodes(o);m>l;l+=1){if(u=o[l],h=this.sys.xml.getAttributeValue(u,"name"),"sub verbo"===h&&(h="sub-verbo"),"ordinal"===h.slice(0,7)){this.sys.xml.getNodeValue(u);if("ordinal"===h)E=!0;else{var N=this.sys.xml.getAttributeValue(u,"match"),A=h.slice(8),g=this.sys.xml.getAttributeValue(u,"gender-form");g||(g="neuter"),N||(N="last-two-digits","0"===A.slice(0,1)&&(N="last-digit")),"0"===A.slice(0,1)&&(A=A.slice(1)),T[N][A]||(T[N][A]={}),T[N][A][g]=h}this.locale[i].ord.keys[h]=!0}"undefined"==typeof this.locale[i].terms[h]&&(this.locale[i].terms[h]={}),c="long",g=!1,this.sys.xml.getAttributeValue(u,"form")&&(c=this.sys.xml.getAttributeValue(u,"form")),this.sys.xml.getAttributeValue(u,"gender-form")&&(g=this.sys.xml.getAttributeValue(u,"gender-form")),this.sys.xml.getAttributeValue(u,"gender")&&(this.locale[i]["noun-genders"][h]=this.sys.xml.getAttributeValue(u,"gender")),g?(this.locale[i].terms[h][g]={},this.locale[i].terms[h][g][c]=[],b=this.locale[i].terms[h][g],I[h]=!0):(this.locale[i].terms[h][c]=[],b=this.locale[i].terms[h]),this.sys.xml.numberofnodes(this.sys.xml.getNodesByName(u,"multiple"))?(b[c][0]=this.sys.xml.getNodeValue(u,"single"),b[c][1]=this.sys.xml.getNodeValue(u,"multiple")):b[c]=this.sys.xml.getNodeValue(u)}if(E){for(var O in I){var k={},P=0;for(var D in this.locale[i].terms[O])["masculine","feminine"].indexOf(D)>-1?k[D]=this.locale[i].terms[O][D]:P+=1;if(!P)if(k.feminine)for(var D in k.feminine)this.locale[i].terms[O][D]=k.feminine[D];else if(k.masculine)for(var D in k.masculine)this.locale[i].terms[O][D]=k.masculine[D]}this.locale[i].ord["1.0.1"]=T}for(h in this.locale[i].terms)for(y=0,v=2;v>y;y+=1)if(g=s.GENDERS[y],this.locale[i].terms[h][g])for(c in this.locale[i].terms[h])this.locale[i].terms[h][g][c]||(this.locale[i].terms[h][g][c]=this.locale[i].terms[h][c]);for(o=this.sys.xml.getNodesByName(r,"style-options"),l=0,m=this.sys.xml.numberofnodes(o);m>l;l+=1){p=o[l],a=this.sys.xml.attributes(p);for(f in a)if(a.hasOwnProperty(f))if("@punctuation-in-quote"===f||"@limit-day-ordinals-to-day-1"===f)"true"===a[f]?this.locale[i].opts[f.slice(1)]=!0:this.locale[i].opts[f.slice(1)]=!1;else if("@skip-words"===f){var R=a[f].split(/\s*,\s*/);this.locale[i].opts[f.slice(1)]=R}else if("@leading-noise-words"===f&&e===i){var j=a[f].split(/\s*,\s*/);this.locale[i].opts["leading-noise-words"]=j}else if("@name-as-sort-order"===f){this.locale[i].opts["name-as-sort-order"]={};for(var L=a[f].split(/\s+/),y=0,v=L.length;v>y;y+=1)this.locale[i].opts["name-as-sort-order"][L[y]]=!0}else if("@name-as-reverse-order"===f){this.locale[i].opts["name-as-reverse-order"]={};for(var L=a[f].split(/\s+/),y=0,v=L.length;v>y;y+=1)this.locale[i].opts["name-as-reverse-order"][L[y]]=!0}else if("@name-never-short"===f){this.locale[i].opts["name-never-short"]={};for(var L=a[f].split(/\s+/),y=0,v=L.length;v>y;y+=1)this.locale[i].opts["name-never-short"][L[y]]=!0}}for(o=this.sys.xml.getNodesByName(r,"date"),l=0,m=this.sys.xml.numberofnodes(o);m>l;l+=1)d=o[l],this.locale[i].dates[this.sys.xml.getAttributeValue(d,"form")]=d},s.Node={},s.Node.bibliography={build:function(t,e){this.tokentype===s.START&&(t.build.area="bibliography",t.build.root="bibliography",t.fixOpt(this,"names-delimiter","delimiter"),t.fixOpt(this,"name-delimiter","delimiter"),t.fixOpt(this,"name-form","form"),t.fixOpt(this,"and","and"),t.fixOpt(this,"delimiter-precedes-last","delimiter-precedes-last"),t.fixOpt(this,"delimiter-precedes-et-al","delimiter-precedes-et-al"),t.fixOpt(this,"initialize-with","initialize-with"),t.fixOpt(this,"initialize","initialize"),t.fixOpt(this,"name-as-sort-order","name-as-sort-order"),t.fixOpt(this,"sort-separator","sort-separator"),t.fixOpt(this,"and","and"),t.fixOpt(this,"et-al-min","et-al-min"),t.fixOpt(this,"et-al-use-first","et-al-use-first"),t.fixOpt(this,"et-al-use-last","et-al-use-last"),t.fixOpt(this,"et-al-subsequent-min","et-al-subsequent-min"),t.fixOpt(this,"et-al-subsequent-use-first","et-al-subsequent-use-first")),e.push(this)}},s.Node.choose={build:function(t,e){var i;this.tokentype===s.START&&(i=function(t,e){t.tmp.jump.push(void 0,s.LITERAL)}),this.tokentype===s.END&&(i=function(t,e){t.tmp.jump.pop()}),this.execs.push(i),e.push(this)},configure:function(t,e){this.tokentype===s.END?(t.configure.fail.push(e),t.configure.succeed.push(e)):(t.configure.fail.pop(),t.configure.succeed.pop())}},s.Node.citation={build:function(t,e){if(this.tokentype===s.START&&(t.fixOpt(this,"names-delimiter","delimiter"),t.fixOpt(this,"name-delimiter","delimiter"),t.fixOpt(this,"name-form","form"),t.fixOpt(this,"and","and"),t.fixOpt(this,"delimiter-precedes-last","delimiter-precedes-last"),t.fixOpt(this,"delimiter-precedes-et-al","delimiter-precedes-et-al"),t.fixOpt(this,"initialize-with","initialize-with"),t.fixOpt(this,"initialize","initialize"),t.fixOpt(this,"name-as-sort-order","name-as-sort-order"),t.fixOpt(this,"sort-separator","sort-separator"),t.fixOpt(this,"and","and"),t.fixOpt(this,"et-al-min","et-al-min"),t.fixOpt(this,"et-al-use-first","et-al-use-first"),t.fixOpt(this,"et-al-use-last","et-al-use-last"),t.fixOpt(this,"et-al-subsequent-min","et-al-subsequent-min"),t.fixOpt(this,"et-al-subsequent-use-first","et-al-subsequent-use-first"),t.build.area="citation"),this.tokentype===s.END){if(t.opt.grouped_sort="in-text"===t.opt.xclass&&t.citation.opt.collapse&&t.citation.opt.collapse.length||t.citation.opt.cite_group_delimiter&&t.citation.opt.cite_group_delimiter.length&&t.opt.update_mode!==s.POSITION&&t.opt.update_mode!==s.NUMERIC,t.opt.grouped_sort&&t.citation_sort.opt.sort_directions.length){var i=t.citation_sort.opt.sort_directions[0].slice();t.citation_sort.opt.sort_directions=[i].concat(t.citation_sort.opt.sort_directions)}t.citation.srt=new s.Registry.Comparifier(t,"citation_sort")}}},s.Node["#comment"]={build:function(t,e){}},s.Node.date={build:function(t,e){var i,n,r,o,a,l,u,c,h,p;(this.tokentype===s.START||this.tokentype===s.SINGLETON)&&(t.build.date_parts=[],t.build.date_variables=this.variables,t.build.extension||s.Util.substituteStart.call(this,t,e),i=t.build.extension?s.dateMacroAsSortKey:function(t,e,i){var s;if(t.tmp.element_rendered_ok=!1,t.tmp.donesies=[],t.tmp.dateparts=[],s=[],!this.variables.length||t.tmp.just_looking&&"issued"!==this.variables[0])t.tmp.date_object=!1;else{for(t.parallel.StartVariable(this.variables[0]),n=e[this.variables[0]],"undefined"==typeof n&&(n={"date-parts":[[0]]},t.opt.development_extensions.locator_date_and_revision&&i&&"locator-date"===this.variables[0]&&i["locator-date"]&&(n=i["locator-date"])),t.tmp.date_object=n,r=this.dateparts.length,o=0;r>o;o+=1)a=this.dateparts[o],"undefined"!=typeof t.tmp.date_object[a+"_end"]?s.push(a):"month"===a&&"undefined"!=typeof t.tmp.date_object.season_end&&s.push(a);for(l=[],u=["year","month","day"],r=u.length,o=0;r>o;o+=1)s.indexOf(u[o])>-1&&l.push(u[o]);for(s=l.slice(),c=2,r=s.length,o=0;r>o;o+=1)if(a=s[o],h=t.tmp.date_object[a],p=t.tmp.date_object[a+"_end"],h!==p){c=o;break}t.tmp.date_collapse_at=s.slice(c)}},this.execs.push(i),i=function(t,e){if(t.output.startTag("date",this),"issued"===this.variables[0]&&"legal_case"===e.type&&!t.tmp.extension&&""+e["collection-number"]==""+t.tmp.date_object.year&&1===this.dateparts.length&&"year"===this.dateparts[0])for(var i in t.tmp.date_object)if(t.tmp.date_object.hasOwnProperty(i)&&"year"===i.slice(0,4)){t.tmp.issued_date={};var n=t.output.current.mystack.slice(-2)[0].blobs;t.tmp.issued_date.list=n,t.tmp.issued_date.pos=n.length-1}},this.execs.push(i)),t.build.extension||this.tokentype!==s.END&&this.tokentype!==s.SINGLETON||(i=function(t,e){t.output.endTag(),t.parallel.CloseVariable("date")},this.execs.push(i)),e.push(this),(this.tokentype===s.END||this.tokentype===s.SINGLETON)&&(t.build.extension||s.Util.substituteEnd.call(this,t,e))}},s.Node["date-part"]={build:function(t,e){var i,n,r,o,a,l,u,c,h,p,d,f,m,g,b,y,v,_,x,C,w,S,T,E;this.strings.form||(this.strings.form="long"),t.build.date_parts.push(this.strings.name);var I=t.build.date_variables[0];i=function(t,e){if(t.tmp.date_object){if(o=!0,a="",l="",t.tmp.donesies.push(this.strings.name),t.tmp.date_object.literal&&"year"===this.strings.name&&(t.parallel.AppendToVariable(t.tmp.date_object.literal),t.output.append(t.tmp.date_object.literal,this)),t.tmp.date_object&&(a=t.tmp.date_object[this.strings.name],l=t.tmp.date_object[this.strings.name+"_end"]),"year"!==this.strings.name||0!==a||t.tmp.suppress_decorations||(a=!1),u=!t.tmp.suppress_decorations,c=t.tmp.have_collapsed,h="year-suffix"===t[t.tmp.area].opt.collapse||"year-suffix-ranged"===t[t.tmp.area].opt.collapse,p=t.opt["disambiguate-add-year-suffix"],u&&p&&h&&(t.tmp.years_used.push(a),d=t.tmp.last_years_used.length>=t.tmp.years_used.length,d&&c&&t.tmp.last_years_used[t.tmp.years_used.length-1]===a&&(a=!1)),"undefined"!=typeof a){f=!1,m=!1,g=!1,b=!1,"year"===this.strings.name&&(parseInt(a,10)<500&&parseInt(a,10)>0&&(m=t.getTerm("ad")),parseInt(a,10)<0&&(f=t.getTerm("bc"),a=-1*parseInt(a,10)),l&&(parseInt(l,10)<500&&parseInt(l,10)>0&&(b=t.getTerm("ad")),parseInt(l,10)<0&&(g=t.getTerm("bc"),l=-1*parseInt(l,10)))),t.parallel.AppendToVariable(a);for(var i=""+t.tmp.date_object.month;i.length<2;)i="0"+i;i="month-"+i;var N=t.locale[t.opt.lang]["noun-genders"][i];if(this.strings.form){var A=this.strings.form;if("day"===this.strings.name&&"ordinal"===A&&t.locale[t.opt.lang].opts["limit-day-ordinals-to-day-1"]&&""+a!="1"&&(A="numeric"),a=s.Util.Dates[this.strings.name][A](t,a,N,"accessed"===I),"month"===this.strings.name)if(t.tmp.strip_periods)a=a.replace(/\./g,"");else for(T=0,E=this.decorations.length;E>T;T+=1)if("@strip-periods"===this.decorations[T][0]&&"true"===this.decorations[T][1]){a=a.replace(/\./g,"");break}if(l)if(l=s.Util.Dates[this.strings.name][A](t,l,N,"accessed"===I,"_end"),t.tmp.strip_periods)l=l.replace(/\./g,"");else for(T=0,E=this.decorations.length;E>T;T+=1)if("@strip-periods"===this.decorations[T][0]&&"true"===this.decorations[T][1]){l=l.replace(/\./g,"");break}}if(t.output.openLevel("empty"),t.tmp.date_collapse_at.length){for(y=!0,r=t.tmp.date_collapse_at.length,n=0;r>n;n+=1)if(S=t.tmp.date_collapse_at[n],-1===t.tmp.donesies.indexOf(S)){y=!1;break}if(y){if(""+l!="0"){if(0===t.dateput.queue.length&&(o=!0),t.opt["year-range-format"]&&"expanded"!==t.opt["year-range-format"]&&!t.tmp.date_object.day&&!t.tmp.date_object.month&&!t.tmp.date_object.season&&"year"===this.strings.name&&a&&l){l=t.fun.year_mangler(a+"-"+l,!0);var O=t.getTerm("year-range-delimiter");l=l.slice(l.indexOf(O)+1)}t.dateput.append(l,this),o&&(t.dateput.current.value()[0].strings.prefix="")}t.output.append(a,this),v=t.output.current.value(),v.blobs[v.blobs.length-1].strings.suffix="",t.output.append(t.getTerm("year-range-delimiter"),"empty"),_=t.dateput.current.value(),v.blobs=v.blobs.concat(_),t.dateput.string(t,t.dateput.queue),t.tmp.date_collapse_at=[]}else t.output.append(a,this),t.tmp.date_collapse_at.indexOf(this.strings.name)>-1&&""+l!="0"&&(0===t.dateput.queue.length&&(o=!0),t.dateput.openLevel("empty"),t.dateput.append(l,this),o&&(t.dateput.current.value().blobs[0].strings.prefix=""),f&&t.dateput.append(f),m&&t.dateput.append(m),t.dateput.closeLevel())}else t.output.append(a,this);f&&t.output.append(f),m&&t.output.append(m),t.output.closeLevel()}else"month"===this.strings.name&&t.tmp.date_object.season&&(a=""+t.tmp.date_object.season,a&&a.match(/^[1-4]$/)?(t.tmp.group_context.replace([!1,!1,!0]),t.output.append(t.getTerm("season-0"+a),this)):a&&t.output.append(a,this));t.tmp.value=[],!a&&!t.tmp.have_collapsed||t.opt.has_year_suffix||"year"!==this.strings.name||t.tmp.just_looking||t.registry.registry[e.id]&&t.registry.registry[e.id].disambig.year_suffix!==!1&&!t.tmp.has_done_year_suffix&&(t.tmp.has_done_year_suffix=!0,C=parseInt(t.registry.registry[e.id].disambig.year_suffix,10),x=new s.NumericBlob(C,this,e.id),this.successor_prefix=t[t.build.area].opt.layout_delimiter,this.splice_prefix=t[t.build.area].opt.layout_delimiter,w=new s.Util.Suffixator(s.SUFFIX_CHARS),x.setFormatter(w),"year-suffix-ranged"===t[t.tmp.area].opt.collapse&&(x.range_prefix=t.getTerm("citation-range-delimiter")),t[t.tmp.area].opt["year-suffix-delimiter"]?x.successor_prefix=t[t.tmp.area].opt["year-suffix-delimiter"]:x.successor_prefix=t[t.tmp.area].opt.layout_delimiter,x.UGLY_DELIMITER_SUPPRESS_HACK=!0,t.output.append(x,"literal"))}},this.execs.push(i),e.push(this)}},s.Node["else-if"]={build:function(t,e){s.Conditions.TopNode.call(this,t,e),e.push(this)},configure:function(t,e){s.Conditions.Configure.call(this,t,e)}},s.Node["else"]={build:function(t,e){e.push(this)},configure:function(t,e){this.tokentype===s.START&&(t.configure.fail[t.configure.fail.length-1]=e)}},s.Node["et-al"]={build:function(t,e){if("citation"===t.build.area||"bibliography"===t.build.area){var i=function(t,e,i){t.tmp.etal_node=this,"string"==typeof this.strings.term&&(t.tmp.etal_term=this.strings.term)};this.execs.push(i)}e.push(this)}},s.Node.group={build:function(t,e){var i,n;this.tokentype===s.START?(s.Util.substituteStart.call(this,t,e),t.build.substitute_level.value()&&t.build.substitute_level.replace(t.build.substitute_level.value()+1),i=function(t,e){t.output.startTag("group",this),t.tmp.group_context.mystack.length&&(t.output.current.value().parent=t.tmp.group_context.value()[4]);var i=t.tmp.group_context.value()[5];!i&&this.strings.label_form_override&&(i=this.strings.label_form_override),t.tmp.group_context.push([!1,!1,!1,!1,t.output.current.value(),i,this.strings.set_parallel_condition],s.LITERAL),this.strings.oops&&(t.tmp.group_context.value()[3]=this.strings.oops)},n=[],n.push(i),this.execs=n.concat(this.execs),this.strings["has-publisher-and-publisher-place"]&&(t.build["publisher-special"]=!0,i=function(t,e){if(this.strings["subgroup-delimiter"]&&e.publisher&&e["publisher-place"]){var i=e.publisher.split(/;\s*/),n=e["publisher-place"].split(/;\s*/);i.length>1&&i.length===n.length&&(t.publisherOutput=new s.PublisherOutput(t,this),t.publisherOutput["publisher-list"]=i,t.publisherOutput["publisher-place-list"]=n)}},this.execs.push(i))):(t.build["publisher-special"]&&(t.build["publisher-special"]=!1,"string"==typeof t[t.build.root].opt["name-delimiter"]&&(i=function(t,e){t.publisherOutput&&(t.publisherOutput.render(),t.publisherOutput=!1)},this.execs.push(i))),i=function(t,e){var i=t.tmp.group_context.pop();t.output.endTag();t.tmp.group_context.value();if(i[1]&&(t.tmp.group_context.value()[1]=!0),i[2]||i[0]&&!i[1]){t.tmp.group_context.value()[2]=!0;var n=t.output.current.value().blobs,s=t.output.current.value().blobs.length-1;if(!t.tmp.just_looking&&"undefined"!=typeof i[6]){var r={blobs:n,conditions:i[6],id:e.id,pos:s};t.parallel.parallel_conditional_blobs_list.push(r)}}else t.output.current.value().blobs&&t.output.current.value().blobs.pop(),t.tmp.group_context.value()[3]&&(t.output.current.mystack[t.output.current.mystack.length-2].strings.delimiter=t.tmp.group_context.value()[3])},this.execs.push(i)),e.push(this),this.tokentype===s.END&&(t.build.substitute_level.value()&&t.build.substitute_level.replace(t.build.substitute_level.value()-1),s.Util.substituteEnd.call(this,t,e))}},s.Node["if"]={build:function(t,e){s.Conditions.TopNode.call(this,t,e),e.push(this)},configure:function(t,e){s.Conditions.Configure.call(this,t,e)}},s.Node.conditions={build:function(t,e){this.tokentype===s.START&&t.tmp.conditions.addMatch(this.match),this.tokentype===s.END&&t.tmp.conditions.matchCombine()}},s.Node.condition={build:function(t,e){if(this.tokentype===s.SINGLETON){var i=t.fun.match[this.match](this,t,this.tests);t.tmp.conditions.addTest(i)}}},s.Conditions={},s.Conditions.TopNode=function(t,e){var i;(this.tokentype===s.START||this.tokentype===s.SINGLETON)&&(this.locale&&(t.opt.lang=this.locale),this.tests&&this.tests.length?this.test=t.fun.match[this.match](this,t,this.tests):t.tmp.conditions=new s.Conditions.Engine(t,this)),(this.tokentype===s.END||this.tokentype===s.SINGLETON)&&(i=function(t,e){this.locale_default&&(t.output.current.value().old_locale=this.locale_default,t.output.closeLevel("empty"),t.opt.lang=this.locale_default);var i=this[t.tmp.jump.value()];return i},this.execs.push(i),this.locale_default&&(t.opt.lang=this.locale_default))},s.Conditions.Configure=function(t,e){this.tokentype===s.START?(this.fail=t.configure.fail.slice(-1)[0],this.succeed=this.next,t.configure.fail[t.configure.fail.length-1]=e):this.tokentype===s.SINGLETON?(this.fail=this.next,this.succeed=t.configure.succeed.slice(-1)[0],t.configure.fail[t.configure.fail.length-1]=e):(this.succeed=t.configure.succeed.slice(-1)[0],this.fail=this.next)},s.Conditions.Engine=function(t,e){this.token=e,this.state=t},s.Conditions.Engine.prototype.addTest=function(t){this.token.tests.push(t)},s.Conditions.Engine.prototype.addMatch=function(t){this.token.match=t},s.Conditions.Engine.prototype.matchCombine=function(){this.token.test=this.state.fun.match[this.token.match](this.token,this.state,this.token.tests)},s.Node.info={build:function(t,e){this.tokentype===s.START?t.build.skip="info":t.build.skip=!1}},s.Node.institution={build:function(t,e){if([s.SINGLETON,s.START].indexOf(this.tokentype)>-1){var i=function(t,e){"string"!=typeof t.build.name_delimiter||this.strings.delimiter||(this.strings.delimiter=t.tmp.name_delimiter);"text"===this.strings.and?this.and_term=t.getTerm("and","long",0):"symbol"===this.strings.and?t.opt.development_extensions.expect_and_symbol_form?this.and_term=t.getTerm("and","symbol",0):this.and_term="&":"none"===this.strings.and&&(this.and_term=this.strings.delimiter),"undefined"==typeof this.and_term&&t.tmp.and_term&&(this.and_term=t.getTerm("and","long",0)),s.STARTSWITH_ROMANESQUE_REGEXP.test(this.and_term)?(this.and_prefix_single=" ",this.and_prefix_multiple=", ","string"==typeof this.strings.delimiter&&(this.and_prefix_multiple=this.strings.delimiter),this.and_suffix=" "):(this.and_prefix_single="",this.and_prefix_multiple="",this.and_suffix=""),"always"===this.strings["delimiter-precedes-last"]?this.and_prefix_single=this.strings.delimiter:"never"===this.strings["delimiter-precedes-last"]&&this.and_prefix_multiple&&(this.and_prefix_multiple=" "),this.and={},"undefined"!=typeof this.and_term?(t.output.append(this.and_term,"empty",!0),this.and.single=t.output.pop(),this.and.single.strings.prefix=this.and_prefix_single,this.and.single.strings.suffix=this.and_suffix,t.output.append(this.and_term,"empty",!0),this.and.multiple=t.output.pop(),this.and.multiple.strings.prefix=this.and_prefix_multiple,this.and.multiple.strings.suffix=this.and_suffix):"undefined"!==this.strings.delimiter&&(this.and.single=new s.Blob(this.strings.delimiter),this.and.single.strings.prefix="",this.and.single.strings.suffix="",this.and.multiple=new s.Blob(this.strings.delimiter),this.and.multiple.strings.prefix="",this.and.multiple.strings.suffix=""),t.nameOutput.institution=this};this.execs.push(i)}e.push(this)},configure:function(t,e){[s.SINGLETON,s.START].indexOf(this.tokentype)>-1&&(t.build.has_institution=!0)}},s.Node["institution-part"]={build:function(t,e){var i;"long"===this.strings.name?i=this.strings["if-short"]?function(t,e){t.nameOutput.institutionpart["long-with-short"]=this}:function(t,e){t.nameOutput.institutionpart["long"]=this}:"short"===this.strings.name&&(i=function(t,e){t.nameOutput.institutionpart["short"]=this}),this.execs.push(i),e.push(this)}},s.Node.key={build:function(t,e){var i,n=new s.Token("key",s.START);n.strings["et-al-min"]=this.strings["et-al-min"],n.strings["et-al-use-first"]=this.strings["et-al-use-first"],n.strings["et-al-use-last"]=this.strings["et-al-use-last"],i=function(t,e){t.tmp.done_vars=[]},n.execs.push(i),t.opt.citation_number_sort_direction=this.strings.sort_direction,i=function(t,e){t.output.openLevel("empty")},n.execs.push(i);var r=[];if(this.strings.sort_direction===s.DESCENDING?(r.push(1),r.push(-1)):(r.push(-1),r.push(1)),t[t.build.area].opt.sort_directions.push(r),s.DATE_VARIABLES.indexOf(this.variables[0])>-1&&(t.build.date_key=!0),i=function(t,e){t.tmp.sort_key_flag=!0,this.strings["et-al-min"]&&(t.tmp["et-al-min"]=this.strings["et-al-min"]),this.strings["et-al-use-first"]&&(t.tmp["et-al-use-first"]=this.strings["et-al-use-first"]),"boolean"==typeof this.strings["et-al-use-last"]&&(t.tmp["et-al-use-last"]=this.strings["et-al-use-last"])},n.execs.push(i),e.push(n),this.variables.length){var o=this.variables[0];if("citation-number"===o&&("citation_sort"===t.build.area&&(t.opt.citation_number_sort=!0),"bibliography_sort"===t.build.area&&(t.opt.citation_number_sort_used=!0)),s.CREATORS.indexOf(o)>-1){var a=new s.Token("names",s.START);a.tokentype=s.START,a.variables=this.variables,s.Node.names.build.call(a,t,e);var l=new s.Token("name",s.SINGLETON);l.tokentype=s.SINGLETON,l.strings["name-as-sort-order"]="all",l.strings["sort-separator"]=" ",l.strings["et-al-use-last"]=this.strings["et-al-use-last"],l.strings["et-al-min"]=this.strings["et-al-min"],l.strings["et-al-use-first"]=this.strings["et-al-use-first"],s.Node.name.build.call(l,t,e);var u=new s.Token("institution",s.SINGLETON);u.tokentype=s.SINGLETON,s.Node.institution.build.call(u,t,e);var c=new s.Token("names",s.END);c.tokentype=s.END,s.Node.names.build.call(c,t,e)}else{var h=new s.Token("text",s.SINGLETON);if(h.dateparts=this.dateparts,s.NUMERIC_VARIABLES.indexOf(o)>-1)i=function(t,e){var i;i=!1,i="citation-number"===o?t.registry.registry[e.id].seq.toString():e[o],i&&(i=s.Util.padding(i)),t.output.append(i,this)};else if("citation-label"===o)i=function(t,e){var i=t.getCitationLabel(e);t.output.append(i,this)};else if(s.DATE_VARIABLES.indexOf(o)>-1)i=s.dateAsSortKey,h.variables=this.variables;else if("title"===o){var p="title",d=!1,f=!1,m=!0;i=t.transform.getOutputFunction(this.variables,p,d,f,m)}else i=function(t,e){var i=e[o];t.output.append(i,"empty")};h.execs.push(i),e.push(h)}}else{var g=new s.Token("text",s.SINGLETON);g.postponed_macro=this.postponed_macro,s.expandMacro.call(t,g)}var b=new s.Token("key",s.END);i=function(t,e){var i=t.output.string(t,t.output.queue);t.sys.normalizeUnicode&&(i=t.sys.normalizeUnicode(i)),""===i&&(i=void 0),("string"!=typeof i||t.tmp.empty_date)&&(i=void 0,t.tmp.empty_date=!1),t[t.tmp.area].keys.push(i),t.tmp.value=[]},b.execs.push(i),t.build.date_key&&("citation_sort"===t.build.area&&(t[t.build.area].opt.sort_directions.push([-1,1]),i=function(t,e){var i=t.registry.registry[e.id].disambig.year_suffix;i||(i=0);var n=s.Util.padding(""+i);t[t.tmp.area].keys.push(n)},b.execs.push(i)),t.build.date_key=!1),i=function(t,e){t.tmp["et-al-min"]=void 0,t.tmp["et-al-use-first"]=void 0,t.tmp["et-al-use-last"]=void 0,t.tmp.sort_key_flag=!1},b.execs.push(i),e.push(b)}},s.Node.label={build:function(t,e){if(this.strings.term){this.strings.form||(this.strings.form="long");var i=function(t,e,i){var n=s.evaluateLabel(this,t,e,i);i&&"locator"===this.strings.term&&(t.parallel.StartVariable("label"),t.parallel.AppendToVariable(i.label),i.section_form_override=this.strings.form),t.output.append(n,this),i&&"locator"===this.strings.term&&t.parallel.CloseVariable()};this.execs.push(i)}else{var n=t.build.names_variables.slice(-1)[0];t.build.name_label||(t.build.name_label={});for(var r=0,o=n.length;o>r;r+=1)t.build.name_label[n[r]]||(t.build.name_label[n[r]]={});if(t.build.name_flag)for(var r=0,o=n.length;o>r;r+=1)t.build.name_label[n[r]].after=this;else for(var r=0,o=n.length;o>r;r+=1)t.build.name_label[n[r]].before=this}e.push(this)}},s.Node.layout={build:function(t,e){var i,n,r,o;this.tokentype===s.START&&(i=function(t,e,i){t.opt.development_extensions.apply_citation_wrapper&&t.sys.wrapCitationEntry&&!t.tmp.just_looking&&e.system_id&&"citation"===t.tmp.area&&(cite_entry=new s.Token("group",s.START),cite_entry.decorations=[["@cite","entry"]],t.output.startTag("cite_entry",cite_entry),t.output.current.value().item_id=e.system_id,i&&(t.output.current.value().locator_txt=i.locator_txt,t.output.current.value().suffix_txt=i.suffix_txt))},this.execs.push(i)),this.tokentype!==s.START||t.tmp.cite_affixes[t.build.area]||(i=function(t,e){t.tmp.done_vars=[],!t.tmp.just_looking&&t.registry.registry[e.id].parallel&&t.tmp.done_vars.push("first-reference-note-number"),t.tmp.rendered_name=!1,t.tmp.name_node={}},this.execs.push(i),i=function(t,e){t.tmp.sort_key_flag=!1},this.execs.push(i),i=function(t,e){t.tmp.nameset_counter=0},this.execs.push(i),i=function(t,e){var i="empty";t.opt.development_extensions.rtl_support&&["ar","he","fa","ur","yi","ps","syr"].indexOf(e.language)>-1&&(i=new s.Token,i.strings.prefix="‫",i.strings.suffix="‬"),t.output.openLevel(i)},this.execs.push(i),e.push(this),t.opt.development_extensions.rtl_support,1,"citation"===t.build.area&&(n=new s.Token("text",s.SINGLETON),i=function(t,e,i){var n;if(i&&i.prefix){n="";var r=i.prefix.replace(/<[^>]+>/g,"").replace(/["'\u201d\u2019\u00bb\u202f\u00a0 ]+$/g,""),o=r.slice(-1);r.match(s.ENDSWITH_ROMANESQUE_REGEXP)?n=" ":s.TERMINAL_PUNCTUATION.slice(0,-1).indexOf(o)>-1?n=" ":o.match(/[\)\],0-9]/)&&(n=" ");var a=!1;s.TERMINAL_PUNCTUATION.slice(0,-1).indexOf(o)>-1&&(t.tmp.term_predecessor=!1,a=!0),prefix=(i.prefix+n).replace(/\s+/g," "),t.output.append(prefix,this,!1,a)}},n.execs.push(i),e.push(n)));var a;if(this.locale_raw&&(a=new s.Token("dummy",s.START),a.locale=this.locale_raw,a.strings.delimiter=this.strings.delimiter,a.strings.suffix=this.strings.suffix,t.tmp.cite_affixes[t.build.area]||(t.tmp.cite_affixes[t.build.area]={})),this.tokentype===s.START&&(t.build.layout_flag=!0,this.locale_raw||(t[t.tmp.area].opt.topdecor=[this.decorations],t[t.tmp.area+"_sort"].opt.topdecor=[this.decorations],t[t.build.area].opt.layout_prefix=this.strings.prefix,t[t.build.area].opt.layout_suffix=this.strings.suffix,t[t.build.area].opt.layout_delimiter=this.strings.delimiter,t[t.build.area].opt.layout_decorations=this.decorations,t.tmp.cite_affixes[t.build.area]&&(o=new s.Token("else",s.START),s.Node["else"].build.call(o,t,e))),this.locale_raw)){if(t.build.layout_locale_flag)a.name="else-if",s.Attributes["@locale-internal"].call(a,t,this.locale_raw),s.Node["else-if"].build.call(a,t,e);else{var l=new s.Token("choose",s.START);s.Node.choose.build.call(l,t,e),a.name="if",s.Attributes["@locale-internal"].call(a,t,this.locale_raw),s.Node["if"].build.call(a,t,e)}t.tmp.cite_affixes[t.build.area][a.locale]={},t.tmp.cite_affixes[t.build.area][a.locale].delimiter=this.strings.delimiter,t.tmp.cite_affixes[t.build.area][a.locale].suffix=this.strings.suffix}this.tokentype===s.END&&(this.locale_raw&&(t.build.layout_locale_flag?(a.name="else-if",a.tokentype=s.END,s.Attributes["@locale-internal"].call(a,t,this.locale_raw),s.Node["else-if"].build.call(a,t,e)):(a.name="if",a.tokentype=s.END,s.Attributes["@locale-internal"].call(a,t,this.locale_raw),s.Node["if"].build.call(a,t,e),t.build.layout_locale_flag=!0)),this.locale_raw||(t.tmp.cite_affixes[t.build.area]&&t.build.layout_locale_flag&&(o=new s.Token("else",s.END),s.Node["else"].build.call(o,t,e),o=new s.Token("choose",s.END),s.Node.choose.build.call(o,t,e)),t.build_layout_locale_flag=!0,"citation"===t.build.area&&(r=new s.Token("text",s.SINGLETON),i=function(t,e,i){var n;i&&i.suffix&&(n="",(i.suffix.match(s.STARTSWITH_ROMANESQUE_REGEXP)||["[","("].indexOf(i.suffix.slice(0,1))>-1)&&(n=" "),t.output.append(n+i.suffix,this))},r.execs.push(i),e.push(r)),i=function(t,e){"bibliography"===t.tmp.area&&t.bibliography.opt["second-field-align"]&&t.output.endTag(),t.output.closeLevel()},this.execs.push(i),i=function(t,e){t.opt.development_extensions.apply_citation_wrapper&&t.sys.wrapCitationEntry&&!t.tmp.just_looking&&e.system_id&&"citation"===t.tmp.area&&t.output.endTag()},this.execs.push(i),e.push(this),t.build.layout_flag=!1,t.build.layout_locale_flag=!1))}},s.Node.macro={build:function(t,e){}},s.NameOutput=function(t,e,i,n){this.debug=!1,this.state=t,this.Item=e,this.item=i,this.nameset_base=0,this.etal_spec={},this._first_creator_variable=!1,this._please_chop=!1},s.NameOutput.prototype.init=function(t){this.state.tmp.term_predecessor&&(this.state.tmp.subsequent_author_substitute_ok=!1),this.nameset_offset&&(this.nameset_base=this.nameset_base+this.nameset_offset),this.nameset_offset=0,this.names=t,this.variables=t.variables,this.state.tmp.value=[],this.state.tmp.rendered_name=[],this.state.tmp.label_blob=!1,this.state.tmp.etal_node=!1,this.state.tmp.etal_term=!1;for(var e=0,i=this.variables.length;i>e;e+=1)this.Item[this.variables[e]]&&this.Item[this.variables[e]].length&&(this.state.tmp.value=this.state.tmp.value.concat(this.Item[this.variables[e]]));this["et-al"]=void 0,this["with"]=void 0,this.name=void 0,this.institutionpart={},this.state.tmp.group_context.value()[1]=!0,!this.state.tmp.value.length},s.NameOutput.prototype.reinit=function(t){if(this.state.tmp.can_substitute.value()){this.nameset_offset=0,this.variables=t.variables;var e=this.state.tmp.value.slice();this.state.tmp.value=[];for(var i=0,n=this.variables.length;n>i;i+=1)this.Item[this.variables[i]]&&this.Item[this.variables[i]].length&&(this.state.tmp.value=this.state.tmp.value.concat(this.Item[this.variables[i]]));this.state.tmp.value.length&&this.state.tmp.can_substitute.replace(!1,s.LITERAL),this.state.tmp.value=e}},s.NameOutput.prototype.outputNames=function(){var t,e,i=this.variables;if(this.institution.and&&(this.institution.and.single.blobs&&this.institution.and.single.blobs.length||(this.institution.and.single.blobs=this.name.and.single.blobs),this.institution.and.multiple.blobs&&this.institution.and.multiple.blobs.length||(this.institution.and.multiple.blobs=this.name.and.multiple.blobs)),this.variable_offset={},this.family)for(this.family_decor=s.Util.cloneToken(this.family),this.family_decor.strings.prefix="",this.family_decor.strings.suffix="",t=0,e=this.family.execs.length;e>t;t+=1)this.family.execs[t].call(this.family_decor,this.state,this.Item);else this.family_decor=!1;if(this.given)for(this.given_decor=s.Util.cloneToken(this.given),this.given_decor.strings.prefix="",this.given_decor.strings.suffix="",t=0,e=this.given.execs.length;e>t;t+=1)this.given.execs[t].call(this.given_decor,this.state,this.Item);else this.given_decor=!1;if(this.getEtAlConfig(),this.divideAndTransliterateNames(),this.truncatePersonalNameLists(),this.disambigNames(),this.constrainNames(),"count"===this.name.strings.form)return void((this.state.tmp.extension||0!=this.names_count)&&(this.state.output.append(this.names_count,"empty"),this.state.tmp.group_context.value()[2]=!0));this.setEtAlParameters(),this.setCommonTerm(),this.state.tmp.name_node={},this.state.tmp.name_node.children=[],this.renderAllNames();var n=[];for(t=0,e=i.length;e>t;t+=1){for(var r=i[t],o=[],a=!1,l=0,u=this.institutions[r].length;u>l;l+=1)o.push(this.joinPersonsAndInstitutions([this.persons[r][l],this.institutions[r][l]]));if(this.institutions[r].length){var c=this.nameset_base+this.variable_offset[r];this.freeters[r].length&&(c+=1),a=this.joinInstitutionSets(o,c)}var h=this.joinFreetersAndInstitutionSets([this.freeters[r],a]);if(h&&("_sort"!==this.state.tmp.area.slice(-5)&&(h=this._applyLabels(h,r)),n.push(h)),this.common_term)break}for(this.state.output.openLevel("empty"),this.state.output.current.value().strings.delimiter=this.names.strings.delimiter,t=0,e=n.length;e>t;t+=1)this.state.output.append(n[t],"literal",!0);this.state.output.closeLevel("empty");var p=this.state.output.pop();if(this.state.output.append(p,this.names),this.state.tmp.term_predecessor_name&&(this.state.tmp.term_predecessor=!0),this.state.tmp.name_node.top=this.state.output.current.value(),"authority"!==i[0]){var d=[],f=this.Item[i[0]];if(f)for(var t=0,e=f.length;e>t;t+=1)substring=s.Util.Names.getRawName(f[t]),substring&&d.push(substring);d=d.join(", "),d&&(this.state.tmp.name_node.string=d)}if(this.state.tmp.name_node.string&&!this.state.tmp.first_name_string&&(this.state.tmp.first_name_string=this.state.tmp.name_node.string),
"classic"===this.Item.type){var m=[];this.state.tmp.first_name_string&&m.push(this.state.tmp.first_name_string),this.Item.title&&m.push(this.Item.title),m=m.join(", "),m&&this.state.sys.getAbbreviation&&(this.state.transform.loadAbbreviation("default","classic",m),this.state.transform.abbrevs["default"].classic[m]&&(this.state.tmp.done_vars.push("title"),this.state.output.append(this.state.transform.abbrevs["default"].classic[m],"empty",!0),p=this.state.output.pop(),this.state.tmp.name_node.top.blobs.pop(),this.state.tmp.name_node.top.blobs.push(p)))}this._collapseAuthor(),this.variables=[]},s.NameOutput.prototype._applyLabels=function(t,e){var i;if(!this.label||!this.label[e])return t;var n=0,s=this.freeters_count[e]+this.institutions_count[e];if(s>1)n=1;else{for(var r=0,o=this.persons[e].length;o>r;r+=1)s+=this.persons_count[e][r];s>1&&(n=1)}return this.label[e].before&&("number"==typeof this.label[e].before.strings.plural&&(n=this.label[e].before.strings.plural),i=this._buildLabel(e,n,"before",e),this.state.output.openLevel("empty"),this.state.output.append(i,this.label[e].before,!0),this.state.output.append(t,"literal",!0),this.state.output.closeLevel("empty"),t=this.state.output.pop()),this.label[e].after&&("number"==typeof this.label[e].after.strings.plural&&(n=this.label[e].after.strings.plural),i=this._buildLabel(e,n,"after",e),this.state.output.openLevel("empty"),this.state.output.append(t,"literal",!0),this.state.output.append(i,this.label[e].after,!0),this.state.tmp.label_blob=this.state.output.pop(),this.state.output.append(this.state.tmp.label_blob,"literal",!0),this.state.output.closeLevel("empty"),t=this.state.output.pop()),t},s.NameOutput.prototype._buildLabel=function(t,e,i,n){this.common_term&&(t=this.common_term);var r=!1,o=this.label[n][i];return o&&(r=s.castLabel(this.state,o,t,e,s.TOLERANT)),r},s.NameOutput.prototype._collapseAuthor=function(){var t,e,i;0===this.nameset_base&&this.Item[this.variables[0]]&&!this._first_creator_variable&&(this._first_creator_variable=this.variables[0]),(this.item&&this.item["suppress-author"]&&this._first_creator_variable==this.variables[0]||this.state[this.state.tmp.area].opt.collapse&&this.state[this.state.tmp.area].opt.collapse.length||this.state[this.state.tmp.area].opt.cite_group_delimiter&&this.state[this.state.tmp.area].opt.cite_group_delimiter.length)&&(this.state.tmp.authorstring_request?(e="",t=this.state.tmp.name_node.top.blobs.slice(-1)[0].blobs,i=this.state.tmp.offset_characters,t&&(e=this.state.output.string(this.state,t,!1)),this.state.tmp.offset_characters=i,this.state.registry.authorstrings[this.Item.id]=e):this.state.tmp.just_looking||this.state.tmp.suppress_decorations||!(this.item["suppress-author"]||this.state[this.state.tmp.area].opt.collapse&&this.state[this.state.tmp.area].opt.collapse.length||this.state[this.state.tmp.area].opt.cite_group_delimiter&&this.state[this.state.tmp.area].opt.cite_group_delimiter)||(e="",t=this.state.tmp.name_node.top.blobs.slice(-1)[0].blobs,i=this.state.tmp.offset_characters,t&&(e=this.state.output.string(this.state,t,!1)),e===this.state.tmp.last_primary_names_string?((this.item["suppress-author"]||this.state[this.state.tmp.area].opt.collapse&&this.state[this.state.tmp.area].opt.collapse.length)&&(this.state.tmp.name_node.top.blobs.pop(),this.state.tmp.name_node.children=[],this.state.tmp.offset_characters=i),this.state[this.state.tmp.area].opt.cite_group_delimiter&&this.state[this.state.tmp.area].opt.cite_group_delimiter&&(this.state.tmp.use_cite_group_delimiter=!0)):(this.state.tmp.last_primary_names_string=e,this.variables.indexOf(this._first_creator_variable)>-1&&this.item&&this.item["suppress-author"]&&"legal_case"!==this.Item.type&&(this.state.tmp.name_node.top.blobs.pop(),this.state.tmp.name_node.children=[],this.state.tmp.offset_characters=i,this.state.tmp.term_predecessor=!1),this.state.tmp.have_collapsed=!1,this.state[this.state.tmp.area].opt.cite_group_delimiter&&this.state[this.state.tmp.area].opt.cite_group_delimiter&&(this.state.tmp.use_cite_group_delimiter=!1))))},s.NameOutput.prototype.isPerson=function(t){return t.literal||!t.given&&t.family&&t.isInstitution?!1:!0},s.NameOutput.prototype.truncatePersonalNameLists=function(){var t,e,i,n,s,r,o;this.freeters_count={},this.persons_count={},this.institutions_count={};for(t in this.freeters)this.freeters.hasOwnProperty(t)&&(this.freeters_count[t]=this.freeters[t].length,this.freeters[t]=this._truncateNameList(this.freeters,t));for(t in this.persons)if(this.persons.hasOwnProperty(t))for(this.institutions_count[t]=this.institutions[t].length,this._truncateNameList(this.institutions,t),this.persons[t]=this.persons[t].slice(0,this.institutions[t].length),this.persons_count[t]=[],n=0,s=this.persons[t].length;s>n;n+=1)this.persons_count[t][n]=this.persons[t][n].length,this.persons[t][n]=this._truncateNameList(this.persons,t,n);if(r=1!==this.etal_min||1!==this.etal_use_first||this.state.tmp.extension||this.state.tmp.just_looking?!1:t,r||this._please_chop)for(e=0,i=this.variables.length;i>e;e+=1){for(t=this.variables[e],this.freeters[t].length&&(this._please_chop===t?(this.freeters[t]=this.freeters[t].slice(1),this.freeters_count[t]+=-1,this._please_chop=!1):r&&!this._please_chop&&(this.freeters[t]=this.freeters[t].slice(0,1),this.freeters_count[t]=1,this.institutions[t]=[],this.persons[t]=[],this._please_chop=r)),e=0,i=this.persons[t].length;i>e;e+=1)if(this.persons[t][e].length){if(this._please_chop===t){this.persons[t][e]=this.persons[t][e].slice(1),this.persons_count[t][e]+=-1,this._please_chop=!1;break}if(r&&!this._please_chop){this.freeters[t]=this.persons[t][e].slice(0,1),this.freeters_count[t]=1,this.institutions[t]=[],this.persons[t]=[],o=[],this._please_chop=r;break}}this.institutions[t].length&&(this._please_chop===t?(this.institutions[t]=this.institutions[t].slice(1),this.institutions_count[t]+=-1,this._please_chop=!1):r&&!this._please_chop&&(this.institutions[t]=this.institutions[t].slice(0,1),this.institutions_count[t]=1,o=[],this._please_chop=r))}for(e=0,i=this.variables.length;i>e;e+=1)for(this.institutions[t].length&&(this.nameset_offset+=1),e=0,i=this.persons[t].length;i>e;e+=1)this.persons[t][e].length&&(this.nameset_offset+=1)},s.NameOutput.prototype._truncateNameList=function(t,e,i){var n;return n="undefined"==typeof i?t[e]:t[e][i],this.state[this.state[this.state.tmp.area].root].opt.max_number_of_names&&n.length>50&&n.length>this.state[this.state[this.state.tmp.area].root].opt.max_number_of_names+2&&(n=n.slice(0,this.state[this.state[this.state.tmp.area].root].opt.max_number_of_names+2)),n},s.NameOutput.prototype.divideAndTransliterateNames=function(){var t,e,i,n,s=this.Item,r=this.variables;for(this.varnames=r.slice(),this.freeters={},this.persons={},this.institutions={},t=0,e=r.length;e>t;t+=1){var o=r[t];this.variable_offset[o]=this.nameset_offset;var a=this._normalizeVariableValue(s,o);if(this.name.strings["suppress-min"]&&a.length>=this.name.strings["suppress-min"]&&(a=[]),this.name.strings["suppress-max"]&&a.length<=this.name.strings["suppress-max"]&&(a=[]),this._getFreeters(o,a),this._getPersonsAndInstitutions(o,a),0===this.name.strings["suppress-min"])for(this.freeters[o]=[],i=0,n=this.persons[o].length;n>i;i+=1)this.persons[o][i]=[];else if(0===this.institution.strings["suppress-min"]){for(this.institutions[o]=[],this.freeters[o]=this.freeters[o].concat(this.persons[o]),i=0,n=this.persons[o].length;n>i;i+=1)for(var l=0,u=this.persons[o][i].length;u>l;l+=1)this.freeters[o].push(this.persons[o][i][l]);this.persons[o]=[]}}},s.NameOutput.prototype._normalizeVariableValue=function(t,e){var i;return i="string"==typeof t[e]?[{literal:t[e]}]:t[e]?t[e].slice():[]},s.NameOutput.prototype._getFreeters=function(t,e){this.freeters[t]=[];for(var i=e.length-1;i>-1&&this.isPerson(e[i]);i+=-1){var n=this._checkNickname(e.pop());n&&this.freeters[t].push(n)}this.freeters[t].reverse(),this.freeters[t].length&&(this.nameset_offset+=1)},s.NameOutput.prototype._getPersonsAndInstitutions=function(t,e){this.persons[t]=[],this.institutions[t]=[];for(var i=[],n=!1,s=!0,r=e.length-1;r>-1;r+=-1)if(this.isPerson(e[r])){var o=this._checkNickname(e[r]);o&&i.push(o)}else n=!0,this.institutions[t].push(e[r]),s||(i.reverse(),this.persons[t].push(i),i=[]),s=!1;n&&(i.reverse(),this.persons[t].push(i),this.persons[t].reverse(),this.institutions[t].reverse())},s.NameOutput.prototype._clearValues=function(t){for(var e=t.length-1;e>-1;e+=-1)t.pop()},s.NameOutput.prototype._checkNickname=function(t){if(["interview","personal_communication"].indexOf(this.Item.type)>-1){var e="";if(e=s.Util.Names.getRawName(t),e&&this.state.sys.getAbbreviation&&(!this.item||!this.item["suppress-author"])){this.state.transform.loadAbbreviation("default","nickname",e);var i=this.state.transform.abbrevs["default"].nickname[e];i&&(t="!here>>>"===i?!1:{family:i,given:""})}}return t},s.NameOutput.prototype.joinPersons=function(t,e,i){var n;return n="undefined"==typeof i?1===this.etal_spec[e].freeters?this._joinEtAl(t,"name"):2===this.etal_spec[e].freeters?this._joinEllipsis(t,"name"):this.state.tmp.sort_key_flag?this._join(t," "):this._joinAnd(t,"name"):1===this.etal_spec[e].persons[i]?this._joinEtAl(t,"name"):2===this.etal_spec[e].persons[i]?this._joinEllipsis(t,"name"):this.state.tmp.sort_key_flag?this._join(t," "):this._joinAnd(t,"name")},s.NameOutput.prototype.joinInstitutionSets=function(t,e){var i;return i=1===this.etal_spec[e].institutions?this._joinEtAl(t,"institution"):2===this.etal_spec[e].institutions?this._joinEllipsis(t,"institution"):this._joinAnd(t,"institution")},s.NameOutput.prototype.joinPersonsAndInstitutions=function(t){return this._join(t,this.name.strings.delimiter)},s.NameOutput.prototype.joinFreetersAndInstitutionSets=function(t){var e=this._join(t,"[never here]",this["with"].single,this["with"].multiple);return e},s.NameOutput.prototype._joinEtAl=function(t,e){var i=this._join(t,this.name.strings.delimiter);return this.state.output.openLevel(this._getToken(e)),this.state.output.current.value().strings.delimiter="",this.state.output.append(i,"literal",!0),t.length>1?this.state.output.append(this["et-al"].multiple,"literal",!0):1===t.length&&this.state.output.append(this["et-al"].single,"literal",!0),this.state.output.closeLevel(),this.state.output.pop()},s.NameOutput.prototype._joinEllipsis=function(t,e){return this._join(t,this.name.strings.delimiter,this.name.ellipsis.single,this.name.ellipsis.multiple,e)},s.NameOutput.prototype._joinAnd=function(t,e){return this._join(t,this[e].strings.delimiter,this[e].and.single,this[e].and.multiple,e)},s.NameOutput.prototype._join=function(t,e,i,n,r){var o,a;if(!t)return!1;for(o=t.length-1;o>-1;o+=-1)t[o]&&0!==t[o].length&&t[o].blobs.length||(t=t.slice(0,o).concat(t.slice(o+1)));if(!t.length)return!1;if(i&&2===t.length)i&&(i=new s.Blob(i.blobs,i)),t=[t[0],i,t[1]];else{var l;for(l=n?2:1,o=0,a=t.length-l;a>o;o+=1)t[o].strings.suffix+=e;if(t.length>1){var u=t.pop();n?(n=new s.Blob(n.blobs,n),t.push(n)):(i&&(i=new s.Blob(i.blobs,i)),t.push(i)),t.push(u)}}for(this.state.output.openLevel(this._getToken(r)),i&&n&&(this.state.output.current.value().strings.delimiter=""),o=0,a=t.length;a>o;o+=1)this.state.output.append(t[o],!1,!0);return this.state.output.closeLevel(),this.state.output.pop()},s.NameOutput.prototype._getToken=function(t){var e=this[t];if("institution"===t){var i=new s.Token;return i}return e},s.NameOutput.prototype.setCommonTerm=function(){var t=this.variables,e=t.slice();if(e.sort(),this.common_term=e.join(""),!this.common_term)return!1;var i=!1;if(this.label&&this.label[this.variables[0]]&&(this.label[this.variables[0]].before?i=this.state.getTerm(this.common_term,this.label[this.variables[0]].before.strings.form,0):this.label[this.variables[0]].after&&(i=this.state.getTerm(this.common_term,this.label[this.variables[0]].after.strings.form,0))),!this.state.locale[this.state.opt.lang].terms[this.common_term]||!i||this.variables.length<2)return void(this.common_term=!1);for(var n=0,s=0,r=this.variables.length-1;r>s;s+=1){var o=this.variables[s],a=this.variables[s+1];if(this.freeters[o].length||this.freeters[a].length){if(this.etal_spec[o].freeters!==this.etal_spec[a].freeters||!this._compareNamesets(this.freeters[o],this.freeters[a]))return void(this.common_term=!1);n+=1}if(this.persons[o].length!==this.persons[a].length)return void(this.common_term=!1);for(var l=0,u=this.persons[o].length;u>l;l+=1)if(this.etal_spec[o].persons[l]!==this.etal_spec[a].persons[l]||!this._compareNamesets(this.persons[o][l],this.persons[a][l]))return void(this.common_term=!1)}},s.NameOutput.prototype._compareNamesets=function(t,e){if(t.length!==e.length)return!1;for(var i=0,n=e.length;n>i;i+=1)for(var r=(e[i],0),o=s.NAME_PARTS.length;o>r;r+=1){var a=s.NAME_PARTS[r];if(!t[i]||t[i][a]!=e[i][a])return!1}return!0},s.NameOutput.prototype.constrainNames=function(){this.names_count=0;for(var t,e=0,i=this.variables.length;i>e;e+=1){var n=this.variables[e];t=this.nameset_base+e,this.freeters[n].length&&(this.state.tmp.names_max.push(this.freeters[n].length,"literal"),this._imposeNameConstraints(this.freeters,this.freeters_count,n,t),this.names_count+=this.freeters[n].length),this.institutions[n].length&&(this.state.tmp.names_max.push(this.institutions[n].length,"literal"),this._imposeNameConstraints(this.institutions,this.institutions_count,n,t),this.persons[n]=this.persons[n].slice(0,this.institutions[n].length),this.names_count+=this.institutions[n].length);for(var s=0,r=this.persons[n].length;r>s;s+=1)this.persons[n][s].length&&(this.state.tmp.names_max.push(this.persons[n][s].length,"literal"),this._imposeNameConstraints(this.persons[n],this.persons_count[n],s,t),this.names_count+=this.persons[n][s].length)}},s.NameOutput.prototype._imposeNameConstraints=function(t,e,i,n){var s=t[i],r=this.state.tmp["et-al-min"];this.state.tmp.suppress_decorations?this.state.tmp.disambig_request&&this.state.tmp.disambig_request.names[n]?r=this.state.tmp.disambig_request.names[n]:e[i]>=this.etal_min&&(r=this.etal_use_first):(this.state.tmp.disambig_request&&this.state.tmp.disambig_request.names[n]>this.etal_use_first?r=e[i]<this.etal_min?e[i]:this.state.tmp.disambig_request.names[n]:e[i]>=this.etal_min&&(r=this.etal_use_first),this.etal_use_last&&r>this.etal_min-2&&(r=this.etal_min-2));var o=this.etal_min>=this.etal_use_first,a=e[i]>r;r>e[i]&&(r=s.length),o&&a&&(this.etal_use_last?t[i]=s.slice(0,r).concat(s.slice(-1)):t[i]=s.slice(0,r)),this.state.tmp.disambig_settings.names[n]=t[i].length,this.state.disambiguate.padBase(this.state.tmp.disambig_settings)},s.NameOutput.prototype.disambigNames=function(){for(var t,e=0,i=this.variables.length;i>e;e+=1){var n=this.variables[e];if(t=this.nameset_base+e,this.freeters[n].length&&this._runDisambigNames(this.freeters[n],t),this.institutions[n].length){"undefined"==typeof this.state.tmp.disambig_settings.givens[t]&&(this.state.tmp.disambig_settings.givens[t]=[]);for(var s=0,r=this.institutions[n].length;r>s;s+=1)"undefined"==typeof this.state.tmp.disambig_settings.givens[t][s]&&this.state.tmp.disambig_settings.givens[t].push(2)}for(var s=0,r=this.persons[n].length;r>s;s+=1)this.persons[n][s].length&&this._runDisambigNames(this.persons[n][s],t)}},s.NameOutput.prototype._runDisambigNames=function(t,e){var i,n,r,o,a,l,u;for(a=0,l=t.length;l>a;a+=1)if(t[a].given||t[a].family){if(r=this.name.strings["initialize-with"],this.state.registry.namereg.addname(""+this.Item.id,t[a],a),i=this.state.tmp.disambig_settings.givens[e],"undefined"==typeof i)for(var c=0,h=e+1;h>c;c+=1)this.state.tmp.disambig_settings.givens[c]||(this.state.tmp.disambig_settings.givens[c]=[]);if(i=this.state.tmp.disambig_settings.givens[e][a],"undefined"==typeof i&&(n=this.name.strings.form,o=this.state.registry.namereg.evalname(""+this.Item.id,t[a],a,0,n,r),this.state.tmp.disambig_settings.givens[e].push(o)),n=this.name.strings.form,u=this.state.registry.namereg.evalname(""+this.Item.id,t[a],a,0,n,r),this.state.tmp.disambig_request){var p=this.state.tmp.disambig_settings.givens[e][a];1!==p||"by-cite"!==this.state.citation.opt["givenname-disambiguation-rule"]||"undefined"!=typeof this.name.strings["initialize-with"]&&"undefined"!=typeof t[a].given||(p=2),o=p,this.state.opt["disambiguate-add-givenname"]&&t[a].given&&(o=this.state.registry.namereg.evalname(""+this.Item.id,t[a],a,o,this.name.strings.form,this.name.strings["initialize-with"]))}else o=u;!this.state.tmp.just_looking&&this.item&&this.item.position===s.POSITION_FIRST&&u>o&&(o=u),this.state.tmp.sort_key_flag||(this.state.tmp.disambig_settings.givens[e][a]=o,"string"!=typeof r||"undefined"!=typeof this.name.strings.initialize&&!0!==this.name.strings.initialize||(this.state.tmp.disambig_settings.use_initials=!0))}},s.NameOutput.prototype.getEtAlConfig=function(){var t=this.item;this["et-al"]={},this.state.output.append(this.etal_term,this.etal_style,!0),this["et-al"].single=this.state.output.pop(),this["et-al"].single.strings.suffix=this.etal_suffix,this["et-al"].single.strings.prefix=this.etal_prefix_single,this.state.output.append(this.etal_term,this.etal_style,!0),this["et-al"].multiple=this.state.output.pop(),this["et-al"].multiple.strings.suffix=this.etal_suffix,this["et-al"].multiple.strings.prefix=this.etal_prefix_multiple,"undefined"==typeof t&&(t={}),t.position?(this.name.strings["et-al-subsequent-min"]?this.etal_min=this.name.strings["et-al-subsequent-min"]:this.etal_min=this.name.strings["et-al-min"],this.name.strings["et-al-subsequent-use-first"]?this.etal_use_first=this.name.strings["et-al-subsequent-use-first"]:this.etal_use_first=this.name.strings["et-al-use-first"]):(this.state.tmp["et-al-min"]?this.etal_min=this.state.tmp["et-al-min"]:this.etal_min=this.name.strings["et-al-min"],this.state.tmp["et-al-use-first"]?this.etal_use_first=this.state.tmp["et-al-use-first"]:this.etal_use_first=this.name.strings["et-al-use-first"],"boolean"==typeof this.state.tmp["et-al-use-last"]?this.etal_use_last=this.state.tmp["et-al-use-last"]:this.etal_use_last=this.name.strings["et-al-use-last"]),this.state.tmp["et-al-min"]||(this.state.tmp["et-al-min"]=this.etal_min)},s.NameOutput.prototype.setEtAlParameters=function(){var t,e,i,n;for(t=0,e=this.variables.length;e>t;t+=1){var s=this.variables[t];for("undefined"==typeof this.etal_spec[s]&&(this.etal_spec[s]={freeters:0,institutions:0,persons:[]}),this.etal_spec[this.nameset_base+t]=this.etal_spec[s],this.freeters[s].length&&this._setEtAlParameter("freeters",s),i=0,n=this.persons[s].length;n>i;i+=1)"undefined"==typeof this.etal_spec[s][i]&&(this.etal_spec[s].persons[i]=0),this._setEtAlParameter("persons",s,i);this.institutions[s].length&&this._setEtAlParameter("institutions",s)}},s.NameOutput.prototype._setEtAlParameter=function(t,e,i){var n,s;"persons"===t?(n=this.persons[e][i],s=this.persons_count[e][i]):(n=this[t][e],s=this[t+"_count"][e]),n.length<s&&!this.state.tmp.sort_key_flag?this.etal_use_last?"persons"===t?this.etal_spec[e].persons[i]=2:this.etal_spec[e][t]=2:"persons"===t?this.etal_spec[e].persons[i]=1:this.etal_spec[e][t]=1:"persons"===t?this.etal_spec[e].persons[i]=0:this.etal_spec[e][t]=0},s.NameOutput.prototype.renderAllNames=function(){for(var t,e=0,i=this.variables.length;i>e;e+=1){var n=this.variables[e];t=this.nameset_base+e,this.freeters[n].length&&(this.freeters[n]=this._renderPersonalNames(this.freeters[n],t));for(var s=0,r=this.institutions[n].length;r>s;s+=1)this.persons[n][s]=this._renderPersonalNames(this.persons[n][s],t,s)}this.renderInstitutionNames()},s.NameOutput.prototype.renderInstitutionNames=function(){for(var t=0,e=this.variables.length;e>t;t+=1)for(var i=this.variables[t],n=0,s=this.institutions[i].length;s>n;n+=1){var r,o,a,l,u,n,s,c,h=this.institutions[i][n];if(c=this.state.tmp.extension?["sort"]:h.isInstitution?this.state.opt["cite-lang-prefs"].institutions:this.state.opt["cite-lang-prefs"].persons,slot={primary:"locale-orig",secondary:!1,tertiary:!1},c)for(var p=["primary","secondary","tertiary"],d=0,f=p.length;f>d&&!(c.length-1<d);d+=1)c[d]&&(slot[p[d]]="locale-"+c[d]);else slot.primary="locale-translat";"bibliography"===this.state.tmp.area||"citation"===this.state.tmp.area&&"note"===this.state.opt.xclass&&this.item&&!this.item.position||(slot.secondary=!1,slot.tertiary=!1);var m;this.setRenderedName(h),m=this.getName(h,slot.primary,!0);var g=m.name,b=m.usedOrig;switch(g&&(g=this.fixupInstitution(g,i,n)),secondary=!1,slot.secondary&&(m=this.getName(h,slot.secondary,!1,b),secondary=m.name,b=m.usedOrig,secondary&&(secondary=this.fixupInstitution(secondary,i,n))),tertiary=!1,slot.tertiary&&(m=this.getName(h,slot.tertiary,!1,b),tertiary=m.name,tertiary&&(tertiary=this.fixupInstitution(tertiary,i,n))),this.institution.strings["institution-parts"]){case"short":g["short"].length?(l=this._getShortStyle(),r=[this._renderOneInstitutionPart(g["short"],l)]):(u=this._getLongStyle(g,i,n),r=[this._renderOneInstitutionPart(g["long"],u)]);break;case"short-long":u=this._getLongStyle(g,i,n),l=this._getShortStyle(),o=this._renderOneInstitutionPart(g["short"],l),a=this._composeOneInstitutionPart([g,secondary,tertiary],slot,u),r=[o,a];break;case"long-short":u=this._getLongStyle(g,i,n),l=this._getShortStyle(),o=this._renderOneInstitutionPart(g["short"],l),a=this._composeOneInstitutionPart([g,secondary,tertiary],slot,u,!0),r=[a,o];break;default:u=this._getLongStyle(g,i,n),r=[this._composeOneInstitutionPart([g,secondary,tertiary],slot,u)]}this.institutions[i][n]=this._join(r,"")}},s.NameOutput.prototype._composeOneInstitutionPart=function(t,e,i){var n=!1,r=!1,o=!1;t[0]&&(n=this._renderOneInstitutionPart(t[0]["long"],i)),t[1]&&(r=this._renderOneInstitutionPart(t[1]["long"],i)),t[2]&&(o=this._renderOneInstitutionPart(t[2]["long"],i));var a;return r||o?(this.state.output.openLevel("empty"),this.state.output.append(n),secondary_tok=s.Util.cloneToken(i),e.secondary&&(secondary_tok.strings.prefix=this.state.opt.citeAffixes.institutions[e.secondary].prefix,secondary_tok.strings.suffix=this.state.opt.citeAffixes.institutions[e.secondary].suffix,secondary_tok.strings.prefix||(secondary_tok.strings.prefix=" ")),this.state.output.append(r,secondary_tok),tertiary_tok=s.Util.cloneToken(i),e.tertiary&&(tertiary_tok.strings.prefix=this.state.opt.citeAffixes.institutions[e.tertiary].prefix,tertiary_tok.strings.suffix=this.state.opt.citeAffixes.institutions[e.tertiary].suffix,tertiary_tok.strings.prefix||(tertiary_tok.strings.prefix=" ")),this.state.output.append(o,tertiary_tok),this.state.output.closeLevel(),a=this.state.output.pop()):a=n,a},s.NameOutput.prototype._renderOneInstitutionPart=function(t,e){for(var i=0,n=t.length;n>i;i+=1)if(t[i]){var r=t[i];if(this.state.tmp.strip_periods)r=r.replace(/\./g,"");else for(var o=0,a=e.decorations.length;a>o;o+=1)if("@strip-periods"===e.decorations[o][0]&&"true"===e.decorations[o][1]){r=r.replace(/\./g,"");break}this.state.tmp.group_context.value()[2]=!0,this.state.tmp.can_substitute.replace(!1,s.LITERAL),"!here>>>"===r?t[i]=!1:(this.state.output.append(r,e,!0),t[i]=this.state.output.pop())}return"undefined"==typeof this.institution.strings["part-separator"]&&(this.institution.strings["part-separator"]=this.name.strings.delimiter),this._join(t,this.institution.strings["part-separator"])},s.NameOutput.prototype._renderPersonalNames=function(t,e,i){var n=!1;if(t.length){for(var r=[],o=0,a=t.length;a>o;o+=1){var n,l,u=t[o];if(l=this.state.tmp.extension?["sort"]:u.isInstitution?this.state.opt["cite-lang-prefs"].institutions:this.state.opt["cite-lang-prefs"].persons,slot={primary:"locale-orig",secondary:!1,tertiary:!1},l)for(var c=["primary","secondary","tertiary"],h=0,p=c.length;p>h&&!(l.length-1<h);h+=1)slot[c[h]]="locale-"+l[h];else slot.primary="locale-translat";(this.state.tmp.sort_key_flag||"bibliography"!==this.state.tmp.area&&("citation"!==this.state.tmp.area||"note"!==this.state.opt.xclass||!this.item||this.item.position))&&(slot.secondary=!1,slot.tertiary=!1),this.setRenderedName(u);var d=this.getName(u,slot.primary,!0),f=this._renderOnePersonalName(d.name,e,o,i);secondary=!1,slot.secondary&&(d=this.getName(u,slot.secondary,!1,d.usedOrig),d.name&&(secondary=this._renderOnePersonalName(d.name,e,o,i))),tertiary=!1,slot.tertiary&&(d=this.getName(u,slot.tertiary,!1,d.usedOrig),d.name&&(tertiary=this._renderOnePersonalName(d.name,e,o,i)));var m;secondary||tertiary?(this.state.output.openLevel("empty"),this.state.output.append(f),secondary_tok=new s.Token,slot.secondary&&(secondary_tok.strings.prefix=this.state.opt.citeAffixes.persons[slot.secondary].prefix,secondary_tok.strings.suffix=this.state.opt.citeAffixes.persons[slot.secondary].suffix,secondary_tok.strings.prefix||(secondary_tok.strings.prefix=" ")),this.state.output.append(secondary,secondary_tok),tertiary_tok=new s.Token,slot.tertiary&&(tertiary_tok.strings.prefix=this.state.opt.citeAffixes.persons[slot.tertiary].prefix,tertiary_tok.strings.suffix=this.state.opt.citeAffixes.persons[slot.tertiary].suffix,tertiary_tok.strings.prefix||(tertiary_tok.strings.prefix=" ")),this.state.output.append(tertiary,tertiary_tok),this.state.output.closeLevel(),m=this.state.output.pop()):m=f,r.push(m)}n=this.joinPersons(r,e,i)}return n},s.NameOutput.prototype._isRomanesque=function(t){var e=2;if(t.family.replace('"',"","g").match(s.ROMANESQUE_REGEXP)||(e=0),!e&&t.given&&t.given.match(s.STARTSWITH_ROMANESQUE_REGEXP)&&(e=1),2==e){if(t.multi&&t.multi.main)var i=t.multi.main.slice(0,2);else this.Item.language&&(i=this.Item.language.slice(0,2));["ja","zh"].indexOf(i)>-1&&(e=1)}return e},s.NameOutput.prototype._renderOnePersonalName=function(t,e,i,n){var r=t,o=this._droppingParticle(r,e,n),a=this._familyName(r),l=this._nonDroppingParticle(r),u=this._givenName(r,e,i),c=this._nameSuffix(r);this._isShort(e,i)&&!r["full-form-always"]&&(o=!1,u=!1,c=!1);var h=this.name.strings["sort-separator"];h||(h="");var p;p=r["comma-suffix"]?", ":" ";var d,f,m,g,b=this._isRomanesque(r),y=l&&"-"===l.blobs.slice(-1);return 0===b?d=this._join([l,a,u],""):1===b||r["static-ordering"]?d=this._join([l,a,u]," "):r["reverse-ordering"]?d=this._join([u,l,a]," "):this.state.tmp.sort_key_flag?"never"===this.state.opt["demote-non-dropping-particle"]?(m=this._join([l,a,o]," "),f=this._join([m,u]," "),d=this._join([f,c]," ")):(g=this._join([u,o,l]," "),f=this._join([a,g]," "),d=this._join([f,c]," ")):"all"===this.name.strings["name-as-sort-order"]||"first"===this.name.strings["name-as-sort-order"]&&0===i&&(0===n||"undefined"==typeof n)?(["Lord","Lady"].indexOf(r.given)>-1&&(h=", "),["always","display-and-sort"].indexOf(this.state.opt["demote-non-dropping-particle"])>-1&&!y?(g=this._join([u,o],r["comma-dropping-particle"]+" "),g=this._join([g,l]," "),g&&this.given&&(g.strings.prefix=this.given.strings.prefix,g.strings.suffix=this.given.strings.suffix),a&&this.family&&(a.strings.prefix=this.family.strings.prefix,a.strings.suffix=this.family.strings.suffix),f=this._join([a,g],h),d=this._join([f,c],h)):("bibliography"===this.state.tmp.area&&!this.state.tmp.term_predecessor&&l&&(y||(l.blobs=s.Output.Formatters["capitalize-first"](this.state,l.blobs))),m=y?this._join([l,a],""):this._join([l,a]," "),m&&this.family&&(m.strings.prefix=this.family.strings.prefix,m.strings.suffix=this.family.strings.suffix),g=this._join([u,o],r["comma-dropping-particle"]+" "),g&&this.given&&(g.strings.prefix=this.given.strings.prefix,g.strings.suffix=this.given.strings.suffix),f=this._join([m,g],h),d=this._join([f,c],h))):(r["dropping-particle"]&&r.family&&!r["non-dropping-particle"]&&["'","ʼ","’"].indexOf(r["dropping-particle"].slice(-1))>-1&&(a=this._join([o,a],""),o=!1),this.state.tmp.term_predecessor||u||"bibliography"!==this.state.tmp.area||(!o&&l?y||(l.blobs=s.Output.Formatters["capitalize-first"](this.state,l.blobs)):o&&(o.blobs=s.Output.Formatters["capitalize-first"](this.state,o.blobs))),y?(g=this._join([l,a],""),g=this._join([o,g]," ")):g=this._join([o,l,a]," "),g=this._join([g,c],p),g&&this.family&&(g.strings.prefix=this.family.strings.prefix,g.strings.suffix=this.family.strings.suffix),u&&this.given&&(u.strings.prefix=this.given.strings.prefix,u.strings.suffix=this.given.strings.suffix),g.strings.prefix&&(r["comma-dropping-particle"]=""),d=this._join([u,g],r["comma-dropping-particle"]+" ")),this.state.tmp.group_context.value()[2]=!0,this.state.tmp.can_substitute.replace(!1,s.LITERAL),this.state.tmp.term_predecessor=!0,this.state.tmp.name_node.children.push(d),d},s.NameOutput.prototype._isShort=function(t,e){return 0===this.state.tmp.disambig_settings.givens[t][e]?!0:!1},s.NameOutput.prototype._normalizeNameInput=function(t){var e={literal:t.literal,family:t.family,isInstitution:t.isInstitution,given:t.given,suffix:t.suffix,"comma-suffix":t["comma-suffix"],"non-dropping-particle":t["non-dropping-particle"],"dropping-particle":t["dropping-particle"],"static-ordering":t["static-ordering"],"reverse-ordering":t["reverse-ordering"],"full-form-always":t["full-form-always"],"parse-names":t["parse-names"],"comma-dropping-particle":"",block_initialize:t.block_initialize,multi:t.multi};return this._parseName(e),e},s.NameOutput.prototype._stripPeriods=function(t,e){var i=this[t+"_decor"];if(e)if(this.state.tmp.strip_periods)e=e.replace(/\./g,"");else if(i)for(var n=0,s=i.decorations.length;s>n;n+=1)if("@strip-periods"===i.decorations[n][0]&&"true"===i.decorations[n][1]){e=e.replace(/\./g,"");break}return e},s.NameOutput.prototype._nonDroppingParticle=function(t){var e=t["non-dropping-particle"];e&&this.state.tmp.sort_key_flag&&(e=e.replace(/[\'\u2019]/,""));var i=this._stripPeriods("family",e);return this.state.output.append(i,this.family_decor,!0)?this.state.output.pop():!1},s.NameOutput.prototype._droppingParticle=function(t,e,i){var n=t["dropping-particle"];n&&this.state.tmp.sort_key_flag&&(n=n.replace(/[\'\u2019]/,""));var s=this._stripPeriods("given",n);if(t["dropping-particle"]&&t["dropping-particle"].match(/^et.?al[^a-z]$/))this.name.strings["et-al-use-last"]?"undefined"==typeof i?this.etal_spec[e].freeters=2:this.etal_spec[e].persons=2:"undefined"==typeof i?this.etal_spec[e].freeters=1:this.etal_spec[e].persons=1,t["comma-dropping-particle"]="";else if(this.state.output.append(s,this.given_decor,!0))return this.state.output.pop();return!1},s.NameOutput.prototype._familyName=function(t){var e=this._stripPeriods("family",t.family);return this.state.output.append(e,this.family_decor,!0)?this.state.output.pop():!1},s.NameOutput.prototype._givenName=function(t,e,i){if(this.name.strings.initialize===!1)t.family&&t.given&&this.name.strings.initialize===!1&&(t.given=s.Util.Names.initializeWith(this.state,t.given,this.name.strings["initialize-with"],!0)),t.given=s.Util.Names.unInitialize(this.state,t.given);else if(t.family&&1===this.state.tmp.disambig_settings.givens[e][i]&&!t.block_initialize){var n=this.name.strings["initialize-with"];t.given=s.Util.Names.initializeWith(this.state,t.given,n)}else t.given=s.Util.Names.unInitialize(this.state,t.given);var r=this._stripPeriods("given",t.given);return this.state.output.append(r,this.given_decor,!0)?this.state.output.pop():!1},s.NameOutput.prototype._nameSuffix=function(t){var e=t.suffix;return"string"==typeof this.name.strings["initialize-with"]&&(e=s.Util.Names.initializeWith(this.state,t.suffix,this.name.strings["initialize-with"],!0)),e=this._stripPeriods("family",e),this.state.output.append(e,"empty",!0)?this.state.output.pop():!1},s.NameOutput.prototype._getLongStyle=function(t,e,i){var n;return n=t["short"].length&&this.institutionpart["long-with-short"]?this.institutionpart["long-with-short"]:this.institutionpart["long"],n||(n=new s.Token),n},s.NameOutput.prototype._getShortStyle=function(){var t;return t=this.institutionpart["short"]?this.institutionpart["short"]:new s.Token},s.NameOutput.prototype._parseName=function(t){var e,i;if(!t["parse-names"]&&"undefined"!=typeof t["parse-names"])return t;t.family&&!t.given&&t.isInstitution&&(t.literal=t.family,t.family=void 0,t.isInstitution=void 0);var n;if(t.family&&'"'===t.family.slice(0,1)&&'"'===t.family.slice(-1)||!t["parse-names"]&&"undefined"!=typeof t["parse-names"]?(t.family=t.family.slice(1,-1),
n=!0,t["parse-names"]=0):n=!1,!t["non-dropping-particle"]&&t.family&&!n&&t.given&&(e=t.family.match(/^((?:[\'\u2019a-z][ \'\u2019a-z]*[-\s\'\u2019]+|[ABDVL][^ ][-\s]+[a-z]*\s*|[ABDVL][^ ][^ ][-\s]+[a-z]*\s*))/),e&&(t.family=t.family.slice(e[1].length),t["non-dropping-particle"]=e[1].replace(/\s+$/,"").replace("'","’"))),!t.suffix&&t.given&&(e=t.given.match(/(\s*,!*\s*)/))){i=t.given.indexOf(e[1]);var s=t.given.slice(i+e[1].length),r=t.given.slice(i,i+e[1].length).replace(/\s*/g,"");s.length<=3?(2===r.length&&(t["comma-suffix"]=!0),t.suffix=s):!t["dropping-particle"]&&t.given&&(t["dropping-particle"]=s,t["comma-dropping-particle"]=","),t.given=t.given.slice(0,i)}!t["dropping-particle"]&&t.given&&(e=t.given.match(/(\s+)([a-z][ \'\u2019a-z]*)$/),e&&(t.given=t.given.slice(0,-1*(e[1].length+e[2].length)),t["dropping-particle"]=e[2]))},s.NameOutput.prototype.getName=function(t,e,n,s){if(s&&"locale-orig"===e)return{name:!1,usedOrig:s};t.family||(t.family=""),t.given||(t.given="");var r={};r["static-ordering"]=this.getStaticOrder(t);var o=!0;if("locale-orig"!==e&&(o=!1,t.multi)){var a=this.state.opt[e];for(i=0,ilen=a.length;i<ilen;i+=1)if(l=a[i],t.multi._key[l]){o=!0,t=t.multi._key[l],r=this.getNameParams(l),r.transliterated=!0;break}}if(!o){var l=!1;t.multi&&t.multi.main?l=t.multi.main:this.Item.language&&(l=this.Item.language),l&&(r=this.getNameParams(l))}if(!n&&!o)return{name:!1,usedOrig:s};t.family||(t.family=""),t.given||(t.given=""),t={family:t.family,given:t.given,"non-dropping-particle":t["non-dropping-particle"],"dropping-particle":t["dropping-particle"],suffix:t.suffix,"static-ordering":r["static-ordering"],"reverse-ordering":r["reverse-ordering"],"full-form-always":r["full-form-always"],"parse-names":t["parse-names"],"comma-suffix":t["comma-suffix"],"comma-dropping-particle":t["comma-dropping-particle"],transliterated:r.transliterated,block_initialize:r["block-initialize"],literal:t.literal,isInstitution:t.isInstitution,multi:t.multi},!t.literal&&!t.given&&t.family&&t.isInstitution&&(t.literal=t.family),t.literal&&(delete t.family,delete t.given),t=this._normalizeNameInput(t);var u;return u=s?s:!o,{name:t,usedOrig:u}},s.NameOutput.prototype.getNameParams=function(t){var e={},i=s.localeResolve(this.Item.language,this.state.opt["default-locale"][0]),n=this.state.locale[i.best]?i.best:this.state.opt["default-locale"][0],r=this.state.locale[n].opts["name-as-sort-order"],o=this.state.locale[n].opts["name-as-reverse-order"],a=this.state.locale[n].opts["name-never-short"],l=t.split("-")[0];return r&&r[l]&&(e["static-ordering"]=!0,e["reverse-ordering"]=!1),o&&o[l]&&(e["reverse-ordering"]=!0,e["static-ordering"]=!1),a&&a[l]&&(e["full-form-always"]=!0),e["static-ordering"]&&(e["block-initialize"]=!0),e},s.NameOutput.prototype.setRenderedName=function(t){if("bibliography"===this.state.tmp.area){for(var e="",i=0,n=s.NAME_PARTS.length;n>i;i+=1)t[s.NAME_PARTS[i]]&&(e+=t[s.NAME_PARTS[i]]);this.state.tmp.rendered_name.push(e)}},s.NameOutput.prototype.fixupInstitution=function(t,e,i){t=this._splitInstitution(t,e,i),this.institution.strings["reverse-order"]&&t["long"].reverse();var n=t["long"],s=n.slice();if(this.state.sys.getAbbreviation)for(var r=this.Item.jurisdiction,o=0,a=n.length;a>o;o+=1)r=this.state.transform.loadAbbreviation(r,"institution-part",n[o]),this.state.transform.abbrevs[r]["institution-part"][n[o]]&&(s[o]=this.state.transform.abbrevs[r]["institution-part"][n[o]]);return t["short"]=s,t},s.NameOutput.prototype.getStaticOrder=function(t,e){var i=!1;return!e&&t["static-ordering"]?i=!0:0===this._isRomanesque(t)?i=!0:(!t.multi||!t.multi.main)&&this.Item.language&&["vi","hu"].indexOf(this.Item.language)>-1?i=!0:t.multi&&t.multi.main&&["vi","hu"].indexOf(t.multi.main.slice(0,2))>-1?i=!0:this.state.opt["auto-vietnamese-names"]&&s.VIETNAMESE_NAMES.exec(t.family+" "+t.given)&&s.VIETNAMESE_SPECIALS.exec(t.family+t.given)&&(i=!0),i},s.NameOutput.prototype._splitInstitution=function(t,e,i){var n={},s=t.literal.replace(/\s*\|\s*/g,"|");if(s=s.split("|"),"short"===this.institution.strings.form&&this.state.sys.getAbbreviation)for(var r=this.Item.jurisdiction,o=s.length;o>0;o+=-1){var a=s.slice(0,o).join("|");if(r=this.state.transform.loadAbbreviation(r,"institution-entire",a),this.state.transform.abbrevs[r]["institution-entire"][a]){var l=this.state.transform.abbrevs[r]["institution-entire"][a];l=this.state.transform.quashCheck(l);var u=l.split(/>>[0-9]{4}>>/),c=l.match(/>>([0-9]{4})>>/);if(l=u.pop(),u.length>0&&this.Item["original-date"]&&this.Item["original-date"].year)for(var h=c.length-1;h>0&&!(parseInt(this.Item["original-date"].year,10)>=parseInt(c[h],10));h+=-1)l=u.pop();l=l.replace(/\s*\|\s*/g,"|"),s=[l]}}return s.reverse(),n["long"]=this._trimInstitution(s,e,i),n},s.NameOutput.prototype._trimInstitution=function(t,e,i){var n=!1,s=!1,r=!1,o=t.slice();return this.institution&&("undefined"!=typeof this.institution.strings["use-first"]&&(n=this.institution.strings["use-first"]),"undefined"!=typeof this.institution.strings["stop-last"]&&(o=o.slice(0,this.institution.strings["stop-last"]),t=t.slice(0,this.institution.strings["stop-last"])),"undefined"!=typeof this.institution.strings["use-last"]&&(s=this.institution.strings["use-last"])),!1===n&&(0===this.persons[e].length&&(n=this.institution.strings["substitute-use-first"]),n||(n=0)),!1===s&&(s=n?0:t.length),n>t.length-s&&(n=t.length-s),r&&(s=0),t=t.slice(0,n),o=o.slice(n),s&&(s>o.length&&(s=o.length),s&&(t=t.concat(o.slice(o.length-s)))),t},s.PublisherOutput=function(t,e){this.state=t,this.group_tok=e,this.varlist=[]},s.PublisherOutput.prototype.render=function(){this.clearVars(),this.composeAndBlob(),this.composeElements(),this.composePublishers(),this.joinPublishers()},s.PublisherOutput.prototype.composeAndBlob=function(){this.and_blob={};var t=!1;"text"===this.group_tok.strings.and?t=this.state.getTerm("and"):"symbol"===this.group_tok.strings.and&&(t="&");var e=new s.Token;e.strings.suffix=" ",e.strings.prefix=" ",this.state.output.append(t,e,!0);var i=this.state.output.pop();e.strings.prefix=this.group_tok.strings["subgroup-delimiter"],this.state.output.append(t,e,!0);var n=this.state.output.pop();this.and_blob.single=!1,this.and_blob.multiple=!1,t&&("always"===this.group_tok.strings["subgroup-delimiter-precedes-last"]?this.and_blob.single=n:"never"===this.group_tok.strings["subgroup-delimiter-precedes-last"]?(this.and_blob.single=i,this.and_blob.multiple=i):(this.and_blob.single=i,this.and_blob.multiple=n))},s.PublisherOutput.prototype.composeElements=function(){for(var t=0,e=2;e>t;t+=1)for(var i=["publisher","publisher-place"][t],n=0,s=this["publisher-list"].length;s>n;n+=1){var r=this[i+"-list"][n],o=this[i+"-token"];this.state.output.append(r,o,!0),this[i+"-list"][n]=this.state.output.pop()}},s.PublisherOutput.prototype.composePublishers=function(){for(var t,e=0,i=this["publisher-list"].length;i>e;e+=1){t=[this[this.varlist[0]+"-list"][e],this[this.varlist[1]+"-list"][e]],this["publisher-list"][e]=this._join(t,this.group_tok.strings.delimiter)}},s.PublisherOutput.prototype.joinPublishers=function(){var t=this["publisher-list"],e=(this.name_delimiter,this._join(t,this.group_tok.strings["subgroup-delimiter"],this.and_blob.single,this.and_blob.multiple,this.group_tok));this.state.output.append(e,"literal")},s.PublisherOutput.prototype._join=s.NameOutput.prototype._join,s.PublisherOutput.prototype._getToken=s.NameOutput.prototype._getToken,s.PublisherOutput.prototype.clearVars=function(){this.state.tmp["publisher-list"]=!1,this.state.tmp["publisher-place-list"]=!1,this.state.tmp["publisher-group-token"]=!1,this.state.tmp["publisher-token"]=!1,this.state.tmp["publisher-place-token"]=!1},s.evaluateLabel=function(t,e,i,n){var r;"locator"===t.strings.term?(n&&n.label&&(r="sub verbo"===n.label?"sub-verbo":n.label),r||(r="page")):r=t.strings.term;var o=t.strings.plural;return n&&"number"==typeof n.force_pluralism?o=n.force_pluralism:"number"!=typeof o&&("locator"===t.strings.term?n&&n.locator&&(e.opt.development_extensions.locator_parsing_for_plurals?(e.tmp.shadow_numbers.locator||e.processNumber(!1,n,"locator",i.type),o=e.tmp.shadow_numbers.locator.plural):o=s.evaluateStringPluralism(n.locator)):["page","page-first"].indexOf(t.variables[0])>-1?(e.processNumber(!1,i,r,i.type),o=e.tmp.shadow_numbers[r].plural,r=e.tmp.shadow_numbers[r].label):(e.tmp.shadow_numbers[r]||e.processNumber(!1,i,r,i.type),o=e.tmp.shadow_numbers[r].plural),t.decorations&&(e.opt.development_extensions.csl_reverse_lookup_support||e.sys.csl_reverse_lookup_support)&&(t.decorations.reverse(),t.decorations.push(["@showid","true",t.cslid]),t.decorations.reverse())),s.castLabel(e,t,r,o,s.TOLERANT)},s.evaluateStringPluralism=function(t){if(t){var e=t.match(/(?:[0-9],\s*[0-9]|\s+and\s+|&|([0-9]+)\s*[\-\u2013]\s*([0-9]+))/);if(e&&(!e[1]||parseInt(e[1],10)<parseInt(e[2],10)))return 1}return 0},s.castLabel=function(t,e,i,n,s){var r=e.strings.form;t.tmp.group_context.value()[5]&&(r=t.tmp.group_context.value()[5]);var o=t.getTerm(i,r,n,!1,s);if(t.tmp.strip_periods)o=o.replace(/\./g,"");else for(var a=0,l=e.decorations.length;l>a;a+=1)if("@strip-periods"===e.decorations[a][0]&&"true"===e.decorations[a][1]){o=o.replace(/\./g,"");break}return o},s.Node.name={build:function(t,e){var i;[s.SINGLETON,s.START].indexOf(this.tokentype)>-1&&(t.fixOpt(this,"name-delimiter","name_delimiter"),t.fixOpt(this,"name-form","form"),t.fixOpt(this,"and","and"),t.fixOpt(this,"delimiter-precedes-last","delimiter-precedes-last"),t.fixOpt(this,"delimiter-precedes-et-al","delimiter-precedes-et-al"),t.fixOpt(this,"initialize-with","initialize-with"),t.fixOpt(this,"initialize","initialize"),t.fixOpt(this,"name-as-sort-order","name-as-sort-order"),t.fixOpt(this,"sort-separator","sort-separator"),t.fixOpt(this,"and","and"),t.fixOpt(this,"et-al-min","et-al-min"),t.fixOpt(this,"et-al-use-first","et-al-use-first"),t.fixOpt(this,"et-al-use-last","et-al-use-last"),t.fixOpt(this,"et-al-subsequent-min","et-al-subsequent-min"),t.fixOpt(this,"et-al-subsequent-use-first","et-al-subsequent-use-first"),this.strings["et-al-subsequent-min"]&&this.strings["et-al-subsequent-min"]!==this.strings["et-al-min"]&&(t.opt.update_mode=s.POSITION),this.strings["et-al-subsequent-use-first"]&&this.strings["et-al-subsequent-use-first"]!==this.strings["et-al-use-first"]&&(t.opt.update_mode=s.POSITION),"undefined"==typeof this.strings.name_delimiter?this.strings.delimiter=", ":this.strings.delimiter=this.strings.name_delimiter,this.strings["et-al-use-last"]&&(this.ellipsis_term="…",this.ellipsis_prefix_single=" ",this.ellipsis_prefix_multiple=this.strings.delimiter,this.ellipsis_suffix=" "),i=function(t,e){t.tmp.etal_term="et-al",t.tmp.name_delimiter=this.strings.delimiter,t.tmp["delimiter-precedes-et-al"]=this.strings["delimiter-precedes-et-al"],"text"===this.strings.and?this.and_term=t.getTerm("and","long",0):"symbol"===this.strings.and&&(t.opt.development_extensions.expect_and_symbol_form?this.and_term=t.getTerm("and","symbol",0):this.and_term="&"),t.tmp.and_term=this.and_term,s.STARTSWITH_ROMANESQUE_REGEXP.test(this.and_term)?(this.and_prefix_single=" ",this.and_prefix_multiple=", ","string"==typeof this.strings.delimiter&&(this.and_prefix_multiple=this.strings.delimiter),this.and_suffix=" ",t.build.name_delimiter=this.strings.delimiter):(this.and_prefix_single="",this.and_prefix_multiple="",this.and_suffix=""),"always"===this.strings["delimiter-precedes-last"]?this.and_prefix_single=this.strings.delimiter:"never"===this.strings["delimiter-precedes-last"]?this.and_prefix_multiple&&(this.and_prefix_multiple=" "):"after-inverted-name"===this.strings["delimiter-precedes-last"]&&(this.and_prefix_single&&(this.and_prefix_single=this.strings.delimiter),this.and_prefix_multiple&&(this.and_prefix_multiple=" ")),this.and={},this.strings.and?(t.output.append(this.and_term,"empty",!0),this.and.single=t.output.pop(),this.and.single.strings.prefix=this.and_prefix_single,this.and.single.strings.suffix=this.and_suffix,t.output.append(this.and_term,"empty",!0),this.and.multiple=t.output.pop(),this.and.multiple.strings.prefix=this.and_prefix_multiple,this.and.multiple.strings.suffix=this.and_suffix):this.strings.delimiter&&(this.and.single=new s.Blob(this.strings.delimiter),this.and.single.strings.prefix="",this.and.single.strings.suffix="",this.and.multiple=new s.Blob(this.strings.delimiter),this.and.multiple.strings.prefix="",this.and.multiple.strings.suffix=""),this.ellipsis={},this.strings["et-al-use-last"]&&(this.ellipsis.single=new s.Blob(this.ellipsis_term),this.ellipsis.single.strings.prefix=this.ellipsis_prefix_single,this.ellipsis.single.strings.suffix=this.ellipsis_suffix,this.ellipsis.multiple=new s.Blob(this.ellipsis_term),this.ellipsis.multiple.strings.prefix=this.ellipsis_prefix_multiple,this.ellipsis.multiple.strings.suffix=this.ellipsis_suffix),"undefined"==typeof t.tmp["et-al-min"]&&(t.tmp["et-al-min"]=this.strings["et-al-min"]),"undefined"==typeof t.tmp["et-al-use-first"]&&(t.tmp["et-al-use-first"]=this.strings["et-al-use-first"]),"undefined"==typeof t.tmp["et-al-use-last"]&&(t.tmp["et-al-use-last"]=this.strings["et-al-use-last"]),t.nameOutput.name=this},t.build.name_flag=!0,this.execs.push(i)),e.push(this)}},s.Node["name-part"]={build:function(t,e){t.build[this.strings.name]=this}},s.Node.names={build:function(t,e){var i;if((this.tokentype===s.START||this.tokentype===s.SINGLETON)&&(s.Util.substituteStart.call(this,t,e),t.build.substitute_level.push(1),t.fixOpt(this,"names-delimiter","delimiter")),this.tokentype===s.SINGLETON){t.build.names_variables.push(this.variables);for(var n=0,r=this.variables.length;r>n;n+=1)t.build.name_label[this.variables[n]]=t.build.name_label[t.build.names_variables.slice(0)[0]];i=function(t,e,i){t.nameOutput.reinit(this)},this.execs.push(i)}if(this.tokentype===s.START&&(t.build.names_flag=!0,t.build.names_level+=1,1===t.build.names_level&&(t.build.names_variables=[],t.build.name_label={}),t.build.names_variables.push(this.variables),i=function(t,e,i){t.tmp.can_substitute.push(!0),t.parallel.StartVariable("names",this.variables[0]),t.nameOutput.init(this)},this.execs.push(i)),this.tokentype===s.END){for(var n=0,r=3;r>n;n+=1){var o=["family","given","et-al"][n];this[o]=t.build[o],1===t.build.names_level&&(t.build[o]=void 0)}this.label=t.build.name_label,1===t.build.names_level&&(t.build.name_label={}),t.build.names_level+=-1,t.build.names_variables.pop();var a="with",l="",u="";s.STARTSWITH_ROMANESQUE_REGEXP.test(a)&&(l=" ",u=" "),this["with"]={},this["with"].single=new s.Blob(a),this["with"].single.strings.suffix=u,this["with"].multiple=new s.Blob(a),this["with"].multiple.strings.suffix=u,"always"===this.strings["delimiter-precedes-last"]?(this["with"].single.strings.prefix=this.strings.delimiter,this["with"].multiple.strings.prefix=this.strings.delimiter):"contextual"===this.strings["delimiter-precedes-last"]?(this["with"].single.strings.prefix=l,this["with"].multiple.strings.prefix=this.strings.delimiter):"after-inverted-name"===this.strings["delimiter-precedes-last"]?(this["with"].single.strings.prefix=this.strings.delimiter,this["with"].multiple.strings.prefix=l):(this["with"].single.strings.prefix=l,this["with"].multiple.strings.prefix=l),i=function(t,e,i){t.tmp.etal_node?this.etal_style=t.tmp.etal_node:this.etal_style="empty",this.etal_term=t.getTerm(t.tmp.etal_term,"long",0),s.STARTSWITH_ROMANESQUE_REGEXP.test(this.etal_term)?(this.etal_prefix_single=" ",this.etal_prefix_multiple=t.tmp.name_delimiter,"always"===t.tmp["delimiter-precedes-et-al"]?this.etal_prefix_single=t.tmp.name_delimiter:"never"===t.tmp["delimiter-precedes-et-al"]?this.etal_prefix_multiple=" ":"after-inverted-name"===t.tmp["delimiter-precedes-et-al"]&&(this.etal_prefix_single=t.tmp.name_delimiter,this.etal_prefix_multiple=" "),this.etal_suffix=""):(this.etal_prefix_single="",this.etal_prefix_multiple="",this.etal_suffix="");for(var n=0,r=3;r>n;n+=1){var o=["family","given"][n];t.nameOutput[o]=this[o]}t.nameOutput["with"]=this["with"],t.nameOutput.label=this.label,t.nameOutput.etal_style=this.etal_style,t.nameOutput.etal_term=this.etal_term,t.nameOutput.etal_prefix_single=this.etal_prefix_single,t.nameOutput.etal_prefix_multiple=this.etal_prefix_multiple,t.nameOutput.etal_suffix=this.etal_suffix,t.nameOutput.outputNames(),t.tmp["et-al-use-first"]=void 0,t.tmp["et-al-min"]=void 0,t.tmp["et-al-use-last"]=void 0},this.execs.push(i),i=function(t,e){t.tmp.can_substitute.pop()||t.tmp.can_substitute.replace(!1,s.LITERAL),t.parallel.CloseVariable("names"),1===t.tmp.can_substitute.mystack.length&&(t.tmp.can_block_substitute=!1)},this.execs.push(i),t.build.name_flag=!1}e.push(this),(this.tokentype===s.END||this.tokentype===s.SINGLETON)&&(t.build.substitute_level.pop(),s.Util.substituteEnd.call(this,t,e))}},s.Node.number={build:function(t,e){var i;s.Util.substituteStart.call(this,t,e),"roman"===this.strings.form?this.formatter=t.fun.romanizer:"ordinal"===this.strings.form?this.formatter=t.fun.ordinalizer:"long-ordinal"===this.strings.form&&(this.formatter=t.fun.long_ordinalizer),"undefined"==typeof this.successor_prefix&&(this.successor_prefix=t[t.build.area].opt.layout_delimiter),"undefined"==typeof this.splice_prefix&&(this.splice_prefix=t[t.build.area].opt.layout_delimiter),i=function(t,e,i){var n,r,o,a;if(0!==this.variables.length){if("undefined"==typeof i)var i={};var l,u;if(l=this.variables[0],"locator"!==l||!t.tmp.just_looking){t.parallel.StartVariable(this.variables[0]),"locator"===this.variables[0]?t.parallel.AppendToVariable(e.section):t.parallel.AppendToVariable(e[this.variables[0]]);var c=new RegExp("(?:&|, | and |"+t.getTerm("page-range-delimiter")+")");"collection-number"===l&&"legal_case"===e.type&&(t.tmp.renders_collection_number=!0);var h=e[this.variables[0]],p="long";if(this.strings.label_form_override&&(p=this.strings.label_form_override),"locator"===l&&i.locator)if(i.locator=i.locator.replace(/([^\\])\s*-\s*/,"$1"+t.getTerm("page-range-delimiter")),u=i.locator.match(s.STATUTE_SUBDIV_GROUPED_REGEX)){for(a=i.locator.split(s.STATUTE_SUBDIV_PLAIN_REGEX),n=0,r=a.length;r>n;n+=1)a[n]=t.fun.page_mangler(a[n]);for(o=[a[0]],!this.strings.label_form_override&&t.tmp.group_context.value()[5]&&(p=t.tmp.group_context.value()[5]),n=1,r=a.length;r>n;n+=1){var d=0;a[n].match(c)&&(d=1);var f=s.STATUTE_SUBDIV_STRINGS[u[n-1].replace(/^\s*/,"")],m=p;i.section_label_count>n&&i.section_form_override&&(m=i.section_form_override),o.push(t.getTerm(f,m,d)),o.push(a[n].replace(/^\s*/,""))}h=o.join(" "),h=h.replace(/\\/,"","g"),t.output.append(h,this)}else h=t.fun.page_mangler(i.locator),h=h.replace(/\\/,"","g"),t.output.append(h,this);else{var g=this;(!t.tmp.shadow_numbers[l]||t.tmp.shadow_numbers[l].values.length&&t.tmp.shadow_numbers[l].values[0][2]===!1)&&("locator"===l?t.processNumber(g,i,l,e.type):t.processNumber(g,e,l,e.type));var b,y=t.tmp.shadow_numbers[l].values,v="",_="page";if(["bill","gazette","legislation","legal_case","treaty"].indexOf(e.type)>-1&&"collection-number"===l&&(_="year"),("number"===l&&["bill","gazette","legislation","treaty"].indexOf(e.type)>-1||t.opt[_+"-range-format"])&&!this.strings.prefix&&!this.strings.suffix&&!this.strings.form)for(n=0,r=y.length;r>n;n+=1)v+=y[n][1];if(v&&!v.match(/^[\-.\u20130-9]+$/)){if("number"===l&&["bill","gazette","legislation","treaty"].indexOf(e.type)>-1){var x=v.split(/\s/)[0];if(x&&(o=[],u=v.match(s.STATUTE_SUBDIV_GROUPED_REGEX))){for(a=v.split(s.STATUTE_SUBDIV_PLAIN_REGEX),n=1,r=a.length;r>n;n+=1)o.push(t.getTerm(s.STATUTE_SUBDIV_STRINGS[u[n-1].replace(/^\s+/,"")],this.strings.label_form_override)),o.push(a[n].replace(/^\s+/,""));v=o.join(" ")}}t.output.append(v,this)}else if(y.length){for(t.output.openLevel("empty"),n=0,r=y.length;r>n;n+=1)b=new s[y[n][0]](y[n][1],y[n][2],e.id),n>0&&(b.strings.prefix=b.strings.prefix.replace(/^\s*/,"")),n<y.length-1&&(b.strings.suffix=b.strings.suffix.replace(/\s*$/,"")),"undefined"==typeof b.gender&&(b.gender=t.locale[t.opt.lang]["noun-genders"][l]),t.output.append(b,"literal",!1,!1,!0);t.output.closeLevel("empty")}}"locator"===l&&t.tmp.done_vars.push("locator"),t.parallel.CloseVariable("number")}}},this.execs.push(i),e.push(this),s.Util.substituteEnd.call(this,t,e)}},s.Node.sort={build:function(t,e){if(e=t[t.build.root+"_sort"].tokens,this.tokentype===s.START){"citation"===t.build.area&&(t.parallel.use_parallels=!1,t.opt.sort_citations=!0),t.build.area=t.build.root+"_sort",t.build.extension="_sort";var i=function(t,e){if(t.opt.has_layout_locale){for(var i,n=s.localeResolve(e.language,t.opt["default-locale"][0]),r=t[t.tmp.area.slice(0,-5)].opt.sort_locales,o=0,a=r.length;a>o&&(i=r[o][n.bare],i||(i=r[o][n.best]),!i);o+=1);i||(i=t.opt["default-locale"][0]),t.tmp.lang_sort_hold=t.opt.lang,t.opt.lang=i}};this.execs.push(i)}if(this.tokentype===s.END){t.build.area=t.build.root,t.build.extension="";var i=function(t,e){t.opt.has_layout_locale&&(t.opt.lang=t.tmp.lang_sort_hold,delete t.tmp.lang_sort_hold)};this.execs.push(i)}e.push(this)}},s.Node.substitute={build:function(t,e){var i;this.tokentype===s.START&&(i=function(t,e){t.tmp.can_block_substitute=!0,t.tmp.value.length&&t.tmp.can_substitute.replace(!1,s.LITERAL)},this.execs.push(i)),e.push(this)}},s.Node.text={build:function(t,e){var i,n,r,o,a,l,u,c,h,p,d,f,m,g,b;if(this.postponed_macro)return s.expandMacro.call(t,this);if(s.Util.substituteStart.call(this,t,e),this.variables_real||(this.variables_real=[]),this.variables||(this.variables=[]),n="long",r=0,this.strings.form&&(n=this.strings.form),this.strings.plural&&(r=this.strings.plural),"citation-number"===this.variables_real[0]||"year-suffix"===this.variables_real[0]||"citation-label"===this.variables_real[0])"citation-number"===this.variables_real[0]?("citation"===t.build.root&&(t.opt.update_mode=s.NUMERIC),"bibliography"===t.build.root&&(t.opt.bib_mode=s.NUMERIC),"bibliography_sort"===t.build.area&&(t.opt.citation_number_sort_used=!0),"citation-number"===t[t.tmp.area].opt.collapse&&(this.range_prefix=t.getTerm("citation-range-delimiter")),this.successor_prefix=t[t.build.area].opt.layout_delimiter,this.splice_prefix=t[t.build.area].opt.layout_delimiter,i=function(t,e,i){if(o=""+e.id,!t.tmp.just_looking){if(i&&i["author-only"]){t.tmp.element_trace.replace("do-not-suppress-me");var n=t.getTerm("reference","long","singular");"undefined"==typeof n&&(n="reference"),f=s.Output.Formatters["capitalize-first"](t,n),t.output.append(f+" "),t.tmp.last_element_trace=!0}i&&i["suppress-author"]&&(t.tmp.last_element_trace&&t.tmp.element_trace.replace("suppress-me"),t.tmp.last_element_trace=!1),a=t.registry.registry[o].seq,t.opt.citation_number_slug?t.output.append(t.opt.citation_number_slug,this):(l=new s.NumericBlob(a,this,e.id),t.output.append(l,"literal"))}},this.execs.push(i)):"year-suffix"===this.variables_real[0]?(t.opt.has_year_suffix=!0,"year-suffix-ranged"===t[t.tmp.area].opt.collapse&&(this.range_prefix=t.getTerm("citation-range-delimiter")),this.successor_prefix=t[t.build.area].opt.layout_delimiter,t[t.tmp.area].opt["year-suffix-delimiter"]&&(this.successor_prefix=t[t.build.area].opt["year-suffix-delimiter"]),i=function(t,e){if(t.registry.registry[e.id]&&t.registry.registry[e.id].disambig.year_suffix!==!1&&!t.tmp.just_looking){for(a=parseInt(t.registry.registry[e.id].disambig.year_suffix,10),l=new s.NumericBlob(a,this,e.id),u=new s.Util.Suffixator(s.SUFFIX_CHARS),l.setFormatter(u),t.output.append(l,"literal"),c=!1,m=t.tmp.group_context.mystack.length,g=0;m>g;g+=1)if(b=t.tmp.group_context.mystack[g],!b[2]&&(b[1]||!b[1]&&!b[0])){c=!0;break}h=t[t.tmp.area].opt["year-suffix-delimiter"],c&&h&&!t.tmp.sort_key_flag&&(t.tmp.splice_delimiter=t[t.tmp.area].opt["year-suffix-delimiter"])}},this.execs.push(i)):"citation-label"===this.variables_real[0]&&(t.opt.has_year_suffix=!0,i=function(t,e){p=e["citation-label"],p||(p=t.getCitationLabel(e)),t.tmp.just_looking||(d="",t.registry.registry[e.id]&&t.registry.registry[e.id].disambig.year_suffix!==!1&&(a=parseInt(t.registry.registry[e.id].disambig.year_suffix,10),d=t.fun.suffixator.format(a)),p+=d),t.output.append(p,this)},this.execs.push(i));else if(this.strings.term)i=function(t,e,i){var o=t.opt.gender[e.type],a=this.strings.term;a=t.getTerm(a,n,r,o,!1,"accessed"===a);var l;if(""!==a&&(b=t.tmp.group_context.value(),b[0]=!0,t.tmp.group_context.replace(b)),l=t.tmp.term_predecessor||"in-text"===t.opt["class"]&&"citation"===t.tmp.area?a:s.Output.Formatters["capitalize-first"](t,a),t.tmp.strip_periods)l=l.replace(/\./g,"");else for(var u=0,c=this.decorations.length;c>u;u+=1)if("@strip-periods"===this.decorations[u][0]&&"true"===this.decorations[u][1]){l=l.replace(/\./g,"");break}t.output.append(l,this)},this.execs.push(i),t.build.term=!1,t.build.form=!1,t.build.plural=!1;else if(this.variables_real.length){if(i=function(t,e,i){var s=this.variables[0];"title"!==s||"short"!==n&&!e["title-short"]||(s="title-short"),t.parallel.StartVariable(s),t.parallel.AppendToVariable(e[s],s)},this.execs.push(i),s.MULTI_FIELDS.indexOf(this.variables_real[0])>-1){var y=this.variables[0],v=!1,_=!1,x=!1;"short"===n?"container-title"===this.variables_real[0]?_="journalAbbreviation":"title"===this.variables_real[0]&&(_="title-short"):y=!1,t.build.extension?x=!0:(x=!0,v=!0),i=t.transform.getOutputFunction(this.variables,y,v,_,x)}else i=s.CITE_FIELDS.indexOf(this.variables_real[0])>-1?function(t,e,i){if(i&&i[this.variables[0]]){var n=""+i[this.variables[0]];n=n.replace(/([^\\])--*/g,"$1"+t.getTerm("page-range-delimiter")),n=n.replace(/\\-/g,"-"),t.output.append(n,this,!1,!1,!0),"locator-revision"===this.variables[0]&&t.tmp.done_vars.push("locator-revision")}}:"page-first"===this.variables_real[0]?function(t,e){var i;i=t.getVariable(e,"page-first",n),i&&(i=i.replace("\\",""),t.output.append(i,this,!1,!1,!0))}:"page"===this.variables_real[0]?function(t,e){var i=t.getVariable(e,"page",n);i&&(i=""+i,i=i.replace(/([^\\])--*/g,"$1"+t.getTerm("page-range-delimiter")),i=i.replace(/\\-/g,"-"),i=t.fun.page_mangler(i),t.output.append(i,this,!1,!1,!0))}:"volume"===this.variables_real[0]?function(t,e){if(this.variables[0]){var i=t.getVariable(e,this.variables[0],n);i&&t.output.append(i,this)}}:["URL","DOI"].indexOf(this.variables_real[0])>-1?function(t,e){var i;this.variables[0]&&(i=t.getVariable(e,this.variables[0],n),i&&(t.opt.development_extensions.wrap_url_and_doi?this.decorations.length&&this.decorations[0][0]==="@"+this.variables[0]||(this.decorations=[["@"+this.variables[0],"true"]].concat(this.decorations)):this.decorations.length&&this.decorations[0][0]==="@"+this.variables[0]&&(this.decorations=this.decorations.slice(1)),t.output.append(i,this,!1,!1,!0)))}:"section"===this.variables_real[0]?function(t,e){var i;i=t.getVariable(e,this.variables[0],n),i&&t.output.append(i,this)}:"hereinafter"===this.variables_real[0]?function(t,e){var i=t.transform.abbrevs["default"].hereinafter[e.id];i&&(t.output.append(i,this),t.tmp.group_context.value()[2]=!0)}:function(t,e){var i;this.variables[0]&&(i=t.getVariable(e,this.variables[0],n),i&&(i=""+i,i=i.replace("\\","","g"),t.output.append(i,this)))};this.execs.push(i),i=function(t,e){t.parallel.CloseVariable("text")},this.execs.push(i)}else this.strings.value&&(i=function(t,e){var i;i=t.tmp.group_context.value(),i[0]=!0,t.tmp.group_context.replace(i),t.output.append(this.strings.value,this)},this.execs.push(i));e.push(this),s.Util.substituteEnd.call(this,t,e)}},s.Attributes={},s.Attributes["@genre"]=function(t,e){e=e.replace("-"," ");var i=function(t,i){return e===t.genre?!0:!1};this.tests.push(i)},s.Attributes["@disambiguate"]=function(t,e){if("true"===e){t.opt.has_disambiguate=!0;var i=function(e,i){return t.tmp.disambiguate_maxMax+=1,t.tmp.disambig_settings.disambiguate&&t.tmp.disambiguate_count<t.tmp.disambig_settings.disambiguate?(t.tmp.disambiguate_count+=1,!0):!1};this.tests.push(i)}else if("check-ambiguity-and-backreference"===e){var i=function(e,i){return t.registry.registry[e.id].disambig.disambiguate&&t.registry.registry[e.id]["citation-count"]>1?!0:!1};this.tests.push(i)}},s.Attributes["@is-numeric"]=function(t,e,i){for(var n=e.split(/\s+/),r=function(e){return function(i,n){var r=i;if(["locator","locator-revision"].indexOf(e)>-1&&(r=n),"undefined"==typeof r)return!1;if(s.NUMERIC_VARIABLES.indexOf(e)>-1){if(t.tmp.shadow_numbers[e]||t.processNumber(!1,r,e,i.type),r[e]&&t.tmp.shadow_numbers[e].numeric)return!0}else if(["title","locator-revision","version"].indexOf(e)>-1&&r[e]&&r[e].slice(-1)===""+parseInt(r[e].slice(-1),10))return!0;return!1}},o=0;o<n.length;o+=1)this.tests.push(r(n[o]))},s.Attributes["@is-uncertain-date"]=function(t,e){for(var i=e.split(/\s+/),n=function(t){return function(e,i){return e[t]&&e[t].circa?!0:!1}},s=0,r=i.length;r>s;s+=1)this.tests.push(n(i[s]))},s.Attributes["@locator"]=function(t,e){var i=e.replace("sub verbo","sub-verbo");i=i.split(/\s+/);for(var n=function(t){return function(e,i){var n;return n="undefined"!=typeof i&&i.label?"sub verbo"===i.label?"sub-verbo":i.label:"page",t===n?!0:!1}},s=0,r=i.length;r>s;s+=1)this.tests.push(n(i[s]))},s.Attributes["@position"]=function(t,e){var i;t.opt.update_mode=s.POSITION,t.parallel.use_parallels=!0;for(var n=e.split(/\s+/),r=function(e){return function(i,n){if("bibliography"===t.tmp.area)return!1;if(n&&"undefined"==typeof n.position&&(n.position=0),n&&"number"==typeof n.position){if(0===n.position&&0===e)return!0;if(e>0&&n.position>=e)return!0}else if(0===e)return!0;return!1}},o=0,a=n.length;a>o;o+=1){var i=n[o];"first"===i?i=s.POSITION_FIRST:"subsequent"===i?i=s.POSITION_SUBSEQUENT:"ibid"===i?i=s.POSITION_IBID:"ibid-with-locator"===i&&(i=s.POSITION_IBID_WITH_LOCATOR),"near-note"===i?this.tests.push(function(t,e){return e&&e.position>=s.POSITION_SUBSEQUENT&&e["near-note"]?!0:!1}):this.tests.push(r(i))}},s.Attributes["@type"]=function(t,e){for(var i=e.split(/\s+/),n=function(t){return function(e,i){var n=e.type===t;return n?!0:!1}},s=[],r=0,o=i.length;o>r;r+=1)s.push(n(i[r]));this.tests.push(t.fun.match.any(this,t,s))},s.Attributes["@variable"]=function(t,e){var i,n,r,o;if(this.variables=e.split(/\s+/),this.variables_real=this.variables.slice(),"label"===this.name&&this.variables[0])this.strings.term=this.variables[0];else if(["names","date","text","number"].indexOf(this.name)>-1)i=function(t,e,i){n=this.variables_real.slice();for(var s=this.variables.length-1;s>-1;s+=-1)this.variables.pop();for(r=n.length,o=0;r>o;o+=1)-1!==t.tmp.done_vars.indexOf(n[o])||i&&"legal_case"===e.type&&i["suppress-author"]&&"title"===n[o]||this.variables.push(n[o]),t.tmp.can_block_substitute&&t.tmp.done_vars.push(n[o])},this.execs.push(i),i=function(t,e,i){var n,a;for(n=!1,r=this.variables.length,o=0;r>o;o+=1){if(a=this.variables[o],"authority"===a&&"string"==typeof e[a]&&"names"===this.name){var l={family:e[a],isInstitution:!0,multi:{_key:{}}};if(e.multi&&e.multi._keys&&e.multi._keys[a])for(var u in e.multi._keys[a])creatorChild={family:e.multi._keys[a][u],isInstitution:!0},l.multi._key[u]=creatorChild;e[a]=[l]}if("short"!==this.strings.form||e[a]||("title"===a?a="title-short":"container-title"===a&&(a="journalAbbreviation")),"year-suffix"===a){n=!0;break}if(s.DATE_VARIABLES.indexOf(a)>-1){if(t.opt.development_extensions.locator_date_and_revision&&"locator-date"===a){n=!0;break}if(e[a]){for(var c in e[a])if((-1!==this.dateparts.indexOf(c)||"literal"===c)&&e[a][c]){n=!0;break}if(n)break}}else{if("locator"===a){i&&i.locator&&(n=!0);break}if("locator-revision"===a){i&&i["locator-revision"]&&(n=!0);break}if(["citation-number","citation-label"].indexOf(a)>-1){n=!0;break}if("first-reference-note-number"===a){i&&i["first-reference-note-number"]&&(n=!0);break}if("hereinafter"===a){t.transform.abbrevs["default"].hereinafter[e.id]&&t.sys.getAbbreviation&&e.id&&(n=!0);break}if("object"==typeof e[a]){e[a].length;break}if("string"==typeof e[a]&&e[a]){n=!0;break}if("number"==typeof e[a]){n=!0;break}}if(n)break}var h=t.tmp.group_context.value();n?(("citation-number"!==a||"bibliography"!==t.tmp.area)&&(t.tmp.cite_renders_content=!0),h[2]=!0,t.tmp.group_context.replace(h),t.tmp.can_substitute.value()&&"bibliography"===t.tmp.area&&"string"==typeof e[a]&&t.tmp.rendered_name.push(e[a]),
t.tmp.can_substitute.replace(!1,s.LITERAL)):h[1]=!0},this.execs.push(i);else if(["if","else-if","condition"].indexOf(this.name)>-1)for(var a=function(e){return function(i,n){var s=i;if(n&&["locator","locator-revision","first-reference-note-number","locator-date"].indexOf(e)>-1&&(s=n),"hereinafter"===e&&t.sys.getAbbreviation&&s.id){if(t.transform.abbrevs["default"].hereinafter[s.id])return!0}else if(s[e]){if("number"==typeof s[e]||"string"==typeof s[e])return!0;if("object"==typeof s[e])for(key in s[e])if(s[e][key])return!0}return!1}},l=0,u=this.variables.length;u>l;l+=1)this.tests.push(a(this.variables[l]))},s.Attributes["@page"]=function(t,e){var i=e.replace("sub verbo","sub-verbo");i=i.split(/\s+/);for(var n=function(e){return function(i,n){var s;return t.processNumber(!1,i,"page",i.type),s=t.tmp.shadow_numbers.page.label?"sub verbo"===t.tmp.shadow_numbers.page.label?"sub-verbo":t.tmp.shadow_numbers.page.label:"page",e===s?!0:!1}},s=0,r=i.length;r>s;s+=1)this.tests.push(n(i[s]))},s.Attributes["@jurisdiction"]=function(t,e){for(var i=e.split(/\s+/),n=0,s=i.length;s>n;n+=1)i[n]=i[n].split(";");for(var r=function(t){return function(e,i){if(!e.jurisdiction)return!1;for(var n=e.jurisdiction.split(";"),s=0,r=n.length;r>s;s+=1)n[s]=n[s].split(";");for(s=t.length;s>0;s+=-1){var o=t.slice(0,s).join(";"),a=n.slice(0,s).join(";");if(o!==a)return!1}return!0}},n=0,s=i.length;s>n;n+=1){var o=i[n].slice();this.tests.push(r(o))}},s.Attributes["@context"]=function(t,e){var i=function(i,n){var s=t.tmp.area.slice(0,e.length);return s===e?!0:!1};this.tests.push(i)},s.Attributes["@has-year-only"]=function(t,e){for(var i=e.split(/\s+/),n=function(t){return function(e,i){var n=e[t];return!n||n.month||n.season?!1:!0}},s=0,r=i.length;r>s;s+=1)this.tests.push(n(i[s]))},s.Attributes["@has-to-month-or-season"]=function(t,e){for(var i=e.split(/\s+/),n=function(t){return function(e,i){var n=e[t];return!n||!n.month&&!n.season||n.day?!1:!0}},s=0,r=i.length;r>s;s+=1)this.tests.push(n(i[s]))},s.Attributes["@has-day"]=function(t,e){for(var i=e.split(/\s+/),n=function(t){return function(e,i){var n=e[t];return n&&n.day?!0:!1}},s=0,r=i.length;r>s;s+=1)this.tests.push(n(i[s]))},s.Attributes["@subjurisdictions"]=function(t,e){var i=parseInt(e,10),n=function(t,e){var n=0;return t.jurisdiction&&(n=t.jurisdiction.split(";").length),n&&(n+=-1),n>=i?!0:!1};this.tests.push(n)},s.Attributes["@is-plural"]=function(t,e){var i=function(t,i){var n=t[e];if(n&&n.length){for(var s=0,r=0,o=!1,a=0,l=n.length;l>a;a+=1)n[a].isInstitution&&(n[a].literal||n[a].family&&!n[a].given)?(r+=1,o=!1):(s+=1,o=!0);if(s>1)return!0;if(r>1)return!0;if(r&&o)return!0}return!1};this.tests.push(i)},s.Attributes["@locale"]=function(t,e){var i,n,r,o,a,l,u=t.opt["default-locale"][0];if("layout"===this.name){if(this.locale_raw=e,this.tokentype===s.START){var c=e.split(/\s+/),h={},p=s.localeResolve(c[0],u);p.generic?h[p.generic]=p.best:h[p.best]=p.best;for(var a=1,l=c.length;l>a;a+=1){var d=s.localeResolve(c[a],u);d.generic?h[d.generic]=p.best:h[d.best]=p.best}t[t.build.area].opt.sort_locales.push(h)}t.opt.has_layout_locale=!0}else{o=e.split(/\s+/);var f=[];for(a=0,l=o.length;l>a;a+=1)r=o[a],n=s.localeResolve(r,u),2===o[a].length&&f.push(n.bare),t.localeConfigure(n,!0),o[a]=n;var m=o.slice(),g=function(t,e,n){return function(r,o){var u;i=[],u=!1;var c,h=!1;for(c=r.language?r.language:e,h=s.localeResolve(c,e),a=0,l=t.length;l>a;a+=1)if(h.best===t[a].best){u=!0;break}return!u&&n.indexOf(h.bare)>-1&&(u=!0),u}};this.tests.push(g(m,u,f))}},s.Attributes["@locale-internal"]=function(t,e){var i,n,r,o,a,l;for(o=e.split(/\s+/),this.locale_bares=[],a=0,l=o.length;l>a;a+=1)r=o[a],n=s.localeResolve(r,t.opt["default-locale"][0]),2===o[a].length&&this.locale_bares.push(n.bare),t.localeConfigure(n),o[a]=n;this.locale_default=t.opt["default-locale"][0],this.locale=o[0].best,this.locale_list=o.slice();var u=function(e){return function(n,o){var u;i=[],u=!1;var c=!1;if(n.language&&(r=n.language,c=s.localeResolve(r,t.opt["default-locale"][0]),c.best===t.opt["default-locale"][0]&&(c=!1)),c){for(a=0,l=e.locale_list.length;l>a;a+=1)if(c.best===e.locale_list[a].best){t.opt.lang=e.locale,t.tmp.last_cite_locale=e.locale,t.output.openLevel("empty"),t.output.current.value().new_locale=e.locale,u=!0;break}!u&&e.locale_bares.indexOf(c.bare)>-1&&(t.opt.lang=e.locale,t.tmp.last_cite_locale=e.locale,t.output.openLevel("empty"),t.output.current.value().new_locale=e.locale,u=!0)}return u}},c=this;this.tests.push(u(c))},s.Attributes["@is-parallel"]=function(t,e){for(var i=e.split(" "),n=0,s=i.length;s>n;n+=1)"true"===i[n]?i[n]=!0:"false"===i[n]&&(i[n]=!1);this.strings.set_parallel_condition=i},s.Attributes["@gender"]=function(t,e){this.gender=e},s.Attributes["@cslid"]=function(t,e){this.cslid=parseInt(e,10)},s.Attributes["@label-form"]=function(t,e){this.strings.label_form_override=e},s.Attributes["@part-separator"]=function(t,e){this.strings["part-separator"]=e},s.Attributes["@leading-noise-words"]=function(t,e){this["leading-noise-words"]=e},s.Attributes["@name-never-short"]=function(t,e){this["name-never-short"]=e},s.Attributes["@class"]=function(t,e){t.opt["class"]=e},s.Attributes["@version"]=function(t,e){t.opt.version=e},s.Attributes["@value"]=function(t,e){this.strings.value=e},s.Attributes["@name"]=function(t,e){this.strings.name=e},s.Attributes["@form"]=function(t,e){this.strings.form=e},s.Attributes["@date-parts"]=function(t,e){this.strings["date-parts"]=e},s.Attributes["@range-delimiter"]=function(t,e){this.strings["range-delimiter"]=e},s.Attributes["@macro"]=function(t,e){this.postponed_macro=e},s.Attributes["@term"]=function(t,e){"sub verbo"===e?this.strings.term="sub-verbo":this.strings.term=e},s.Attributes["@xmlns"]=function(t,e){},s.Attributes["@lang"]=function(t,e){e&&(t.build.lang=e)},s.Attributes["@lingo"]=function(t,e){},s.Attributes["@macro-has-date"]=function(t,e){this["macro-has-date"]=!0},s.Attributes["@suffix"]=function(t,e){this.strings.suffix=e},s.Attributes["@prefix"]=function(t,e){this.strings.prefix=e},s.Attributes["@delimiter"]=function(t,e){"name"==this.name?this.strings.name_delimiter=e:this.strings.delimiter=e},s.Attributes["@match"]=function(t,e){this.match=e},s.Attributes["@names-min"]=function(t,e){var i=parseInt(e,10);t[t.tmp.area].opt.max_number_of_names<i&&(t[t.tmp.area].opt.max_number_of_names=i),this.strings["et-al-min"]=i},s.Attributes["@names-use-first"]=function(t,e){this.strings["et-al-use-first"]=parseInt(e,10)},s.Attributes["@names-use-last"]=function(t,e){"true"===e?this.strings["et-al-use-last"]=!0:this.strings["et-al-use-last"]=!1},s.Attributes["@sort"]=function(t,e){"descending"===e&&(this.strings.sort_direction=s.DESCENDING)},s.Attributes["@plural"]=function(t,e){"always"===e||"true"===e?this.strings.plural=1:"never"===e||"false"===e?this.strings.plural=0:"contextual"===e&&(this.strings.plural=!1)},s.Attributes["@number"]=function(t,e){var i,n=e.replace("sub verbo","sub-verbo");n=n.split(/\s+/),["if","else-if"].indexOf(this.name)>-1&&(i=function(t,e,i){var s,r=[];t.processNumber(!1,e,"number",e.type),s=t.tmp.shadow_numbers.number.label?"sub verbo"===t.tmp.shadow_numbers.number.label?"sub-verbo":t.tmp.shadow_numbers.number.label:"number";for(var o=0,a=n.length;a>o;o+=1)n[o]===s?r.push(!0):r.push(!1);return r},this.tests.push(i))},s.Attributes["@has-publisher-and-publisher-place"]=function(t,e){this.strings["has-publisher-and-publisher-place"]=!0},s.Attributes["@publisher-delimiter-precedes-last"]=function(t,e){this.strings["publisher-delimiter-precedes-last"]=e},s.Attributes["@publisher-delimiter"]=function(t,e){this.strings["publisher-delimiter"]=e},s.Attributes["@publisher-and"]=function(t,e){this.strings["publisher-and"]=e},s.Attributes["@newdate"]=function(t,e){},s.Attributes["@givenname-disambiguation-rule"]=function(t,e){s.GIVENNAME_DISAMBIGUATION_RULES.indexOf(e)>-1&&(t.citation.opt["givenname-disambiguation-rule"]=e)},s.Attributes["@collapse"]=function(t,e){e&&(t[this.name].opt.collapse=e)},s.Attributes["@cite-group-delimiter"]=function(t,e){e&&(t[t.tmp.area].opt.cite_group_delimiter=e)},s.Attributes["@names-delimiter"]=function(t,e){t.setOpt(this,"names-delimiter",e)},s.Attributes["@name-form"]=function(t,e){t.setOpt(this,"name-form",e)},s.Attributes["@subgroup-delimiter"]=function(t,e){this.strings["subgroup-delimiter"]=e},s.Attributes["@subgroup-delimiter-precedes-last"]=function(t,e){this.strings["subgroup-delimiter-precedes-last"]=e},s.Attributes["@name-delimiter"]=function(t,e){t.setOpt(this,"name-delimiter",e)},s.Attributes["@et-al-min"]=function(t,e){var i=parseInt(e,10);t[t.tmp.area].opt.max_number_of_names<i&&(t[t.tmp.area].opt.max_number_of_names=i),t.setOpt(this,"et-al-min",i)},s.Attributes["@et-al-use-first"]=function(t,e){t.setOpt(this,"et-al-use-first",parseInt(e,10))},s.Attributes["@et-al-use-last"]=function(t,e){"true"===e?t.setOpt(this,"et-al-use-last",!0):t.setOpt(this,"et-al-use-last",!1)},s.Attributes["@et-al-subsequent-min"]=function(t,e){var i=parseInt(e,10);t[t.tmp.area].opt.max_number_of_names<i&&(t[t.tmp.area].opt.max_number_of_names=i),t.setOpt(this,"et-al-subsequent-min",i)},s.Attributes["@et-al-subsequent-use-first"]=function(t,e){t.setOpt(this,"et-al-subsequent-use-first",parseInt(e,10))},s.Attributes["@suppress-min"]=function(t,e){this.strings["suppress-min"]=parseInt(e,10)},s.Attributes["@suppress-max"]=function(t,e){this.strings["suppress-max"]=parseInt(e,10)},s.Attributes["@and"]=function(t,e){t.setOpt(this,"and",e)},s.Attributes["@delimiter-precedes-last"]=function(t,e){t.setOpt(this,"delimiter-precedes-last",e)},s.Attributes["@delimiter-precedes-et-al"]=function(t,e){t.setOpt(this,"delimiter-precedes-et-al",e)},s.Attributes["@initialize-with"]=function(t,e){t.setOpt(this,"initialize-with",e)},s.Attributes["@initialize"]=function(t,e){"false"===e&&t.setOpt(this,"initialize",!1)},s.Attributes["@name-as-reverse-order"]=function(t,e){this["name-as-reverse-order"]=e},s.Attributes["@name-as-sort-order"]=function(t,e){"style-options"===this.name?this["name-as-sort-order"]=e:t.setOpt(this,"name-as-sort-order",e)},s.Attributes["@sort-separator"]=function(t,e){t.setOpt(this,"sort-separator",e)},s.Attributes["@year-suffix-delimiter"]=function(t,e){t[this.name].opt["year-suffix-delimiter"]=e},s.Attributes["@after-collapse-delimiter"]=function(t,e){t[this.name].opt["after-collapse-delimiter"]=e},s.Attributes["@subsequent-author-substitute"]=function(t,e){t[this.name].opt["subsequent-author-substitute"]=e},s.Attributes["@subsequent-author-substitute-rule"]=function(t,e){t[this.name].opt["subsequent-author-substitute-rule"]=e},s.Attributes["@disambiguate-add-names"]=function(t,e){"true"===e&&(t.opt["disambiguate-add-names"]=!0)},s.Attributes["@disambiguate-add-givenname"]=function(t,e){"true"===e&&(t.opt["disambiguate-add-givenname"]=!0)},s.Attributes["@disambiguate-add-year-suffix"]=function(t,e){"true"===e&&"numeric"!==t.opt.xclass&&(t.opt["disambiguate-add-year-suffix"]=!0)},s.Attributes["@second-field-align"]=function(t,e){("flush"===e||"margin"===e)&&(t[this.name].opt["second-field-align"]=e)},s.Attributes["@hanging-indent"]=function(t,e){"true"===e&&(t[this.name].opt.hangingindent=2)},s.Attributes["@line-spacing"]=function(t,e){e&&e.match(/^[.0-9]+$/)&&(t[this.name].opt["line-spacing"]=parseFloat(e,10))},s.Attributes["@entry-spacing"]=function(t,e){e&&e.match(/^[.0-9]+$/)&&(t[this.name].opt["entry-spacing"]=parseFloat(e,10))},s.Attributes["@near-note-distance"]=function(t,e){t[this.name].opt["near-note-distance"]=parseInt(e,10)},s.Attributes["@text-case"]=function(t,e){var i=function(t,i){if("normal"===e)this.text_case_normal=!0;else if(this.strings["text-case"]=e,"title"===e){t.opt["default-locale"][0].slice(0,2);i.jurisdiction&&(this.strings["text-case"]="passthrough")}};this.execs.push(i)},s.Attributes["@page-range-format"]=function(t,e){t.opt["page-range-format"]=e},s.Attributes["@year-range-format"]=function(t,e){t.opt["year-range-format"]=e},s.Attributes["@default-locale"]=function(t,e){var i,n,s,r,o;if(r=e.match(/-x-(sort|translit|translat)-/g))for(s=0,n=r.length;n>s;s+=1)r[s]=r[s].replace(/^-x-/,"").replace(/-$/,"");for(i=e.split(/-x-(?:sort|translit|translat)-/),o=[i[0]],s=1,n=i.length;n>s;s+=1)o.push(r[s-1]),o.push(i[s]);for(i=o.slice(),n=i.length,s=1;n>s;s+=2)t.opt["locale-"+i[s]].push(i[s+1].replace(/^\s*/g,"").replace(/\s*$/g,""));i.length?t.opt["default-locale"]=i.slice(0,1):t.opt["default-locale"]=["en"]},s.Attributes["@default-locale-sort"]=function(t,e){t.opt["default-locale-sort"]=e},s.Attributes["@demote-non-dropping-particle"]=function(t,e){t.opt["demote-non-dropping-particle"]=e},s.Attributes["@initialize-with-hyphen"]=function(t,e){"false"===e&&(t.opt["initialize-with-hyphen"]=!1)},s.Attributes["@institution-parts"]=function(t,e){this.strings["institution-parts"]=e},s.Attributes["@if-short"]=function(t,e){"true"===e&&(this.strings["if-short"]=!0)},s.Attributes["@substitute-use-first"]=function(t,e){this.strings["substitute-use-first"]=parseInt(e,10)},s.Attributes["@use-first"]=function(t,e){this.strings["use-first"]=parseInt(e,10)},s.Attributes["@stop-last"]=function(t,e){this.strings["stop-last"]=-1*parseInt(e,10)},s.Attributes["@oops"]=function(t,e){this.strings.oops=e},s.Attributes["@use-last"]=function(t,e){this.strings["use-last"]=parseInt(e,10)},s.Attributes["@reverse-order"]=function(t,e){"true"===e&&(this.strings["reverse-order"]=!0)},s.Attributes["@display"]=function(t,e){this.strings.cls=e},s.Stack=function(t,e){this.mystack=[],(e||t)&&this.mystack.push(t)},s.Stack.prototype.push=function(t,e){e||t?this.mystack.push(t):this.mystack.push("")},s.Stack.prototype.clear=function(){this.mystack=[]},s.Stack.prototype.replace=function(t,e){if(0===this.mystack.length)throw"Internal CSL processor error: attempt to replace nonexistent stack item with "+t;e||t?this.mystack[this.mystack.length-1]=t:this.mystack[this.mystack.length-1]=""},s.Stack.prototype.pop=function(){return this.mystack.pop()},s.Stack.prototype.value=function(){return this.mystack.slice(-1)[0]},s.Stack.prototype.length=function(){return this.mystack.length},s.Parallel=function(t){this.state=t,this.sets=new s.Stack([]),this.try_cite=!0,this.use_parallels=!1,this.midVars=["section","volume","container-title","collection-number","issue","page-first","page","number"],this.ignoreVarsLawGeneral=["first-reference-note-number","locator","label","page-first","page","genre"],this.ignoreVarsLawProceduralHistory=["issued","first-reference-note-number","locator","label","page-first","page","genre","jurisdiction"],this.ignoreVarsOrders=["first-reference-note-number"],this.ignoreVarsOther=["first-reference-note-number","locator","label","section","page-first","page"]},s.Parallel.prototype.isMid=function(t){return this.midVars.indexOf(t)>-1},s.Parallel.prototype.StartCitation=function(t,e){this.parallel_conditional_blobs_list=[],this.use_parallels&&(this.sortedItems=t,this.sortedItemsPos=-1,this.sets.clear(),this.sets.push([]),this.in_series=!0,this.delim_counter=0,this.delim_pointers=[],e?this.out=e:this.out=this.state.output.queue,this.master_was_neutral_cite=!0)},s.Parallel.prototype.StartCite=function(t,e,i){var n,r,o,a,l,u,c,h;if(this.use_parallels){this.sets.value().length&&this.sets.value()[0].itemId==t.id&&this.ComposeSet(),this.sortedItemsPos+=1,e&&(n=e.position),this.try_cite=!0;for(var p=!1,d=0,f=s.PARALLEL_MATCH_VARS.length;f>d;d+=1)if(t[s.PARALLEL_MATCH_VARS[d]]){p=!0;break}var m=!0,g=this.sets.value().slice(-1)[0];if(g&&g.Item&&(g.Item.title!==t.title?m=!1:g.Item.type!==t.type?m=!1:["article-journal","article-magazine"].indexOf(t.type)>-1&&(this.state.opt.development_extensions.handle_parallel_articles&&g.Item["container-title"]===t["container-title"]||(m=!1))),m&&p&&-1!==s.PARALLEL_TYPES.indexOf(t.type)||(this.try_cite=!0,this.in_series&&(this.in_series=!1)),this.cite={},this.cite.front=[],this.cite.mid=[],this.cite.back=[],this.cite.front_collapse={},this.cite.back_forceme=[],this.cite.position=n,this.cite.Item=t,this.cite.itemId=""+t.id,this.cite.prevItemID=""+i,this.target="front",["treaty"].indexOf(t.type)>-1)this.ignoreVars=this.ignoreVarsOrders;else if(["article-journal","article-magazine"].indexOf(t.type)>-1)this.ignoreVars=this.ignoreVarsOther;else if(e&&e.prefix){this.ignoreVars=this.ignoreVarsLawProceduralHistory,this.cite.useProceduralHistory=!0;var b=this.sets.value()[this.sets.value().length-1];if(b&&b.back)for(var d=b.back.length-1;d>-1;d+=-1)b.back[d]&&b[b.back[d]]&&delete b[b.back[d]]}else this.ignoreVars=this.ignoreVarsLawGeneral;if(this.sortedItems&&this.sortedItemsPos>0&&this.sortedItemsPos<this.sortedItems.length){if(a=this.sortedItems[this.sortedItemsPos][1],u=""+this.sortedItems[this.sortedItemsPos-1][1].id,l=this.state.registry.registry[u].parallel,c=!1,l==a.id){for(r=this.sortedItemsPos-1,o=r;o>-1;o+=-1)if(this.sortedItems[o][1].id==t.id){c=this.sortedItems[o][1].locator;break}h=this.sortedItems[this.sortedItemsPos][1].locator,!c&&h?a.position=s.POSITION_IBID_WITH_LOCATOR:h===c?a.position=s.POSITION_IBID:a.position=s.POSITION_IBID_WITH_LOCATOR}}else{if(!this.state.registry.registry[t.id])return this.try_cite=!1,void(this.force_collapse=!1);this.state.registry.registry[t.id].parallel=!1}this.force_collapse=!1,this.state.registry.registry[t.id].parallel&&(this.force_collapse=!0)}},s.Parallel.prototype.StartVariable=function(t,e){if(this.use_parallels&&(this.try_cite||this.force_collapse)){if("names"===t?this.variable=t+":"+this.target:this.variable=t,this.ignoreVars.indexOf(t)>-1)return;"container-title"===t&&0===this.sets.value().length&&(this.master_was_neutral_cite=!1),this.data={},this.data.value="",this.data.blobs=[];var i=this.isMid(t);"authority"===e&&"names:front"===this.variable?(this.try_cite=!0,this.in_series=!1):"front"===this.target&&i?this.target="mid":"mid"===this.target&&!i&&this.cite.Item.title&&"names"!==t?this.target="back":"back"===this.target&&i&&(this.try_cite=!0,this.in_series=!1),"number"===t?this.cite.front.push(this.variable):s.PARALLEL_COLLAPSING_MID_VARSET.indexOf(t)>-1?["article-journal","article-magazine"].indexOf(this.cite.Item.type)>-1?this.cite.mid.push(this.variable):this.cite.front.push(this.variable):this.cite[this.target].push(this.variable)}},s.Parallel.prototype.AppendBlobPointer=function(t){if(this.use_parallels){if(this.ignoreVars.indexOf(this.variable)>-1)return;if(this.use_parallels&&(this.force_collapse||this.try_cite)){if(["article-journal","article-magazine"].indexOf(this.cite.Item.type)>-1){if(["volume","page","page-first","issue"].indexOf(this.variable)>-1)return;if("container-title"===this.variable&&this.cite.mid.length>1)return}this.variable&&(this.try_cite||this.force_collapse)&&t&&t.blobs&&(this.cite.useProceduralHistory&&"back"===this.target||this.data.blobs.push([t,t.blobs.length]))}}},s.Parallel.prototype.AppendToVariable=function(t,e){if(this.use_parallels){if(this.ignoreVars.indexOf(this.variable)>-1)return;if(this.try_cite||this.force_collapse)if("back"!==this.target,0){var i=this.sets.value()[this.sets.value().length-1];i&&i[this.variable]&&i[this.variable].value&&(this.data.value+="::"+t)}else this.data.value+="::"+t}},s.Parallel.prototype.CloseVariable=function(){if(this.use_parallels){if(this.ignoreVars.indexOf(this.variable)>-1)return;if((this.try_cite||this.force_collapse)&&(this.cite[this.variable]=this.data,this.sets.value().length>0)){var t=this.sets.value()[this.sets.value().length-1];"front"===this.target&&"issued"===this.variable&&this.data.value&&this.master_was_neutral_cite&&(this.target="mid"),"front"===this.target?!t[this.variable]&&!this.data.value||t[this.variable]&&this.data.value===t[this.variable].value||"issued"!==this.variable&&(this.in_series=!1):"mid"===this.target?s.PARALLEL_COLLAPSING_MID_VARSET.indexOf(this.variable)>-1&&(t[this.variable]&&t[this.variable].value===this.data.value?this.cite.front_collapse[this.variable]=!0:this.cite.front_collapse[this.variable]=!1):"back"===this.target&&t[this.variable]&&this.data.value!==t[this.variable].value&&-1===this.sets.value().slice(-1)[0].back_forceme.indexOf(this.variable)&&(this.in_series=!1)}this.variable=!1}},s.Parallel.prototype.CloseCite=function(){var t,e,i,n,s,r,o;if(this.use_parallels&&(this.force_collapse||this.try_cite)){if(n=!1,this.cite.front_collapse["container-title"]||(n=!0),this.cite.front_collapse.volume===!1&&(n=!0),this.cite.front_collapse["collection-number"]===!1&&(n=!0),this.cite.front_collapse.section===!1&&(n=!0),n&&(this.cite.use_journal_info=!0,o=this.cite.front.indexOf("section"),o>-1&&(this.cite.front=this.cite.front.slice(0,o).concat(this.cite.front.slice(o+1))),s=this.cite.front.indexOf("volume"),s>-1&&(this.cite.front=this.cite.front.slice(0,s).concat(this.cite.front.slice(s+1))),r=this.cite.front.indexOf("container-title"),r>-1&&(this.cite.front=this.cite.front.slice(0,r).concat(this.cite.front.slice(r+1))),collection_number_pos=this.cite.front.indexOf("collection-number"),collection_number_pos>-1&&(this.cite.front=this.cite.front.slice(0,collection_number_pos).concat(this.cite.front.slice(collection_number_pos+1)))),this.in_series||this.force_collapse||this.ComposeSet(!0),0===this.sets.value().length){for(has_date=!1,e=0,i=this.cite.back.length;i>e;e+=1)if(t=this.cite.back[e],"issued"===t&&this.cite.issued&&this.cite.issued.value){has_date=!0;break}has_date||this.cite.back_forceme.push("issued")}else{var a=this.cite.front.indexOf("issued");if((-1===a||this.master_was_neutral_cite)&&(this.cite.back_forceme=this.sets.value().slice(-1)[0].back_forceme),a>-1){var l=this.sets.value()[this.sets.value().length-1];l.issued||(this.cite.front=this.cite.front.slice(0,a).concat(this.cite.front.slice(a+1)))}this.master_was_neutral_cite&&this.cite.mid.indexOf("names:mid")>-1&&this.cite.front.push("names:mid")}this.sets.value().push(this.cite)}},s.Parallel.prototype.ComposeSet=function(t){var e,i,n;if(this.use_parallels&&(this.force_collapse||this.try_cite)){var r=this.sets.value().length;if(1===this.sets.value().length)this.in_series||(this.sets.value().pop(),this.delim_counter+=1);else{for(n=this.sets.value().length,i=0;n>i;i+=1)e=this.sets.value()[i],0===i?this.delim_counter+=1:(!e.Item.title&&e.use_journal_info?this.delim_pointers.push(!1):this.delim_pointers.push(this.delim_counter),this.delim_counter+=1),s.POSITION_FIRST===e.position&&(0===i?(this.state.registry.registry[e.itemId].master=!0,this.state.registry.registry[e.itemId].siblings=[],this.state.registry.registry[e.itemId].parallel=!1):e.prevItemID&&(this.state.registry.registry[e.prevItemID].parallel?this.state.registry.registry[e.itemId].parallel=this.state.registry.registry[e.prevItemID].parallel:this.state.registry.registry[e.itemId].parallel=e.prevItemID,this.state.registry.registry[e.itemId].siblings=this.state.registry.registry[e.prevItemID].siblings,this.state.registry.registry[e.itemId].siblings||(this.state.registry.registry[e.itemId].siblings=[],s.debug("WARNING: adding missing siblings array to registry object")),this.state.registry.registry[e.itemId].siblings.push(e.itemId)));this.sets.push([])}2>r?this.purgeGroupsIfParallel(!1):this.purgeGroupsIfParallel(!0),this.in_series=!0}},s.Parallel.prototype.PruneOutputQueue=function(){var t,e,i,n,s,r;if(this.use_parallels)for(t=this.sets.mystack.length,e=0;t>e;e+=1)if(i=this.sets.mystack[e],i.length>1)for(s=i.length,n=0;s>n;n+=1)r=i[n],0===n?this.purgeVariableBlobs(r,r.back):n===i.length-1?this.purgeVariableBlobs(r,r.front.concat(r.back_forceme)):this.purgeVariableBlobs(r,r.front.concat(r.back))},s.Parallel.prototype.purgeVariableBlobs=function(t,e){var i,n,s,r,o,a,l;if(this.use_parallels){for(l=this.state.output.current.value(),"undefined"==typeof l.length&&(l=l.blobs),n=0,i=this.delim_pointers.length;i>n;n+=1)a=this.delim_pointers[n],a!==!1&&(l[a].parallel_delimiter=", ");for(i=e.length-1,n=i;n>-1;n+=-1)if(s=e[n],t[s])for(o=t[s].blobs.length-1,a=o;a>-1;a+=-1)r=t[s].blobs[a],r[0].blobs=r[0].blobs.slice(0,r[1]).concat(r[0].blobs.slice(r[1]+1)),this.state.tmp.has_purged_parallel=!0,r[0]&&r[0].strings&&"string"==typeof r[0].strings.oops&&r[0].parent&&r[0].parent&&(r[0].parent.parent.strings.delimiter=r[0].strings.oops)}},s.Parallel.prototype.purgeGroupsIfParallel=function(t){for(var e=this.parallel_conditional_blobs_list.length-1;e>-1;e+=-1){for(var i=this.parallel_conditional_blobs_list[e],n=!0,s=0,r=i.conditions.length;r>s;s+=1)if(!i.conditions[s]!=!!t&&("master"!==i.conditions[s]||this.state.registry.registry[i.id].master)&&("servant"!==i.conditions[s]||this.state.registry.registry[i.id].parallel)){var n=!1;break}if(n){for(var o=[];i.blobs.length>i.pos;)o.push(i.blobs.pop());for(o.length&&o.pop();o.length;)i.blobs.push(o.pop())}this.parallel_conditional_blobs_list.pop()}},s.Util={},s.Util.Match=function(){this.any=function(t,e,i){return function(t,e){for(var n=0,s=i.length;s>n;n+=1)if(result=i[n](t,e),result)return!0;return!1}},this.none=function(t,e,i){return function(t,e){for(var n=0,s=i.length;s>n;n+=1)if(result=i[n](t,e),result)return!1;return!0}},this.all=function(t,e,i){return function(t,e){for(var n=0,s=i.length;s>n;n+=1)if(result=i[n](t,e),!result)return!1;return!0}},this[void 0]=this.all,this.nand=function(t,e,i){return function(t,e){for(var n=0,s=i.length;s>n;n+=1)if(result=i[n](t,e),!result)return!0;return!1}}},s.Transform=function(t){function e(t,e,i,n,r,o){var a;if(!r)return n;var l=r,u=!1;if(["title","title-short"].indexOf(l)>-1&&!e.jurisdiction&&(u=!0),s.NUMERIC_VARIABLES.indexOf(r)>-1&&(r="number"),["publisher-place","event-place","jurisdiction","archive-place"].indexOf(r)>-1&&(r="place"),["publisher","authority"].indexOf(r)>-1&&(r="institution-part"),["genre","event","medium","title-short"].indexOf(r)>-1&&(r="title"),["archive"].indexOf(r)>-1&&(r="collection-title"),a="",t.sys.getAbbreviation){var c=t.transform.loadAbbreviation(e.jurisdiction,r,n,e.type,u);t.transform.abbrevs[c][r]&&n&&t.sys.getAbbreviation&&t.transform.abbrevs[c][r][n]&&(a=t.transform.abbrevs[c][r][n].replace("{stet}",n))}return a||t.opt.development_extensions.require_explicit_legal_case_title_short&&"legal_case"===e.type||!i||!e[i]||!o||(a=e[i]),a||(a=n),a&&"!here>>>"===a.slice(0,10)&&(a="jurisdiction"===l&&["treaty","patent"].indexOf(l)>-1?a.slice(10):!1),a}function i(e,i){var n,s=t.opt["default-locale"][0].slice(0,2);return n=t.opt.development_extensions.strict_text_case_locales?new RegExp("^([a-zA-Z]{2})(?:$|-.*| .*)"):new RegExp("^([a-zA-Z]{2})(?:$|-.*|.*)"),e.language&&(m=(""+e.language).match(n),s=m?m[1]:"tlh"),e.multi&&e.multi&&e.multi.main&&e.multi.main[i]&&(s=e.multi.main[i]),(!t.opt.development_extensions.strict_text_case_locales||t.opt.development_extensions.normalize_lang_keys_to_lowercase)&&(s=s.toLowerCase()),s}function n(e,n,s,r,o){var a,l,u,c;if(!e[n])return{name:"",usedOrig:o};if(u={name:"",usedOrig:o,locale:i(e,n)},c=t.opt[s],"locale-orig"===s)return u=o?{name:"",usedOrig:o}:{name:e[n],usedOrig:!1,locale:i(e,n)};if(r&&("undefined"==typeof c||0===c.length))return{name:e[n],usedOrig:!0,locale:i(e,n)};for(var h=0,p=c.length;p>h;h+=1){if(a=c[h],l=a.split(/[\-_]/)[0],a&&e.multi&&e.multi._keys[n]&&e.multi._keys[n][a]){u.name=e.multi._keys[n][a],u.locale=l;break}if(l&&e.multi&&e.multi._keys[n]&&e.multi._keys[n][l]){u.name=e.multi._keys[n][l],u.locale=l;break}}return!u.name&&r&&(u={name:e[n],usedOrig:!0,locale:i(e,n)}),u}function r(e,i,n,s,r){if(e||(e="default"),!n)return t.transform.abbrevs[e]||(t.transform.abbrevs[e]=new t.sys.AbbreviationSegments),e;if(t.sys.getAbbreviation){var o=["default"];if("default"!==e)for(var a=e.split(/\s*;\s*/),l=0,u=a.length;u>l;l+=1)o.push(a.slice(0,l+1).join(";"));for(var l=o.length-1;l>-1;l+=-1)if(t.transform.abbrevs[o[l]]||(t.transform.abbrevs[o[l]]=new t.sys.AbbreviationSegments),t.transform.abbrevs[o[l]][i][n]||t.sys.getAbbreviation(t.opt.styleID,t.transform.abbrevs,o[l],i,n,s,r),t.transform.abbrevs[o[l]][i][n]){l<o.length&&(t.transform.abbrevs[e][i][n]=t.transform.abbrevs[o[l]][i][n]);break}}return e}function o(i,n,s,r){var o=i.variables[0];if(t.publisherOutput&&s){if(-1===["publisher","publisher-place"].indexOf(o))return!1;t.publisherOutput[o+"-token"]=i,t.publisherOutput.varlist.push(o);var a=s.split(/;\s*/);a.length===t.publisherOutput[o+"-list"].length&&(t.publisherOutput[o+"-list"]=a);for(var l=0,u=a.length;u>l;l+=1)a[l]=e(t,n,!1,a[l],r,!0);return t.tmp[o+"-token"]=i,!0}return!1}function a(i,r,a,u,c){var h,p=s.LangPrefsMap[i[0]];return h=p?t.opt["cite-lang-prefs"][p]:!1,function(t,a,c,d){var f,m,g,b,y,v,_;if(!i[0]||!a[i[0]]&&!a[u])return null;if(t.opt.suppressJurisdictions&&"jurisdiction"===i[0]&&t.opt.suppressJurisdictions[a.jurisdiction]&&["legal_case","gazette","regulation","legislation"].indexOf(a.type)>-1)return null;var x={primary:!1,secondary:!1,tertiary:!1};if("_sort"===t.tmp.area.slice(-5))x.primary="locale-sort";else if(h)for(var C=["primary","secondary","tertiary"],w=0,S=C.length;S>w&&!(h.length-1<w);w+=1)h[w]&&(x[C[w]]="locale-"+h[w]);else x.primary="locale-orig";if("bibliography"===t.tmp.area||"citation"===t.tmp.area&&"note"===t.opt.xclass&&c&&!c.position||(x.secondary=!1,x.tertiary=!1),t.tmp["publisher-list"])return"publisher"===i[0]?t.tmp["publisher-token"]=this:"publisher-place"===i[0]&&(t.tmp["publisher-place-token"]=this),null;var T=n(a,i[0],x.primary,!0);f=T.name,m=T.locale;var E=T.usedOrig;if(o(this,a,f,r))return null;g=!1,y=!1,x.secondary&&(T=n(a,i[0],x.secondary,!1,T.usedOrig),g=T.name,b=T.locale),x.tertiary&&(T=n(a,i[0],x.tertiary,!1,T.usedOrig),y=T.name,v=T.locale),r&&(f=e(t,a,u,f,r,!0),f&&(f=l(f)),g=e(t,a,!1,g,r,!0),y=e(t,a,!1,y,r,!0));var I,N=s.Util.cloneToken(this),_=s.Util.cloneToken(this);if("locale-translit"===x.primary&&(I=t.opt.citeAffixes[p][x.primary].prefix),"<i>"===I&&"title"===i[0]&&!E){for(var A=!1,w=0,S=_.decorations.length;S>w;w+=1)"@font-style"===_.decorations[w][0]&&"italic"===_.decorations[w][1]&&(A=!0);A||_.decorations.push(["@font-style","italic"])}if("en"!==m&&"title"===_.strings["text-case"]&&(_.strings["text-case"]="passthrough"),"title"===i[0]&&(f=s.demoteNoiseWords(t,f,this["leading-noise-words"])),g||y){if(t.output.openLevel("empty"),_.strings.suffix=_.strings.suffix.replace(/[ .,]+$/,""),t.output.append(f,_),g){secondary_tok=s.Util.cloneToken(N),secondary_tok.strings.prefix=t.opt.citeAffixes[p][x.secondary].prefix,secondary_tok.strings.suffix=t.opt.citeAffixes[p][x.secondary].suffix,secondary_tok.strings.prefix||(secondary_tok.strings.prefix=" ");for(var w=secondary_tok.decorations.length-1;w>-1;w+=-1)["@quotes/true","@font-style/italic","@font-style/oblique","@font-weight/bold"].indexOf(secondary_tok.decorations[w].join("/"))>-1&&(secondary_tok.decorations=secondary_tok.decorations.slice(0,w).concat(secondary_tok.decorations.slice(w+1)));"en"!==b&&"title"===secondary_tok.strings["text-case"]&&(secondary_tok.strings["text-case"]="passthrough"),t.output.append(g,secondary_tok);var O=t.output.current.value(),k=t.output.current.value().blobs.length-1;t.parallel.use_parallels&&(t.parallel.cite.front.push(i[0]+":secondary"),t.parallel.cite[i[0]+":secondary"]={blobs:[[O,k]]})}if(y){tertiary_tok=s.Util.cloneToken(N),tertiary_tok.strings.prefix=t.opt.citeAffixes[p][x.tertiary].prefix,tertiary_tok.strings.suffix=t.opt.citeAffixes[p][x.tertiary].suffix,tertiary_tok.strings.prefix||(tertiary_tok.strings.prefix=" ");for(var w=tertiary_tok.decorations.length-1;w>-1;w+=-1)["@quotes/true","@font-style/italic","@font-style/oblique","@font-weight/bold"].indexOf(tertiary_tok.decorations[w].join("/"))>-1&&(tertiary_tok.decorations=tertiary_tok.decorations.slice(0,w).concat(tertiary_tok.decorations.slice(w+1)));"en"!==v&&"title"===tertiary_tok.strings["text-case"]&&(tertiary_tok.strings["text-case"]="passthrough"),t.output.append(y,tertiary_tok);var O=t.output.current.value(),k=t.output.current.value().blobs.length-1;t.parallel.use_parallels&&(t.parallel.cite.front.push(i[0]+":tertiary"),t.parallel.cite[i[0]+":tertiary"]={blobs:[[O,k]]})}t.output.closeLevel()}else t.output.append(f,_);return null}}function l(e){var i=e.match(/^!([-,_a-z]+)>>>/);if(i){var n=i[1].split(",");
e=e.slice(i[0].length);for(var s=0,r=n.length;r>s;s+=1)-1===t.tmp.done_vars.indexOf(n[s])&&t.tmp.done_vars.push(n[s])}return e}this.abbrevs={},this.abbrevs["default"]=new t.sys.AbbreviationSegments,this.getTextSubField=n,this.loadAbbreviation=r,this.getOutputFunction=a,this.quashCheck=l},s.Token=function(t,e){this.name=t,this.strings={},this.strings.delimiter=void 0,this.strings.prefix="",this.strings.suffix="",this.decorations=[],this.variables=[],this.execs=[],this.tokentype=e,this.evaluator=!1,this.tests=[],this.rawtests=[],this.succeed=!1,this.fail=!1,this.next=!1},s.Util.cloneToken=function(t){var e,i,n,r;if("string"==typeof t)return t;e=new s.Token(t.name,t.tokentype);for(i in t.strings)t.strings.hasOwnProperty(i)&&(e.strings[i]=t.strings[i]);if(t.decorations)for(e.decorations=[],n=0,r=t.decorations.length;r>n;n+=1)e.decorations.push(t.decorations[n].slice());return t.variables&&(e.variables=t.variables.slice()),t.execs&&(e.execs=t.execs.slice(),e.tests=t.tests.slice(),e.rawtests=t.tests.slice()),e},s.AmbigConfig=function(){this.maxvals=[],this.minval=1,this.names=[],this.givens=[],this.year_suffix=!1,this.disambiguate=0},s.Blob=function(t,e,i){var n,s,r;if(this.levelname=i,e){this.strings={prefix:"",suffix:""};for(r in e.strings)e.strings.hasOwnProperty(r)&&(this.strings[r]=e.strings[r]);for(this.decorations=[],n=void 0===e.decorations?0:e.decorations.length,s=0;n>s;s+=1)this.decorations.push(e.decorations[s].slice())}else this.strings={},this.strings.prefix="",this.strings.suffix="",this.strings.delimiter="",this.decorations=[];"string"==typeof t?this.blobs=t:t?this.blobs=[t]:this.blobs=[],this.alldecor=[this.decorations]},s.Blob.prototype.push=function(t){if("string"==typeof this.blobs)throw"Attempt to push blob onto string object";!1!==t&&(t.alldecor=t.alldecor.concat(this.alldecor),this.blobs.push(t))},s.NumericBlob=function(t,e,i){this.id=i,this.alldecor=[],this.num=t,this.blobs=t.toString(),this.status=s.START,this.strings={},e?(this.gender=e.gender,this.decorations=e.decorations,this.strings.prefix=e.strings.prefix,this.strings.suffix=e.strings.suffix,this.strings["text-case"]=e.strings["text-case"],this.successor_prefix=e.successor_prefix,this.range_prefix=e.range_prefix,this.splice_prefix=e.splice_prefix,this.formatter=e.formatter,this.formatter||(this.formatter=new s.Output.DefaultFormatter),this.formatter&&(this.type=this.formatter.format(1))):(this.decorations=[],this.strings.prefix="",this.strings.suffix="",this.successor_prefix="",this.range_prefix="",this.splice_prefix="",this.formatter=new s.Output.DefaultFormatter)},s.NumericBlob.prototype.setFormatter=function(t){this.formatter=t,this.type=this.formatter.format(1)},s.Output.DefaultFormatter=function(){},s.Output.DefaultFormatter.prototype.format=function(t){return t.toString()},s.NumericBlob.prototype.checkNext=function(t,e){e?(this.status=s.START,"object"==typeof t&&(t.num===this.num+1?t.status=s.SUCCESSOR:t.status=s.SEEN)):t&&t.num&&this.type===t.type&&t.num===this.num+1?this.status===s.START||this.status===s.SEEN?t.status=s.SUCCESSOR:(this.status===s.SUCCESSOR||this.status===s.SUCCESSOR_OF_SUCCESSOR)&&(this.range_prefix?(t.status=s.SUCCESSOR_OF_SUCCESSOR,this.status=s.SUPPRESS):t.status=s.SUCCESSOR):(this.status===s.SUCCESSOR_OF_SUCCESSOR&&(this.status=s.END),"object"==typeof t&&(t.status=s.SEEN))},s.NumericBlob.prototype.checkLast=function(t){return this.status===s.SEEN||t.num!==this.num-1&&this.status===s.SUCCESSOR?(this.status=s.SUCCESSOR,!0):!1},s.Util.fixDateNode=function(t,e,i){var n,s,r,o,a,l,u,c,h,p,d,f,m,g;this.build.date_key=!0,n=this.sys.xml.getAttributeValue(i,"form");var b;if(b="accessed"===this.sys.xml.getAttributeValue(i,"variable")?this.opt["default-locale"][0]:this.sys.xml.getAttributeValue(i,"lingo"),!this.getDate(n))return t;var y=this.sys.xml.getAttributeValue(i,"date-parts");s=this.sys.xml.getAttributeValue(i,"variable"),c=this.sys.xml.getAttributeValue(i,"prefix"),h=this.sys.xml.getAttributeValue(i,"suffix"),m=this.sys.xml.getAttributeValue(i,"display"),g=this.sys.xml.getAttributeValue(i,"cslid"),r=this.sys.xml.nodeCopy(this.getDate(n,"accessed"===s)),this.sys.xml.setAttribute(r,"lingo",this.opt.lang),this.sys.xml.setAttribute(r,"form",n),this.sys.xml.setAttribute(r,"date-parts",y),this.sys.xml.setAttribute(r,"cslid",g),this.sys.xml.setAttribute(r,"variable",s),c&&this.sys.xml.setAttribute(r,"prefix",c),h&&this.sys.xml.setAttribute(r,"suffix",h),m&&this.sys.xml.setAttribute(r,"display",m),p=this.sys.xml.children(i);for(d in p)if(o=p[d],"date-part"===this.sys.xml.nodename(o)){a=this.sys.xml.getAttributeValue(o,"name"),f=this.sys.xml.attributes(o);for(l in f)if(f.hasOwnProperty(l)){if("@name"===l)continue;if(b&&b!==this.opt.lang&&["@suffix","@prefix","@form"].indexOf(l)>-1)continue;u=f[l],this.sys.xml.setAttributeOnNodeIdentifiedByNameAttribute(r,"date-part",a,l,u)}}return"year"===this.sys.xml.getAttributeValue(i,"date-parts")?(this.sys.xml.deleteNodeByNameAttribute(r,"month"),this.sys.xml.deleteNodeByNameAttribute(r,"day")):"year-month"===this.sys.xml.getAttributeValue(i,"date-parts")&&this.sys.xml.deleteNodeByNameAttribute(r,"day"),this.sys.xml.insertChildNodeAfter(t,i,e,r)},s.dateMacroAsSortKey=function(t,e){s.dateAsSortKey.call(this,t,e,!0)},s.dateAsSortKey=function(t,e,i){var n,r,o,a,l,u,c,h,p=this.variables[0],d="empty";for(i&&(d="macro-with-date"),n=e[p],"undefined"==typeof n&&(n={"date-parts":[[0]]},n.year||(t.tmp.empty_date=!0)),"undefined"==typeof this.dateparts&&(this.dateparts=["year","month","day"]),n.raw?n=t.fun.dateparser.parse(n.raw):n["date-parts"]&&(n=t.dateParseArray(n)),"undefined"==typeof n&&(n={}),c=0,h=s.DATE_PARTS_INTERNAL.length;h>c;c+=1)r=s.DATE_PARTS_INTERNAL[c],o=0,a=r,"_end"===a.slice(-4)&&(a=a.slice(0,-4)),n[r]&&this.dateparts.indexOf(a)>-1&&(o=n[r]),"year"===r.slice(0,4)?(l=s.Util.Dates[a].numeric(t,o),u="Y","-"===l[0]&&(u="X",l=l.slice(1),l=9999-parseInt(l,10)),t.output.append(s.Util.Dates[r.slice(0,4)].numeric(t,u+l),d)):(o=s.Util.Dates[a]["numeric-leading-zeros"](t,o),o||(o="00"),t.output.append(o,d))},s.Engine.prototype.dateParseArray=function(t){var e,i,n,r;e={};for(i in t)if("date-parts"===i){n=t["date-parts"],n.length>1&&n[0].length!==n[1].length&&s.error("CSL data error: element mismatch in date range input."),r=["","_end"];for(var o=0,a=n.length;a>o;o+=1)for(var l=0,u=s.DATE_PARTS.length;u>l;l+=1)"undefined"==typeof n[o][l]?e[s.DATE_PARTS[l]+r[o]]=n[o][l]:e[s.DATE_PARTS[l]+r[o]]=parseInt(n[o][l],10)}else t.hasOwnProperty(i)&&("literal"===i&&"object"==typeof t.literal&&"string"==typeof t.literal.part?(s.debug("Warning: fixing up weird literal date value"),e.literal=t.literal.part):e[i]=t[i]);return e},s.Util.Names={},s.Util.Names.compareNamesets=s.NameOutput.prototype._compareNamesets,s.Util.Names.unInitialize=function(t,e){var i,n,r,o,a;if(!e)return"";for(r=e.split(/(?:\-|\s+)/),o=e.match(/(\-|\s+)/g),a="",i=0,n=r.length;n>i;i+=1)s.ALL_ROMANESQUE_REGEXP.exec(r[i].slice(0,-1))&&r[i]&&r[i]!==r[i].toUpperCase()&&(r[i]=r[i].slice(0,1)+r[i].slice(1,2).toLowerCase()+r[i].slice(2)),a+=r[i],n-1>i&&(a+=o[i]);return a},s.Util.Names.initializeWith=function(t,e,i,n){var r,o,a,l,u,c,h;if(!e)return"";if(["Lord","Lady"].indexOf(e)>-1||!e.match(s.STARTSWITH_ROMANESQUE_REGEXP)&&!i.match("%s"))return e;i||(i="");var p=e;if(t.opt["initialize-with-hyphen"]===!1&&(p=p.replace(/\-/g," ")),p=p.replace(/\s*\-\s*/g,"-").replace(/\s+/g," "),p=p.replace(/-([a-z])/g,"–$1"),u=p.match(/[\-\s]+/g),c=p.split(/[\-\s]+/),0===c.length)p=u;else for(p=[c[0]],r=1,o=c.length;o>r;r+=1)p.push(u[r-1]),p.push(c[r]);for(c=p,r=c.length-1;r>-1;r+=-1)if(c[r]&&c[r].slice(0,-1).indexOf(".")>-1){var d=c.slice(r+1),f=c[r].slice(0,-1).split(".");for(c=c.slice(0,r),a=0,l=f.length;l>a;a+=1)c.push(f[a]+"."),a<f.length-1&&c.push(" ");c=c.concat(d)}return h=n?s.Util.Names.doNormalize(t,c,i):s.Util.Names.doInitialize(t,c,i),h=h.replace(/\u2013([a-z])/g,"-$1")},s.Util.Names.doNormalize=function(t,e,i,n){var r,o,a=[];for(r=0,o=e.length;o>r;r+=1)e[r].length>1&&"."===e[r].slice(-1)?(e[r]=e[r].slice(0,-1),a.push(!0)):1===e[r].length&&e[r].toUpperCase()===e[r]?a.push(!0):a.push(!1);for(r=0,o=e.length;o>r;r+=2)a[r]&&(r<e.length-2&&(e[r+1]="",(!i||i.slice(-1)&&" "!==i.slice(-1))&&e[r].length&&e[r].match(s.ALL_ROMANESQUE_REGEXP)&&(e[r].length>1||e[r+2].length>1)&&(e[r+1]=" "),e[r]=e[r]+i),r===e.length-1&&(e[r]=e[r]+i));return e.join("").replace(/\s+$/,"")},s.Util.Names.doInitialize=function(t,e,i,n){var r,o,a,l,u,c,h;for(r=0,o=e.length;o>r;r+=2)if(h=e[r])if(a=h.match(s.NAME_INITIAL_REGEXP),!a&&!h.match(s.STARTSWITH_ROMANESQUE_REGEXP)&&h.length>1&&i.match("%s")&&(a=h.match(/(.)(.*)/)),a&&a[1]===a[1].toUpperCase()){var p="";if(a[2]){var d="";for(c=a[2].split(""),l=0,u=c.length;u>l;l+=1){var f=c[l];if(f!==f.toUpperCase())break;d+=f}d.length<a[2].length&&(p=d.toLocaleLowerCase())}e[r]=a[1].toLocaleUpperCase()+p,o-1>r?i.match("%s")?e[r]=i.replace("%s",e[r]):e[r+1].indexOf("-")>-1?e[r+1]=i+e[r+1]:e[r+1]=i:i.match("%s")?e[r]=i.replace("%s",e[r]):e.push(i)}else h.match(s.ROMANESQUE_REGEXP)&&(e[r]=" "+h);var m=e.join("");return m=m.replace(/\s+$/,"").replace(/\s*\-\s*/g,"-").replace(/\s+/g," ")},s.Util.Names.getRawName=function(t){var e=[];return t.given&&e.push(t.given),t.family&&e.push(t.family),e.join(" ")},s.Util.Dates={},s.Util.Dates.year={},s.Util.Dates.year["long"]=function(t,e){return e||(e="boolean"==typeof e?"":0),e.toString()},s.Util.Dates.year.imperial=function(t,e,i,n){e||(e="boolean"==typeof e?"":0),i=i?"_end":"";var s=t.tmp.date_object["month"+i];for(s=s?""+s:"1";s.length<2;)s="0"+s;var r=t.tmp.date_object["day"+i];for(r=r?""+r:"1";r.length<2;)r="0"+r;var o,a,l=parseInt(e+s+r,10);return l>=18680908&&19120730>l?(o="明治",a=1867):l>=19120730&&19261225>l?(o="大正",a=1911):l>=19261225&&19890108>l?(o="昭和",a=1925):l>=19890108&&(o="平成",a=1988),o&&a&&(t.transform.abbrevs["default"].number[o]||t.transform.loadAbbreviation("default","number",o),t.transform.abbrevs["default"].number[o]&&(o=t.transform.abbrevs["default"].number[o]),year=o+(e-a)),year},s.Util.Dates.year["short"]=function(t,e){return e=e.toString(),e&&4===e.length?e.substr(2):void 0},s.Util.Dates.year.numeric=function(t,e){var i,n;for(e=""+e,i=e.match(/([0-9]*)$/),i?(n=e.slice(0,-1*i[1].length),e=i[1]):(n=e,e="");e.length<4;)e="0"+e;return n+e},s.Util.Dates.normalizeMonth=function(t,e){var i;if(t||(t=0),t=""+t,t.match(/^[0-9]+$/)||(t=0),t=parseInt(t,10),e){var n={stub:"month-",num:t};n.num<1||n.num>20?n.num=0:n.num>16?(n.stub="season-",n.num=n.num-16):n.num>12&&(n.stub="season-",n.num=n.num-12),i=n}else(1>t||t>12)&&(t=0),i=t;return i},s.Util.Dates.month={},s.Util.Dates.month.numeric=function(t,e){var e=s.Util.Dates.normalizeMonth(e);return e||(e=""),e},s.Util.Dates.month["numeric-leading-zeros"]=function(t,e){var e=s.Util.Dates.normalizeMonth(e);if(e)for(e=""+e;e.length<2;)e="0"+e;else e="";return e},s.Util.Dates.month["long"]=function(t,e,i,n){var r=s.Util.Dates.normalizeMonth(e,!0),e=r.num;if(e){for(e=""+e;e.length<2;)e="0"+e;e=t.getTerm(r.stub+e,"long",0,0,!1,n)}else e="";return e},s.Util.Dates.month["short"]=function(t,e,i,n){var r=s.Util.Dates.normalizeMonth(e,!0),e=r.num;if(e){for(e=""+e;e.length<2;)e="0"+e;e=t.getTerm(r.stub+e,"short",0,0,!1,n)}else e="";return e},s.Util.Dates.day={},s.Util.Dates.day.numeric=function(t,e){return e.toString()},s.Util.Dates.day["long"]=s.Util.Dates.day.numeric,s.Util.Dates.day["numeric-leading-zeros"]=function(t,e){for(e||(e=0),e=e.toString();e.length<2;)e="0"+e;return e.toString()},s.Util.Dates.day.ordinal=function(t,e,i){return t.fun.ordinalizer.format(e,i)},s.Util.Sort={},s.Util.Sort.strip_prepositions=function(t){var e;return"string"==typeof t&&(e=t.toLocaleLowerCase(),e=t.match(/^((a|an|the)\s+)/)),e&&(t=t.substr(e[1].length)),t},s.Util.substituteStart=function(t,e){var i,n,r,o,a,l,u;o=function(t,e){for(var i=0,n=this.decorations.length;n>i;i+=1)if("@strip-periods"===this.decorations[i][0]&&"true"===this.decorations[i][1]){t.tmp.strip_periods+=1;break}},this.execs.push(o),this.decorations&&(t.opt.development_extensions.csl_reverse_lookup_support||t.sys.csl_reverse_lookup_support)&&(this.decorations.reverse(),this.decorations.push(["@showid","true",this.cslid]),this.decorations.reverse()),u=["number","date","names"],("text"===this.name&&!this.postponed_macro||u.indexOf(this.name)>-1)&&(i=function(t,e,i){"author"===t.tmp.element_trace.value()||"names"===this.name?i&&i["author-only"]?t.tmp.element_trace.push("do-not-suppress-me"):i&&i["suppress-author"]:i&&i["author-only"]?t.tmp.element_trace.push("suppress-me"):i&&i["suppress-author"]&&t.tmp.element_trace.push("do-not-suppress-me")},this.execs.push(i)),n=this.strings.cls,this.strings.cls=!1,0===t.build.render_nesting_level&&("bibliography"===t.build.area&&t.bibliography.opt["second-field-align"]?(r=new s.Token("group",s.START),r.decorations=[["@display","left-margin"]],o=function(t,e){t.tmp.render_seen||(r.strings.first_blob=e.id,t.output.startTag("bib_first",r))},r.execs.push(o),e.push(r)):s.DISPLAY_CLASSES.indexOf(n)>-1&&(r=new s.Token("group",s.START),r.decorations=[["@display",n]],o=function(t,e){r.strings.first_blob=e.id,t.output.startTag("bib_first",r)},r.execs.push(o),e.push(r)),t.build.cls=n),t.build.render_nesting_level+=1,1===t.build.substitute_level.value()&&(a=new s.Token("choose",s.START),s.Node.choose.build.call(a,t,e),l=new s.Token("if",s.START),o=function(e,i){return t.tmp.can_substitute.value()?!0:!1},l.tests.push(o),l.test=t.fun.match.any(this,t,l.tests),e.push(l)),t.sys.variableWrapper&&this.variables_real&&this.variables_real.length&&(o=function(t,e,i){if(!t.tmp.just_looking&&!t.tmp.suppress_decorations){variable_entry=new s.Token("text",s.START),variable_entry.decorations=[["@showid","true"]],t.output.startTag("variable_entry",variable_entry);var n=null;i&&(n=i.position),n||(n=0);var r=["first","subsequent","ibid","ibid-with-locator"],o=0;i&&i.noteIndex&&(o=i.noteIndex);var a=0;i&&i["first-reference-note-number"]&&(a=i["first-reference-note-number"]);var l=0;i&&i["citation-number"]&&(l=i["citation-number"]);var u=0;i&&i.index&&(u=i.index);var c={itemData:e,variableNames:this.variables,context:t.tmp.area,xclass:t.opt.xclass,position:r[n],"note-number":o,"first-reference-note-number":a,"citation-number":l,index:u,mode:t.opt.mode};t.output.current.value().params=c}},this.execs.push(o))},s.Util.substituteEnd=function(t,e){var i,n,r,o,a,l,u,c,h;t.sys.variableWrapper&&(this.hasVariable||this.variables_real&&this.variables_real.length)&&(i=function(t,e){t.tmp.just_looking||t.tmp.suppress_decorations||t.output.endTag("variable_entry")},this.execs.push(i)),i=function(t,e){for(var i=0,n=this.decorations.length;n>i;i+=1)if("@strip-periods"===this.decorations[i][0]&&"true"===this.decorations[i][1]){t.tmp.strip_periods+=-1;break}},this.execs.push(i),t.build.render_nesting_level+=-1,0===t.build.render_nesting_level&&(t.build.cls?(i=function(t,e){t.output.endTag("bib_first")},this.execs.push(i),t.build.cls=!1):"bibliography"===t.build.area&&t.bibliography.opt["second-field-align"]&&(n=new s.Token("group",s.END),i=function(t,e){t.tmp.render_seen||t.output.endTag()},n.execs.push(i),e.push(n),r=new s.Token("group",s.START),r.decorations=[["@display","right-inline"]],i=function(t,e){t.tmp.render_seen||(t.tmp.render_seen=!0,t.output.startTag("bib_other",r))},r.execs.push(i),e.push(r))),1===t.build.substitute_level.value()&&(o=new s.Token("if",s.END),e.push(o),a=new s.Token("choose",s.END),s.Node.choose.build.call(a,t,e)),l="names"===this.name&&0===t.build.substitute_level.value(),u="string"==typeof t[t.build.area].opt["subsequent-author-substitute"];var p=t[t.build.area].opt["subsequent-author-substitute-rule"];l&&u&&(c=new s.Token("text",s.SINGLETON),i=function(t,e){var i,n,r=!t.tmp.suppress_decorations;if(r&&"bibliography"===t.tmp.area&&t.tmp.subsequent_author_substitute_ok&&t.tmp.rendered_name)if("partial-each"===p||"partial-first"===p){var o=!0,a=[];for(i=0,n=t.tmp.name_node.children.length;n>i;i+=1){var l=t.tmp.rendered_name[i];o&&t.tmp.last_rendered_name&&t.tmp.last_rendered_name.length>i-1&&l&&!l.localeCompare(t.tmp.last_rendered_name[i])?(h=new s.Blob(t[t.tmp.area].opt["subsequent-author-substitute"]),t.tmp.name_node.children[i].blobs=[h],"partial-first"===p&&(o=!1)):o=!1,a.push(l)}t.tmp.last_rendered_name=a}else if("complete-each"===p){var a=t.tmp.rendered_name.join(",");if(a){if(!a.localeCompare(t.tmp.last_rendered_name))for(i=0,n=t.tmp.name_node.children.length;n>i;i+=1)h=new s.Blob(t[t.tmp.area].opt["subsequent-author-substitute"]),t.tmp.name_node.children[i].blobs=[h];t.tmp.last_rendered_name=a}}else{var a=t.tmp.rendered_name.join(",");a&&(a.localeCompare(t.tmp.last_rendered_name)||(h=new s.Blob(t[t.tmp.area].opt["subsequent-author-substitute"]),t.tmp.label_blob?t.tmp.name_node.top.blobs=[h,t.tmp.label_blob]:t.tmp.name_node.top.blobs=[h]),t.tmp.last_rendered_name=a)}},c.execs.push(i),e.push(c)),("text"===this.name&&!this.postponed_macro||["number","date","names"].indexOf(this.name)>-1)&&(i=function(t,e){t.tmp.element_trace.pop()},this.execs.push(i))},s.Util.padding=function(t){var e=t.match(/\s*(-{0,1}[0-9]+)/);if(e)for(t=parseInt(e[1],10),0>t&&(t=1e20+t),t=""+t;t.length<20;)t="0"+t;return t},s.Util.LongOrdinalizer=function(){},s.Util.LongOrdinalizer.prototype.init=function(t){this.state=t},s.Util.LongOrdinalizer.prototype.format=function(t,e){10>t&&(t="0"+t);var i=s.Engine.getField(s.LOOSE,this.state.locale[this.state.opt.lang].terms,"long-ordinal-"+t,"long",0,e);return i||(i=this.state.fun.ordinalizer.format(t,e)),this.state.tmp.cite_renders_content=!0,i},s.Util.Ordinalizer=function(t){this.state=t,this.suffixes={}},s.Util.Ordinalizer.prototype.init=function(){if(!this.suffixes[this.state.opt.lang]){this.suffixes[this.state.opt.lang]={};for(var t=0,e=3;e>t;t+=1){var i=[void 0,"masculine","feminine"][t];this.suffixes[this.state.opt.lang][i]=[];for(var n=1;5>n;n+=1){var s=this.state.getTerm("ordinal-0"+n,"long",!1,i);if("undefined"==typeof s){delete this.suffixes[this.state.opt.lang][i];break}this.suffixes[this.state.opt.lang][i].push(s)}}}},s.Util.Ordinalizer.prototype.format=function(t,e){var i;t=parseInt(t,10),i=""+t;var n="",s=[];if(e&&s.push(e),s.push("neuter"),this.state.locale[this.state.opt.lang].ord["1.0.1"]){n=this.state.getTerm("ordinal",!1,0,e);for(var r,o=0,a=s.length;a>o;o+=1){r=s[o];var l=this.state.locale[this.state.opt.lang].ord["1.0.1"];if(l["whole-number"][i]&&l["whole-number"][i][r]?n=this.state.getTerm(this.state.locale[this.state.opt.lang].ord["1.0.1"]["whole-number"][i][r],!1,0,e):l["last-two-digits"][i.slice(i.length-2)]&&l["last-two-digits"][i.slice(i.length-2)][r]?n=this.state.getTerm(this.state.locale[this.state.opt.lang].ord["1.0.1"]["last-two-digits"][i.slice(i.length-2)][r],!1,0,e):l["last-digit"][i.slice(i.length-1)]&&l["last-digit"][i.slice(i.length-1)][r]&&(n=this.state.getTerm(this.state.locale[this.state.opt.lang].ord["1.0.1"]["last-digit"][i.slice(i.length-1)][r],!1,0,e)),n)break}}else e||(e=void 0),this.state.fun.ordinalizer.init(),n=t/10%10===1||t>10&&20>t?this.suffixes[this.state.opt.lang][e][3]:t%10===1&&t%100!==11?this.suffixes[this.state.opt.lang][e][0]:t%10===2&&t%100!==12?this.suffixes[this.state.opt.lang][e][1]:t%10===3&&t%100!==13?this.suffixes[this.state.opt.lang][e][2]:this.suffixes[this.state.opt.lang][e][3];return i=i+=n},s.Util.Romanizer=function(){},s.Util.Romanizer.prototype.format=function(t){var e,i,n,r,o;if(e="",6e3>t)for(r=t.toString().split(""),r.reverse(),i=0,n=0,o=r.length,i=0;o>i;i+=1)n=parseInt(r[i],10),e=s.ROMAN_NUMERALS[i][n]+e;return e},s.Util.Suffixator=function(t){t||(t=s.SUFFIX_CHARS),this.slist=t.split(",")},s.Util.Suffixator.prototype.format=function(t){var e;t+=1;var i="";do e=t%26===0?26:t%26,i=this.slist[e-1]+i,t=(t-e)/26;while(0!==t);return i},s.Engine.prototype.processNumber=function(t,e,i,n){var r,o,a,l,u,c;if(this.tmp.shadow_numbers[i]){if(this.tmp.shadow_numbers[i].numeric)for(var a=0,l=this.tmp.shadow_numbers[i].values.length;l>a;a+=2)this.tmp.shadow_numbers[i].values[a][2]=t}else if(this.tmp.shadow_numbers[i]={},this.tmp.shadow_numbers[i].values=[],this.tmp.shadow_numbers[i].plural=0,this.tmp.shadow_numbers[i].numeric=!1,this.tmp.shadow_numbers[i].label=!1,e){var h=s.LangPrefsMap[i];if(h){var p=this.opt["cite-lang-prefs"][h][0];r=this.transform.getTextSubField(e,i,"locale-"+p,!0),r=r.name}else r=e[i];if(r&&this.sys.getAbbreviation){r=(""+r).replace(/^\"/,"").replace(/\"$/,"");var d=this.transform.loadAbbreviation(e.jurisdiction,"number",r);this.transform.abbrevs[d].number[r]?r=this.transform.abbrevs[d].number[r]:"undefined"!=typeof this.transform.abbrevs[d].number[r]&&delete this.transform.abbrevs[d].number[r]}if("undefined"!=typeof r){if("number"==typeof r&&(r=""+r),this.tmp.shadow_numbers[i].label=i,'"'===r.slice(0,1)&&'"'===r.slice(-1)&&(r=r.slice(1,-1)),r&&["number-of-volumes","number-of-pages"].indexOf(i)>-1){var o=r.match(/[^0-9]*([0-9]+).*/);o&&(this.tmp.shadow_numbers[i].numeric=!0,"1"!==o[1]&&(this.tmp.shadow_numbers[i].plural=1))}"locator"===i&&["bill","gazette","legislation","treaty"].indexOf(n)>-1&&(r=r.split(s.STATUTE_SUBDIV_PLAIN_REGEX)[0]);var f="page";if(["bill","gazette","legislation","legal_case","treaty"].indexOf(n)>-1&&"collection-number"===i&&(f="year"),["page","page-first"].indexOf(i)>-1){var o=r.split(" ")[0].match(s.STATUTE_SUBDIV_GROUPED_REGEX);if(o){this.opt.development_extensions.static_statute_locator&&(this.tmp.shadow_numbers[i].label=s.STATUTE_SUBDIV_STRINGS[o[0]]);var m=r.match(/[^ ]+\s+(.*)/);m&&(r=m[1])}}for(var g=r.split(/(?:,\s+|\s*\\*[\-\u2013]+\s*|\s*&\s*)/),o=r.match(/(,\s+|\s*\\*[\-\u2013]+\s*|\s*&\s*)/g),b=[],a=0,l=g.length-1;l>a;a+=1)b.push(g[a]),b.push(o[a]);b.push(g[g.length-1]);for(var y=0,v=!0,a=0,l=b.length;l>a;a+=1){var _=a%2===0;if(_){if(b[a]){if(b[a].match(/(?:[0-9]|[xivcmlXIVCML])/))if(b[a-1]&&b[a-1].match(/^\s*\\*[\-\u2013]+\s*$/)){var x=this.tmp.shadow_numbers[i].values.slice(-1);if(-1==x[0][1].indexOf("\\")){if(b[a-2]&&(""+b[a-2]).match(/(:?[a-zA-Z]*[0-9]+$|^[ivxlcmIVXLCM]+$)/)&&b[a].match(/(?:^[a-zA-Z]*[0-9]+|^[ivxlcmIVXLCM]+$)/)){var C=this.tmp.shadow_numbers[i].values.slice(-2);if(x[0][1]=this.getTerm(f+"-range-delimiter"),this.opt[f+"-range-format"]){var w=this.fun[f+"_mangler"](C[0][1]+"-"+b[a]);w=w.split(this.getTerm(f+"-range-delimiter")),b[a]=w[1]}y+=1}x[0][1].indexOf("--")>-1&&(x[0][1]=x[0][1].replace(/--*/,"–"))}else x[0][1]=x[0][1].replace(/\\/,"","g")}else-1===b[a].indexOf(" ")&&(y+=1);for(var S=b[a].split(/\s+/),u=0,c=S.length;c>u;u+=1)this.opt.development_extensions.strict_page_numbers&&"page"===i&&!S[u].match(/^-*[0-9]/)?v=!1:S[u].match(/[-0-9]/)||(v=!1);if(b[a].match(/^[1-9][0-9]*$/))b[a]=parseInt(b[a],10),t&&"undefined"==typeof t.gender&&(t.gender=this.locale[this.opt.lang]["noun-genders"][i],t.gender||(t.gender="")),this.tmp.shadow_numbers[i].values.push(["NumericBlob",b[a],t]);else{var T=b[a];this.tmp.shadow_numbers[i].values.push(["Blob",T,t])}}}else b[a]&&this.tmp.shadow_numbers[i].values.push(["Blob",b[a],void 0])}this.opt.development_extensions.strict_page_numbers&&"page"===i?-1===r.indexOf(" ")&&r.match(/^-*[0-9]/)?this.tmp.shadow_numbers[i].numeric=!0:this.tmp.shadow_numbers[i].numeric=v:-1===r.indexOf(" ")&&r.match(/[0-9]/)?this.tmp.shadow_numbers[i].numeric=!0:this.tmp.shadow_numbers[i].numeric=v,this.tmp.shadow_numbers[i].numeric||this.transform.loadAbbreviation(e.jurisdiction,"number",r),y>1&&(this.tmp.shadow_numbers[i].plural=1),1===e.force_pluralism?this.tmp.shadow_numbers[i].plural=1:0===e.force_pluralism&&(this.tmp.shadow_numbers[i].plural=0)}}},s.Util.PageRangeMangler={},s.Util.PageRangeMangler.getFunction=function(t,e){var i,n,s,r,o,a,l,u,c,h,p,d,f,m,g,b,y,v=t.getTerm(e+"-range-delimiter");i=/([a-zA-Z]*)([0-9]+)\s*(?:\u2013|-)\s*([a-zA-Z]*)([0-9]+)/,r=function(i){for(s=i.length,n=1;s>n;n+=2)"object"==typeof i[n]&&(i[n]=i[n].join(""));var r=i.join("");return r=r.replace(/([^\\])\-/g,"$1"+t.getTerm(e+"-range-delimiter"))},o=function(t){var e,i,r,o="\\s+\\-\\s+",a=new RegExp("([^\\\\])["+v+"\\u2013]","g");t=t.replace(a,"$1 - ").replace(/\s+-\s+/g," - ");var l=new RegExp("([a-zA-Z]*[0-9]+"+o+"[a-zA-Z]*[0-9]+)","g"),u=new RegExp("[a-zA-Z]*[0-9]+"+o+"[a-zA-Z]*[0-9]+");if(e=t.match(l),i=t.split(u),0===i.length)r=e;else for(r=[i[0]],n=1,s=i.length;s>n;n+=1)r.push(e[n-1].replace(/\s*\-\s*/,"-","g")),r.push(i[n]);return r},a=function(t){for(t=""+t,h=o(t),s=h.length,n=1;s>n;n+=2)p=h[n].match(i),p&&(p[3]&&p[1]!==p[3]||(p[4].length<p[2].length&&(p[4]=p[2].slice(0,p[2].length-p[4].length)+p[4]),parseInt(p[2],10)<parseInt(p[4],10)&&(p[3]=v+p[1],h[n]=p.slice(1)))),"string"==typeof h[n]&&(h[n]=h[n].replace("-",v,"g"));return h},l=function(t,e,i){s=t.length;for(var n=1,o=t.length;o>n;n+=2)t[n][3]=u(t[n][1],t[n][3],e,i),t[n][2].slice(1)===t[n][0]&&(t[n][2]=v);return r(t)},u=function(t,e,i,n){if(i||(i=0),d=(""+t).split(""),f=(""+e).split(""),m=f.slice(),m.reverse(),d.length===f.length)for(var s=0,r=d.length;r>s;s+=1){if(!(d[s]===f[s]&&m.length>i)){if(i&&n&&3===m.length){var o=d.slice(0,s);o.reverse(),m=m.concat(o)}break}m.pop()}return m.reverse(),m.join("")},c=function(t){for(s=t.length,n=1;s>n;n+=2)"object"==typeof t[n]&&(p=t[n],g=parseInt(p[1],10),b=parseInt(p[3],10),g>100&&g%100&&parseInt(g/100,10)===parseInt(b/100,10)?p[3]=""+b%100:g>=1e4&&(p[3]=""+b%1e3)),p[2].slice(1)===p[0]&&(p[2]=v);return r(t)};var _=function(t,e,i,n){var s;t=""+t;var r=a(t),s=e(r,i,n);return s};return t.opt[e+"-range-format"]?"expanded"===t.opt[e+"-range-format"]?y=function(t){return _(t,r)}:"minimal"===t.opt[e+"-range-format"]?y=function(t){return _(t,l)}:"minimal-two"===t.opt[e+"-range-format"]?y=function(t,e){return _(t,l,2,e)}:"chicago"===t.opt[e+"-range-format"]&&(y=function(t){return _(t,c)}):y=function(t){return t},y},s.Util.FlipFlopper=function(t){var e,i,n,s,r,o,a,l,u,c,h,p,d,f,m,g,b,y;for(this.state=t,this.blob=!1,this.quotechars=['"',"'"],e=[["<i>","</i>","italics","@font-style",["italic","normal","normal"],!0],["<b>","</b>","bold","@font-weight",["bold","normal","normal"],!0],["<sup>","</sup>","superscript","@vertical-align",["sup","sup","baseline"],!0],["<sub>","</sub>","subscript","@vertical-align",["sub","sub","baseline"],!0],["<sc>","</sc>","smallcaps","@font-variant",["small-caps","small-caps","normal"],!0],['<span style="font-variant:small-caps;">',"</span>","smallcaps","@font-variant",["small-caps","normal","normal"],!0],['<span class="nocase">',"</span>","passthrough","@passthrough",["true","true","true"],!0],['<span class="nodecor">',"</span>","passthrough","@passthrough",["true","true","true"],!0],['"','"',"quotes","@quotes",["true","inner","true"],"'"],[" '","'","quotes","@quotes",["inner","true","true"],'"']],i=0;2>i;i+=1){s=["-","-inner-"][i],r=[];var v=t.getTerm("open"+s+"quote");r.push(v),this.quotechars.push(v);var _=t.getTerm("close"+s+"quote");r.push(_),this.quotechars.push(_),r.push("quotes"),r.push("@quotes"),"-"===s?r.push(["true","inner"]):r.push(["inner","true"]),r.push(!0),"-"===s?r.push(t.getTerm("close-inner-quote")):r.push(t.getTerm("close-quote")),e.push(r)}for(o=function(t){for(a=[],n=t.length,i=0;n>i;i+=1)l=t[i],-1===a.indexOf(l[0])&&(u="",["(",")","[","]"].indexOf(l[0])>-1&&(u="\\"),a.push(u+l[0])),-1===a.indexOf(l[1])&&(u="",["(",")","[","]"].indexOf(l[1])>-1&&(u="\\"),a.push(u+l[1]));return a},b=o(e),y=[],i=0,n=b.length;n>i;i+=1)b[i]&&y.push(b[i]);b=y.slice(),this.allTagsRexMatch=new RegExp("("+b.join("|")+")","g"),this.allTagsRexSplit=new RegExp("(?:"+b.join("|")+")"),c=function(t){for(h={},p={},d={},f={},m={},n=t.length,i=0;n>i;i+=1)h[t[i][1]]=!0,p[t[i][1]]=t[i][5],d[t[i][0]]=t[i][1],f[t[i][0]]=[t[i][3],t[i][4]],m[t[i][3]]=[t[i][3],[t[i][4][2],t[i][1]]];return[h,p,d,f,m]},g=c(e),this.closeTagsHash=g[0],this.flipTagsHash=g[1],this.openToCloseHash=g[2],this.openToDecorations=g[3],this.okReverseHash=g[4]},s.Util.FlipFlopper.prototype.init=function(t,e){this.txt_esc=s.getSafeEscape(this.state),e?(this.blob=e,this.strs=this.getSplitStrings(this.blob.blobs),this.blob.blobs=[]):(this.strs=this.getSplitStrings(t),this.blob=new s.Blob),this.blobstack=new s.Stack(this.blob)},s.Util.FlipFlopper.prototype._normalizeString=function(t){var e,i;if(t=t.replace(/\s+'\s+/," â€™ ","g"),t.indexOf(this.quotechars[0])>-1)for(e=0,i=2;i>e;e+=1)this.quotechars[e+2]&&(t=t.replace(this.quotechars[e+2],this.quotechars[0]));if(t.indexOf(this.quotechars[1])>-1)for(e=0,i=2;i>e;e+=1)this.quotechars[e+4]&&(t=0===e?t.replace(this.quotechars[e+4]," "+this.quotechars[1]):t.replace(this.quotechars[e+4],this.quotechars[1]));return t},s.Util.FlipFlopper.prototype.getSplitStrings=function(t){var e,i,n,s,r,o,a,l,u,c,h,p,d,f,m,g,b,y,v,_,x,C,w,S,T,E,I,N,A;for(t=this._normalizeString(t),N=t.match(this.allTagsRexMatch),e=t.split(this.allTagsRexSplit),A=[e[0]],i=1,n=e.length;n>i;i+=1)A.push(N[i-1]),A.push(e[i]);for(e=A.slice(),n=e.length-2,i=n;i>0;i+=-2)"\\"===e[i-1].slice(e[i-1].length-1)&&(s=e[i-1].slice(0,e[i-1].length-1)+e[i]+e[i+1],r=e.slice(0,i-1),o=e.slice(i+2),r.push(s),e=r.concat(o));for(a=[],l=[],u=[],c=[],h=[],S=e.length-1,p=1;S>p;p+=2)if(g=e[p],this.closeTagsHash[g]&&(a.reverse(),d=this.openToCloseHash[g],f=a.indexOf(g),m=u.indexOf(g),a.reverse(),!d||f>-1&&(m>f||-1===m))){for(b=!1,T=a.length-1,y=T;y>-1;y+=-1){if(b=!0,v=a[y],g===v){a.pop(),l.pop(),u.pop(),c.pop();break}h.push(p)}b||h.push(p)}else this.openToCloseHash[g]&&(a.push(this.openToCloseHash[g]),l.push(g),u.push(this.flipTagsHash[g]),c.push(p));for(E=a.length-1,_=E;_>-1;_+=-1)a.pop(),u.pop(),l.pop(),h.push(c.pop());for(h.sort(function(t,e){return e>t?1:t>e?-1:0}),n=h.length,i=0;n>i;i+=1)I=h[i],r=e.slice(0,I-1),o=e.slice(I+2),x=e[I],x.length&&"<"!==x[0]&&this.openToDecorations[x]&&-1===this.quotechars.indexOf(x.replace(/\s+/g,""))&&(w=this.openToDecorations[x],x=this.state.fun.decorate[w[0]][w[1][0]](this.state)),C=e[I-1]+x+e[I+1],r.push(C),e=r.concat(o);for(n=e.length,i=0;n>i;i+=2)e[i]=e[i].replace("'","’","g"),e[i]=e[i].replace("  ’"," ’","g");return e},s.Util.FlipFlopper.prototype.processTags=function(){var t,e,i,n,r,o,a,l,u,c,h,p,d,f,m,g,b,y,v,_,x,C,w,S;if(t=[],e=[],i=[],n=[],r="",1===this.strs.length)this.blob.blobs=this.strs[0];else if(this.strs.length>2){for(x=this.strs.length-1,o=1;x>o;o+=2)if(a=this.strs[o],l=this.strs[o-1],l&&(u=new s.Blob(l),c=this.blobstack.value(),c.push(u)),this.closeTagsHash[a]&&(t.reverse(),h=this.openToCloseHash[a],p=t.indexOf(a),d=i.indexOf(a),t.reverse(),!h||p>-1&&(d>p||-1===d))){for(C=t.length,f=C;f>-1;f+=-1)if(m=t[f],a===m){t.pop(),e.pop(),i.pop(),n.pop(),this.blobstack.pop();break}}else if(this.openToCloseHash[a]){if(t.push(this.openToCloseHash[a]),e.push(a),i.push(this.flipTagsHash[a]),c=this.blobstack.value(),g=new s.Blob,c.push(g),b=this.addFlipFlop(g,this.openToDecorations[a]),'<span class="nodecor">'===a)for(y=this.state[this.state.tmp.area].opt.topdecor.concat(this.blob.alldecor).concat([[["@quotes","inner"]]]),C=y.length,f=0;C>f;f+=1)for(v=y[f],S=v.length,w=0;S>w;w+=1)_=v[w],["@font-style","@font-weight","@font-variant"].indexOf(_[0])>-1&&(b=this.addFlipFlop(g,this.okReverseHash[_[0]]));n.push(this.state.fun.decorate[b[0]][b[1]](this.state)),this.blobstack.push(g)}this.strs.length>2&&(r=this.strs[this.strs.length-1],r&&(c=this.blobstack.value(),u=new s.Blob(r),c.push(u)))}return this.blob},s.Util.FlipFlopper.prototype.addFlipFlop=function(t,e){var i,n,s,r,o,a,l,u,c,h;for(n=0,s=this.state[this.state.tmp.area].opt.topdecor.concat(t.alldecor).concat([[["@quotes","inner"]]]),r=s.length,i=0;r>i;i+=1){for(o=s[i],a=!1,h=o.length-1,u=h;u>-1;u+=-1)if(l=o[u],l[0]===e[0]){l[1]===e[1][0]&&(n=1),a=!0;break}if(a)break}return c=[e[0],e[1][n]],t.decorations.reverse(),t.decorations.push(c),t.decorations.reverse(),c},s.Output.Formatters={},s.getSafeEscape=function(t){if(["bibliography","citation"].indexOf(t.tmp.area)>-1){var e=[];return t.opt.development_extensions.thin_non_breaking_space_html_hack&&"html"===t.opt.mode&&e.push(function(t){return t.replace(/\u202f/g,'<span style="white-space:nowrap">&thinsp;</span>')}),e.length?function(i){for(var n=0,r=e.length;r>n;n+=1)i=e[n](i);return s.Output.Formats[t.opt.mode].text_escape(i)}:s.Output.Formats[t.opt.mode].text_escape;
}return function(t){return t}},s.Output.Formatters.passthrough=function(t,e){return e},s.Output.Formatters.lowercase=function(t,e){var i=s.Output.Formatters.doppelString(e,s.TAG_USEALL);return i.string=i.string.toLowerCase(),s.Output.Formatters.undoppelString(i)},s.Output.Formatters.uppercase=function(t,e){var i=s.Output.Formatters.doppelString(e,s.TAG_USEALL);return i.string=i.string.toUpperCase(),s.Output.Formatters.undoppelString(i)},s.Output.Formatters["capitalize-first"]=function(t,e){var i=s.Output.Formatters.doppelString(e,s.TAG_ESCAPE);return i.string.length?(i.string=i.string.slice(0,1).toUpperCase()+i.string.substr(1),s.Output.Formatters.undoppelString(i)):""},s.Output.Formatters.sentence=function(t,e){var i=s.Output.Formatters.doppelString(e,s.TAG_ESCAPE);return i.string=i.string.slice(0,1).toUpperCase()+i.string.substr(1).toLowerCase(),s.Output.Formatters.undoppelString(i)},s.Output.Formatters["capitalize-all"]=function(t,e){for(var i=s.Output.Formatters.doppelString(e,s.TAG_ESCAPE),n=i.string.split(" "),r=0,o=n.length;o>r;r+=1)n[r].length>1?t.opt.development_extensions.allow_force_lowercase?n[r]=n[r].slice(0,1).toUpperCase()+n[r].substr(1).toLowerCase():n[r]=n[r].slice(0,1).toUpperCase()+n[r].substr(1):1===n[r].length&&(n[r]=n[r].toUpperCase());return i.string=n.join(" "),s.Output.Formatters.undoppelString(i)},s.Output.Formatters.title=function(t,e){function i(t){var e=t.match(/([:?!]+\s+|-|^)(.)(.*)/);return e?e[1]+e[2].toUpperCase()+e[3]:t}var n,r,o,a,l;t.locale[t.opt.lang].opts["skip-words"];if(!e)return"";var u=s.Output.Formatters.doppelString(e,s.TAG_ESCAPE),n=u.string,l=n.split(t.locale[t.opt.lang].opts["skip-words-regexp"]);for(c=1,h=l.length;h>c;c+=2)l[c].match(/^[:?!]/)&&(l[c]=i(l[c]));l[0]||(l[1]=i(l[1])),l.length>2&&!l[l.length-1]&&(l[l.length-2]=i(l[l.length-2]));for(var c=0,h=l.length;h>c;c+=2){for(var r=l[c].split(/([:?!]*\s+|-)/),p=0,d=r.length;d>p;p+=2)if(0!==r[p].length){if(o=r[p].toUpperCase(),a=r[p].toLowerCase(),r[p].match(/[0-9]/))continue;r[p]===a&&(r[p]=i(r[p]))}l[c]=r.join("")}u.string=l.join("");var f=s.Output.Formatters.undoppelString(u);return f},s.Output.Formatters.doppelString=function(t,e){var i;i={},i.array=e(t),i.string="";for(var n=0,s=i.array.length;s>n;n+=2)"-"===i.array[n-1],i.string+=i.array[n];return i},s.Output.Formatters.undoppelString=function(t){var e;e="";for(var i=0,n=t.array.length;n>i;i+=1)i%2?e+=t.array[i]:("-"===t.array[i-1],e+=t.string.slice(0,t.array[i].length),t.string=t.string.slice(t.array[i].length));return e},s.Output.Formatters.serializeItemAsRdf=function(t){return""},s.Output.Formatters.serializeItemAsRdfA=function(t){return""},s.demoteNoiseWords=function(t,e,i){var n=t.locale[t.opt.lang].opts["leading-noise-words"];if(e&&i){e=e.split(/\s+/),e.reverse();for(var s=[],r=e.length-1;r>-1&&n.indexOf(e[r].toLowerCase())>-1;r+=-1)s.push(e.pop());e.reverse();var o=e.join(" "),a=s.join(" ");"drop"!==i&&a?"demote"===i&&(e=[o,a].join(", ")):e=o}return e},s.Output.Formats=function(){},s.Output.Formats.prototype.html={text_escape:function(t){return t||(t=""),t.replace(/&/g,"&#38;").replace(/</g,"&#60;").replace(/>/g,"&#62;").replace("  ","&#160; ","g").replace(s.SUPERSCRIPTS_REGEXP,function(t){return"<sup>"+s.SUPERSCRIPTS[t]+"</sup>"})},bibstart:'<div class="csl-bib-body">\n',bibend:"</div>","@font-style/italic":"<i>%%STRING%%</i>","@font-style/oblique":"<em>%%STRING%%</em>","@font-style/normal":'<span style="font-style:normal;">%%STRING%%</span>',"@font-variant/small-caps":'<span style="font-variant:small-caps;">%%STRING%%</span>',"@passthrough/true":s.Output.Formatters.passthrough,"@font-variant/normal":'<span style="font-variant:normal;">%%STRING%%</span>',"@font-weight/bold":"<b>%%STRING%%</b>","@font-weight/normal":'<span style="font-weight:normal;">%%STRING%%</span>',"@font-weight/light":!1,"@text-decoration/none":'<span style="text-decoration:none;">%%STRING%%</span>',"@text-decoration/underline":'<span style="text-decoration:underline;">%%STRING%%</span>',"@vertical-align/sup":"<sup>%%STRING%%</sup>","@vertical-align/sub":"<sub>%%STRING%%</sub>","@vertical-align/baseline":'<span style="baseline">%%STRING%%</span>',"@strip-periods/true":s.Output.Formatters.passthrough,"@strip-periods/false":s.Output.Formatters.passthrough,"@quotes/true":function(t,e){return"undefined"==typeof e?t.getTerm("open-quote"):t.getTerm("open-quote")+e+t.getTerm("close-quote")},"@quotes/inner":function(t,e){return"undefined"==typeof e?"’":t.getTerm("open-inner-quote")+e+t.getTerm("close-inner-quote")},"@quotes/false":!1,"@cite/entry":function(t,e){return t.sys.wrapCitationEntry(e,this.item_id,this.locator_txt,this.suffix_txt)},"@bibliography/entry":function(t,e){var i="";return t.sys.embedBibliographyEntry&&(i=t.sys.embedBibliographyEntry(this.item_id)+"\n"),'  <div class="csl-entry">'+e+"</div>\n"+i},"@display/block":function(t,e){return'\n\n    <div class="csl-block">'+e+"</div>\n"},"@display/left-margin":function(t,e){return'\n    <div class="csl-left-margin">'+e+"</div>"},"@display/right-inline":function(t,e){return'<div class="csl-right-inline">'+e+"</div>\n  "},"@display/indent":function(t,e){return'<div class="csl-indent">'+e+"</div>\n  "},"@showid/true":function(t,e,i){if(t.tmp.just_looking||t.tmp.suppress_decorations)return e;if(i)return'<span class="'+t.opt.nodenames[i]+'" cslid="'+i+'">'+e+"</span>";if("string"==typeof e){var n="";if(e){var r=e.match(s.VARIABLE_WRAPPER_PREPUNCT_REX);n=r[1],e=r[2]}var o="";return e&&s.SWAPPING_PUNCTUATION.indexOf(e.slice(-1))>-1&&(o=e.slice(-1),e=e.slice(0,-1)),t.sys.variableWrapper(this.params,n,e,o)}return e},"@URL/true":function(t,e){return'<a href="'+e+'">'+e+"</a>"},"@DOI/true":function(t,e){return'<a href="http://dx.doi.org/'+e+'">'+e+"</a>"}},s.Output.Formats.prototype.text={text_escape:function(t){return t||(t=""),t},bibstart:"",bibend:"","@font-style/italic":!1,"@font-style/oblique":!1,"@font-style/normal":!1,"@font-variant/small-caps":!1,"@passthrough/true":s.Output.Formatters.passthrough,"@font-variant/normal":!1,"@font-weight/bold":!1,"@font-weight/normal":!1,"@font-weight/light":!1,"@text-decoration/none":!1,"@text-decoration/underline":!1,"@vertical-align/baseline":!1,"@vertical-align/sup":!1,"@vertical-align/sub":!1,"@strip-periods/true":s.Output.Formatters.passthrough,"@strip-periods/false":s.Output.Formatters.passthrough,"@quotes/true":function(t,e){return"undefined"==typeof e?t.getTerm("open-quote"):t.getTerm("open-quote")+e+t.getTerm("close-quote")},"@quotes/inner":function(t,e){return"undefined"==typeof e?"’":t.getTerm("open-inner-quote")+e+t.getTerm("close-inner-quote")},"@quotes/false":!1,"@cite/entry":function(t,e){return t.sys.wrapCitationEntry(e,this.item_id,this.locator_txt,this.suffix_txt)},"@bibliography/entry":function(t,e){return e+"\n"},"@display/block":function(t,e){return"\n"+e},"@display/left-margin":function(t,e){return e},"@display/right-inline":function(t,e){return e},"@display/indent":function(t,e){return"\n    "+e},"@showid/true":function(t,e,i){return e},"@URL/true":function(t,e){return e},"@DOI/true":function(t,e){return e}},s.Output.Formats.prototype.rtf={text_escape:function(t){return t||(t=""),t.replace(/([\\{}])/g,"\\$1","g").replace(s.SUPERSCRIPTS_REGEXP,function(t){return"\\super "+s.SUPERSCRIPTS[t]+"\\nosupersub{}"}).replace(/[\u007F-\uFFFF]/g,function(t){return"\\uc0\\u"+t.charCodeAt(0).toString()+"{}"}).replace("	","\\tab{}","g")},"@passthrough/true":s.Output.Formatters.passthrough,"@font-style/italic":"\\i %%STRING%%\\i0{}","@font-style/normal":"\\i0{}%%STRING%%\\i{}","@font-style/oblique":"\\i %%STRING%%\\i0{}","@font-variant/small-caps":"\\scaps %%STRING%%\\scaps0{}","@font-variant/normal":"\\scaps0{}%%STRING%%\\scaps{}","@font-weight/bold":"\\b %%STRING%%\\b0{}","@font-weight/normal":"\\b0{}%%STRING%%\\b{}","@font-weight/light":!1,"@text-decoration/none":!1,"@text-decoration/underline":"\\ul %%STRING%%\\ul0{}","@vertical-align/baseline":!1,"@vertical-align/sup":"\\super %%STRING%%\\nosupersub{}","@vertical-align/sub":"\\sub %%STRING%%\\nosupersub{}","@strip-periods/true":s.Output.Formatters.passthrough,"@strip-periods/false":s.Output.Formatters.passthrough,"@quotes/true":function(t,e){return"undefined"==typeof e?s.Output.Formats.rtf.text_escape(t.getTerm("open-quote")):s.Output.Formats.rtf.text_escape(t.getTerm("open-quote"))+e+s.Output.Formats.rtf.text_escape(t.getTerm("close-quote"))},"@quotes/inner":function(t,e){return"undefined"==typeof e?s.Output.Formats.rtf.text_escape("’"):s.Output.Formats.rtf.text_escape(t.getTerm("open-inner-quote"))+e+s.Output.Formats.rtf.text_escape(t.getTerm("close-inner-quote"))},"@quotes/false":!1,bibstart:"{\\rtf ",bibend:"}","@display/block":"\\line{}%%STRING%%\\line\r\n","@cite/entry":function(t,e){return e},"@cite/entry":function(t,e){return t.sys.wrapCitationEntry(e,this.item_id,this.locator_txt,this.suffix_txt)},"@bibliography/entry":function(t,e){return e},"@display/left-margin":function(t,e){return e+"\\tab "},"@display/right-inline":function(t,e){return e+"\n"},"@display/indent":function(t,e){return"\n\\tab "+e},"@showid/true":function(t,e,i){if(t.tmp.just_looking||t.tmp.suppress_decorations)return e;var n="";if(e){var r=e.match(s.VARIABLE_WRAPPER_PREPUNCT_REX);n=r[1],e=r[2]}var o="";return e&&s.SWAPPING_PUNCTUATION.indexOf(e.slice(-1))>-1&&(o=e.slice(-1),e=e.slice(0,-1)),t.sys.variableWrapper(this.params,n,e,o)},"@URL/true":function(t,e){return e},"@DOI/true":function(t,e){return e}},s.Output.Formats=new s.Output.Formats,s.Registry=function(t){var e,i,n;this.debug=!1,this.state=t,this.registry={},this.reflist=[],this.namereg=new s.Registry.NameReg(t),this.citationreg=new s.Registry.CitationReg(t),this.authorstrings={},this.mylist=[],this.myhash={},this.deletes=[],this.inserts=[],this.uncited={},this.refreshes={},this.akeys={},this.oldseq={},this.return_data={},this.ambigcites={},this.ambigresets={},this.sorter=new s.Registry.Comparifier(t,"bibliography_sort"),this.getSortedIds=function(){for(e=[],i=0,n=this.reflist.length;n>i;i+=1)e.push(""+this.reflist[i].id);return e},this.getSortedRegistryItems=function(){for(e=[],i=0,n=this.reflist.length;n>i;i+=1)e.push(this.reflist[i]);return e}},s.Registry.prototype.init=function(t,e){var i,n;if(this.oldseq={},e){this.uncited={};for(var i=0,n=t.length;n>i;i+=1)this.myhash[t[i]]||this.mylist.push(""+t[i]),this.uncited[t[i]]=!0,this.myhash[t[i]]=!0}else{for(var s in this.uncited)t.push(s);var r={};for(i=t.length-1;i>-1;i+=-1)r[t[i]]?t=t.slice(0,i).concat(t.slice(i+1)):r[t[i]]=!0;this.mylist=[];for(var i=0,n=t.length;n>i;i+=1)this.mylist.push(""+t[i]);this.myhash=r}this.refreshes={},this.touched={},this.ambigsTouched={},this.ambigresets={}},s.Registry.prototype.dopurge=function(t){for(var e=this.mylist.length-1;e>-1;e+=-1)this.citationreg.citationsByItemId&&(this.citationreg.citationsByItemId[this.mylist[e]]||t[this.mylist[e]]||(delete this.myhash[this.mylist[e]],this.mylist=this.mylist.slice(0,e).concat(this.mylist.slice(e+1))));this.dodeletes(this.myhash)},s.Registry.prototype.dodeletes=function(t){var e,i,n,s,r,o,a,l,u;"string"==typeof t&&(t={},t[t]=!0);for(i in this.registry)if(!t[i]){if(this.uncited[i])continue;e=this.namereg.delitems(i);for(a in e)this.refreshes[a]=!0;for(n=this.registry[i].ambig,l=this.ambigcites[n].indexOf(i),l>-1&&(o=this.ambigcites[n].slice(),this.ambigcites[n]=o.slice(0,l).concat(o.slice(l+1,o.length)),this.ambigresets[n]=this.ambigcites[n].length),r=this.ambigcites[n].length,s=0;r>s;s+=1)u=""+this.ambigcites[n][s],this.refreshes[u]=!0;if(this.registry[i].siblings)if(1==this.registry[i].siblings.length){var c=this.registry[i].siblings[0];this.registry[c].master=!0,this.registry[c].siblings.pop(),this.registry[c].parallel=!1}else if(this.registry[i].siblings.length>1){var h=[i];if(this.registry[i].master){var p=this.registry[i].siblings[0],d=this.registry[p];d.master=!0,d.parallel=!1,h.push(p);for(var f=0,m=this.registry[i].siblings.length;m>f;f+=1)this.registry[this.registry[i].siblings[f]].parallel=p}for(var g=[],f=this.registry[i].siblings.length-1;f>-1;f+=-1){var b=this.registry[i].siblings.pop();-1===h.indexOf(b)&&g.push(b)}for(var f=g.length-1;f>-1;f+=-1)this.registry[i].siblings.push(g[f])}delete this.registry[i],this.return_data.bibchange=!0}},s.Registry.prototype.doinserts=function(t){var e,i,n,r,o,a,l;for("string"==typeof t&&(t=[t]),a=0,l=t.length;l>a;a+=1)e=t[a],this.registry[e]||(i=this.state.retrieveItem(e),n=s.getAmbiguousCite.call(this.state,i),this.ambigsTouched[n]=!0,i.legislation_id||(this.akeys[n]=!0),r={id:""+e,seq:0,offset:0,sortkeys:!1,ambig:!1,rendered:!1,disambig:!1,ref:i},this.registry[e]=r,this.citationreg.citationsByItemId&&this.citationreg.citationsByItemId[e]&&(this.registry[e]["first-reference-note-number"]=this.citationreg.citationsByItemId[e][0].properties.noteIndex),o=s.getAmbigConfig.call(this.state),this.registerAmbigToken(n,e,o),this.touched[e]=!0,this.return_data.bibchange=!0)},s.Registry.prototype.rebuildlist=function(){var t,e,i;for(this.reflist=[],this.state.opt.citation_number_sort_direction===s.DESCENDING&&this.state.opt.citation_number_sort_used,t=this.mylist.length,e=0;t>e;e+=1)i=this.mylist[e],this.reflist.push(this.registry[i]),this.oldseq[i]=this.registry[i].seq,this.registry[i].seq=e+1;this.state.opt.citation_number_sort_direction===s.DESCENDING&&this.state.opt.citation_number_sort_used},s.Registry.prototype.dorefreshes=function(){var t,e,i,n,r;for(t in this.refreshes)if(e=this.registry[t]){e.sortkeys=void 0,i=this.state.retrieveItem(t);var n=e.ambig;"undefined"==typeof n&&(this.state.tmp.disambig_settings=!1,n=s.getAmbiguousCite.call(this.state,i),r=s.getAmbigConfig.call(this.state),this.registerAmbigToken(n,t,r));for(var o in this.ambigresets)if(1===this.ambigresets[o]){var a=this.ambigcites[n][0],i=this.state.retrieveItem(a);this.registry[a].disambig=new s.AmbigConfig,this.state.tmp.disambig_settings=!1;var n=s.getAmbiguousCite.call(this.state,i),r=s.getAmbigConfig.call(this.state);this.registerAmbigToken(n,a,r)}this.state.tmp.taintedItemIDs[t]=!0,this.ambigsTouched[n]=!0,i.legislation_id||(this.akeys[n]=!0),this.touched[t]=!0}},s.Registry.prototype.setdisambigs=function(){var t;this.leftovers=[];for(t in this.ambigsTouched)this.state.disambiguate.run(t);this.ambigsTouched={},this.akeys={}},s.Registry.prototype.renumber=function(){var t,e,i;for(this.state.opt.citation_number_sort_direction===s.DESCENDING&&this.state.opt.citation_number_sort_used,t=this.reflist.length,e=0;t>e;e+=1)i=this.reflist[e],i.seq=e+1,this.state.opt.update_mode===s.NUMERIC&&i.seq!=this.oldseq[i.id]&&(this.state.tmp.taintedItemIDs[i.id]=!0),this.state.opt.bib_mode===s.NUMERIC&&i.seq!=this.oldseq[i.id]&&(this.return_data.bibchange=!0);this.state.opt.citation_number_sort_direction===s.DESCENDING&&this.state.opt.citation_number_sort_used&&this.reflist.reverse()},s.Registry.prototype.setsortkeys=function(){for(var t,e=0,i=this.mylist.length;i>e;e+=1){var t=this.mylist[e];(this.touched[t]||this.state.tmp.taintedItemIDs[t]||!this.registry[t].sortkeys)&&(this.registry[t].sortkeys=s.getSortKeys.call(this.state,this.state.retrieveItem(t),"bibliography_sort"))}},s.Registry.prototype.sorttokens=function(){this.reflist.sort(this.sorter.compareKeys)},s.Registry.Comparifier=function(t,e){var i,n,r,o,a=s.getSortCompare(t.opt["default-locale-sort"]);i=t[e].opt.sort_directions,this.compareKeys=function(t,e){for(n=t.sortkeys?t.sortkeys.length:0,r=0;n>r;r+=1){var s=0;if(s=t.sortkeys[r]===e.sortkeys[r]?0:"undefined"==typeof t.sortkeys[r]?i[r][1]:"undefined"==typeof e.sortkeys[r]?i[r][0]:a(t.sortkeys[r],e.sortkeys[r]),s>0)return i[r][1];if(0>s)return i[r][0]}return t.seq>e.seq?1:t.seq<e.seq?-1:0},o=this.compareKeys,this.compareCompositeKeys=function(t,e){return o(t[1],e[1])}},s.Registry.prototype.compareRegistryTokens=function(t,e){return t.seq>e.seq?1:t.seq<e.seq?-1:0},s.Registry.prototype.registerAmbigToken=function(t,e,i){if(this.registry[e]&&this.registry[e].disambig&&this.registry[e].disambig.names)for(var n=0,r=i.names.length;r>n;n+=1){var o=i.names[n],a=this.registry[e].disambig.names[n];if(o!==a)this.state.tmp.taintedItemIDs[e]=!0;else if(i.givens[n])for(var l=0,u=i.givens[n].length;u>l;l+=1){var c=i.givens[n][l],h=this.registry[e].disambig.givens[n][l];c!==h&&(this.state.tmp.taintedItemIDs[e]=!0)}}this.ambigcites[t]||(this.ambigcites[t]=[]),-1===this.ambigcites[t].indexOf(""+e)&&this.ambigcites[t].push(""+e),this.registry[e].ambig=t;this.registry[e].disambig=s.cloneAmbigConfig(i)},s.getSortKeys=function(t,e){var i,n,r,o,a,l;for(i=this.tmp.area,n=this.tmp.extension,r=s.Util.Sort.strip_prepositions,this.tmp.area=e,this.tmp.extension="_sort",this.tmp.disambig_override=!0,this.tmp.disambig_request=!1,o=this.parallel.use_parallels,this.parallel.use_parallels=!1,this.tmp.suppress_decorations=!0,s.getCite.call(this,t),this.tmp.suppress_decorations=!1,this.parallel.use_parallels=o,this.tmp.disambig_override=!1,a=this[e].keys.length,l=0;a>l;l+=1)this[e].keys[l]=r(this[e].keys[l]);return this.tmp.area=i,this.tmp.extension=n,this[e].keys},s.Registry.NameReg=function(t){var e,i,n,r,o,a,l,u,c,h,p,d,f,m,g,b;this.state=t,this.namereg={},this.nameind={},this.nameindpkeys={},this.itemkeyreg={},u=function(t){return t||(t=""),t.replace("."," ","g").replace(/\s+/g," ").replace(/\s+$/,"")},c=function(t,r,o){e=u(o.family),n=u(o.given);var a=n.match(/[,\!]* ([^,]+)$/);a&&a[1]===a[1].toLowerCase()&&(n=n.replace(/[,\!]* [^,]+$/,"")),i=s.Util.Names.initializeWith(t,n,"%s"),"by-cite"===t.citation.opt["givenname-disambiguation-rule"]&&(e=""+r+e)},h=function(n,s,a,l,u,h){var p;if("bibliography"===t.tmp.area.slice(0,12)&&!u)return"string"==typeof h?1:2;var d=t.nameOutput.getName(s,"locale-translit",!0);s=d.name,c(this.state,""+n,s),p=2,r=t.opt["disambiguate-add-givenname"],o=t.citation.opt["givenname-disambiguation-rule"];var f=o;return"by-cite"===o&&(o="all-names"),"short"===u?p=0:"string"==typeof h&&(p=1),"undefined"==typeof this.namereg[e]||"undefined"==typeof this.namereg[e].ikey[i]?p:"by-cite"===f&&l>=p?l:r?"string"==typeof o&&"primary-name"===o.slice(0,12)&&a>0?p:(o&&"all-names"!==o&&"primary-name"!==o?("all-names-with-initials"===o||"primary-name-with-initials"===o)&&(p=this.namereg[e].count>1?1:0):(this.namereg[e].count>1&&(p=1),(this.namereg[e].ikey&&this.namereg[e].ikey[i].count>1||this.namereg[e].count>1&&"string"!=typeof h)&&(p=2)),t.registry.registry[n]?p:"short"==u?0:"string"==typeof h?1:void 0):p},p=function(s){var r,o,u,c,h;for(("string"==typeof s||"number"==typeof s)&&(s=[""+s]),a={},o=s.length,r=0;o>r;r+=1)if(c=""+s[r],this.nameind[c]){for(h in this.nameind[c])if(this.nameind[c].hasOwnProperty(h)){if(f=h.split("::"),e=f[0],i=f[1],n=f[2],"undefined"==typeof this.namereg[e])continue;if(l=this.namereg[e].items,n&&this.namereg[e].ikey[i]&&this.namereg[e].ikey[i].skey[n]&&(m=this.namereg[e].ikey[i].skey[n].items,u=m.indexOf(""+c),u>-1&&(this.namereg[e].ikey[i].skey[n].items=m.slice(0,u).concat(m.slice([u+1]))),0===this.namereg[e].ikey[i].skey[n].items.length&&(delete this.namereg[e].ikey[i].skey[n],this.namereg[e].ikey[i].count+=-1,this.namereg[e].ikey[i].count<2)))for(g=0,b=this.namereg[e].ikey[i].items.length;b>g;g+=1)t.tmp.taintedItemIDs[this.namereg[e].ikey[i].items[g]]=!0;if(i&&this.namereg[e].ikey[i]&&(u=this.namereg[e].ikey[i].items.indexOf(""+c),u>-1&&(l=this.namereg[e].ikey[i].items.slice(),this.namereg[e].ikey[i].items=l.slice(0,u).concat(l.slice([u+1]))),0===this.namereg[e].ikey[i].items.length&&(delete this.namereg[e].ikey[i],this.namereg[e].count+=-1,this.namereg[e].count<2)))for(g=0,b=this.namereg[e].items.length;b>g;g+=1)t.tmp.taintedItemIDs[this.namereg[e].items[g]]=!0;e&&(u=this.namereg[e].items.indexOf(""+c),u>-1&&(l=this.namereg[e].items.slice(),this.namereg[e].items=l.slice(0,u).concat(l.slice([u+1],l.length))),this.namereg[e].items.length<2&&delete this.namereg[e]),delete this.nameind[c][h]}delete this.nameind[c],delete this.nameindpkeys[c]}return a},d=function(s,r,o){var a,l,u=t.nameOutput.getName(r,"locale-translit",!0);if(r=u.name,!t.citation.opt["givenname-disambiguation-rule"]||"primary-"!==t.citation.opt["givenname-disambiguation-rule"].slice(0,8)||0===o){if(c(this.state,""+s,r),e&&("undefined"==typeof this.namereg[e]?(this.namereg[e]={},this.namereg[e].count=0,this.namereg[e].ikey={},this.namereg[e].items=[s]):-1===this.namereg[e].items.indexOf(s)&&this.namereg[e].items.push(s)),e&&i)if("undefined"==typeof this.namereg[e].ikey[i]){if(this.namereg[e].ikey[i]={},this.namereg[e].ikey[i].count=0,this.namereg[e].ikey[i].skey={},this.namereg[e].ikey[i].items=[s],this.namereg[e].count+=1,2===this.namereg[e].count)for(a=0,l=this.namereg[e].items.length;l>a;a+=1)t.tmp.taintedItemIDs[this.namereg[e].items[a]]=!0}else-1===this.namereg[e].ikey[i].items.indexOf(s)&&this.namereg[e].ikey[i].items.push(s);if(e&&i&&n)if("undefined"==typeof this.namereg[e].ikey[i].skey[n]){if(this.namereg[e].ikey[i].skey[n]={},this.namereg[e].ikey[i].skey[n].items=[s],this.namereg[e].ikey[i].count+=1,2===this.namereg[e].ikey[i].count)for(a=0,l=this.namereg[e].ikey[i].items.length;l>a;a+=1)t.tmp.taintedItemIDs[this.namereg[e].ikey[i].items[a]]=!0}else-1===this.namereg[e].ikey[i].skey[n].items.indexOf(s)&&this.namereg[e].ikey[i].skey[n].items.push(s);"undefined"==typeof this.nameind[s]&&(this.nameind[s]={},this.nameindpkeys[s]={}),e&&(this.nameind[s][e+"::"+i+"::"+n]=!0,this.nameindpkeys[s][e]=this.namereg[e])}},this.addname=d,this.delitems=p,this.evalname=h},s.Registry.CitationReg=function(t){this.citationById={},this.citationByIndex=[]},s.Disambiguation=function(t){this.state=t,this.sys=this.state.sys,this.registry=t.registry.registry,this.ambigcites=t.registry.ambigcites,this.configModes(),this.debug=!1},s.Disambiguation.prototype.run=function(t){this.modes.length&&(this.akey=t,this.initVars(t)&&this.runDisambig())},s.Disambiguation.prototype.runDisambig=function(){var t;for(this.initGivens=!0;this.lists.length;){for(this.gnameset=0,this.gname=0,this.clashes=[1,0];this.lists[0][1].length;){this.listpos=0,this.base||(this.base=this.lists[0][0]);t=this.incrementDisambig(),this.scanItems(this.lists[0]),this.evalScan(t)}this.lists=this.lists.slice(1)}},s.Disambiguation.prototype.scanItems=function(t){var e,i,n;this.Item=t[1][0],this.ItemCite=s.getAmbiguousCite.call(this.state,this.Item,this.base,!0),this.scanlist=t[1],this.partners=[],this.partners.push(this.Item),this.nonpartners=[];var r=0;for(e=1,i=t[1].length;i>e;e+=1){n=t[1][e];var o=s.getAmbiguousCite.call(this.state,n,this.base,!0);this.ItemCite===o?(r+=1,this.partners.push(n)):this.nonpartners.push(n)}this.clashes[0]=this.clashes[1],this.clashes[1]=r},s.Disambiguation.prototype.evalScan=function(t){this[this.modes[this.modeindex]](t),t&&(this.modeindex<this.modes.length-1?this.modeindex+=1:this.lists[this.listpos+1]=[this.base,[]])},s.Disambiguation.prototype.disNames=function(t){var e,i;if(0===this.clashes[1]&&1===this.nonpartners.length)this.captureStepToBase(),this.state.registry.registerAmbigToken(this.akey,""+this.nonpartners[0].id,this.betterbase),this.state.registry.registerAmbigToken(this.akey,""+this.partners[0].id,this.betterbase),this.lists[this.listpos]=[this.betterbase,[]];else if(0===this.clashes[1])this.captureStepToBase(),this.state.registry.registerAmbigToken(this.akey,""+this.partners[0].id,this.betterbase),this.lists[this.listpos]=[this.betterbase,this.nonpartners],this.nonpartners.length&&(this.initGivens=!0);else if(1===this.nonpartners.length)this.captureStepToBase(),this.state.registry.registerAmbigToken(this.akey,""+this.nonpartners[0].id,this.betterbase),this.lists[this.listpos]=[this.betterbase,this.partners];else if(this.clashes[1]<this.clashes[0])this.captureStepToBase(),this.lists[this.listpos]=[this.betterbase,this.partners],this.lists.push([this.betterbase,this.nonpartners]);else if(t&&(this.lists[this.listpos]=[this.betterbase,this.nonpartners],this.lists.push([this.betterbase,this.partners]),this.modeindex===this.modes.length-1)){for(e=0,i=this.partners.length;i>e;e+=1)this.state.registry.registerAmbigToken(this.akey,""+this.partners[e].id,this.betterbase);this.lists[this.listpos]=[this.betterbase,[]]}},s.Disambiguation.prototype.disExtraText=function(){var t=!1;if(0===this.clashes[1]&&this.nonpartners.length<2&&(t=!0),t||this.base.disambiguate&&this.state.tmp.disambiguate_count===this.state.tmp.disambiguate_maxMax){if(t||this.state.tmp.disambiguate_count===this.state.tmp.disambiguate_maxMax)if(t||this.modeindex===this.modes.length-1){for(var e=this.lists[this.listpos][0],i=0,n=this.lists[this.listpos][1].length;n>i;i+=1)this.state.tmp.taintedItemIDs[this.lists[this.listpos][1][i].id]=!0,this.state.registry.registerAmbigToken(this.akey,""+this.lists[this.listpos][1][i].id,e);this.lists[this.listpos]=[this.betterbase,[]]}else{this.modeindex=this.modes.length-1;var e=this.lists[this.listpos][0];e.disambiguate=!0;for(var i=0,n=this.lists[this.listpos][1].length;n>i;i+=1)this.state.tmp.taintedItemIDs[this.lists[this.listpos][1][i].id]=!0,this.state.registry.registerAmbigToken(this.akey,""+this.lists[this.listpos][1][i].id,e)}}else if(this.modeindex=0,this.base.disambiguate=this.state.tmp.disambiguate_count,this.betterbase.disambiguate=this.state.tmp.disambiguate_count,this.base.disambiguate)this.disNames();else{this.initGivens=!0,this.base.disambiguate=1;for(var i=0,n=this.lists[this.listpos][1].length;n>i;i+=1)this.state.tmp.taintedItemIDs[this.lists[this.listpos][1][i].id]=!0}},s.Disambiguation.prototype.disYears=function(){var t,e,i,n;i=[];var r=this.lists[this.listpos][0];if(this.clashes[1])for(var o=0,a=this.state.registry.mylist.length;a>o;o+=1)for(var l=this.state.registry.mylist[o],u=0,c=this.lists[this.listpos][1].length;c>u;u+=1){var n=this.lists[this.listpos][1][u];if(n.id==l){i.push(this.registry[n.id]);break}}for(i.sort(this.state.registry.sorter.compareKeys),t=0,e=i.length;e>t;t+=1){r.year_suffix=""+t;var h=this.state.registry.registry[i[t].id].disambig;this.state.registry.registerAmbigToken(this.akey,""+i[t].id,r),s.ambigConfigDiff(h,r)&&(this.state.tmp.taintedItemIDs[i[t].id]=!0)}this.lists[this.listpos]=[this.betterbase,[]]},s.Disambiguation.prototype.incrementDisambig=function(){if(this.initGivens)return this.initGivens=!1,!1;var t=!1,e=!0;if("disNames"===this.modes[this.modeindex]){e=!1,"number"!=typeof this.givensMax&&(e=!0);var i=!1;if("number"!=typeof this.namesMax&&(i=!0),"number"==typeof this.givensMax&&(this.base.givens.length&&this.base.givens[this.gnameset][this.gname]<this.givensMax?this.base.givens[this.gnameset][this.gname]+=1:e=!0),"number"==typeof this.namesMax&&e&&(this.state.opt["disambiguate-add-names"]?(i=!1,this.gname<this.namesMax?(this.base.names[this.gnameset]+=1,this.gname+=1):i=!0):i=!0),"number"==typeof this.namesetsMax&&i)if(this.gnameset<this.namesetsMax)this.gnameset+=1,this.base.names[this.gnameset]=1,this.gname=0;else;"number"==typeof this.namesetsMax&&-1!==this.namesetsMax&&this.gnameset!==this.namesetsMax||this.state.opt["disambiguate-add-names"]&&"number"==typeof this.namesMax&&this.gname!==this.namesMax||"number"==typeof this.givensMax&&"undefined"!=typeof this.base.givens[this.gnameset]&&"undefined"!=typeof this.base.givens[this.gnameset][this.gname]&&this.base.givens[this.gnameset][this.gname]!==this.givensMax||(t=!0)}else"disExtraText"===this.modes[this.modeindex]&&(this.base.disambiguate+=1,this.betterbase.disambiguate+=1);return t},s.Disambiguation.prototype.initVars=function(t){var e,i,n,r,o;if(this.lists=[],this.base=!1,this.betterbase=!1,this.akey=t,this.maxNamesByItemId={},r=[],n=this.ambigcites[t],!n||!n.length)return!1;var a=this.state.retrieveItem(""+n[0]);if(this.getCiteData(a),this.base=s.getAmbigConfig.call(this.state),n&&n.length>1){for(r.push([this.maxNamesByItemId[a.id],a]),e=1,i=n.length;i>e;e+=1)a=this.state.retrieveItem(""+n[e]),this.getCiteData(a,this.base),r.push([this.maxNamesByItemId[a.id],a]);for(r.sort(function(t,e){return t[0]>e[0]?1:t[0]<e[0]?-1:t[1].id>e[1].id?1:t[1].id<e[1].id?-1:0}),o=[],e=0,i=r.length;i>e;e+=1)o.push(r[e][1]);this.lists.push([this.base,o]),this.Item=this.lists[0][1][0]}else this.Item=this.state.retrieveItem(""+n[0]);if(this.modeindex=0,this.state.citation.opt["disambiguate-add-names"],0)for(var l=this.base.names[0],e=1,i=this.base.names.length;i>e;e+=1)l=Math.max(l,this.base.names.names[e]);else this.namesMax=this.maxNamesByItemId[this.Item.id][0];return this.padBase(this.base),this.padBase(this.betterbase),this.base.year_suffix=!1,this.base.disambiguate=!1,this.betterbase.year_suffix=!1,this.betterbase.disambiguate=!1,"by-cite"===this.state.citation.opt["givenname-disambiguation-rule"]&&this.state.opt["disambiguate-add-givenname"]&&(this.givensMax=2),!0},s.Disambiguation.prototype.padBase=function(t){for(var e=0,i=t.names.length;i>e;e+=1){t.givens[e]||(t.givens[e]=[]);for(var n=0,s=t.names[e];s>n;n+=1)t.givens[e][n]||(t.givens[e][n]=0)}},s.Disambiguation.prototype.configModes=function(){var t,e;this.modes=[],t=this.state.opt["disambiguate-add-givenname"],e=this.state.citation.opt["givenname-disambiguation-rule"],(this.state.opt["disambiguate-add-names"]||t&&"by-cite"===e)&&this.modes.push("disNames"),this.state.opt.has_disambiguate&&this.modes.push("disExtraText"),this.state.opt["disambiguate-add-year-suffix"]&&this.modes.push("disYears")},s.Disambiguation.prototype.getCiteData=function(t,e){if(!this.maxNamesByItemId[t.id]){s.getAmbiguousCite.call(this.state,t,e),e=s.getAmbigConfig.call(this.state),this.maxNamesByItemId[t.id]=s.getMaxVals.call(this.state),this.state.registry.registry[t.id].disambig.givens=this.state.tmp.disambig_settings.givens.slice();for(var i=0,n=this.state.registry.registry[t.id].disambig.givens.length;n>i;i+=1)this.state.registry.registry[t.id].disambig.givens[i]=this.state.tmp.disambig_settings.givens[i].slice();this.namesetsMax=this.state.registry.registry[t.id].disambig.names.length-1,this.base||(this.base=e,this.betterbase=s.cloneAmbigConfig(e)),e.names.length<this.base.names.length&&(this.base=e);for(var i=0,n=e.names.length;n>i;i+=1)e.names[i]>this.base.names[i]&&(this.base.givens[i]=e.givens[i].slice(),this.base.names[i]=e.names[i],this.betterbase.names=this.base.names.slice(),this.betterbase.givens=this.base.givens.slice(),this.padBase(this.base),this.padBase(this.betterbase));this.betterbase.givens=this.base.givens.slice();for(var r=0,o=this.base.givens.length;o>r;r+=1)this.betterbase.givens[r]=this.base.givens[r].slice()}},s.Disambiguation.prototype.captureStepToBase=function(){"by-cite"===this.state.citation.opt["givenname-disambiguation-rule"]&&this.base.givens&&this.base.givens.length&&"undefined"!=typeof this.base.givens[this.gnameset][this.gname]&&(this.betterbase.givens[this.gnameset][this.gname]=this.base.givens[this.gnameset][this.gname]),this.betterbase.names[this.gnameset]=this.base.names[this.gnameset]}},{"./csl_nodejs_jsdom":333}],332:[function(t,e,i){var n="undefined"!=typeof window,s=function(){this.institutionStr='<institution institution-parts="long" delimiter=", " substitute-use-first="1" use-last="1"><institution-part name="long"/></institution>',this.ns="http://purl.org/net/xbiblio/csl"};s.prototype._parseDoc=function(t){if(n){var e=new window.DOMParser;return e.parseFromString(t,"text/xml")}return $(t)},s.prototype.importNode=function(t,e){return n?t.importNode(e,!0):(e._root=t._root,e)},s.prototype._hasAttributes=function(t){return t.attributes&&t.attributes.length>0},s.prototype._isElementNode=function(t){return n?t.nodeType===window.Node.ELEMENT_NODE:"tag"===t.type},s.prototype._getTagName=function(t){return t.tagName?t.tagName.toLowerCase():""},s.prototype.clean=function(t){return t=t.replace(/<\?[^?]+\?>/g,""),t=t.replace(/<![^>]+>/g,""),t=t.replace(/^\s+/,""),t=t.replace(/\s+$/,""),t=t.replace(/^\n*/,"")},s.prototype.getStyleId=function(t,e){var i=e?"title":"id",n=$(t).find(i);return n.length&&(n=n[0]),$(n).text()},s.prototype.children=function(t){return $(t).children()},s.prototype.nodename=function(t){return this._getTagName(t)},s.prototype.attributes=function(t){var e,i,s={};if(t){if(n){if(this._hasAttributes(t)){
e=t.attributes;for(var r=0,o=e.length;o>r;r+=1)i=e[r],s["@"+i.name]=i.value}}else if(t.attribs){e=t.attribs;for(var a in e)e.hasOwnProperty(a)&&(s["@"+a]=e[a])}}else;return s},s.prototype.content=function(t){return $(t).text()},s.prototype.namespace={xml:"http://www.w3.org/XML/1998/namespace"},s.prototype.numberofnodes=function(t){return t?t.length:0},s.prototype.getAttributeName=function(t){return t.name},s.prototype.getAttributeValue=function(t,e,i){return i&&(e=i+":"+e),$(t).attr(e)},s.prototype.getNodeValue=function(t,e){if(!e)return $(t).text();var i=$(t).find(e);return i.length?i.text():void 0},s.prototype.setAttributeOnNodeIdentifiedByNameAttribute=function(t,e,i,n,s){"@"===n.slice(0,1)&&(n=n.slice(1)),$(t).find(e).each(function(){var t=$(this);t.attr("name")===i&&t.attr(n,s)})},s.prototype.deleteNodeByNameAttribute=function(t,e){$(t).find("*[name="+e+"]").remove()},s.prototype.deleteAttribute=function(t,e){$(t).removeAttr(e)},s.prototype.setAttribute=function(t,e,i){return $(t).attr(e,i),!1},s.prototype.nodeCopy=function(t){return $(t).clone()},s.prototype.getNodesByName=function(t,e,i){return $(t).find(e+"[name="+i+"]")},s.prototype.nodeNameIs=function(t,e){return this._getTagName(t)===e},s.prototype.makeXml=function(t){t||(t="<docco><bogus/></docco>"),t=t.replace(/\s*<\?[^>]*\?>\s*\n*/g,"");var e,i=this._parseDoc(t);return e=n?i.firstChild:i._root},s.prototype.insertChildNodeAfter=function(t,e,i,n){var s=this.importNode(e.ownerDocument,n);return $(s).insertAfter(e),t},s.prototype.insertPublisherAndPlace=function(t){for(var e=$(t).find("group"),i=0,n=e.length;n>i;i+=1){var s=$(e[i]),r=s.find("[variable=publisher]"),o=s.find("[variable=publisher-place]");r.length&&o.length&&s.attr("has-publisher-and-publisher-place",!0)}},s.prototype.addMissingNameNodes=function(t){$(t).find("names").each(function(){var t=$(this),e=t.find("name");0!==e.length||t.parent("substitute")||t.append($("<name>"))})},s.prototype.addInstitutionNodes=function(t){function e(t,e){for(var i=0,n=CSL.INSTITUTION_KEYS.length;n>i;i+=1){var s=CSL.INSTITUTION_KEYS[i],r=e.attr(s);r&&t.attr(s,r)}}$(t).find("names").each(function(){var t=$(this).find("name"),i=$(this).find("institution");if(t.length&&!i.length){i=$(this.institutionStr);var n=i.find("institution-part");e(n,t),t.find("name-part[name=family]").each(function(){e(n,$(this))}),i.insertBefore(t)}})},s.prototype.flagDateMacros=function(t){$(t).find("macro").each(function(){var t=$(this),e=t.find("data");e.length&&t.attr("macro-has-date","true")})},e.exports=s},{}],333:[function(t,e,i){var n;n=t("undefined"==typeof window?"./csl_jquery":"./xmldom"),e.exports={CSL_NODEJS_JSDOM:n}},{"./csl_jquery":332,"./xmldom":334}],334:[function(t,e,i){var n,s=function(){"undefined"==typeof DOMParser||n?(n=!0,DOMParser=function(){},DOMParser.prototype.parseFromString=function(t,e){if("undefined"!=typeof ActiveXObject){var i=new ActiveXObject("MSXML.DomDocument");return i.async=!1,i.loadXML(t),i}if("undefined"!=typeof XMLHttpRequest){var i=new XMLHttpRequest;return e||(e="text/xml"),i.open("GET","data:"+e+";charset=utf-8,"+encodeURIComponent(t),!1),i.overrideMimeType&&i.overrideMimeType(e),i.send(null),i.responseXML}},this.hasAttributes=function(t){var e;return e=t.attributes&&t.attributes.length?!0:!1}):this.hasAttributes=function(t){var e;return e=t.attributes&&t.attributes.length?!0:!1},this.importNode=function(t,e){if("undefined"==typeof t.importNode)var i=this._importNode(t,e,!0);else var i=t.importNode(e,!0);return i},this._importNode=function(t,e,i){switch(e.nodeType){case 1:var n=t.createElement(e.nodeName);if(e.attributes&&e.attributes.length>0)for(var s=0,r=e.attributes.length;r>s;)n.setAttribute(e.attributes[s].nodeName,e.getAttribute(e.attributes[s++].nodeName));if(i&&e.childNodes&&e.childNodes.length>0)for(var s=0,r=e.childNodes.length;r>s;)n.appendChild(this._importNode(t,e.childNodes[s++],i));return n;case 3:case 4:case 8:}},this.parser=new DOMParser;var t='<docco><institution institution-parts="long" delimiter=", " substitute-use-first="1" use-last="1"><institution-part name="long"/></institution></docco>',e=this.parser.parseFromString(t,"text/xml"),i=e.getElementsByTagName("institution");this.institution=i.item(0);var s=e.getElementsByTagName("institution-part");this.institutionpart=s.item(0),this.ns="http://purl.org/net/xbiblio/csl"};s.prototype.clean=function(t){return t=t.replace(/<\?[^?]+\?>/g,""),t=t.replace(/<![^>]+>/g,""),t=t.replace(/^\s+/,""),t=t.replace(/\s+$/,""),t=t.replace(/^\n*/,"")},s.prototype.getStyleId=function(t){var e="",i=t.getElementsByTagName("id");return i&&i.length&&(i=i.item(0)),i&&(e=i.textContent),e||(e=i.innerText),e||(e=i.innerHTML),e},s.prototype.children=function(t){var e,i,n,s;if(t){for(s=[],e=t.childNodes,i=0,n=e.length;n>i;i+=1)"#text"!=e[i].nodeName&&s.push(e[i]);return s}return[]},s.prototype.nodename=function(t){var e=t.nodeName;return e},s.prototype.attributes=function(t){var e,i,n,s,r;if(e=new Object,t&&this.hasAttributes(t))for(i=t.attributes,s=0,r=i.length;r>s;s+=1)n=i[s],e["@"+n.name]=n.value;return e},s.prototype.content=function(t){var e;return e="undefined"!=typeof t.textContent?t.textContent:"undefined"!=typeof t.innerText?t.innerText:t.txt},s.prototype.namespace={xml:"http://www.w3.org/XML/1998/namespace"},s.prototype.numberofnodes=function(t){return t?t.length:0},s.prototype.getAttributeName=function(t){var e=t.name;return e},s.prototype.getAttributeValue=function(t,e,i){var n="";return t&&this.hasAttributes(t)&&t.getAttribute(e)&&(n=t.getAttribute(e)),n},s.prototype.getNodeValue=function(t,e){var i="";if(e){var n=t.getElementsByTagName(e);n.length>0&&(i="undefined"!=typeof n[0].textContent?n[0].textContent:"undefined"!=typeof n[0].innerText?n[0].innerText:n[0].text)}else i=t;return i&&i.childNodes&&(0==i.childNodes.length||1==i.childNodes.length&&"#text"==i.firstChild.nodeName)&&(i="undefined"!=typeof i.textContent?i.textContent:"undefined"!=typeof i.innerText?i.innerText:i.text),i},s.prototype.setAttributeOnNodeIdentifiedByNameAttribute=function(t,e,i,n,s){var r,o,a,l;for("@"===n.slice(0,1)&&(n=n.slice(1)),a=t.getElementsByTagName(e),r=0,o=a.length;o>r;r+=1)l=a[r],l.getAttribute("name")==i&&l.setAttribute(n,s)},s.prototype.deleteNodeByNameAttribute=function(t,e){var i,n,s,r;for(r=t.childNodes,i=0,n=r.length;n>i;i+=1)s=r[i],s&&s.nodeType!=s.TEXT_NODE&&this.hasAttributes(s)&&s.getAttribute("name")==e&&t.removeChild(r[i])},s.prototype.deleteAttribute=function(t,e){t.removeAttribute(e)},s.prototype.setAttribute=function(t,e,i){return t.ownerDocument||(t=t.firstChild),["function","unknown"].indexOf(typeof t.setAttribute)>-1&&t.setAttribute(e,i),!1},s.prototype.nodeCopy=function(t){var e=t.cloneNode(!0);return e},s.prototype.getNodesByName=function(t,e,i){var n,s,r,o,a;for(n=[],s=t.getElementsByTagName(e),o=0,a=s.length;a>o;o+=1)r=s.item(o),(!i||this.hasAttributes(r)&&r.getAttribute("name")==i)&&n.push(r);return n},s.prototype.nodeNameIs=function(t,e){return e==t.nodeName?!0:!1},s.prototype.makeXml=function(t){t||(t="<docco><bogus/></docco>"),t=t.replace(/\s*<\?[^>]*\?>\s*\n*/g,"");var e=this.parser.parseFromString(t,"application/xml");return e.firstChild},s.prototype.insertChildNodeAfter=function(t,e,i,n){var s;return s=this.importNode(e.ownerDocument,n),t.replaceChild(s,e),t},s.prototype.insertPublisherAndPlace=function(t){for(var e=t.getElementsByTagName("group"),i=0,n=e.length;n>i;i+=1){for(var s=e.item(i),r=[],o=0,a=s.childNodes.length;a>o;o+=1)1!==s.childNodes.item(o).nodeType&&r.push(o);if(s.childNodes.length-r.length===2){for(var l=[],o=0,a=2;a>o;o+=1)if(!(r.indexOf(o)>-1)){for(var u=s.childNodes.item(o),c=[],h=0,p=u.childNodes.length;p>h;h+=1)1!==u.childNodes.item(h).nodeType&&c.push(h);if(u.childNodes.length-c.length===0&&(l.push(u.getAttribute("variable")),u.getAttribute("suffix")||u.getAttribute("prefix"))){l=[];break}}l.indexOf("publisher")>-1&&l.indexOf("publisher-place")>-1&&s.setAttribute("has-publisher-and-publisher-place",!0)}}},s.prototype.addMissingNameNodes=function(t){for(var e=t.getElementsByTagName("names"),i=0,n=e.length;n>i;i+=1){var s=e.item(i),r=s.getElementsByTagName("name");if((!r||0===r.length)&&"substitute"!==s.parentNode.tagName.toLowerCase()){var o=s.ownerDocument,a=o.createElement("name");s.appendChild(a)}}};var r={INSTITUTION_KEYS:["font-style","font-variant","font-weight","text-decoration","text-case"]};s.prototype.addInstitutionNodes=function(t){var e,i,n,s,o,a,l,u,c;for(e=t.getElementsByTagName("names"),u=0,c=e.length;c>u;u+=1)if(i=e.item(u),a=i.getElementsByTagName("name"),0!=a.length&&(n=i.getElementsByTagName("institution"),0==n.length)){s=this.importNode(t.ownerDocument,this.institution),o=s.getElementsByTagName("institution-part").item(0),l=a.item(0),i.insertBefore(s,l.nextSibling);for(var h=0,p=r.INSTITUTION_KEYS.length;p>h;h+=1){var d=r.INSTITUTION_KEYS[h],f=l.getAttribute(d);f&&o.setAttribute(d,f)}for(var m=l.getElementsByTagName("name-part"),h=0,p=m.length;p>h;h+=1)if("family"===m[h].getAttribute("name"))for(var g=0,b=r.INSTITUTION_KEYS.length;b>g;g+=1){var d=r.INSTITUTION_KEYS[g],f=m[h].getAttribute(d);f&&o.setAttribute(d,f)}}},s.prototype.flagDateMacros=function(t){var e,i,n,s,r;for(r=t.getElementsByTagName("macro"),e=0,i=r.length;i>e;e+=1)n=r.item(e),s=n.getElementsByTagName("date"),s.length&&n.setAttribute("macro-has-date","true")},e.exports=s},{}],335:[function(t,e,i){var n=t("substance/util/helpers"),s=t("substance/util/jquery"),r=t("substance/model/Annotation"),o=r.extend({name:"citation",properties:{targets:["array","id"]},getDefaultProperties:function(){return{targets:[]}},setLabel:function(t){this.label!==t&&(this.label=t,this.emit("label:changed"))},didAttach:function(t){t.isTransaction()||t.isClipboard()||(t.getEventProxy("path").connect(this,[this.id,"targets"],this.onTargetChange),this.updateCollection(t))},didDetach:function(t){t.getEventProxy("path").disconnect(this,[this.id,"targets"]),this.updateCollection(t)},updateCollection:function(t){var e=t.getCollection(this.getItemType());e&&e.update()},onTargetChange:function(t,e,i){this.updateCollection(i)}});o["static"].tagName="cite",o["static"].external=!0,o["static"].fromHtml=function(t,e){var i={id:t.attr("id"),targets:n.compact(t.attr("data-rid").split(" "))};return i},o["static"].toHtml=function(t,e){var i=t.id,n=t.targets.join(" "),r=s("<cite>").attr("id",i).attr("data-rid",n);return r},e.exports=o},{"substance/model/Annotation":56,"substance/util/helpers":315,"substance/util/jquery":316}],336:[function(t,e,i){"use strict";var n=t("substance/ui/SurfaceCommand"),s=t("substance/model/transform/createAnnotation"),r=t("substance/model/transform/insertText"),o=n.extend({getCommandState:function(){var t=this.getSelection(),e={disabled:!0,active:!1};return t&&!t.isNull()&&t.isPropertySelection()&&t.isCollapsed()&&(e.disabled=!1),e},getAnnotationData:function(){return{targets:[]}},getAnnotationType:function(){if(this.constructor["static"].annotationType)return this.constructor["static"].annotationType;throw new Error("Contract: CitationCommand.static.annotationType should be associated to a document citation type.")},execute:function(){var t,e=this.getCommandState(),i=this.getDocument(),n=this.getSurface();return e.disabled?void 0:(n.transaction(function(e,o){var a=n.getSelection();o=r(e,{selection:a,text:"$"});var l=i.createSelection({type:"property",path:a.path,startOffset:a.startOffset-1,endOffset:a.endOffset});return o.annotationType=this.getAnnotationType(),o.annotationData=this.getAnnotationData(),o.selection=l,o.splitContainerSelections=!1,o.containerId=n.getContainerId(),o=s(e,o),t=o.result,o}.bind(this)),{mode:"create",anno:t})}});e.exports=o},{"substance/model/transform/createAnnotation":96,"substance/model/transform/insertText":104,"substance/ui/SurfaceCommand":299}],337:[function(t,e,i){"use strict";function n(){r.apply(this,arguments),this.props.node.connect(this,{"label:changed":this.onLabelChanged})}var s=t("substance/util/oo"),r=t("substance/ui/AnnotationComponent"),o=t("substance/ui/Component"),a=o.$$;n.Prototype=function(){this.dispose=function(){r.prototype.dispose.call(this),this.props.node.disconnect(this)},this.render=function(){return a("span").addClass(this.getClassNames()).attr({"data-id":this.props.node.id,"data-external":1,contentEditable:!1}).on("click",this.onClick).on("mousedown",this.onMouseDown).append(this.props.node.label||"")},this.getClassNames=function(){var t=this.props.node.getTypeNames().join(" ");return this.props.classNames&&(t+=" "+this.props.classNames.join(" ")),this.props.node.highlighted&&(t+=" highlighted"),t.replace(/_/g,"-")},this.onMouseDown=function(t){t.preventDefault(),t.stopPropagation();var e=this.props.node,i=this.context.surface;i.setSelection(e.getSelection());var n=this.context.controller;n.emit("citation:selected",e)},this.onClick=function(t){t.preventDefault(),t.stopPropagation()},this.onLabelChanged=function(){this.rerender()}},s.inherit(n,r),e.exports=n},{"substance/ui/AnnotationComponent":275,"substance/ui/Component":279,"substance/util/oo":317}],338:[function(t,e,i){"use strict";function n(){a.apply(this,arguments),this._initialize(this.props)}var s=t("substance/util/helpers"),r=t("substance/util/oo"),o=t("substance/ui/Component"),a=t("substance/ui/Panel"),l=t("substance/ui/FontAwesomeIcon"),u=o.$$;n.Prototype=function(){this.render=function(){var t,e=this.context.componentRegistry;return t=this.items.length>0?this.items.map(function(t){var i=e.get(this.props.citationType+"-entry");return u(i,{node:t,active:this.isItemActive(t.id),handleSelection:this.handleSelection.bind(this)}).ref(t.id)}.bind(this)):[u("div").addClass("no-results").append("Nothing to reference.")],u("div").addClass("panel dialog cite-panel-component").append(u("div").addClass("dialog-header").append(u("a").addClass("back").attr("href","#").on("click",this.handleCancel).append(u(l,{icon:"fa-chevron-left"})),u("div").addClass("label").append(this.i18n.t("choose_referenced_items"))),u("div").addClass("panel-content").ref("panelContent").append(u("div").addClass("bib-items").append(t)))},this.willReceiveProps=function(t){this._initialize(t)},this._initialize=function(){this.items=this.getItems(this.props.citationType)},this.dispose=function(){this.$el.off("click",".back",this.handleCancel)},this.didMount=function(){var t=this.getFirstCitationTarget();t&&this.scrollToNode(t)},this.getFirstCitationTarget=function(){var t=this.props.doc,e=t.get(this.props.citationId);return e.targets[0]},this.isItemActive=function(t){if(!this.props.citationId)return!1;var e=this.props.doc,i=e.get(this.props.citationId);return s.includes(i.targets,t)},this.handleCancel=function(t){t.preventDefault(),this.send("switchContext","toc")},this.getItems=function(t){var e=this.props.doc,i=e.getCollection(t);return i.getItems()},this.handleSelection=function(t){var e=this.props.citationId,i=this.props.doc,n=i.get(e),r=n.targets.slice();s.includes(r,t)?r=s.without(r,t):r.push(t);var o=this.context.controller;o.transaction(function(t,e){return t.set([n.id,"targets"],r),e}),this.rerender()}},r.inherit(n,a),n.icon="fa-bullseye",n.isDialog=!0,e.exports=n},{"substance/ui/Component":279,"substance/ui/FontAwesomeIcon":288,"substance/ui/Panel":290,"substance/util/helpers":315,"substance/util/oo":317}],339:[function(t,e,i){var n=t("substance/packages/figure/Figure"),s=n.extend({name:"image-figure"});s["static"].citationType="image-figure-citation",s["static"].blockType=!0,s["static"].matchElement=function(t){return t.is("image-figure")},s["static"].fromHtml=function(t,e){var i,s=n["static"].fromHtml(t,e),r=t.find("img"),o=t.find("embed");return r.length>0?i=e.convertElement(r,{parent:s.id}):o.length>0&&(i=e.convertElement(o,{parent:s.id})),s.content=i.id,s},s["static"].toHtml=function(t,e){return n["static"].toHtml("image-figure",t,e)},e.exports=s},{"substance/packages/figure/Figure":244}],340:[function(t,e,i){var n=t("../citations/Citation"),s=n.extend({name:"image-figure-citation",getItemType:function(){return"image-figure"}});s["static"].matchElement=function(t){return t.is(s["static"].tagName)&&"image-figure"===t.attr("data-rtype")},s["static"].fromHtml=function(t,e){return n["static"].fromHtml(t,e)},s["static"].toHtml=function(t,e){var i=n["static"].toHtml(t,e);return i.attr("data-rtype","image-figure"),i},e.exports=s},{"../citations/Citation":335}],341:[function(t,e,i){"use strict";var n=t("../citations/CitationCommand"),s=n.extend({"static":{name:"imageFigureCitation",annotationType:"image-figure-citation"}});e.exports=s},{"../citations/CitationCommand":336}],342:[function(t,e,i){"use strict";var n=t("substance/ui/AnnotationTool"),s=n.extend({"static":{name:"Figure Citation",command:"imageFigureCitation"}});e.exports=s},{"substance/ui/AnnotationTool":276}],343:[function(t,e,i){"use strict";function n(){r.apply(this,arguments)}var s=t("substance/util/oo"),r=t("substance/ui/Component"),o=r.$$;n.Prototype=function(){this.render=function(){var t=o("div").addClass("figure border-bottom item pad clearfix small").attr("data-id",this.props.node.id).on("click",this.onClick).on("mousedown",this.onMouseDown);return this.props.active&&t.addClass("active"),t.append(o("img").addClass("image").attr("src",this.props.node.getContentNode().src)),t.append(o("div").addClass("title").append([this.props.node.label,this.props.node.title].join(" "))),t.append(o("div").addClass("caption truncate").append(this.props.node.caption)),t},this.onClick=function(t){t.preventDefault(),t.stopPropagation()},this.onMouseDown=function(t){t.preventDefault(),this.props.handleSelection(this.props.node.id)}},s.inherit(n,r),e.exports=n},{"substance/ui/Component":279,"substance/util/oo":317}],344:[function(t,e,i){var n=t("substance/packages/figure/Figure"),s=n.extend({name:"table-figure"});s["static"].components=["title","content","caption"],s["static"].citationType="table-figure-citation",s["static"].blockType=!0,s["static"].matchElement=function(t){return t.is("table-figure")},s["static"].fromHtml=function(t,e){var i=n["static"].fromHtml(t,e),s=e.convertElement(t.find("table"),{parent:i.id});return i.content=s.id,i},s["static"].toHtml=function(t,e){return n["static"].toHtml("table-figure",t,e)},e.exports=s},{"substance/packages/figure/Figure":244}],345:[function(t,e,i){var n=t("../citations/Citation"),s=n.extend({name:"table-figure-citation",getItemType:function(){return"table-figure"}});s["static"].matchElement=function(t){return t.is(s["static"].tagName)&&"table-figure"===t.attr("data-rtype")},s["static"].fromHtml=function(t,e){return n["static"].fromHtml(t,e)},s["static"].toHtml=function(t,e){var i=n["static"].toHtml(t,e);return i.attr("data-rtype","table-figure"),i},e.exports=s},{"../citations/Citation":335}],346:[function(t,e,i){"use strict";function n(){r.apply(this,arguments)}var s=t("substance/util/oo"),r=t("substance/ui/Component"),o=r.$$;n.Prototype=function(){this.render=function(){var t=o("div").addClass("figure border-bottom item pad clearfix small").attr("data-id",this.props.node.id);return t.on("click",this.onClick),t.on("mousedown",this.onMouseDown),this.props.active&&t.addClass("active"),t.append(o("div").addClass("title").append([this.props.node.label,this.props.node.title].join(" ")),o("div").addClass("caption truncate").append(this.props.node.caption))},this.onClick=function(t){t.preventDefault(),t.stopPropagation()},this.onMouseDown=function(t){t.preventDefault(),this.props.handleSelection(this.props.node.id)}},s.inherit(n,r),e.exports=n},{"substance/ui/Component":279,"substance/util/oo":317}],347:[function(t,e,i){var n=t("substance/util/jquery"),s=t("substance/model/DocumentNode"),r=s.extend({name:"article-meta",properties:{title:"string",authors:["array","string"],"abstract":"string"}});r["static"].matchElement=function(t){return t.is("meta")},r["static"].fromHtml=function(t,e){var i="article-meta",s={id:i,title:"",authors:[],"abstract":""},r=t.find("title");r.length?s.title=e.annotatedText(r,[i,"title"]):e.warning("ArticleMeta: no title found.");var o=t.find("authors author");o.each(function(){var t=e.convertElement(n(this));s.authors.push(t.id)});var a=t.find("abstract");return a.length?s["abstract"]=e.annotatedText(a,[i,"abstract"]):e.warning("ArticleMeta: no abstract found."),s},r["static"].toHtml=function(t,e){var i=t.id,s=n("<meta>"),r=e.getDocument(),o=n("<title>").append(e.annotatedText([i,"title"])),a=n("<abstract>").append(e.annotatedText([i,"abstract"])),l=n("<authors>");return t.authors.forEach(function(t){var i=r.get(t);l.append(e.convertNode(i))}),s.append(o,l,a)},e.exports=r},{"substance/model/DocumentNode":67,"substance/util/jquery":316}],348:[function(t,e,i){var n=t("substance/util/jquery"),s=t("substance/model/DocumentNode"),r=s.extend({name:"author",properties:{name:"string"}});r["static"].matchElement=function(t){return t.is("author")},r["static"].fromHtml=function(t,e){var i=e.defaultId(t,"author"),n={id:i,name:t.text()};return n},r["static"].toHtml=function(t,e){var i=n("<author>").attr("id",t.id).attr("name",t.name);return i},e.exports=r},{"substance/model/DocumentNode":67,"substance/util/jquery":316}],349:[function(t,e,i){"use strict";var n=t("substance/util/oo"),s=t("substance/ui/FormEditor"),r=t("substance/ui/Component").$$,o=t("substance/ui/TextPropertyComponent"),a=t("lodash/collection/map"),l=function(){s.apply(this,arguments)};l.Prototype=function(){this.render=function(){var t=this.getDocument(),e=t.getDocumentMeta();return r("div").addClass("document-cover").append(r(o,{tagName:"div",className:"title",path:[e.id,"title"]}).addClass("title"),r("div").addClass("authors clearfix").append(a(e.authors,function(t){return r(o,{tagName:"div",path:[t,"name"]}).addClass("author")})))}},n.inherit(l,s),e.exports=l},{"lodash/collection/map":15,"substance/ui/Component":279,"substance/ui/FormEditor":289,"substance/ui/TextPropertyComponent":302,"substance/util/oo":317}],350:[function(t,e,i){"use strict";function n(){r.apply(this,arguments)}var s=t("substance/util/oo"),r=t("substance/ui/Component"),o=r.$$,a=t("substance/ui/UndoTool"),l=t("substance/ui/RedoTool"),u=t("substance/ui/SaveTool"),c=t("substance/packages/text/TextTool"),h=t("substance/packages/strong/StrongTool"),p=t("substance/packages/emphasis/EmphasisTool"),d=t("substance/packages/embed/EmbedTool"),f=t("substance/packages/link/LinkTool"),m=t("substance/packages/figure/InsertFigureTool"),g=t("../figures/ImageFigureCitationTool"),b=t("../bibliography/BibItemCitationTool"),y=t("substance/ui/Dropdown"),v=t("substance/ui/FontAwesomeIcon");n.Prototype=function(){this.render=function(){var t=o("div").addClass("content-tools-component toolbar toolbar-component small fill-white");t.append(o("div").addClass("tool-group text clearfix").append(o(c))),t.append(o("div").addClass("tool-group document clearfix").append(o(a).append(o(v,{icon:"fa-undo"})),o(l).append(o(v,{icon:"fa-repeat"})),o(u).append(o(v,{icon:"fa-save"}))));var e=o(y,{label:o(v,{icon:"fa-image"}),title:this.i18n.t("figure")}).append(o(m).removeClass("tool").addClass("option").append(this.i18n.t("insert")),o(g).addClass("option").append(this.i18n.t("cite"))),i=o(y,{label:o(v,{icon:"fa-book"}),title:this.i18n.t("bib-item")}).append(o(b).addClass("option").append(this.i18n.t("cite")));return t.append(o("div").addClass("tool-group actions clearfix").append(e,i,o(d).append(o(v,{icon:"fa-code"}))),o("div").addClass("tool-group formatting clearfix float-right").append(o(h).append(o(v,{icon:"fa-bold"})),o(p).append(o(v,{icon:"fa-italic"})),o(f).append(o(v,{icon:"fa-link"})))),t}},s.inherit(n,r),e.exports=n},{"../bibliography/BibItemCitationTool":322,"../figures/ImageFigureCitationTool":342,"substance/packages/embed/EmbedTool":240,"substance/packages/emphasis/EmphasisTool":243,"substance/packages/figure/InsertFigureTool":247,"substance/packages/link/LinkTool":257,"substance/packages/strong/StrongTool":265,"substance/packages/text/TextTool":273,"substance/ui/Component":279,"substance/ui/Dropdown":287,"substance/ui/FontAwesomeIcon":288,"substance/ui/RedoTool":292,"substance/ui/SaveTool":294,"substance/ui/UndoTool":307,"substance/util/oo":317}],351:[function(t,e,i){"use strict";var n=t("substance/util/oo"),s=t("substance/ui/FormEditor"),r=t("substance/ui/Component").$$,o=t("substance/ui/TextPropertyComponent"),a=t("lodash/collection/map"),l=function(){s.apply(this,arguments)};l.Prototype=function(){this.render=function(){var t=this.getDocument(),e=t.getDocumentMeta();return r("div").addClass("document-cover").attr({contentEditable:!0,"data-id":"title-editor"}).append(r(o,{tagName:"div",className:"title",path:[e.id,"title"]}).addClass("title"),r("div").addClass("authors clearfix").append(a(e.authors,function(t){return r(o,{tagName:"div",path:[t,"name"]}).addClass("author")})))}},n.inherit(l,s),e.exports=l},{"lodash/collection/map":15,"substance/ui/Component":279,"substance/ui/FormEditor":289,"substance/ui/TextPropertyComponent":302,"substance/util/oo":317}]},{},[4]);