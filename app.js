!function t(e,i,s){function n(o,a){if(!i[o]){if(!e[o]){var l="function"==typeof require&&require;if(!a&&l)return l(o,!0);if(r)return r(o,!0);var c=new Error("Cannot find module '"+o+"'");throw c.code="MODULE_NOT_FOUND",c}var u=i[o]={exports:{}};e[o][0].call(u.exports,function(t){var i=e[o][1][t];return n(i?i:t)},u,u.exports,t,e,i,s)}return i[o].exports}for(var r="function"==typeof require&&require,o=0;o<s.length;o++)n(s[o]);return n}({1:[function(t,e,i){"use strict";t("./i18n/load");var s=(t("substance/helpers"),React.createElement),n=t("./backend"),r=new n,o=t("./notification_service"),a=new o,l=t("../lib/article/bib/crossref_search"),c=t("../src"),u=React.createClass({displayName:"App",childContextTypes:{backend:React.PropTypes.object,notifications:React.PropTypes.object,bibSearchEngines:React.PropTypes.array},getChildContext:function(){return{backend:r,bibSearchEngines:[new l],notifications:a}},render:function(){return s(c,{documentId:"sample"})}});$(function(){React.render(s(u,{route:window.location.hash.slice(1)}),document.getElementById("container"))})},{"../lib/article/bib/crossref_search":15,"../src":290,"./backend":2,"./i18n/load":4,"./notification_service":5,"substance/helpers":170}],2:[function(t,e,i){var s=t("substance"),n=t("../lib/article"),r=function(){};r.Prototype=function(){this._request=function(t,e,i,s){var n={type:t,url:e,contentType:"application/json; charset=UTF-8",success:function(t){s(null,t)},error:function(t){console.error(t),s(t.responseText)}};i&&(n.data=JSON.stringify(i));var r=localStorage.getItem("session");if(r){var o=JSON.parse(r).token;n.beforeSend=function(t){t.setRequestHeader("Authorization","Bearer "+o)}}$.ajax(n)},this.getDocument=function(t,e){this._request("GET","data/example-doc.xml",null,function(t,i){t&&(console.error(t),e(t));var s=n.fromXml(i);window.doc=s,e(null,s)})},this.saveDocument=function(t,e){e("Not supported in dev version")},this.uploadFigure=function(t,e){var i=URL.createObjectURL(t);e(null,i)}},s.initClass(r),e.exports=r},{"../lib/article":20,substance:171}],3:[function(t,e,i){e.exports={"menu.text_tool":"Update text","menu.undo":"Undo","menu.redo":"Redo","menu.save":"Save","menu.emphasis":"Emphasis","menu.strong":"Strong","menu.manage":"Manage","menu.cite":"Cite","menu.insert":"Insert",insert_column_before:"Insert column before",insert_column_after:"Insert column after",insert_k_columns_before:"Insert %{smart_count} column before |||| Insert %{smart_count} columns before",insert_k_columns_after:"Insert %{smart_count} column after |||| Insert %{smart_count} columns after",delete_column:"Remove column",delete_k_columns:"Remove %{smart_count} column |||| Remove %{smart_count} columns",insert_row_above:"Insert row above",insert_row_below:"Insert row below",insert_k_rows_above:"Insert %{smart_count} row above |||| Insert %{smart_count} rows above",insert_k_rows_below:"Insert %{smart_count} row below |||| Insert %{smart_count} rows below",delete_row:"Remove row",delete_k_rows:"Remove %{smart_count} row |||| Remove %{smart_count} rows",bibitem:"Reference",bibitems:"References",figure:"Figure",figures:"Figures",heading:"Heading",heading1:"Heading 1",heading2:"Heading 2",heading3:"Heading 3",heading4:"Heading 4",heading5:"Heading 5",caption:"Caption","export":"Export XML",title:"Title",no_selection:"No Selection",paragraph:"Paragraph",table:"Table",tables:"Tables"}},{}],4:[function(t,e,i){(function(e){var i=t("node-polyglot"),s=t("./en.json"),n=window.storage||window.localStorage,r=n.getItem("locale")||"en",o=JSON.parse(n.getItem("phrases"));"en"!==r&&o||(o=s);var a=new i({locale:r,phrases:o});e.i18n=a}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./en.json":3,"node-polyglot":145}],5:[function(t,e,i){"use strict";var s=t("substance"),n=function(){n["super"].call(this),this.messages=[]};n.Prototype=function(){this.addMessage=function(t){this.messages.push(t),this.emit("messages:updated",this.messages)},this.log=function(t){this.addMessage({type:"info",message:t})},this.error=function(t){this.addMessage({type:"error",message:t})},this.warn=this.log,this.info=this.log,this.clearMessages=function(){this.messages=[],this.emit("messages:updated",this.messages)}},s.inherit(n,s.EventEmitter),e.exports=n},{substance:171}],6:[function(t,e,i){var s=t("substance"),n=t("./article_schema"),r=s._,o=t("./converter/article_html_importer"),a=t("./converter/article_html_exporter"),l=t("./converter/article_xml_exporter"),c=t("./bib/citeproc_compiler"),u=t("./bib/bibliography"),h=t("./collections/collection"),p=function(){p["super"].call(this,n)};p.Prototype=function(){this.initialize=function(){this["super"].initialize.apply(this,arguments),this.create({type:"container",id:"main",nodes:[]}),this.citeprocCompiler=new c,this.collections={bib_item:new u(this,"main"),image_figure:new h(this,"main","image_figure","Figure"),table_figure:new h(this,"main","table_figure","Table")},this.includesIndex=this.addIndex("includes",s.Data.Index.create({type:"include",property:"nodeId"})),this.bibItemByGuidIndex=this.addIndex("bibItemByGuid",s.Data.Index.create({type:"bib_item",property:"guid"})),this.citationsIndex=this.addIndex("citations",s.Data.Index.create({type:"citation",property:"targets"}))},this.documentDidLoad=function(){p["super"].prototype.documentDidLoad.call(this),this.isClipboard()||r.each(this.collections,function(t){t.update()})},this.toXml=function(){return(new l).convert(this)},this.toHtml=function(){return(new a).convert(this)},this.propertyToHtml=function(t){return(new a).convertProperty(this,t)},this.getDocumentMeta=function(){return this.get("article-meta")},this.getTOCNodes=function(){var t=[],e=this.get("main").nodes;return r.each(e,function(e){var i=this.get(e);"heading"===i.type&&t.push(i)},this),t},this.getCiteprocCompiler=function(){return this.citeprocCompiler},this.getBibliography=function(){return this.collections.bib_item},this.getFiguresCollection=function(){return this.collections.image_figure},this.getTablesCollection=function(){return this.collections.table_figure},this.getCollection=function(t){return this.collections[t]},this.getTitle=function(){return this.get("article-meta").title},this.deleteFigure=function(t){this.transaction(function(e,i){var s=r.map(this.citationsIndex.get(t));r.each(s,function(t){e["delete"](t.id)});var n=r.map(e.getIndex("includes").get(t));return r.each(n,function(t){e.get("main").hide(t.id),e["delete"](t.id)}),e["delete"](t),i})},this.deleteBibItem=function(t){this.transaction(function(e,i){var s=r.map(e.getIndex("citations").get(t));return r.each(s,function(t){e["delete"](t.id)}),e["delete"](t),i})}},s.inherit(p,s.Document),p.fromHtml=function(t){var e;if("undefined"==typeof window)e=$(t);else{var i=new window.DOMParser,s=i.parseFromString(t,"text/xml");e=$(s)}var n=new p;return(new o).convert(e,n),n.documentDidLoad(),n},p.fromXml=function(t){$root=$(t);var e=new p;return(new o).convert($root,e),e.documentDidLoad(),e},p.ArticleHtmlImporter=o,e.exports=p},{"./article_schema":7,"./bib/bibliography":8,"./bib/citeproc_compiler":13,"./collections/collection":16,"./converter/article_html_exporter":17,"./converter/article_html_importer":18,"./converter/article_xml_exporter":19,substance:171}],7:[function(t,e,i){var s=t("substance"),n=s.Document.Include,r=s.Document.Paragraph,o=s.Document.Heading,a=s.Document.Emphasis,l=s.Document.Strong,c=s.Document.Link,u=s.Document.Table,h=s.Document.TableSection,p=s.Document.TableRow,f=s.Document.TableCell,d=s.Document.List,m=s.Document.ListItem,g=t("./nodes/article_meta"),b=t("./nodes/figure"),v=t("./nodes/image_figure"),y=t("./nodes/table_figure"),_=t("./nodes/image"),x=t("./nodes/bib_item"),w=t("./nodes/image_figure_citation"),S=t("./nodes/table_figure_citation"),O=t("./nodes/bib_item_citation"),T=new s.Document.Schema("scientific-article","0.0.1");T.getDefaultTextType=function(){return"paragraph"},T.addNodes([n,g,r,o,a,l,c,_,b,v,u,h,p,f,y,w,S,O,d,m,x]),e.exports=T},{"./nodes/article_meta":21,"./nodes/bib_item":22,"./nodes/bib_item_citation":23,"./nodes/figure":25,"./nodes/image":26,"./nodes/image_figure":27,"./nodes/image_figure_citation":28,"./nodes/table_figure":29,"./nodes/table_figure_citation":30,substance:171}],8:[function(t,e,i){"use strict";function s(t,e){n.EventEmitter.call(this),this.doc=t,this.containerId=e,this.bibitemsByGuid={},this._compileDebounced=r.debounce(this.compile.bind(this),50)}var n=t("substance"),r=t("substance/helpers");s.Prototype=function(){this.dispose=function(){this.doc.disconnect(this)},this.getDocument=function(){return this.doc},this.getCompiler=function(){return this.getDocument().getCiteprocCompiler()},this.compile=function(){var t=this.getDocument(),e=this.getCompiler(),i=t.get(this.containerId);e.clear();var s=t.getIndex("type").get("bib_item");this.bibitemsByGuid={},r.each(s,function(t){if("citeproc"!==t.format)throw new Error("Only 'citeproc' bibliographic items are supported right now.");var i=t.source,s=JSON.parse(i);s.id=t.id,e.addRecord(s),this.bibitemsByGuid[t.guid]=t},this);var n=t.getIndex("type").get("bib_item_citation"),o=r.map(n,function(t){var e=i.getComponent(t.path);return{citation:t,comp:e}});o.sort(function(t,e){var i=t.comp.getIndex()-e.comp.getIndex();return 0===i&&(i=t.citation.startOffset-e.citation.startOffset),i}),r.each(o,function(t){var e=t.citation;if(e.targets.length>0){var i=r.filter(e.targets,function(t){var e=!!s[t];return e||console.error("No Bibitem found with id",t),e}),n=this.getCompiler().addCitation(i);e.setLabel(n.label)}else e.setLabel("???")},this);var a=this.getCompiler().makeBibliography();a=r.sortBy(a,"rank"),this.sortedBibItems=r.map(a,function(t){var e=s[t.id];return e.setLabel(t.label),e.setText(t.content),e},this),this.emit("bibliography:updated")},this.update=function(){this._compileDebounced()},this.makeBibliography=function(){return this.getCompiler().makeBibliography()},this.getBibItems=function(){for(var t=[],e=this.getCompiler().getSortedIds(),i=0;i<e.length;i++)t.push(this.doc.get(e[i]));return t},this.getCompiledItems=function(){return this.sortedBibItems},this.getItems=function(){return this.getCompiledItems()}},n.inherit(s,n.EventEmitter),e.exports=s},{substance:171,"substance/helpers":170}],9:[function(t,e,s){Array.indexOf||(Array.prototype.indexOf=function(t){var e,i;for(e=0,i=this.length;i>e;e+=1)if(this[e]===t)return e;return-1});var n={PROCESSOR_VERSION:"1.0.542",CONDITION_LEVEL_TOP:1,CONDITION_LEVEL_BOTTOM:2,PLAIN_HYPHEN_REGEX:/(?:[^\\]-|\u2013)/,LOCATOR_LABELS_REGEXP:new RegExp("^((art|ch|Ch|subch|col|fig|l|n|no|op|p|pp|para|subpara|pt|r|sec|subsec|Sec|sv|sch|tit|vrs|vol)\\.)\\s+(.*)"),STATUTE_SUBDIV_GROUPED_REGEX:/((?:^| )(?:art|ch|Ch|subch|p|pp|para|subpara|pt|r|sec|subsec|Sec|sch|tit)\.)/g,STATUTE_SUBDIV_PLAIN_REGEX:/(?:(?:^| )(?:art|ch|Ch|subch|p|pp|para|subpara|pt|r|sec|subsec|Sec|sch|tit)\.)/,STATUTE_SUBDIV_STRINGS:{"art.":"article","bk.":"book","ch.":"chapter","Ch.":"Chapter","subch.":"subchapter","p.":"page","pp.":"page","para.":"paragraph","subpara.":"subparagraph","pt.":"part","r.":"rule","sec.":"section","subsec.":"subsection","Sec.":"Section","sch.":"schedule","tit.":"title","col.":"column","fig.":"figure","fol.":"folio","l.":"line","n.":"note","no.":"issue","op.":"opus","sv.":"sub-verbo","vrs.":"verse","vol.":"volume"},STATUTE_SUBDIV_STRINGS_REVERSE:{article:"art.",book:"bk.",chapter:"ch.",Chapter:"Ch.",subchapter:"subch.",page:"p.",paragraph:"para.",subparagraph:"subpara.",part:"pt.",rule:"r.",section:"sec.",subsection:"subsec.",Section:"Sec.",schedule:"sch.",title:"tit.",column:"col.",figure:"fig.",folio:"fol.",line:"l.",note:"n.",issue:"no.",opus:"op.","sub-verbo":"sv.","sub verbo":"sv.",verse:"vrs.",volume:"vol."},LOCATOR_LABELS_MAP:{art:"article",bk:"book",ch:"chapter",Ch:"Chapter",subch:"subchapter",col:"column",fig:"figure",fol:"folio",l:"line",n:"note",no:"issue",op:"opus",p:"page",pp:"page",para:"paragraph",subpara:"subparagraph",pt:"part",r:"rule",sec:"section",subsec:"subsection",Sec:"Section",sv:"sub-verbo",sch:"schedule",tit:"title",vrs:"verse",vol:"volume"},NestedBraces:[["(","["],[")","]"]],checkNestedBraceOpen:new RegExp(".*\\("),checkNestedBraceClose:new RegExp(".*\\)"),LangPrefsMap:{title:"titles","title-short":"titles","container-title":"journals","collection-title":"journals",publisher:"publishers",authority:"publishers","publisher-place":"places","event-place":"places",number:"number",edition:"number",issue:"number",volume:"number"},AbbreviationSegments:function(){this["container-title"]={},this["collection-title"]={},this["institution-entire"]={},this["institution-part"]={},this.nickname={},this.number={},this.title={},this.place={},this.hereinafter={},this.classic={},this["container-phrase"]={},this["title-phrase"]={}},GENDERS:["masculine","feminine"],ERROR_NO_RENDERED_FORM:1,PREVIEW:"Just for laughs.",ASSUME_ALL_ITEMS_REGISTERED:2,START:0,END:1,SINGLETON:2,SEEN:6,SUCCESSOR:3,SUCCESSOR_OF_SUCCESSOR:4,SUPPRESS:5,SINGULAR:0,PLURAL:1,LITERAL:!0,BEFORE:1,AFTER:2,DESCENDING:1,ASCENDING:2,ONLY_FIRST:1,ALWAYS:2,ONLY_LAST:3,FINISH:1,POSITION_FIRST:0,POSITION_SUBSEQUENT:1,POSITION_IBID:2,POSITION_IBID_WITH_LOCATOR:3,MARK_TRAILING_NAMES:!0,POSITION_TEST_VARS:["position","first-reference-note-number","near-note"],AREAS:["citation","citation_sort","bibliography","bibliography_sort"],MULTI_FIELDS:["event","publisher","publisher-place","event-place","title","container-title","collection-title","authority","edition","genre","title-short","medium","jurisdiction","archive","archive-place"],CITE_FIELDS:["first-reference-note-number","locator","locator-revision"],MINIMAL_NAME_FIELDS:["literal","family"],SWAPPING_PUNCTUATION:[".","!","?",":",","],TERMINAL_PUNCTUATION:[":",".",";","!","?"," "],NONE:0,NUMERIC:1,POSITION:2,COLLAPSE_VALUES:["citation-number","year","year-suffix"],DATE_PARTS:["year","month","day"],DATE_PARTS_ALL:["year","month","day","season"],DATE_PARTS_INTERNAL:["year","month","day","year_end","month_end","day_end"],NAME_PARTS:["family","given","dropping-particle","non-dropping-particle","suffix","literal"],DECORABLE_NAME_PARTS:["given","family","suffix"],DISAMBIGUATE_OPTIONS:["disambiguate-add-names","disambiguate-add-givenname","disambiguate-add-year-suffix"],GIVENNAME_DISAMBIGUATION_RULES:["all-names","all-names-with-initials","primary-name","primary-name-with-initials","by-cite"],NAME_ATTRIBUTES:["and","delimiter-precedes-last","delimiter-precedes-et-al","initialize-with","initialize","name-as-sort-order","sort-separator","et-al-min","et-al-use-first","et-al-subsequent-min","et-al-subsequent-use-first","form","prefix","suffix","delimiter"],PARALLEL_MATCH_VARS:["container-title"],PARALLEL_TYPES:["bill","gazette","regulation","legislation","legal_case","treaty","article-magazine","article-journal"],PARALLEL_COLLAPSING_MID_VARSET:["volume","issue","container-title","section","collection-number"],LOOSE:0,STRICT:1,TOLERANT:2,PREFIX_PUNCTUATION:/[.;:]\s*$/,SUFFIX_PUNCTUATION:/^\s*[.;:,\(\)]/,NUMBER_REGEXP:/(?:^\d+|\d+$)/,NAME_INITIAL_REGEXP:/^([A-Z\u0590-\u05ff\u0080-\u017f\u0400-\u042f\u0600-\u06ff\u0370\u0372\u0376\u0386\u0388-\u03ab\u03e2\u03e4\u03e6\u03e8\u03ea\u03ec\u03ee\u03f4\u03f7\u03fd-\u03ff])([a-zA-Z\u0080-\u017f\u0400-\u052f\u0600-\u06ff\u0370-\u03ff\u1f00-\u1fff]*|)/,ROMANESQUE_REGEXP:/[-0-9a-zA-Z\u0590-\u05d4\u05d6-\u05ff\u0080-\u017f\u0400-\u052f\u0370-\u03ff\u1f00-\u1fff\u0600-\u06ff\u200c\u200d\u200e\u0218\u0219\u021a\u021b\u202a-\u202e]/,ROMANESQUE_NOT_REGEXP:/[^a-zA-Z\u0590-\u05ff\u0080-\u017f\u0400-\u052f\u0370-\u03ff\u1f00-\u1fff\u0600-\u06ff\u200c\u200d\u200e\u0218\u0219\u021a\u021b\u202a-\u202e]/g,STARTSWITH_ROMANESQUE_REGEXP:/^[&a-zA-Z\u0590-\u05d4\u05d6-\u05ff\u0080-\u017f\u0400-\u052f\u0370-\u03ff\u1f00-\u1fff\u0600-\u06ff\u200c\u200d\u200e\u0218\u0219\u021a\u021b\u202a-\u202e]/,ENDSWITH_ROMANESQUE_REGEXP:/[.;:&a-zA-Z\u0590-\u05d4\u05d6-\u05ff\u0080-\u017f\u0400-\u052f\u0370-\u03ff\u1f00-\u1fff\u0600-\u06ff\u200c\u200d\u200e\u0218\u0219\u021a\u021b\u202a-\u202e]$/,ALL_ROMANESQUE_REGEXP:/^[a-zA-Z\u0590-\u05ff\u0080-\u017f\u0400-\u052f\u0370-\u03ff\u1f00-\u1fff\u0600-\u06ff\u200c\u200d\u200e\u0218\u0219\u021a\u021b\u202a-\u202e]+$/,VIETNAMESE_SPECIALS:/[\u00c0-\u00c3\u00c8-\u00ca\u00cc\u00cd\u00d2-\u00d5\u00d9\u00da\u00dd\u00e0-\u00e3\u00e8-\u00ea\u00ec\u00ed\u00f2-\u00f5\u00f9\u00fa\u00fd\u0101\u0103\u0110\u0111\u0128\u0129\u0168\u0169\u01a0\u01a1\u01af\u01b0\u1ea0-\u1ef9]/,VIETNAMESE_NAMES:/^(?:(?:[.AaBbCcDdEeGgHhIiKkLlMmNnOoPpQqRrSsTtUuVvXxYy \u00c0-\u00c3\u00c8-\u00ca\u00cc\u00cd\u00d2-\u00d5\u00d9\u00da\u00dd\u00e0-\u00e3\u00e8-\u00ea\u00ec\u00ed\u00f2-\u00f5\u00f9\u00fa\u00fd\u0101\u0103\u0110\u0111\u0128\u0129\u0168\u0169\u01a0\u01a1\u01af\u01b0\u1ea0-\u1ef9]{2,6})(\s+|$))+$/,NOTE_FIELDS_REGEXP:/\{:(?:[\-_a-z]+|[A-Z]+):[^\}]+\}/g,NOTE_FIELD_REGEXP:/\{:([\-_a-z]+|[A-Z]+):\s*([^\}]+)\}/,DISPLAY_CLASSES:["block","left-margin","right-inline","indent"],NAME_VARIABLES:["author","editor","translator","contributor","collection-editor","composer","container-author","director","editorial-director","interviewer","original-author","recipient"],NUMERIC_VARIABLES:["call-number","chapter-number","collection-number","edition","page","issue","locator","number","number-of-pages","number-of-volumes","volume","citation-number"],DATE_VARIABLES:["locator-date","issued","event-date","accessed","container","original-date","publication-date","original-date","available-date","submitted"],TAG_ESCAPE:function(t){var e,i,s,n,r;for(e=t.match(/((?:\"|\')|(?:(?:<span\s+class=\"no(?:case|decor)\">).*?(?:<\/span>|<\/?(?:i|sc|b)>)))/g),i=t.split(/(?:(?:\"|\')|(?:(?:<span\s+class=\"no(?:case|decor)\">).*?(?:<\/span>|<\/?(?:i|sc|b)>)))/g),r=[i[0]],n=1,s=i.length;s>n;n+=1)r.push(e[n-1]),r.push(i[n]);return i=r.slice()},TAG_USEALL:function(t){var e,i,s,n;for(e=[""],i=t.indexOf("<"),s=t.indexOf(">");i>-1&&s>-1;)n=i>s?i+1:s+1,s>i&&-1===t.slice(i+1,s).indexOf("<")?(e[e.length-1]+=t.slice(0,i),e.push(t.slice(i,s+1)),e.push(""),t=t.slice(n)):(e[e.length-1]+=t.slice(0,s+1),t=t.slice(n)),i=t.indexOf("<"),s=t.indexOf(">");return e[e.length-1]+=t,e},SKIP_WORDS:["about","above","across","afore","after","against","along","alongside","amid","amidst","among","amongst","anenst","apropos","apud","around","as","aside","astride","at","athwart","atop","barring","before","behind","below","beneath","beside","besides","between","beyond","but","by","circa","despite","down","during","except","for","forenenst","from","given","in","inside","into","lest","like","modulo","near","next","notwithstanding","of","off","on","onto","out","over","per","plus","pro","qua","sans","since","than","through"," thru","throughout","thruout","till","to","toward","towards","under","underneath","until","unto","up","upon","versus","vs.","v.","vs","v","via","vis-Ã -vis","with","within","without","according to","ahead of","apart from","as for","as of","as per","as regards","aside from","back to","because of","close to","due to","except for","far from","inside of","instead of","near to","next to","on to","out from","out of","outside of","prior to","pursuant to","rather than","regardless of","such as","that of","up to","where as","or","yet","so","for","and","nor","a","an","the","de","d'","von","van","c","et","ca"],FORMAT_KEY_SEQUENCE:["@strip-periods","@font-style","@font-variant","@font-weight","@text-decoration","@vertical-align","@quotes"],INSTITUTION_KEYS:["font-style","font-variant","font-weight","text-decoration","text-case"],SUFFIX_CHARS:"a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z",ROMAN_NUMERALS:[["","i","ii","iii","iv","v","vi","vii","viii","ix"],["","x","xx","xxx","xl","l","lx","lxx","lxxx","xc"],["","c","cc","ccc","cd","d","dc","dcc","dccc","cm"],["","m","mm","mmm","mmmm","mmmmm"]],CREATORS:["author","editor","contributor","translator","recipient","interviewer","composer","original-author","container-author","collection-editor"],LANGS:{"af-ZA":"Afrikaans","ar-AR":"Arabic","bg-BG":"Bulgarian","ca-AD":"Catalan","cs-CZ":"Czech","da-DK":"Danish","de-AT":"Austrian","de-CH":"German (CH)","de-DE":"German (DE)","el-GR":"Greek","en-GB":"English (GB)","en-US":"English (US)","es-ES":"Spanish","et-EE":"Estonian",eu:"European","fa-IR":"Persian","fi-FI":"Finnish","fr-CA":"French (CA)","fr-FR":"French (FR)","he-IL":"Hebrew","hr-HR":"Croatian","hu-HU":"Hungarian","is-IS":"Icelandic","it-IT":"Italian","ja-JP":"Japanese","km-KH":"Khmer","ko-KR":"Korean","lt-LT":"Lithuanian","lv-LV":"Latvian","mn-MN":"Mongolian","nb-NO":"Norwegian (BokmÃ¥l)","nl-NL":"Dutch","nn-NO":"Norwegian (Nynorsk)","pl-PL":"Polish","pt-BR":"Portuguese (BR)","pt-PT":"Portuguese (PT)","ro-RO":"Romanian","ru-RU":"Russian","sk-SK":"Slovak","sl-SI":"Slovenian","sr-RS":"Serbian","sv-SE":"Swedish","th-TH":"Thai","tr-TR":"Turkish","uk-UA":"Ukranian","vi-VN":"Vietnamese","zh-CN":"Chinese (CN)","zh-TW":"Chinese (TW)"},LANG_BASES:{af:"af_ZA",ar:"ar_AR",bg:"bg_BG",ca:"ca_AD",cs:"cs_CZ",da:"da_DK",de:"de_DE",el:"el_GR",en:"en_US",es:"es_ES",et:"et_EE",eu:"eu",fa:"fa_IR",fi:"fi_FI",fr:"fr_FR",he:"he_IL",hu:"hu_HU",is:"is_IS",it:"it_IT",ja:"ja_JP",km:"km_KH",ko:"ko_KR",lt:"lt_LT",mn:"mn_MN",nb:"nb_NO",nl:"nl_NL",nn:"nn-NO",pl:"pl_PL",pt:"pt_PT",ro:"ro_RO",ru:"ru_RU",sk:"sk_SK",sl:"sl_SI",sr:"sr_RS",sv:"sv_SE",th:"th_TH",tr:"tr_TR",uk:"uk_UA",vi:"vi_VN",zh:"zh_CN"},SUPERSCRIPTS:{"ª":"a","²":"2","³":"3","¹":"1","º":"o","ʰ":"h","ʱ":"ɦ","ʲ":"j","ʳ":"r","ʴ":"ɹ","ʵ":"ɻ","ʶ":"ʁ","ʷ":"w","ʸ":"y","ˠ":"ɣ","ˡ":"l","ˢ":"s","ˣ":"x","ˤ":"ʕ","ᴬ":"A","ᴭ":"Æ","ᴮ":"B","ᴰ":"D","ᴱ":"E","ᴲ":"Ǝ","ᴳ":"G","ᴴ":"H","ᴵ":"I","ᴶ":"J","ᴷ":"K","ᴸ":"L","ᴹ":"M","ᴺ":"N","ᴼ":"O","ᴽ":"Ȣ","ᴾ":"P","ᴿ":"R","ᵀ":"T","ᵁ":"U","ᵂ":"W","ᵃ":"a","ᵄ":"ɐ","ᵅ":"ɑ","ᵆ":"ᴂ","ᵇ":"b","ᵈ":"d","ᵉ":"e","ᵊ":"ə","ᵋ":"ɛ","ᵌ":"ɜ","ᵍ":"g","ᵏ":"k","ᵐ":"m","ᵑ":"ŋ","ᵒ":"o","ᵓ":"ɔ","ᵔ":"ᴖ","ᵕ":"ᴗ","ᵖ":"p","ᵗ":"t","ᵘ":"u","ᵙ":"ᴝ","ᵚ":"ɯ","ᵛ":"v","ᵜ":"ᴥ","ᵝ":"β","ᵞ":"γ","ᵟ":"δ","ᵠ":"φ","ᵡ":"χ","⁰":"0","ⁱ":"i","⁴":"4","⁵":"5","⁶":"6","⁷":"7","⁸":"8","⁹":"9","⁺":"+","⁻":"−","⁼":"=","⁽":"(","⁾":")","ⁿ":"n","℠":"SM","™":"TM","㆒":"一","㆓":"二","㆔":"三","㆕":"四","㆖":"上","㆗":"中","㆘":"下","㆙":"甲","㆚":"乙","㆛":"丙","㆜":"丁","㆝":"天","㆞":"地","㆟":"人","ˀ":"ʔ","ˁ":"ʕ","ۥ":"و","ۦ":"ي"},SUPERSCRIPTS_REGEXP:new RegExp("[ª²³¹ºʰʱʲʳʴʵʶʷʸˠˡˢˣˤᴬᴭᴮᴰᴱᴲᴳᴴᴵᴶᴷᴸᴹᴺᴼᴽᴾᴿᵀᵁᵂᵃᵄᵅᵆᵇᵈᵉᵊᵋᵌᵍᵏᵐᵑᵒᵓᵔᵕᵖᵗᵘᵙᵚᵛᵜᵝᵞᵟᵠᵡ⁰ⁱ⁴⁵⁶⁷⁸⁹⁺⁻⁼⁽⁾ⁿ℠™㆒㆓㆔㆕㆖㆗㆘㆙㆚㆛㆜㆝㆞㆟ˀˁۥۦ]","g"),locale:{},locale_opts:{},locale_dates:{}};if("undefined"!=typeof t&&"undefined"!=typeof e&&"exports"in e){var r=!0,o=t("./csl_nodejs_jsdom").CSL_NODEJS_JSDOM;s.CSL=n}n.TERMINAL_PUNCTUATION_REGEXP=new RegExp("^(["+n.TERMINAL_PUNCTUATION.slice(0,-1).join("")+"])(.*)"),n.CLOSURES=new RegExp(".*[\\]\\)]"),"object"==typeof console&&"function"==typeof console.log?(n.debug=function(t){console.log("CSL: "+t)},n.error=function(t){console.log("CSL error: "+t)}):(n.debug=function(){},n.error=function(t){throw"CSL error: "+t});var a;a="undefined"!=typeof r?o:"undefined"!=typeof CSL_E4X?CSL_E4X:"undefined"!=typeof CSL_JSON?CSL_JSON:CSL_CHROME,n.System={},n.System.Xml={Parsing:a},n.getSortCompare=function(t){if(n.stringCompare)return n.stringCompare;var e,i={sensitivity:"base",ignorePunctuation:!0,numeric:!0};t||(t="en-US"),e=function(e,s){return e.toLocaleLowerCase().localeCompare(s.toLocaleLowerCase(),t,i)};var s=function(t){return t.replace(/^[\[\]\'\"]*/g,"")},r=function(){return e("[x","x")?function(t,i){return e(s(t),s(i))}:!1},o=r(),a=function(t,i){return o?o(t,i):e(t,i)};return a},n.ambigConfigDiff=function(t,e){var i,s,n,r;if(t.names.length!==e.names.length)return 1;for(i=0,s=t.names.length;s>i;i+=1){if(t.names[i]!==e.names[i])return 1;for(n=0,r=t.givens[i];r>n;n+=1)if(t.givens[i][n]!==e.givens[i][n])return 1}return t.disambiguate!=e.disambiguate?1:t.year_suffix!==e.year_suffix?1:0},n.cloneAmbigConfig=function(t,e,i){var s,n,r,o,a,l={};for(l.names=[],l.givens=[],l.year_suffix=!1,l.disambiguate=!1,s=0,n=t.names.length;n>s;s+=1)a=t.names[s],l.names[s]=a;for(s=0,n=t.givens.length;n>s;s+=1){for(a=[],r=0,o=t.givens[s].length;o>r;r+=1)a.push(t.givens[s][r]);l.givens.push(a)}return e?(l.year_suffix=e.year_suffix,l.disambiguate=e.disambiguate):(l.year_suffix=t.year_suffix,l.disambiguate=t.disambiguate),l},n.getAmbigConfig=function(){var t,e;return t=this.tmp.disambig_request,t||(t=this.tmp.disambig_settings),e=n.cloneAmbigConfig(t)},n.getMaxVals=function(){return this.tmp.names_max.mystack.slice()},n.getMinVal=function(){return this.tmp["et-al-min"]},n.tokenExec=function(t,e,i){var s,n,r,o,a,l;l=!1,s=t.next,n=!1;var c=function(e){return e?(this.tmp.jump.replace("succeed"),t.succeed):(this.tmp.jump.replace("fail"),t.fail)};for(t.test&&(s=c.call(this,t.test(e,i))),a=t.execs.length,o=0;a>o;o+=1)r=t.execs[o],n=r.call(t,this,e,i),n&&(s=n);return s},n.expandMacro=function(t){var e,i,s,r;if(e=t.postponed_macro,this.build.macro_stack.indexOf(e)>-1)throw'CSL processor error: call to macro "'+e+'" would cause an infinite loop';this.build.macro_stack.push(e);var o=!1,a=!1;if(i=this.sys.xml.getNodesByName(this.cslXml,"macro",e),i.length&&(a=this.sys.xml.getAttributeValue(i[0],"cslid"),o=this.sys.xml.getAttributeValue(i[0],"macro-has-date")),o&&(r=function(t,e){t.tmp.extension&&(t.tmp["doing-macro-with-date"]=!0)},t.execs.push(r)),t.tokentype=n.START,t.cslid=a,n.Node.group.build.call(t,this,this[this.build.area].tokens,!0),!this.sys.xml.getNodeValue(i))throw'CSL style error: undefined macro "'+e+'"';var l=n.makeBuilder(this);l(i[0]),s=new n.Token("group",n.END),t.decorations&&(s.decorations=t.decorations.slice()),o&&(r=function(t,e){t.tmp.extension&&(t.tmp["doing-macro-with-date"]=!1)},s.execs.push(r)),n.Node.group.build.call(s,this,this[this.build.area].tokens,!0),this.build.macro_stack.pop()},n.XmlToToken=function(t,e){var i,s,r,o,a,l,c,u;if(i=t.sys.xml.nodename(this),!t.build.skip||t.build.skip===i){if(!i)return s=t.sys.xml.content(this),void(s&&(t.build.text=s));if(!n.Node[t.sys.xml.nodename(this)])throw'Undefined node name "'+i+'".';if(r=[],o=t.sys.xml.attributes(this),a=n.setDecorations.call(this,t,o),l=new n.Token(i,e),e!==n.END||"if"===i||"else-if"===i||"layout"===i){for(c in o)if(o.hasOwnProperty(c)){if(e===n.END&&"@language"!==c&&"@locale"!==c)continue;if(o.hasOwnProperty(c))if(n.Attributes[c])try{n.Attributes[c].call(l,t,""+o[c])}catch(h){throw n.error(h),"CSL processor error, "+c+" attribute: "+h}else n.debug('warning: undefined attribute "'+c+'" in style')}l.decorations=a}else e===n.END&&o["@variable"]&&(l.hasVariable=!0);u=t[t.build.area].tokens,n.Node[i].build.call(l,t,u)}},n.DateParser=function(){var t,e,i,s,r,o,a,l,c,u,h,p,f,d,m,g,b,v,y,_,x,w,S,O,T;for(t=[["明治",1867],["大正",1911],["昭和",1925],["平成",1988]],e={},S=t.length,a=0;S>a;a+=1)l=t[a][0],c=t[a][1],e[l]=c;for(O=[],a=0;S>a;a+=1)c=t[a][0],O.push(c);for(O=O.join("|"),i="(?:"+O+")(?:[0-9]+)",i=new RegExp(i),T="(?:"+O+")(?:[0-9]+)",T=new RegExp(T,"g"),r=/(\u6708|\u5E74)/g,s=/\u65E5/,o=/\u301c/g,u="(?:[?0-9]{1,2}%%NUMD%%){0,2}[?0-9]{4}(?![0-9])",h="[?0-9]{4}(?:%%NUMD%%[?0-9]{1,2}){0,2}(?![0-9])",p="[?0-9]{1,3}",f="[%%DATED%%]",d="[?~]",m="[a-zA-Z]+",g="("+h+"|"+u+"|"+p+"|"+f+"|"+d+"|"+m+")",b=new RegExp(g.replace(/%%NUMD%%/g,"-").replace(/%%DATED%%/g,"-")),v=new RegExp(g.replace(/%%NUMD%%/g,"-").replace(/%%DATED%%/g,"/")),y=new RegExp(g.replace(/%%NUMD%%/g,"/").replace(/%%DATED%%/g,"-")),_=[],x=[],S=_.length,a=0;S>a;a+=1)w=new RegExp(_[a]+".*"),x.push(w);this.mstrings="january february march april may june july august september october november december spring summer fall winter spring summer",this.mstrings=this.mstrings.split(" "),this.setOrderDayMonth=function(){this.monthguess=1,this.dayguess=0},this.setOrderMonthDay=function(){this.monthguess=0,this.dayguess=1},this.setOrderMonthDay(),this.resetMonths=function(){var t,e,i,s;for(this.msets=[],t=0,e=this.mstrings.length;e>t;t+=1)this.msets.push([this.mstrings[t]]);for(this.mabbrevs=[],t=0,e=this.msets.length;e>t;t+=1)for(this.mabbrevs.push([]),i=0,s=this.msets[t].length;s>i;i+=1)this.mabbrevs[t].push(this.msets[t][0].slice(0,3));for(this.mrexes=[],t=0,e=this.mabbrevs.length;e>t;t+=1)this.mrexes.push(new RegExp("(?:"+this.mabbrevs[t].join("|")+")"))},this.resetMonths(),this.addMonths=function(t){var e,i,s,r,o,a,l,c;if("string"==typeof t&&(t=t.split(/\s+/)),12!==t.length&&16!==t.length)return void n.debug("month [+season] list of "+t.length+", expected 12 or 16. Ignoring.");for(e=0,i=t.length;i>e;e+=1){var u=!1,h=!1,p=3,f={};for(s=0,r=this.mabbrevs.length;r>s;s+=1){if(f[s]={},s===e){for(o=0,a=this.mabbrevs[e].length;a>o;o+=1)if(this.mabbrevs[e][o]===t[e].slice(0,this.mabbrevs[e][o].length)){h=!0;break}}else for(o=0,a=this.mabbrevs[s].length;a>o;o+=1)if(u=this.mabbrevs[s][o].length,this.mabbrevs[s][o]===t[e].slice(0,u)){for(;this.msets[s][o].slice(0,u)===t[e].slice(0,u);){if(u>t[e].length||u>this.msets[s][o].length){n.debug("unable to disambiguate month string in date parser: "+t[e]);break}u+=1}p=u,f[s][o]=u}for(l in f)if(f.hasOwnProperty(l))for(c in f[l])f[l].hasOwnProperty(c)&&(u=f[l][c],l=parseInt(l,10),c=parseInt(c,10),this.mabbrevs[l][c]=this.msets[l][c].slice(0,u))}h||(this.msets[e].push(t[e]),this.mabbrevs[e].push(t[e].slice(0,p)))}for(this.mrexes=[],e=0,i=this.mabbrevs.length;i>e;e+=1)this.mrexes.push(new RegExp("(?:"+this.mabbrevs[e].join("|")+")"))},this.parse=function(t){var l,c,u,h,p,f,d,m,g,_,w,O,I,N,E,C,A,k,R,P,D,j,L,M,U,B,F,q,$,H;if(t&&(t=""+t,t=t.replace(/\s*[0-9]{2}:[0-9]{2}(?::[0-9]+)/,""),p=t.match(r))){if(t=t.replace(/\s+/,"","g"),t=t.replace(s,"","g"),t=t.replace(r,"-","g"),t=t.replace(o,"/","g"),t=t.replace("-/","/","g"),t=t.replace(/-$/,"","g"),L=t.split(i),u=[],j=t.match(T)){var z=[];for(a=0,S=j.length;S>a;a+=1)z=z.concat(j[a].match(/([^0-9]+)([0-9]+)/).slice(1));for(a=0,S=L.length;S>a;a+=1)u.push(L[a]),a!==S-1&&(M=2*a,u.push(z[M]),u.push(z[M+1]))}else u=L;for(h=u.length,a=1;h>a;a+=3)u[a+1]=e[u[a]]+parseInt(u[a+1],10),u[a]="";t=u.join(""),t=t.replace(/\s*-\s*$/,"").replace(/\s*-\s*\//,"/"),t=t.replace(/\.\s*$/,""),t=t.replace(/\.(?! )/,""),l=t.indexOf("/"),c=t.indexOf("-")}if(t=t.replace(/([A-Za-z])\./g,"$1"),f="",d="",m={},'"'===t.slice(0,1)&&'"'===t.slice(-1))return m.literal=t.slice(1,-1),m;for(l>-1&&c>-1?(g=t.split("/"),g.length>3?(_="-",w="/",u=t.split(y)):(_="/",w="-",u=t.split(v))):(t=t.replace("/","-"),_="-",w="-",u=t.split(b)),O=[],S=u.length,a=0;S>a;a+=1)R=u[a],p=R.match(/^\s*([\-\/]|[a-zA-Z]+|[\-~?0-9]+)\s*$/),p&&O.push(p[1]);for(I=O.indexOf(_),N=[],E=!1,I>-1?(N.push([0,I]),N.push([I+1,O.length]),E=!0):N.push([0,O.length]),C="",U=0,B=N.length;B>U;U+=1){for(P=N[U],A=O.slice(P[0],P[1]),F=0,q=A.length;q>F;F+=1)if(D=A[F],D.indexOf(w)>-1)this.parseNumericDate(m,w,C,D);else if(D.match(/[0-9]{4}/))m["year"+C]=D.replace(/^0*/,"");else{for(k=!1,$=0,H=this.mrexes.length;H>$;$+=1){if(D.toLocaleLowerCase().match(this.mrexes[$])){m["month"+C]=""+(parseInt($,10)+1),k=!0;break}k||(D.match(/^[0-9]+$/)&&(f=parseInt(D,10)),D.toLocaleLowerCase().match(/^bc/)&&f?(m["year"+C]=""+-1*f,f=""):D.toLocaleLowerCase().match(/^ad/)&&f&&(m["year"+C]=""+f,f=""))}for(k=!1,$=0,H=x.length;H>$;$+=1)if(D.toLocaleLowerCase().match(x[$])){m["season"+C]=""+(parseInt($,10)+1),k=!0;break}k||("~"===D||"?"===D||"c"===D||D.match(/^cir/)?m.circa="1":!D.toLocaleLowerCase().match(/(?:mic|tri|hil|eas)/)||m["season"+C]||(d=D))}f&&(m["day"+C]=f,f=""),d&&!m["season"+C]&&(m["season"+C]=d,d=""),C="_end"}if(E)for(F=0,q=n.DATE_PARTS_ALL.length;q>F;F+=1)R=n.DATE_PARTS_ALL[F],m[R]&&!m[R+"_end"]?m[R+"_end"]=m[R]:!m[R]&&m[R+"_end"]&&(m[R]=m[R+"_end"]);return m.year||(m={literal:t}),this.use_array&&this.toArray(m),m},this.returnAsArray=function(){this.use_array=!0},this.returnAsKeys=function(){this.use_array=!1},this.toArray=function(t){var e,i,s;t["date-parts"]=[],t["date-parts"].push([]);var n=0;for(e=0,i=3;i>e&&(s=["year","month","day"][e],t[s]);e+=1)n+=1,t["date-parts"][0].push(t[s]),delete t[s];for(t["date-parts"].push([]),e=0,i=n;i>e&&(s=["year_end","month_end","day_end"][e],t[s]);e+=1)t["date-parts"][1].push(t[s]),delete t[s];t["date-parts"][0].length!==t["date-parts"][1].length&&t["date-parts"].pop()},this.parseNumericDate=function(t,e,i,s){var n,r,o;for(n=s.split(e),
r=0,o=n.length;o>r;r+=1)if(4===n[r].length){t["year"+i]=n[r].replace(/^0*/,""),n=r?n.slice(0,r):n.slice(1);break}for(r=0,o=n.length;o>r;r+=1)n[r]=parseInt(n[r],10);1===n.length||2===n.length&&!n[1]?t["month"+i]=""+n[0]:2===n.length&&(n[this.monthguess]>12?(t["month"+i]=""+n[this.dayguess],t["day"+i]=""+n[this.monthguess]):(t["month"+i]=""+n[this.monthguess],t["day"+i]=""+n[this.dayguess]))}},n.Engine=function(t,e,i,s){function r(t){var t=t.slice(),e=new RegExp("((?:[?!:]*\\s+|-|^)(?:"+t.join("|")+")(?=[!?:]*\\s+|-|$))");return e}var o,a;this.processor_version=n.PROCESSOR_VERSION,this.csl_version="1.0",this.sys=t,t.variableWrapper&&(n.VARIABLE_WRAPPER_PREPUNCT_REX=new RegExp("^(["+[" "].concat(n.SWAPPING_PUNCTUATION).join("")+"]*)(.*)")),this.sys.xml=new n.System.Xml.Parsing,"undefined"==typeof CSL_JSON&&"string"!=typeof e&&(e=""),n.getAbbreviation&&(this.sys.getAbbreviation=n.getAbbreviation),this.sys.stringCompare&&(n.stringCompare=this.sys.stringCompare),this.sys.AbbreviationSegments=n.AbbreviationSegments,this.parallel=new n.Parallel(this),this.transform=new n.Transform(this),this.setParseNames=function(t){this.opt["parse-names"]=t},this.opt=new n.Engine.Opt,this.tmp=new n.Engine.Tmp,this.build=new n.Engine.Build,this.fun=new n.Engine.Fun(this),this.configure=new n.Engine.Configure,this.citation_sort=new n.Engine.CitationSort,this.bibliography_sort=new n.Engine.BibliographySort,this.citation=new n.Engine.Citation(this),this.bibliography=new n.Engine.Bibliography,this.output=new n.Output.Queue(this),this.dateput=new n.Output.Queue(this),this.cslXml=this.sys.xml.makeXml(e),(this.opt.development_extensions.csl_reverse_lookup_support||this.sys.csl_reverse_lookup_support)&&(this.build.cslNodeId=0,this.setCslNodeIds=function(t,e){var i=this.sys.xml.children(t);this.sys.xml.setAttribute(t,"cslid",this.build.cslNodeId),this.opt.nodenames.push(e),this.build.cslNodeId+=1;for(var s=0,n=this.sys.xml.numberofnodes(i);n>s;s+=1)e=this.sys.xml.nodename(i[s]),e&&this.setCslNodeIds(i[s],e)},this.setCslNodeIds(this.cslXml,"style")),this.sys.xml.addMissingNameNodes(this.cslXml),this.sys.xml.addInstitutionNodes(this.cslXml),this.sys.xml.insertPublisherAndPlace(this.cslXml),this.sys.xml.flagDateMacros(this.cslXml),o=this.sys.xml.attributes(this.cslXml),"undefined"==typeof o["@sort-separator"]&&this.sys.xml.setAttribute(this.cslXml,"sort-separator",", "),this.opt["initialize-with-hyphen"]=!0,this.setStyleAttributes(),this.opt.xclass=t.xml.getAttributeValue(this.cslXml,"class"),this.opt.styleID=this.sys.xml.getStyleId(this.cslXml),this.opt.styleName=this.sys.xml.getStyleId(this.cslXml,!0),n.getSuppressJurisdictions&&(this.opt.suppressJurisdictions=n.getSuppressJurisdictions(this.opt.styleID)),i&&(i=i.replace("_","-")),this.opt["default-locale"][0]&&(this.opt["default-locale"][0]=this.opt["default-locale"][0].replace("_","-")),i&&s&&(this.opt["default-locale"]=[i]),i&&!s&&this.opt["default-locale"][0]&&(i=this.opt["default-locale"][0]),0===this.opt["default-locale"].length&&(i||(i="en-US"),this.opt["default-locale"].push("en-US")),i||(i=this.opt["default-locale"][0]),a=n.localeResolve(i),this.opt.lang=a.best,this.opt["default-locale"][0]=a.best,this.locale={},this.opt["default-locale-sort"]||(this.opt["default-locale-sort"]=this.opt["default-locale"][0]),this.localeConfigure(a),this.locale[this.opt.lang].opts["skip-words-regexp"]=r(this.locale[this.opt.lang].opts["skip-words"]),this.output.adjust=new n.Output.Queue.adjust(this.getOpt("punctuation-in-quote")),this.registry=new n.Registry(this),this.buildTokenLists("citation"),this.buildTokenLists("bibliography"),this.configureTokenLists(),this.disambiguate=new n.Disambiguation(this),this.splice_delimiter=!1,this.fun.dateparser=new n.DateParser,this.fun.flipflopper=new n.Util.FlipFlopper(this),this.setCloseQuotesArray(),this.fun.ordinalizer.init(this),this.fun.long_ordinalizer.init(this),this.fun.page_mangler=n.Util.PageRangeMangler.getFunction(this,"page"),this.fun.year_mangler=n.Util.PageRangeMangler.getFunction(this,"year"),this.setOutputFormat("html")},n.Engine.prototype.setCloseQuotesArray=function(){var t;t=[],t.push(this.getTerm("close-quote")),t.push(this.getTerm("close-inner-quote")),t.push('"'),t.push("'"),this.opt.close_quotes_array=t},n.makeBuilder=function(t){function e(e){n.XmlToToken.call(e,t,n.START)}function i(e){n.XmlToToken.call(e,t,n.END)}function s(e){n.XmlToToken.call(e,t,n.SINGLETON)}function r(o){var a;if(t.sys.xml.numberofnodes(t.sys.xml.children(o))){a=o,e(a);for(var l=0;l<t.sys.xml.numberofnodes(t.sys.xml.children(a));l+=1)o=t.sys.xml.children(a)[l],null!==t.sys.xml.nodename(o)&&("date"===t.sys.xml.nodename(o)&&(n.Util.fixDateNode.call(t,a,l,o),o=t.sys.xml.children(a)[l]),r(o,e,i,s));i(a)}else s(o)}return r},n.Engine.prototype.buildTokenLists=function(t){var e,i=n.makeBuilder(this);if(e=this.sys.xml.getNodesByName(this.cslXml,t),this.sys.xml.getNodeValue(e)){this.build.area=t;var s=e[0];i(s)}},n.Engine.prototype.setStyleAttributes=function(){var t,e,i;t={};var s=this.cslXml,r=this.cslXml.tagName?(""+this.cslXml.tagName).toLowerCase():"";if("style"!==r&&"cslstyle"!==r&&this.cslXml.getElementsByTagName)var s=this.cslXml.getElementsByTagName("style")[0];t.name=this.sys.xml.nodename(s),e=this.sys.xml.attributes(s);for(i in e)e.hasOwnProperty(i)&&n.Attributes[i].call(t,this,e[i])},n.Engine.prototype.getTerm=function(t,e,i,s,r,o){t&&t.match(/[A-Z]/)&&t===t.toUpperCase()&&(n.debug("Warning: term key is in uppercase form: "+t),t=t.toLowerCase());var a;a=o?this.opt["default-locale"][0]:this.opt.lang;var l=n.Engine.getField(n.LOOSE,this.locale[a].terms,t,e,i,s);if(l||"range-delimiter"!==t||(l="–"),"undefined"==typeof l){if(r===n.STRICT)throw'Error in getTerm: term "'+t+'" does not exist.';r===n.TOLERANT&&(l="")}return l&&(this.tmp.cite_renders_content=!0),l},n.Engine.prototype.getDate=function(t,e){var i;return i=e?this.opt["default-locale"]:this.opt.lang,this.locale[i].dates[t]?this.locale[i].dates[t]:!1},n.Engine.prototype.getOpt=function(t){return"undefined"!=typeof this.locale[this.opt.lang].opts[t]?this.locale[this.opt.lang].opts[t]:!1},n.Engine.prototype.getVariable=function(t,e,i,s){return n.Engine.getField(n.LOOSE,t,e,i,s)},n.Engine.prototype.getDateNum=function(t,e){return"undefined"==typeof t?0:t[e]},n.Engine.getField=function(t,e,i,s,r,o){var a,l,c,u,h,p;if(a="","undefined"==typeof e[i]){if(t===n.STRICT)throw'Error in getField: term "'+i+'" does not exist.';return void 0}for(p=o&&e[i][o]?e[i][o]:e[i],l=[],"symbol"===s?l=["symbol","short"]:"verb-short"===s?l=["verb-short","verb"]:"long"!==s&&(l=[s]),l=l.concat(["long"]),h=l.length,u=0;h>u;u+=1)if(c=l[u],"string"==typeof p||"number"==typeof p)a=p;else if("undefined"!=typeof p[c]){a="string"==typeof p[c]||"number"==typeof p[c]?p[c]:"number"==typeof r?p[c][r]:p[c][0];break}return a},n.Engine.prototype.configureTokenLists=function(){var t,e,i,s,r,o,a,l,c,u,h;for(t=["year","month","day"],c=n.AREAS.length,i=0;c>i;i+=1)for(e=n.AREAS[i],u=this[e].tokens.length-1,a=u;a>-1;a+=-1){if(s=this[e].tokens[a],"date"===s.name&&n.END===s.tokentype&&(r=[]),"date-part"===s.name&&s.strings.name)for(h=t.length,l=0;h>l;l+=1)o=t[l],o===s.strings.name&&r.push(s.strings.name);"date"===s.name&&n.START===s.tokentype&&(r.reverse(),s.dateparts=r),s.next=a+1,s.name&&n.Node[s.name].configure&&n.Node[s.name].configure.call(s,this,a)}return this.version=n.version,this.state},n.Engine.prototype.retrieveItems=function(t){var e;e=[];for(var i=0,s=t.length;s>i;i+=1)e.push(this.retrieveItem(""+t[i]));return e},n.ITERATION=0,n.Engine.prototype.retrieveItem=function(t){var e,i,s,r,o;if(this.opt.development_extensions.normalize_lang_keys_to_lowercase&&"boolean"==typeof this.opt.development_extensions.normalize_lang_keys_to_lowercase){for(var a=0,l=this.opt["default-locale"].length;l>a;a+=1)this.opt["default-locale"][a]=this.opt["default-locale"][a].toLowerCase();for(var a=0,l=this.opt["locale-translit"].length;l>a;a+=1)this.opt["locale-translit"][a]=this.opt["locale-translit"][a].toLowerCase();for(var a=0,l=this.opt["locale-translat"].length;l>a;a+=1)this.opt["locale-translat"][a]=this.opt["locale-translat"][a].toLowerCase();this.opt.development_extensions.normalize_lang_keys_to_lowercase=100}if(n.ITERATION+=1,e=this.sys.retrieveItem(""+t),this.opt.development_extensions.normalize_lang_keys_to_lowercase){if(e.multi){if(e.multi._keys)for(var c in e.multi._keys)for(var u in e.multi._keys[c])u!==u.toLowerCase()&&(e.multi._keys[c][u.toLowerCase()]=e.multi._keys[c][u],delete e.multi._keys[c][u]);if(e.multi.main)for(var c in e.multi.main)e.multi.main[c]=e.multi.main[c].toLowerCase()}for(var a=0,l=n.CREATORS.length;a>l;a+=1){var h=n.CREATORS[a];if(e[h]&&e[h].multi)for(var p=0,f=e[h].length;f>p;p+=1){var d=e[h][p];if(d.multi){if(d.multi._key)for(var u in d.multi._key)u!==u.toLowerCase()&&(d.multi._key[u.toLowerCase()]=d.multi._key[u],delete d.multi._key[u]);d.multi.main&&(d.multi.main=d.multi.main.toLowerCase())}}}}if(e.page){e["page-first"]=e.page;var m=""+e.page;i=m.split(/\s*(?:&|,|-|\u2013)\s*/),"\\"!==i[0].slice(-1)&&(e["page-first"]=i[0])}if(this.opt.development_extensions.field_hack&&e.note&&(i=e.note.match(n.NOTE_FIELDS_REGEXP))){for(s=0,r=i.length;r>s;s+=1){if(o=i[s].match(n.NOTE_FIELD_REGEXP),!e[o[1]]&&n.DATE_VARIABLES.indexOf(o[1])>-1)e[o[1]]={raw:o[2]};else if(!e[o[1]]&&n.NAME_VARIABLES.indexOf(o[1])>-1){e[o[1]]||(e[o[1]]=[]);var g=o[2].split(/\s*\|\|\s*/);1===g.length?e[o[1]].push({family:g[0],isInstitution:!0}):2===g.length&&e[o[1]].push({family:g[0],given:g[1]})}else e[o[1]]&&"type"!==o[1]||(e[o[1]]=o[2].replace(/^\s+/,"").replace(/\s+$/,""));e.note.replace(n.NOTE_FIELD_REGEXP,"")}}for(var a=1,l=n.DATE_VARIABLES.length;l>a;a+=1){var b=e[n.DATE_VARIABLES[a]];b&&(this.opt.development_extensions.raw_date_parsing&&b.raw&&(b=this.fun.dateparser.parse(b.raw)),e[n.DATE_VARIABLES[a]]=this.dateParseArray(b))}if(this.opt.development_extensions.static_statute_locator&&e.type&&["bill","gazette","legislation","treaty"].indexOf(e.type)>-1){var v,y=["type","title","jurisdiction","genre","volume","container-title"],_=[];for(a=0,l=y.length;l>a;a+=1)v=y[a],e[v]&&_.push(e[v]);for(y=["original-date","issued"],a=0,y.length;l>a;a+=1)if(v=y[a],e[v]&&e[v].year){var x=e[v].year;_.push(x);break}e.legislation_id=_.join("::")}if(e["title-short"]||(e["title-short"]=e.shortTitle),this.opt.development_extensions.main_title_from_short_title&&(e["title-main"]=e.title,e["title-sub"]=!1,e.title&&e["title-short"])){var w=e["title-short"];offset=w.length,e.title.slice(0,offset)===w&&e.title.slice(offset).match(/^\s*:/)&&(e["title-main"]=e.title.slice(0,offset).replace(/\s+$/,""),e["title-sub"]=e.title.slice(offset).replace(/^\s*:\s*/,""))}var S=["legal_case","legislation","gazette","regulation"].indexOf(e.type)>-1;if(!S&&e.title&&this.sys.getAbbreviation){var O=!1;e.jurisdiction||(O=!0);var T=this.transform.loadAbbreviation(e.jurisdiction,"title",e.title,e.type,!0);this.transform.abbrevs[T].title&&this.transform.abbrevs[T].title[e.title]&&(e["title-short"]=this.transform.abbrevs[T].title[e.title])}if(e["container-title-short"]=e.journalAbbreviation,e["container-title"]&&this.sys.getAbbreviation){var T=this.transform.loadAbbreviation(e.jurisdiction,"container-title",e["container-title"]);this.transform.abbrevs[T]["container-title"]&&this.transform.abbrevs[T]["container-title"][e["container-title"]]&&(e["container-title-short"]=this.transform.abbrevs[T]["container-title"][e["container-title"]])}return e},n.Engine.prototype.setOpt=function(t,e,i){"style"===t.name||"cslstyle"===t.name?this.opt[e]=i:["citation","bibliography"].indexOf(t.name)>-1?this[t.name].opt[e]=i:-1===["name-form","name-delimiter","names-delimiter"].indexOf(e)&&(t.strings[e]=i)},n.Engine.prototype.fixOpt=function(t,e,i){["citation","bibliography"].indexOf(t.name)>-1&&(this[t.name].opt[e]||"undefined"==typeof this.opt[e]||(this[t.name].opt[e]=this.opt[e])),("name"===t.name||"names"===t.name)&&"undefined"==typeof t.strings[i]&&"undefined"!=typeof this[this.build.root].opt[e]&&(t.strings[i]=this[this.build.root].opt[e])},n.Engine.prototype.remapSectionVariable=function(t){for(var e=0,i=t.length;i>e;e+=1){var s=t[e][0],r=t[e][1],o=!1;if(["bill","gazette","legislation","treaty"].indexOf(s.type)>-1){r.force_pluralism=0,r.label||(r.label="page");var a=["section","","",""];if(this.opt.development_extensions.static_statute_locator&&s.section?(l=s.section.replace(/^\s+/,"").replace(/\s+$/,"").split(/\s+/),n.STATUTE_SUBDIV_STRINGS[l[0]]?(a[0]=" "+l[0]+" ",a[1]=l.slice(1).join(" ")):(a[0]=" sec. ",a[1]=l.slice(0).join(" "))):this.opt.development_extensions.clobber_locator_if_no_statute_section&&(r.locator=void 0,r.label=void 0),r.locator){var l=r.locator.replace(/^\s+/,"").replace(/\s+$/,"").split(/\s+/);n.STATUTE_SUBDIV_STRINGS[l[0]]?(a[2]=" "+l[0]+" ",a[3]=l.slice(1).join(" ")):r.label?(a[2]=" "+n.STATUTE_SUBDIV_STRINGS_REVERSE[r.label]+" ",a[3]=l.slice(0).join(" ")):a[3]=l.join(" "),a[3]&&"&"===a[3].slice(0,1)&&(a[3]=" "+a[3])}if(a[2]||(a[2]=a[0]),a[3]){if(a[3].match(/^[^0-9a-zA-Z]/)){var c=a[3].split(/\s+/);a[0]===a[2]&&c[1]&&!n.STATUTE_SUBDIV_STRINGS[c[1].replace(/\s+/,"").replace(/\s+/,"")]&&(r.force_pluralism=1),a[2]=""}}else a[2]="";a[1]||(a[0]="");var o=a.join("");if(o=o.replace(/^\s+/,"").replace(/\s+$/,""))if(l=o.split(/\s+/),n.STATUTE_SUBDIV_STRINGS[l[0]]){for(var u=l.length-2;u>0;u+=-2)l[u]===l[0]&&(r.force_pluralism=1,l=l.slice(0,u).concat(l.slice(u+1)));r.label=n.STATUTE_SUBDIV_STRINGS[l[0]],r.locator=l.slice(1).join(" "),0===r.force_pluralism&&delete r.force_pluralism}else r.locator=l.slice(0).join(" ")}}},n.Engine.prototype.setNumberLabels=function(t){if(t.number&&["bill","gazette","legislation","treaty"].indexOf(t.type)>-1&&this.opt.development_extensions.static_statute_locator&&!this.tmp.shadow_numbers.number){this.tmp.shadow_numbers.number={},this.tmp.shadow_numbers.number.values=[],this.tmp.shadow_numbers.number.plural=0,this.tmp.shadow_numbers.number.numeric=!1,this.tmp.shadow_numbers.number.label=!1;var e=""+t.number;e=e.replace("\\","","g");var i=e.split(/\s/)[0],s=n.STATUTE_SUBDIV_STRINGS[i];if(s){var r=e.match(n.STATUTE_SUBDIV_GROUPED_REGEX),o=e.split(n.STATUTE_SUBDIV_PLAIN_REGEX);if(o.length>1){for(var a=[],l=1,c=o.length;c>l;l+=1){var u=r[l-1].replace(/^\s*/,"");a.push(u.replace("sec.","Sec.").replace("ch.","Ch.")),a.push(o[l].replace(/\s*$/,"").replace(/^\s*/,""))}e=a.join(" ")}else e=o[0];this.tmp.shadow_numbers.number.values.push(["Blob",e,!1]),this.tmp.shadow_numbers.number.numeric=!1}else this.tmp.shadow_numbers.number.values.push(["Blob",e,!1]),this.tmp.shadow_numbers.number.numeric=!0}},n.substituteOne=function(t){return function(e,i){return i?t.replace("%%STRING%%",i):""}},n.substituteTwo=function(t){return function(e){var i=t.replace("%%PARAM%%",e);return function(t,e){return e?i.replace("%%STRING%%",e):""}}},n.Mode=function(t){var e,i,s,r,o,a;e={},i=n.Output.Formats[t];for(s in i)if("@"===s.slice(0,1)){if(r=!1,o=i[s],a=s.split("/"),"string"==typeof o&&o.indexOf("%%STRING%%")>-1)r=o.indexOf("%%PARAM%%")>-1?n.substituteTwo(o):n.substituteOne(o);else if("boolean"!=typeof o||o){if("function"!=typeof o)throw"CSL.Compiler: Bad "+t+" config entry for "+s+": "+o;r=o}else r=n.Output.Formatters.passthrough;1===a.length?e[a[0]]=r:2===a.length&&(e[a[0]]||(e[a[0]]={}),e[a[0]][a[1]]=r)}else e[s]=i[s];return e},n.setDecorations=function(t,e){var i,s,r;i=[];for(r in n.FORMAT_KEY_SEQUENCE)s=n.FORMAT_KEY_SEQUENCE[r],e[s]&&(i.push([s,e[s]]),delete e[s]);return i},n.Engine.prototype.normalDecorIsOrphan=function(t,e){if("normal"===e[1]){var i,s=!1;i="citation"===this.tmp.area?[this.citation.opt.layout_decorations].concat(t.alldecor):t.alldecor;for(var n=i.length-1;n>-1;n+=-1)for(var r=i[n].length-1;r>-1;r+=-1)i[n][r][0]===e[0]&&"normal"!==i[n][r][1]&&(s=!0);if(!s)return!0}return!1},n.Engine.prototype.getCitationLabel=function(t){var e="",i=this.getTrigraphParams(),s=i[0],r=this.getTerm("reference","short",0);"undefined"==typeof r&&(r="reference"),r=r.replace(".",""),r=r.slice(0,1).toUpperCase()+r.slice(1);for(var o=0,a=n.CREATORS.length;a>o;o+=1){var l=n.CREATORS[o];if(t[l]){var c=t[l];s=c.length>i.length?i[i.length-1]:i[c.length-1];for(var u=0,h=c.length;h>u&&u!==s.authors.length;u+=1){var p=this.nameOutput.getName(c[u],"locale-translit",!0),f=p.name;f&&f.family?(r=f.family,r=r.replace(/^([ \'\u2019a-z]+\s+)/,"")):f&&f.literal&&(r=f.literal);var d=r.toLowerCase().match(/^(a\s+|the\s+|an\s+)/);if(d&&(r=r.slice(d[1].length)),r=r.replace(n.ROMANESQUE_NOT_REGEXP,"","g"),!r)break;r=r.slice(0,s.authors[u]),r.length>1?r=r.slice(0,1).toUpperCase()+r.slice(1).toLowerCase():1===r.length&&(r=r.toUpperCase()),e+=r}break}}var m="0000";return t.issued&&t.issued.year&&(m=""+t.issued.year),m=m.slice(-1*s.year),e+=m},n.Engine.prototype.getTrigraphParams=function(){var t=[],e=this.opt.trigraph.split(":");if(!this.opt.trigraph||"A"!==this.opt.trigraph.slice(0,1))throw"Bad trigraph definition: "+this.opt.trigraph;for(var i=0,s=e.length;s>i;i+=1){for(var n=e[i],r={authors:[],year:0},o=0,a=n.length;a>o;o+=1)switch(n.slice(o,o+1)){case"A":r.authors.push(1);break;case"a":r.authors[r.authors.length-1]+=1;break;case"0":r.year+=1;break;default:throw"Invalid character in trigraph definition: "+this.opt.trigraph}t.push(r)}return t},n.Engine.prototype.setOutputFormat=function(t){this.opt.mode=t,this.fun.decorate=n.Mode(t),this.output[t]||(this.output[t]={},this.output[t].tmp={})},n.Engine.prototype.getSortFunc=function(){return function(t,e){return t=t.split("-"),e=e.split("-"),t.length<e.length?1:t.length>e.length?-1:(t=t.slice(-1)[0],e=e.slice(-1)[0],t.length<e.length?1:t.length>e.length?-1:0)}},n.Engine.prototype.setLangTagsForCslSort=function(t){var e,i;if(t)for(this.opt["locale-sort"]=[],e=0,i=t.length;i>e;e+=1)this.opt["locale-sort"].push(t[e]);this.opt["locale-sort"].sort(this.getSortFunc())},n.Engine.prototype.setLangTagsForCslTransliteration=function(t){var e,i;if(this.opt["locale-translit"]=[],t)for(e=0,i=t.length;i>e;e+=1)this.opt["locale-translit"].push(t[e]);this.opt["locale-translit"].sort(this.getSortFunc())},n.Engine.prototype.setLangTagsForCslTranslation=function(t){var e,i;if(this.opt["locale-translat"]=[],t)for(e=0,i=t.length;i>e;e+=1)this.opt["locale-translat"].push(t[e]);this.opt["locale-translat"].sort(this.getSortFunc())},n.Engine.prototype.setLangPrefsForCites=function(t,e){var i=this.opt["cite-lang-prefs"];e||(e=function(t){return t.toLowerCase()});for(var s=["Persons","Institutions","Titles","Journals","Publishers","Places"],n=0,r=s.length;r>n;n+=1){var o=e(s[n]),a=s[n].toLowerCase();if(t[o]){for(var l=[];t[o].length>1;)l.push(t[o].pop());var c={orig:1,translit:2,translat:3};for(2===l.length&&c[l[0]]<c[l[1]]&&l.reverse();l.length;)t[o].push(l.pop());for(var u=i[a];u.length;)u.pop();for(var h=0,p=t[o].length;p>h;h+=1)u.push(t[o][h])}}},n.Engine.prototype.setLangPrefsForCiteAffixes=function(t){if(t&&48===t.length){for(var e,i=this.opt.citeAffixes,s=0,n=["persons","institutions","titles","journals","publishers","places"],r=["translit","orig","translit","translat"],o=0,a=n.length;a>o;o+=1)for(var l=0,c=r.length;c>l;l+=1)e="",s%8===4?i[n[o]]["locale-"+r[l]].prefix||i[n[o]]["locale-"+r[l]].suffix||(e=t[s]?t[s]:"",i[n[o]]["locale-"+r[l]].prefix=e,e=t[s]?t[s+1]:"",i[n[o]]["locale-"+r[l]].suffix=e):(e=t[s]?t[s]:"",i[n[o]]["locale-"+r[l]].prefix=e,e=t[s]?t[s+1]:"",i[n[o]]["locale-"+r[l]].suffix=e),s+=2;this.opt.citeAffixes=i}},n.Engine.prototype.setAutoVietnameseNamesOption=function(t){t?this.opt["auto-vietnamese-names"]=!0:this.opt["auto-vietnamese-names"]=!1},n.Engine.prototype.setAbbreviations=function(t){this.sys.setAbbreviations&&this.sys.setAbbreviations(t)},n.Engine.prototype.setSuppressTrailingPunctuation=function(t){this.citation.opt.suppressTrailingPunctuation=!!t},n.Output={},n.Output.Queue=function(t){this.levelname=["top"],this.state=t,this.queue=[],this.empty=new n.Token("empty");var e={};e.empty=this.empty,this.formats=new n.Stack(e),this.current=new n.Stack(this.queue)},n.Output.Queue.prototype.pop=function(){var t=this.current.value();return t.length?t.pop():t.blobs.pop()},n.Output.Queue.prototype.getToken=function(t){var e=this.formats.value()[t];return e},n.Output.Queue.prototype.mergeTokenStrings=function(t,e){var i,s,r,o;if(i=this.formats.value()[t],s=this.formats.value()[e],r=i,s){i||(i=new n.Token(t,n.SINGLETON),i.decorations=[]),r=new n.Token(t,n.SINGLETON),o="";for(o in i.strings)i.strings.hasOwnProperty(o)&&(r.strings[o]=i.strings[o]);for(o in s.strings)s.strings.hasOwnProperty(o)&&(r.strings[o]=s.strings[o]);r.decorations=i.decorations.concat(s.decorations)}return r},n.Output.Queue.prototype.addToken=function(t,e,i){var s,r;if(s=new n.Token("output"),"string"==typeof i&&(i=this.formats.value()[i]),i&&i.strings){for(r in i.strings)i.strings.hasOwnProperty(r)&&(s.strings[r]=i.strings[r]);s.decorations=i.decorations}"string"==typeof e&&(s.strings.delimiter=e),this.formats.value()[t]=s},n.Output.Queue.prototype.pushFormats=function(t){t||(t={}),t.empty=this.empty,this.formats.push(t)},n.Output.Queue.prototype.popFormats=function(t){this.formats.pop()},n.Output.Queue.prototype.startTag=function(t,e){var i={};this.state.tmp["doing-macro-with-date"]&&this.state.tmp.extension&&(e=this.empty,t="empty"),i[t]=e,this.pushFormats(i),this.openLevel(t)},n.Output.Queue.prototype.endTag=function(t){this.closeLevel(),this.popFormats()},n.Output.Queue.prototype.openLevel=function(t,e){var i,s;if("object"==typeof t)i=new n.Blob(void 0,t);else if("undefined"==typeof t)i=new n.Blob(void 0,this.formats.value().empty,"empty");else{if(!this.formats.value()||!this.formats.value()[t])throw'CSL processor error: call to nonexistent format token "'+t+'"';i=new n.Blob(void 0,this.formats.value()[t],t)}this.nestedBraces&&(i.strings.prefix=i.strings.prefix.replace(this.nestedBraces[0][0],this.nestedBraces[0][1]),i.strings.prefix=i.strings.prefix.replace(this.nestedBraces[1][0],this.nestedBraces[1][1]),i.strings.suffix=i.strings.suffix.replace(this.nestedBraces[0][0],this.nestedBraces[0][1]),i.strings.suffix=i.strings.suffix.replace(this.nestedBraces[1][0],this.nestedBraces[1][1])),s=this.current.value(),s.push(i),this.current.push(i)},n.Output.Queue.prototype.closeLevel=function(t){t&&t!==this.current.value().levelname&&n.error("Level mismatch error:  wanted "+t+" but found "+this.current.value().levelname),this.current.pop()},n.Output.Queue.prototype.append=function(t,e,i,s,r){var o,a,l,c=!0;if(i&&(s=!0),this.state.tmp["doing-macro-with-date"]&&!i){if("macro-with-date"!==e)return!1;"macro-with-date"===e&&(e="empty")}if("undefined"==typeof t)return!1;if("number"==typeof t&&(t=""+t),!i&&this.state.tmp.element_trace&&"suppress-me"===this.state.tmp.element_trace.value())return!1;if(a=!1,e?"literal"===e?(o=!0,c=!1):o="string"==typeof e?this.formats.value()[e]:e:o=this.formats.value().empty,!o)throw"CSL processor error: unknown format token name: "+e;if(o.strings&&"undefined"==typeof o.strings.delimiter&&(o.strings.delimiter=""),"string"==typeof t&&t.length&&(t=t.replace(/ ([:;?!\u00bb])/g," $1").replace(/\u00ab /g,"« "),this.last_char_rendered=t.slice(-1),t=t.replace(/\s+'/g,"  '").replace(/^'/g," '"),s?i&&(this.state.tmp.term_predecessor_name=!0):this.state.tmp.term_predecessor=!0),a=new n.Blob(t,o),this.nestedBraces&&(a.strings.prefix=a.strings.prefix.replace(this.nestedBraces[0][0],this.nestedBraces[0][1]),a.strings.prefix=a.strings.prefix.replace(this.nestedBraces[1][0],this.nestedBraces[1][1]),a.strings.suffix=a.strings.suffix.replace(this.nestedBraces[0][0],this.nestedBraces[0][1]),a.strings.suffix=a.strings.suffix.replace(this.nestedBraces[1][0],this.nestedBraces[1][1])),l=this.current.value(),"undefined"==typeof l&&0===this.current.mystack.length&&(this.current.mystack.push([]),l=this.current.value()),"string"==typeof a.blobs&&(s?i&&(this.state.tmp.term_predecessor_name=!0):this.state.tmp.term_predecessor=!0),i||this.state.parallel.AppendBlobPointer(l),"string"==typeof t){l.push(a),a.strings["text-case"]&&(a.blobs=n.Output.Formatters[a.strings["text-case"]](this.state,t)),this.state.tmp.strip_periods&&!r&&(a.blobs=a.blobs.replace(/\.([^a-z]|$)/g,"$1"));for(var u=a.decorations.length-1;u>-1;u+=-1)"@quotes"===a.decorations[u][0]&&"true"===a.decorations[u][1]&&(a.punctuation_in_quote=this.state.getOpt("punctuation-in-quote")),a.blobs.match(n.ROMANESQUE_REGEXP)||"@font-style"===a.decorations[u][0]&&(a.decorations=a.decorations.slice(0,u).concat(a.decorations.slice(u+1)));this.state.fun.flipflopper.init(t,a),this.state.fun.flipflopper.processTags()}else c?l.push(a):l.push(t);return!0},n.Output.Queue.prototype.string=function(t,e,i){var s,r,o,a,l,c=n.getSafeEscape(this.state),u=e.slice(),h=[];if(0===u.length)return h;var p="";i?p=i.strings.delimiter:(t.tmp.count_offset_characters=!1,t.tmp.offset_characters=0),i&&i.new_locale&&(i.old_locale=t.opt.lang,t.opt.lang=i.new_locale);var f,d,m,g;for(s=0,r=u.length;r>s;s+=1){if(f=u[s],f.strings.first_blob&&(t.tmp.count_offset_characters=f.strings.first_blob),"string"==typeof f.blobs){if("number"==typeof f.num)h.push(f);else if(f.blobs){l=c(f.blobs);var b=l.length;if(!t.tmp.suppress_decorations)for(o=0,a=f.decorations.length;a>o;o+=1)g=f.decorations[o],"@showid"!==g[0]&&(t.normalDecorIsOrphan(f,g)||(l=t.fun.decorate[g[0]][g[1]].call(f,t,l,g[2])));if(l&&l.length){if(l=c(f.strings.prefix,t.tmp.nestedBraces)+l+c(f.strings.suffix,t.tmp.nestedBraces),(t.opt.development_extensions.csl_reverse_lookup_support||t.sys.csl_reverse_lookup_support)&&!t.tmp.suppress_decorations)for(o=0,a=f.decorations.length;a>o;o+=1)g=f.decorations[o],"@showid"===g[0]&&(l=t.fun.decorate[g[0]][g[1]].call(f,t,l,g[2]));h.push(l),t.tmp.count_offset_characters&&(t.tmp.offset_characters+=b+f.strings.suffix.length+f.strings.prefix.length)}}}else if(f.blobs.length){var v=t.output.string(t,f.blobs,f);h=h.concat(v)}f.strings.first_blob&&(t.registry.registry[f.strings.first_blob].offset=t.tmp.offset_characters,t.tmp.count_offset_characters=!1)}for(s=0,r=h.length-1;r>s;s+=1)"number"!=typeof h[s].num||"number"!=typeof h[s+1].num||h[s+1].UGLY_DELIMITER_SUPPRESS_HACK||(h[s].strings.suffix=h[s].strings.suffix+(p?p:""),h[s+1].successor_prefix="",h[s+1].UGLY_DELIMITER_SUPPRESS_HACK=!0);var y=0;for(s=0,r=h.length;r>s;s+=1)"string"==typeof h[s]&&(y=parseInt(s,10)+1,s<h.length-1&&"object"==typeof h[s+1]&&(p&&!h[s+1].UGLY_DELIMITER_SUPPRESS_HACK&&(h[s]+=c(p)),h[s+1].UGLY_DELIMITER_SUPPRESS_HACK=!0));i&&(i.decorations.length||i.strings.suffix||i.strings.prefix)&&(y=h.length);var _=t.output.renderBlobs(h.slice(0,y),p,!0,i);if(_&&i&&(i.decorations.length||i.strings.suffix||i.strings.prefix)){if(!t.tmp.suppress_decorations)for(s=0,r=i.decorations.length;r>s;s+=1)g=i.decorations[s],["@cite","@bibliography","@display","@showid"].indexOf(g[0])>-1||t.normalDecorIsOrphan(f,g)||"string"==typeof _&&(_=t.fun.decorate[g[0]][g[1]].call(i,t,_,g[2]));if(l=_,d=i.strings.suffix,l&&l.length&&(m=i.strings.prefix,l=c(m,t.tmp.nestedBraces)+l+c(d,t.tmp.nestedBraces),t.tmp.count_offset_characters&&(t.tmp.offset_characters+=m.length+d.length)),_=l,!t.tmp.suppress_decorations)for(s=0,r=i.decorations.length;r>s;s+=1)g=i.decorations[s],-1!==["@cite","@bibliography","@display","@showid"].indexOf(g[0])&&"string"==typeof _&&(_=t.fun.decorate[g[0]][g[1]].call(i,t,_,g[2]))}var x=h.slice(y,h.length);return!x.length&&_?h=[_]:x.length&&!_?h=x:_&&x.length&&(h=[_].concat(x)),"undefined"==typeof i?(this.queue=[],this.current.mystack=[],this.current.mystack.push(this.queue),t.tmp.suppress_decorations&&(h=t.output.renderBlobs(h,void 0,!0))):"boolean"==typeof i&&(h=t.output.renderBlobs(h,void 0,!0)),i&&i.new_locale&&(t.opt.lang=i.old_locale),h},n.Output.Queue.prototype.clearlevel=function(){var t,e,i;for(t=this.current.value(),i=t.blobs.length,e=0;i>e;e+=1)t.blobs.pop()},n.Output.Queue.prototype.renderBlobs=function(t,e,i,s){var r,o,a,l,c,u,h,p,f,d,m,g;if(g=n.getSafeEscape(this.state),e||(e=""),r=this.state,o="",a=[],l="",h=t.length,"citation"===this.state.tmp.area&&!this.state.tmp.just_looking&&1===h&&"object"==typeof t[0]&&s)return t[0].strings.prefix=s.strings.prefix+t[0].strings.prefix,t[0].strings.suffix=t[0].strings.suffix+s.strings.suffix,t[0].decorations=t[0].decorations.concat(s.decorations),t[0].params=s.params,t[0];var b=!0;for(u=0;h>u;u+=1)t[u].checkNext?(t[u].checkNext(t[u+1],b),b=!1):b=!0;var v=!0;for(u=t.length-1;u>0;u+=-1)t[u].checkLast?v&&t[u].checkLast(t[u-1])&&(v=!1):v=!0;for(h=t.length,u=0;h>u;u+=1)if(c=t[u],o&&(l=e),"string"==typeof c)o+=g(l),o+=c,r.tmp.count_offset_characters&&(r.tmp.offset_characters+=l.length);else if(c.status!==n.SUPPRESS){d=c.formatter.format(c.num,c.gender);var y=d.replace(/<[^>]*>/g,"").length;this.append(d,"empty",!0);var _=this.pop(),x=r.tmp.count_offset_characters;if(d=this.string(r,[_],!1),r.tmp.count_offset_characters=x,c.strings["text-case"]&&(d=n.Output.Formatters[c.strings["text-case"]](this.state,d)),d&&this.state.tmp.strip_periods&&(d=d.replace(/\.([^a-z]|$)/g,"$1")),!r.tmp.suppress_decorations)for(f=c.decorations.length,p=0;f>p;p+=1)m=c.decorations[p],r.normalDecorIsOrphan(c,m)||(d=r.fun.decorate[m[0]][m[1]].call(c,r,d,m[2]));d=g(c.strings.prefix)+d+g(c.strings.suffix);var w="";c.status===n.END?w=g(c.range_prefix):c.status===n.SUCCESSOR?w=g(c.successor_prefix):c.status===n.START?w="":c.status===n.SEEN&&(w=g(c.splice_prefix)),o+=w,o+=d,r.tmp.count_offset_characters&&(r.tmp.offset_characters+=w.length+c.strings.prefix.length+y+c.strings.suffix.length)}return o},n.Output.Queue.purgeEmptyBlobs=function(t){if("object"==typeof t&&"object"==typeof t.blobs&&t.blobs.length)for(var e=t.blobs.length-1;e>-1;e--){n.Output.Queue.purgeEmptyBlobs(t.blobs[e]);var i=t.blobs[e];if(!i||!i.blobs||!i.blobs.length){for(var s=[];t.blobs.length-1>e;)s.push(t.blobs.pop());for(t.blobs.pop();s.length;)t.blobs.push(s.pop())}}},n.Output.Queue.adjust=function(t){function e(t){return"number"==typeof t.num||t.blobs&&1===t.blobs.length&&"number"==typeof t.blobs[0].num}function i(t){return"number"==typeof t.num?!0:t.blobs&&"object"==typeof t.blobs?i(t.blobs[t.blobs.length-1])?!0:void 0:!1}function s(t,e){var i=!1,s=["@font-style","@font-variant","@font-weight","@text-decoration","@vertical-align"];if(e&&s.push("@quotes"),t.decorations)for(var n=0,r=t.decorations.length;r>n;n++)if(s.indexOf(t.decorations[n][0])>-1){i=!0;break}return i}function n(t){if(t.decorations)for(var e=0,i=t.decorations.length;i>e;e++)if("@quotes"===t.decorations[e][0])return!0;return"object"!=typeof t.blobs?!1:n(t.blobs[t.blobs.length-1])?!0:!1}function r(t,e){if(!g[e])return!1;if("string"==typeof t.blobs)return t.blobs.slice(-1)===e?!0:!1;var i=t.blobs[t.blobs.length-1];if(i){var s=i.strings.suffix.slice(-1);return s?i.strings.suffix.slice(-1)==e?!0:!1:r(i,e)}return!1}function o(t,e,i,s,n){function r(){SecondStrings[s]=SecondStrings[s].slice(1)}function o(){FirstStrings[e]=FirstStrings[e].slice(0,-1)}function a(t){SecondStrings[s]=t+SecondStrings[s]}function l(t){FirstStrings[e]+=t}function c(){return y[m]}function u(){FirstStrings[e].slice(-1);return f[d]}function h(){var t=f[d][m];"string"==typeof t?(o(),r(),a(t)):(a(d),o())}function p(){var t=y[m][d];"string"==typeof t?(o(),r(),l(t)):(l(m),r())}FirstStrings="blobs"===e?t:t.strings,SecondStrings="blobs"===s?i:i.strings;var d=FirstStrings[e].slice(-1),m=SecondStrings[s].slice(0,1),g=n?o:r,b=n?u:c,v=n?h:p,_=d===m;_?g():b()&&v()}function a(t){if(t.blobs&&"string"==typeof t.blobs)return void(g[t.strings.suffix.slice(0,1)]&&t.strings.suffix.slice(0,1)===t.blobs.slice(-1)&&(t.strings.suffix=t.strings.suffix.slice(1)));if("object"==typeof t&&"object"==typeof t.blobs&&t.blobs.length)for(var e=s(t,!0),i=t.blobs.length-1;i>-1;i--){i===t.blobs.length-1;this.upward(t.blobs[i]);var n=t.strings,r=t.blobs[i].strings;if(0===i){" "===n.prefix.slice(-1)&&" "===r.prefix.slice(0,1)&&(r.prefix=r.prefix.slice(1));var o=r.prefix.slice(0,1);e||!b[o]||n.prefix||(n.prefix+=o,r.prefix=r.prefix.slice(1))}if(i===t.blobs.length-1){var o=r.suffix.slice(-1);!e&&[" "].indexOf(o)>-1&&(n.suffix.slice(0,1)!==o&&(n.suffix=o+n.suffix),r.suffix=r.suffix.slice(0,-1));
}n.delimiter&&i>0&&b[n.delimiter.slice(-1)]&&n.delimiter.slice(-1)===r.prefix.slice(0,1)&&(r.prefix=r.prefix.slice(1))}}function l(t){if("object"==typeof t&&"object"==typeof t.blobs&&t.blobs.length)for(var e=t.blobs.length-1;e>-1;e--)if(this.leftward(t.blobs[e]),e<t.blobs.length-1&&!t.strings.delimiter){var i=t.blobs[e],n=i.strings.suffix.slice(-1),r=t.blobs[e+1],a=r.strings.prefix.slice(0,1),l=s(i)||s(r),c="number"==typeof n||"number"==typeof a;if(!l&&!c&&g[a]&&!c){var u=a===i.strings.suffix.slice(-1),h=!i.strings.suffix&&"string"==typeof i.blobs&&i.blobs.slice(-1)===a;u||h?r.strings.prefix=r.strings.prefix.slice(1):o(i,"suffix",r,"prefix")}}}function c(t,a){if(t.blobs&&"string"==typeof t.blobs)return void(g[t.strings.suffix.slice(0,1)]&&t.strings.suffix.slice(0,1)===t.blobs.slice(-1)&&(t.strings.suffix=t.strings.suffix.slice(1)));if("object"==typeof t&&"object"==typeof t.blobs&&t.blobs.length){for(var l=t.strings,c=!1,u=0,h=t.blobs.length;h>u;u++)if(e(t.blobs[u])){c=!0;break}if(!c&&l.delimiter&&g[l.delimiter.slice(0,1)]){for(var p=l.delimiter.slice(0,1),u=t.blobs.length-2;u>-1;u--){var f=t.blobs[u].strings;f.suffix+=p}l.delimiter=l.delimiter.slice(1)}for(var d=s(t,!0),u=(e(t),t.blobs.length-1);u>-1;u--){var m=t.blobs[u],f=t.blobs[u].strings,v=s(m,!0),y=e(m);if(u===t.blobs.length-1){if(!d||n(m)){var _=l.suffix.slice(0,1);g[_]&&(i(m)||(o(m,"suffix",t,"suffix"),"."===l.suffix.slice(0,1)&&(f.suffix+=l.suffix.slice(0,1),l.suffix=l.suffix.slice(1)))),"Â "===f.suffix.slice(-1)&&l.suffix.slice(0,1)&&(l.suffix=l.suffix.slice(1))}b[f.suffix.slice(0,1)]&&("string"==typeof m.blobs&&m.blobs.slice(-1)===f.suffix.slice(0,1)&&(f.suffix=f.suffix.slice(1)),f.suffix.slice(-1)===l.suffix.slice(0,1)&&(l.suffix=l.suffix.slice(0,-1))),r(t,t.strings.suffix.slice(0,1))&&(t.strings.suffix=t.strings.suffix.slice(1))}else if(l.delimiter)b[l.delimiter.slice(0,1)]&&l.delimiter.slice(0,1)===f.suffix.slice(-1)&&(t.blobs[u].strings.suffix=t.blobs[u].strings.suffix.slice(0,-1));else{var x=t.blobs[u+1].strings;e(m)||v||!b[f.suffix.slice(-1)]||f.suffix.slice(-1)!==x.prefix.slice(0,1)||(x.prefix=x.prefix.slice(1))}y||v||!g[f.suffix.slice(0,1)]||"string"!=typeof m.blobs||o(m,"blobs",m,"suffix"),this.downward(t.blobs[u])}}}function u(e){if("object"==typeof e&&"object"==typeof e.blobs&&e.blobs.length){for(var i,s=0,n=e.blobs.length;n>s;s++){for(var r=e.blobs[s],a=!1,l=0,c=r.decorations.length;c>l;l++){var u=r.decorations[l];"@quotes"===u[0]&&(a=!0)}if(a)if(t){var h=r.strings.suffix.slice(0,1);if("string"==typeof r.blobs)for(;d[h];)o(r,"blobs",r,"suffix"),h=r.strings.suffix.slice(0,1);else for(;d[h];)o(r.blobs[r.blobs.length-1],"suffix",r,"suffix"),h=r.strings.suffix.slice(0,1)}else if("string"==typeof r.blobs)for(var h=r.blobs.slice(-1);m[h];)o(r,"blobs",r,"suffix",!0),h=r.blobs.slice(-1);else for(var h=r.blobs[r.blobs.length-1].strings.suffix.slice(-1);m[h];)o(r.blobs[r.blobs.length-1],"suffix",r,"suffix",!0),h=r.blobs[r.blobs.length-1].strings.suffix.slice(-1);i=this.fix(e.blobs[s]),r.blobs&&"string"==typeof r.blobs&&(i=r.blobs.slice(-1))}return i}}var h={";":!0,":":!0},p={".":!0,"!":!0,"?":!0};this.upward=a,this.leftward=l,this.downward=c,this.fix=u;var f={"!":{".":"!","?":"!?",":":"!",",":"!,",";":"!;"},"?":{"!":"?!",".":"?",":":"?",",":"?,",";":"?;"},".":{"!":".!","?":".?",":":".:",",":".,",";":".;"},":":{"!":"!","?":"?",".":":",",":":,",";":":;"},",":{"!":",!","?":",?",":":",:",".":",.",";":",;"},";":{"!":"!","?":"?",":":";",",":";,",".":";"}},d={},m={},g={},b={};for(var v in f)g[v]=!0,b[v]=!0,h[v]||(d[v]=!0),p[v]||(m[v]=!0);b[" "]=!0,b["Â "]=!0;var y={};for(var v in f)for(var _ in f[v])y[_]||(y[_]={}),y[_][v]=f[v][_]},n.Engine.Opt=function(){this.has_disambiguate=!1,this.mode="html",this.dates={},this["locale-sort"]=[],this["locale-translit"]=[],this["locale-translat"]=[],this.citeAffixes={persons:{"locale-orig":{prefix:"",suffix:""},"locale-translit":{prefix:"",suffix:""},"locale-translat":{prefix:"",suffix:""}},institutions:{"locale-orig":{prefix:"",suffix:""},"locale-translit":{prefix:"",suffix:""},"locale-translat":{prefix:"",suffix:""}},titles:{"locale-orig":{prefix:"",suffix:""},"locale-translit":{prefix:"",suffix:""},"locale-translat":{prefix:"",suffix:""}},journals:{"locale-orig":{prefix:"",suffix:""},"locale-translit":{prefix:"",suffix:""},"locale-translat":{prefix:"",suffix:""}},publishers:{"locale-orig":{prefix:"",suffix:""},"locale-translit":{prefix:"",suffix:""},"locale-translat":{prefix:"",suffix:""}},places:{"locale-orig":{prefix:"",suffix:""},"locale-translit":{prefix:"",suffix:""},"locale-translat":{prefix:"",suffix:""}}},this["default-locale"]=[],this.update_mode=n.NONE,this.bib_mode=n.NONE,this.sort_citations=!1,this["et-al-min"]=0,this["et-al-use-first"]=1,this["et-al-use-last"]=!1,this["et-al-subsequent-min"]=!1,this["et-al-subsequent-use-first"]=!1,this["demote-non-dropping-particle"]="display-and-sort",this["parse-names"]=!0,this.citation_number_slug=!1,this.trigraph="Aaaa00:AaAa00:AaAA00:AAAA00",this.development_extensions={},this.development_extensions.field_hack=!0,this.development_extensions.locator_date_and_revision=!0,this.development_extensions.locator_parsing_for_plurals=!0,this.development_extensions.locator_label_parse=!0,this.development_extensions.raw_date_parsing=!0,this.development_extensions.clean_up_csl_flaws=!0,this.development_extensions.flip_parentheses_to_braces=!0,this.development_extensions.jurisdiction_subfield=!0,this.development_extensions.static_statute_locator=!1,this.development_extensions.csl_reverse_lookup_support=!1,this.development_extensions.clobber_locator_if_no_statute_section=!1,this.development_extensions.wrap_url_and_doi=!1,this.development_extensions.allow_force_lowercase=!1,this.development_extensions.handle_parallel_articles=!1,this.development_extensions.thin_non_breaking_space_html_hack=!1,this.development_extensions.apply_citation_wrapper=!1,this.development_extensions.main_title_from_short_title=!1,this.development_extensions.normalize_lang_keys_to_lowercase=!1,this.development_extensions.strict_text_case_locales=!1,this.development_extensions.rtl_support=!1,this.development_extensions.strict_page_numbers=!1,this.development_extensions.expect_and_symbol_form=!1,this.development_extensions.require_explicit_legal_case_title_short=!1,this.nodenames=[],this.gender={},this["cite-lang-prefs"]={persons:["orig"],institutions:["orig"],titles:["orig","translat"],journals:["translit"],publishers:["orig"],places:["orig"],number:["translat"]},this.has_layout_locale=!1},n.Engine.Tmp=function(){this.names_max=new n.Stack,this.names_base=new n.Stack,this.givens_base=new n.Stack,this.value=[],this.namepart_decorations={},this.namepart_type=!1,this.area="citation",this.root="citation",this.extension="",this.can_substitute=new n.Stack(0,n.LITERAL),this.element_rendered_ok=!1,this.element_trace=new n.Stack("style"),this.nameset_counter=0,this.group_context=new n.Stack([!1,!1,!1],n.LITERAL),this.term_predecessor=!1,this.jump=new n.Stack(0,n.LITERAL),this.decorations=new n.Stack,this.tokenstore_stack=new n.Stack,this.last_suffix_used="",this.last_names_used=[],this.last_years_used=[],this.years_used=[],this.names_used=[],this.taintedItemIDs={},this.taintedCitationIDs={},this.initialize_with=new n.Stack,this.disambig_request=!1,this["name-as-sort-order"]=!1,this.suppress_decorations=!1,this.disambig_settings=new n.AmbigConfig,this.bib_sort_keys=[],this.prefix=new n.Stack("",n.LITERAL),this.suffix=new n.Stack("",n.LITERAL),this.delimiter=new n.Stack("",n.LITERAL),this.cite_locales=[],this.cite_affixes={citation:!1,bibliography:!1,citation_sort:!1,bibliography_sort:!1},this.strip_periods=0,this.shadow_numbers={}},n.Engine.Fun=function(t){this.match=new n.Util.Match,this.suffixator=new n.Util.Suffixator(n.SUFFIX_CHARS),this.romanizer=new n.Util.Romanizer,this.ordinalizer=new n.Util.Ordinalizer(t),this.long_ordinalizer=new n.Util.LongOrdinalizer},n.Engine.Build=function(){this["alternate-term"]=!1,this.in_bibliography=!1,this.in_style=!1,this.skip=!1,this.postponed_macro=!1,this.layout_flag=!1,this.name=!1,this.form=!1,this.term=!1,this.macro={},this.macro_stack=[],this.text=!1,this.lang=!1,this.area="citation",this.root="citation",this.extension="",this.substitute_level=new n.Stack(0,n.LITERAL),this.names_level=0,this.render_nesting_level=0,this.render_seen=!1},n.Engine.Configure=function(){this.fail=[],this.succeed=[]},n.Engine.Citation=function(t){this.opt={},this.tokens=[],this.srt=new n.Registry.Comparifier(t,"citation_sort"),this.opt.collapse=[],this.opt["disambiguate-add-names"]=!1,this.opt["disambiguate-add-givenname"]=!1,this.opt["disambiguate-add-year-suffix"]=!1,this.opt["givenname-disambiguation-rule"]="by-cite",this.opt["near-note-distance"]=5,this.opt.topdecor=[],this.opt.layout_decorations=[],this.opt.layout_prefix="",this.opt.layout_suffix="",this.opt.layout_delimiter="",this.opt.sort_locales=[],this.opt.max_number_of_names=0,this.root="citation"},n.Engine.Bibliography=function(){this.opt={},this.tokens=[],this.opt.collapse=[],this.opt.topdecor=[],this.opt.layout_decorations=[],this.opt.layout_prefix="",this.opt.layout_suffix="",this.opt.layout_delimiter="",this.opt["line-spacing"]=1,this.opt["entry-spacing"]=1,this.opt.sort_locales=[],this.opt.max_number_of_names=0,this.root="bibliography"},n.Engine.BibliographySort=function(){this.tokens=[],this.opt={},this.opt.sort_directions=[],this.keys=[],this.opt.topdecor=[],this.root="bibliography"},n.Engine.CitationSort=function(){this.tokens=[],this.opt={},this.opt.sort_directions=[],this.keys=[],this.opt.topdecor=[],this.root="citation"},n.Engine.prototype.previewCitationCluster=function(t,e,i,s){var r=this.opt.mode;this.setOutputFormat(s);var o=this.processCitationCluster(t,e,i,n.PREVIEW);return this.setOutputFormat(r),o[1]},n.Engine.prototype.appendCitationCluster=function(t){for(var e=[],i=this.registry.citationreg.citationByIndex.length,s=0;i>s;s+=1){var n=this.registry.citationreg.citationByIndex[s];e.push([""+n.citationID,n.properties.noteIndex])}return this.processCitationCluster(t,e,[])[1]},n.Engine.prototype.processCitationCluster=function(t,e,i,s){var r,o,a,l,c,u,h,p,f,d,m,g,b,v,y,_;this.debug=!1,this.tmp.citation_errors=[];var x={bibchange:!1};this.setCitationId(t);var w,S,O;if(s===n.PREVIEW){w=this.registry.citationreg.citationByIndex.slice(),S=this.registry.reflist.slice();var T=e.concat([[""+t.citationID,t.properties.noteIndex]]).concat(i),I={},N=[];for(o=0,a=T.length;a>o;o+=1)for(r=this.registry.citationreg.citationById[T[o][0]],l=0,c=r.citationItems.length;c>l;l+=1)I[r.citationItems[l].id]=!0,N.push(""+r.citationItems[l].id);for(O={},o=0,a=S.length;a>o;o+=1)if(!I[S[o].id]){var E=this.registry.registry[S[o].id].ambig,C=this.registry.ambigcites[E];if(C)for(l=0,c=C.length;c>l;l+=1)O[C[l]]=n.cloneAmbigConfig(this.registry.registry[C[l]].disambig)}}this.tmp.taintedCitationIDs={};var A=[],k={};for(o=0,a=t.citationItems.length;a>o;o+=1){g={};for(d in t.citationItems[o])g[d]=t.citationItems[o][d];if(m=this.retrieveItem(""+g.id),m.id&&this.transform.loadAbbreviation("default","hereinafter",m.id),this.remapSectionVariable([[m,g]]),this.opt.development_extensions.locator_date_and_revision&&g.locator){g.locator=""+g.locator;var R=g.locator.indexOf("|");if(R>-1){var P=g.locator;g.locator=P.slice(0,R),P=P.slice(R+1),y=P.match(/^([0-9]{4}-[0-9]{2}-[0-9]{2}).*/),y&&(g["locator-date"]=this.fun.dateparser.parse(y[1]),P=P.slice(y[1].length)),g["locator-revision"]=P.replace(/^\s+/,"").replace(/\s+$/,"")}}this.opt.development_extensions.locator_label_parse&&(!g.locator||-1!==["bill","gazette","legislation","treaty"].indexOf(m.type)||g.label&&"page"!==g.label||(y=n.LOCATOR_LABELS_REGEXP.exec(g.locator),y&&(g.label=n.LOCATOR_LABELS_MAP[y[2]],g.locator=y[3])));var D=[m,g];A.push(D),t.citationItems[o].item=m}t.sortedItems=A;var j=[];for(o=0,a=e.length;a>o;o+=1)r=e[o],this.registry.citationreg.citationById[r[0]].properties.noteIndex=r[1],j.push(this.registry.citationreg.citationById[r[0]]);for(j.push(t),o=0,a=i.length;a>o;o+=1)r=i[o],this.registry.citationreg.citationById[r[0]].properties.noteIndex=r[1],j.push(this.registry.citationreg.citationById[r[0]]);this.registry.citationreg.citationByIndex=j,this.registry.citationreg.citationsByItemId={},this.opt.update_mode===n.POSITION&&(v=[],b=[],_={});var L=[];for(o=0,a=j.length;a>o;o+=1){for(j[o].properties.index=o,l=0,c=j[o].sortedItems.length;c>l;l+=1)g=j[o].sortedItems[l],this.registry.citationreg.citationsByItemId[g[1].id]||(this.registry.citationreg.citationsByItemId[g[1].id]=[],L.push(""+g[1].id)),-1===this.registry.citationreg.citationsByItemId[g[1].id].indexOf(j[o])&&this.registry.citationreg.citationsByItemId[g[1].id].push(j[o]);this.opt.update_mode===n.POSITION&&(j[o].properties.noteIndex?b.push(j[o]):(j[o].properties.noteIndex=0,v.push(j[o])))}if(s!==n.ASSUME_ALL_ITEMS_REGISTERED&&this.updateItems(L),!this.opt.citation_number_sort&&A&&A.length>1&&this.citation_sort.tokens.length>0){for(o=0,a=A.length;a>o;o+=1)A[o][1].sortkeys=n.getSortKeys.call(this,A[o][0],"citation_sort");if(this.opt.grouped_sort&&!t.properties.unsorted){for(o=0,a=A.length;a>o;o+=1){var M=A[o][1].sortkeys;this.tmp.authorstring_request=!0;var U=this.registry.registry[A[o][0].id].disambig;this.tmp.authorstring_request=!0,n.getAmbiguousCite.call(this,A[o][0],U);var B=this.registry.authorstrings[A[o][0].id];this.tmp.authorstring_request=!1,A[o][1].sortkeys=[B].concat(M)}A.sort(this.citation.srt.compareCompositeKeys);var F=!1,q=!1,$=!1;for(o=0,a=A.length;a>o;o+=1)A[o][1].sortkeys[0]!==F&&($=A[o][1].sortkeys[0],q=A[o][1].sortkeys[1]),A[o][1].sortkeys[0]=""+q+o,F=$}t.properties.unsorted||A.sort(this.citation.srt.compareCompositeKeys)}var H;if(this.opt.update_mode===n.POSITION)for(o=0;2>o;o+=1){H=[v,b][o];var z={},V={};for(l=0,c=H.length;c>l;l+=1){var G=H[l];for(H[l].properties.noteIndex||(H[l].properties.noteIndex=0),H[l].properties.noteIndex=parseInt(H[l].properties.noteIndex,10),l>0&&H[l-1].properties.noteIndex>H[l].properties.noteIndex&&(_={},z={},V={}),u=0,h=G.sortedItems.length;h>u;u+=1)this.registry.registry[G.sortedItems[u][1].id].parallel||(_[G.properties.noteIndex]?_[G.properties.noteIndex]+=1:_[G.properties.noteIndex]=1);for(u=0,h=H[l].sortedItems.length;h>u;u+=1){g=H[l].sortedItems[u];var W=g[0].id,X=g[1].locator,K=g[1].label;g[0].legislation_id&&(W=g[0].legislation_id);var J;if(u>0&&(J=G.sortedItems[u-1][0].legislation_id?G.sortedItems[u-1][0].legislation_id:G.sortedItems[u-1][1].id),s!==n.PREVIEW||G.citationID==t.citationID){var Q={};if(Q.position=g[1].position,Q["first-reference-note-number"]=g[1]["first-reference-note-number"],Q["near-note"]=g[1]["near-note"],g[1]["first-reference-note-number"]=0,g[1]["near-note"]=!1,this.registry.citationreg.citationsByItemId[W]&&"note"===this.opt.xclass&&this.opt.has_disambiguate){var Y=this.registry.registry[W]["citation-count"],Z=this.registry.citationreg.citationsByItemId[W].length;if(this.registry.registry[W]["citation-count"]=this.registry.citationreg.citationsByItemId[W].length,"number"==typeof Y){var tt=2>Y,et=2>Z;if(tt!==et)for(var it=0,st=this.registry.citationreg.citationsByItemId[W].length;st>it;it++)k[this.registry.registry[W].ambig]=!0,this.tmp.taintedCitationIDs[this.registry.citationreg.citationsByItemId[W][it].citationID]=!0}else for(var it=0,st=this.registry.citationreg.citationsByItemId[W].length;st>it;it++)k[this.registry.registry[W].ambig]=!0,this.tmp.taintedCitationIDs[this.registry.citationreg.citationsByItemId[W][it].citationID]=!0}var nt;if("undefined"==typeof z[W])z[W]=G.properties.noteIndex,this.registry.registry[W]&&(this.registry.registry[W]["first-reference-note-number"]=G.properties.noteIndex),V[W]=G.properties.noteIndex,g[1].position=n.POSITION_FIRST;else{var rt=!1,ot=!1;if(l>0&&(nt=H[l-1].sortedItems.slice(-1)[0][1].id,H[l-1].sortedItems[0].slice(-1)[0].legislation_id&&(nt=H[l-1].sortedItems[0].slice(-1)[0].legislation_id)),l>0&&0===parseInt(u,10)&&H[l-1].properties.noteIndex!==H[l].properties.noteIndex){var at=H[l-1].sortedItems,lt=!1,ct=H[l-1].sortedItems[0][0].id;for(H[l-1].sortedItems[0][0].legislation_id&&(ct=H[l-1].sortedItems[0][0].legislation_id),(ct==W&&H[l-1].properties.noteIndex>=H[l].properties.noteIndex-1||H[l-1].sortedItems[0][1].id==this.registry.registry[g[1].id].parallel)&&(1===_[H[l-1].properties.noteIndex]||0===H[l-1].properties.noteIndex)&&(lt=!0),p=0,f=at.slice(1).length;f>p;p+=1){var ut=at.slice(1)[p];this.registry.registry[ut[1].id].parallel&&this.registry.registry[ut[1].id].parallel!=this.registry.registry[ut[1].id]||(lt=!1)}lt?rt=!0:ot=!0}else u>0&&J==W?rt=!0:0===u&&H[l-1].properties.noteIndex==H[l].properties.noteIndex&&H[l-1].sortedItems.length&&nt==W?rt=!0:ot=!0;var ht,pt,ft,dt,mt;if(rt&&(ht=u>0?G.sortedItems[u-1][1]:H[l-1].sortedItems[0][1],ht.locator?(ft=ht.label?ht.label:"",pt=""+ht.locator+ft):pt=ht.locator,X?(mt=K?K:"",dt=""+X+mt):dt=X),rt&&pt&&!dt&&(rt=!1,ot=!0),rt&&(!pt&&dt?g[1].position=n.POSITION_IBID_WITH_LOCATOR:pt||dt?pt&&dt===pt?g[1].position=n.POSITION_IBID:pt&&dt&&dt!==pt?g[1].position=n.POSITION_IBID_WITH_LOCATOR:(rt=!1,ot=!0):g[1].position=n.POSITION_IBID),ot&&(g[1].position=n.POSITION_SUBSEQUENT),(ot||rt)&&z[W]!=G.properties.noteIndex&&(g[1]["first-reference-note-number"]=z[W],this.registry.registry[W])){var gt=this.registry.citationreg.citationsByItemId[W][0].properties.noteIndex,bt=G.properties.noteIndex;this.registry.registry[W]["first-reference-note-number"]=gt>bt?bt:gt}}if(G.properties.noteIndex){var vt=parseInt(G.properties.noteIndex,10)-parseInt(V[W],10);g[1].position!==n.POSITION_FIRST&&vt<=this.citation.opt["near-note-distance"]&&(g[1]["near-note"]=!0),V[W]=G.properties.noteIndex}if(G.citationID!=t.citationID)for(p=0,f=n.POSITION_TEST_VARS.length;f>p;p+=1){var yt=n.POSITION_TEST_VARS[p];g[1][yt]!==Q[yt]&&("first-reference-note-number"===yt&&(k[this.registry.registry[W].ambig]=!0),this.tmp.taintedCitationIDs[G.citationID]=!0,"first-reference-note-number"===yt&&(this.tmp.taintedItemIDs[W]=!0))}this.sys.variableWrapper&&(g[1].index=G.properties.index,g[1].noteIndex=G.properties.noteIndex)}else"undefined"==typeof z[g[1].id]?(z[W]=G.properties.noteIndex,V[W]=G.properties.noteIndex):V[W]=G.properties.noteIndex}}}if(this.opt.citation_number_sort&&A&&A.length>1&&this.citation_sort.tokens.length>0){for(o=0,a=A.length;a>o;o+=1)A[o][1].sortkeys=n.getSortKeys.call(this,A[o][0],"citation_sort");t.properties.unsorted||A.sort(this.citation.srt.compareCompositeKeys)}for(d in this.tmp.taintedItemIDs)if(this.tmp.taintedItemIDs.hasOwnProperty(d)&&(H=this.registry.citationreg.citationsByItemId[d]))for(o=0,a=H.length;a>o;o+=1)this.tmp.taintedCitationIDs[H[o].citationID]=!0;var _t=[];if(s===n.PREVIEW){try{_t=this.process_CitationCluster.call(this,t.sortedItems,t.citationID)}catch(xt){n.error("Error running CSL processor for preview: "+xt)}for(this.registry.citationreg.citationByIndex=w,this.registry.citationreg.citationById={},o=0,a=w.length;a>o;o+=1)this.registry.citationreg.citationById[w[o].citationID]=w[o];var wt=[];for(o=0,a=S.length;a>o;o+=1)wt.push(""+S[o].id);this.updateItems(wt);for(d in O)O.hasOwnProperty(d)&&(this.registry.registry[d].disambig=O[d])}else{for(var St in k)this.disambiguate.run(St,t);var Ot;for(d in this.tmp.taintedCitationIDs)if(d!=t.citationID){var Tt=this.registry.citationreg.citationById[d];this.tmp.citation_pos=Tt.properties.index,this.tmp.citation_note_index=Tt.properties.noteIndex,this.tmp.citation_id=""+Tt.citationID,Ot=[],Ot.push(Tt.properties.index),Ot.push(this.process_CitationCluster.call(this,Tt.sortedItems,Tt.citationID)),_t.push(Ot)}this.tmp.taintedItemIDs={},this.tmp.taintedCitationIDs={},this.tmp.citation_pos=t.properties.index,this.tmp.citation_note_index=t.properties.noteIndex,this.tmp.citation_id=""+t.citationID,Ot=[],Ot.push(e.length),Ot.push(this.process_CitationCluster.call(this,A,t.citationID)),_t.push(Ot),_t.sort(function(t,e){return t[0]>e[0]?1:t[0]<e[0]?-1:0})}return x.citation_errors=this.tmp.citation_errors.slice(),[x,_t]},n.Engine.prototype.process_CitationCluster=function(t,e){var i;return this.parallel.StartCitation(t),i=n.getCitationCluster.call(this,t,e)},n.Engine.prototype.makeCitationCluster=function(t){var e,i,s,r,o,a,l;for(e=[],o=t.length,r=0;o>r;r+=1){a={};for(var c in t[r])a[c]=t[r][c];if(l=this.retrieveItem(""+a.id),this.opt.development_extensions.locator_label_parse&&a.locator&&-1===["bill","gazette","legislation","treaty"].indexOf(l.type)&&(!a.label||"page"===a.label)){var u=n.LOCATOR_LABELS_REGEXP.exec(a.locator);u&&(a.label=n.LOCATOR_LABELS_MAP[u[2]],a.locator=u[3])}i=[l,a],e.push(i)}if(this.remapSectionVariable(e),e&&e.length>1&&this.citation_sort.tokens.length>0){for(o=e.length,r=0;o>r;r+=1)e[r][1].sortkeys=n.getSortKeys.call(this,e[r][0],"citation_sort");e.sort(this.citation.srt.compareCompositeKeys)}return this.tmp.citation_errors=[],this.parallel.StartCitation(e),s=n.getCitationCluster.call(this,e)},n.getAmbiguousCite=function(t,e,i){var s,r,o=this.tmp.group_context.value().slice();e?this.tmp.disambig_request=e:this.tmp.disambig_request=!1;var a={position:1};this.registry.registry[t.id]&&this.registry.citationreg.citationsByItemId&&this.registry.citationreg.citationsByItemId[t.id]&&this.registry.citationreg.citationsByItemId[t.id].length&&i&&"by-cite"===this.citation.opt["givenname-disambiguation-rule"]&&(a["first-reference-note-number"]=this.registry.registry[t.id]["first-reference-note-number"]),this.tmp.area="citation",s=this.parallel.use_parallels,this.parallel.use_parallels=!1,this.tmp.suppress_decorations=!0,this.tmp.just_looking=!0,n.getCite.call(this,t,a);for(var l=0,c=this.output.queue.length;c>l;l+=1)n.Output.Queue.purgeEmptyBlobs(this.output.queue[l]);if(this.opt.development_extensions.clean_up_csl_flaws)for(var u=0,h=this.output.queue.length;h>u;u+=1)this.output.adjust.upward(this.output.queue[u]),this.output.adjust.leftward(this.output.queue[u]),this.output.adjust.downward(this.output.queue[u]),this.output.adjust.fix(this.output.queue[u]);return r=this.output.string(this,this.output.queue),this.tmp.just_looking=!1,this.tmp.suppress_decorations=!1,this.parallel.use_parallels=s,this.tmp.group_context.replace(o,"literal"),r},n.getSpliceDelimiter=function(t,e){if(t&&!this.tmp.have_collapsed&&"string"==typeof this.citation.opt["after-collapse-delimiter"])this.tmp.splice_delimiter=this.citation.opt["after-collapse-delimiter"];else if(this.tmp.have_collapsed&&"in-text"===this.opt.xclass&&this.opt.update_mode!==n.NUMERIC)this.tmp.splice_delimiter=", ";else if(this.tmp.use_cite_group_delimiter)this.tmp.splice_delimiter=this.citation.opt.cite_group_delimiter;else if(this.tmp.cite_locales[e-1]){var i=this.tmp.cite_affixes[this.tmp.area][this.tmp.cite_locales[e-1]];i&&i.delimiter&&(this.tmp.splice_delimiter=i.delimiter)}return this.tmp.splice_delimiter||(this.tmp.splice_delimiter=""),this.tmp.splice_delimiter},n.getCitationCluster=function(t,e){var i,s,r,o,a,l,c,u,h,p,f,d,m,g,b,v,y,_,x;this.tmp.last_primary_names_string=!1,this.tmp.nestedBraces=!1,_=n.getSafeEscape(this),this.tmp.area="citation",i="",s=[],this.tmp.last_suffix_used="",this.tmp.last_names_used=[],this.tmp.last_years_used=[],this.tmp.backref_index=[],this.tmp.cite_locales=[];var w=!1;if("note"===this.opt.xclass&&this.citation.opt.suppressTrailingPunctuation&&(w=!0),e&&this.registry.citationreg.citationById[e].properties["suppress-trailing-punctuation"]&&(w=!0),"note"===this.opt.xclass){for(var S=[],O=!1,T=!1,I=!1,N=[],E=0,C=t.length;C>E;E+=1){var A=t[E][0].type,k=t[E][0].title,R=t[E][1].position,P=t[E][0].id;k&&"legal_case"===A&&P!==I&&R&&((k!==O||0===S.length)&&(N=[],S.push(N)),N.push(t[E][1])),O=k,T=R,I=P}for(E=0,C=S.length;C>E;E+=1)if(N=S[E],!(N.length<2)){var D=N.slice(-1)[0].locator;if(D)for(var j=0,L=N.length-1;L>j;j+=1)N[j].locator&&(D=!1);D&&(N[0].locator=D,delete N.slice(-1)[0].locator,N[0].label=N.slice(-1)[0].label,N.slice(-1)[0].label&&delete N.slice(-1)[0].label)}}for(r=[],o=t.length,a=0;o>a;a+=1){if(m=t[a][0],l=t[a][1],c=this.tmp.have_collapsed,u={},a>0?n.getCite.call(this,m,l,""+t[a-1][0].id):(this.tmp.term_predecessor=!1,n.getCite.call(this,m,l)),this.tmp.cite_renders_content||(x={citationID:""+this.tmp.citation_id,index:this.tmp.citation_pos,noteIndex:this.tmp.citation_note_index,itemID:""+m.id,citationItems_pos:a,error_code:n.ERROR_NO_RENDERED_FORM},this.tmp.citation_errors.push(x)),a===t.length-1&&this.parallel.ComposeSet(),u.splice_delimiter=n.getSpliceDelimiter.call(this,c,a),l&&l["author-only"]&&(this.tmp.suppress_decorations=!0),a>0){y=t[a-1][1];var M=y.suffix&&"."===y.suffix.slice(-1),U=!y.suffix&&l.prefix&&"."===l.prefix.slice(0,1);if(M||U){var B=u.splice_delimiter.indexOf(" ");B>-1&&!U?u.splice_delimiter=u.splice_delimiter.slice(B):u.splice_delimiter=""}}u.suppress_decorations=this.tmp.suppress_decorations,u.have_collapsed=this.tmp.have_collapsed,r.push(u)}this.tmp.has_purged_parallel=!1,this.parallel.PruneOutputQueue(this),h=0,d=this.output.queue.slice();var F=({strings:{suffix:this.citation.opt.layout_suffix,delimiter:this.citation.opt.layout_delimiter}},this.citation.opt.layout_suffix),q=this.tmp.cite_locales[this.tmp.cite_locales.length-1];q&&this.tmp.cite_affixes[this.tmp.area][q]&&this.tmp.cite_affixes[this.tmp.area][q].suffix&&(F=this.tmp.cite_affixes[this.tmp.area][q].suffix),n.TERMINAL_PUNCTUATION.slice(0,-1).indexOf(F.slice(0,1))>-1&&(F=F.slice(0,1));var $=this.citation.opt.layout_delimiter;$||($=""),n.TERMINAL_PUNCTUATION.slice(0,-1).indexOf($.slice(0,1))>-1&&($=$.slice(0,1));for(var H=F,E=0,C=this.output.queue.length;C>E;E+=1)n.Output.Queue.purgeEmptyBlobs(this.output.queue[E]);if(!this.tmp.suppress_decorations&&this.output.queue.length&&(this.opt.development_extensions.apply_citation_wrapper&&this.sys.wrapCitationEntry&&!this.tmp.just_looking&&"citation"===this.tmp.area||(w||(this.output.queue[this.output.queue.length-1].strings.suffix=H),this.output.queue[0].strings.prefix=this.citation.opt.layout_prefix)),this.opt.development_extensions.clean_up_csl_flaws)for(var j=0,L=this.output.queue.length;L>j;j+=1)this.output.adjust.upward(this.output.queue[j]),this.output.adjust.leftward(this.output.queue[j]),this.output.adjust.downward(this.output.queue[j]),this.tmp.last_chr=this.output.adjust.fix(this.output.queue[j]);for(a=0,o=d.length;o>a;a+=1){if(this.output.queue=[d[a]],this.tmp.suppress_decorations=r[a].suppress_decorations,this.tmp.splice_delimiter=r[a].splice_delimiter,d[a].parallel_delimiter&&(this.tmp.splice_delimiter=d[a].parallel_delimiter),this.tmp.have_collapsed=r[a].have_collapsed,p=this.output.string(this,this.output.queue),this.tmp.suppress_decorations=!1,"string"==typeof p)return this.tmp.suppress_decorations=!1,p;if("object"==typeof p&&0===p.length&&!l["suppress-author"])if(this.tmp.has_purged_parallel)p.push("");else{var z="[CSL STYLE ERROR: reference with no printed form.]",V=0===a?_(this.citation.opt.layout_prefix):"",G=a===d.length-1?_(this.citation.opt.layout_suffix):"";p.push(V+z+G)}if(s.length&&"string"==typeof p[0]){p.reverse();var W=p.pop();W&&","===W.slice(0,1)?s.push(W):"string"==typeof s.slice(-1)[0]&&","===s.slice(-1)[0].slice(-1)?s.push(" "+W):W&&s.push(_(this.tmp.splice_delimiter)+W)}else p.reverse(),f=p.pop(),"undefined"!=typeof f&&(s.length&&"string"==typeof s[s.length-1]&&(s[s.length-1]+=f.successor_prefix),s.push(f));for(g=p.length,b=0;g>b;b+=1)v=p[b],"string"!=typeof v?(f=p.pop(),"undefined"!=typeof f&&s.push(f)):s.push(_(this.tmp.splice_delimiter)+v);0!==s.length||t[a][1]["suppress-author"]||(h+=1)}if(i+=this.output.renderBlobs(s),i&&(this.output.nestedBraces=!1,!this.tmp.suppress_decorations))for(o=this.citation.opt.layout_decorations.length,a=0;o>a;a+=1)u=this.citation.opt.layout_decorations[a],"normal"!==u[1]&&(i=this.fun.decorate[u[0]][u[1]](this,i));return this.tmp.suppress_decorations=!1,i},n.getCite=function(t,e,i){var s,r;for(this.tmp.cite_renders_content=!1,this.parallel.StartCite(t,e,i),n.citeStart.call(this,t,e),s=0,this.nameOutput=new n.NameOutput(this,t,e);s<this[this.tmp.area].tokens.length;)s=n.tokenExec.call(this,this[this.tmp.area].tokens[s],t,e);return n.citeEnd.call(this,t,e),this.parallel.CloseCite(this),this.tmp.cite_renders_content||this.tmp.just_looking||"bibliography"===this.tmp.area&&(r={index:this.tmp.bibliography_pos,itemID:""+t.id,error_code:n.ERROR_NO_RENDERED_FORM},this.tmp.bibliography_errors.push(r)),""+t.id},n.citeStart=function(t,e){if(this.tmp.disambiguate_count=0,this.tmp.disambiguate_maxMax=0,this.tmp.same_author_as_previous_cite=!1,this.tmp.suppress_decorations?this.tmp.subsequent_author_substitute_ok=!1:this.tmp.subsequent_author_substitute_ok=!0,this.tmp.lastchr="","citation"===this.tmp.area&&this.citation.opt.collapse&&this.citation.opt.collapse.length?this.tmp.have_collapsed=!0:this.tmp.have_collapsed=!1,this.tmp.render_seen=!1,this.tmp.disambig_request&&!this.tmp.disambig_override?this.tmp.disambig_settings=this.tmp.disambig_request:this.registry.registry[t.id]&&!this.tmp.disambig_override?(this.tmp.disambig_request=this.registry.registry[t.id].disambig,this.tmp.disambig_settings=this.registry.registry[t.id].disambig):this.tmp.disambig_settings=new n.AmbigConfig,"citation"!==this.tmp.area&&this.registry.registry[t.id]&&(this.tmp.disambig_restore=n.cloneAmbigConfig(this.registry.registry[t.id].disambig),"bibliography"===this.tmp.area&&this.tmp.disambig_settings&&this.tmp.disambig_override&&(this.opt["disambiguate-add-names"]&&(this.tmp.disambig_settings.names=this.registry.registry[t.id].disambig.names.slice(),this.tmp.disambig_request.names=this.registry.registry[t.id].disambig.names.slice()),this.opt["disambiguate-add-givenname"]))){this.tmp.disambig_request=this.tmp.disambig_settings,this.tmp.disambig_settings.givens=this.registry.registry[t.id].disambig.givens.slice(),this.tmp.disambig_request.givens=this.registry.registry[t.id].disambig.givens.slice();for(var i=0,s=this.tmp.disambig_settings.givens.length;s>i;i+=1)this.tmp.disambig_settings.givens[i]=this.registry.registry[t.id].disambig.givens[i].slice();for(var i=0,s=this.tmp.disambig_request.givens.length;s>i;i+=1)this.tmp.disambig_request.givens[i]=this.registry.registry[t.id].disambig.givens[i].slice()}if(this.tmp.names_used=[],this.tmp.nameset_counter=0,this.tmp.years_used=[],this.tmp.names_max.clear(),this.tmp.splice_delimiter=this[this.tmp.area].opt.layout_delimiter,this.bibliography_sort.keys=[],this.citation_sort.keys=[],this.tmp.has_done_year_suffix=!1,this.tmp.last_cite_locale=!1,!this.tmp.just_looking&&e&&!e.position&&this.registry.registry[t.id]&&(this.tmp.disambig_restore=n.cloneAmbigConfig(this.registry.registry[t.id].disambig)),this.tmp.shadow_numbers={},this.setNumberLabels(t),this.tmp.first_name_string=!1,this.opt.development_extensions.flip_parentheses_to_braces&&e&&e.prefix){var r=n.checkNestedBraceOpen.exec(e.prefix),o=n.checkNestedBraceClose.exec(e.prefix);r?o?o[0].length<r[0].length?this.output.nestedBraces=n.NestedBraces:this.output.nestedBraces=!1:this.output.nestedBraces=n.NestedBraces:o&&(this.output.nestedBraces=!1)}},n.citeEnd=function(t,e){if(this.tmp.disambig_restore){this.registry.registry[t.id].disambig.names=this.tmp.disambig_restore.names.slice(),this.registry.registry[t.id].disambig.givens=this.tmp.disambig_restore.givens.slice();for(var i=0,s=this.registry.registry[t.id].disambig.givens.length;s>i;i+=1)this.registry.registry[t.id].disambig.givens[i]=this.tmp.disambig_restore.givens[i].slice()}if(this.tmp.disambig_restore=!1,e&&e.suffix?this.tmp.last_suffix_used=e.suffix:this.tmp.last_suffix_used="",this.tmp.last_years_used=this.tmp.years_used.slice(),this.tmp.last_names_used=this.tmp.names_used.slice(),this.tmp.cut_var=!1,this.tmp.disambig_request=!1,this.tmp.cite_locales.push(this.tmp.last_cite_locale),this.tmp.issued_date&&this.tmp.renders_collection_number){for(var r=[],i=this.tmp.issued_date.list.length-1;i>this.tmp.issued_date.pos;i+=-1)r.push(this.tmp.issued_date.list.pop());for(this.tmp.issued_date.list.pop(),i=r.length-1;i>-1;i+=-1)this.tmp.issued_date.list.push(r.pop());this.parallel.use_parallels&&(this.parallel.cite.issued=!1)}if(this.tmp.issued_date=!1,
this.tmp.renders_collection_number=!1,this.opt.development_extensions.flip_parentheses_to_braces&&e&&e.suffix){var o=n.checkNestedBraceOpen.exec(e.suffix),a=n.checkNestedBraceClose.exec(e.suffix);a?o?o[0].length<a[0].length?this.output.nestedBraces=!1:this.output.nestedBraces=n.NestedBraces:this.output.nestedBraces=!1:o&&(this.output.nestedBraces=n.NestedBraces)}},n.Engine.prototype.makeBibliography=function(t){var e,i,s,r,o,a,l,c,u;if(e=!1,!this.bibliography.tokens.length)return!1;"string"==typeof t&&(this.opt.citation_number_slug=t,t=!1),i=n.getBibliographyEntries.call(this,t),c=i[0],u=i[1];var h=i[2];for(s={maxoffset:0,entryspacing:this.bibliography.opt["entry-spacing"],linespacing:this.bibliography.opt["line-spacing"],"second-field-align":!1,entry_ids:c,bibliography_errors:this.tmp.bibliography_errors.slice(),done:h},this.bibliography.opt["second-field-align"]&&(s["second-field-align"]=this.bibliography.opt["second-field-align"]),r=0,a=this.registry.reflist.length,l=0;a>l;l+=1)o=this.registry.reflist[l],o.offset>s.maxoffset&&(s.maxoffset=o.offset);return this.bibliography.opt.hangingindent&&(s.hangingindent=this.bibliography.opt.hangingindent),s.bibstart=this.fun.decorate.bibstart,s.bibend=this.fun.decorate.bibend,this.opt.citation_number_slug=!1,[s,u]},n.getBibliographyEntries=function(t){function e(t,e){return t===e?!0:!1}function i(t,i){for(d=i.length,m=0;d>m;m+=1)if(e(t,i[m]))return!0;return!1}function s(t,s){return"none"!==t&&t||s?"string"==typeof s?e(t,s):s?i(t,s):!1:!0}var r,o,a,l,c,u,h,p,f,d,m,g,b,v,y,_,x,w,S,O,T,I,N,E;r=[],I=[],this.tmp.area="bibliography",this.tmp.last_rendered_name=!1,this.tmp.bibliography_errors=[],this.tmp.bibliography_pos=0,o=t&&t.page_start&&t.page_length?this.registry.getSortedIds():this.retrieveItems(this.registry.getSortedIds()),this.tmp.disambig_override=!0,w={};var C;if(t&&t.page_start&&t.page_length&&(C=0,t.page_start!==!0))for(y=0,_=o.length;_>y&&(w[o[y]]=!0,t.page_start!=o[y]);y+=1);var A=[];for(y=0,_=o.length;_>y;y+=1){if(t&&t.page_start&&t.page_length){if(w[o[y]])continue;if(p=this.retrieveItem(o[y]),C===t.page_length)break}else if(p=o[y],w[p.id])continue;if(t){if(a=!0,t.include){for(a=!1,N=0,E=t.include.length;E>N;N+=1)if(f=t.include[N],s(f.value,p[f.field])){a=!0;break}}else if(t.exclude){for(l=!1,N=0,E=t.exclude.length;E>N;N+=1)if(f=t.exclude[N],s(f.value,p[f.field])){l=!0;break}l&&(a=!1)}else if(t.select){for(a=!1,c=!0,N=0,E=t.select.length;E>N;N+=1)f=t.select[N],s(f.value,p[f.field])||(c=!1);c&&(a=!0)}if(t.quash){for(c=!0,N=0,E=t.quash.length;E>N;N+=1)f=t.quash[N],s(f.value,p[f.field])||(c=!1);c&&(a=!1)}if(!a)continue}if(u=new n.Token("group",n.START),u.decorations=[["@bibliography","entry"]].concat(this.bibliography.opt.layout_decorations),this.output.startTag("bib_entry",u),p.system_id&&this.sys.embedBibliographyEntry?this.output.current.value().item_id=p.system_id:this.output.current.value().system_id=p.id,S=[[{id:""+p.id},p]],b=[],!this.registry.registry[p.id].master||t&&t.page_start&&t.page_length)this.registry.registry[p.id].siblings||(this.parallel.StartCitation(S),this.tmp.term_predecessor=!1,b.push(""+n.getCite.call(this,p)),t&&t.page_start&&t.page_length&&(C+=1));else{for(v=!0,this.parallel.StartCitation(S),this.output.queue[0].strings.delimiter=", ",this.tmp.term_predecessor=!1,b.push(""+n.getCite.call(this,p)),w[p.id]=!0,x=this.registry.registry[p.id].siblings,N=0,E=x.length;E>N;N+=1){var k=this.registry.registry[p.id].siblings[N];O=this.retrieveItem(k),b.push(""+n.getCite.call(this,O)),w[O.id]=!0}this.parallel.ComposeSet(),this.parallel.PruneOutputQueue()}if(I.push(""),this.tmp.bibliography_pos+=1,A.push(b),this.output.endTag("bib_entry"),this.output.queue[0].blobs.length&&this.output.queue[0].blobs[0].blobs.length){for(v||!this.output.queue[0].blobs[0].blobs[0].strings?(g=this.output.queue[0].blobs,v=!1):g=this.output.queue[0].blobs[0].blobs,N=g.length-1;N>-1;N+=-1)if(g[N].blobs&&0!==g[N].blobs.length){var R,P=this.tmp.cite_locales[this.tmp.cite_locales.length-1];R=this.tmp.cite_affixes[this.tmp.area][P]?this.tmp.cite_affixes[this.tmp.area][P].suffix:this.bibliography.opt.layout_suffix,T=R.slice(0,1),T&&g[N].strings.suffix.slice(-1)===T&&(g[N].strings.suffix=g[N].strings.suffix.slice(0,-1)),g[N].strings.suffix+=R;break}g[0].strings.prefix=this.bibliography.opt.layout_prefix+g[0].strings.prefix}for(var N=0,E=this.output.queue.length;E>N;N+=1)n.Output.Queue.purgeEmptyBlobs(this.output.queue[N]);for(var N=0,E=this.output.queue.length;E>N;N+=1)this.output.adjust.upward(this.output.queue[N]),this.output.adjust.leftward(this.output.queue[N]),this.output.adjust.downward(this.output.queue[N],!0),this.output.adjust.fix(this.output.queue[N]);h=this.output.string(this,this.output.queue)[0],h||(h="\n[CSL STYLE ERROR: reference with no printed form.]\n"),r.push(h)}var D=!1;if(t&&t.page_start&&t.page_length){var j=o.slice(-1)[0],L=A.slice(-1)[0];j&&L&&j!=L||(D=!0)}return this.tmp.disambig_override=!1,[A,r,D]},n.Engine.prototype.setCitationId=function(t,e){var i,s,n;if(i=!1,!t.citationID||e){for(s=Math.floor(1e14*Math.random());;){if(n=0,!this.registry.citationreg.citationById[s]){t.citationID=s.toString(32);break}n=!n&&5e13>s?1:-1,s+=1===n?1:-1}i=""+s}return this.registry.citationreg.citationById[t.citationID]=t,i},n.Engine.prototype.rebuildProcessorState=function(t,e,i){t||(t=[]),e||(e="html");for(var s={},r=[],o=0,a=t.length;a>o;o+=1)for(var l=0,c=t[o].citationItems.length;c>l;l+=1){var u=""+t[o].citationItems[l].id;s[u]||r.push(u),s[u]=!0}this.updateItems(r);var h=[],p=[],f=[],d=this.opt.mode;this.setOutputFormat(e);for(var o=0,a=t.length;a>o;o+=1){var m=this.processCitationCluster(t[o],h,p,n.ASSUME_ALL_ITEMS_REGISTERED);h.push([t[o].citationID,t[o].properties.noteIndex]);for(var l=0,c=m[1].length;c>l;l+=1){var g=m[1][l][0];f[g]=[h[g][0],h[g][1],m[1][l][1]]}}return this.updateUncitedItems(i),this.setOutputFormat(d),f},n.Engine.prototype.restoreProcessorState=function(t){var e,i,s,r,o,a,l,c,u,h;c=[],u=[],t||(t=[]);var p=[],f={};for(e=0,i=t.length;i>e;e+=1)f[t[e].citationID]&&this.setCitationId(t[e],!0),f[t[e].citationID]=!0,p.push(t[e].properties.index);var d=t.slice();for(d.sort(function(t,e){return t.properties.index<e.properties.index?-1:t.properties.index>e.properties.index?1:0}),e=0,i=d.length;i>e;e+=1)d[e].properties.index=e;for(e=0,i=d.length;i>e;e+=1){for(h=[],s=0,r=d[e].citationItems.length;r>s;s+=1)o=d[e].citationItems[s],"undefined"==typeof o.sortkeys&&(o.sortkeys=[]),a=this.retrieveItem(""+o.id),l=[a,o],h.push(l),d[e].citationItems[s].item=a,u.push(""+o.id);d[e].properties.unsorted||h.sort(this.citation.srt.compareCompositeKeys),d[e].sortedItems=h,this.registry.citationreg.citationById[d[e].citationID]=d[e]}for(this.updateItems(u),e=0,i=t.length;i>e;e+=1)c.push([""+t[e].citationID,t[e].properties.noteIndex]);var m=[];return t&&t.length?m=this.processCitationCluster(t[0],[],c.slice(1)):(this.registry=new n.Registry(this),this.tmp=new n.Engine.Tmp,this.disambiguate=new n.Disambiguation(this)),m},n.Engine.prototype.updateItems=function(t,e,i){var s=this.tmp.area;if(this.registry.init(t),i)for(var n in this.registry.ambigcites)this.registry.ambigsTouched[n]=!0;return this.registry.dodeletes(this.registry.myhash),this.registry.doinserts(this.registry.mylist),this.registry.dorefreshes(),this.registry.rebuildlist(),this.registry.setsortkeys(),this.registry.setdisambigs(),e||this.registry.sorttokens(),this.registry.renumber(),this.tmp.area=s,this.registry.getSortedIds()},n.Engine.prototype.updateUncitedItems=function(t,e){if(t||(t=[]),"object"==typeof t)if("undefined"==typeof t.length){var i=t;t=[];for(var s in i)t.push(s)}else if("number"==typeof t.length)for(var i={},n=0,r=t.length;r>n;n+=1)i[t[n]]=!0;return this.registry.init(t,!0),this.registry.dopurge(i),this.registry.doinserts(this.registry.mylist),this.registry.dorefreshes(),this.registry.rebuildlist(),this.registry.setsortkeys(),this.registry.setdisambigs(),e||this.registry.sorttokens(),this.registry.renumber(),this.registry.getSortedIds()},n.localeResolve=function(t,e){var i,s;return e||(e="en-US"),t||(t=e),i={},s=t.split(/[\-_]/),i.base=n.LANG_BASES[s[0]],"undefined"==typeof i.base?(n.debug("Warning: unknown locale "+t+", setting fallback to "+e),{base:e,best:t,bare:s[0]}):(1===s.length&&(i.generic=!0),1===s.length||"x"===s[1]?i.best=i.base.replace("_","-"):i.best=s.slice(0,2).join("-"),i.base=i.base.replace("_","-"),i.bare=s[0],i)},n.Engine.prototype.localeConfigure=function(t,e){var i;if(this.opt.development_extensions.normalize_lang_keys_to_lowercase&&(t.best=t.best.toLowerCase(),t.bare=t.bare.toLowerCase(),t.base=t.base.toLowerCase()),(!e||!this.locale[t.best])&&(i=this.sys.xml.makeXml(this.sys.retrieveLocale("en-US")),this.localeSet(i,"en-US",t.best),"en-US"!==t.best&&(t.base!==t.best&&(i=this.sys.xml.makeXml(this.sys.retrieveLocale(t.base)),this.localeSet(i,t.base,t.best)),i=this.sys.xml.makeXml(this.sys.retrieveLocale(t.best)),this.localeSet(i,t.best,t.best)),this.localeSet(this.cslXml,"",t.best),this.localeSet(this.cslXml,t.bare,t.best),t.base!==t.best&&this.localeSet(this.cslXml,t.base,t.best),this.localeSet(this.cslXml,t.best,t.best),"undefined"==typeof this.locale[t.best].terms["page-range-delimiter"]&&(["fr","pt"].indexOf(t.best.slice(0,2).toLowerCase())>-1?this.locale[t.best].terms["page-range-delimiter"]="-":this.locale[t.best].terms["page-range-delimiter"]="–"),"undefined"==typeof this.locale[t.best].terms["year-range-delimiter"]&&(this.locale[t.best].terms["year-range-delimiter"]="–"),"undefined"==typeof this.locale[t.best].terms["citation-range-delimiter"]&&(this.locale[t.best].terms["citation-range-delimiter"]="–"),this.opt.development_extensions.normalize_lang_keys_to_lowercase)){for(var s=["default-locale","locale-sort","locale-translit","locale-translat"],n=0,r=s.length;r>n;n+=1)for(var o=0,a=this.opt[s[n]].length;a>o;o+=1)this.opt[s[n]][o]=this.opt[s[n]][o].toLowerCase();this.opt.lang=this.opt.lang.toLowerCase()}},n.Engine.prototype.localeSet=function(t,e,i){var s,r,o,a,l,c,u,h,p,f,d,m,g,b,v,y;if(e=e.replace("_","-"),i=i.replace("_","-"),this.opt.development_extensions.normalize_lang_keys_to_lowercase&&(e=e.toLowerCase(),i=i.toLowerCase()),this.locale[i]||(this.locale[i]={},this.locale[i].terms={},this.locale[i].opts={},this.locale[i].opts["skip-words"]=n.SKIP_WORDS,this.locale[i].opts["leading-noise-words"]||(this.locale[i].opts["leading-noise-words"]=[]),this.locale[i].dates={},this.locale[i].ord={"1.0.1":!1,keys:{}},this.locale[i]["noun-genders"]={}),r=this.sys.xml.makeXml(),this.sys.xml.nodeNameIs(t,"locale"))r=t;else for(o=this.sys.xml.getNodesByName(t,"locale"),l=0,m=this.sys.xml.numberofnodes(o);m>l;l+=1)if(s=o[l],this.sys.xml.getAttributeValue(s,"lang","xml")===e){r=s;break}for(o=this.sys.xml.getNodesByName(r,"type"),v=0,y=this.sys.xml.numberofnodes(o);y>v;v+=1){var _=o[v],x=this.sys.xml.getAttributeValue(_,"name"),w=this.sys.xml.getAttributeValue(_,"gender");this.opt.gender[x]=w}var S=this.sys.xml.getNodesByName(r,"term","ordinal").length;if(S){for(var O in this.locale[i].ord.keys)delete this.locale[i].terms[O];this.locale[i].ord={"1.0.1":!1,keys:{}}}o=this.sys.xml.getNodesByName(r,"term");var T={"last-digit":{},"last-two-digits":{},"whole-number":{}},I=!1,N={};for(l=0,m=this.sys.xml.numberofnodes(o);m>l;l+=1){if(c=o[l],h=this.sys.xml.getAttributeValue(c,"name"),"sub verbo"===h&&(h="sub-verbo"),"ordinal"===h.slice(0,7)){this.sys.xml.getNodeValue(c);if("ordinal"===h)I=!0;else{var E=this.sys.xml.getAttributeValue(c,"match"),C=h.slice(8),g=this.sys.xml.getAttributeValue(c,"gender-form");g||(g="neuter"),E||(E="last-two-digits","0"===C.slice(0,1)&&(E="last-digit")),"0"===C.slice(0,1)&&(C=C.slice(1)),T[E][C]||(T[E][C]={}),T[E][C][g]=h}this.locale[i].ord.keys[h]=!0}"undefined"==typeof this.locale[i].terms[h]&&(this.locale[i].terms[h]={}),u="long",g=!1,this.sys.xml.getAttributeValue(c,"form")&&(u=this.sys.xml.getAttributeValue(c,"form")),this.sys.xml.getAttributeValue(c,"gender-form")&&(g=this.sys.xml.getAttributeValue(c,"gender-form")),this.sys.xml.getAttributeValue(c,"gender")&&(this.locale[i]["noun-genders"][h]=this.sys.xml.getAttributeValue(c,"gender")),g?(this.locale[i].terms[h][g]={},this.locale[i].terms[h][g][u]=[],b=this.locale[i].terms[h][g],N[h]=!0):(this.locale[i].terms[h][u]=[],b=this.locale[i].terms[h]),this.sys.xml.numberofnodes(this.sys.xml.getNodesByName(c,"multiple"))?(b[u][0]=this.sys.xml.getNodeValue(c,"single"),b[u][1]=this.sys.xml.getNodeValue(c,"multiple")):b[u]=this.sys.xml.getNodeValue(c)}if(I){for(var A in N){var k={},R=0;for(var P in this.locale[i].terms[A])["masculine","feminine"].indexOf(P)>-1?k[P]=this.locale[i].terms[A][P]:R+=1;if(!R)if(k.feminine)for(var P in k.feminine)this.locale[i].terms[A][P]=k.feminine[P];else if(k.masculine)for(var P in k.masculine)this.locale[i].terms[A][P]=k.masculine[P]}this.locale[i].ord["1.0.1"]=T}for(h in this.locale[i].terms)for(v=0,y=2;y>v;v+=1)if(g=n.GENDERS[v],this.locale[i].terms[h][g])for(u in this.locale[i].terms[h])this.locale[i].terms[h][g][u]||(this.locale[i].terms[h][g][u]=this.locale[i].terms[h][u]);for(o=this.sys.xml.getNodesByName(r,"style-options"),l=0,m=this.sys.xml.numberofnodes(o);m>l;l+=1){p=o[l],a=this.sys.xml.attributes(p);for(d in a)if(a.hasOwnProperty(d))if("@punctuation-in-quote"===d||"@limit-day-ordinals-to-day-1"===d)"true"===a[d]?this.locale[i].opts[d.slice(1)]=!0:this.locale[i].opts[d.slice(1)]=!1;else if("@skip-words"===d){var D=a[d].split(/\s*,\s*/);this.locale[i].opts[d.slice(1)]=D}else if("@leading-noise-words"===d&&e===i){var j=a[d].split(/\s*,\s*/);this.locale[i].opts["leading-noise-words"]=j}else if("@name-as-sort-order"===d){this.locale[i].opts["name-as-sort-order"]={};for(var L=a[d].split(/\s+/),v=0,y=L.length;y>v;v+=1)this.locale[i].opts["name-as-sort-order"][L[v]]=!0}else if("@name-as-reverse-order"===d){this.locale[i].opts["name-as-reverse-order"]={};for(var L=a[d].split(/\s+/),v=0,y=L.length;y>v;v+=1)this.locale[i].opts["name-as-reverse-order"][L[v]]=!0}else if("@name-never-short"===d){this.locale[i].opts["name-never-short"]={};for(var L=a[d].split(/\s+/),v=0,y=L.length;y>v;v+=1)this.locale[i].opts["name-never-short"][L[v]]=!0}}for(o=this.sys.xml.getNodesByName(r,"date"),l=0,m=this.sys.xml.numberofnodes(o);m>l;l+=1)f=o[l],this.locale[i].dates[this.sys.xml.getAttributeValue(f,"form")]=f},n.Node={},n.Node.bibliography={build:function(t,e){this.tokentype===n.START&&(t.build.area="bibliography",t.build.root="bibliography",t.fixOpt(this,"names-delimiter","delimiter"),t.fixOpt(this,"name-delimiter","delimiter"),t.fixOpt(this,"name-form","form"),t.fixOpt(this,"and","and"),t.fixOpt(this,"delimiter-precedes-last","delimiter-precedes-last"),t.fixOpt(this,"delimiter-precedes-et-al","delimiter-precedes-et-al"),t.fixOpt(this,"initialize-with","initialize-with"),t.fixOpt(this,"initialize","initialize"),t.fixOpt(this,"name-as-sort-order","name-as-sort-order"),t.fixOpt(this,"sort-separator","sort-separator"),t.fixOpt(this,"and","and"),t.fixOpt(this,"et-al-min","et-al-min"),t.fixOpt(this,"et-al-use-first","et-al-use-first"),t.fixOpt(this,"et-al-use-last","et-al-use-last"),t.fixOpt(this,"et-al-subsequent-min","et-al-subsequent-min"),t.fixOpt(this,"et-al-subsequent-use-first","et-al-subsequent-use-first")),e.push(this)}},n.Node.choose={build:function(t,e){var i;this.tokentype===n.START&&(i=function(t,e){t.tmp.jump.push(void 0,n.LITERAL)}),this.tokentype===n.END&&(i=function(t,e){t.tmp.jump.pop()}),this.execs.push(i),e.push(this)},configure:function(t,e){this.tokentype===n.END?(t.configure.fail.push(e),t.configure.succeed.push(e)):(t.configure.fail.pop(),t.configure.succeed.pop())}},n.Node.citation={build:function(t,e){if(this.tokentype===n.START&&(t.fixOpt(this,"names-delimiter","delimiter"),t.fixOpt(this,"name-delimiter","delimiter"),t.fixOpt(this,"name-form","form"),t.fixOpt(this,"and","and"),t.fixOpt(this,"delimiter-precedes-last","delimiter-precedes-last"),t.fixOpt(this,"delimiter-precedes-et-al","delimiter-precedes-et-al"),t.fixOpt(this,"initialize-with","initialize-with"),t.fixOpt(this,"initialize","initialize"),t.fixOpt(this,"name-as-sort-order","name-as-sort-order"),t.fixOpt(this,"sort-separator","sort-separator"),t.fixOpt(this,"and","and"),t.fixOpt(this,"et-al-min","et-al-min"),t.fixOpt(this,"et-al-use-first","et-al-use-first"),t.fixOpt(this,"et-al-use-last","et-al-use-last"),t.fixOpt(this,"et-al-subsequent-min","et-al-subsequent-min"),t.fixOpt(this,"et-al-subsequent-use-first","et-al-subsequent-use-first"),t.build.area="citation"),this.tokentype===n.END){if(t.opt.grouped_sort="in-text"===t.opt.xclass&&t.citation.opt.collapse&&t.citation.opt.collapse.length||t.citation.opt.cite_group_delimiter&&t.citation.opt.cite_group_delimiter.length&&t.opt.update_mode!==n.POSITION&&t.opt.update_mode!==n.NUMERIC,t.opt.grouped_sort&&t.citation_sort.opt.sort_directions.length){var i=t.citation_sort.opt.sort_directions[0].slice();t.citation_sort.opt.sort_directions=[i].concat(t.citation_sort.opt.sort_directions)}t.citation.srt=new n.Registry.Comparifier(t,"citation_sort")}}},n.Node["#comment"]={build:function(t,e){}},n.Node.date={build:function(t,e){var i,s,r,o,a,l,c,u,h,p;(this.tokentype===n.START||this.tokentype===n.SINGLETON)&&(t.build.date_parts=[],t.build.date_variables=this.variables,t.build.extension||n.Util.substituteStart.call(this,t,e),i=t.build.extension?n.dateMacroAsSortKey:function(t,e,i){var n;if(t.tmp.element_rendered_ok=!1,t.tmp.donesies=[],t.tmp.dateparts=[],n=[],!this.variables.length||t.tmp.just_looking&&"issued"!==this.variables[0])t.tmp.date_object=!1;else{for(t.parallel.StartVariable(this.variables[0]),s=e[this.variables[0]],"undefined"==typeof s&&(s={"date-parts":[[0]]},t.opt.development_extensions.locator_date_and_revision&&i&&"locator-date"===this.variables[0]&&i["locator-date"]&&(s=i["locator-date"])),t.tmp.date_object=s,r=this.dateparts.length,o=0;r>o;o+=1)a=this.dateparts[o],"undefined"!=typeof t.tmp.date_object[a+"_end"]?n.push(a):"month"===a&&"undefined"!=typeof t.tmp.date_object.season_end&&n.push(a);for(l=[],c=["year","month","day"],r=c.length,o=0;r>o;o+=1)n.indexOf(c[o])>-1&&l.push(c[o]);for(n=l.slice(),u=2,r=n.length,o=0;r>o;o+=1)if(a=n[o],h=t.tmp.date_object[a],p=t.tmp.date_object[a+"_end"],h!==p){u=o;break}t.tmp.date_collapse_at=n.slice(u)}},this.execs.push(i),i=function(t,e){if(t.output.startTag("date",this),"issued"===this.variables[0]&&"legal_case"===e.type&&!t.tmp.extension&&""+e["collection-number"]==""+t.tmp.date_object.year&&1===this.dateparts.length&&"year"===this.dateparts[0])for(var i in t.tmp.date_object)if(t.tmp.date_object.hasOwnProperty(i)&&"year"===i.slice(0,4)){t.tmp.issued_date={};var s=t.output.current.mystack.slice(-2)[0].blobs;t.tmp.issued_date.list=s,t.tmp.issued_date.pos=s.length-1}},this.execs.push(i)),t.build.extension||this.tokentype!==n.END&&this.tokentype!==n.SINGLETON||(i=function(t,e){t.output.endTag(),t.parallel.CloseVariable("date")},this.execs.push(i)),e.push(this),(this.tokentype===n.END||this.tokentype===n.SINGLETON)&&(t.build.extension||n.Util.substituteEnd.call(this,t,e))}},n.Node["date-part"]={build:function(t,e){var i,s,r,o,a,l,c,u,h,p,f,d,m,g,b,v,y,_,x,w,S,O,T,I;this.strings.form||(this.strings.form="long"),t.build.date_parts.push(this.strings.name);var N=t.build.date_variables[0];i=function(t,e){if(t.tmp.date_object){if(o=!0,a="",l="",t.tmp.donesies.push(this.strings.name),t.tmp.date_object.literal&&"year"===this.strings.name&&(t.parallel.AppendToVariable(t.tmp.date_object.literal),t.output.append(t.tmp.date_object.literal,this)),t.tmp.date_object&&(a=t.tmp.date_object[this.strings.name],l=t.tmp.date_object[this.strings.name+"_end"]),"year"!==this.strings.name||0!==a||t.tmp.suppress_decorations||(a=!1),c=!t.tmp.suppress_decorations,u=t.tmp.have_collapsed,h="year-suffix"===t[t.tmp.area].opt.collapse||"year-suffix-ranged"===t[t.tmp.area].opt.collapse,p=t.opt["disambiguate-add-year-suffix"],c&&p&&h&&(t.tmp.years_used.push(a),f=t.tmp.last_years_used.length>=t.tmp.years_used.length,f&&u&&t.tmp.last_years_used[t.tmp.years_used.length-1]===a&&(a=!1)),"undefined"!=typeof a){d=!1,m=!1,g=!1,b=!1,"year"===this.strings.name&&(parseInt(a,10)<500&&parseInt(a,10)>0&&(m=t.getTerm("ad")),parseInt(a,10)<0&&(d=t.getTerm("bc"),a=-1*parseInt(a,10)),l&&(parseInt(l,10)<500&&parseInt(l,10)>0&&(b=t.getTerm("ad")),parseInt(l,10)<0&&(g=t.getTerm("bc"),l=-1*parseInt(l,10)))),t.parallel.AppendToVariable(a);for(var i=""+t.tmp.date_object.month;i.length<2;)i="0"+i;i="month-"+i;var E=t.locale[t.opt.lang]["noun-genders"][i];if(this.strings.form){var C=this.strings.form;if("day"===this.strings.name&&"ordinal"===C&&t.locale[t.opt.lang].opts["limit-day-ordinals-to-day-1"]&&""+a!="1"&&(C="numeric"),a=n.Util.Dates[this.strings.name][C](t,a,E,"accessed"===N),"month"===this.strings.name)if(t.tmp.strip_periods)a=a.replace(/\./g,"");else for(T=0,I=this.decorations.length;I>T;T+=1)if("@strip-periods"===this.decorations[T][0]&&"true"===this.decorations[T][1]){a=a.replace(/\./g,"");break}if(l)if(l=n.Util.Dates[this.strings.name][C](t,l,E,"accessed"===N,"_end"),t.tmp.strip_periods)l=l.replace(/\./g,"");else for(T=0,I=this.decorations.length;I>T;T+=1)if("@strip-periods"===this.decorations[T][0]&&"true"===this.decorations[T][1]){l=l.replace(/\./g,"");break}}if(t.output.openLevel("empty"),t.tmp.date_collapse_at.length){for(v=!0,r=t.tmp.date_collapse_at.length,s=0;r>s;s+=1)if(O=t.tmp.date_collapse_at[s],-1===t.tmp.donesies.indexOf(O)){v=!1;break}if(v){if(""+l!="0"){if(0===t.dateput.queue.length&&(o=!0),t.opt["year-range-format"]&&"expanded"!==t.opt["year-range-format"]&&!t.tmp.date_object.day&&!t.tmp.date_object.month&&!t.tmp.date_object.season&&"year"===this.strings.name&&a&&l){l=t.fun.year_mangler(a+"-"+l,!0);var A=t.getTerm("year-range-delimiter");l=l.slice(l.indexOf(A)+1)}t.dateput.append(l,this),o&&(t.dateput.current.value()[0].strings.prefix="")}t.output.append(a,this),y=t.output.current.value(),y.blobs[y.blobs.length-1].strings.suffix="",t.output.append(t.getTerm("year-range-delimiter"),"empty"),_=t.dateput.current.value(),y.blobs=y.blobs.concat(_),t.dateput.string(t,t.dateput.queue),t.tmp.date_collapse_at=[]}else t.output.append(a,this),t.tmp.date_collapse_at.indexOf(this.strings.name)>-1&&""+l!="0"&&(0===t.dateput.queue.length&&(o=!0),t.dateput.openLevel("empty"),t.dateput.append(l,this),o&&(t.dateput.current.value().blobs[0].strings.prefix=""),d&&t.dateput.append(d),m&&t.dateput.append(m),t.dateput.closeLevel())}else t.output.append(a,this);d&&t.output.append(d),m&&t.output.append(m),t.output.closeLevel()}else"month"===this.strings.name&&t.tmp.date_object.season&&(a=""+t.tmp.date_object.season,a&&a.match(/^[1-4]$/)?(t.tmp.group_context.replace([!1,!1,!0]),t.output.append(t.getTerm("season-0"+a),this)):a&&t.output.append(a,this));t.tmp.value=[],!a&&!t.tmp.have_collapsed||t.opt.has_year_suffix||"year"!==this.strings.name||t.tmp.just_looking||t.registry.registry[e.id]&&t.registry.registry[e.id].disambig.year_suffix!==!1&&!t.tmp.has_done_year_suffix&&(t.tmp.has_done_year_suffix=!0,w=parseInt(t.registry.registry[e.id].disambig.year_suffix,10),x=new n.NumericBlob(w,this,e.id),this.successor_prefix=t[t.build.area].opt.layout_delimiter,this.splice_prefix=t[t.build.area].opt.layout_delimiter,S=new n.Util.Suffixator(n.SUFFIX_CHARS),x.setFormatter(S),"year-suffix-ranged"===t[t.tmp.area].opt.collapse&&(x.range_prefix=t.getTerm("citation-range-delimiter")),t[t.tmp.area].opt["year-suffix-delimiter"]?x.successor_prefix=t[t.tmp.area].opt["year-suffix-delimiter"]:x.successor_prefix=t[t.tmp.area].opt.layout_delimiter,x.UGLY_DELIMITER_SUPPRESS_HACK=!0,t.output.append(x,"literal"))}},this.execs.push(i),e.push(this)}},n.Node["else-if"]={build:function(t,e){n.Conditions.TopNode.call(this,t,e),e.push(this)},configure:function(t,e){n.Conditions.Configure.call(this,t,e)}},n.Node["else"]={build:function(t,e){e.push(this)},configure:function(t,e){this.tokentype===n.START&&(t.configure.fail[t.configure.fail.length-1]=e)}},n.Node["et-al"]={build:function(t,e){if("citation"===t.build.area||"bibliography"===t.build.area){var i=function(t,e,i){t.tmp.etal_node=this,"string"==typeof this.strings.term&&(t.tmp.etal_term=this.strings.term)};this.execs.push(i)}e.push(this)}},n.Node.group={build:function(t,e){var i,s;this.tokentype===n.START?(n.Util.substituteStart.call(this,t,e),t.build.substitute_level.value()&&t.build.substitute_level.replace(t.build.substitute_level.value()+1),i=function(t,e){t.output.startTag("group",this),t.tmp.group_context.mystack.length&&(t.output.current.value().parent=t.tmp.group_context.value()[4]);var i=t.tmp.group_context.value()[5];!i&&this.strings.label_form_override&&(i=this.strings.label_form_override),t.tmp.group_context.push([!1,!1,!1,!1,t.output.current.value(),i,this.strings.set_parallel_condition],n.LITERAL),this.strings.oops&&(t.tmp.group_context.value()[3]=this.strings.oops)},s=[],s.push(i),this.execs=s.concat(this.execs),this.strings["has-publisher-and-publisher-place"]&&(t.build["publisher-special"]=!0,i=function(t,e){if(this.strings["subgroup-delimiter"]&&e.publisher&&e["publisher-place"]){var i=e.publisher.split(/;\s*/),s=e["publisher-place"].split(/;\s*/);i.length>1&&i.length===s.length&&(t.publisherOutput=new n.PublisherOutput(t,this),t.publisherOutput["publisher-list"]=i,t.publisherOutput["publisher-place-list"]=s)}},this.execs.push(i))):(t.build["publisher-special"]&&(t.build["publisher-special"]=!1,"string"==typeof t[t.build.root].opt["name-delimiter"]&&(i=function(t,e){t.publisherOutput&&(t.publisherOutput.render(),t.publisherOutput=!1)},this.execs.push(i))),i=function(t,e){var i=t.tmp.group_context.pop();t.output.endTag();t.tmp.group_context.value();if(i[1]&&(t.tmp.group_context.value()[1]=!0),i[2]||i[0]&&!i[1]){t.tmp.group_context.value()[2]=!0;var s=t.output.current.value().blobs,n=t.output.current.value().blobs.length-1;if(!t.tmp.just_looking&&"undefined"!=typeof i[6]){var r={blobs:s,conditions:i[6],id:e.id,pos:n};t.parallel.parallel_conditional_blobs_list.push(r)}}else t.output.current.value().blobs&&t.output.current.value().blobs.pop(),t.tmp.group_context.value()[3]&&(t.output.current.mystack[t.output.current.mystack.length-2].strings.delimiter=t.tmp.group_context.value()[3])},this.execs.push(i)),e.push(this),this.tokentype===n.END&&(t.build.substitute_level.value()&&t.build.substitute_level.replace(t.build.substitute_level.value()-1),n.Util.substituteEnd.call(this,t,e))}},n.Node["if"]={build:function(t,e){n.Conditions.TopNode.call(this,t,e),e.push(this)},configure:function(t,e){n.Conditions.Configure.call(this,t,e)}},n.Node.conditions={build:function(t,e){this.tokentype===n.START&&t.tmp.conditions.addMatch(this.match),this.tokentype===n.END&&t.tmp.conditions.matchCombine()}},n.Node.condition={build:function(t,e){if(this.tokentype===n.SINGLETON){var i=t.fun.match[this.match](this,t,this.tests);t.tmp.conditions.addTest(i)}}},n.Conditions={},n.Conditions.TopNode=function(t,e){var i;(this.tokentype===n.START||this.tokentype===n.SINGLETON)&&(this.locale&&(t.opt.lang=this.locale),this.tests&&this.tests.length?this.test=t.fun.match[this.match](this,t,this.tests):t.tmp.conditions=new n.Conditions.Engine(t,this)),(this.tokentype===n.END||this.tokentype===n.SINGLETON)&&(i=function(t,e){this.locale_default&&(t.output.current.value().old_locale=this.locale_default,t.output.closeLevel("empty"),t.opt.lang=this.locale_default);var i=this[t.tmp.jump.value()];return i},this.execs.push(i),this.locale_default&&(t.opt.lang=this.locale_default))},n.Conditions.Configure=function(t,e){this.tokentype===n.START?(this.fail=t.configure.fail.slice(-1)[0],this.succeed=this.next,t.configure.fail[t.configure.fail.length-1]=e):this.tokentype===n.SINGLETON?(this.fail=this.next,this.succeed=t.configure.succeed.slice(-1)[0],t.configure.fail[t.configure.fail.length-1]=e):(this.succeed=t.configure.succeed.slice(-1)[0],this.fail=this.next)},n.Conditions.Engine=function(t,e){this.token=e,this.state=t},n.Conditions.Engine.prototype.addTest=function(t){this.token.tests.push(t)},n.Conditions.Engine.prototype.addMatch=function(t){this.token.match=t},n.Conditions.Engine.prototype.matchCombine=function(){this.token.test=this.state.fun.match[this.token.match](this.token,this.state,this.token.tests)},n.Node.info={build:function(t,e){this.tokentype===n.START?t.build.skip="info":t.build.skip=!1}},n.Node.institution={build:function(t,e){if([n.SINGLETON,n.START].indexOf(this.tokentype)>-1){var i=function(t,e){"string"!=typeof t.build.name_delimiter||this.strings.delimiter||(this.strings.delimiter=t.tmp.name_delimiter);"text"===this.strings.and?this.and_term=t.getTerm("and","long",0):"symbol"===this.strings.and?t.opt.development_extensions.expect_and_symbol_form?this.and_term=t.getTerm("and","symbol",0):this.and_term="&":"none"===this.strings.and&&(this.and_term=this.strings.delimiter),"undefined"==typeof this.and_term&&t.tmp.and_term&&(this.and_term=t.getTerm("and","long",0)),n.STARTSWITH_ROMANESQUE_REGEXP.test(this.and_term)?(this.and_prefix_single=" ",this.and_prefix_multiple=", ","string"==typeof this.strings.delimiter&&(this.and_prefix_multiple=this.strings.delimiter),this.and_suffix=" "):(this.and_prefix_single="",this.and_prefix_multiple="",this.and_suffix=""),"always"===this.strings["delimiter-precedes-last"]?this.and_prefix_single=this.strings.delimiter:"never"===this.strings["delimiter-precedes-last"]&&this.and_prefix_multiple&&(this.and_prefix_multiple=" "),this.and={},"undefined"!=typeof this.and_term?(t.output.append(this.and_term,"empty",!0),this.and.single=t.output.pop(),this.and.single.strings.prefix=this.and_prefix_single,this.and.single.strings.suffix=this.and_suffix,t.output.append(this.and_term,"empty",!0),this.and.multiple=t.output.pop(),this.and.multiple.strings.prefix=this.and_prefix_multiple,this.and.multiple.strings.suffix=this.and_suffix):"undefined"!==this.strings.delimiter&&(this.and.single=new n.Blob(this.strings.delimiter),this.and.single.strings.prefix="",this.and.single.strings.suffix="",this.and.multiple=new n.Blob(this.strings.delimiter),this.and.multiple.strings.prefix="",this.and.multiple.strings.suffix=""),t.nameOutput.institution=this};this.execs.push(i)}e.push(this)},configure:function(t,e){[n.SINGLETON,n.START].indexOf(this.tokentype)>-1&&(t.build.has_institution=!0)}},n.Node["institution-part"]={build:function(t,e){var i;"long"===this.strings.name?i=this.strings["if-short"]?function(t,e){t.nameOutput.institutionpart["long-with-short"]=this}:function(t,e){t.nameOutput.institutionpart["long"]=this}:"short"===this.strings.name&&(i=function(t,e){t.nameOutput.institutionpart["short"]=this}),this.execs.push(i),e.push(this)}},n.Node.key={build:function(t,e){var i,s=new n.Token("key",n.START);s.strings["et-al-min"]=this.strings["et-al-min"],s.strings["et-al-use-first"]=this.strings["et-al-use-first"],s.strings["et-al-use-last"]=this.strings["et-al-use-last"],i=function(t,e){t.tmp.done_vars=[]},s.execs.push(i),t.opt.citation_number_sort_direction=this.strings.sort_direction,i=function(t,e){t.output.openLevel("empty")},s.execs.push(i);var r=[];if(this.strings.sort_direction===n.DESCENDING?(r.push(1),r.push(-1)):(r.push(-1),r.push(1)),t[t.build.area].opt.sort_directions.push(r),n.DATE_VARIABLES.indexOf(this.variables[0])>-1&&(t.build.date_key=!0),i=function(t,e){t.tmp.sort_key_flag=!0,this.strings["et-al-min"]&&(t.tmp["et-al-min"]=this.strings["et-al-min"]),this.strings["et-al-use-first"]&&(t.tmp["et-al-use-first"]=this.strings["et-al-use-first"]),"boolean"==typeof this.strings["et-al-use-last"]&&(t.tmp["et-al-use-last"]=this.strings["et-al-use-last"])},s.execs.push(i),e.push(s),this.variables.length){var o=this.variables[0];if("citation-number"===o&&("citation_sort"===t.build.area&&(t.opt.citation_number_sort=!0),"bibliography_sort"===t.build.area&&(t.opt.citation_number_sort_used=!0)),n.CREATORS.indexOf(o)>-1){var a=new n.Token("names",n.START);a.tokentype=n.START,a.variables=this.variables,n.Node.names.build.call(a,t,e);var l=new n.Token("name",n.SINGLETON);l.tokentype=n.SINGLETON,l.strings["name-as-sort-order"]="all",l.strings["sort-separator"]=" ",
l.strings["et-al-use-last"]=this.strings["et-al-use-last"],l.strings["et-al-min"]=this.strings["et-al-min"],l.strings["et-al-use-first"]=this.strings["et-al-use-first"],n.Node.name.build.call(l,t,e);var c=new n.Token("institution",n.SINGLETON);c.tokentype=n.SINGLETON,n.Node.institution.build.call(c,t,e);var u=new n.Token("names",n.END);u.tokentype=n.END,n.Node.names.build.call(u,t,e)}else{var h=new n.Token("text",n.SINGLETON);if(h.dateparts=this.dateparts,n.NUMERIC_VARIABLES.indexOf(o)>-1)i=function(t,e){var i;i=!1,i="citation-number"===o?t.registry.registry[e.id].seq.toString():e[o],i&&(i=n.Util.padding(i)),t.output.append(i,this)};else if("citation-label"===o)i=function(t,e){var i=t.getCitationLabel(e);t.output.append(i,this)};else if(n.DATE_VARIABLES.indexOf(o)>-1)i=n.dateAsSortKey,h.variables=this.variables;else if("title"===o){var p="title",f=!1,d=!1,m=!0;i=t.transform.getOutputFunction(this.variables,p,f,d,m)}else i=function(t,e){var i=e[o];t.output.append(i,"empty")};h.execs.push(i),e.push(h)}}else{var g=new n.Token("text",n.SINGLETON);g.postponed_macro=this.postponed_macro,n.expandMacro.call(t,g)}var b=new n.Token("key",n.END);i=function(t,e){var i=t.output.string(t,t.output.queue);t.sys.normalizeUnicode&&(i=t.sys.normalizeUnicode(i)),""===i&&(i=void 0),("string"!=typeof i||t.tmp.empty_date)&&(i=void 0,t.tmp.empty_date=!1),t[t.tmp.area].keys.push(i),t.tmp.value=[]},b.execs.push(i),t.build.date_key&&("citation_sort"===t.build.area&&(t[t.build.area].opt.sort_directions.push([-1,1]),i=function(t,e){var i=t.registry.registry[e.id].disambig.year_suffix;i||(i=0);var s=n.Util.padding(""+i);t[t.tmp.area].keys.push(s)},b.execs.push(i)),t.build.date_key=!1),i=function(t,e){t.tmp["et-al-min"]=void 0,t.tmp["et-al-use-first"]=void 0,t.tmp["et-al-use-last"]=void 0,t.tmp.sort_key_flag=!1},b.execs.push(i),e.push(b)}},n.Node.label={build:function(t,e){if(this.strings.term){this.strings.form||(this.strings.form="long");var i=function(t,e,i){var s=n.evaluateLabel(this,t,e,i);i&&"locator"===this.strings.term&&(t.parallel.StartVariable("label"),t.parallel.AppendToVariable(i.label),i.section_form_override=this.strings.form),t.output.append(s,this),i&&"locator"===this.strings.term&&t.parallel.CloseVariable()};this.execs.push(i)}else{var s=t.build.names_variables.slice(-1)[0];t.build.name_label||(t.build.name_label={});for(var r=0,o=s.length;o>r;r+=1)t.build.name_label[s[r]]||(t.build.name_label[s[r]]={});if(t.build.name_flag)for(var r=0,o=s.length;o>r;r+=1)t.build.name_label[s[r]].after=this;else for(var r=0,o=s.length;o>r;r+=1)t.build.name_label[s[r]].before=this}e.push(this)}},n.Node.layout={build:function(t,e){var i,s,r,o;this.tokentype===n.START&&(i=function(t,e,i){t.opt.development_extensions.apply_citation_wrapper&&t.sys.wrapCitationEntry&&!t.tmp.just_looking&&e.system_id&&"citation"===t.tmp.area&&(cite_entry=new n.Token("group",n.START),cite_entry.decorations=[["@cite","entry"]],t.output.startTag("cite_entry",cite_entry),t.output.current.value().item_id=e.system_id,i&&(t.output.current.value().locator_txt=i.locator_txt,t.output.current.value().suffix_txt=i.suffix_txt))},this.execs.push(i)),this.tokentype!==n.START||t.tmp.cite_affixes[t.build.area]||(i=function(t,e){t.tmp.done_vars=[],!t.tmp.just_looking&&t.registry.registry[e.id].parallel&&t.tmp.done_vars.push("first-reference-note-number"),t.tmp.rendered_name=!1,t.tmp.name_node={}},this.execs.push(i),i=function(t,e){t.tmp.sort_key_flag=!1},this.execs.push(i),i=function(t,e){t.tmp.nameset_counter=0},this.execs.push(i),i=function(t,e){var i="empty";t.opt.development_extensions.rtl_support&&["ar","he","fa","ur","yi","ps","syr"].indexOf(e.language)>-1&&(i=new n.Token,i.strings.prefix="‫",i.strings.suffix="‬"),t.output.openLevel(i)},this.execs.push(i),e.push(this),t.opt.development_extensions.rtl_support,1,"citation"===t.build.area&&(s=new n.Token("text",n.SINGLETON),i=function(t,e,i){var s;if(i&&i.prefix){s="";var r=i.prefix.replace(/<[^>]+>/g,"").replace(/["'\u201d\u2019\u00bb\u202f\u00a0 ]+$/g,""),o=r.slice(-1);r.match(n.ENDSWITH_ROMANESQUE_REGEXP)?s=" ":n.TERMINAL_PUNCTUATION.slice(0,-1).indexOf(o)>-1?s=" ":o.match(/[\)\],0-9]/)&&(s=" ");var a=!1;n.TERMINAL_PUNCTUATION.slice(0,-1).indexOf(o)>-1&&(t.tmp.term_predecessor=!1,a=!0),prefix=(i.prefix+s).replace(/\s+/g," "),t.output.append(prefix,this,!1,a)}},s.execs.push(i),e.push(s)));var a;if(this.locale_raw&&(a=new n.Token("dummy",n.START),a.locale=this.locale_raw,a.strings.delimiter=this.strings.delimiter,a.strings.suffix=this.strings.suffix,t.tmp.cite_affixes[t.build.area]||(t.tmp.cite_affixes[t.build.area]={})),this.tokentype===n.START&&(t.build.layout_flag=!0,this.locale_raw||(t[t.tmp.area].opt.topdecor=[this.decorations],t[t.tmp.area+"_sort"].opt.topdecor=[this.decorations],t[t.build.area].opt.layout_prefix=this.strings.prefix,t[t.build.area].opt.layout_suffix=this.strings.suffix,t[t.build.area].opt.layout_delimiter=this.strings.delimiter,t[t.build.area].opt.layout_decorations=this.decorations,t.tmp.cite_affixes[t.build.area]&&(o=new n.Token("else",n.START),n.Node["else"].build.call(o,t,e))),this.locale_raw)){if(t.build.layout_locale_flag)a.name="else-if",n.Attributes["@locale-internal"].call(a,t,this.locale_raw),n.Node["else-if"].build.call(a,t,e);else{var l=new n.Token("choose",n.START);n.Node.choose.build.call(l,t,e),a.name="if",n.Attributes["@locale-internal"].call(a,t,this.locale_raw),n.Node["if"].build.call(a,t,e)}t.tmp.cite_affixes[t.build.area][a.locale]={},t.tmp.cite_affixes[t.build.area][a.locale].delimiter=this.strings.delimiter,t.tmp.cite_affixes[t.build.area][a.locale].suffix=this.strings.suffix}this.tokentype===n.END&&(this.locale_raw&&(t.build.layout_locale_flag?(a.name="else-if",a.tokentype=n.END,n.Attributes["@locale-internal"].call(a,t,this.locale_raw),n.Node["else-if"].build.call(a,t,e)):(a.name="if",a.tokentype=n.END,n.Attributes["@locale-internal"].call(a,t,this.locale_raw),n.Node["if"].build.call(a,t,e),t.build.layout_locale_flag=!0)),this.locale_raw||(t.tmp.cite_affixes[t.build.area]&&t.build.layout_locale_flag&&(o=new n.Token("else",n.END),n.Node["else"].build.call(o,t,e),o=new n.Token("choose",n.END),n.Node.choose.build.call(o,t,e)),t.build_layout_locale_flag=!0,"citation"===t.build.area&&(r=new n.Token("text",n.SINGLETON),i=function(t,e,i){var s;i&&i.suffix&&(s="",(i.suffix.match(n.STARTSWITH_ROMANESQUE_REGEXP)||["[","("].indexOf(i.suffix.slice(0,1))>-1)&&(s=" "),t.output.append(s+i.suffix,this))},r.execs.push(i),e.push(r)),i=function(t,e){"bibliography"===t.tmp.area&&t.bibliography.opt["second-field-align"]&&t.output.endTag(),t.output.closeLevel()},this.execs.push(i),i=function(t,e){t.opt.development_extensions.apply_citation_wrapper&&t.sys.wrapCitationEntry&&!t.tmp.just_looking&&e.system_id&&"citation"===t.tmp.area&&t.output.endTag()},this.execs.push(i),e.push(this),t.build.layout_flag=!1,t.build.layout_locale_flag=!1))}},n.Node.macro={build:function(t,e){}},n.NameOutput=function(t,e,i,s){this.debug=!1,this.state=t,this.Item=e,this.item=i,this.nameset_base=0,this.etal_spec={},this._first_creator_variable=!1,this._please_chop=!1},n.NameOutput.prototype.init=function(t){this.state.tmp.term_predecessor&&(this.state.tmp.subsequent_author_substitute_ok=!1),this.nameset_offset&&(this.nameset_base=this.nameset_base+this.nameset_offset),this.nameset_offset=0,this.names=t,this.variables=t.variables,this.state.tmp.value=[],this.state.tmp.rendered_name=[],this.state.tmp.label_blob=!1,this.state.tmp.etal_node=!1,this.state.tmp.etal_term=!1;for(var e=0,i=this.variables.length;i>e;e+=1)this.Item[this.variables[e]]&&this.Item[this.variables[e]].length&&(this.state.tmp.value=this.state.tmp.value.concat(this.Item[this.variables[e]]));this["et-al"]=void 0,this["with"]=void 0,this.name=void 0,this.institutionpart={},this.state.tmp.group_context.value()[1]=!0,!this.state.tmp.value.length},n.NameOutput.prototype.reinit=function(t){if(this.state.tmp.can_substitute.value()){this.nameset_offset=0,this.variables=t.variables;var e=this.state.tmp.value.slice();this.state.tmp.value=[];for(var i=0,s=this.variables.length;s>i;i+=1)this.Item[this.variables[i]]&&this.Item[this.variables[i]].length&&(this.state.tmp.value=this.state.tmp.value.concat(this.Item[this.variables[i]]));this.state.tmp.value.length&&this.state.tmp.can_substitute.replace(!1,n.LITERAL),this.state.tmp.value=e}},n.NameOutput.prototype.outputNames=function(){var t,e,i=this.variables;if(this.institution.and&&(this.institution.and.single.blobs&&this.institution.and.single.blobs.length||(this.institution.and.single.blobs=this.name.and.single.blobs),this.institution.and.multiple.blobs&&this.institution.and.multiple.blobs.length||(this.institution.and.multiple.blobs=this.name.and.multiple.blobs)),this.variable_offset={},this.family)for(this.family_decor=n.Util.cloneToken(this.family),this.family_decor.strings.prefix="",this.family_decor.strings.suffix="",t=0,e=this.family.execs.length;e>t;t+=1)this.family.execs[t].call(this.family_decor,this.state,this.Item);else this.family_decor=!1;if(this.given)for(this.given_decor=n.Util.cloneToken(this.given),this.given_decor.strings.prefix="",this.given_decor.strings.suffix="",t=0,e=this.given.execs.length;e>t;t+=1)this.given.execs[t].call(this.given_decor,this.state,this.Item);else this.given_decor=!1;if(this.getEtAlConfig(),this.divideAndTransliterateNames(),this.truncatePersonalNameLists(),this.disambigNames(),this.constrainNames(),"count"===this.name.strings.form)return void((this.state.tmp.extension||0!=this.names_count)&&(this.state.output.append(this.names_count,"empty"),this.state.tmp.group_context.value()[2]=!0));this.setEtAlParameters(),this.setCommonTerm(),this.state.tmp.name_node={},this.state.tmp.name_node.children=[],this.renderAllNames();var s=[];for(t=0,e=i.length;e>t;t+=1){for(var r=i[t],o=[],a=!1,l=0,c=this.institutions[r].length;c>l;l+=1)o.push(this.joinPersonsAndInstitutions([this.persons[r][l],this.institutions[r][l]]));if(this.institutions[r].length){var u=this.nameset_base+this.variable_offset[r];this.freeters[r].length&&(u+=1),a=this.joinInstitutionSets(o,u)}var h=this.joinFreetersAndInstitutionSets([this.freeters[r],a]);if(h&&("_sort"!==this.state.tmp.area.slice(-5)&&(h=this._applyLabels(h,r)),s.push(h)),this.common_term)break}for(this.state.output.openLevel("empty"),this.state.output.current.value().strings.delimiter=this.names.strings.delimiter,t=0,e=s.length;e>t;t+=1)this.state.output.append(s[t],"literal",!0);this.state.output.closeLevel("empty");var p=this.state.output.pop();if(this.state.output.append(p,this.names),this.state.tmp.term_predecessor_name&&(this.state.tmp.term_predecessor=!0),this.state.tmp.name_node.top=this.state.output.current.value(),"authority"!==i[0]){var f=[],d=this.Item[i[0]];if(d)for(var t=0,e=d.length;e>t;t+=1)substring=n.Util.Names.getRawName(d[t]),substring&&f.push(substring);f=f.join(", "),f&&(this.state.tmp.name_node.string=f)}if(this.state.tmp.name_node.string&&!this.state.tmp.first_name_string&&(this.state.tmp.first_name_string=this.state.tmp.name_node.string),"classic"===this.Item.type){var m=[];this.state.tmp.first_name_string&&m.push(this.state.tmp.first_name_string),this.Item.title&&m.push(this.Item.title),m=m.join(", "),m&&this.state.sys.getAbbreviation&&(this.state.transform.loadAbbreviation("default","classic",m),this.state.transform.abbrevs["default"].classic[m]&&(this.state.tmp.done_vars.push("title"),this.state.output.append(this.state.transform.abbrevs["default"].classic[m],"empty",!0),p=this.state.output.pop(),this.state.tmp.name_node.top.blobs.pop(),this.state.tmp.name_node.top.blobs.push(p)))}this._collapseAuthor(),this.variables=[]},n.NameOutput.prototype._applyLabels=function(t,e){var i;if(!this.label||!this.label[e])return t;var s=0,n=this.freeters_count[e]+this.institutions_count[e];if(n>1)s=1;else{for(var r=0,o=this.persons[e].length;o>r;r+=1)n+=this.persons_count[e][r];n>1&&(s=1)}return this.label[e].before&&("number"==typeof this.label[e].before.strings.plural&&(s=this.label[e].before.strings.plural),i=this._buildLabel(e,s,"before",e),this.state.output.openLevel("empty"),this.state.output.append(i,this.label[e].before,!0),this.state.output.append(t,"literal",!0),this.state.output.closeLevel("empty"),t=this.state.output.pop()),this.label[e].after&&("number"==typeof this.label[e].after.strings.plural&&(s=this.label[e].after.strings.plural),i=this._buildLabel(e,s,"after",e),this.state.output.openLevel("empty"),this.state.output.append(t,"literal",!0),this.state.output.append(i,this.label[e].after,!0),this.state.tmp.label_blob=this.state.output.pop(),this.state.output.append(this.state.tmp.label_blob,"literal",!0),this.state.output.closeLevel("empty"),t=this.state.output.pop()),t},n.NameOutput.prototype._buildLabel=function(t,e,i,s){this.common_term&&(t=this.common_term);var r=!1,o=this.label[s][i];return o&&(r=n.castLabel(this.state,o,t,e,n.TOLERANT)),r},n.NameOutput.prototype._collapseAuthor=function(){var t,e,i;0===this.nameset_base&&this.Item[this.variables[0]]&&!this._first_creator_variable&&(this._first_creator_variable=this.variables[0]),(this.item&&this.item["suppress-author"]&&this._first_creator_variable==this.variables[0]||this.state[this.state.tmp.area].opt.collapse&&this.state[this.state.tmp.area].opt.collapse.length||this.state[this.state.tmp.area].opt.cite_group_delimiter&&this.state[this.state.tmp.area].opt.cite_group_delimiter.length)&&(this.state.tmp.authorstring_request?(e="",t=this.state.tmp.name_node.top.blobs.slice(-1)[0].blobs,i=this.state.tmp.offset_characters,t&&(e=this.state.output.string(this.state,t,!1)),this.state.tmp.offset_characters=i,this.state.registry.authorstrings[this.Item.id]=e):this.state.tmp.just_looking||this.state.tmp.suppress_decorations||!(this.item["suppress-author"]||this.state[this.state.tmp.area].opt.collapse&&this.state[this.state.tmp.area].opt.collapse.length||this.state[this.state.tmp.area].opt.cite_group_delimiter&&this.state[this.state.tmp.area].opt.cite_group_delimiter)||(e="",t=this.state.tmp.name_node.top.blobs.slice(-1)[0].blobs,i=this.state.tmp.offset_characters,t&&(e=this.state.output.string(this.state,t,!1)),e===this.state.tmp.last_primary_names_string?((this.item["suppress-author"]||this.state[this.state.tmp.area].opt.collapse&&this.state[this.state.tmp.area].opt.collapse.length)&&(this.state.tmp.name_node.top.blobs.pop(),this.state.tmp.name_node.children=[],this.state.tmp.offset_characters=i),this.state[this.state.tmp.area].opt.cite_group_delimiter&&this.state[this.state.tmp.area].opt.cite_group_delimiter&&(this.state.tmp.use_cite_group_delimiter=!0)):(this.state.tmp.last_primary_names_string=e,this.variables.indexOf(this._first_creator_variable)>-1&&this.item&&this.item["suppress-author"]&&"legal_case"!==this.Item.type&&(this.state.tmp.name_node.top.blobs.pop(),this.state.tmp.name_node.children=[],this.state.tmp.offset_characters=i,this.state.tmp.term_predecessor=!1),this.state.tmp.have_collapsed=!1,this.state[this.state.tmp.area].opt.cite_group_delimiter&&this.state[this.state.tmp.area].opt.cite_group_delimiter&&(this.state.tmp.use_cite_group_delimiter=!1))))},n.NameOutput.prototype.isPerson=function(t){return t.literal||!t.given&&t.family&&t.isInstitution?!1:!0},n.NameOutput.prototype.truncatePersonalNameLists=function(){var t,e,i,s,n,r,o;this.freeters_count={},this.persons_count={},this.institutions_count={};for(t in this.freeters)this.freeters.hasOwnProperty(t)&&(this.freeters_count[t]=this.freeters[t].length,this.freeters[t]=this._truncateNameList(this.freeters,t));for(t in this.persons)if(this.persons.hasOwnProperty(t))for(this.institutions_count[t]=this.institutions[t].length,this._truncateNameList(this.institutions,t),this.persons[t]=this.persons[t].slice(0,this.institutions[t].length),this.persons_count[t]=[],s=0,n=this.persons[t].length;n>s;s+=1)this.persons_count[t][s]=this.persons[t][s].length,this.persons[t][s]=this._truncateNameList(this.persons,t,s);if(r=1!==this.etal_min||1!==this.etal_use_first||this.state.tmp.extension||this.state.tmp.just_looking?!1:t,r||this._please_chop)for(e=0,i=this.variables.length;i>e;e+=1){for(t=this.variables[e],this.freeters[t].length&&(this._please_chop===t?(this.freeters[t]=this.freeters[t].slice(1),this.freeters_count[t]+=-1,this._please_chop=!1):r&&!this._please_chop&&(this.freeters[t]=this.freeters[t].slice(0,1),this.freeters_count[t]=1,this.institutions[t]=[],this.persons[t]=[],this._please_chop=r)),e=0,i=this.persons[t].length;i>e;e+=1)if(this.persons[t][e].length){if(this._please_chop===t){this.persons[t][e]=this.persons[t][e].slice(1),this.persons_count[t][e]+=-1,this._please_chop=!1;break}if(r&&!this._please_chop){this.freeters[t]=this.persons[t][e].slice(0,1),this.freeters_count[t]=1,this.institutions[t]=[],this.persons[t]=[],o=[],this._please_chop=r;break}}this.institutions[t].length&&(this._please_chop===t?(this.institutions[t]=this.institutions[t].slice(1),this.institutions_count[t]+=-1,this._please_chop=!1):r&&!this._please_chop&&(this.institutions[t]=this.institutions[t].slice(0,1),this.institutions_count[t]=1,o=[],this._please_chop=r))}for(e=0,i=this.variables.length;i>e;e+=1)for(this.institutions[t].length&&(this.nameset_offset+=1),e=0,i=this.persons[t].length;i>e;e+=1)this.persons[t][e].length&&(this.nameset_offset+=1)},n.NameOutput.prototype._truncateNameList=function(t,e,i){var s;return s="undefined"==typeof i?t[e]:t[e][i],this.state[this.state[this.state.tmp.area].root].opt.max_number_of_names&&s.length>50&&s.length>this.state[this.state[this.state.tmp.area].root].opt.max_number_of_names+2&&(s=s.slice(0,this.state[this.state[this.state.tmp.area].root].opt.max_number_of_names+2)),s},n.NameOutput.prototype.divideAndTransliterateNames=function(){var t,e,i,s,n=this.Item,r=this.variables;for(this.varnames=r.slice(),this.freeters={},this.persons={},this.institutions={},t=0,e=r.length;e>t;t+=1){var o=r[t];this.variable_offset[o]=this.nameset_offset;var a=this._normalizeVariableValue(n,o);if(this.name.strings["suppress-min"]&&a.length>=this.name.strings["suppress-min"]&&(a=[]),this.name.strings["suppress-max"]&&a.length<=this.name.strings["suppress-max"]&&(a=[]),this._getFreeters(o,a),this._getPersonsAndInstitutions(o,a),0===this.name.strings["suppress-min"])for(this.freeters[o]=[],i=0,s=this.persons[o].length;s>i;i+=1)this.persons[o][i]=[];else if(0===this.institution.strings["suppress-min"]){for(this.institutions[o]=[],this.freeters[o]=this.freeters[o].concat(this.persons[o]),i=0,s=this.persons[o].length;s>i;i+=1)for(var l=0,c=this.persons[o][i].length;c>l;l+=1)this.freeters[o].push(this.persons[o][i][l]);this.persons[o]=[]}}},n.NameOutput.prototype._normalizeVariableValue=function(t,e){var i;return i="string"==typeof t[e]?[{literal:t[e]}]:t[e]?t[e].slice():[]},n.NameOutput.prototype._getFreeters=function(t,e){this.freeters[t]=[];for(var i=e.length-1;i>-1&&this.isPerson(e[i]);i+=-1){var s=this._checkNickname(e.pop());s&&this.freeters[t].push(s)}this.freeters[t].reverse(),this.freeters[t].length&&(this.nameset_offset+=1)},n.NameOutput.prototype._getPersonsAndInstitutions=function(t,e){this.persons[t]=[],this.institutions[t]=[];for(var i=[],s=!1,n=!0,r=e.length-1;r>-1;r+=-1)if(this.isPerson(e[r])){var o=this._checkNickname(e[r]);o&&i.push(o)}else s=!0,this.institutions[t].push(e[r]),n||(i.reverse(),this.persons[t].push(i),i=[]),n=!1;s&&(i.reverse(),this.persons[t].push(i),this.persons[t].reverse(),this.institutions[t].reverse())},n.NameOutput.prototype._clearValues=function(t){for(var e=t.length-1;e>-1;e+=-1)t.pop()},n.NameOutput.prototype._checkNickname=function(t){if(["interview","personal_communication"].indexOf(this.Item.type)>-1){var e="";if(e=n.Util.Names.getRawName(t),e&&this.state.sys.getAbbreviation&&(!this.item||!this.item["suppress-author"])){this.state.transform.loadAbbreviation("default","nickname",e);var i=this.state.transform.abbrevs["default"].nickname[e];i&&(t="!here>>>"===i?!1:{family:i,given:""})}}return t},n.NameOutput.prototype.joinPersons=function(t,e,i){var s;return s="undefined"==typeof i?1===this.etal_spec[e].freeters?this._joinEtAl(t,"name"):2===this.etal_spec[e].freeters?this._joinEllipsis(t,"name"):this.state.tmp.sort_key_flag?this._join(t," "):this._joinAnd(t,"name"):1===this.etal_spec[e].persons[i]?this._joinEtAl(t,"name"):2===this.etal_spec[e].persons[i]?this._joinEllipsis(t,"name"):this.state.tmp.sort_key_flag?this._join(t," "):this._joinAnd(t,"name")},n.NameOutput.prototype.joinInstitutionSets=function(t,e){var i;return i=1===this.etal_spec[e].institutions?this._joinEtAl(t,"institution"):2===this.etal_spec[e].institutions?this._joinEllipsis(t,"institution"):this._joinAnd(t,"institution")},n.NameOutput.prototype.joinPersonsAndInstitutions=function(t){return this._join(t,this.name.strings.delimiter)},n.NameOutput.prototype.joinFreetersAndInstitutionSets=function(t){var e=this._join(t,"[never here]",this["with"].single,this["with"].multiple);return e},n.NameOutput.prototype._joinEtAl=function(t,e){var i=this._join(t,this.name.strings.delimiter);return this.state.output.openLevel(this._getToken(e)),this.state.output.current.value().strings.delimiter="",this.state.output.append(i,"literal",!0),t.length>1?this.state.output.append(this["et-al"].multiple,"literal",!0):1===t.length&&this.state.output.append(this["et-al"].single,"literal",!0),this.state.output.closeLevel(),this.state.output.pop()},n.NameOutput.prototype._joinEllipsis=function(t,e){return this._join(t,this.name.strings.delimiter,this.name.ellipsis.single,this.name.ellipsis.multiple,e)},n.NameOutput.prototype._joinAnd=function(t,e){return this._join(t,this[e].strings.delimiter,this[e].and.single,this[e].and.multiple,e)},n.NameOutput.prototype._join=function(t,e,i,s,r){var o,a;if(!t)return!1;for(o=t.length-1;o>-1;o+=-1)t[o]&&0!==t[o].length&&t[o].blobs.length||(t=t.slice(0,o).concat(t.slice(o+1)));if(!t.length)return!1;if(i&&2===t.length)i&&(i=new n.Blob(i.blobs,i)),t=[t[0],i,t[1]];else{var l;for(l=s?2:1,o=0,a=t.length-l;a>o;o+=1)t[o].strings.suffix+=e;if(t.length>1){var c=t.pop();s?(s=new n.Blob(s.blobs,s),t.push(s)):(i&&(i=new n.Blob(i.blobs,i)),t.push(i)),t.push(c)}}for(this.state.output.openLevel(this._getToken(r)),i&&s&&(this.state.output.current.value().strings.delimiter=""),o=0,a=t.length;a>o;o+=1)this.state.output.append(t[o],!1,!0);return this.state.output.closeLevel(),this.state.output.pop()},n.NameOutput.prototype._getToken=function(t){var e=this[t];if("institution"===t){var i=new n.Token;return i}return e},n.NameOutput.prototype.setCommonTerm=function(){var t=this.variables,e=t.slice();if(e.sort(),this.common_term=e.join(""),!this.common_term)return!1;var i=!1;if(this.label&&this.label[this.variables[0]]&&(this.label[this.variables[0]].before?i=this.state.getTerm(this.common_term,this.label[this.variables[0]].before.strings.form,0):this.label[this.variables[0]].after&&(i=this.state.getTerm(this.common_term,this.label[this.variables[0]].after.strings.form,0))),!this.state.locale[this.state.opt.lang].terms[this.common_term]||!i||this.variables.length<2)return void(this.common_term=!1);for(var s=0,n=0,r=this.variables.length-1;r>n;n+=1){var o=this.variables[n],a=this.variables[n+1];if(this.freeters[o].length||this.freeters[a].length){if(this.etal_spec[o].freeters!==this.etal_spec[a].freeters||!this._compareNamesets(this.freeters[o],this.freeters[a]))return void(this.common_term=!1);s+=1}if(this.persons[o].length!==this.persons[a].length)return void(this.common_term=!1);for(var l=0,c=this.persons[o].length;c>l;l+=1)if(this.etal_spec[o].persons[l]!==this.etal_spec[a].persons[l]||!this._compareNamesets(this.persons[o][l],this.persons[a][l]))return void(this.common_term=!1)}},n.NameOutput.prototype._compareNamesets=function(t,e){if(t.length!==e.length)return!1;for(var i=0,s=e.length;s>i;i+=1)for(var r=(e[i],0),o=n.NAME_PARTS.length;o>r;r+=1){var a=n.NAME_PARTS[r];if(!t[i]||t[i][a]!=e[i][a])return!1}return!0},n.NameOutput.prototype.constrainNames=function(){this.names_count=0;for(var t,e=0,i=this.variables.length;i>e;e+=1){var s=this.variables[e];t=this.nameset_base+e,this.freeters[s].length&&(this.state.tmp.names_max.push(this.freeters[s].length,"literal"),this._imposeNameConstraints(this.freeters,this.freeters_count,s,t),this.names_count+=this.freeters[s].length),this.institutions[s].length&&(this.state.tmp.names_max.push(this.institutions[s].length,"literal"),this._imposeNameConstraints(this.institutions,this.institutions_count,s,t),this.persons[s]=this.persons[s].slice(0,this.institutions[s].length),this.names_count+=this.institutions[s].length);for(var n=0,r=this.persons[s].length;r>n;n+=1)this.persons[s][n].length&&(this.state.tmp.names_max.push(this.persons[s][n].length,"literal"),this._imposeNameConstraints(this.persons[s],this.persons_count[s],n,t),this.names_count+=this.persons[s][n].length)}},n.NameOutput.prototype._imposeNameConstraints=function(t,e,i,s){var n=t[i],r=this.state.tmp["et-al-min"];this.state.tmp.suppress_decorations?this.state.tmp.disambig_request&&this.state.tmp.disambig_request.names[s]?r=this.state.tmp.disambig_request.names[s]:e[i]>=this.etal_min&&(r=this.etal_use_first):(this.state.tmp.disambig_request&&this.state.tmp.disambig_request.names[s]>this.etal_use_first?r=e[i]<this.etal_min?e[i]:this.state.tmp.disambig_request.names[s]:e[i]>=this.etal_min&&(r=this.etal_use_first),this.etal_use_last&&r>this.etal_min-2&&(r=this.etal_min-2));var o=this.etal_min>=this.etal_use_first,a=e[i]>r;r>e[i]&&(r=n.length),o&&a&&(this.etal_use_last?t[i]=n.slice(0,r).concat(n.slice(-1)):t[i]=n.slice(0,r)),this.state.tmp.disambig_settings.names[s]=t[i].length,this.state.disambiguate.padBase(this.state.tmp.disambig_settings)},n.NameOutput.prototype.disambigNames=function(){for(var t,e=0,i=this.variables.length;i>e;e+=1){var s=this.variables[e];if(t=this.nameset_base+e,this.freeters[s].length&&this._runDisambigNames(this.freeters[s],t),this.institutions[s].length){"undefined"==typeof this.state.tmp.disambig_settings.givens[t]&&(this.state.tmp.disambig_settings.givens[t]=[]);for(var n=0,r=this.institutions[s].length;r>n;n+=1)"undefined"==typeof this.state.tmp.disambig_settings.givens[t][n]&&this.state.tmp.disambig_settings.givens[t].push(2)}for(var n=0,r=this.persons[s].length;r>n;n+=1)this.persons[s][n].length&&this._runDisambigNames(this.persons[s][n],t)}},n.NameOutput.prototype._runDisambigNames=function(t,e){var i,s,r,o,a,l,c;for(a=0,l=t.length;l>a;a+=1)if(t[a].given||t[a].family){if(r=this.name.strings["initialize-with"],this.state.registry.namereg.addname(""+this.Item.id,t[a],a),i=this.state.tmp.disambig_settings.givens[e],"undefined"==typeof i)for(var u=0,h=e+1;h>u;u+=1)this.state.tmp.disambig_settings.givens[u]||(this.state.tmp.disambig_settings.givens[u]=[]);if(i=this.state.tmp.disambig_settings.givens[e][a],"undefined"==typeof i&&(s=this.name.strings.form,o=this.state.registry.namereg.evalname(""+this.Item.id,t[a],a,0,s,r),this.state.tmp.disambig_settings.givens[e].push(o)),s=this.name.strings.form,c=this.state.registry.namereg.evalname(""+this.Item.id,t[a],a,0,s,r),this.state.tmp.disambig_request){var p=this.state.tmp.disambig_settings.givens[e][a];1!==p||"by-cite"!==this.state.citation.opt["givenname-disambiguation-rule"]||"undefined"!=typeof this.name.strings["initialize-with"]&&"undefined"!=typeof t[a].given||(p=2),o=p,this.state.opt["disambiguate-add-givenname"]&&t[a].given&&(o=this.state.registry.namereg.evalname(""+this.Item.id,t[a],a,o,this.name.strings.form,this.name.strings["initialize-with"]))}else o=c;!this.state.tmp.just_looking&&this.item&&this.item.position===n.POSITION_FIRST&&c>o&&(o=c),this.state.tmp.sort_key_flag||(this.state.tmp.disambig_settings.givens[e][a]=o,"string"!=typeof r||"undefined"!=typeof this.name.strings.initialize&&!0!==this.name.strings.initialize||(this.state.tmp.disambig_settings.use_initials=!0))}},n.NameOutput.prototype.getEtAlConfig=function(){var t=this.item;this["et-al"]={},this.state.output.append(this.etal_term,this.etal_style,!0),this["et-al"].single=this.state.output.pop(),this["et-al"].single.strings.suffix=this.etal_suffix,this["et-al"].single.strings.prefix=this.etal_prefix_single,this.state.output.append(this.etal_term,this.etal_style,!0),this["et-al"].multiple=this.state.output.pop(),this["et-al"].multiple.strings.suffix=this.etal_suffix,this["et-al"].multiple.strings.prefix=this.etal_prefix_multiple,"undefined"==typeof t&&(t={}),t.position?(this.name.strings["et-al-subsequent-min"]?this.etal_min=this.name.strings["et-al-subsequent-min"]:this.etal_min=this.name.strings["et-al-min"],this.name.strings["et-al-subsequent-use-first"]?this.etal_use_first=this.name.strings["et-al-subsequent-use-first"]:this.etal_use_first=this.name.strings["et-al-use-first"]):(this.state.tmp["et-al-min"]?this.etal_min=this.state.tmp["et-al-min"]:this.etal_min=this.name.strings["et-al-min"],this.state.tmp["et-al-use-first"]?this.etal_use_first=this.state.tmp["et-al-use-first"]:this.etal_use_first=this.name.strings["et-al-use-first"],"boolean"==typeof this.state.tmp["et-al-use-last"]?this.etal_use_last=this.state.tmp["et-al-use-last"]:this.etal_use_last=this.name.strings["et-al-use-last"]),this.state.tmp["et-al-min"]||(this.state.tmp["et-al-min"]=this.etal_min)},n.NameOutput.prototype.setEtAlParameters=function(){var t,e,i,s;for(t=0,e=this.variables.length;e>t;t+=1){var n=this.variables[t];for("undefined"==typeof this.etal_spec[n]&&(this.etal_spec[n]={freeters:0,institutions:0,persons:[]}),this.etal_spec[this.nameset_base+t]=this.etal_spec[n],this.freeters[n].length&&this._setEtAlParameter("freeters",n),i=0,s=this.persons[n].length;s>i;i+=1)"undefined"==typeof this.etal_spec[n][i]&&(this.etal_spec[n].persons[i]=0),this._setEtAlParameter("persons",n,i);this.institutions[n].length&&this._setEtAlParameter("institutions",n)}},n.NameOutput.prototype._setEtAlParameter=function(t,e,i){var s,n;"persons"===t?(s=this.persons[e][i],n=this.persons_count[e][i]):(s=this[t][e],n=this[t+"_count"][e]),s.length<n&&!this.state.tmp.sort_key_flag?this.etal_use_last?"persons"===t?this.etal_spec[e].persons[i]=2:this.etal_spec[e][t]=2:"persons"===t?this.etal_spec[e].persons[i]=1:this.etal_spec[e][t]=1:"persons"===t?this.etal_spec[e].persons[i]=0:this.etal_spec[e][t]=0},n.NameOutput.prototype.renderAllNames=function(){for(var t,e=0,i=this.variables.length;i>e;e+=1){var s=this.variables[e];t=this.nameset_base+e,this.freeters[s].length&&(this.freeters[s]=this._renderPersonalNames(this.freeters[s],t));for(var n=0,r=this.institutions[s].length;r>n;n+=1)this.persons[s][n]=this._renderPersonalNames(this.persons[s][n],t,n)}this.renderInstitutionNames()},n.NameOutput.prototype.renderInstitutionNames=function(){for(var t=0,e=this.variables.length;e>t;t+=1)for(var i=this.variables[t],s=0,n=this.institutions[i].length;n>s;s+=1){var r,o,a,l,c,s,n,u,h=this.institutions[i][s];if(u=this.state.tmp.extension?["sort"]:h.isInstitution?this.state.opt["cite-lang-prefs"].institutions:this.state.opt["cite-lang-prefs"].persons,slot={primary:"locale-orig",secondary:!1,tertiary:!1},u)for(var p=["primary","secondary","tertiary"],f=0,d=p.length;d>f&&!(u.length-1<f);f+=1)u[f]&&(slot[p[f]]="locale-"+u[f]);else slot.primary="locale-translat";"bibliography"===this.state.tmp.area||"citation"===this.state.tmp.area&&"note"===this.state.opt.xclass&&this.item&&!this.item.position||(slot.secondary=!1,slot.tertiary=!1);var m;this.setRenderedName(h),m=this.getName(h,slot.primary,!0);var g=m.name,b=m.usedOrig;switch(g&&(g=this.fixupInstitution(g,i,s)),secondary=!1,slot.secondary&&(m=this.getName(h,slot.secondary,!1,b),secondary=m.name,b=m.usedOrig,secondary&&(secondary=this.fixupInstitution(secondary,i,s))),tertiary=!1,slot.tertiary&&(m=this.getName(h,slot.tertiary,!1,b),tertiary=m.name,tertiary&&(tertiary=this.fixupInstitution(tertiary,i,s))),this.institution.strings["institution-parts"]){case"short":g["short"].length?(l=this._getShortStyle(),r=[this._renderOneInstitutionPart(g["short"],l)]):(c=this._getLongStyle(g,i,s),r=[this._renderOneInstitutionPart(g["long"],c)]);break;case"short-long":c=this._getLongStyle(g,i,s),l=this._getShortStyle(),
o=this._renderOneInstitutionPart(g["short"],l),a=this._composeOneInstitutionPart([g,secondary,tertiary],slot,c),r=[o,a];break;case"long-short":c=this._getLongStyle(g,i,s),l=this._getShortStyle(),o=this._renderOneInstitutionPart(g["short"],l),a=this._composeOneInstitutionPart([g,secondary,tertiary],slot,c,!0),r=[a,o];break;default:c=this._getLongStyle(g,i,s),r=[this._composeOneInstitutionPart([g,secondary,tertiary],slot,c)]}this.institutions[i][s]=this._join(r,"")}},n.NameOutput.prototype._composeOneInstitutionPart=function(t,e,i){var s=!1,r=!1,o=!1;t[0]&&(s=this._renderOneInstitutionPart(t[0]["long"],i)),t[1]&&(r=this._renderOneInstitutionPart(t[1]["long"],i)),t[2]&&(o=this._renderOneInstitutionPart(t[2]["long"],i));var a;return r||o?(this.state.output.openLevel("empty"),this.state.output.append(s),secondary_tok=n.Util.cloneToken(i),e.secondary&&(secondary_tok.strings.prefix=this.state.opt.citeAffixes.institutions[e.secondary].prefix,secondary_tok.strings.suffix=this.state.opt.citeAffixes.institutions[e.secondary].suffix,secondary_tok.strings.prefix||(secondary_tok.strings.prefix=" ")),this.state.output.append(r,secondary_tok),tertiary_tok=n.Util.cloneToken(i),e.tertiary&&(tertiary_tok.strings.prefix=this.state.opt.citeAffixes.institutions[e.tertiary].prefix,tertiary_tok.strings.suffix=this.state.opt.citeAffixes.institutions[e.tertiary].suffix,tertiary_tok.strings.prefix||(tertiary_tok.strings.prefix=" ")),this.state.output.append(o,tertiary_tok),this.state.output.closeLevel(),a=this.state.output.pop()):a=s,a},n.NameOutput.prototype._renderOneInstitutionPart=function(t,e){for(var i=0,s=t.length;s>i;i+=1)if(t[i]){var r=t[i];if(this.state.tmp.strip_periods)r=r.replace(/\./g,"");else for(var o=0,a=e.decorations.length;a>o;o+=1)if("@strip-periods"===e.decorations[o][0]&&"true"===e.decorations[o][1]){r=r.replace(/\./g,"");break}this.state.tmp.group_context.value()[2]=!0,this.state.tmp.can_substitute.replace(!1,n.LITERAL),"!here>>>"===r?t[i]=!1:(this.state.output.append(r,e,!0),t[i]=this.state.output.pop())}return"undefined"==typeof this.institution.strings["part-separator"]&&(this.institution.strings["part-separator"]=this.name.strings.delimiter),this._join(t,this.institution.strings["part-separator"])},n.NameOutput.prototype._renderPersonalNames=function(t,e,i){var s=!1;if(t.length){for(var r=[],o=0,a=t.length;a>o;o+=1){var s,l,c=t[o];if(l=this.state.tmp.extension?["sort"]:c.isInstitution?this.state.opt["cite-lang-prefs"].institutions:this.state.opt["cite-lang-prefs"].persons,slot={primary:"locale-orig",secondary:!1,tertiary:!1},l)for(var u=["primary","secondary","tertiary"],h=0,p=u.length;p>h&&!(l.length-1<h);h+=1)slot[u[h]]="locale-"+l[h];else slot.primary="locale-translat";(this.state.tmp.sort_key_flag||"bibliography"!==this.state.tmp.area&&("citation"!==this.state.tmp.area||"note"!==this.state.opt.xclass||!this.item||this.item.position))&&(slot.secondary=!1,slot.tertiary=!1),this.setRenderedName(c);var f=this.getName(c,slot.primary,!0),d=this._renderOnePersonalName(f.name,e,o,i);secondary=!1,slot.secondary&&(f=this.getName(c,slot.secondary,!1,f.usedOrig),f.name&&(secondary=this._renderOnePersonalName(f.name,e,o,i))),tertiary=!1,slot.tertiary&&(f=this.getName(c,slot.tertiary,!1,f.usedOrig),f.name&&(tertiary=this._renderOnePersonalName(f.name,e,o,i)));var m;secondary||tertiary?(this.state.output.openLevel("empty"),this.state.output.append(d),secondary_tok=new n.Token,slot.secondary&&(secondary_tok.strings.prefix=this.state.opt.citeAffixes.persons[slot.secondary].prefix,secondary_tok.strings.suffix=this.state.opt.citeAffixes.persons[slot.secondary].suffix,secondary_tok.strings.prefix||(secondary_tok.strings.prefix=" ")),this.state.output.append(secondary,secondary_tok),tertiary_tok=new n.Token,slot.tertiary&&(tertiary_tok.strings.prefix=this.state.opt.citeAffixes.persons[slot.tertiary].prefix,tertiary_tok.strings.suffix=this.state.opt.citeAffixes.persons[slot.tertiary].suffix,tertiary_tok.strings.prefix||(tertiary_tok.strings.prefix=" ")),this.state.output.append(tertiary,tertiary_tok),this.state.output.closeLevel(),m=this.state.output.pop()):m=d,r.push(m)}s=this.joinPersons(r,e,i)}return s},n.NameOutput.prototype._isRomanesque=function(t){var e=2;if(t.family.replace('"',"","g").match(n.ROMANESQUE_REGEXP)||(e=0),!e&&t.given&&t.given.match(n.STARTSWITH_ROMANESQUE_REGEXP)&&(e=1),2==e){if(t.multi&&t.multi.main)var i=t.multi.main.slice(0,2);else this.Item.language&&(i=this.Item.language.slice(0,2));["ja","zh"].indexOf(i)>-1&&(e=1)}return e},n.NameOutput.prototype._renderOnePersonalName=function(t,e,i,s){var r=t,o=this._droppingParticle(r,e,s),a=this._familyName(r),l=this._nonDroppingParticle(r),c=this._givenName(r,e,i),u=this._nameSuffix(r);this._isShort(e,i)&&!r["full-form-always"]&&(o=!1,c=!1,u=!1);var h=this.name.strings["sort-separator"];h||(h="");var p;p=r["comma-suffix"]?", ":" ";var f,d,m,g,b=this._isRomanesque(r),v=l&&"-"===l.blobs.slice(-1);return 0===b?f=this._join([l,a,c],""):1===b||r["static-ordering"]?f=this._join([l,a,c]," "):r["reverse-ordering"]?f=this._join([c,l,a]," "):this.state.tmp.sort_key_flag?"never"===this.state.opt["demote-non-dropping-particle"]?(m=this._join([l,a,o]," "),d=this._join([m,c]," "),f=this._join([d,u]," ")):(g=this._join([c,o,l]," "),d=this._join([a,g]," "),f=this._join([d,u]," ")):"all"===this.name.strings["name-as-sort-order"]||"first"===this.name.strings["name-as-sort-order"]&&0===i&&(0===s||"undefined"==typeof s)?(["Lord","Lady"].indexOf(r.given)>-1&&(h=", "),["always","display-and-sort"].indexOf(this.state.opt["demote-non-dropping-particle"])>-1&&!v?(g=this._join([c,o],r["comma-dropping-particle"]+" "),g=this._join([g,l]," "),g&&this.given&&(g.strings.prefix=this.given.strings.prefix,g.strings.suffix=this.given.strings.suffix),a&&this.family&&(a.strings.prefix=this.family.strings.prefix,a.strings.suffix=this.family.strings.suffix),d=this._join([a,g],h),f=this._join([d,u],h)):("bibliography"===this.state.tmp.area&&!this.state.tmp.term_predecessor&&l&&(v||(l.blobs=n.Output.Formatters["capitalize-first"](this.state,l.blobs))),m=v?this._join([l,a],""):this._join([l,a]," "),m&&this.family&&(m.strings.prefix=this.family.strings.prefix,m.strings.suffix=this.family.strings.suffix),g=this._join([c,o],r["comma-dropping-particle"]+" "),g&&this.given&&(g.strings.prefix=this.given.strings.prefix,g.strings.suffix=this.given.strings.suffix),d=this._join([m,g],h),f=this._join([d,u],h))):(r["dropping-particle"]&&r.family&&!r["non-dropping-particle"]&&["'","ʼ","’"].indexOf(r["dropping-particle"].slice(-1))>-1&&(a=this._join([o,a],""),o=!1),this.state.tmp.term_predecessor||c||"bibliography"!==this.state.tmp.area||(!o&&l?v||(l.blobs=n.Output.Formatters["capitalize-first"](this.state,l.blobs)):o&&(o.blobs=n.Output.Formatters["capitalize-first"](this.state,o.blobs))),v?(g=this._join([l,a],""),g=this._join([o,g]," ")):g=this._join([o,l,a]," "),g=this._join([g,u],p),g&&this.family&&(g.strings.prefix=this.family.strings.prefix,g.strings.suffix=this.family.strings.suffix),c&&this.given&&(c.strings.prefix=this.given.strings.prefix,c.strings.suffix=this.given.strings.suffix),g.strings.prefix&&(r["comma-dropping-particle"]=""),f=this._join([c,g],r["comma-dropping-particle"]+" ")),this.state.tmp.group_context.value()[2]=!0,this.state.tmp.can_substitute.replace(!1,n.LITERAL),this.state.tmp.term_predecessor=!0,this.state.tmp.name_node.children.push(f),f},n.NameOutput.prototype._isShort=function(t,e){return 0===this.state.tmp.disambig_settings.givens[t][e]?!0:!1},n.NameOutput.prototype._normalizeNameInput=function(t){var e={literal:t.literal,family:t.family,isInstitution:t.isInstitution,given:t.given,suffix:t.suffix,"comma-suffix":t["comma-suffix"],"non-dropping-particle":t["non-dropping-particle"],"dropping-particle":t["dropping-particle"],"static-ordering":t["static-ordering"],"reverse-ordering":t["reverse-ordering"],"full-form-always":t["full-form-always"],"parse-names":t["parse-names"],"comma-dropping-particle":"",block_initialize:t.block_initialize,multi:t.multi};return this._parseName(e),e},n.NameOutput.prototype._stripPeriods=function(t,e){var i=this[t+"_decor"];if(e)if(this.state.tmp.strip_periods)e=e.replace(/\./g,"");else if(i)for(var s=0,n=i.decorations.length;n>s;s+=1)if("@strip-periods"===i.decorations[s][0]&&"true"===i.decorations[s][1]){e=e.replace(/\./g,"");break}return e},n.NameOutput.prototype._nonDroppingParticle=function(t){var e=t["non-dropping-particle"];e&&this.state.tmp.sort_key_flag&&(e=e.replace(/[\'\u2019]/,""));var i=this._stripPeriods("family",e);return this.state.output.append(i,this.family_decor,!0)?this.state.output.pop():!1},n.NameOutput.prototype._droppingParticle=function(t,e,i){var s=t["dropping-particle"];s&&this.state.tmp.sort_key_flag&&(s=s.replace(/[\'\u2019]/,""));var n=this._stripPeriods("given",s);if(t["dropping-particle"]&&t["dropping-particle"].match(/^et.?al[^a-z]$/))this.name.strings["et-al-use-last"]?"undefined"==typeof i?this.etal_spec[e].freeters=2:this.etal_spec[e].persons=2:"undefined"==typeof i?this.etal_spec[e].freeters=1:this.etal_spec[e].persons=1,t["comma-dropping-particle"]="";else if(this.state.output.append(n,this.given_decor,!0))return this.state.output.pop();return!1},n.NameOutput.prototype._familyName=function(t){var e=this._stripPeriods("family",t.family);return this.state.output.append(e,this.family_decor,!0)?this.state.output.pop():!1},n.NameOutput.prototype._givenName=function(t,e,i){if(this.name.strings.initialize===!1)t.family&&t.given&&this.name.strings.initialize===!1&&(t.given=n.Util.Names.initializeWith(this.state,t.given,this.name.strings["initialize-with"],!0)),t.given=n.Util.Names.unInitialize(this.state,t.given);else if(t.family&&1===this.state.tmp.disambig_settings.givens[e][i]&&!t.block_initialize){var s=this.name.strings["initialize-with"];t.given=n.Util.Names.initializeWith(this.state,t.given,s)}else t.given=n.Util.Names.unInitialize(this.state,t.given);var r=this._stripPeriods("given",t.given);return this.state.output.append(r,this.given_decor,!0)?this.state.output.pop():!1},n.NameOutput.prototype._nameSuffix=function(t){var e=t.suffix;return"string"==typeof this.name.strings["initialize-with"]&&(e=n.Util.Names.initializeWith(this.state,t.suffix,this.name.strings["initialize-with"],!0)),e=this._stripPeriods("family",e),this.state.output.append(e,"empty",!0)?this.state.output.pop():!1},n.NameOutput.prototype._getLongStyle=function(t,e,i){var s;return s=t["short"].length&&this.institutionpart["long-with-short"]?this.institutionpart["long-with-short"]:this.institutionpart["long"],s||(s=new n.Token),s},n.NameOutput.prototype._getShortStyle=function(){var t;return t=this.institutionpart["short"]?this.institutionpart["short"]:new n.Token},n.NameOutput.prototype._parseName=function(t){var e,i;if(!t["parse-names"]&&"undefined"!=typeof t["parse-names"])return t;t.family&&!t.given&&t.isInstitution&&(t.literal=t.family,t.family=void 0,t.isInstitution=void 0);var s;if(t.family&&'"'===t.family.slice(0,1)&&'"'===t.family.slice(-1)||!t["parse-names"]&&"undefined"!=typeof t["parse-names"]?(t.family=t.family.slice(1,-1),s=!0,t["parse-names"]=0):s=!1,!t["non-dropping-particle"]&&t.family&&!s&&t.given&&(e=t.family.match(/^((?:[\'\u2019a-z][ \'\u2019a-z]*[-\s\'\u2019]+|[ABDVL][^ ][-\s]+[a-z]*\s*|[ABDVL][^ ][^ ][-\s]+[a-z]*\s*))/),e&&(t.family=t.family.slice(e[1].length),t["non-dropping-particle"]=e[1].replace(/\s+$/,"").replace("'","’"))),!t.suffix&&t.given&&(e=t.given.match(/(\s*,!*\s*)/))){i=t.given.indexOf(e[1]);var n=t.given.slice(i+e[1].length),r=t.given.slice(i,i+e[1].length).replace(/\s*/g,"");n.length<=3?(2===r.length&&(t["comma-suffix"]=!0),t.suffix=n):!t["dropping-particle"]&&t.given&&(t["dropping-particle"]=n,t["comma-dropping-particle"]=","),t.given=t.given.slice(0,i)}!t["dropping-particle"]&&t.given&&(e=t.given.match(/(\s+)([a-z][ \'\u2019a-z]*)$/),e&&(t.given=t.given.slice(0,-1*(e[1].length+e[2].length)),t["dropping-particle"]=e[2]))},n.NameOutput.prototype.getName=function(t,e,s,n){if(n&&"locale-orig"===e)return{name:!1,usedOrig:n};t.family||(t.family=""),t.given||(t.given="");var r={};r["static-ordering"]=this.getStaticOrder(t);var o=!0;if("locale-orig"!==e&&(o=!1,t.multi)){var a=this.state.opt[e];for(i=0,ilen=a.length;i<ilen;i+=1)if(l=a[i],t.multi._key[l]){o=!0,t=t.multi._key[l],r=this.getNameParams(l),r.transliterated=!0;break}}if(!o){var l=!1;t.multi&&t.multi.main?l=t.multi.main:this.Item.language&&(l=this.Item.language),l&&(r=this.getNameParams(l))}if(!s&&!o)return{name:!1,usedOrig:n};t.family||(t.family=""),t.given||(t.given=""),t={family:t.family,given:t.given,"non-dropping-particle":t["non-dropping-particle"],"dropping-particle":t["dropping-particle"],suffix:t.suffix,"static-ordering":r["static-ordering"],"reverse-ordering":r["reverse-ordering"],"full-form-always":r["full-form-always"],"parse-names":t["parse-names"],"comma-suffix":t["comma-suffix"],"comma-dropping-particle":t["comma-dropping-particle"],transliterated:r.transliterated,block_initialize:r["block-initialize"],literal:t.literal,isInstitution:t.isInstitution,multi:t.multi},!t.literal&&!t.given&&t.family&&t.isInstitution&&(t.literal=t.family),t.literal&&(delete t.family,delete t.given),t=this._normalizeNameInput(t);var c;return c=n?n:!o,{name:t,usedOrig:c}},n.NameOutput.prototype.getNameParams=function(t){var e={},i=n.localeResolve(this.Item.language,this.state.opt["default-locale"][0]),s=this.state.locale[i.best]?i.best:this.state.opt["default-locale"][0],r=this.state.locale[s].opts["name-as-sort-order"],o=this.state.locale[s].opts["name-as-reverse-order"],a=this.state.locale[s].opts["name-never-short"],l=t.split("-")[0];return r&&r[l]&&(e["static-ordering"]=!0,e["reverse-ordering"]=!1),o&&o[l]&&(e["reverse-ordering"]=!0,e["static-ordering"]=!1),a&&a[l]&&(e["full-form-always"]=!0),e["static-ordering"]&&(e["block-initialize"]=!0),e},n.NameOutput.prototype.setRenderedName=function(t){if("bibliography"===this.state.tmp.area){for(var e="",i=0,s=n.NAME_PARTS.length;s>i;i+=1)t[n.NAME_PARTS[i]]&&(e+=t[n.NAME_PARTS[i]]);this.state.tmp.rendered_name.push(e)}},n.NameOutput.prototype.fixupInstitution=function(t,e,i){t=this._splitInstitution(t,e,i),this.institution.strings["reverse-order"]&&t["long"].reverse();var s=t["long"],n=s.slice();if(this.state.sys.getAbbreviation)for(var r=this.Item.jurisdiction,o=0,a=s.length;a>o;o+=1)r=this.state.transform.loadAbbreviation(r,"institution-part",s[o]),this.state.transform.abbrevs[r]["institution-part"][s[o]]&&(n[o]=this.state.transform.abbrevs[r]["institution-part"][s[o]]);return t["short"]=n,t},n.NameOutput.prototype.getStaticOrder=function(t,e){var i=!1;return!e&&t["static-ordering"]?i=!0:0===this._isRomanesque(t)?i=!0:(!t.multi||!t.multi.main)&&this.Item.language&&["vi","hu"].indexOf(this.Item.language)>-1?i=!0:t.multi&&t.multi.main&&["vi","hu"].indexOf(t.multi.main.slice(0,2))>-1?i=!0:this.state.opt["auto-vietnamese-names"]&&n.VIETNAMESE_NAMES.exec(t.family+" "+t.given)&&n.VIETNAMESE_SPECIALS.exec(t.family+t.given)&&(i=!0),i},n.NameOutput.prototype._splitInstitution=function(t,e,i){var s={},n=t.literal.replace(/\s*\|\s*/g,"|");if(n=n.split("|"),"short"===this.institution.strings.form&&this.state.sys.getAbbreviation)for(var r=this.Item.jurisdiction,o=n.length;o>0;o+=-1){var a=n.slice(0,o).join("|");if(r=this.state.transform.loadAbbreviation(r,"institution-entire",a),this.state.transform.abbrevs[r]["institution-entire"][a]){var l=this.state.transform.abbrevs[r]["institution-entire"][a];l=this.state.transform.quashCheck(l);var c=l.split(/>>[0-9]{4}>>/),u=l.match(/>>([0-9]{4})>>/);if(l=c.pop(),c.length>0&&this.Item["original-date"]&&this.Item["original-date"].year)for(var h=u.length-1;h>0&&!(parseInt(this.Item["original-date"].year,10)>=parseInt(u[h],10));h+=-1)l=c.pop();l=l.replace(/\s*\|\s*/g,"|"),n=[l]}}return n.reverse(),s["long"]=this._trimInstitution(n,e,i),s},n.NameOutput.prototype._trimInstitution=function(t,e,i){var s=!1,n=!1,r=!1,o=t.slice();return this.institution&&("undefined"!=typeof this.institution.strings["use-first"]&&(s=this.institution.strings["use-first"]),"undefined"!=typeof this.institution.strings["stop-last"]&&(o=o.slice(0,this.institution.strings["stop-last"]),t=t.slice(0,this.institution.strings["stop-last"])),"undefined"!=typeof this.institution.strings["use-last"]&&(n=this.institution.strings["use-last"])),!1===s&&(0===this.persons[e].length&&(s=this.institution.strings["substitute-use-first"]),s||(s=0)),!1===n&&(n=s?0:t.length),s>t.length-n&&(s=t.length-n),r&&(n=0),t=t.slice(0,s),o=o.slice(s),n&&(n>o.length&&(n=o.length),n&&(t=t.concat(o.slice(o.length-n)))),t},n.PublisherOutput=function(t,e){this.state=t,this.group_tok=e,this.varlist=[]},n.PublisherOutput.prototype.render=function(){this.clearVars(),this.composeAndBlob(),this.composeElements(),this.composePublishers(),this.joinPublishers()},n.PublisherOutput.prototype.composeAndBlob=function(){this.and_blob={};var t=!1;"text"===this.group_tok.strings.and?t=this.state.getTerm("and"):"symbol"===this.group_tok.strings.and&&(t="&");var e=new n.Token;e.strings.suffix=" ",e.strings.prefix=" ",this.state.output.append(t,e,!0);var i=this.state.output.pop();e.strings.prefix=this.group_tok.strings["subgroup-delimiter"],this.state.output.append(t,e,!0);var s=this.state.output.pop();this.and_blob.single=!1,this.and_blob.multiple=!1,t&&("always"===this.group_tok.strings["subgroup-delimiter-precedes-last"]?this.and_blob.single=s:"never"===this.group_tok.strings["subgroup-delimiter-precedes-last"]?(this.and_blob.single=i,this.and_blob.multiple=i):(this.and_blob.single=i,this.and_blob.multiple=s))},n.PublisherOutput.prototype.composeElements=function(){for(var t=0,e=2;e>t;t+=1)for(var i=["publisher","publisher-place"][t],s=0,n=this["publisher-list"].length;n>s;s+=1){var r=this[i+"-list"][s],o=this[i+"-token"];this.state.output.append(r,o,!0),this[i+"-list"][s]=this.state.output.pop()}},n.PublisherOutput.prototype.composePublishers=function(){for(var t,e=0,i=this["publisher-list"].length;i>e;e+=1){t=[this[this.varlist[0]+"-list"][e],this[this.varlist[1]+"-list"][e]],this["publisher-list"][e]=this._join(t,this.group_tok.strings.delimiter)}},n.PublisherOutput.prototype.joinPublishers=function(){var t=this["publisher-list"],e=(this.name_delimiter,this._join(t,this.group_tok.strings["subgroup-delimiter"],this.and_blob.single,this.and_blob.multiple,this.group_tok));this.state.output.append(e,"literal")},n.PublisherOutput.prototype._join=n.NameOutput.prototype._join,n.PublisherOutput.prototype._getToken=n.NameOutput.prototype._getToken,n.PublisherOutput.prototype.clearVars=function(){this.state.tmp["publisher-list"]=!1,this.state.tmp["publisher-place-list"]=!1,this.state.tmp["publisher-group-token"]=!1,this.state.tmp["publisher-token"]=!1,this.state.tmp["publisher-place-token"]=!1},n.evaluateLabel=function(t,e,i,s){var r;"locator"===t.strings.term?(s&&s.label&&(r="sub verbo"===s.label?"sub-verbo":s.label),r||(r="page")):r=t.strings.term;var o=t.strings.plural;return s&&"number"==typeof s.force_pluralism?o=s.force_pluralism:"number"!=typeof o&&("locator"===t.strings.term?s&&s.locator&&(e.opt.development_extensions.locator_parsing_for_plurals?(e.tmp.shadow_numbers.locator||e.processNumber(!1,s,"locator",i.type),o=e.tmp.shadow_numbers.locator.plural):o=n.evaluateStringPluralism(s.locator)):["page","page-first"].indexOf(t.variables[0])>-1?(e.processNumber(!1,i,r,i.type),o=e.tmp.shadow_numbers[r].plural,r=e.tmp.shadow_numbers[r].label):(e.tmp.shadow_numbers[r]||e.processNumber(!1,i,r,i.type),o=e.tmp.shadow_numbers[r].plural),t.decorations&&(e.opt.development_extensions.csl_reverse_lookup_support||e.sys.csl_reverse_lookup_support)&&(t.decorations.reverse(),t.decorations.push(["@showid","true",t.cslid]),t.decorations.reverse())),n.castLabel(e,t,r,o,n.TOLERANT)},n.evaluateStringPluralism=function(t){if(t){var e=t.match(/(?:[0-9],\s*[0-9]|\s+and\s+|&|([0-9]+)\s*[\-\u2013]\s*([0-9]+))/);if(e&&(!e[1]||parseInt(e[1],10)<parseInt(e[2],10)))return 1}return 0},n.castLabel=function(t,e,i,s,n){var r=e.strings.form;t.tmp.group_context.value()[5]&&(r=t.tmp.group_context.value()[5]);var o=t.getTerm(i,r,s,!1,n);if(t.tmp.strip_periods)o=o.replace(/\./g,"");else for(var a=0,l=e.decorations.length;l>a;a+=1)if("@strip-periods"===e.decorations[a][0]&&"true"===e.decorations[a][1]){o=o.replace(/\./g,"");break}return o},n.Node.name={build:function(t,e){var i;[n.SINGLETON,n.START].indexOf(this.tokentype)>-1&&(t.fixOpt(this,"name-delimiter","name_delimiter"),t.fixOpt(this,"name-form","form"),t.fixOpt(this,"and","and"),t.fixOpt(this,"delimiter-precedes-last","delimiter-precedes-last"),t.fixOpt(this,"delimiter-precedes-et-al","delimiter-precedes-et-al"),t.fixOpt(this,"initialize-with","initialize-with"),t.fixOpt(this,"initialize","initialize"),t.fixOpt(this,"name-as-sort-order","name-as-sort-order"),t.fixOpt(this,"sort-separator","sort-separator"),t.fixOpt(this,"and","and"),t.fixOpt(this,"et-al-min","et-al-min"),t.fixOpt(this,"et-al-use-first","et-al-use-first"),t.fixOpt(this,"et-al-use-last","et-al-use-last"),t.fixOpt(this,"et-al-subsequent-min","et-al-subsequent-min"),t.fixOpt(this,"et-al-subsequent-use-first","et-al-subsequent-use-first"),this.strings["et-al-subsequent-min"]&&this.strings["et-al-subsequent-min"]!==this.strings["et-al-min"]&&(t.opt.update_mode=n.POSITION),this.strings["et-al-subsequent-use-first"]&&this.strings["et-al-subsequent-use-first"]!==this.strings["et-al-use-first"]&&(t.opt.update_mode=n.POSITION),"undefined"==typeof this.strings.name_delimiter?this.strings.delimiter=", ":this.strings.delimiter=this.strings.name_delimiter,this.strings["et-al-use-last"]&&(this.ellipsis_term="…",this.ellipsis_prefix_single=" ",this.ellipsis_prefix_multiple=this.strings.delimiter,this.ellipsis_suffix=" "),i=function(t,e){t.tmp.etal_term="et-al",t.tmp.name_delimiter=this.strings.delimiter,t.tmp["delimiter-precedes-et-al"]=this.strings["delimiter-precedes-et-al"],"text"===this.strings.and?this.and_term=t.getTerm("and","long",0):"symbol"===this.strings.and&&(t.opt.development_extensions.expect_and_symbol_form?this.and_term=t.getTerm("and","symbol",0):this.and_term="&"),t.tmp.and_term=this.and_term,n.STARTSWITH_ROMANESQUE_REGEXP.test(this.and_term)?(this.and_prefix_single=" ",this.and_prefix_multiple=", ","string"==typeof this.strings.delimiter&&(this.and_prefix_multiple=this.strings.delimiter),this.and_suffix=" ",t.build.name_delimiter=this.strings.delimiter):(this.and_prefix_single="",this.and_prefix_multiple="",this.and_suffix=""),"always"===this.strings["delimiter-precedes-last"]?this.and_prefix_single=this.strings.delimiter:"never"===this.strings["delimiter-precedes-last"]?this.and_prefix_multiple&&(this.and_prefix_multiple=" "):"after-inverted-name"===this.strings["delimiter-precedes-last"]&&(this.and_prefix_single&&(this.and_prefix_single=this.strings.delimiter),this.and_prefix_multiple&&(this.and_prefix_multiple=" ")),this.and={},this.strings.and?(t.output.append(this.and_term,"empty",!0),this.and.single=t.output.pop(),this.and.single.strings.prefix=this.and_prefix_single,this.and.single.strings.suffix=this.and_suffix,t.output.append(this.and_term,"empty",!0),this.and.multiple=t.output.pop(),this.and.multiple.strings.prefix=this.and_prefix_multiple,this.and.multiple.strings.suffix=this.and_suffix):this.strings.delimiter&&(this.and.single=new n.Blob(this.strings.delimiter),this.and.single.strings.prefix="",this.and.single.strings.suffix="",this.and.multiple=new n.Blob(this.strings.delimiter),this.and.multiple.strings.prefix="",this.and.multiple.strings.suffix=""),this.ellipsis={},this.strings["et-al-use-last"]&&(this.ellipsis.single=new n.Blob(this.ellipsis_term),this.ellipsis.single.strings.prefix=this.ellipsis_prefix_single,this.ellipsis.single.strings.suffix=this.ellipsis_suffix,this.ellipsis.multiple=new n.Blob(this.ellipsis_term),this.ellipsis.multiple.strings.prefix=this.ellipsis_prefix_multiple,this.ellipsis.multiple.strings.suffix=this.ellipsis_suffix),"undefined"==typeof t.tmp["et-al-min"]&&(t.tmp["et-al-min"]=this.strings["et-al-min"]),"undefined"==typeof t.tmp["et-al-use-first"]&&(t.tmp["et-al-use-first"]=this.strings["et-al-use-first"]),"undefined"==typeof t.tmp["et-al-use-last"]&&(t.tmp["et-al-use-last"]=this.strings["et-al-use-last"]),t.nameOutput.name=this},t.build.name_flag=!0,this.execs.push(i)),e.push(this)}},n.Node["name-part"]={build:function(t,e){t.build[this.strings.name]=this}},n.Node.names={build:function(t,e){var i;if((this.tokentype===n.START||this.tokentype===n.SINGLETON)&&(n.Util.substituteStart.call(this,t,e),t.build.substitute_level.push(1),t.fixOpt(this,"names-delimiter","delimiter")),this.tokentype===n.SINGLETON){t.build.names_variables.push(this.variables);for(var s=0,r=this.variables.length;r>s;s+=1)t.build.name_label[this.variables[s]]=t.build.name_label[t.build.names_variables.slice(0)[0]];i=function(t,e,i){t.nameOutput.reinit(this)},this.execs.push(i)}if(this.tokentype===n.START&&(t.build.names_flag=!0,t.build.names_level+=1,1===t.build.names_level&&(t.build.names_variables=[],t.build.name_label={}),t.build.names_variables.push(this.variables),i=function(t,e,i){t.tmp.can_substitute.push(!0),t.parallel.StartVariable("names",this.variables[0]),t.nameOutput.init(this)},this.execs.push(i)),this.tokentype===n.END){for(var s=0,r=3;r>s;s+=1){var o=["family","given","et-al"][s];this[o]=t.build[o],1===t.build.names_level&&(t.build[o]=void 0)}this.label=t.build.name_label,1===t.build.names_level&&(t.build.name_label={}),t.build.names_level+=-1,t.build.names_variables.pop();var a="with",l="",c="";n.STARTSWITH_ROMANESQUE_REGEXP.test(a)&&(l=" ",c=" "),this["with"]={},this["with"].single=new n.Blob(a),this["with"].single.strings.suffix=c,this["with"].multiple=new n.Blob(a),this["with"].multiple.strings.suffix=c,"always"===this.strings["delimiter-precedes-last"]?(this["with"].single.strings.prefix=this.strings.delimiter,this["with"].multiple.strings.prefix=this.strings.delimiter):"contextual"===this.strings["delimiter-precedes-last"]?(this["with"].single.strings.prefix=l,this["with"].multiple.strings.prefix=this.strings.delimiter):"after-inverted-name"===this.strings["delimiter-precedes-last"]?(this["with"].single.strings.prefix=this.strings.delimiter,this["with"].multiple.strings.prefix=l):(this["with"].single.strings.prefix=l,this["with"].multiple.strings.prefix=l),i=function(t,e,i){t.tmp.etal_node?this.etal_style=t.tmp.etal_node:this.etal_style="empty",this.etal_term=t.getTerm(t.tmp.etal_term,"long",0),n.STARTSWITH_ROMANESQUE_REGEXP.test(this.etal_term)?(this.etal_prefix_single=" ",this.etal_prefix_multiple=t.tmp.name_delimiter,"always"===t.tmp["delimiter-precedes-et-al"]?this.etal_prefix_single=t.tmp.name_delimiter:"never"===t.tmp["delimiter-precedes-et-al"]?this.etal_prefix_multiple=" ":"after-inverted-name"===t.tmp["delimiter-precedes-et-al"]&&(this.etal_prefix_single=t.tmp.name_delimiter,this.etal_prefix_multiple=" "),this.etal_suffix=""):(this.etal_prefix_single="",this.etal_prefix_multiple="",this.etal_suffix="");for(var s=0,r=3;r>s;s+=1){var o=["family","given"][s];t.nameOutput[o]=this[o]}t.nameOutput["with"]=this["with"],t.nameOutput.label=this.label,t.nameOutput.etal_style=this.etal_style,t.nameOutput.etal_term=this.etal_term,t.nameOutput.etal_prefix_single=this.etal_prefix_single,t.nameOutput.etal_prefix_multiple=this.etal_prefix_multiple,t.nameOutput.etal_suffix=this.etal_suffix,t.nameOutput.outputNames(),t.tmp["et-al-use-first"]=void 0,t.tmp["et-al-min"]=void 0,t.tmp["et-al-use-last"]=void 0},this.execs.push(i),i=function(t,e){t.tmp.can_substitute.pop()||t.tmp.can_substitute.replace(!1,n.LITERAL),t.parallel.CloseVariable("names"),1===t.tmp.can_substitute.mystack.length&&(t.tmp.can_block_substitute=!1)},this.execs.push(i),t.build.name_flag=!1}e.push(this),(this.tokentype===n.END||this.tokentype===n.SINGLETON)&&(t.build.substitute_level.pop(),n.Util.substituteEnd.call(this,t,e))}},n.Node.number={build:function(t,e){var i;n.Util.substituteStart.call(this,t,e),"roman"===this.strings.form?this.formatter=t.fun.romanizer:"ordinal"===this.strings.form?this.formatter=t.fun.ordinalizer:"long-ordinal"===this.strings.form&&(this.formatter=t.fun.long_ordinalizer),"undefined"==typeof this.successor_prefix&&(this.successor_prefix=t[t.build.area].opt.layout_delimiter),"undefined"==typeof this.splice_prefix&&(this.splice_prefix=t[t.build.area].opt.layout_delimiter),i=function(t,e,i){var s,r,o,a;if(0!==this.variables.length){if("undefined"==typeof i)var i={};var l,c;if(l=this.variables[0],"locator"!==l||!t.tmp.just_looking){t.parallel.StartVariable(this.variables[0]),"locator"===this.variables[0]?t.parallel.AppendToVariable(e.section):t.parallel.AppendToVariable(e[this.variables[0]]);var u=new RegExp("(?:&|, | and |"+t.getTerm("page-range-delimiter")+")");"collection-number"===l&&"legal_case"===e.type&&(t.tmp.renders_collection_number=!0);var h=e[this.variables[0]],p="long";if(this.strings.label_form_override&&(p=this.strings.label_form_override),"locator"===l&&i.locator)if(i.locator=i.locator.replace(/([^\\])\s*-\s*/,"$1"+t.getTerm("page-range-delimiter")),c=i.locator.match(n.STATUTE_SUBDIV_GROUPED_REGEX)){for(a=i.locator.split(n.STATUTE_SUBDIV_PLAIN_REGEX),s=0,r=a.length;r>s;s+=1)a[s]=t.fun.page_mangler(a[s]);for(o=[a[0]],!this.strings.label_form_override&&t.tmp.group_context.value()[5]&&(p=t.tmp.group_context.value()[5]),s=1,r=a.length;r>s;s+=1){var f=0;a[s].match(u)&&(f=1);var d=n.STATUTE_SUBDIV_STRINGS[c[s-1].replace(/^\s*/,"")],m=p;i.section_label_count>s&&i.section_form_override&&(m=i.section_form_override),o.push(t.getTerm(d,m,f)),o.push(a[s].replace(/^\s*/,""))}h=o.join(" "),h=h.replace(/\\/,"","g"),t.output.append(h,this)}else h=t.fun.page_mangler(i.locator),h=h.replace(/\\/,"","g"),t.output.append(h,this);else{var g=this;(!t.tmp.shadow_numbers[l]||t.tmp.shadow_numbers[l].values.length&&t.tmp.shadow_numbers[l].values[0][2]===!1)&&("locator"===l?t.processNumber(g,i,l,e.type):t.processNumber(g,e,l,e.type));var b,v=t.tmp.shadow_numbers[l].values,y="",_="page";if(["bill","gazette","legislation","legal_case","treaty"].indexOf(e.type)>-1&&"collection-number"===l&&(_="year"),("number"===l&&["bill","gazette","legislation","treaty"].indexOf(e.type)>-1||t.opt[_+"-range-format"])&&!this.strings.prefix&&!this.strings.suffix&&!this.strings.form)for(s=0,r=v.length;r>s;s+=1)y+=v[s][1];if(y&&!y.match(/^[\-.\u20130-9]+$/)){if("number"===l&&["bill","gazette","legislation","treaty"].indexOf(e.type)>-1){var x=y.split(/\s/)[0];if(x&&(o=[],c=y.match(n.STATUTE_SUBDIV_GROUPED_REGEX))){for(a=y.split(n.STATUTE_SUBDIV_PLAIN_REGEX),s=1,r=a.length;r>s;s+=1)o.push(t.getTerm(n.STATUTE_SUBDIV_STRINGS[c[s-1].replace(/^\s+/,"")],this.strings.label_form_override)),o.push(a[s].replace(/^\s+/,""));y=o.join(" ")}}t.output.append(y,this)}else if(v.length){for(t.output.openLevel("empty"),s=0,r=v.length;r>s;s+=1)b=new n[v[s][0]](v[s][1],v[s][2],e.id),s>0&&(b.strings.prefix=b.strings.prefix.replace(/^\s*/,"")),s<v.length-1&&(b.strings.suffix=b.strings.suffix.replace(/\s*$/,"")),"undefined"==typeof b.gender&&(b.gender=t.locale[t.opt.lang]["noun-genders"][l]),t.output.append(b,"literal",!1,!1,!0);t.output.closeLevel("empty")}}"locator"===l&&t.tmp.done_vars.push("locator"),t.parallel.CloseVariable("number")}}},this.execs.push(i),e.push(this),n.Util.substituteEnd.call(this,t,e)}},n.Node.sort={build:function(t,e){if(e=t[t.build.root+"_sort"].tokens,this.tokentype===n.START){"citation"===t.build.area&&(t.parallel.use_parallels=!1,t.opt.sort_citations=!0),t.build.area=t.build.root+"_sort",t.build.extension="_sort";var i=function(t,e){if(t.opt.has_layout_locale){for(var i,s=n.localeResolve(e.language,t.opt["default-locale"][0]),r=t[t.tmp.area.slice(0,-5)].opt.sort_locales,o=0,a=r.length;a>o&&(i=r[o][s.bare],i||(i=r[o][s.best]),!i);o+=1);i||(i=t.opt["default-locale"][0]),t.tmp.lang_sort_hold=t.opt.lang,t.opt.lang=i}};this.execs.push(i)}if(this.tokentype===n.END){t.build.area=t.build.root,t.build.extension="";var i=function(t,e){t.opt.has_layout_locale&&(t.opt.lang=t.tmp.lang_sort_hold,delete t.tmp.lang_sort_hold);
};this.execs.push(i)}e.push(this)}},n.Node.substitute={build:function(t,e){var i;this.tokentype===n.START&&(i=function(t,e){t.tmp.can_block_substitute=!0,t.tmp.value.length&&t.tmp.can_substitute.replace(!1,n.LITERAL)},this.execs.push(i)),e.push(this)}},n.Node.text={build:function(t,e){var i,s,r,o,a,l,c,u,h,p,f,d,m,g,b;if(this.postponed_macro)return n.expandMacro.call(t,this);if(n.Util.substituteStart.call(this,t,e),this.variables_real||(this.variables_real=[]),this.variables||(this.variables=[]),s="long",r=0,this.strings.form&&(s=this.strings.form),this.strings.plural&&(r=this.strings.plural),"citation-number"===this.variables_real[0]||"year-suffix"===this.variables_real[0]||"citation-label"===this.variables_real[0])"citation-number"===this.variables_real[0]?("citation"===t.build.root&&(t.opt.update_mode=n.NUMERIC),"bibliography"===t.build.root&&(t.opt.bib_mode=n.NUMERIC),"bibliography_sort"===t.build.area&&(t.opt.citation_number_sort_used=!0),"citation-number"===t[t.tmp.area].opt.collapse&&(this.range_prefix=t.getTerm("citation-range-delimiter")),this.successor_prefix=t[t.build.area].opt.layout_delimiter,this.splice_prefix=t[t.build.area].opt.layout_delimiter,i=function(t,e,i){if(o=""+e.id,!t.tmp.just_looking){if(i&&i["author-only"]){t.tmp.element_trace.replace("do-not-suppress-me");var s=t.getTerm("reference","long","singular");"undefined"==typeof s&&(s="reference"),d=n.Output.Formatters["capitalize-first"](t,s),t.output.append(d+" "),t.tmp.last_element_trace=!0}i&&i["suppress-author"]&&(t.tmp.last_element_trace&&t.tmp.element_trace.replace("suppress-me"),t.tmp.last_element_trace=!1),a=t.registry.registry[o].seq,t.opt.citation_number_slug?t.output.append(t.opt.citation_number_slug,this):(l=new n.NumericBlob(a,this,e.id),t.output.append(l,"literal"))}},this.execs.push(i)):"year-suffix"===this.variables_real[0]?(t.opt.has_year_suffix=!0,"year-suffix-ranged"===t[t.tmp.area].opt.collapse&&(this.range_prefix=t.getTerm("citation-range-delimiter")),this.successor_prefix=t[t.build.area].opt.layout_delimiter,t[t.tmp.area].opt["year-suffix-delimiter"]&&(this.successor_prefix=t[t.build.area].opt["year-suffix-delimiter"]),i=function(t,e){if(t.registry.registry[e.id]&&t.registry.registry[e.id].disambig.year_suffix!==!1&&!t.tmp.just_looking){for(a=parseInt(t.registry.registry[e.id].disambig.year_suffix,10),l=new n.NumericBlob(a,this,e.id),c=new n.Util.Suffixator(n.SUFFIX_CHARS),l.setFormatter(c),t.output.append(l,"literal"),u=!1,m=t.tmp.group_context.mystack.length,g=0;m>g;g+=1)if(b=t.tmp.group_context.mystack[g],!b[2]&&(b[1]||!b[1]&&!b[0])){u=!0;break}h=t[t.tmp.area].opt["year-suffix-delimiter"],u&&h&&!t.tmp.sort_key_flag&&(t.tmp.splice_delimiter=t[t.tmp.area].opt["year-suffix-delimiter"])}},this.execs.push(i)):"citation-label"===this.variables_real[0]&&(t.opt.has_year_suffix=!0,i=function(t,e){p=e["citation-label"],p||(p=t.getCitationLabel(e)),t.tmp.just_looking||(f="",t.registry.registry[e.id]&&t.registry.registry[e.id].disambig.year_suffix!==!1&&(a=parseInt(t.registry.registry[e.id].disambig.year_suffix,10),f=t.fun.suffixator.format(a)),p+=f),t.output.append(p,this)},this.execs.push(i));else if(this.strings.term)i=function(t,e,i){var o=t.opt.gender[e.type],a=this.strings.term;a=t.getTerm(a,s,r,o,!1,"accessed"===a);var l;if(""!==a&&(b=t.tmp.group_context.value(),b[0]=!0,t.tmp.group_context.replace(b)),l=t.tmp.term_predecessor||"in-text"===t.opt["class"]&&"citation"===t.tmp.area?a:n.Output.Formatters["capitalize-first"](t,a),t.tmp.strip_periods)l=l.replace(/\./g,"");else for(var c=0,u=this.decorations.length;u>c;c+=1)if("@strip-periods"===this.decorations[c][0]&&"true"===this.decorations[c][1]){l=l.replace(/\./g,"");break}t.output.append(l,this)},this.execs.push(i),t.build.term=!1,t.build.form=!1,t.build.plural=!1;else if(this.variables_real.length){if(i=function(t,e,i){var n=this.variables[0];"title"!==n||"short"!==s&&!e["title-short"]||(n="title-short"),t.parallel.StartVariable(n),t.parallel.AppendToVariable(e[n],n)},this.execs.push(i),n.MULTI_FIELDS.indexOf(this.variables_real[0])>-1){var v=this.variables[0],y=!1,_=!1,x=!1;"short"===s?"container-title"===this.variables_real[0]?_="journalAbbreviation":"title"===this.variables_real[0]&&(_="title-short"):v=!1,t.build.extension?x=!0:(x=!0,y=!0),i=t.transform.getOutputFunction(this.variables,v,y,_,x)}else i=n.CITE_FIELDS.indexOf(this.variables_real[0])>-1?function(t,e,i){if(i&&i[this.variables[0]]){var s=""+i[this.variables[0]];s=s.replace(/([^\\])--*/g,"$1"+t.getTerm("page-range-delimiter")),s=s.replace(/\\-/g,"-"),t.output.append(s,this,!1,!1,!0),"locator-revision"===this.variables[0]&&t.tmp.done_vars.push("locator-revision")}}:"page-first"===this.variables_real[0]?function(t,e){var i;i=t.getVariable(e,"page-first",s),i&&(i=i.replace("\\",""),t.output.append(i,this,!1,!1,!0))}:"page"===this.variables_real[0]?function(t,e){var i=t.getVariable(e,"page",s);i&&(i=""+i,i=i.replace(/([^\\])--*/g,"$1"+t.getTerm("page-range-delimiter")),i=i.replace(/\\-/g,"-"),i=t.fun.page_mangler(i),t.output.append(i,this,!1,!1,!0))}:"volume"===this.variables_real[0]?function(t,e){if(this.variables[0]){var i=t.getVariable(e,this.variables[0],s);i&&t.output.append(i,this)}}:["URL","DOI"].indexOf(this.variables_real[0])>-1?function(t,e){var i;this.variables[0]&&(i=t.getVariable(e,this.variables[0],s),i&&(t.opt.development_extensions.wrap_url_and_doi?this.decorations.length&&this.decorations[0][0]==="@"+this.variables[0]||(this.decorations=[["@"+this.variables[0],"true"]].concat(this.decorations)):this.decorations.length&&this.decorations[0][0]==="@"+this.variables[0]&&(this.decorations=this.decorations.slice(1)),t.output.append(i,this,!1,!1,!0)))}:"section"===this.variables_real[0]?function(t,e){var i;i=t.getVariable(e,this.variables[0],s),i&&t.output.append(i,this)}:"hereinafter"===this.variables_real[0]?function(t,e){var i=t.transform.abbrevs["default"].hereinafter[e.id];i&&(t.output.append(i,this),t.tmp.group_context.value()[2]=!0)}:function(t,e){var i;this.variables[0]&&(i=t.getVariable(e,this.variables[0],s),i&&(i=""+i,i=i.replace("\\","","g"),t.output.append(i,this)))};this.execs.push(i),i=function(t,e){t.parallel.CloseVariable("text")},this.execs.push(i)}else this.strings.value&&(i=function(t,e){var i;i=t.tmp.group_context.value(),i[0]=!0,t.tmp.group_context.replace(i),t.output.append(this.strings.value,this)},this.execs.push(i));e.push(this),n.Util.substituteEnd.call(this,t,e)}},n.Attributes={},n.Attributes["@genre"]=function(t,e){e=e.replace("-"," ");var i=function(t,i){return e===t.genre?!0:!1};this.tests.push(i)},n.Attributes["@disambiguate"]=function(t,e){if("true"===e){t.opt.has_disambiguate=!0;var i=function(e,i){return t.tmp.disambiguate_maxMax+=1,t.tmp.disambig_settings.disambiguate&&t.tmp.disambiguate_count<t.tmp.disambig_settings.disambiguate?(t.tmp.disambiguate_count+=1,!0):!1};this.tests.push(i)}else if("check-ambiguity-and-backreference"===e){var i=function(e,i){return t.registry.registry[e.id].disambig.disambiguate&&t.registry.registry[e.id]["citation-count"]>1?!0:!1};this.tests.push(i)}},n.Attributes["@is-numeric"]=function(t,e,i){for(var s=e.split(/\s+/),r=function(e){return function(i,s){var r=i;if(["locator","locator-revision"].indexOf(e)>-1&&(r=s),"undefined"==typeof r)return!1;if(n.NUMERIC_VARIABLES.indexOf(e)>-1){if(t.tmp.shadow_numbers[e]||t.processNumber(!1,r,e,i.type),r[e]&&t.tmp.shadow_numbers[e].numeric)return!0}else if(["title","locator-revision","version"].indexOf(e)>-1&&r[e]&&r[e].slice(-1)===""+parseInt(r[e].slice(-1),10))return!0;return!1}},o=0;o<s.length;o+=1)this.tests.push(r(s[o]))},n.Attributes["@is-uncertain-date"]=function(t,e){for(var i=e.split(/\s+/),s=function(t){return function(e,i){return e[t]&&e[t].circa?!0:!1}},n=0,r=i.length;r>n;n+=1)this.tests.push(s(i[n]))},n.Attributes["@locator"]=function(t,e){var i=e.replace("sub verbo","sub-verbo");i=i.split(/\s+/);for(var s=function(t){return function(e,i){var s;return s="undefined"!=typeof i&&i.label?"sub verbo"===i.label?"sub-verbo":i.label:"page",t===s?!0:!1}},n=0,r=i.length;r>n;n+=1)this.tests.push(s(i[n]))},n.Attributes["@position"]=function(t,e){var i;t.opt.update_mode=n.POSITION,t.parallel.use_parallels=!0;for(var s=e.split(/\s+/),r=function(e){return function(i,s){if("bibliography"===t.tmp.area)return!1;if(s&&"undefined"==typeof s.position&&(s.position=0),s&&"number"==typeof s.position){if(0===s.position&&0===e)return!0;if(e>0&&s.position>=e)return!0}else if(0===e)return!0;return!1}},o=0,a=s.length;a>o;o+=1){var i=s[o];"first"===i?i=n.POSITION_FIRST:"subsequent"===i?i=n.POSITION_SUBSEQUENT:"ibid"===i?i=n.POSITION_IBID:"ibid-with-locator"===i&&(i=n.POSITION_IBID_WITH_LOCATOR),"near-note"===i?this.tests.push(function(t,e){return e&&e.position>=n.POSITION_SUBSEQUENT&&e["near-note"]?!0:!1}):this.tests.push(r(i))}},n.Attributes["@type"]=function(t,e){for(var i=e.split(/\s+/),s=function(t){return function(e,i){var s=e.type===t;return s?!0:!1}},n=[],r=0,o=i.length;o>r;r+=1)n.push(s(i[r]));this.tests.push(t.fun.match.any(this,t,n))},n.Attributes["@variable"]=function(t,e){var i,s,r,o;if(this.variables=e.split(/\s+/),this.variables_real=this.variables.slice(),"label"===this.name&&this.variables[0])this.strings.term=this.variables[0];else if(["names","date","text","number"].indexOf(this.name)>-1)i=function(t,e,i){s=this.variables_real.slice();for(var n=this.variables.length-1;n>-1;n+=-1)this.variables.pop();for(r=s.length,o=0;r>o;o+=1)-1!==t.tmp.done_vars.indexOf(s[o])||i&&"legal_case"===e.type&&i["suppress-author"]&&"title"===s[o]||this.variables.push(s[o]),t.tmp.can_block_substitute&&t.tmp.done_vars.push(s[o])},this.execs.push(i),i=function(t,e,i){var s,a;for(s=!1,r=this.variables.length,o=0;r>o;o+=1){if(a=this.variables[o],"authority"===a&&"string"==typeof e[a]&&"names"===this.name){var l={family:e[a],isInstitution:!0,multi:{_key:{}}};if(e.multi&&e.multi._keys&&e.multi._keys[a])for(var c in e.multi._keys[a])creatorChild={family:e.multi._keys[a][c],isInstitution:!0},l.multi._key[c]=creatorChild;e[a]=[l]}if("short"!==this.strings.form||e[a]||("title"===a?a="title-short":"container-title"===a&&(a="journalAbbreviation")),"year-suffix"===a){s=!0;break}if(n.DATE_VARIABLES.indexOf(a)>-1){if(t.opt.development_extensions.locator_date_and_revision&&"locator-date"===a){s=!0;break}if(e[a]){for(var u in e[a])if((-1!==this.dateparts.indexOf(u)||"literal"===u)&&e[a][u]){s=!0;break}if(s)break}}else{if("locator"===a){i&&i.locator&&(s=!0);break}if("locator-revision"===a){i&&i["locator-revision"]&&(s=!0);break}if(["citation-number","citation-label"].indexOf(a)>-1){s=!0;break}if("first-reference-note-number"===a){i&&i["first-reference-note-number"]&&(s=!0);break}if("hereinafter"===a){t.transform.abbrevs["default"].hereinafter[e.id]&&t.sys.getAbbreviation&&e.id&&(s=!0);break}if("object"==typeof e[a]){e[a].length;break}if("string"==typeof e[a]&&e[a]){s=!0;break}if("number"==typeof e[a]){s=!0;break}}if(s)break}var h=t.tmp.group_context.value();s?(("citation-number"!==a||"bibliography"!==t.tmp.area)&&(t.tmp.cite_renders_content=!0),h[2]=!0,t.tmp.group_context.replace(h),t.tmp.can_substitute.value()&&"bibliography"===t.tmp.area&&"string"==typeof e[a]&&t.tmp.rendered_name.push(e[a]),t.tmp.can_substitute.replace(!1,n.LITERAL)):h[1]=!0},this.execs.push(i);else if(["if","else-if","condition"].indexOf(this.name)>-1)for(var a=function(e){return function(i,s){var n=i;if(s&&["locator","locator-revision","first-reference-note-number","locator-date"].indexOf(e)>-1&&(n=s),"hereinafter"===e&&t.sys.getAbbreviation&&n.id){if(t.transform.abbrevs["default"].hereinafter[n.id])return!0}else if(n[e]){if("number"==typeof n[e]||"string"==typeof n[e])return!0;if("object"==typeof n[e])for(key in n[e])if(n[e][key])return!0}return!1}},l=0,c=this.variables.length;c>l;l+=1)this.tests.push(a(this.variables[l]))},n.Attributes["@page"]=function(t,e){var i=e.replace("sub verbo","sub-verbo");i=i.split(/\s+/);for(var s=function(e){return function(i,s){var n;return t.processNumber(!1,i,"page",i.type),n=t.tmp.shadow_numbers.page.label?"sub verbo"===t.tmp.shadow_numbers.page.label?"sub-verbo":t.tmp.shadow_numbers.page.label:"page",e===n?!0:!1}},n=0,r=i.length;r>n;n+=1)this.tests.push(s(i[n]))},n.Attributes["@jurisdiction"]=function(t,e){for(var i=e.split(/\s+/),s=0,n=i.length;n>s;s+=1)i[s]=i[s].split(";");for(var r=function(t){return function(e,i){if(!e.jurisdiction)return!1;for(var s=e.jurisdiction.split(";"),n=0,r=s.length;r>n;n+=1)s[n]=s[n].split(";");for(n=t.length;n>0;n+=-1){var o=t.slice(0,n).join(";"),a=s.slice(0,n).join(";");if(o!==a)return!1}return!0}},s=0,n=i.length;n>s;s+=1){var o=i[s].slice();this.tests.push(r(o))}},n.Attributes["@context"]=function(t,e){var i=function(i,s){var n=t.tmp.area.slice(0,e.length);return n===e?!0:!1};this.tests.push(i)},n.Attributes["@has-year-only"]=function(t,e){for(var i=e.split(/\s+/),s=function(t){return function(e,i){var s=e[t];return!s||s.month||s.season?!1:!0}},n=0,r=i.length;r>n;n+=1)this.tests.push(s(i[n]))},n.Attributes["@has-to-month-or-season"]=function(t,e){for(var i=e.split(/\s+/),s=function(t){return function(e,i){var s=e[t];return!s||!s.month&&!s.season||s.day?!1:!0}},n=0,r=i.length;r>n;n+=1)this.tests.push(s(i[n]))},n.Attributes["@has-day"]=function(t,e){for(var i=e.split(/\s+/),s=function(t){return function(e,i){var s=e[t];return s&&s.day?!0:!1}},n=0,r=i.length;r>n;n+=1)this.tests.push(s(i[n]))},n.Attributes["@subjurisdictions"]=function(t,e){var i=parseInt(e,10),s=function(t,e){var s=0;return t.jurisdiction&&(s=t.jurisdiction.split(";").length),s&&(s+=-1),s>=i?!0:!1};this.tests.push(s)},n.Attributes["@is-plural"]=function(t,e){var i=function(t,i){var s=t[e];if(s&&s.length){for(var n=0,r=0,o=!1,a=0,l=s.length;l>a;a+=1)s[a].isInstitution&&(s[a].literal||s[a].family&&!s[a].given)?(r+=1,o=!1):(n+=1,o=!0);if(n>1)return!0;if(r>1)return!0;if(r&&o)return!0}return!1};this.tests.push(i)},n.Attributes["@locale"]=function(t,e){var i,s,r,o,a,l,c=t.opt["default-locale"][0];if("layout"===this.name){if(this.locale_raw=e,this.tokentype===n.START){var u=e.split(/\s+/),h={},p=n.localeResolve(u[0],c);p.generic?h[p.generic]=p.best:h[p.best]=p.best;for(var a=1,l=u.length;l>a;a+=1){var f=n.localeResolve(u[a],c);f.generic?h[f.generic]=p.best:h[f.best]=p.best}t[t.build.area].opt.sort_locales.push(h)}t.opt.has_layout_locale=!0}else{o=e.split(/\s+/);var d=[];for(a=0,l=o.length;l>a;a+=1)r=o[a],s=n.localeResolve(r,c),2===o[a].length&&d.push(s.bare),t.localeConfigure(s,!0),o[a]=s;var m=o.slice(),g=function(t,e,s){return function(r,o){var c;i=[],c=!1;var u,h=!1;for(u=r.language?r.language:e,h=n.localeResolve(u,e),a=0,l=t.length;l>a;a+=1)if(h.best===t[a].best){c=!0;break}return!c&&s.indexOf(h.bare)>-1&&(c=!0),c}};this.tests.push(g(m,c,d))}},n.Attributes["@locale-internal"]=function(t,e){var i,s,r,o,a,l;for(o=e.split(/\s+/),this.locale_bares=[],a=0,l=o.length;l>a;a+=1)r=o[a],s=n.localeResolve(r,t.opt["default-locale"][0]),2===o[a].length&&this.locale_bares.push(s.bare),t.localeConfigure(s),o[a]=s;this.locale_default=t.opt["default-locale"][0],this.locale=o[0].best,this.locale_list=o.slice();var c=function(e){return function(s,o){var c;i=[],c=!1;var u=!1;if(s.language&&(r=s.language,u=n.localeResolve(r,t.opt["default-locale"][0]),u.best===t.opt["default-locale"][0]&&(u=!1)),u){for(a=0,l=e.locale_list.length;l>a;a+=1)if(u.best===e.locale_list[a].best){t.opt.lang=e.locale,t.tmp.last_cite_locale=e.locale,t.output.openLevel("empty"),t.output.current.value().new_locale=e.locale,c=!0;break}!c&&e.locale_bares.indexOf(u.bare)>-1&&(t.opt.lang=e.locale,t.tmp.last_cite_locale=e.locale,t.output.openLevel("empty"),t.output.current.value().new_locale=e.locale,c=!0)}return c}},u=this;this.tests.push(c(u))},n.Attributes["@is-parallel"]=function(t,e){for(var i=e.split(" "),s=0,n=i.length;n>s;s+=1)"true"===i[s]?i[s]=!0:"false"===i[s]&&(i[s]=!1);this.strings.set_parallel_condition=i},n.Attributes["@gender"]=function(t,e){this.gender=e},n.Attributes["@cslid"]=function(t,e){this.cslid=parseInt(e,10)},n.Attributes["@label-form"]=function(t,e){this.strings.label_form_override=e},n.Attributes["@part-separator"]=function(t,e){this.strings["part-separator"]=e},n.Attributes["@leading-noise-words"]=function(t,e){this["leading-noise-words"]=e},n.Attributes["@name-never-short"]=function(t,e){this["name-never-short"]=e},n.Attributes["@class"]=function(t,e){t.opt["class"]=e},n.Attributes["@version"]=function(t,e){t.opt.version=e},n.Attributes["@value"]=function(t,e){this.strings.value=e},n.Attributes["@name"]=function(t,e){this.strings.name=e},n.Attributes["@form"]=function(t,e){this.strings.form=e},n.Attributes["@date-parts"]=function(t,e){this.strings["date-parts"]=e},n.Attributes["@range-delimiter"]=function(t,e){this.strings["range-delimiter"]=e},n.Attributes["@macro"]=function(t,e){this.postponed_macro=e},n.Attributes["@term"]=function(t,e){"sub verbo"===e?this.strings.term="sub-verbo":this.strings.term=e},n.Attributes["@xmlns"]=function(t,e){},n.Attributes["@lang"]=function(t,e){e&&(t.build.lang=e)},n.Attributes["@lingo"]=function(t,e){},n.Attributes["@macro-has-date"]=function(t,e){this["macro-has-date"]=!0},n.Attributes["@suffix"]=function(t,e){this.strings.suffix=e},n.Attributes["@prefix"]=function(t,e){this.strings.prefix=e},n.Attributes["@delimiter"]=function(t,e){"name"==this.name?this.strings.name_delimiter=e:this.strings.delimiter=e},n.Attributes["@match"]=function(t,e){this.match=e},n.Attributes["@names-min"]=function(t,e){var i=parseInt(e,10);t[t.tmp.area].opt.max_number_of_names<i&&(t[t.tmp.area].opt.max_number_of_names=i),this.strings["et-al-min"]=i},n.Attributes["@names-use-first"]=function(t,e){this.strings["et-al-use-first"]=parseInt(e,10)},n.Attributes["@names-use-last"]=function(t,e){"true"===e?this.strings["et-al-use-last"]=!0:this.strings["et-al-use-last"]=!1},n.Attributes["@sort"]=function(t,e){"descending"===e&&(this.strings.sort_direction=n.DESCENDING)},n.Attributes["@plural"]=function(t,e){"always"===e||"true"===e?this.strings.plural=1:"never"===e||"false"===e?this.strings.plural=0:"contextual"===e&&(this.strings.plural=!1)},n.Attributes["@number"]=function(t,e){var i,s=e.replace("sub verbo","sub-verbo");s=s.split(/\s+/),["if","else-if"].indexOf(this.name)>-1&&(i=function(t,e,i){var n,r=[];t.processNumber(!1,e,"number",e.type),n=t.tmp.shadow_numbers.number.label?"sub verbo"===t.tmp.shadow_numbers.number.label?"sub-verbo":t.tmp.shadow_numbers.number.label:"number";for(var o=0,a=s.length;a>o;o+=1)s[o]===n?r.push(!0):r.push(!1);return r},this.tests.push(i))},n.Attributes["@has-publisher-and-publisher-place"]=function(t,e){this.strings["has-publisher-and-publisher-place"]=!0},n.Attributes["@publisher-delimiter-precedes-last"]=function(t,e){this.strings["publisher-delimiter-precedes-last"]=e},n.Attributes["@publisher-delimiter"]=function(t,e){this.strings["publisher-delimiter"]=e},n.Attributes["@publisher-and"]=function(t,e){this.strings["publisher-and"]=e},n.Attributes["@newdate"]=function(t,e){},n.Attributes["@givenname-disambiguation-rule"]=function(t,e){n.GIVENNAME_DISAMBIGUATION_RULES.indexOf(e)>-1&&(t.citation.opt["givenname-disambiguation-rule"]=e)},n.Attributes["@collapse"]=function(t,e){e&&(t[this.name].opt.collapse=e)},n.Attributes["@cite-group-delimiter"]=function(t,e){e&&(t[t.tmp.area].opt.cite_group_delimiter=e)},n.Attributes["@names-delimiter"]=function(t,e){t.setOpt(this,"names-delimiter",e)},n.Attributes["@name-form"]=function(t,e){t.setOpt(this,"name-form",e)},n.Attributes["@subgroup-delimiter"]=function(t,e){this.strings["subgroup-delimiter"]=e},n.Attributes["@subgroup-delimiter-precedes-last"]=function(t,e){this.strings["subgroup-delimiter-precedes-last"]=e},n.Attributes["@name-delimiter"]=function(t,e){t.setOpt(this,"name-delimiter",e)},n.Attributes["@et-al-min"]=function(t,e){var i=parseInt(e,10);t[t.tmp.area].opt.max_number_of_names<i&&(t[t.tmp.area].opt.max_number_of_names=i),t.setOpt(this,"et-al-min",i)},n.Attributes["@et-al-use-first"]=function(t,e){t.setOpt(this,"et-al-use-first",parseInt(e,10))},n.Attributes["@et-al-use-last"]=function(t,e){"true"===e?t.setOpt(this,"et-al-use-last",!0):t.setOpt(this,"et-al-use-last",!1)},n.Attributes["@et-al-subsequent-min"]=function(t,e){var i=parseInt(e,10);t[t.tmp.area].opt.max_number_of_names<i&&(t[t.tmp.area].opt.max_number_of_names=i),t.setOpt(this,"et-al-subsequent-min",i)},n.Attributes["@et-al-subsequent-use-first"]=function(t,e){t.setOpt(this,"et-al-subsequent-use-first",parseInt(e,10))},n.Attributes["@suppress-min"]=function(t,e){this.strings["suppress-min"]=parseInt(e,10)},n.Attributes["@suppress-max"]=function(t,e){this.strings["suppress-max"]=parseInt(e,10)},n.Attributes["@and"]=function(t,e){t.setOpt(this,"and",e)},n.Attributes["@delimiter-precedes-last"]=function(t,e){t.setOpt(this,"delimiter-precedes-last",e)},n.Attributes["@delimiter-precedes-et-al"]=function(t,e){t.setOpt(this,"delimiter-precedes-et-al",e)},n.Attributes["@initialize-with"]=function(t,e){t.setOpt(this,"initialize-with",e)},n.Attributes["@initialize"]=function(t,e){"false"===e&&t.setOpt(this,"initialize",!1)},n.Attributes["@name-as-reverse-order"]=function(t,e){this["name-as-reverse-order"]=e},n.Attributes["@name-as-sort-order"]=function(t,e){"style-options"===this.name?this["name-as-sort-order"]=e:t.setOpt(this,"name-as-sort-order",e)},n.Attributes["@sort-separator"]=function(t,e){t.setOpt(this,"sort-separator",e)},n.Attributes["@year-suffix-delimiter"]=function(t,e){t[this.name].opt["year-suffix-delimiter"]=e},n.Attributes["@after-collapse-delimiter"]=function(t,e){t[this.name].opt["after-collapse-delimiter"]=e},n.Attributes["@subsequent-author-substitute"]=function(t,e){t[this.name].opt["subsequent-author-substitute"]=e},n.Attributes["@subsequent-author-substitute-rule"]=function(t,e){t[this.name].opt["subsequent-author-substitute-rule"]=e},n.Attributes["@disambiguate-add-names"]=function(t,e){"true"===e&&(t.opt["disambiguate-add-names"]=!0)},n.Attributes["@disambiguate-add-givenname"]=function(t,e){"true"===e&&(t.opt["disambiguate-add-givenname"]=!0)},n.Attributes["@disambiguate-add-year-suffix"]=function(t,e){"true"===e&&"numeric"!==t.opt.xclass&&(t.opt["disambiguate-add-year-suffix"]=!0)},n.Attributes["@second-field-align"]=function(t,e){("flush"===e||"margin"===e)&&(t[this.name].opt["second-field-align"]=e)},n.Attributes["@hanging-indent"]=function(t,e){"true"===e&&(t[this.name].opt.hangingindent=2)},n.Attributes["@line-spacing"]=function(t,e){e&&e.match(/^[.0-9]+$/)&&(t[this.name].opt["line-spacing"]=parseFloat(e,10))},n.Attributes["@entry-spacing"]=function(t,e){e&&e.match(/^[.0-9]+$/)&&(t[this.name].opt["entry-spacing"]=parseFloat(e,10))},n.Attributes["@near-note-distance"]=function(t,e){t[this.name].opt["near-note-distance"]=parseInt(e,10)},n.Attributes["@text-case"]=function(t,e){var i=function(t,i){if("normal"===e)this.text_case_normal=!0;else if(this.strings["text-case"]=e,"title"===e){t.opt["default-locale"][0].slice(0,2);i.jurisdiction&&(this.strings["text-case"]="passthrough")}};this.execs.push(i)},n.Attributes["@page-range-format"]=function(t,e){t.opt["page-range-format"]=e},n.Attributes["@year-range-format"]=function(t,e){t.opt["year-range-format"]=e},n.Attributes["@default-locale"]=function(t,e){var i,s,n,r,o;if(r=e.match(/-x-(sort|translit|translat)-/g))for(n=0,s=r.length;s>n;n+=1)r[n]=r[n].replace(/^-x-/,"").replace(/-$/,"");for(i=e.split(/-x-(?:sort|translit|translat)-/),o=[i[0]],n=1,s=i.length;s>n;n+=1)o.push(r[n-1]),o.push(i[n]);for(i=o.slice(),s=i.length,n=1;s>n;n+=2)t.opt["locale-"+i[n]].push(i[n+1].replace(/^\s*/g,"").replace(/\s*$/g,""));i.length?t.opt["default-locale"]=i.slice(0,1):t.opt["default-locale"]=["en"]},n.Attributes["@default-locale-sort"]=function(t,e){t.opt["default-locale-sort"]=e},n.Attributes["@demote-non-dropping-particle"]=function(t,e){t.opt["demote-non-dropping-particle"]=e},n.Attributes["@initialize-with-hyphen"]=function(t,e){"false"===e&&(t.opt["initialize-with-hyphen"]=!1)},n.Attributes["@institution-parts"]=function(t,e){this.strings["institution-parts"]=e},n.Attributes["@if-short"]=function(t,e){"true"===e&&(this.strings["if-short"]=!0)},n.Attributes["@substitute-use-first"]=function(t,e){this.strings["substitute-use-first"]=parseInt(e,10)},n.Attributes["@use-first"]=function(t,e){this.strings["use-first"]=parseInt(e,10)},n.Attributes["@stop-last"]=function(t,e){this.strings["stop-last"]=-1*parseInt(e,10)},n.Attributes["@oops"]=function(t,e){this.strings.oops=e},n.Attributes["@use-last"]=function(t,e){this.strings["use-last"]=parseInt(e,10)},n.Attributes["@reverse-order"]=function(t,e){"true"===e&&(this.strings["reverse-order"]=!0)},n.Attributes["@display"]=function(t,e){this.strings.cls=e},n.Stack=function(t,e){this.mystack=[],(e||t)&&this.mystack.push(t)},n.Stack.prototype.push=function(t,e){e||t?this.mystack.push(t):this.mystack.push("")},n.Stack.prototype.clear=function(){this.mystack=[]},n.Stack.prototype.replace=function(t,e){if(0===this.mystack.length)throw"Internal CSL processor error: attempt to replace nonexistent stack item with "+t;e||t?this.mystack[this.mystack.length-1]=t:this.mystack[this.mystack.length-1]=""},n.Stack.prototype.pop=function(){return this.mystack.pop()},n.Stack.prototype.value=function(){return this.mystack.slice(-1)[0]},n.Stack.prototype.length=function(){return this.mystack.length},n.Parallel=function(t){this.state=t,this.sets=new n.Stack([]),this.try_cite=!0,this.use_parallels=!1,this.midVars=["section","volume","container-title","collection-number","issue","page-first","page","number"],this.ignoreVarsLawGeneral=["first-reference-note-number","locator","label","page-first","page","genre"],this.ignoreVarsLawProceduralHistory=["issued","first-reference-note-number","locator","label","page-first","page","genre","jurisdiction"],this.ignoreVarsOrders=["first-reference-note-number"],this.ignoreVarsOther=["first-reference-note-number","locator","label","section","page-first","page"]},n.Parallel.prototype.isMid=function(t){return this.midVars.indexOf(t)>-1},n.Parallel.prototype.StartCitation=function(t,e){this.parallel_conditional_blobs_list=[],this.use_parallels&&(this.sortedItems=t,this.sortedItemsPos=-1,this.sets.clear(),this.sets.push([]),this.in_series=!0,this.delim_counter=0,this.delim_pointers=[],e?this.out=e:this.out=this.state.output.queue,this.master_was_neutral_cite=!0)},n.Parallel.prototype.StartCite=function(t,e,i){var s,r,o,a,l,c,u,h;if(this.use_parallels){this.sets.value().length&&this.sets.value()[0].itemId==t.id&&this.ComposeSet(),this.sortedItemsPos+=1,e&&(s=e.position),this.try_cite=!0;for(var p=!1,f=0,d=n.PARALLEL_MATCH_VARS.length;d>f;f+=1)if(t[n.PARALLEL_MATCH_VARS[f]]){p=!0;break}var m=!0,g=this.sets.value().slice(-1)[0];if(g&&g.Item&&(g.Item.title!==t.title?m=!1:g.Item.type!==t.type?m=!1:["article-journal","article-magazine"].indexOf(t.type)>-1&&(this.state.opt.development_extensions.handle_parallel_articles&&g.Item["container-title"]===t["container-title"]||(m=!1))),m&&p&&-1!==n.PARALLEL_TYPES.indexOf(t.type)||(this.try_cite=!0,this.in_series&&(this.in_series=!1)),this.cite={},this.cite.front=[],this.cite.mid=[],this.cite.back=[],this.cite.front_collapse={},this.cite.back_forceme=[],this.cite.position=s,this.cite.Item=t,this.cite.itemId=""+t.id,this.cite.prevItemID=""+i,this.target="front",["treaty"].indexOf(t.type)>-1)this.ignoreVars=this.ignoreVarsOrders;else if(["article-journal","article-magazine"].indexOf(t.type)>-1)this.ignoreVars=this.ignoreVarsOther;else if(e&&e.prefix){this.ignoreVars=this.ignoreVarsLawProceduralHistory,this.cite.useProceduralHistory=!0;var b=this.sets.value()[this.sets.value().length-1];if(b&&b.back)for(var f=b.back.length-1;f>-1;f+=-1)b.back[f]&&b[b.back[f]]&&delete b[b.back[f]]}else this.ignoreVars=this.ignoreVarsLawGeneral;if(this.sortedItems&&this.sortedItemsPos>0&&this.sortedItemsPos<this.sortedItems.length){if(a=this.sortedItems[this.sortedItemsPos][1],c=""+this.sortedItems[this.sortedItemsPos-1][1].id,l=this.state.registry.registry[c].parallel,u=!1,l==a.id){for(r=this.sortedItemsPos-1,o=r;o>-1;o+=-1)if(this.sortedItems[o][1].id==t.id){u=this.sortedItems[o][1].locator;break}h=this.sortedItems[this.sortedItemsPos][1].locator,!u&&h?a.position=n.POSITION_IBID_WITH_LOCATOR:h===u?a.position=n.POSITION_IBID:a.position=n.POSITION_IBID_WITH_LOCATOR}}else{if(!this.state.registry.registry[t.id])return this.try_cite=!1,void(this.force_collapse=!1);this.state.registry.registry[t.id].parallel=!1}this.force_collapse=!1,this.state.registry.registry[t.id].parallel&&(this.force_collapse=!0)}},n.Parallel.prototype.StartVariable=function(t,e){if(this.use_parallels&&(this.try_cite||this.force_collapse)){if("names"===t?this.variable=t+":"+this.target:this.variable=t,this.ignoreVars.indexOf(t)>-1)return;"container-title"===t&&0===this.sets.value().length&&(this.master_was_neutral_cite=!1),this.data={},this.data.value="",this.data.blobs=[];var i=this.isMid(t);"authority"===e&&"names:front"===this.variable?(this.try_cite=!0,this.in_series=!1):"front"===this.target&&i?this.target="mid":"mid"===this.target&&!i&&this.cite.Item.title&&"names"!==t?this.target="back":"back"===this.target&&i&&(this.try_cite=!0,this.in_series=!1),"number"===t?this.cite.front.push(this.variable):n.PARALLEL_COLLAPSING_MID_VARSET.indexOf(t)>-1?["article-journal","article-magazine"].indexOf(this.cite.Item.type)>-1?this.cite.mid.push(this.variable):this.cite.front.push(this.variable):this.cite[this.target].push(this.variable)}},n.Parallel.prototype.AppendBlobPointer=function(t){if(this.use_parallels){if(this.ignoreVars.indexOf(this.variable)>-1)return;if(this.use_parallels&&(this.force_collapse||this.try_cite)){if(["article-journal","article-magazine"].indexOf(this.cite.Item.type)>-1){if(["volume","page","page-first","issue"].indexOf(this.variable)>-1)return;if("container-title"===this.variable&&this.cite.mid.length>1)return}this.variable&&(this.try_cite||this.force_collapse)&&t&&t.blobs&&(this.cite.useProceduralHistory&&"back"===this.target||this.data.blobs.push([t,t.blobs.length]))}}},n.Parallel.prototype.AppendToVariable=function(t,e){if(this.use_parallels){if(this.ignoreVars.indexOf(this.variable)>-1)return;if(this.try_cite||this.force_collapse)if("back"!==this.target,0){var i=this.sets.value()[this.sets.value().length-1];i&&i[this.variable]&&i[this.variable].value&&(this.data.value+="::"+t)}else this.data.value+="::"+t}},n.Parallel.prototype.CloseVariable=function(){if(this.use_parallels){if(this.ignoreVars.indexOf(this.variable)>-1)return;if((this.try_cite||this.force_collapse)&&(this.cite[this.variable]=this.data,this.sets.value().length>0)){var t=this.sets.value()[this.sets.value().length-1];"front"===this.target&&"issued"===this.variable&&this.data.value&&this.master_was_neutral_cite&&(this.target="mid"),"front"===this.target?!t[this.variable]&&!this.data.value||t[this.variable]&&this.data.value===t[this.variable].value||"issued"!==this.variable&&(this.in_series=!1):"mid"===this.target?n.PARALLEL_COLLAPSING_MID_VARSET.indexOf(this.variable)>-1&&(t[this.variable]&&t[this.variable].value===this.data.value?this.cite.front_collapse[this.variable]=!0:this.cite.front_collapse[this.variable]=!1):"back"===this.target&&t[this.variable]&&this.data.value!==t[this.variable].value&&-1===this.sets.value().slice(-1)[0].back_forceme.indexOf(this.variable)&&(this.in_series=!1)}this.variable=!1}},n.Parallel.prototype.CloseCite=function(){var t,e,i,s,n,r,o;if(this.use_parallels&&(this.force_collapse||this.try_cite)){if(s=!1,this.cite.front_collapse["container-title"]||(s=!0),this.cite.front_collapse.volume===!1&&(s=!0),this.cite.front_collapse["collection-number"]===!1&&(s=!0),this.cite.front_collapse.section===!1&&(s=!0),s&&(this.cite.use_journal_info=!0,o=this.cite.front.indexOf("section"),o>-1&&(this.cite.front=this.cite.front.slice(0,o).concat(this.cite.front.slice(o+1))),n=this.cite.front.indexOf("volume"),n>-1&&(this.cite.front=this.cite.front.slice(0,n).concat(this.cite.front.slice(n+1))),r=this.cite.front.indexOf("container-title"),r>-1&&(this.cite.front=this.cite.front.slice(0,r).concat(this.cite.front.slice(r+1))),
collection_number_pos=this.cite.front.indexOf("collection-number"),collection_number_pos>-1&&(this.cite.front=this.cite.front.slice(0,collection_number_pos).concat(this.cite.front.slice(collection_number_pos+1)))),this.in_series||this.force_collapse||this.ComposeSet(!0),0===this.sets.value().length){for(has_date=!1,e=0,i=this.cite.back.length;i>e;e+=1)if(t=this.cite.back[e],"issued"===t&&this.cite.issued&&this.cite.issued.value){has_date=!0;break}has_date||this.cite.back_forceme.push("issued")}else{var a=this.cite.front.indexOf("issued");if((-1===a||this.master_was_neutral_cite)&&(this.cite.back_forceme=this.sets.value().slice(-1)[0].back_forceme),a>-1){var l=this.sets.value()[this.sets.value().length-1];l.issued||(this.cite.front=this.cite.front.slice(0,a).concat(this.cite.front.slice(a+1)))}this.master_was_neutral_cite&&this.cite.mid.indexOf("names:mid")>-1&&this.cite.front.push("names:mid")}this.sets.value().push(this.cite)}},n.Parallel.prototype.ComposeSet=function(t){var e,i,s;if(this.use_parallels&&(this.force_collapse||this.try_cite)){var r=this.sets.value().length;if(1===this.sets.value().length)this.in_series||(this.sets.value().pop(),this.delim_counter+=1);else{for(s=this.sets.value().length,i=0;s>i;i+=1)e=this.sets.value()[i],0===i?this.delim_counter+=1:(!e.Item.title&&e.use_journal_info?this.delim_pointers.push(!1):this.delim_pointers.push(this.delim_counter),this.delim_counter+=1),n.POSITION_FIRST===e.position&&(0===i?(this.state.registry.registry[e.itemId].master=!0,this.state.registry.registry[e.itemId].siblings=[],this.state.registry.registry[e.itemId].parallel=!1):e.prevItemID&&(this.state.registry.registry[e.prevItemID].parallel?this.state.registry.registry[e.itemId].parallel=this.state.registry.registry[e.prevItemID].parallel:this.state.registry.registry[e.itemId].parallel=e.prevItemID,this.state.registry.registry[e.itemId].siblings=this.state.registry.registry[e.prevItemID].siblings,this.state.registry.registry[e.itemId].siblings||(this.state.registry.registry[e.itemId].siblings=[],n.debug("WARNING: adding missing siblings array to registry object")),this.state.registry.registry[e.itemId].siblings.push(e.itemId)));this.sets.push([])}2>r?this.purgeGroupsIfParallel(!1):this.purgeGroupsIfParallel(!0),this.in_series=!0}},n.Parallel.prototype.PruneOutputQueue=function(){var t,e,i,s,n,r;if(this.use_parallels)for(t=this.sets.mystack.length,e=0;t>e;e+=1)if(i=this.sets.mystack[e],i.length>1)for(n=i.length,s=0;n>s;s+=1)r=i[s],0===s?this.purgeVariableBlobs(r,r.back):s===i.length-1?this.purgeVariableBlobs(r,r.front.concat(r.back_forceme)):this.purgeVariableBlobs(r,r.front.concat(r.back))},n.Parallel.prototype.purgeVariableBlobs=function(t,e){var i,s,n,r,o,a,l;if(this.use_parallels){for(l=this.state.output.current.value(),"undefined"==typeof l.length&&(l=l.blobs),s=0,i=this.delim_pointers.length;i>s;s+=1)a=this.delim_pointers[s],a!==!1&&(l[a].parallel_delimiter=", ");for(i=e.length-1,s=i;s>-1;s+=-1)if(n=e[s],t[n])for(o=t[n].blobs.length-1,a=o;a>-1;a+=-1)r=t[n].blobs[a],r[0].blobs=r[0].blobs.slice(0,r[1]).concat(r[0].blobs.slice(r[1]+1)),this.state.tmp.has_purged_parallel=!0,r[0]&&r[0].strings&&"string"==typeof r[0].strings.oops&&r[0].parent&&r[0].parent&&(r[0].parent.parent.strings.delimiter=r[0].strings.oops)}},n.Parallel.prototype.purgeGroupsIfParallel=function(t){for(var e=this.parallel_conditional_blobs_list.length-1;e>-1;e+=-1){for(var i=this.parallel_conditional_blobs_list[e],s=!0,n=0,r=i.conditions.length;r>n;n+=1)if(!i.conditions[n]!=!!t&&("master"!==i.conditions[n]||this.state.registry.registry[i.id].master)&&("servant"!==i.conditions[n]||this.state.registry.registry[i.id].parallel)){var s=!1;break}if(s){for(var o=[];i.blobs.length>i.pos;)o.push(i.blobs.pop());for(o.length&&o.pop();o.length;)i.blobs.push(o.pop())}this.parallel_conditional_blobs_list.pop()}},n.Util={},n.Util.Match=function(){this.any=function(t,e,i){return function(t,e){for(var s=0,n=i.length;n>s;s+=1)if(result=i[s](t,e),result)return!0;return!1}},this.none=function(t,e,i){return function(t,e){for(var s=0,n=i.length;n>s;s+=1)if(result=i[s](t,e),result)return!1;return!0}},this.all=function(t,e,i){return function(t,e){for(var s=0,n=i.length;n>s;s+=1)if(result=i[s](t,e),!result)return!1;return!0}},this[void 0]=this.all,this.nand=function(t,e,i){return function(t,e){for(var s=0,n=i.length;n>s;s+=1)if(result=i[s](t,e),!result)return!0;return!1}}},n.Transform=function(t){function e(t,e,i,s,r,o){var a;if(!r)return s;var l=r,c=!1;if(["title","title-short"].indexOf(l)>-1&&!e.jurisdiction&&(c=!0),n.NUMERIC_VARIABLES.indexOf(r)>-1&&(r="number"),["publisher-place","event-place","jurisdiction","archive-place"].indexOf(r)>-1&&(r="place"),["publisher","authority"].indexOf(r)>-1&&(r="institution-part"),["genre","event","medium","title-short"].indexOf(r)>-1&&(r="title"),["archive"].indexOf(r)>-1&&(r="collection-title"),a="",t.sys.getAbbreviation){var u=t.transform.loadAbbreviation(e.jurisdiction,r,s,e.type,c);t.transform.abbrevs[u][r]&&s&&t.sys.getAbbreviation&&t.transform.abbrevs[u][r][s]&&(a=t.transform.abbrevs[u][r][s].replace("{stet}",s))}return a||t.opt.development_extensions.require_explicit_legal_case_title_short&&"legal_case"===e.type||!i||!e[i]||!o||(a=e[i]),a||(a=s),a&&"!here>>>"===a.slice(0,10)&&(a="jurisdiction"===l&&["treaty","patent"].indexOf(l)>-1?a.slice(10):!1),a}function i(e,i){var s,n=t.opt["default-locale"][0].slice(0,2);return s=t.opt.development_extensions.strict_text_case_locales?new RegExp("^([a-zA-Z]{2})(?:$|-.*| .*)"):new RegExp("^([a-zA-Z]{2})(?:$|-.*|.*)"),e.language&&(m=(""+e.language).match(s),n=m?m[1]:"tlh"),e.multi&&e.multi&&e.multi.main&&e.multi.main[i]&&(n=e.multi.main[i]),(!t.opt.development_extensions.strict_text_case_locales||t.opt.development_extensions.normalize_lang_keys_to_lowercase)&&(n=n.toLowerCase()),n}function s(e,s,n,r,o){var a,l,c,u;if(!e[s])return{name:"",usedOrig:o};if(c={name:"",usedOrig:o,locale:i(e,s)},u=t.opt[n],"locale-orig"===n)return c=o?{name:"",usedOrig:o}:{name:e[s],usedOrig:!1,locale:i(e,s)};if(r&&("undefined"==typeof u||0===u.length))return{name:e[s],usedOrig:!0,locale:i(e,s)};for(var h=0,p=u.length;p>h;h+=1){if(a=u[h],l=a.split(/[\-_]/)[0],a&&e.multi&&e.multi._keys[s]&&e.multi._keys[s][a]){c.name=e.multi._keys[s][a],c.locale=l;break}if(l&&e.multi&&e.multi._keys[s]&&e.multi._keys[s][l]){c.name=e.multi._keys[s][l],c.locale=l;break}}return!c.name&&r&&(c={name:e[s],usedOrig:!0,locale:i(e,s)}),c}function r(e,i,s,n,r){if(e||(e="default"),!s)return t.transform.abbrevs[e]||(t.transform.abbrevs[e]=new t.sys.AbbreviationSegments),e;if(t.sys.getAbbreviation){var o=["default"];if("default"!==e)for(var a=e.split(/\s*;\s*/),l=0,c=a.length;c>l;l+=1)o.push(a.slice(0,l+1).join(";"));for(var l=o.length-1;l>-1;l+=-1)if(t.transform.abbrevs[o[l]]||(t.transform.abbrevs[o[l]]=new t.sys.AbbreviationSegments),t.transform.abbrevs[o[l]][i][s]||t.sys.getAbbreviation(t.opt.styleID,t.transform.abbrevs,o[l],i,s,n,r),t.transform.abbrevs[o[l]][i][s]){l<o.length&&(t.transform.abbrevs[e][i][s]=t.transform.abbrevs[o[l]][i][s]);break}}return e}function o(i,s,n,r){var o=i.variables[0];if(t.publisherOutput&&n){if(-1===["publisher","publisher-place"].indexOf(o))return!1;t.publisherOutput[o+"-token"]=i,t.publisherOutput.varlist.push(o);var a=n.split(/;\s*/);a.length===t.publisherOutput[o+"-list"].length&&(t.publisherOutput[o+"-list"]=a);for(var l=0,c=a.length;c>l;l+=1)a[l]=e(t,s,!1,a[l],r,!0);return t.tmp[o+"-token"]=i,!0}return!1}function a(i,r,a,c,u){var h,p=n.LangPrefsMap[i[0]];return h=p?t.opt["cite-lang-prefs"][p]:!1,function(t,a,u,f){var d,m,g,b,v,y,_;if(!i[0]||!a[i[0]]&&!a[c])return null;if(t.opt.suppressJurisdictions&&"jurisdiction"===i[0]&&t.opt.suppressJurisdictions[a.jurisdiction]&&["legal_case","gazette","regulation","legislation"].indexOf(a.type)>-1)return null;var x={primary:!1,secondary:!1,tertiary:!1};if("_sort"===t.tmp.area.slice(-5))x.primary="locale-sort";else if(h)for(var w=["primary","secondary","tertiary"],S=0,O=w.length;O>S&&!(h.length-1<S);S+=1)h[S]&&(x[w[S]]="locale-"+h[S]);else x.primary="locale-orig";if("bibliography"===t.tmp.area||"citation"===t.tmp.area&&"note"===t.opt.xclass&&u&&!u.position||(x.secondary=!1,x.tertiary=!1),t.tmp["publisher-list"])return"publisher"===i[0]?t.tmp["publisher-token"]=this:"publisher-place"===i[0]&&(t.tmp["publisher-place-token"]=this),null;var T=s(a,i[0],x.primary,!0);d=T.name,m=T.locale;var I=T.usedOrig;if(o(this,a,d,r))return null;g=!1,v=!1,x.secondary&&(T=s(a,i[0],x.secondary,!1,T.usedOrig),g=T.name,b=T.locale),x.tertiary&&(T=s(a,i[0],x.tertiary,!1,T.usedOrig),v=T.name,y=T.locale),r&&(d=e(t,a,c,d,r,!0),d&&(d=l(d)),g=e(t,a,!1,g,r,!0),v=e(t,a,!1,v,r,!0));var N,E=n.Util.cloneToken(this),_=n.Util.cloneToken(this);if("locale-translit"===x.primary&&(N=t.opt.citeAffixes[p][x.primary].prefix),"<i>"===N&&"title"===i[0]&&!I){for(var C=!1,S=0,O=_.decorations.length;O>S;S+=1)"@font-style"===_.decorations[S][0]&&"italic"===_.decorations[S][1]&&(C=!0);C||_.decorations.push(["@font-style","italic"])}if("en"!==m&&"title"===_.strings["text-case"]&&(_.strings["text-case"]="passthrough"),"title"===i[0]&&(d=n.demoteNoiseWords(t,d,this["leading-noise-words"])),g||v){if(t.output.openLevel("empty"),_.strings.suffix=_.strings.suffix.replace(/[ .,]+$/,""),t.output.append(d,_),g){secondary_tok=n.Util.cloneToken(E),secondary_tok.strings.prefix=t.opt.citeAffixes[p][x.secondary].prefix,secondary_tok.strings.suffix=t.opt.citeAffixes[p][x.secondary].suffix,secondary_tok.strings.prefix||(secondary_tok.strings.prefix=" ");for(var S=secondary_tok.decorations.length-1;S>-1;S+=-1)["@quotes/true","@font-style/italic","@font-style/oblique","@font-weight/bold"].indexOf(secondary_tok.decorations[S].join("/"))>-1&&(secondary_tok.decorations=secondary_tok.decorations.slice(0,S).concat(secondary_tok.decorations.slice(S+1)));"en"!==b&&"title"===secondary_tok.strings["text-case"]&&(secondary_tok.strings["text-case"]="passthrough"),t.output.append(g,secondary_tok);var A=t.output.current.value(),k=t.output.current.value().blobs.length-1;t.parallel.use_parallels&&(t.parallel.cite.front.push(i[0]+":secondary"),t.parallel.cite[i[0]+":secondary"]={blobs:[[A,k]]})}if(v){tertiary_tok=n.Util.cloneToken(E),tertiary_tok.strings.prefix=t.opt.citeAffixes[p][x.tertiary].prefix,tertiary_tok.strings.suffix=t.opt.citeAffixes[p][x.tertiary].suffix,tertiary_tok.strings.prefix||(tertiary_tok.strings.prefix=" ");for(var S=tertiary_tok.decorations.length-1;S>-1;S+=-1)["@quotes/true","@font-style/italic","@font-style/oblique","@font-weight/bold"].indexOf(tertiary_tok.decorations[S].join("/"))>-1&&(tertiary_tok.decorations=tertiary_tok.decorations.slice(0,S).concat(tertiary_tok.decorations.slice(S+1)));"en"!==y&&"title"===tertiary_tok.strings["text-case"]&&(tertiary_tok.strings["text-case"]="passthrough"),t.output.append(v,tertiary_tok);var A=t.output.current.value(),k=t.output.current.value().blobs.length-1;t.parallel.use_parallels&&(t.parallel.cite.front.push(i[0]+":tertiary"),t.parallel.cite[i[0]+":tertiary"]={blobs:[[A,k]]})}t.output.closeLevel()}else t.output.append(d,_);return null}}function l(e){var i=e.match(/^!([-,_a-z]+)>>>/);if(i){var s=i[1].split(",");e=e.slice(i[0].length);for(var n=0,r=s.length;r>n;n+=1)-1===t.tmp.done_vars.indexOf(s[n])&&t.tmp.done_vars.push(s[n])}return e}this.abbrevs={},this.abbrevs["default"]=new t.sys.AbbreviationSegments,this.getTextSubField=s,this.loadAbbreviation=r,this.getOutputFunction=a,this.quashCheck=l},n.Token=function(t,e){this.name=t,this.strings={},this.strings.delimiter=void 0,this.strings.prefix="",this.strings.suffix="",this.decorations=[],this.variables=[],this.execs=[],this.tokentype=e,this.evaluator=!1,this.tests=[],this.rawtests=[],this.succeed=!1,this.fail=!1,this.next=!1},n.Util.cloneToken=function(t){var e,i,s,r;if("string"==typeof t)return t;e=new n.Token(t.name,t.tokentype);for(i in t.strings)t.strings.hasOwnProperty(i)&&(e.strings[i]=t.strings[i]);if(t.decorations)for(e.decorations=[],s=0,r=t.decorations.length;r>s;s+=1)e.decorations.push(t.decorations[s].slice());return t.variables&&(e.variables=t.variables.slice()),t.execs&&(e.execs=t.execs.slice(),e.tests=t.tests.slice(),e.rawtests=t.tests.slice()),e},n.AmbigConfig=function(){this.maxvals=[],this.minval=1,this.names=[],this.givens=[],this.year_suffix=!1,this.disambiguate=0},n.Blob=function(t,e,i){var s,n,r;if(this.levelname=i,e){this.strings={prefix:"",suffix:""};for(r in e.strings)e.strings.hasOwnProperty(r)&&(this.strings[r]=e.strings[r]);for(this.decorations=[],s=void 0===e.decorations?0:e.decorations.length,n=0;s>n;n+=1)this.decorations.push(e.decorations[n].slice())}else this.strings={},this.strings.prefix="",this.strings.suffix="",this.strings.delimiter="",this.decorations=[];"string"==typeof t?this.blobs=t:t?this.blobs=[t]:this.blobs=[],this.alldecor=[this.decorations]},n.Blob.prototype.push=function(t){if("string"==typeof this.blobs)throw"Attempt to push blob onto string object";!1!==t&&(t.alldecor=t.alldecor.concat(this.alldecor),this.blobs.push(t))},n.NumericBlob=function(t,e,i){this.id=i,this.alldecor=[],this.num=t,this.blobs=t.toString(),this.status=n.START,this.strings={},e?(this.gender=e.gender,this.decorations=e.decorations,this.strings.prefix=e.strings.prefix,this.strings.suffix=e.strings.suffix,this.strings["text-case"]=e.strings["text-case"],this.successor_prefix=e.successor_prefix,this.range_prefix=e.range_prefix,this.splice_prefix=e.splice_prefix,this.formatter=e.formatter,this.formatter||(this.formatter=new n.Output.DefaultFormatter),this.formatter&&(this.type=this.formatter.format(1))):(this.decorations=[],this.strings.prefix="",this.strings.suffix="",this.successor_prefix="",this.range_prefix="",this.splice_prefix="",this.formatter=new n.Output.DefaultFormatter)},n.NumericBlob.prototype.setFormatter=function(t){this.formatter=t,this.type=this.formatter.format(1)},n.Output.DefaultFormatter=function(){},n.Output.DefaultFormatter.prototype.format=function(t){return t.toString()},n.NumericBlob.prototype.checkNext=function(t,e){e?(this.status=n.START,"object"==typeof t&&(t.num===this.num+1?t.status=n.SUCCESSOR:t.status=n.SEEN)):t&&t.num&&this.type===t.type&&t.num===this.num+1?this.status===n.START||this.status===n.SEEN?t.status=n.SUCCESSOR:(this.status===n.SUCCESSOR||this.status===n.SUCCESSOR_OF_SUCCESSOR)&&(this.range_prefix?(t.status=n.SUCCESSOR_OF_SUCCESSOR,this.status=n.SUPPRESS):t.status=n.SUCCESSOR):(this.status===n.SUCCESSOR_OF_SUCCESSOR&&(this.status=n.END),"object"==typeof t&&(t.status=n.SEEN))},n.NumericBlob.prototype.checkLast=function(t){return this.status===n.SEEN||t.num!==this.num-1&&this.status===n.SUCCESSOR?(this.status=n.SUCCESSOR,!0):!1},n.Util.fixDateNode=function(t,e,i){var s,n,r,o,a,l,c,u,h,p,f,d,m,g;this.build.date_key=!0,s=this.sys.xml.getAttributeValue(i,"form");var b;if(b="accessed"===this.sys.xml.getAttributeValue(i,"variable")?this.opt["default-locale"][0]:this.sys.xml.getAttributeValue(i,"lingo"),!this.getDate(s))return t;var v=this.sys.xml.getAttributeValue(i,"date-parts");n=this.sys.xml.getAttributeValue(i,"variable"),u=this.sys.xml.getAttributeValue(i,"prefix"),h=this.sys.xml.getAttributeValue(i,"suffix"),m=this.sys.xml.getAttributeValue(i,"display"),g=this.sys.xml.getAttributeValue(i,"cslid"),r=this.sys.xml.nodeCopy(this.getDate(s,"accessed"===n)),this.sys.xml.setAttribute(r,"lingo",this.opt.lang),this.sys.xml.setAttribute(r,"form",s),this.sys.xml.setAttribute(r,"date-parts",v),this.sys.xml.setAttribute(r,"cslid",g),this.sys.xml.setAttribute(r,"variable",n),u&&this.sys.xml.setAttribute(r,"prefix",u),h&&this.sys.xml.setAttribute(r,"suffix",h),m&&this.sys.xml.setAttribute(r,"display",m),p=this.sys.xml.children(i);for(f in p)if(o=p[f],"date-part"===this.sys.xml.nodename(o)){a=this.sys.xml.getAttributeValue(o,"name"),d=this.sys.xml.attributes(o);for(l in d)if(d.hasOwnProperty(l)){if("@name"===l)continue;if(b&&b!==this.opt.lang&&["@suffix","@prefix","@form"].indexOf(l)>-1)continue;c=d[l],this.sys.xml.setAttributeOnNodeIdentifiedByNameAttribute(r,"date-part",a,l,c)}}return"year"===this.sys.xml.getAttributeValue(i,"date-parts")?(this.sys.xml.deleteNodeByNameAttribute(r,"month"),this.sys.xml.deleteNodeByNameAttribute(r,"day")):"year-month"===this.sys.xml.getAttributeValue(i,"date-parts")&&this.sys.xml.deleteNodeByNameAttribute(r,"day"),this.sys.xml.insertChildNodeAfter(t,i,e,r)},n.dateMacroAsSortKey=function(t,e){n.dateAsSortKey.call(this,t,e,!0)},n.dateAsSortKey=function(t,e,i){var s,r,o,a,l,c,u,h,p=this.variables[0],f="empty";for(i&&(f="macro-with-date"),s=e[p],"undefined"==typeof s&&(s={"date-parts":[[0]]},s.year||(t.tmp.empty_date=!0)),"undefined"==typeof this.dateparts&&(this.dateparts=["year","month","day"]),s.raw?s=t.fun.dateparser.parse(s.raw):s["date-parts"]&&(s=t.dateParseArray(s)),"undefined"==typeof s&&(s={}),u=0,h=n.DATE_PARTS_INTERNAL.length;h>u;u+=1)r=n.DATE_PARTS_INTERNAL[u],o=0,a=r,"_end"===a.slice(-4)&&(a=a.slice(0,-4)),s[r]&&this.dateparts.indexOf(a)>-1&&(o=s[r]),"year"===r.slice(0,4)?(l=n.Util.Dates[a].numeric(t,o),c="Y","-"===l[0]&&(c="X",l=l.slice(1),l=9999-parseInt(l,10)),t.output.append(n.Util.Dates[r.slice(0,4)].numeric(t,c+l),f)):(o=n.Util.Dates[a]["numeric-leading-zeros"](t,o),o||(o="00"),t.output.append(o,f))},n.Engine.prototype.dateParseArray=function(t){var e,i,s,r;e={};for(i in t)if("date-parts"===i){s=t["date-parts"],s.length>1&&s[0].length!==s[1].length&&n.error("CSL data error: element mismatch in date range input."),r=["","_end"];for(var o=0,a=s.length;a>o;o+=1)for(var l=0,c=n.DATE_PARTS.length;c>l;l+=1)"undefined"==typeof s[o][l]?e[n.DATE_PARTS[l]+r[o]]=s[o][l]:e[n.DATE_PARTS[l]+r[o]]=parseInt(s[o][l],10)}else t.hasOwnProperty(i)&&("literal"===i&&"object"==typeof t.literal&&"string"==typeof t.literal.part?(n.debug("Warning: fixing up weird literal date value"),e.literal=t.literal.part):e[i]=t[i]);return e},n.Util.Names={},n.Util.Names.compareNamesets=n.NameOutput.prototype._compareNamesets,n.Util.Names.unInitialize=function(t,e){var i,s,r,o,a;if(!e)return"";for(r=e.split(/(?:\-|\s+)/),o=e.match(/(\-|\s+)/g),a="",i=0,s=r.length;s>i;i+=1)n.ALL_ROMANESQUE_REGEXP.exec(r[i].slice(0,-1))&&r[i]&&r[i]!==r[i].toUpperCase()&&(r[i]=r[i].slice(0,1)+r[i].slice(1,2).toLowerCase()+r[i].slice(2)),a+=r[i],s-1>i&&(a+=o[i]);return a},n.Util.Names.initializeWith=function(t,e,i,s){var r,o,a,l,c,u,h;if(!e)return"";if(["Lord","Lady"].indexOf(e)>-1||!e.match(n.STARTSWITH_ROMANESQUE_REGEXP)&&!i.match("%s"))return e;i||(i="");var p=e;if(t.opt["initialize-with-hyphen"]===!1&&(p=p.replace(/\-/g," ")),p=p.replace(/\s*\-\s*/g,"-").replace(/\s+/g," "),p=p.replace(/-([a-z])/g,"–$1"),c=p.match(/[\-\s]+/g),u=p.split(/[\-\s]+/),0===u.length)p=c;else for(p=[u[0]],r=1,o=u.length;o>r;r+=1)p.push(c[r-1]),p.push(u[r]);for(u=p,r=u.length-1;r>-1;r+=-1)if(u[r]&&u[r].slice(0,-1).indexOf(".")>-1){var f=u.slice(r+1),d=u[r].slice(0,-1).split(".");for(u=u.slice(0,r),a=0,l=d.length;l>a;a+=1)u.push(d[a]+"."),a<d.length-1&&u.push(" ");u=u.concat(f)}return h=s?n.Util.Names.doNormalize(t,u,i):n.Util.Names.doInitialize(t,u,i),h=h.replace(/\u2013([a-z])/g,"-$1")},n.Util.Names.doNormalize=function(t,e,i,s){var r,o,a=[];for(r=0,o=e.length;o>r;r+=1)e[r].length>1&&"."===e[r].slice(-1)?(e[r]=e[r].slice(0,-1),a.push(!0)):1===e[r].length&&e[r].toUpperCase()===e[r]?a.push(!0):a.push(!1);for(r=0,o=e.length;o>r;r+=2)a[r]&&(r<e.length-2&&(e[r+1]="",(!i||i.slice(-1)&&" "!==i.slice(-1))&&e[r].length&&e[r].match(n.ALL_ROMANESQUE_REGEXP)&&(e[r].length>1||e[r+2].length>1)&&(e[r+1]=" "),e[r]=e[r]+i),r===e.length-1&&(e[r]=e[r]+i));return e.join("").replace(/\s+$/,"")},n.Util.Names.doInitialize=function(t,e,i,s){var r,o,a,l,c,u,h;for(r=0,o=e.length;o>r;r+=2)if(h=e[r])if(a=h.match(n.NAME_INITIAL_REGEXP),!a&&!h.match(n.STARTSWITH_ROMANESQUE_REGEXP)&&h.length>1&&i.match("%s")&&(a=h.match(/(.)(.*)/)),a&&a[1]===a[1].toUpperCase()){var p="";if(a[2]){var f="";for(u=a[2].split(""),l=0,c=u.length;c>l;l+=1){var d=u[l];if(d!==d.toUpperCase())break;f+=d}f.length<a[2].length&&(p=f.toLocaleLowerCase())}e[r]=a[1].toLocaleUpperCase()+p,o-1>r?i.match("%s")?e[r]=i.replace("%s",e[r]):e[r+1].indexOf("-")>-1?e[r+1]=i+e[r+1]:e[r+1]=i:i.match("%s")?e[r]=i.replace("%s",e[r]):e.push(i)}else h.match(n.ROMANESQUE_REGEXP)&&(e[r]=" "+h);var m=e.join("");return m=m.replace(/\s+$/,"").replace(/\s*\-\s*/g,"-").replace(/\s+/g," ")},n.Util.Names.getRawName=function(t){var e=[];return t.given&&e.push(t.given),t.family&&e.push(t.family),e.join(" ")},n.Util.Dates={},n.Util.Dates.year={},n.Util.Dates.year["long"]=function(t,e){return e||(e="boolean"==typeof e?"":0),e.toString()},n.Util.Dates.year.imperial=function(t,e,i,s){e||(e="boolean"==typeof e?"":0),i=i?"_end":"";var n=t.tmp.date_object["month"+i];for(n=n?""+n:"1";n.length<2;)n="0"+n;var r=t.tmp.date_object["day"+i];for(r=r?""+r:"1";r.length<2;)r="0"+r;var o,a,l=parseInt(e+n+r,10);return l>=18680908&&19120730>l?(o="明治",a=1867):l>=19120730&&19261225>l?(o="大正",a=1911):l>=19261225&&19890108>l?(o="昭和",a=1925):l>=19890108&&(o="平成",a=1988),o&&a&&(t.transform.abbrevs["default"].number[o]||t.transform.loadAbbreviation("default","number",o),t.transform.abbrevs["default"].number[o]&&(o=t.transform.abbrevs["default"].number[o]),year=o+(e-a)),year},n.Util.Dates.year["short"]=function(t,e){return e=e.toString(),e&&4===e.length?e.substr(2):void 0},n.Util.Dates.year.numeric=function(t,e){var i,s;for(e=""+e,i=e.match(/([0-9]*)$/),i?(s=e.slice(0,-1*i[1].length),e=i[1]):(s=e,e="");e.length<4;)e="0"+e;return s+e},n.Util.Dates.normalizeMonth=function(t,e){var i;if(t||(t=0),t=""+t,t.match(/^[0-9]+$/)||(t=0),t=parseInt(t,10),e){var s={stub:"month-",num:t};s.num<1||s.num>20?s.num=0:s.num>16?(s.stub="season-",s.num=s.num-16):s.num>12&&(s.stub="season-",s.num=s.num-12),i=s}else(1>t||t>12)&&(t=0),i=t;return i},n.Util.Dates.month={},n.Util.Dates.month.numeric=function(t,e){var e=n.Util.Dates.normalizeMonth(e);return e||(e=""),e},n.Util.Dates.month["numeric-leading-zeros"]=function(t,e){var e=n.Util.Dates.normalizeMonth(e);if(e)for(e=""+e;e.length<2;)e="0"+e;else e="";return e},n.Util.Dates.month["long"]=function(t,e,i,s){var r=n.Util.Dates.normalizeMonth(e,!0),e=r.num;if(e){for(e=""+e;e.length<2;)e="0"+e;e=t.getTerm(r.stub+e,"long",0,0,!1,s)}else e="";return e},n.Util.Dates.month["short"]=function(t,e,i,s){var r=n.Util.Dates.normalizeMonth(e,!0),e=r.num;if(e){for(e=""+e;e.length<2;)e="0"+e;e=t.getTerm(r.stub+e,"short",0,0,!1,s)}else e="";return e},n.Util.Dates.day={},n.Util.Dates.day.numeric=function(t,e){return e.toString()},n.Util.Dates.day["long"]=n.Util.Dates.day.numeric,n.Util.Dates.day["numeric-leading-zeros"]=function(t,e){for(e||(e=0),e=e.toString();e.length<2;)e="0"+e;return e.toString()},n.Util.Dates.day.ordinal=function(t,e,i){return t.fun.ordinalizer.format(e,i)},n.Util.Sort={},n.Util.Sort.strip_prepositions=function(t){var e;return"string"==typeof t&&(e=t.toLocaleLowerCase(),e=t.match(/^((a|an|the)\s+)/)),e&&(t=t.substr(e[1].length)),t},n.Util.substituteStart=function(t,e){var i,s,r,o,a,l,c;o=function(t,e){for(var i=0,s=this.decorations.length;s>i;i+=1)if("@strip-periods"===this.decorations[i][0]&&"true"===this.decorations[i][1]){t.tmp.strip_periods+=1;break}},this.execs.push(o),this.decorations&&(t.opt.development_extensions.csl_reverse_lookup_support||t.sys.csl_reverse_lookup_support)&&(this.decorations.reverse(),this.decorations.push(["@showid","true",this.cslid]),this.decorations.reverse()),c=["number","date","names"],("text"===this.name&&!this.postponed_macro||c.indexOf(this.name)>-1)&&(i=function(t,e,i){"author"===t.tmp.element_trace.value()||"names"===this.name?i&&i["author-only"]?t.tmp.element_trace.push("do-not-suppress-me"):i&&i["suppress-author"]:i&&i["author-only"]?t.tmp.element_trace.push("suppress-me"):i&&i["suppress-author"]&&t.tmp.element_trace.push("do-not-suppress-me")},this.execs.push(i)),s=this.strings.cls,this.strings.cls=!1,0===t.build.render_nesting_level&&("bibliography"===t.build.area&&t.bibliography.opt["second-field-align"]?(r=new n.Token("group",n.START),r.decorations=[["@display","left-margin"]],o=function(t,e){t.tmp.render_seen||(r.strings.first_blob=e.id,t.output.startTag("bib_first",r))},r.execs.push(o),e.push(r)):n.DISPLAY_CLASSES.indexOf(s)>-1&&(r=new n.Token("group",n.START),r.decorations=[["@display",s]],o=function(t,e){r.strings.first_blob=e.id,t.output.startTag("bib_first",r)},r.execs.push(o),e.push(r)),t.build.cls=s),t.build.render_nesting_level+=1,1===t.build.substitute_level.value()&&(a=new n.Token("choose",n.START),n.Node.choose.build.call(a,t,e),l=new n.Token("if",n.START),o=function(e,i){return t.tmp.can_substitute.value()?!0:!1},l.tests.push(o),l.test=t.fun.match.any(this,t,l.tests),e.push(l)),t.sys.variableWrapper&&this.variables_real&&this.variables_real.length&&(o=function(t,e,i){if(!t.tmp.just_looking&&!t.tmp.suppress_decorations){variable_entry=new n.Token("text",n.START),variable_entry.decorations=[["@showid","true"]],t.output.startTag("variable_entry",variable_entry);var s=null;i&&(s=i.position),s||(s=0);var r=["first","subsequent","ibid","ibid-with-locator"],o=0;i&&i.noteIndex&&(o=i.noteIndex);var a=0;i&&i["first-reference-note-number"]&&(a=i["first-reference-note-number"]);var l=0;i&&i["citation-number"]&&(l=i["citation-number"]);var c=0;i&&i.index&&(c=i.index);var u={itemData:e,variableNames:this.variables,context:t.tmp.area,xclass:t.opt.xclass,position:r[s],"note-number":o,"first-reference-note-number":a,"citation-number":l,index:c,mode:t.opt.mode};t.output.current.value().params=u}},this.execs.push(o))},n.Util.substituteEnd=function(t,e){var i,s,r,o,a,l,c,u,h;t.sys.variableWrapper&&(this.hasVariable||this.variables_real&&this.variables_real.length)&&(i=function(t,e){t.tmp.just_looking||t.tmp.suppress_decorations||t.output.endTag("variable_entry")},this.execs.push(i)),i=function(t,e){for(var i=0,s=this.decorations.length;s>i;i+=1)if("@strip-periods"===this.decorations[i][0]&&"true"===this.decorations[i][1]){t.tmp.strip_periods+=-1;break}},this.execs.push(i),t.build.render_nesting_level+=-1,0===t.build.render_nesting_level&&(t.build.cls?(i=function(t,e){t.output.endTag("bib_first")},this.execs.push(i),t.build.cls=!1):"bibliography"===t.build.area&&t.bibliography.opt["second-field-align"]&&(s=new n.Token("group",n.END),i=function(t,e){t.tmp.render_seen||t.output.endTag()},s.execs.push(i),e.push(s),r=new n.Token("group",n.START),r.decorations=[["@display","right-inline"]],i=function(t,e){t.tmp.render_seen||(t.tmp.render_seen=!0,t.output.startTag("bib_other",r))},r.execs.push(i),e.push(r))),1===t.build.substitute_level.value()&&(o=new n.Token("if",n.END),e.push(o),a=new n.Token("choose",n.END),n.Node.choose.build.call(a,t,e)),l="names"===this.name&&0===t.build.substitute_level.value(),c="string"==typeof t[t.build.area].opt["subsequent-author-substitute"];var p=t[t.build.area].opt["subsequent-author-substitute-rule"];l&&c&&(u=new n.Token("text",n.SINGLETON),i=function(t,e){var i,s,r=!t.tmp.suppress_decorations;if(r&&"bibliography"===t.tmp.area&&t.tmp.subsequent_author_substitute_ok&&t.tmp.rendered_name)if("partial-each"===p||"partial-first"===p){var o=!0,a=[];for(i=0,s=t.tmp.name_node.children.length;s>i;i+=1){var l=t.tmp.rendered_name[i];o&&t.tmp.last_rendered_name&&t.tmp.last_rendered_name.length>i-1&&l&&!l.localeCompare(t.tmp.last_rendered_name[i])?(h=new n.Blob(t[t.tmp.area].opt["subsequent-author-substitute"]),t.tmp.name_node.children[i].blobs=[h],"partial-first"===p&&(o=!1)):o=!1,a.push(l)}t.tmp.last_rendered_name=a}else if("complete-each"===p){var a=t.tmp.rendered_name.join(",");if(a){if(!a.localeCompare(t.tmp.last_rendered_name))for(i=0,s=t.tmp.name_node.children.length;s>i;i+=1)h=new n.Blob(t[t.tmp.area].opt["subsequent-author-substitute"]),t.tmp.name_node.children[i].blobs=[h];t.tmp.last_rendered_name=a}}else{var a=t.tmp.rendered_name.join(",");a&&(a.localeCompare(t.tmp.last_rendered_name)||(h=new n.Blob(t[t.tmp.area].opt["subsequent-author-substitute"]),t.tmp.label_blob?t.tmp.name_node.top.blobs=[h,t.tmp.label_blob]:t.tmp.name_node.top.blobs=[h]),t.tmp.last_rendered_name=a)}},u.execs.push(i),e.push(u)),("text"===this.name&&!this.postponed_macro||["number","date","names"].indexOf(this.name)>-1)&&(i=function(t,e){t.tmp.element_trace.pop()},this.execs.push(i))},n.Util.padding=function(t){var e=t.match(/\s*(-{0,1}[0-9]+)/);if(e)for(t=parseInt(e[1],10),0>t&&(t=1e20+t),t=""+t;t.length<20;)t="0"+t;return t},n.Util.LongOrdinalizer=function(){},n.Util.LongOrdinalizer.prototype.init=function(t){this.state=t},n.Util.LongOrdinalizer.prototype.format=function(t,e){10>t&&(t="0"+t);var i=n.Engine.getField(n.LOOSE,this.state.locale[this.state.opt.lang].terms,"long-ordinal-"+t,"long",0,e);return i||(i=this.state.fun.ordinalizer.format(t,e)),this.state.tmp.cite_renders_content=!0,i},n.Util.Ordinalizer=function(t){this.state=t,this.suffixes={}},n.Util.Ordinalizer.prototype.init=function(){if(!this.suffixes[this.state.opt.lang]){this.suffixes[this.state.opt.lang]={};for(var t=0,e=3;e>t;t+=1){var i=[void 0,"masculine","feminine"][t];this.suffixes[this.state.opt.lang][i]=[];for(var s=1;5>s;s+=1){var n=this.state.getTerm("ordinal-0"+s,"long",!1,i);if("undefined"==typeof n){delete this.suffixes[this.state.opt.lang][i];break}this.suffixes[this.state.opt.lang][i].push(n)}}}},n.Util.Ordinalizer.prototype.format=function(t,e){var i;t=parseInt(t,10),i=""+t;var s="",n=[];if(e&&n.push(e),n.push("neuter"),this.state.locale[this.state.opt.lang].ord["1.0.1"]){s=this.state.getTerm("ordinal",!1,0,e);for(var r,o=0,a=n.length;a>o;o+=1){r=n[o];var l=this.state.locale[this.state.opt.lang].ord["1.0.1"];if(l["whole-number"][i]&&l["whole-number"][i][r]?s=this.state.getTerm(this.state.locale[this.state.opt.lang].ord["1.0.1"]["whole-number"][i][r],!1,0,e):l["last-two-digits"][i.slice(i.length-2)]&&l["last-two-digits"][i.slice(i.length-2)][r]?s=this.state.getTerm(this.state.locale[this.state.opt.lang].ord["1.0.1"]["last-two-digits"][i.slice(i.length-2)][r],!1,0,e):l["last-digit"][i.slice(i.length-1)]&&l["last-digit"][i.slice(i.length-1)][r]&&(s=this.state.getTerm(this.state.locale[this.state.opt.lang].ord["1.0.1"]["last-digit"][i.slice(i.length-1)][r],!1,0,e)),s)break}}else e||(e=void 0),this.state.fun.ordinalizer.init(),s=t/10%10===1||t>10&&20>t?this.suffixes[this.state.opt.lang][e][3]:t%10===1&&t%100!==11?this.suffixes[this.state.opt.lang][e][0]:t%10===2&&t%100!==12?this.suffixes[this.state.opt.lang][e][1]:t%10===3&&t%100!==13?this.suffixes[this.state.opt.lang][e][2]:this.suffixes[this.state.opt.lang][e][3];return i=i+=s},n.Util.Romanizer=function(){},n.Util.Romanizer.prototype.format=function(t){var e,i,s,r,o;if(e="",6e3>t)for(r=t.toString().split(""),r.reverse(),i=0,s=0,o=r.length,i=0;o>i;i+=1)s=parseInt(r[i],10),e=n.ROMAN_NUMERALS[i][s]+e;return e},n.Util.Suffixator=function(t){t||(t=n.SUFFIX_CHARS),this.slist=t.split(",")},n.Util.Suffixator.prototype.format=function(t){var e;t+=1;var i="";do e=t%26===0?26:t%26,i=this.slist[e-1]+i,t=(t-e)/26;while(0!==t);return i},n.Engine.prototype.processNumber=function(t,e,i,s){var r,o,a,l,c,u;if(this.tmp.shadow_numbers[i]){if(this.tmp.shadow_numbers[i].numeric)for(var a=0,l=this.tmp.shadow_numbers[i].values.length;l>a;a+=2)this.tmp.shadow_numbers[i].values[a][2]=t}else if(this.tmp.shadow_numbers[i]={},this.tmp.shadow_numbers[i].values=[],this.tmp.shadow_numbers[i].plural=0,this.tmp.shadow_numbers[i].numeric=!1,this.tmp.shadow_numbers[i].label=!1,e){var h=n.LangPrefsMap[i];if(h){var p=this.opt["cite-lang-prefs"][h][0];r=this.transform.getTextSubField(e,i,"locale-"+p,!0),r=r.name}else r=e[i];if(r&&this.sys.getAbbreviation){r=(""+r).replace(/^\"/,"").replace(/\"$/,"");var f=this.transform.loadAbbreviation(e.jurisdiction,"number",r);this.transform.abbrevs[f].number[r]?r=this.transform.abbrevs[f].number[r]:"undefined"!=typeof this.transform.abbrevs[f].number[r]&&delete this.transform.abbrevs[f].number[r]}if("undefined"!=typeof r){if("number"==typeof r&&(r=""+r),this.tmp.shadow_numbers[i].label=i,'"'===r.slice(0,1)&&'"'===r.slice(-1)&&(r=r.slice(1,-1)),r&&["number-of-volumes","number-of-pages"].indexOf(i)>-1){var o=r.match(/[^0-9]*([0-9]+).*/);
o&&(this.tmp.shadow_numbers[i].numeric=!0,"1"!==o[1]&&(this.tmp.shadow_numbers[i].plural=1))}"locator"===i&&["bill","gazette","legislation","treaty"].indexOf(s)>-1&&(r=r.split(n.STATUTE_SUBDIV_PLAIN_REGEX)[0]);var d="page";if(["bill","gazette","legislation","legal_case","treaty"].indexOf(s)>-1&&"collection-number"===i&&(d="year"),["page","page-first"].indexOf(i)>-1){var o=r.split(" ")[0].match(n.STATUTE_SUBDIV_GROUPED_REGEX);if(o){this.opt.development_extensions.static_statute_locator&&(this.tmp.shadow_numbers[i].label=n.STATUTE_SUBDIV_STRINGS[o[0]]);var m=r.match(/[^ ]+\s+(.*)/);m&&(r=m[1])}}for(var g=r.split(/(?:,\s+|\s*\\*[\-\u2013]+\s*|\s*&\s*)/),o=r.match(/(,\s+|\s*\\*[\-\u2013]+\s*|\s*&\s*)/g),b=[],a=0,l=g.length-1;l>a;a+=1)b.push(g[a]),b.push(o[a]);b.push(g[g.length-1]);for(var v=0,y=!0,a=0,l=b.length;l>a;a+=1){var _=a%2===0;if(_){if(b[a]){if(b[a].match(/(?:[0-9]|[xivcmlXIVCML])/))if(b[a-1]&&b[a-1].match(/^\s*\\*[\-\u2013]+\s*$/)){var x=this.tmp.shadow_numbers[i].values.slice(-1);if(-1==x[0][1].indexOf("\\")){if(b[a-2]&&(""+b[a-2]).match(/(:?[a-zA-Z]*[0-9]+$|^[ivxlcmIVXLCM]+$)/)&&b[a].match(/(?:^[a-zA-Z]*[0-9]+|^[ivxlcmIVXLCM]+$)/)){var w=this.tmp.shadow_numbers[i].values.slice(-2);if(x[0][1]=this.getTerm(d+"-range-delimiter"),this.opt[d+"-range-format"]){var S=this.fun[d+"_mangler"](w[0][1]+"-"+b[a]);S=S.split(this.getTerm(d+"-range-delimiter")),b[a]=S[1]}v+=1}x[0][1].indexOf("--")>-1&&(x[0][1]=x[0][1].replace(/--*/,"–"))}else x[0][1]=x[0][1].replace(/\\/,"","g")}else-1===b[a].indexOf(" ")&&(v+=1);for(var O=b[a].split(/\s+/),c=0,u=O.length;u>c;c+=1)this.opt.development_extensions.strict_page_numbers&&"page"===i&&!O[c].match(/^-*[0-9]/)?y=!1:O[c].match(/[-0-9]/)||(y=!1);if(b[a].match(/^[1-9][0-9]*$/))b[a]=parseInt(b[a],10),t&&"undefined"==typeof t.gender&&(t.gender=this.locale[this.opt.lang]["noun-genders"][i],t.gender||(t.gender="")),this.tmp.shadow_numbers[i].values.push(["NumericBlob",b[a],t]);else{var T=b[a];this.tmp.shadow_numbers[i].values.push(["Blob",T,t])}}}else b[a]&&this.tmp.shadow_numbers[i].values.push(["Blob",b[a],void 0])}this.opt.development_extensions.strict_page_numbers&&"page"===i?-1===r.indexOf(" ")&&r.match(/^-*[0-9]/)?this.tmp.shadow_numbers[i].numeric=!0:this.tmp.shadow_numbers[i].numeric=y:-1===r.indexOf(" ")&&r.match(/[0-9]/)?this.tmp.shadow_numbers[i].numeric=!0:this.tmp.shadow_numbers[i].numeric=y,this.tmp.shadow_numbers[i].numeric||this.transform.loadAbbreviation(e.jurisdiction,"number",r),v>1&&(this.tmp.shadow_numbers[i].plural=1),1===e.force_pluralism?this.tmp.shadow_numbers[i].plural=1:0===e.force_pluralism&&(this.tmp.shadow_numbers[i].plural=0)}}},n.Util.PageRangeMangler={},n.Util.PageRangeMangler.getFunction=function(t,e){var i,s,n,r,o,a,l,c,u,h,p,f,d,m,g,b,v,y=t.getTerm(e+"-range-delimiter");i=/([a-zA-Z]*)([0-9]+)\s*(?:\u2013|-)\s*([a-zA-Z]*)([0-9]+)/,r=function(i){for(n=i.length,s=1;n>s;s+=2)"object"==typeof i[s]&&(i[s]=i[s].join(""));var r=i.join("");return r=r.replace(/([^\\])\-/g,"$1"+t.getTerm(e+"-range-delimiter"))},o=function(t){var e,i,r,o="\\s+\\-\\s+",a=new RegExp("([^\\\\])["+y+"\\u2013]","g");t=t.replace(a,"$1 - ").replace(/\s+-\s+/g," - ");var l=new RegExp("([a-zA-Z]*[0-9]+"+o+"[a-zA-Z]*[0-9]+)","g"),c=new RegExp("[a-zA-Z]*[0-9]+"+o+"[a-zA-Z]*[0-9]+");if(e=t.match(l),i=t.split(c),0===i.length)r=e;else for(r=[i[0]],s=1,n=i.length;n>s;s+=1)r.push(e[s-1].replace(/\s*\-\s*/,"-","g")),r.push(i[s]);return r},a=function(t){for(t=""+t,h=o(t),n=h.length,s=1;n>s;s+=2)p=h[s].match(i),p&&(p[3]&&p[1]!==p[3]||(p[4].length<p[2].length&&(p[4]=p[2].slice(0,p[2].length-p[4].length)+p[4]),parseInt(p[2],10)<parseInt(p[4],10)&&(p[3]=y+p[1],h[s]=p.slice(1)))),"string"==typeof h[s]&&(h[s]=h[s].replace("-",y,"g"));return h},l=function(t,e,i){n=t.length;for(var s=1,o=t.length;o>s;s+=2)t[s][3]=c(t[s][1],t[s][3],e,i),t[s][2].slice(1)===t[s][0]&&(t[s][2]=y);return r(t)},c=function(t,e,i,s){if(i||(i=0),f=(""+t).split(""),d=(""+e).split(""),m=d.slice(),m.reverse(),f.length===d.length)for(var n=0,r=f.length;r>n;n+=1){if(!(f[n]===d[n]&&m.length>i)){if(i&&s&&3===m.length){var o=f.slice(0,n);o.reverse(),m=m.concat(o)}break}m.pop()}return m.reverse(),m.join("")},u=function(t){for(n=t.length,s=1;n>s;s+=2)"object"==typeof t[s]&&(p=t[s],g=parseInt(p[1],10),b=parseInt(p[3],10),g>100&&g%100&&parseInt(g/100,10)===parseInt(b/100,10)?p[3]=""+b%100:g>=1e4&&(p[3]=""+b%1e3)),p[2].slice(1)===p[0]&&(p[2]=y);return r(t)};var _=function(t,e,i,s){var n;t=""+t;var r=a(t),n=e(r,i,s);return n};return t.opt[e+"-range-format"]?"expanded"===t.opt[e+"-range-format"]?v=function(t){return _(t,r)}:"minimal"===t.opt[e+"-range-format"]?v=function(t){return _(t,l)}:"minimal-two"===t.opt[e+"-range-format"]?v=function(t,e){return _(t,l,2,e)}:"chicago"===t.opt[e+"-range-format"]&&(v=function(t){return _(t,u)}):v=function(t){return t},v},n.Util.FlipFlopper=function(t){var e,i,s,n,r,o,a,l,c,u,h,p,f,d,m,g,b,v;for(this.state=t,this.blob=!1,this.quotechars=['"',"'"],e=[["<i>","</i>","italics","@font-style",["italic","normal","normal"],!0],["<b>","</b>","bold","@font-weight",["bold","normal","normal"],!0],["<sup>","</sup>","superscript","@vertical-align",["sup","sup","baseline"],!0],["<sub>","</sub>","subscript","@vertical-align",["sub","sub","baseline"],!0],["<sc>","</sc>","smallcaps","@font-variant",["small-caps","small-caps","normal"],!0],['<span style="font-variant:small-caps;">',"</span>","smallcaps","@font-variant",["small-caps","normal","normal"],!0],['<span class="nocase">',"</span>","passthrough","@passthrough",["true","true","true"],!0],['<span class="nodecor">',"</span>","passthrough","@passthrough",["true","true","true"],!0],['"','"',"quotes","@quotes",["true","inner","true"],"'"],[" '","'","quotes","@quotes",["inner","true","true"],'"']],i=0;2>i;i+=1){n=["-","-inner-"][i],r=[];var y=t.getTerm("open"+n+"quote");r.push(y),this.quotechars.push(y);var _=t.getTerm("close"+n+"quote");r.push(_),this.quotechars.push(_),r.push("quotes"),r.push("@quotes"),"-"===n?r.push(["true","inner"]):r.push(["inner","true"]),r.push(!0),"-"===n?r.push(t.getTerm("close-inner-quote")):r.push(t.getTerm("close-quote")),e.push(r)}for(o=function(t){for(a=[],s=t.length,i=0;s>i;i+=1)l=t[i],-1===a.indexOf(l[0])&&(c="",["(",")","[","]"].indexOf(l[0])>-1&&(c="\\"),a.push(c+l[0])),-1===a.indexOf(l[1])&&(c="",["(",")","[","]"].indexOf(l[1])>-1&&(c="\\"),a.push(c+l[1]));return a},b=o(e),v=[],i=0,s=b.length;s>i;i+=1)b[i]&&v.push(b[i]);b=v.slice(),this.allTagsRexMatch=new RegExp("("+b.join("|")+")","g"),this.allTagsRexSplit=new RegExp("(?:"+b.join("|")+")"),u=function(t){for(h={},p={},f={},d={},m={},s=t.length,i=0;s>i;i+=1)h[t[i][1]]=!0,p[t[i][1]]=t[i][5],f[t[i][0]]=t[i][1],d[t[i][0]]=[t[i][3],t[i][4]],m[t[i][3]]=[t[i][3],[t[i][4][2],t[i][1]]];return[h,p,f,d,m]},g=u(e),this.closeTagsHash=g[0],this.flipTagsHash=g[1],this.openToCloseHash=g[2],this.openToDecorations=g[3],this.okReverseHash=g[4]},n.Util.FlipFlopper.prototype.init=function(t,e){this.txt_esc=n.getSafeEscape(this.state),e?(this.blob=e,this.strs=this.getSplitStrings(this.blob.blobs),this.blob.blobs=[]):(this.strs=this.getSplitStrings(t),this.blob=new n.Blob),this.blobstack=new n.Stack(this.blob)},n.Util.FlipFlopper.prototype._normalizeString=function(t){var e,i;if(t=t.replace(/\s+'\s+/," â€™ ","g"),t.indexOf(this.quotechars[0])>-1)for(e=0,i=2;i>e;e+=1)this.quotechars[e+2]&&(t=t.replace(this.quotechars[e+2],this.quotechars[0]));if(t.indexOf(this.quotechars[1])>-1)for(e=0,i=2;i>e;e+=1)this.quotechars[e+4]&&(t=0===e?t.replace(this.quotechars[e+4]," "+this.quotechars[1]):t.replace(this.quotechars[e+4],this.quotechars[1]));return t},n.Util.FlipFlopper.prototype.getSplitStrings=function(t){var e,i,s,n,r,o,a,l,c,u,h,p,f,d,m,g,b,v,y,_,x,w,S,O,T,I,N,E,C;for(t=this._normalizeString(t),E=t.match(this.allTagsRexMatch),e=t.split(this.allTagsRexSplit),C=[e[0]],i=1,s=e.length;s>i;i+=1)C.push(E[i-1]),C.push(e[i]);for(e=C.slice(),s=e.length-2,i=s;i>0;i+=-2)"\\"===e[i-1].slice(e[i-1].length-1)&&(n=e[i-1].slice(0,e[i-1].length-1)+e[i]+e[i+1],r=e.slice(0,i-1),o=e.slice(i+2),r.push(n),e=r.concat(o));for(a=[],l=[],c=[],u=[],h=[],O=e.length-1,p=1;O>p;p+=2)if(g=e[p],this.closeTagsHash[g]&&(a.reverse(),f=this.openToCloseHash[g],d=a.indexOf(g),m=c.indexOf(g),a.reverse(),!f||d>-1&&(m>d||-1===m))){for(b=!1,T=a.length-1,v=T;v>-1;v+=-1){if(b=!0,y=a[v],g===y){a.pop(),l.pop(),c.pop(),u.pop();break}h.push(p)}b||h.push(p)}else this.openToCloseHash[g]&&(a.push(this.openToCloseHash[g]),l.push(g),c.push(this.flipTagsHash[g]),u.push(p));for(I=a.length-1,_=I;_>-1;_+=-1)a.pop(),c.pop(),l.pop(),h.push(u.pop());for(h.sort(function(t,e){return e>t?1:t>e?-1:0}),s=h.length,i=0;s>i;i+=1)N=h[i],r=e.slice(0,N-1),o=e.slice(N+2),x=e[N],x.length&&"<"!==x[0]&&this.openToDecorations[x]&&-1===this.quotechars.indexOf(x.replace(/\s+/g,""))&&(S=this.openToDecorations[x],x=this.state.fun.decorate[S[0]][S[1][0]](this.state)),w=e[N-1]+x+e[N+1],r.push(w),e=r.concat(o);for(s=e.length,i=0;s>i;i+=2)e[i]=e[i].replace("'","’","g"),e[i]=e[i].replace("  ’"," ’","g");return e},n.Util.FlipFlopper.prototype.processTags=function(){var t,e,i,s,r,o,a,l,c,u,h,p,f,d,m,g,b,v,y,_,x,w,S,O;if(t=[],e=[],i=[],s=[],r="",1===this.strs.length)this.blob.blobs=this.strs[0];else if(this.strs.length>2){for(x=this.strs.length-1,o=1;x>o;o+=2)if(a=this.strs[o],l=this.strs[o-1],l&&(c=new n.Blob(l),u=this.blobstack.value(),u.push(c)),this.closeTagsHash[a]&&(t.reverse(),h=this.openToCloseHash[a],p=t.indexOf(a),f=i.indexOf(a),t.reverse(),!h||p>-1&&(f>p||-1===f))){for(w=t.length,d=w;d>-1;d+=-1)if(m=t[d],a===m){t.pop(),e.pop(),i.pop(),s.pop(),this.blobstack.pop();break}}else if(this.openToCloseHash[a]){if(t.push(this.openToCloseHash[a]),e.push(a),i.push(this.flipTagsHash[a]),u=this.blobstack.value(),g=new n.Blob,u.push(g),b=this.addFlipFlop(g,this.openToDecorations[a]),'<span class="nodecor">'===a)for(v=this.state[this.state.tmp.area].opt.topdecor.concat(this.blob.alldecor).concat([[["@quotes","inner"]]]),w=v.length,d=0;w>d;d+=1)for(y=v[d],O=y.length,S=0;O>S;S+=1)_=y[S],["@font-style","@font-weight","@font-variant"].indexOf(_[0])>-1&&(b=this.addFlipFlop(g,this.okReverseHash[_[0]]));s.push(this.state.fun.decorate[b[0]][b[1]](this.state)),this.blobstack.push(g)}this.strs.length>2&&(r=this.strs[this.strs.length-1],r&&(u=this.blobstack.value(),c=new n.Blob(r),u.push(c)))}return this.blob},n.Util.FlipFlopper.prototype.addFlipFlop=function(t,e){var i,s,n,r,o,a,l,c,u,h;for(s=0,n=this.state[this.state.tmp.area].opt.topdecor.concat(t.alldecor).concat([[["@quotes","inner"]]]),r=n.length,i=0;r>i;i+=1){for(o=n[i],a=!1,h=o.length-1,c=h;c>-1;c+=-1)if(l=o[c],l[0]===e[0]){l[1]===e[1][0]&&(s=1),a=!0;break}if(a)break}return u=[e[0],e[1][s]],t.decorations.reverse(),t.decorations.push(u),t.decorations.reverse(),u},n.Output.Formatters={},n.getSafeEscape=function(t){if(["bibliography","citation"].indexOf(t.tmp.area)>-1){var e=[];return t.opt.development_extensions.thin_non_breaking_space_html_hack&&"html"===t.opt.mode&&e.push(function(t){return t.replace(/\u202f/g,'<span style="white-space:nowrap">&thinsp;</span>')}),e.length?function(i){for(var s=0,r=e.length;r>s;s+=1)i=e[s](i);return n.Output.Formats[t.opt.mode].text_escape(i)}:n.Output.Formats[t.opt.mode].text_escape}return function(t){return t}},n.Output.Formatters.passthrough=function(t,e){return e},n.Output.Formatters.lowercase=function(t,e){var i=n.Output.Formatters.doppelString(e,n.TAG_USEALL);return i.string=i.string.toLowerCase(),n.Output.Formatters.undoppelString(i)},n.Output.Formatters.uppercase=function(t,e){var i=n.Output.Formatters.doppelString(e,n.TAG_USEALL);return i.string=i.string.toUpperCase(),n.Output.Formatters.undoppelString(i)},n.Output.Formatters["capitalize-first"]=function(t,e){var i=n.Output.Formatters.doppelString(e,n.TAG_ESCAPE);return i.string.length?(i.string=i.string.slice(0,1).toUpperCase()+i.string.substr(1),n.Output.Formatters.undoppelString(i)):""},n.Output.Formatters.sentence=function(t,e){var i=n.Output.Formatters.doppelString(e,n.TAG_ESCAPE);return i.string=i.string.slice(0,1).toUpperCase()+i.string.substr(1).toLowerCase(),n.Output.Formatters.undoppelString(i)},n.Output.Formatters["capitalize-all"]=function(t,e){for(var i=n.Output.Formatters.doppelString(e,n.TAG_ESCAPE),s=i.string.split(" "),r=0,o=s.length;o>r;r+=1)s[r].length>1?t.opt.development_extensions.allow_force_lowercase?s[r]=s[r].slice(0,1).toUpperCase()+s[r].substr(1).toLowerCase():s[r]=s[r].slice(0,1).toUpperCase()+s[r].substr(1):1===s[r].length&&(s[r]=s[r].toUpperCase());return i.string=s.join(" "),n.Output.Formatters.undoppelString(i)},n.Output.Formatters.title=function(t,e){function i(t){var e=t.match(/([:?!]+\s+|-|^)(.)(.*)/);return e?e[1]+e[2].toUpperCase()+e[3]:t}var s,r,o,a,l;t.locale[t.opt.lang].opts["skip-words"];if(!e)return"";var c=n.Output.Formatters.doppelString(e,n.TAG_ESCAPE),s=c.string,l=s.split(t.locale[t.opt.lang].opts["skip-words-regexp"]);for(u=1,h=l.length;h>u;u+=2)l[u].match(/^[:?!]/)&&(l[u]=i(l[u]));l[0]||(l[1]=i(l[1])),l.length>2&&!l[l.length-1]&&(l[l.length-2]=i(l[l.length-2]));for(var u=0,h=l.length;h>u;u+=2){for(var r=l[u].split(/([:?!]*\s+|-)/),p=0,f=r.length;f>p;p+=2)if(0!==r[p].length){if(o=r[p].toUpperCase(),a=r[p].toLowerCase(),r[p].match(/[0-9]/))continue;r[p]===a&&(r[p]=i(r[p]))}l[u]=r.join("")}c.string=l.join("");var d=n.Output.Formatters.undoppelString(c);return d},n.Output.Formatters.doppelString=function(t,e){var i;i={},i.array=e(t),i.string="";for(var s=0,n=i.array.length;n>s;s+=2)"-"===i.array[s-1],i.string+=i.array[s];return i},n.Output.Formatters.undoppelString=function(t){var e;e="";for(var i=0,s=t.array.length;s>i;i+=1)i%2?e+=t.array[i]:("-"===t.array[i-1],e+=t.string.slice(0,t.array[i].length),t.string=t.string.slice(t.array[i].length));return e},n.Output.Formatters.serializeItemAsRdf=function(t){return""},n.Output.Formatters.serializeItemAsRdfA=function(t){return""},n.demoteNoiseWords=function(t,e,i){var s=t.locale[t.opt.lang].opts["leading-noise-words"];if(e&&i){e=e.split(/\s+/),e.reverse();for(var n=[],r=e.length-1;r>-1&&s.indexOf(e[r].toLowerCase())>-1;r+=-1)n.push(e.pop());e.reverse();var o=e.join(" "),a=n.join(" ");"drop"!==i&&a?"demote"===i&&(e=[o,a].join(", ")):e=o}return e},n.Output.Formats=function(){},n.Output.Formats.prototype.html={text_escape:function(t){return t||(t=""),t.replace(/&/g,"&#38;").replace(/</g,"&#60;").replace(/>/g,"&#62;").replace("  ","&#160; ","g").replace(n.SUPERSCRIPTS_REGEXP,function(t){return"<sup>"+n.SUPERSCRIPTS[t]+"</sup>"})},bibstart:'<div class="csl-bib-body">\n',bibend:"</div>","@font-style/italic":"<i>%%STRING%%</i>","@font-style/oblique":"<em>%%STRING%%</em>","@font-style/normal":'<span style="font-style:normal;">%%STRING%%</span>',"@font-variant/small-caps":'<span style="font-variant:small-caps;">%%STRING%%</span>',"@passthrough/true":n.Output.Formatters.passthrough,"@font-variant/normal":'<span style="font-variant:normal;">%%STRING%%</span>',"@font-weight/bold":"<b>%%STRING%%</b>","@font-weight/normal":'<span style="font-weight:normal;">%%STRING%%</span>',"@font-weight/light":!1,"@text-decoration/none":'<span style="text-decoration:none;">%%STRING%%</span>',"@text-decoration/underline":'<span style="text-decoration:underline;">%%STRING%%</span>',"@vertical-align/sup":"<sup>%%STRING%%</sup>","@vertical-align/sub":"<sub>%%STRING%%</sub>","@vertical-align/baseline":'<span style="baseline">%%STRING%%</span>',"@strip-periods/true":n.Output.Formatters.passthrough,"@strip-periods/false":n.Output.Formatters.passthrough,"@quotes/true":function(t,e){return"undefined"==typeof e?t.getTerm("open-quote"):t.getTerm("open-quote")+e+t.getTerm("close-quote")},"@quotes/inner":function(t,e){return"undefined"==typeof e?"’":t.getTerm("open-inner-quote")+e+t.getTerm("close-inner-quote")},"@quotes/false":!1,"@cite/entry":function(t,e){return t.sys.wrapCitationEntry(e,this.item_id,this.locator_txt,this.suffix_txt)},"@bibliography/entry":function(t,e){var i="";return t.sys.embedBibliographyEntry&&(i=t.sys.embedBibliographyEntry(this.item_id)+"\n"),'  <div class="csl-entry">'+e+"</div>\n"+i},"@display/block":function(t,e){return'\n\n    <div class="csl-block">'+e+"</div>\n"},"@display/left-margin":function(t,e){return'\n    <div class="csl-left-margin">'+e+"</div>"},"@display/right-inline":function(t,e){return'<div class="csl-right-inline">'+e+"</div>\n  "},"@display/indent":function(t,e){return'<div class="csl-indent">'+e+"</div>\n  "},"@showid/true":function(t,e,i){if(t.tmp.just_looking||t.tmp.suppress_decorations)return e;if(i)return'<span class="'+t.opt.nodenames[i]+'" cslid="'+i+'">'+e+"</span>";if("string"==typeof e){var s="";if(e){var r=e.match(n.VARIABLE_WRAPPER_PREPUNCT_REX);s=r[1],e=r[2]}var o="";return e&&n.SWAPPING_PUNCTUATION.indexOf(e.slice(-1))>-1&&(o=e.slice(-1),e=e.slice(0,-1)),t.sys.variableWrapper(this.params,s,e,o)}return e},"@URL/true":function(t,e){return'<a href="'+e+'">'+e+"</a>"},"@DOI/true":function(t,e){return'<a href="http://dx.doi.org/'+e+'">'+e+"</a>"}},n.Output.Formats.prototype.text={text_escape:function(t){return t||(t=""),t},bibstart:"",bibend:"","@font-style/italic":!1,"@font-style/oblique":!1,"@font-style/normal":!1,"@font-variant/small-caps":!1,"@passthrough/true":n.Output.Formatters.passthrough,"@font-variant/normal":!1,"@font-weight/bold":!1,"@font-weight/normal":!1,"@font-weight/light":!1,"@text-decoration/none":!1,"@text-decoration/underline":!1,"@vertical-align/baseline":!1,"@vertical-align/sup":!1,"@vertical-align/sub":!1,"@strip-periods/true":n.Output.Formatters.passthrough,"@strip-periods/false":n.Output.Formatters.passthrough,"@quotes/true":function(t,e){return"undefined"==typeof e?t.getTerm("open-quote"):t.getTerm("open-quote")+e+t.getTerm("close-quote")},"@quotes/inner":function(t,e){return"undefined"==typeof e?"’":t.getTerm("open-inner-quote")+e+t.getTerm("close-inner-quote")},"@quotes/false":!1,"@cite/entry":function(t,e){return t.sys.wrapCitationEntry(e,this.item_id,this.locator_txt,this.suffix_txt)},"@bibliography/entry":function(t,e){return e+"\n"},"@display/block":function(t,e){return"\n"+e},"@display/left-margin":function(t,e){return e},"@display/right-inline":function(t,e){return e},"@display/indent":function(t,e){return"\n    "+e},"@showid/true":function(t,e,i){return e},"@URL/true":function(t,e){return e},"@DOI/true":function(t,e){return e}},n.Output.Formats.prototype.rtf={text_escape:function(t){return t||(t=""),t.replace(/([\\{}])/g,"\\$1","g").replace(n.SUPERSCRIPTS_REGEXP,function(t){return"\\super "+n.SUPERSCRIPTS[t]+"\\nosupersub{}"}).replace(/[\u007F-\uFFFF]/g,function(t){return"\\uc0\\u"+t.charCodeAt(0).toString()+"{}"}).replace("	","\\tab{}","g")},"@passthrough/true":n.Output.Formatters.passthrough,"@font-style/italic":"\\i %%STRING%%\\i0{}","@font-style/normal":"\\i0{}%%STRING%%\\i{}","@font-style/oblique":"\\i %%STRING%%\\i0{}","@font-variant/small-caps":"\\scaps %%STRING%%\\scaps0{}","@font-variant/normal":"\\scaps0{}%%STRING%%\\scaps{}","@font-weight/bold":"\\b %%STRING%%\\b0{}","@font-weight/normal":"\\b0{}%%STRING%%\\b{}","@font-weight/light":!1,"@text-decoration/none":!1,"@text-decoration/underline":"\\ul %%STRING%%\\ul0{}","@vertical-align/baseline":!1,"@vertical-align/sup":"\\super %%STRING%%\\nosupersub{}","@vertical-align/sub":"\\sub %%STRING%%\\nosupersub{}","@strip-periods/true":n.Output.Formatters.passthrough,"@strip-periods/false":n.Output.Formatters.passthrough,"@quotes/true":function(t,e){return"undefined"==typeof e?n.Output.Formats.rtf.text_escape(t.getTerm("open-quote")):n.Output.Formats.rtf.text_escape(t.getTerm("open-quote"))+e+n.Output.Formats.rtf.text_escape(t.getTerm("close-quote"))},"@quotes/inner":function(t,e){return"undefined"==typeof e?n.Output.Formats.rtf.text_escape("’"):n.Output.Formats.rtf.text_escape(t.getTerm("open-inner-quote"))+e+n.Output.Formats.rtf.text_escape(t.getTerm("close-inner-quote"))},"@quotes/false":!1,bibstart:"{\\rtf ",bibend:"}","@display/block":"\\line{}%%STRING%%\\line\r\n","@cite/entry":function(t,e){return e},"@cite/entry":function(t,e){return t.sys.wrapCitationEntry(e,this.item_id,this.locator_txt,this.suffix_txt)},"@bibliography/entry":function(t,e){return e},"@display/left-margin":function(t,e){return e+"\\tab "},"@display/right-inline":function(t,e){return e+"\n"},"@display/indent":function(t,e){return"\n\\tab "+e},"@showid/true":function(t,e,i){if(t.tmp.just_looking||t.tmp.suppress_decorations)return e;var s="";if(e){var r=e.match(n.VARIABLE_WRAPPER_PREPUNCT_REX);s=r[1],e=r[2]}var o="";return e&&n.SWAPPING_PUNCTUATION.indexOf(e.slice(-1))>-1&&(o=e.slice(-1),e=e.slice(0,-1)),t.sys.variableWrapper(this.params,s,e,o)},"@URL/true":function(t,e){return e},"@DOI/true":function(t,e){return e}},n.Output.Formats=new n.Output.Formats,n.Registry=function(t){var e,i,s;this.debug=!1,this.state=t,this.registry={},this.reflist=[],this.namereg=new n.Registry.NameReg(t),this.citationreg=new n.Registry.CitationReg(t),this.authorstrings={},this.mylist=[],this.myhash={},this.deletes=[],this.inserts=[],this.uncited={},this.refreshes={},this.akeys={},this.oldseq={},this.return_data={},this.ambigcites={},this.ambigresets={},this.sorter=new n.Registry.Comparifier(t,"bibliography_sort"),this.getSortedIds=function(){for(e=[],i=0,s=this.reflist.length;s>i;i+=1)e.push(""+this.reflist[i].id);return e},this.getSortedRegistryItems=function(){for(e=[],i=0,s=this.reflist.length;s>i;i+=1)e.push(this.reflist[i]);return e}},n.Registry.prototype.init=function(t,e){var i,s;if(this.oldseq={},e){this.uncited={};for(var i=0,s=t.length;s>i;i+=1)this.myhash[t[i]]||this.mylist.push(""+t[i]),this.uncited[t[i]]=!0,this.myhash[t[i]]=!0}else{for(var n in this.uncited)t.push(n);var r={};for(i=t.length-1;i>-1;i+=-1)r[t[i]]?t=t.slice(0,i).concat(t.slice(i+1)):r[t[i]]=!0;this.mylist=[];for(var i=0,s=t.length;s>i;i+=1)this.mylist.push(""+t[i]);this.myhash=r}this.refreshes={},this.touched={},this.ambigsTouched={},this.ambigresets={}},n.Registry.prototype.dopurge=function(t){for(var e=this.mylist.length-1;e>-1;e+=-1)this.citationreg.citationsByItemId&&(this.citationreg.citationsByItemId[this.mylist[e]]||t[this.mylist[e]]||(delete this.myhash[this.mylist[e]],this.mylist=this.mylist.slice(0,e).concat(this.mylist.slice(e+1))));this.dodeletes(this.myhash)},n.Registry.prototype.dodeletes=function(t){var e,i,s,n,r,o,a,l,c;"string"==typeof t&&(t={},t[t]=!0);for(i in this.registry)if(!t[i]){if(this.uncited[i])continue;e=this.namereg.delitems(i);for(a in e)this.refreshes[a]=!0;for(s=this.registry[i].ambig,l=this.ambigcites[s].indexOf(i),l>-1&&(o=this.ambigcites[s].slice(),this.ambigcites[s]=o.slice(0,l).concat(o.slice(l+1,o.length)),this.ambigresets[s]=this.ambigcites[s].length),r=this.ambigcites[s].length,n=0;r>n;n+=1)c=""+this.ambigcites[s][n],this.refreshes[c]=!0;if(this.registry[i].siblings)if(1==this.registry[i].siblings.length){var u=this.registry[i].siblings[0];this.registry[u].master=!0,this.registry[u].siblings.pop(),this.registry[u].parallel=!1}else if(this.registry[i].siblings.length>1){var h=[i];if(this.registry[i].master){var p=this.registry[i].siblings[0],f=this.registry[p];f.master=!0,f.parallel=!1,h.push(p);for(var d=0,m=this.registry[i].siblings.length;m>d;d+=1)this.registry[this.registry[i].siblings[d]].parallel=p}for(var g=[],d=this.registry[i].siblings.length-1;d>-1;d+=-1){var b=this.registry[i].siblings.pop();-1===h.indexOf(b)&&g.push(b)}for(var d=g.length-1;d>-1;d+=-1)this.registry[i].siblings.push(g[d])}delete this.registry[i],this.return_data.bibchange=!0}},n.Registry.prototype.doinserts=function(t){var e,i,s,r,o,a,l;for("string"==typeof t&&(t=[t]),a=0,l=t.length;l>a;a+=1)e=t[a],this.registry[e]||(i=this.state.retrieveItem(e),s=n.getAmbiguousCite.call(this.state,i),this.ambigsTouched[s]=!0,i.legislation_id||(this.akeys[s]=!0),r={id:""+e,seq:0,offset:0,sortkeys:!1,ambig:!1,rendered:!1,disambig:!1,ref:i},this.registry[e]=r,this.citationreg.citationsByItemId&&this.citationreg.citationsByItemId[e]&&(this.registry[e]["first-reference-note-number"]=this.citationreg.citationsByItemId[e][0].properties.noteIndex),o=n.getAmbigConfig.call(this.state),this.registerAmbigToken(s,e,o),this.touched[e]=!0,this.return_data.bibchange=!0)},n.Registry.prototype.rebuildlist=function(){var t,e,i;for(this.reflist=[],this.state.opt.citation_number_sort_direction===n.DESCENDING&&this.state.opt.citation_number_sort_used,t=this.mylist.length,e=0;t>e;e+=1)i=this.mylist[e],this.reflist.push(this.registry[i]),this.oldseq[i]=this.registry[i].seq,this.registry[i].seq=e+1;this.state.opt.citation_number_sort_direction===n.DESCENDING&&this.state.opt.citation_number_sort_used},n.Registry.prototype.dorefreshes=function(){var t,e,i,s,r;for(t in this.refreshes)if(e=this.registry[t]){e.sortkeys=void 0,i=this.state.retrieveItem(t);var s=e.ambig;"undefined"==typeof s&&(this.state.tmp.disambig_settings=!1,s=n.getAmbiguousCite.call(this.state,i),r=n.getAmbigConfig.call(this.state),this.registerAmbigToken(s,t,r));for(var o in this.ambigresets)if(1===this.ambigresets[o]){var a=this.ambigcites[s][0],i=this.state.retrieveItem(a);this.registry[a].disambig=new n.AmbigConfig,this.state.tmp.disambig_settings=!1;var s=n.getAmbiguousCite.call(this.state,i),r=n.getAmbigConfig.call(this.state);this.registerAmbigToken(s,a,r)}this.state.tmp.taintedItemIDs[t]=!0,this.ambigsTouched[s]=!0,i.legislation_id||(this.akeys[s]=!0),this.touched[t]=!0}},n.Registry.prototype.setdisambigs=function(){var t;this.leftovers=[];for(t in this.ambigsTouched)this.state.disambiguate.run(t);this.ambigsTouched={},this.akeys={}},n.Registry.prototype.renumber=function(){var t,e,i;for(this.state.opt.citation_number_sort_direction===n.DESCENDING&&this.state.opt.citation_number_sort_used,t=this.reflist.length,e=0;t>e;e+=1)i=this.reflist[e],i.seq=e+1,this.state.opt.update_mode===n.NUMERIC&&i.seq!=this.oldseq[i.id]&&(this.state.tmp.taintedItemIDs[i.id]=!0),this.state.opt.bib_mode===n.NUMERIC&&i.seq!=this.oldseq[i.id]&&(this.return_data.bibchange=!0);this.state.opt.citation_number_sort_direction===n.DESCENDING&&this.state.opt.citation_number_sort_used&&this.reflist.reverse()},n.Registry.prototype.setsortkeys=function(){for(var t,e=0,i=this.mylist.length;i>e;e+=1){var t=this.mylist[e];(this.touched[t]||this.state.tmp.taintedItemIDs[t]||!this.registry[t].sortkeys)&&(this.registry[t].sortkeys=n.getSortKeys.call(this.state,this.state.retrieveItem(t),"bibliography_sort"))}},n.Registry.prototype.sorttokens=function(){this.reflist.sort(this.sorter.compareKeys)},n.Registry.Comparifier=function(t,e){var i,s,r,o,a=n.getSortCompare(t.opt["default-locale-sort"]);i=t[e].opt.sort_directions,this.compareKeys=function(t,e){for(s=t.sortkeys?t.sortkeys.length:0,r=0;s>r;r+=1){var n=0;if(n=t.sortkeys[r]===e.sortkeys[r]?0:"undefined"==typeof t.sortkeys[r]?i[r][1]:"undefined"==typeof e.sortkeys[r]?i[r][0]:a(t.sortkeys[r],e.sortkeys[r]),n>0)return i[r][1];if(0>n)return i[r][0]}return t.seq>e.seq?1:t.seq<e.seq?-1:0},o=this.compareKeys,this.compareCompositeKeys=function(t,e){return o(t[1],e[1])}},n.Registry.prototype.compareRegistryTokens=function(t,e){return t.seq>e.seq?1:t.seq<e.seq?-1:0},n.Registry.prototype.registerAmbigToken=function(t,e,i){if(this.registry[e]&&this.registry[e].disambig&&this.registry[e].disambig.names)for(var s=0,r=i.names.length;r>s;s+=1){var o=i.names[s],a=this.registry[e].disambig.names[s];if(o!==a)this.state.tmp.taintedItemIDs[e]=!0;else if(i.givens[s])for(var l=0,c=i.givens[s].length;c>l;l+=1){var u=i.givens[s][l],h=this.registry[e].disambig.givens[s][l];u!==h&&(this.state.tmp.taintedItemIDs[e]=!0)}}this.ambigcites[t]||(this.ambigcites[t]=[]),-1===this.ambigcites[t].indexOf(""+e)&&this.ambigcites[t].push(""+e),this.registry[e].ambig=t;this.registry[e].disambig=n.cloneAmbigConfig(i)},n.getSortKeys=function(t,e){var i,s,r,o,a,l;for(i=this.tmp.area,s=this.tmp.extension,r=n.Util.Sort.strip_prepositions,this.tmp.area=e,this.tmp.extension="_sort",this.tmp.disambig_override=!0,this.tmp.disambig_request=!1,o=this.parallel.use_parallels,this.parallel.use_parallels=!1,this.tmp.suppress_decorations=!0,n.getCite.call(this,t),this.tmp.suppress_decorations=!1,this.parallel.use_parallels=o,this.tmp.disambig_override=!1,a=this[e].keys.length,l=0;a>l;l+=1)this[e].keys[l]=r(this[e].keys[l]);return this.tmp.area=i,this.tmp.extension=s,this[e].keys},n.Registry.NameReg=function(t){var e,i,s,r,o,a,l,c,u,h,p,f,d,m,g,b;this.state=t,this.namereg={},this.nameind={},this.nameindpkeys={},this.itemkeyreg={},c=function(t){return t||(t=""),t.replace("."," ","g").replace(/\s+/g," ").replace(/\s+$/,"")},u=function(t,r,o){e=c(o.family),s=c(o.given);var a=s.match(/[,\!]* ([^,]+)$/);a&&a[1]===a[1].toLowerCase()&&(s=s.replace(/[,\!]* [^,]+$/,"")),i=n.Util.Names.initializeWith(t,s,"%s"),"by-cite"===t.citation.opt["givenname-disambiguation-rule"]&&(e=""+r+e)},h=function(s,n,a,l,c,h){var p;if("bibliography"===t.tmp.area.slice(0,12)&&!c)return"string"==typeof h?1:2;var f=t.nameOutput.getName(n,"locale-translit",!0);n=f.name,u(this.state,""+s,n),p=2,r=t.opt["disambiguate-add-givenname"],o=t.citation.opt["givenname-disambiguation-rule"];var d=o;return"by-cite"===o&&(o="all-names"),"short"===c?p=0:"string"==typeof h&&(p=1),"undefined"==typeof this.namereg[e]||"undefined"==typeof this.namereg[e].ikey[i]?p:"by-cite"===d&&l>=p?l:r?"string"==typeof o&&"primary-name"===o.slice(0,12)&&a>0?p:(o&&"all-names"!==o&&"primary-name"!==o?("all-names-with-initials"===o||"primary-name-with-initials"===o)&&(p=this.namereg[e].count>1?1:0):(this.namereg[e].count>1&&(p=1),(this.namereg[e].ikey&&this.namereg[e].ikey[i].count>1||this.namereg[e].count>1&&"string"!=typeof h)&&(p=2)),t.registry.registry[s]?p:"short"==c?0:"string"==typeof h?1:void 0):p},p=function(n){var r,o,c,u,h;for(("string"==typeof n||"number"==typeof n)&&(n=[""+n]),a={},o=n.length,r=0;o>r;r+=1)if(u=""+n[r],this.nameind[u]){for(h in this.nameind[u])if(this.nameind[u].hasOwnProperty(h)){if(d=h.split("::"),e=d[0],i=d[1],s=d[2],"undefined"==typeof this.namereg[e])continue;if(l=this.namereg[e].items,s&&this.namereg[e].ikey[i]&&this.namereg[e].ikey[i].skey[s]&&(m=this.namereg[e].ikey[i].skey[s].items,c=m.indexOf(""+u),c>-1&&(this.namereg[e].ikey[i].skey[s].items=m.slice(0,c).concat(m.slice([c+1]))),0===this.namereg[e].ikey[i].skey[s].items.length&&(delete this.namereg[e].ikey[i].skey[s],this.namereg[e].ikey[i].count+=-1,this.namereg[e].ikey[i].count<2)))for(g=0,b=this.namereg[e].ikey[i].items.length;b>g;g+=1)t.tmp.taintedItemIDs[this.namereg[e].ikey[i].items[g]]=!0;if(i&&this.namereg[e].ikey[i]&&(c=this.namereg[e].ikey[i].items.indexOf(""+u),c>-1&&(l=this.namereg[e].ikey[i].items.slice(),this.namereg[e].ikey[i].items=l.slice(0,c).concat(l.slice([c+1]))),0===this.namereg[e].ikey[i].items.length&&(delete this.namereg[e].ikey[i],this.namereg[e].count+=-1,this.namereg[e].count<2)))for(g=0,b=this.namereg[e].items.length;b>g;g+=1)t.tmp.taintedItemIDs[this.namereg[e].items[g]]=!0;e&&(c=this.namereg[e].items.indexOf(""+u),c>-1&&(l=this.namereg[e].items.slice(),this.namereg[e].items=l.slice(0,c).concat(l.slice([c+1],l.length))),this.namereg[e].items.length<2&&delete this.namereg[e]),delete this.nameind[u][h]}delete this.nameind[u],delete this.nameindpkeys[u]}return a},f=function(n,r,o){var a,l,c=t.nameOutput.getName(r,"locale-translit",!0);if(r=c.name,!t.citation.opt["givenname-disambiguation-rule"]||"primary-"!==t.citation.opt["givenname-disambiguation-rule"].slice(0,8)||0===o){if(u(this.state,""+n,r),e&&("undefined"==typeof this.namereg[e]?(this.namereg[e]={},this.namereg[e].count=0,this.namereg[e].ikey={},this.namereg[e].items=[n]):-1===this.namereg[e].items.indexOf(n)&&this.namereg[e].items.push(n)),e&&i)if("undefined"==typeof this.namereg[e].ikey[i]){if(this.namereg[e].ikey[i]={},this.namereg[e].ikey[i].count=0,this.namereg[e].ikey[i].skey={},this.namereg[e].ikey[i].items=[n],this.namereg[e].count+=1,2===this.namereg[e].count)for(a=0,l=this.namereg[e].items.length;l>a;a+=1)t.tmp.taintedItemIDs[this.namereg[e].items[a]]=!0}else-1===this.namereg[e].ikey[i].items.indexOf(n)&&this.namereg[e].ikey[i].items.push(n);if(e&&i&&s)if("undefined"==typeof this.namereg[e].ikey[i].skey[s]){if(this.namereg[e].ikey[i].skey[s]={},
this.namereg[e].ikey[i].skey[s].items=[n],this.namereg[e].ikey[i].count+=1,2===this.namereg[e].ikey[i].count)for(a=0,l=this.namereg[e].ikey[i].items.length;l>a;a+=1)t.tmp.taintedItemIDs[this.namereg[e].ikey[i].items[a]]=!0}else-1===this.namereg[e].ikey[i].skey[s].items.indexOf(n)&&this.namereg[e].ikey[i].skey[s].items.push(n);"undefined"==typeof this.nameind[n]&&(this.nameind[n]={},this.nameindpkeys[n]={}),e&&(this.nameind[n][e+"::"+i+"::"+s]=!0,this.nameindpkeys[n][e]=this.namereg[e])}},this.addname=f,this.delitems=p,this.evalname=h},n.Registry.CitationReg=function(t){this.citationById={},this.citationByIndex=[]},n.Disambiguation=function(t){this.state=t,this.sys=this.state.sys,this.registry=t.registry.registry,this.ambigcites=t.registry.ambigcites,this.configModes(),this.debug=!1},n.Disambiguation.prototype.run=function(t){this.modes.length&&(this.akey=t,this.initVars(t)&&this.runDisambig())},n.Disambiguation.prototype.runDisambig=function(){var t;for(this.initGivens=!0;this.lists.length;){for(this.gnameset=0,this.gname=0,this.clashes=[1,0];this.lists[0][1].length;){this.listpos=0,this.base||(this.base=this.lists[0][0]);t=this.incrementDisambig(),this.scanItems(this.lists[0]),this.evalScan(t)}this.lists=this.lists.slice(1)}},n.Disambiguation.prototype.scanItems=function(t){var e,i,s;this.Item=t[1][0],this.ItemCite=n.getAmbiguousCite.call(this.state,this.Item,this.base,!0),this.scanlist=t[1],this.partners=[],this.partners.push(this.Item),this.nonpartners=[];var r=0;for(e=1,i=t[1].length;i>e;e+=1){s=t[1][e];var o=n.getAmbiguousCite.call(this.state,s,this.base,!0);this.ItemCite===o?(r+=1,this.partners.push(s)):this.nonpartners.push(s)}this.clashes[0]=this.clashes[1],this.clashes[1]=r},n.Disambiguation.prototype.evalScan=function(t){this[this.modes[this.modeindex]](t),t&&(this.modeindex<this.modes.length-1?this.modeindex+=1:this.lists[this.listpos+1]=[this.base,[]])},n.Disambiguation.prototype.disNames=function(t){var e,i;if(0===this.clashes[1]&&1===this.nonpartners.length)this.captureStepToBase(),this.state.registry.registerAmbigToken(this.akey,""+this.nonpartners[0].id,this.betterbase),this.state.registry.registerAmbigToken(this.akey,""+this.partners[0].id,this.betterbase),this.lists[this.listpos]=[this.betterbase,[]];else if(0===this.clashes[1])this.captureStepToBase(),this.state.registry.registerAmbigToken(this.akey,""+this.partners[0].id,this.betterbase),this.lists[this.listpos]=[this.betterbase,this.nonpartners],this.nonpartners.length&&(this.initGivens=!0);else if(1===this.nonpartners.length)this.captureStepToBase(),this.state.registry.registerAmbigToken(this.akey,""+this.nonpartners[0].id,this.betterbase),this.lists[this.listpos]=[this.betterbase,this.partners];else if(this.clashes[1]<this.clashes[0])this.captureStepToBase(),this.lists[this.listpos]=[this.betterbase,this.partners],this.lists.push([this.betterbase,this.nonpartners]);else if(t&&(this.lists[this.listpos]=[this.betterbase,this.nonpartners],this.lists.push([this.betterbase,this.partners]),this.modeindex===this.modes.length-1)){for(e=0,i=this.partners.length;i>e;e+=1)this.state.registry.registerAmbigToken(this.akey,""+this.partners[e].id,this.betterbase);this.lists[this.listpos]=[this.betterbase,[]]}},n.Disambiguation.prototype.disExtraText=function(){var t=!1;if(0===this.clashes[1]&&this.nonpartners.length<2&&(t=!0),t||this.base.disambiguate&&this.state.tmp.disambiguate_count===this.state.tmp.disambiguate_maxMax){if(t||this.state.tmp.disambiguate_count===this.state.tmp.disambiguate_maxMax)if(t||this.modeindex===this.modes.length-1){for(var e=this.lists[this.listpos][0],i=0,s=this.lists[this.listpos][1].length;s>i;i+=1)this.state.tmp.taintedItemIDs[this.lists[this.listpos][1][i].id]=!0,this.state.registry.registerAmbigToken(this.akey,""+this.lists[this.listpos][1][i].id,e);this.lists[this.listpos]=[this.betterbase,[]]}else{this.modeindex=this.modes.length-1;var e=this.lists[this.listpos][0];e.disambiguate=!0;for(var i=0,s=this.lists[this.listpos][1].length;s>i;i+=1)this.state.tmp.taintedItemIDs[this.lists[this.listpos][1][i].id]=!0,this.state.registry.registerAmbigToken(this.akey,""+this.lists[this.listpos][1][i].id,e)}}else if(this.modeindex=0,this.base.disambiguate=this.state.tmp.disambiguate_count,this.betterbase.disambiguate=this.state.tmp.disambiguate_count,this.base.disambiguate)this.disNames();else{this.initGivens=!0,this.base.disambiguate=1;for(var i=0,s=this.lists[this.listpos][1].length;s>i;i+=1)this.state.tmp.taintedItemIDs[this.lists[this.listpos][1][i].id]=!0}},n.Disambiguation.prototype.disYears=function(){var t,e,i,s;i=[];var r=this.lists[this.listpos][0];if(this.clashes[1])for(var o=0,a=this.state.registry.mylist.length;a>o;o+=1)for(var l=this.state.registry.mylist[o],c=0,u=this.lists[this.listpos][1].length;u>c;c+=1){var s=this.lists[this.listpos][1][c];if(s.id==l){i.push(this.registry[s.id]);break}}for(i.sort(this.state.registry.sorter.compareKeys),t=0,e=i.length;e>t;t+=1){r.year_suffix=""+t;var h=this.state.registry.registry[i[t].id].disambig;this.state.registry.registerAmbigToken(this.akey,""+i[t].id,r),n.ambigConfigDiff(h,r)&&(this.state.tmp.taintedItemIDs[i[t].id]=!0)}this.lists[this.listpos]=[this.betterbase,[]]},n.Disambiguation.prototype.incrementDisambig=function(){if(this.initGivens)return this.initGivens=!1,!1;var t=!1,e=!0;if("disNames"===this.modes[this.modeindex]){e=!1,"number"!=typeof this.givensMax&&(e=!0);var i=!1;if("number"!=typeof this.namesMax&&(i=!0),"number"==typeof this.givensMax&&(this.base.givens.length&&this.base.givens[this.gnameset][this.gname]<this.givensMax?this.base.givens[this.gnameset][this.gname]+=1:e=!0),"number"==typeof this.namesMax&&e&&(this.state.opt["disambiguate-add-names"]?(i=!1,this.gname<this.namesMax?(this.base.names[this.gnameset]+=1,this.gname+=1):i=!0):i=!0),"number"==typeof this.namesetsMax&&i)if(this.gnameset<this.namesetsMax)this.gnameset+=1,this.base.names[this.gnameset]=1,this.gname=0;else;"number"==typeof this.namesetsMax&&-1!==this.namesetsMax&&this.gnameset!==this.namesetsMax||this.state.opt["disambiguate-add-names"]&&"number"==typeof this.namesMax&&this.gname!==this.namesMax||"number"==typeof this.givensMax&&"undefined"!=typeof this.base.givens[this.gnameset]&&"undefined"!=typeof this.base.givens[this.gnameset][this.gname]&&this.base.givens[this.gnameset][this.gname]!==this.givensMax||(t=!0)}else"disExtraText"===this.modes[this.modeindex]&&(this.base.disambiguate+=1,this.betterbase.disambiguate+=1);return t},n.Disambiguation.prototype.initVars=function(t){var e,i,s,r,o;if(this.lists=[],this.base=!1,this.betterbase=!1,this.akey=t,this.maxNamesByItemId={},r=[],s=this.ambigcites[t],!s||!s.length)return!1;var a=this.state.retrieveItem(""+s[0]);if(this.getCiteData(a),this.base=n.getAmbigConfig.call(this.state),s&&s.length>1){for(r.push([this.maxNamesByItemId[a.id],a]),e=1,i=s.length;i>e;e+=1)a=this.state.retrieveItem(""+s[e]),this.getCiteData(a,this.base),r.push([this.maxNamesByItemId[a.id],a]);for(r.sort(function(t,e){return t[0]>e[0]?1:t[0]<e[0]?-1:t[1].id>e[1].id?1:t[1].id<e[1].id?-1:0}),o=[],e=0,i=r.length;i>e;e+=1)o.push(r[e][1]);this.lists.push([this.base,o]),this.Item=this.lists[0][1][0]}else this.Item=this.state.retrieveItem(""+s[0]);if(this.modeindex=0,this.state.citation.opt["disambiguate-add-names"],0)for(var l=this.base.names[0],e=1,i=this.base.names.length;i>e;e+=1)l=Math.max(l,this.base.names.names[e]);else this.namesMax=this.maxNamesByItemId[this.Item.id][0];return this.padBase(this.base),this.padBase(this.betterbase),this.base.year_suffix=!1,this.base.disambiguate=!1,this.betterbase.year_suffix=!1,this.betterbase.disambiguate=!1,"by-cite"===this.state.citation.opt["givenname-disambiguation-rule"]&&this.state.opt["disambiguate-add-givenname"]&&(this.givensMax=2),!0},n.Disambiguation.prototype.padBase=function(t){for(var e=0,i=t.names.length;i>e;e+=1){t.givens[e]||(t.givens[e]=[]);for(var s=0,n=t.names[e];n>s;s+=1)t.givens[e][s]||(t.givens[e][s]=0)}},n.Disambiguation.prototype.configModes=function(){var t,e;this.modes=[],t=this.state.opt["disambiguate-add-givenname"],e=this.state.citation.opt["givenname-disambiguation-rule"],(this.state.opt["disambiguate-add-names"]||t&&"by-cite"===e)&&this.modes.push("disNames"),this.state.opt.has_disambiguate&&this.modes.push("disExtraText"),this.state.opt["disambiguate-add-year-suffix"]&&this.modes.push("disYears")},n.Disambiguation.prototype.getCiteData=function(t,e){if(!this.maxNamesByItemId[t.id]){n.getAmbiguousCite.call(this.state,t,e),e=n.getAmbigConfig.call(this.state),this.maxNamesByItemId[t.id]=n.getMaxVals.call(this.state),this.state.registry.registry[t.id].disambig.givens=this.state.tmp.disambig_settings.givens.slice();for(var i=0,s=this.state.registry.registry[t.id].disambig.givens.length;s>i;i+=1)this.state.registry.registry[t.id].disambig.givens[i]=this.state.tmp.disambig_settings.givens[i].slice();this.namesetsMax=this.state.registry.registry[t.id].disambig.names.length-1,this.base||(this.base=e,this.betterbase=n.cloneAmbigConfig(e)),e.names.length<this.base.names.length&&(this.base=e);for(var i=0,s=e.names.length;s>i;i+=1)e.names[i]>this.base.names[i]&&(this.base.givens[i]=e.givens[i].slice(),this.base.names[i]=e.names[i],this.betterbase.names=this.base.names.slice(),this.betterbase.givens=this.base.givens.slice(),this.padBase(this.base),this.padBase(this.betterbase));this.betterbase.givens=this.base.givens.slice();for(var r=0,o=this.base.givens.length;o>r;r+=1)this.betterbase.givens[r]=this.base.givens[r].slice()}},n.Disambiguation.prototype.captureStepToBase=function(){"by-cite"===this.state.citation.opt["givenname-disambiguation-rule"]&&this.base.givens&&this.base.givens.length&&"undefined"!=typeof this.base.givens[this.gnameset][this.gname]&&(this.betterbase.givens[this.gnameset][this.gname]=this.base.givens[this.gnameset][this.gname]),this.betterbase.names[this.gnameset]=this.base.names[this.gnameset]}},{"./csl_nodejs_jsdom":11}],10:[function(t,e,i){var s="undefined"!=typeof window,n=function(){this.institutionStr='<institution institution-parts="long" delimiter=", " substitute-use-first="1" use-last="1"><institution-part name="long"/></institution>',this.ns="http://purl.org/net/xbiblio/csl"};n.prototype._parseDoc=function(t){if(s){var e=new window.DOMParser;return e.parseFromString(t,"text/xml")}return $(t)},n.prototype.importNode=function(t,e){return s?t.importNode(e,!0):(e._root=t._root,e)},n.prototype._hasAttributes=function(t){return t.attributes&&t.attributes.length>0},n.prototype._isElementNode=function(t){return s?t.nodeType===window.Node.ELEMENT_NODE:"tag"===t.type},n.prototype._getTagName=function(t){return t.tagName?t.tagName.toLowerCase():""},n.prototype.clean=function(t){return t=t.replace(/<\?[^?]+\?>/g,""),t=t.replace(/<![^>]+>/g,""),t=t.replace(/^\s+/,""),t=t.replace(/\s+$/,""),t=t.replace(/^\n*/,"")},n.prototype.getStyleId=function(t,e){var i=e?"title":"id",s=$(t).find(i);return s.length&&(s=s[0]),$(s).text()},n.prototype.children=function(t){return $(t).children()},n.prototype.nodename=function(t){return this._getTagName(t)},n.prototype.attributes=function(t){var e,i,n={};if(t){if(s){if(this._hasAttributes(t)){e=t.attributes;for(var r=0,o=e.length;o>r;r+=1)i=e[r],n["@"+i.name]=i.value}}else if(t.attribs){e=t.attribs;for(var a in e)e.hasOwnProperty(a)&&(n["@"+a]=e[a])}}else;return n},n.prototype.content=function(t){return $(t).text()},n.prototype.namespace={xml:"http://www.w3.org/XML/1998/namespace"},n.prototype.numberofnodes=function(t){return t?t.length:0},n.prototype.getAttributeName=function(t){return t.name},n.prototype.getAttributeValue=function(t,e,i){return i&&(e=i+":"+e),$(t).attr(e)},n.prototype.getNodeValue=function(t,e){if(!e)return $(t).text();var i=$(t).find(e);return i.length?i.text():void 0},n.prototype.setAttributeOnNodeIdentifiedByNameAttribute=function(t,e,i,s,n){"@"===s.slice(0,1)&&(s=s.slice(1)),$(t).find(e).each(function(){var t=$(this);t.attr("name")===i&&t.attr(s,n)})},n.prototype.deleteNodeByNameAttribute=function(t,e){$(t).find("*[name="+e+"]").remove()},n.prototype.deleteAttribute=function(t,e){$(t).removeAttr(e)},n.prototype.setAttribute=function(t,e,i){return $(t).attr(e,i),!1},n.prototype.nodeCopy=function(t){return $(t).clone()},n.prototype.getNodesByName=function(t,e,i){return $(t).find(e+"[name="+i+"]")},n.prototype.nodeNameIs=function(t,e){return this._getTagName(t)===e},n.prototype.makeXml=function(t){t||(t="<docco><bogus/></docco>"),t=t.replace(/\s*<\?[^>]*\?>\s*\n*/g,"");var e,i=this._parseDoc(t);return e=s?i.firstChild:i._root},n.prototype.insertChildNodeAfter=function(t,e,i,s){var n=this.importNode(e.ownerDocument,s);return $(n).insertAfter(e),t},n.prototype.insertPublisherAndPlace=function(t){for(var e=$(t).find("group"),i=0,s=e.length;s>i;i+=1){var n=$(e[i]),r=n.find("[variable=publisher]"),o=n.find("[variable=publisher-place]");r.length&&o.length&&n.attr("has-publisher-and-publisher-place",!0)}},n.prototype.addMissingNameNodes=function(t){$(t).find("names").each(function(){var t=$(this),e=t.find("name");0!==e.length||t.parent("substitute")||t.append($("<name>"))})},n.prototype.addInstitutionNodes=function(t){function e(t,e){for(var i=0,s=CSL.INSTITUTION_KEYS.length;s>i;i+=1){var n=CSL.INSTITUTION_KEYS[i],r=e.attr(n);r&&t.attr(n,r)}}$(t).find("names").each(function(){var t=$(this).find("name"),i=$(this).find("institution");if(t.length&&!i.length){i=$(this.institutionStr);var s=i.find("institution-part");e(s,t),t.find("name-part[name=family]").each(function(){e(s,$(this))}),i.insertBefore(t)}})},n.prototype.flagDateMacros=function(t){$(t).find("macro").each(function(){var t=$(this),e=t.find("data");e.length&&t.attr("macro-has-date","true")})},e.exports=n},{}],11:[function(t,e,i){var s;s=t("undefined"==typeof window?"./csl_jquery":"./xmldom"),e.exports={CSL_NODEJS_JSDOM:s}},{"./csl_jquery":10,"./xmldom":12}],12:[function(t,e,i){var s,n=function(){"undefined"==typeof DOMParser||s?(s=!0,DOMParser=function(){},DOMParser.prototype.parseFromString=function(t,e){if("undefined"!=typeof ActiveXObject){var i=new ActiveXObject("MSXML.DomDocument");return i.async=!1,i.loadXML(t),i}if("undefined"!=typeof XMLHttpRequest){var i=new XMLHttpRequest;return e||(e="text/xml"),i.open("GET","data:"+e+";charset=utf-8,"+encodeURIComponent(t),!1),i.overrideMimeType&&i.overrideMimeType(e),i.send(null),i.responseXML}},this.hasAttributes=function(t){var e;return e=t.attributes&&t.attributes.length?!0:!1}):this.hasAttributes=function(t){var e;return e=t.attributes&&t.attributes.length?!0:!1},this.importNode=function(t,e){if("undefined"==typeof t.importNode)var i=this._importNode(t,e,!0);else var i=t.importNode(e,!0);return i},this._importNode=function(t,e,i){switch(e.nodeType){case 1:var s=t.createElement(e.nodeName);if(e.attributes&&e.attributes.length>0)for(var n=0,r=e.attributes.length;r>n;)s.setAttribute(e.attributes[n].nodeName,e.getAttribute(e.attributes[n++].nodeName));if(i&&e.childNodes&&e.childNodes.length>0)for(var n=0,r=e.childNodes.length;r>n;)s.appendChild(this._importNode(t,e.childNodes[n++],i));return s;case 3:case 4:case 8:}},this.parser=new DOMParser;var t='<docco><institution institution-parts="long" delimiter=", " substitute-use-first="1" use-last="1"><institution-part name="long"/></institution></docco>',e=this.parser.parseFromString(t,"text/xml"),i=e.getElementsByTagName("institution");this.institution=i.item(0);var n=e.getElementsByTagName("institution-part");this.institutionpart=n.item(0),this.ns="http://purl.org/net/xbiblio/csl"};n.prototype.clean=function(t){return t=t.replace(/<\?[^?]+\?>/g,""),t=t.replace(/<![^>]+>/g,""),t=t.replace(/^\s+/,""),t=t.replace(/\s+$/,""),t=t.replace(/^\n*/,"")},n.prototype.getStyleId=function(t){var e="",i=t.getElementsByTagName("id");return i&&i.length&&(i=i.item(0)),i&&(e=i.textContent),e||(e=i.innerText),e||(e=i.innerHTML),e},n.prototype.children=function(t){var e,i,s,n;if(t){for(n=[],e=t.childNodes,i=0,s=e.length;s>i;i+=1)"#text"!=e[i].nodeName&&n.push(e[i]);return n}return[]},n.prototype.nodename=function(t){var e=t.nodeName;return e},n.prototype.attributes=function(t){var e,i,s,n,r;if(e=new Object,t&&this.hasAttributes(t))for(i=t.attributes,n=0,r=i.length;r>n;n+=1)s=i[n],e["@"+s.name]=s.value;return e},n.prototype.content=function(t){var e;return e="undefined"!=typeof t.textContent?t.textContent:"undefined"!=typeof t.innerText?t.innerText:t.txt},n.prototype.namespace={xml:"http://www.w3.org/XML/1998/namespace"},n.prototype.numberofnodes=function(t){return t?t.length:0},n.prototype.getAttributeName=function(t){var e=t.name;return e},n.prototype.getAttributeValue=function(t,e,i){var s="";return t&&this.hasAttributes(t)&&t.getAttribute(e)&&(s=t.getAttribute(e)),s},n.prototype.getNodeValue=function(t,e){var i="";if(e){var s=t.getElementsByTagName(e);s.length>0&&(i="undefined"!=typeof s[0].textContent?s[0].textContent:"undefined"!=typeof s[0].innerText?s[0].innerText:s[0].text)}else i=t;return i&&i.childNodes&&(0==i.childNodes.length||1==i.childNodes.length&&"#text"==i.firstChild.nodeName)&&(i="undefined"!=typeof i.textContent?i.textContent:"undefined"!=typeof i.innerText?i.innerText:i.text),i},n.prototype.setAttributeOnNodeIdentifiedByNameAttribute=function(t,e,i,s,n){var r,o,a,l;for("@"===s.slice(0,1)&&(s=s.slice(1)),a=t.getElementsByTagName(e),r=0,o=a.length;o>r;r+=1)l=a[r],l.getAttribute("name")==i&&l.setAttribute(s,n)},n.prototype.deleteNodeByNameAttribute=function(t,e){var i,s,n,r;for(r=t.childNodes,i=0,s=r.length;s>i;i+=1)n=r[i],n&&n.nodeType!=n.TEXT_NODE&&this.hasAttributes(n)&&n.getAttribute("name")==e&&t.removeChild(r[i])},n.prototype.deleteAttribute=function(t,e){t.removeAttribute(e)},n.prototype.setAttribute=function(t,e,i){return t.ownerDocument||(t=t.firstChild),["function","unknown"].indexOf(typeof t.setAttribute)>-1&&t.setAttribute(e,i),!1},n.prototype.nodeCopy=function(t){var e=t.cloneNode(!0);return e},n.prototype.getNodesByName=function(t,e,i){var s,n,r,o,a;for(s=[],n=t.getElementsByTagName(e),o=0,a=n.length;a>o;o+=1)r=n.item(o),(!i||this.hasAttributes(r)&&r.getAttribute("name")==i)&&s.push(r);return s},n.prototype.nodeNameIs=function(t,e){return e==t.nodeName?!0:!1},n.prototype.makeXml=function(t){t||(t="<docco><bogus/></docco>"),t=t.replace(/\s*<\?[^>]*\?>\s*\n*/g,"");var e=this.parser.parseFromString(t,"application/xml");return e.firstChild},n.prototype.insertChildNodeAfter=function(t,e,i,s){var n;return n=this.importNode(e.ownerDocument,s),t.replaceChild(n,e),t},n.prototype.insertPublisherAndPlace=function(t){for(var e=t.getElementsByTagName("group"),i=0,s=e.length;s>i;i+=1){for(var n=e.item(i),r=[],o=0,a=n.childNodes.length;a>o;o+=1)1!==n.childNodes.item(o).nodeType&&r.push(o);if(n.childNodes.length-r.length===2){for(var l=[],o=0,a=2;a>o;o+=1)if(!(r.indexOf(o)>-1)){for(var c=n.childNodes.item(o),u=[],h=0,p=c.childNodes.length;p>h;h+=1)1!==c.childNodes.item(h).nodeType&&u.push(h);if(c.childNodes.length-u.length===0&&(l.push(c.getAttribute("variable")),c.getAttribute("suffix")||c.getAttribute("prefix"))){l=[];break}}l.indexOf("publisher")>-1&&l.indexOf("publisher-place")>-1&&n.setAttribute("has-publisher-and-publisher-place",!0)}}},n.prototype.addMissingNameNodes=function(t){for(var e=t.getElementsByTagName("names"),i=0,s=e.length;s>i;i+=1){var n=e.item(i),r=n.getElementsByTagName("name");if((!r||0===r.length)&&"substitute"!==n.parentNode.tagName.toLowerCase()){var o=n.ownerDocument,a=o.createElement("name");n.appendChild(a)}}};var r={INSTITUTION_KEYS:["font-style","font-variant","font-weight","text-decoration","text-case"]};n.prototype.addInstitutionNodes=function(t){var e,i,s,n,o,a,l,c,u;for(e=t.getElementsByTagName("names"),c=0,u=e.length;u>c;c+=1)if(i=e.item(c),a=i.getElementsByTagName("name"),0!=a.length&&(s=i.getElementsByTagName("institution"),0==s.length)){n=this.importNode(t.ownerDocument,this.institution),o=n.getElementsByTagName("institution-part").item(0),l=a.item(0),i.insertBefore(n,l.nextSibling);for(var h=0,p=r.INSTITUTION_KEYS.length;p>h;h+=1){var f=r.INSTITUTION_KEYS[h],d=l.getAttribute(f);d&&o.setAttribute(f,d)}for(var m=l.getElementsByTagName("name-part"),h=0,p=m.length;p>h;h+=1)if("family"===m[h].getAttribute("name"))for(var g=0,b=r.INSTITUTION_KEYS.length;b>g;g+=1){var f=r.INSTITUTION_KEYS[g],d=m[h].getAttribute(f);d&&o.setAttribute(f,d)}}},n.prototype.flagDateMacros=function(t){var e,i,s,n,r;for(r=t.getElementsByTagName("macro"),e=0,i=r.length;i>e;e+=1)s=r.item(e),n=s.getElementsByTagName("date"),n.length&&s.setAttribute("macro-has-date","true")},e.exports=n},{}],13:[function(t,e,i){function s(t){this.config=t||new o,this.style=this.config.style,this.clear()}var n=t("substance/helpers"),r=t("./citeproc/citeproc").CSL,o=t("./citeproc_default_config");s.prototype.setStyle=function(t){this.style=t,this.clear()},s.prototype.clear=function(){this.engine=new r.Engine(this,this.style),this.data={},this.citationLabels={},this.count=0},s.prototype.addRecord=function(t){return t.id=t.id||"ITEM_"+this.count++,this.sanitizeData(t),this.data[t.id]=t,t.id},s.prototype.addCitation=function(t){n.isArray(t)||(t=[t]);for(var e={citationItems:[],properties:{}},i=0;i<t.length;i++)e.citationItems.push({id:t[i]});var s=this.engine.appendCitationCluster(e),r=s[0][0];e=this.engine.registry.citationreg.citationByIndex[r];var o=e.citationID,a=s[0][1];for(this.citationLabels[o]=a,i=1;i<s.length;i++)this.citationLabels[s[i][0]]=s[i][1];return{id:o,label:a}},s.prototype.getCitationCount=function(t){var e=this.engine.registry.citationreg.citationsByItemId[t];return e?e.length:0},s.prototype.makeBibliography=function(){var t,e,i,s,n,r,o,a={},l=[],c=this.engine.registry.citationreg.citationByIndex,u=[];for(e=0;e<c.length;e+=1)s=c[e],u.push([""+s.citationID,s.properties.noteIndex]);for(t=this.engine.registry.getSortedIds(),i=0;i<t.length;i++)o=t[i],n=this.engine.previewCitationCluster({citationItems:[{id:o}],properties:{}},u,[],"html"),r=this.renderReference(this.data[o]),a[o]={id:o,rank:i,citeCount:this.getCitationCount(o),label:n,content:r},l.push(a[o]);for(o in this.data)a[o]||(i+=1,r=this.renderReference(this.data[o]),a[o]={id:o,rank:i,citeCount:0,label:null,content:r},l.push(a[o]));return a},s.prototype.getSortedIds=function(){var t,e,i,s;for(t=this.engine.registry.getSortedIds(),e={},i=0;i<t.length;i++)e[t[i]]=!0;for(s in this.data)e[s]||(t.push(s),e[s]=!0);return t},s.prototype.renderReference=function(t){function e(t){if(t.search("csl-right-inline")>=0){var e=$("<div>").append($(t)).find(".csl-right-inline");return e.html()}return t}function i(){o.sanitizeData(t);var e=new r.Engine({retrieveItem:function(){return t},retrieveLocale:function(t){return o.config.locale[t]}},o.style),i={citationItems:[{id:t.id}],properties:{}};e.appendCitationCluster(i);try{return e.makeBibliography()[1][0]}catch(s){return console.error(s),"Error: invalid citation data."}}var n,o=this;if(this.data[t.id])try{n=s.getBibliographyEntry.call(this.engine,t.id)}catch(a){n=i()}else n=i();return e(n)},s.getBibliographyEntry=function(t){var e,i,s,n,o,a,l;if(this.tmp.area="bibliography",this.tmp.last_rendered_name=!1,this.tmp.bibliography_errors=[],this.tmp.bibliography_pos=0,this.tmp.disambig_override=!0,this.tmp.just_looking=!0,e=this.retrieveItem(t),this.parallel.StartCitation([[{id:""+e.id},e]]),this.tmp.term_predecessor=!1,r.getCite.call(this,e),this.output.queue[0].blobs.length&&this.output.queue[0].blobs[0].blobs.length){for(n||!this.output.queue[0].blobs[0].blobs[0].strings?(i=this.output.queue[0].blobs,n=!1):i=this.output.queue[0].blobs[0].blobs,o=i.length-1;o>-1;o+=-1)if(i[o].blobs&&0!==i[o].blobs.length){var c,u=this.tmp.cite_locales[this.tmp.cite_locales.length-1];c=this.tmp.cite_affixes[this.tmp.area][u]?this.tmp.cite_affixes[this.tmp.area][u].suffix:this.bibliography.opt.layout_suffix,l=c.slice(0,1),l&&i[o].strings.suffix.slice(-1)===l&&(i[o].strings.suffix=i[o].strings.suffix.slice(0,-1)),i[o].strings.suffix+=c;break}i[0].strings.prefix=this.bibliography.opt.layout_prefix+i[0].strings.prefix}for(o=0,a=this.output.queue.length;a>o;o+=1)r.Output.Queue.purgeEmptyBlobs(this.output.queue[o]);for(o=0,a=this.output.queue.length;a>o;o+=1)this.output.adjust.upward(this.output.queue[o]),this.output.adjust.leftward(this.output.queue[o]),this.output.adjust.downward(this.output.queue[o],!0),this.output.adjust.fix(this.output.queue[o]);return s=this.output.string(this,this.output.queue)[0],s||(s="\n[CSL STYLE ERROR: reference with no printed form.]\n"),this.tmp.disambig_override=!1,this.tmp.just_looking=!1,s},s.prototype.retrieveItem=function(t){return this.data[t]},s.prototype.retrieveLocale=function(t){return this.config.locale[t]},s.prototype.sanitizeData=function(t){t["container-title"]=t["container-title"]||"",t.title=t.title||""},e.exports=s},{"./citeproc/citeproc":9,"./citeproc_default_config":14,"substance/helpers":170}],14:[function(t,e,i){function s(t){t=t||{},this.style=t.style||s.defaultStyle,this.locale=t.locale||s.defaultLocale}s.defaultStyleName="PLOS",s.defaultStyle='<?xml version="1.0" encoding="utf-8"?><style xmlns="http://purl.org/net/xbiblio/csl" class="in-text" version="1.0" demote-non-dropping-particle="sort-only" page-range-format="expanded" default-locale="en-US">  <info>    <title>Public Library of Science</title>    <title-short>PLOS</title-short>    <id>http://www.zotero.org/styles/plos</id>    <link href="http://www.zotero.org/styles/plos" rel="self"/>    <link href="http://journals.plos.org/plosbiology/guidelines.php" rel="documentation"/>    <author>      <name>Julian Onions</name>      <email>julian.onions@gmail.com</email>    </author>    <category citation-format="numeric"/>    <category field="science"/>    <summary>Public Library of Science Journal style.</summary>    <updated>2012-09-27T22:06:38+00:00</updated>    <rights license="http://creativecommons.org/licenses/by-sa/3.0/">This work is licensed under a Creative Commons Attribution-ShareAlike 3.0 License</rights>  </info>  <macro name="editor">    <names variable="editor" delimiter=", ">      <name name-as-sort-order="all" sort-separator=" " initialize-with="" delimiter=", " delimiter-precedes-last="always"/>      <label form="long" prefix=", "/>    </names>  </macro>  <macro name="author">    <names variable="author">      <name name-as-sort-order="all" sort-separator=" " initialize-with="" delimiter=", " delimiter-precedes-last="always"/>      <label form="long" prefix=", "/>      <substitute>        <names variable="editor"/>        <text variable="title"/>      </substitute>    </names>  </macro>  <macro name="access">    <group>      <choose>        <if variable="URL">          <text variable="URL" prefix="Available: " suffix="."/>          <group prefix=" " suffix=".">            <text term="accessed" text-case="capitalize-first" suffix=" "/>            <date variable="accessed">              <date-part name="day" suffix=" "/>              <date-part name="month" suffix=" "/>              <date-part name="year"/>            </date>          </group>        </if>        <else>          <text variable="DOI" prefix="doi:"/>        </else>      </choose>    </group>  </macro>  <macro name="publisher">    <group delimiter=": ">      <text variable="publisher-place"/>      <text variable="publisher"/>    </group>  </macro>  <macro name="year-date">    <choose>      <if variable="issued">        <date variable="issued">          <date-part name="year"/>        </date>      </if>      <else>        <text term="no date" form="short"/>      </else>    </choose>  </macro>  <macro name="edition">    <choose>      <if is-numeric="edition">        <group delimiter=" ">          <number variable="edition" form="ordinal"/>          <text term="edition" form="short"/>        </group>      </if>      <else>        <text variable="edition" suffix="."/>      </else>    </choose>  </macro>  <citation collapse="citation-number">    <sort>      <key variable="citation-number"/>    </sort>    <layout prefix="[" suffix="]" delimiter=",">      <text variable="citation-number"/>    </layout>  </citation>  <bibliography et-al-min="6" et-al-use-first="5" second-field-align="flush">    <layout suffix=".">      <text variable="citation-number" suffix=". "/>      <group delimiter=" ">        <text macro="author"/>        <text macro="year-date" prefix="(" suffix=")"/>        <text variable="title"/>      </group>      <choose>        <if type="book report" match="any">          <text variable="genre" prefix=". "/>          <group delimiter=" " prefix=". ">            <text macro="edition"/>            <text macro="editor"/>            <text macro="publisher" suffix="."/>            <group delimiter=" ">              <text variable="number-of-pages"/>              <text term="page" form="short" strip-periods="true"/>            </group>          </group>        </if>        <else-if type="chapter paper-conference" match="any">          <group prefix=". " delimiter=". " suffix=".">            <group delimiter=" ">              <text term="in" text-case="capitalize-first" suffix=":"/>              <text macro="editor"/>            </group>            <text variable="container-title"/>            <text variable="collection-title"/>          </group>          <group prefix=" " suffix="." delimiter=", ">            <text macro="publisher"/>            <text variable="volume" prefix="Vol. "/>          </group>          <group prefix=" ">            <label variable="page" suffix=" " form="short"/>            <text variable="page"/>          </group>        </else-if>        <else-if type="thesis">          <group delimiter=" " prefix=" ">            <text variable="genre" prefix="[" suffix="]."/>            <text macro="publisher"/>          </group>        </else-if>        <else>          <group delimiter=" " prefix=". ">            <text variable="container-title" form="short" strip-periods="true"/>            <text variable="volume"/>          </group>          <text variable="page" prefix=": "/>        </else>      </choose>      <text macro="access" prefix=". "/>    </layout>  </bibliography></style>',s.defaultLocale={"en-US":'<locale xml:lang="en" xmlns="http://purl.org/net/xbiblio/csl">  <style-options punctuation-in-quote="true"/>  <date form="text">    <date-part name="month" suffix=" "/>    <date-part name="day" suffix=", "/>    <date-part name="year"/>  </date>  <date form="numeric">    <date-part name="year"/>    <date-part name="month" form="numeric" prefix="-" range-delimiter="/"/>    <date-part name="day" prefix="-" range-delimiter="/"/>  </date>  <terms>    <term name="document-number-label">No.</term>    <term name="document-number-authority-suffix">Doc.</term>    <term name="un-sales-number-label">U.N. Sales No.</term>    <term name="collection-number-label">No.</term>    <term name="open-quote">“</term>    <term name="close-quote">”</term>    <term name="open-inner-quote">‘</term>    <term name="close-inner-quote">’</term>    <term name="ordinal-01">st</term>    <term name="ordinal-02">nd</term>    <term name="ordinal-03">rd</term>    <term name="ordinal-04">th</term>    <term name="long-ordinal-01">first</term>    <term name="long-ordinal-02">second</term>    <term name="long-ordinal-03">third</term>    <term name="long-ordinal-04">fourth</term>    <term name="long-ordinal-05">fifth</term>    <term name="long-ordinal-06">sixth</term>    <term name="long-ordinal-07">seventh</term>    <term name="long-ordinal-08">eighth</term>    <term name="long-ordinal-09">ninth</term>    <term name="long-ordinal-10">tenth</term>    <term name="at">at</term>    <term name="in">in</term>    <term name="ibid">ibid</term>    <term name="accessed">accessed</term>    <term name="retrieved">retrieved</term>    <term name="from">from</term>    <term name="forthcoming">forthcoming</term>    <term name="references">      <single>reference</single>      <multiple>references</multiple>    </term>    <term name="references" form="short">      <single>ref</single>      <multiple>refs</multiple>    </term>    <term name="no date">n.d.</term>    <term name="and">and</term>    <term name="et-al">et al.</term>    <term name="interview">interview</term>    <term name="letter">letter</term>    <term name="anonymous">anonymous</term>    <term name="anonymous" form="short">anon.</term>    <term name="and others">and others</term>    <term name="in press">in press</term>    <term name="online">online</term>    <term name="cited">cited</term>    <term name="internet">internet</term>    <term name="presented at">presented at the</term>    <term name="ad">AD</term>    <term name="bc">BC</term>    <term name="season-01">Spring</term>    <term name="season-02">Summer</term>    <term name="season-03">Autumn</term>    <term name="season-04">Winter</term>    <term name="with">with</term>        <!-- CATEGORIES -->    <term name="anthropology">anthropology</term>    <term name="astronomy">astronomy</term>    <term name="biology">biology</term>    <term name="botany">botany</term>    <term name="chemistry">chemistry</term>    <term name="engineering">engineering</term>    <term name="generic-base">generic base</term>    <term name="geography">geography</term>    <term name="geology">geology</term>    <term name="history">history</term>    <term name="humanities">humanities</term>    <term name="literature">literature</term>    <term name="math">math</term>    <term name="medicine">medicine</term>    <term name="philosophy">philosophy</term>    <term name="physics">physics</term>    <term name="psychology">psychology</term>    <term name="sociology">sociology</term>    <term name="science">science</term>    <term name="political_science">political science</term>    <term name="social_science">social science</term>    <term name="theology">theology</term>    <term name="zoology">zoology</term>        <!-- LONG LOCATOR FORMS -->    <term name="book">      <single>book</single>      <multiple>books</multiple>    </term>    <term name="chapter">      <single>chapter</single>      <multiple>chapters</multiple>    </term>    <term name="column">      <single>column</single>      <multiple>columns</multiple>    </term>    <term name="figure">      <single>figure</single>      <multiple>figures</multiple>    </term>    <term name="folio">      <single>folio</single>      <multiple>folios</multiple>    </term>    <term name="issue">      <single>number</single>      <multiple>numbers</multiple>    </term>    <term name="line">      <single>line</single>      <multiple>lines</multiple>    </term>    <term name="note">      <single>note</single>      <multiple>notes</multiple>    </term>    <term name="opus">      <single>opus</single>      <multiple>opera</multiple>    </term>    <term name="page">      <single>page</single>      <multiple>pages</multiple>    </term>    <term name="paragraph">      <single>paragraph</single>      <multiple>paragraph</multiple>    </term>    <term name="part">      <single>part</single>      <multiple>parts</multiple>    </term>    <term name="section">      <single>section</single>      <multiple>sections</multiple>    </term>    <term name="volume">      <single>volume</single>      <multiple>volumes</multiple>    </term>    <term name="edition">      <single>edition</single>      <multiple>editions</multiple>    </term>    <term name="verse">      <single>verse</single>      <multiple>verses</multiple>    </term>    <term name="sub verbo">      <single>sub verbo</single>      <multiple>s.vv</multiple>    </term>        <!-- SHORT LOCATOR FORMS -->    <term name="book" form="short">bk.</term>    <term name="chapter" form="short">chap.</term>    <term name="column" form="short">col.</term>    <term name="figure" form="short">fig.</term>    <term name="folio" form="short">f.</term>    <term name="issue" form="short">no.</term>    <term name="opus" form="short">op.</term>    <term name="page" form="short">      <single>p.</single>      <multiple>pp.</multiple>    </term>    <term name="paragraph" form="short">para.</term>    <term name="part" form="short">pt.</term>    <term name="section" form="short">sec.</term>    <term name="sub verbo" form="short">      <single>s.v.</single>      <multiple>s.vv.</multiple>    </term>    <term name="verse" form="short">      <single>v.</single>      <multiple>vv.</multiple>    </term>    <term name="volume" form="short">     <single>vol.</single>     <multiple>vols.</multiple>    </term>    <term name="edition">edition</term>    <term name="edition" form="short">ed.</term>        <!-- SYMBOL LOCATOR FORMS -->    <term name="paragraph" form="symbol">      <single>¶</single>      <multiple>¶¶</multiple>    </term>    <term name="section" form="symbol">      <single>§</single>      <multiple>§§</multiple>    </term>        <!-- LONG ROLE FORMS -->    <term name="author">      <single></single>      <multiple></multiple>    </term>    <term name="editor">      <single>editor</single>      <multiple>editors</multiple>    </term>    <term name="translator">      <single>translator</single>      <multiple>translators</multiple>    </term>        <!-- SHORT ROLE FORMS -->    <term name="author" form="short">      <single></single>      <multiple></multiple>    </term>    <term name="editor" form="short">      <single>ed.</single>      <multiple>eds.</multiple>    </term>    <term name="translator" form="short">      <single>tran.</single>      <multiple>trans.</multiple>    </term>        <!-- VERB ROLE FORMS -->    <term name="editor" form="verb">edited by</term>    <term name="translator" form="verb">translated by</term>    <term name="recipient" form="verb">to</term>    <term name="interviewer" form="verb">interview by</term>        <!-- SHORT VERB ROLE FORMS -->    <term name="editor" form="verb-short">ed.</term>    <term name="translator" form="verb-short">trans.</term>        <!-- LONG MONTH FORMS -->    <term name="month-01">January</term>    <term name="month-02">February</term>    <term name="month-03">March</term>    <term name="month-04">April</term>    <term name="month-05">May</term>    <term name="month-06">June</term>    <term name="month-07">July</term>    <term name="month-08">August</term>    <term name="month-09">September</term>    <term name="month-10">October</term>    <term name="month-11">November</term>    <term name="month-12">December</term>        <!-- SHORT MONTH FORMS -->    <term name="month-01" form="short">Jan.</term>    <term name="month-02" form="short">Feb.</term>    <term name="month-03" form="short">Mar.</term>    <term name="month-04" form="short">Apr.</term> <term name="month-05" form="short">May</term>    <term name="month-06" form="short">Jun.</term>    <term name="month-07" form="short">Jul.</term>    <term name="month-08" form="short">Aug.</term>    <term name="month-09" form="short">Sep.</term>    <term name="month-10" form="short">Oct.</term>    <term name="month-11" form="short">Nov.</term>    <term name="month-12" form="short">Dec.</term>  </terms></locale>'
},e.exports=s},{}],15:[function(t,e,i){function s(){this.lastSearch="",this.lastResult=[],this.name="crossref",this.label="CrossRef"}s.resolveDOI=function(t){var e=$.Deferred();return/^http:/.exec(t)||(t="http://dx.doi.org/"+t),$.ajax(t,{type:"GET",crossDomain:!0,cache:!1,headers:{Accept:"application/citeproc+json"},success:function(t){e.resolve(t)},error:function(t,i,s){window.console.error("Could not retrieve data from cross-ref",i,s),e.rejectWith(null,s)}}),e},s.prototype.find=function(t,e){var i,n,r,o,a=$.Deferred(),l=this;return this.lastSearch===t?(o=this.lastResult,window.setTimeout(function(){o.forEach(function(t){a.notifyWith(e,[t])}),a.resolveWith(e)},0)):(this.lastSearch="",this.lastSearch=[],o=[],i=t.trim().toLowerCase().split(/\s+/),n=i.join("+"),r=0,$.ajax("http://search.crossref.org/dois",{data:{q:n,sort:"score"},success:function(i){function n(){if(r<i.length){var c=i[r++],u=s.resolveDOI(c.doi);u.done(function(t){"pending"===a.state()&&(o.push(t),a.notifyWith(e,[t]))}).always(function(){"pending"===a.state()&&n()})}else l.lastSearch=t,l.lastResult=o,a.resolveWith(e)}n()},error:function(t,i,s){a.rejectWith(e,[s])}})),a},e.exports=s},{}],16:[function(t,e,i){function s(t,e,i,s){this.doc=t,this.containerId=e,this.itemType=i,this.labelPrefix=s,this.doc.connect(this,{"operation:applied":this.onOperationApplied})}var n=t("substance"),r=t("substance/helpers");s.Prototype=function(){this.dispose=function(){this.doc.disconnect(this)},this.getDocument=function(){return this.doc},this.determineItems=function(){var t=this.doc,e=t.get(this.containerId),i=t.getIndex("type").get(this.itemType),s=[];r.each(i,function(t){var i,n,o=r.map(e.getComponent([t.id])),a=r.first(o);a?(n=!0,i=a.getIndex()):(n=!1,i=Number.MAX_VALUE),s.push({pos:i,item:t,isShown:n})}),s=r.sortBy(s,"pos");var n=0;return r.each(s,function(t){t.isShown?t.index=n++:t.index=-1}),s},this.createItemLabel=function(t){return t.index<0?this.labelPrefix+" ?":[this.labelPrefix,t.index+1].join(" ")},this.createCitationLabel=function(t){var e,i=t.citation,s=i.targets,n=[],o=this.doc;r.each(s,function(t){var i=o.get(t),s=this.items.indexOf(i);if(0>s)return console.error("citation target not found: ",t),void(e=t);var r=this._items[s];if(r.index<0)return console.error("citation target does not have a label: ",t),void(e=t);var a=r.index+1;n.push(a)},this),n.sort();var a;return a=0===n.length?this.labelPrefix+" ???":[this.labelPrefix,n.join(", ")].join(" ")},this.updateItemLabels=function(){r.each(this._items,function(t){var e=this.createItemLabel(t);t.item.setLabel(e)},this)},this.updateCitationLabels=function(){r.each(this._citations,function(t){var e=this.createCitationLabel(t);t.citation.setLabel(e)},this)},this.determineCitations=function(){var t=this.doc,e=t.getIndex("type").get(this.itemType+"_citation"),i=t.get(this.containerId),s=r.map(e,function(t){var e=i.getComponent(t.path);return{citation:t,comp:e}});return s.sort(function(t,e){var i=t.comp.getIndex()-e.comp.getIndex();return 0===i&&(i=t.citation.startOffset-e.citation.startOffset),i}),s},this.update=function(){this._items=this.determineItems(),this.items=r.pluck(this._items,"item"),this._citations=this.determineCitations(),this.citations=r.pluck(this._citations,"citation"),this.updateItemLabels(),this.updateCitationLabels()},this.getItems=function(){return this.items},this.onOperationApplied=function(t){if(t.path[0]===this.containerId){if("set"===t.type)return this.update();if("update"===t.type){var e=t.diff.val,i=this.doc.get(e);if(!i)return;if(i.type===this.itemType)return this.update();if("include"===i.type){if(i=i.getIncludedNode(),!i)return;if(i.type===this.itemType)return this.update()}}}}},n.initClass(s),e.exports=s},{substance:171,"substance/helpers":170}],17:[function(t,e,i){function s(){s["super"].call(this,{schema:a})}var n=t("substance"),r=n._,o=n.Document.HtmlExporter,a=t("../article_schema");s.Prototype=function(){this.convert=function(t,e){this.initialize(t,e);var i=this.createHtmlDocument(),s=i.find("head");s.append($("<!-- title is only there to calm down the validator. do not edit -->")).append($("<title>🐰</title>")).append($('<meta charset="utf-8" />'));var n=i.find("body");return n.append(this.header()),n.append(this.main()),["<!DOCTYPE html>",'<html lang="en">',i.find("html").html(),"</html>"].join("")},this.header=function(){var t=this.state.doc,e=$("<header>"),i=t.get("article-meta");e.append(i.toHtml(this));var s=t.getIndex("type").get("image_figure");r.each(s,function(t){e.append(t.toHtml(this))},this);var n=t.getIndex("type").get("table_figure");r.each(n,function(t){e.append(t.toHtml(this))},this);var o=t.getIndex("type").get("bib_item");return r.each(o,function(t){e.append(t.toHtml(this))},this),e},this.main=function(){var t=this.state.doc,e=t.get("main"),i=$("<main>").append(this.convertContainer(e));return i}},n.inherit(s,o),e.exports=s},{"../article_schema":7,substance:171}],18:[function(t,e,i){function s(){s["super"].call(this,{schema:o})}var n=t("substance"),r=n.Document.HtmlImporter,o=t("../article_schema");s.Prototype=function(){this.convert=function(t,e){this.initialize(e,t);var i=t.find("meta");if(!i.length)throw new Error("meta is mandatory");var s=t.find("resources");if(!s.length)throw new Error("resources is mandatory");var n=t.find("body");if(!n.length)throw new Error("body is mandatory");this.meta(i),this.resources(s),this.body(n),this.finish()},this.meta=function(t){this.convertElement(t)},this.resources=function(t){var e=this;this.state.doc;t.children().each(function(){var t=e.$(this);e.convertElement(t)})},this.body=function(t){this.convertContainer(t,"main")}},n.inherit(s,r),e.exports=s},{"../article_schema":7,substance:171}],19:[function(t,e,i){function s(){s["super"].call(this,{schema:a})}var n=t("substance"),r=n._,o=n.Document.HtmlExporter,a=t("../article_schema");s.Prototype=function(){this.convert=function(t,e){this.initialize(t,e);var i=this.createXmlDocument(),s=i.find("article");s.append(this.meta()),s.append(this.resources()),s.append(this.body());var n=(new XMLSerializer).serializeToString(i[0]);return window.res=n,n=n.replace("http://www.w3.org/1999/xhtml","http://substance.io/science-article/0.1.0")},this.meta=function(){var t=this.state.doc,e=t.get("article-meta");return e.toHtml(this)},this.resources=function(){var t=this.state.doc,e=$("<resources>"),i=t.getIndex("type").get("image_figure");r.each(i,function(t){e.append(t.toHtml(this))},this);var s=t.getIndex("type").get("table_figure");r.each(s,function(t){e.append(t.toHtml(this))},this);var n=t.getIndex("type").get("bib_item");return r.each(n,function(t){e.append(t.toHtml(this))},this),e},this.body=function(){var t=this.state.doc,e=t.get("main"),i=(this.convertContainer(e),$("<body>").append(this.convertContainer(e)));return i}},n.inherit(s,o),e.exports=s},{"../article_schema":7,substance:171}],20:[function(t,e,i){e.exports=t("./article")},{"./article":6}],21:[function(t,e,i){var s=t("substance"),n=s.Document.Node.extend({name:"article-meta",properties:{title:"string","abstract":"string"}});n["static"].matchElement=function(t){return t.is("meta")},n["static"].fromHtml=function(t,e){var i="article-meta",s={id:i,title:"","abstract":""},n=t.find("title");n.length?s.title=e.annotatedText(n,[i,"title"]):e.warning("ArticleMeta: no title found.");var r=t.find("abstract");return r.length?s["abstract"]=e.annotatedText(r,[i,"abstract"]):e.warning("ArticleMeta: no abstract found."),s},n["static"].toHtml=function(t,e){var i=t.id,s=$("<meta>"),n=$("<title>").append(e.annotatedText([i,"title"])),r=$("<abstract>").append(e.annotatedText([i,"abstract"]));return s.append(n,r)},e.exports=n},{substance:171}],22:[function(t,e,i){var s=t("substance"),n=s.Document.Node,r=n.extend({name:"bib_item",properties:{source:"string",format:"string"},setLabel:function(t){this.label=t,this.emit("label",t)},setText:function(t){this.text=t},init:function(){"citeproc"===this.format?(this.data=JSON.parse(this.source),this.guid=this.data.DOI||this.data.ISSN||this.id):(this.data=this.source,this.guid=this.id)},didAttach:function(t){t.isTransaction()||t.isClipboard()||this.updateCollection(t)},didDetach:function(t){t.isTransaction()||t.isClipboard()||this.updateCollection(t)},updateCollection:function(t){var e=t.getCollection(this.type);e&&e.update()}});r["static"].citationType="bib_item_citation",r["static"].matchElement=function(t){return t.is("bib")},r["static"].fromHtml=function(t,e){var i=e.defaultId(t,"bib"),s={id:i,source:"",format:""};return s.format="citeproc",s.source=t.text(),s},r["static"].toHtml=function(t){var e=t.id,i=$("<bib>").attr("format","citeproc").attr("id",e).text(JSON.stringify(t.data));return i},e.exports=r},{substance:171}],23:[function(t,e,i){var s=(t("substance"),t("./citation")),n=s.extend({name:"bib_item_citation",getItemType:function(){return"bib_item"}});n["static"].matchElement=function(t){return t.is(n["static"].tagName)&&"bib"===t.attr("data-rtype")},n["static"].fromHtml=function(t,e){return s["static"].fromHtml(t,e)},n["static"].toHtml=function(t,e){var i=s["static"].toHtml(t,e);return i.attr("data-rtype","bib"),i},e.exports=n},{"./citation":24,substance:171}],24:[function(t,e,i){var s=t("substance"),n=t("substance/helpers"),r=s.Document.Annotation.extend({name:"citation",properties:{targets:["array","id"]},getDefaultProperties:function(){return{targets:[]}},setLabel:function(t){this.label=t,this.emit("label:changed")},didAttach:function(t){t.isTransaction()||t.isClipboard()||(t.getEventProxy("path").connect(this,[this.id,"targets"],this.onChange),t.getEventProxy("path").connect(this,[this.id,"path"],this.onChange),this.updateCollection(t))},didDetach:function(t){t.getEventProxy("path").disconnect(this,[this.id,"targets"]),t.getEventProxy("path").disconnect(this,[this.id,"path"]),this.updateCollection(t)},updateCollection:function(t){var e=t.getCollection(this.getItemType());e&&e.update()},onChange:function(t,e,i){this.updateCollection(i)}});r["static"].tagName="cite",r["static"].external=!0,r["static"].fromHtml=function(t,e){var i={targets:n.compact(t.attr("data-rid").split(" "))};return i},r["static"].toHtml=function(t,e){var i=t.id,s=t.targets.join(" "),n=$("<cite>").attr("id",i).attr("data-rid",s);return n},e.exports=r},{substance:171,"substance/helpers":170}],25:[function(t,e,i){var s=t("substance"),n=s.Document.Node.extend({name:"figure",properties:{title:"string",caption:"string",content:"id"},setLabel:function(t){this.label=t,this.emit("label",t)},setText:function(t){this.text=t},init:function(){this.guid=this.id},getContentNode:function(){return this.document.get(this.content)}});n["static"].components=["title","caption"],n["static"].fromHtml=function(t,e){var i=e.defaultId(t,"fig"),s={id:i,title:"",caption:""};return t.children().each(function(){var t=$(this),n=t[0].tagName.toLowerCase();switch(n){case"title":case"caption":s[n]=e.annotatedText(t,[i,n])}}),s},n["static"].toHtml=function(t,e,i){var s=e.id,n=$("<"+t+">").attr("id",s),r=$("<title>").append(i.annotatedText([s,"title"])),o=e.getContentNode().toHtml(i),a=$("<caption>").append(i.annotatedText([s,"caption"]));return n.append(r,o,a)},e.exports=n},{substance:171}],26:[function(t,e,i){var s=t("substance"),n=s.Document.Node.extend({name:"image",properties:{src:"string",previewSrc:"string"}});n["static"].matchElement=function(t){return t.is("img")},n["static"].fromHtml=function(t,e){var i=e.defaultId(t,"img"),s={id:i,src:t.attr("src"),previewSrc:t.attr("data-preview-src")};return s},n["static"].toHtml=function(t,e){var i=$("<img>").attr("id",t.id).attr("src",t.src).attr("data-preview-src",t.previewSrc);return i},e.exports=n},{substance:171}],27:[function(t,e,i){var s=(t("substance"),t("./figure")),n=s.extend({name:"image_figure"});n["static"].citationType="image_figure_citation",n["static"].matchElement=function(t){return t.is("image-figure")},n["static"].fromHtml=function(t,e){var i=s["static"].fromHtml(t,e),n=e.convertElement(t.find("img"),{parent:i.id});return i.content=n.id,i},n["static"].toHtml=function(t,e){return s["static"].toHtml("image-figure",t,e)},e.exports=n},{"./figure":25,substance:171}],28:[function(t,e,i){var s=(t("substance"),t("./citation")),n=s.extend({name:"image_figure_citation",getItemType:function(){return"image_figure"}});n["static"].matchElement=function(t){return t.is(n["static"].tagName)&&"image_figure"===t.attr("data-rtype")},n["static"].fromHtml=function(t,e){return s["static"].fromHtml(t,e)},n["static"].toHtml=function(t,e){var i=s["static"].toHtml(t,e);return i.attr("data-rtype","image_figure"),i},e.exports=n},{"./citation":24,substance:171}],29:[function(t,e,i){var s=(t("substance"),t("./figure")),n=s.extend({name:"table_figure"});n["static"].components=["title","content","caption"],n["static"].citationType="table_figure_citation",n["static"].matchElement=function(t){return t.is("table-figure")},n["static"].fromHtml=function(t,e){var i=s["static"].fromHtml(t,e),n=e.convertElement(t.find("table"),{parent:i.id});return i.content=n.id,i},n["static"].toHtml=function(t,e){return s["static"].toHtml("table-figure",t,e)},e.exports=n},{"./figure":25,substance:171}],30:[function(t,e,i){var s=(t("substance"),t("./citation")),n=s.extend({name:"table_figure_citation",getItemType:function(){return"table_figure"}});n["static"].matchElement=function(t){return t.is(n["static"].tagName)&&"table_figure"===t.attr("data-rtype")},n["static"].fromHtml=function(t,e){return s["static"].fromHtml(t,e)},n["static"].toHtml=function(t,e){var i=s["static"].toHtml(t,e);return i.attr("data-rtype","table_figure"),i},e.exports=n},{"./citation":24,substance:171}],31:[function(t,e,i){function s(t){for(var e=-1,i=t?t.length:0,s=-1,n=[];++e<i;){var r=t[e];r&&(n[++s]=r)}return n}e.exports=s},{}],32:[function(t,e,i){function s(t,e,i){var s=-1,r=t?t.length:0;for(e=n(e,i,3);++s<r;)if(e(t[s],s,t))return s;return-1}var n=t("../internal/baseCallback");e.exports=s},{"../internal/baseCallback":57}],33:[function(t,e,i){function s(t){return t?t[0]:void 0}e.exports=s},{}],34:[function(t,e,i){function s(){for(var t=[],e=-1,i=arguments.length,s=[],c=n,u=!0;++e<i;){var h=arguments[e];(l(h)||a(h))&&(t.push(h),s.push(u&&h.length>=120?o(e&&h):null))}i=t.length;var p=t[0],f=-1,d=p?p.length:0,m=[],g=s[0];t:for(;++f<d;)if(h=p[f],(g?r(g,h):c(m,h))<0){for(e=i;--e;){var b=s[e];if((b?r(b,h):c(t[e],h))<0)continue t}g&&g.push(h),m.push(h)}return m}var n=t("../internal/baseIndexOf"),r=t("../internal/cacheIndexOf"),o=t("../internal/createCache"),a=t("../lang/isArguments"),l=t("../lang/isArray");e.exports=s},{"../internal/baseIndexOf":70,"../internal/cacheIndexOf":87,"../internal/createCache":95,"../lang/isArguments":124,"../lang/isArray":125}],35:[function(t,e,i){function s(t){var e=t?t.length:0;return e?t[e-1]:void 0}e.exports=s},{}],36:[function(t,e,i){function s(){return r(n(arguments,!1,!0))}var n=t("../internal/baseFlatten"),r=t("../internal/baseUniq");e.exports=s},{"../internal/baseFlatten":67,"../internal/baseUniq":83}],37:[function(t,e,i){function s(t,e,i,s){var l=t?t.length:0;return l?(null!=e&&"boolean"!=typeof e&&(s=i,i=o(t,e,s)?null:e,e=!1),i=null==i?i:n(i,s,3),e?a(t,i):r(t,i)):[]}var n=t("../internal/baseCallback"),r=t("../internal/baseUniq"),o=t("../internal/isIterateeCall"),a=t("../internal/sortedUniq");e.exports=s},{"../internal/baseCallback":57,"../internal/baseUniq":83,"../internal/isIterateeCall":110,"../internal/sortedUniq":120}],38:[function(t,e,i){function s(t){return n(t,r(arguments,1))}var n=t("../internal/baseDifference"),r=t("../internal/baseSlice");e.exports=s},{"../internal/baseDifference":63,"../internal/baseSlice":80}],39:[function(t,e,i){function s(t,e,i){var s=a(t)?n:o;return e=r(e,i,3),s(t,e)}var n=t("../internal/arrayFilter"),r=t("../internal/baseCallback"),o=t("../internal/baseFilter"),a=t("../lang/isArray");e.exports=s},{"../internal/arrayFilter":54,"../internal/baseCallback":57,"../internal/baseFilter":65,"../lang/isArray":125}],40:[function(t,e,i){function s(t,e,i){if(l(t)){var s=a(t,e,i);return s>-1?t[s]:void 0}return e=n(e,i,3),o(t,e,r)}var n=t("../internal/baseCallback"),r=t("../internal/baseEach"),o=t("../internal/baseFind"),a=t("../array/findIndex"),l=t("../lang/isArray");e.exports=s},{"../array/findIndex":32,"../internal/baseCallback":57,"../internal/baseEach":64,"../internal/baseFind":66,"../lang/isArray":125}],41:[function(t,e,i){function s(t,e,i){return"function"==typeof e&&"undefined"==typeof i&&a(t)?n(t,e):r(t,o(e,i,3))}var n=t("../internal/arrayEach"),r=t("../internal/baseEach"),o=t("../internal/bindCallback"),a=t("../lang/isArray");e.exports=s},{"../internal/arrayEach":53,"../internal/baseEach":64,"../internal/bindCallback":85,"../lang/isArray":125}],42:[function(t,e,i){function s(t,e,i){var s=t?t.length:0;return o(s)||(t=l(t),s=t.length),s?(i="number"==typeof i?0>i?c(s+i,0):i||0:0,"string"==typeof t||!r(t)&&a(t)?s>i&&t.indexOf(e,i)>-1:n(t,e,i)>-1):!1}var n=t("../internal/baseIndexOf"),r=t("../lang/isArray"),o=t("../internal/isLength"),a=t("../lang/isString"),l=t("../object/values"),c=Math.max;e.exports=s},{"../internal/baseIndexOf":70,"../internal/isLength":111,"../lang/isArray":125,"../lang/isString":133,"../object/values":139}],43:[function(t,e,i){var s=t("../internal/createAggregator"),n=s(function(t,e,i){t[i]=e});e.exports=n},{"../internal/createAggregator":92}],44:[function(t,e,i){function s(t,e,i){var s=a(t)?n:o;return e=r(e,i,3),s(t,e)}var n=t("../internal/arrayMap"),r=t("../internal/baseCallback"),o=t("../internal/baseMap"),a=t("../lang/isArray");e.exports=s},{"../internal/arrayMap":55,"../internal/baseCallback":57,"../internal/baseMap":75,"../lang/isArray":125}],45:[function(t,e,i){function s(t,e){return r(t,n(e))}var n=t("../internal/baseProperty"),r=t("./map");e.exports=s},{"../internal/baseProperty":78,"./map":44}],46:[function(t,e,i){function s(t,e,i){var s=-1,u=t?t.length:0,h=c(u)?Array(u):[];return i&&l(t,e,i)&&(e=null),e=n(e,i,3),r(t,function(t,i,n){h[++s]={criteria:e(t,i,n),index:s,value:t}}),o(h,a)}var n=t("../internal/baseCallback"),r=t("../internal/baseEach"),o=t("../internal/baseSortBy"),a=t("../internal/compareAscending"),l=t("../internal/isIterateeCall"),c=t("../internal/isLength");e.exports=s},{"../internal/baseCallback":57,"../internal/baseEach":64,"../internal/baseSortBy":81,"../internal/compareAscending":89,"../internal/isIterateeCall":110,"../internal/isLength":111}],47:[function(t,e,i){var s=t("../lang/isNative"),n=s(n=Date.now)&&n,r=n||function(){return(new Date).getTime()};e.exports=r},{"../lang/isNative":130}],48:[function(t,e,i){function s(t,e){var i=a;if(arguments.length>2){var c=n(arguments,2),u=o(c,s.placeholder);i|=l}return r(t,i,e,c,u)}var n=t("../internal/baseSlice"),r=t("../internal/createWrapper"),o=t("../internal/replaceHolders"),a=1,l=32;s.placeholder={},e.exports=s},{"../internal/baseSlice":80,"../internal/createWrapper":99,"../internal/replaceHolders":117}],49:[function(t,e,i){function s(t,e,i){function s(){g&&clearTimeout(g),p&&clearTimeout(p),p=g=b=void 0}function l(){var i=e-(r()-d);if(0>=i||i>e){p&&clearTimeout(p);var s=b;p=g=b=void 0,s&&(v=r(),f=t.apply(m,h),g||p||(h=m=null))}else g=setTimeout(l,i)}function c(){g&&clearTimeout(g),p=g=b=void 0,(_||y!==e)&&(v=r(),f=t.apply(m,h),g||p||(h=m=null))}function u(){if(h=arguments,d=r(),m=this,b=_&&(g||!x),y===!1)var i=x&&!g;else{p||x||(v=d);var s=y-(d-v),n=0>=s||s>y;n?(p&&(p=clearTimeout(p)),v=d,f=t.apply(m,h)):p||(p=setTimeout(c,s))}return n&&g?g=clearTimeout(g):g||e===y||(g=setTimeout(l,e)),i&&(n=!0,f=t.apply(m,h)),!n||g||p||(h=m=null),f}var h,p,f,d,m,g,b,v=0,y=!1,_=!0;if("function"!=typeof t)throw new TypeError(o);if(e=0>e?0:+e||0,i===!0){var x=!0;_=!1}else n(i)&&(x=i.leading,y="maxWait"in i&&a(+i.maxWait||0,e),_="trailing"in i?i.trailing:_);return u.cancel=s,u}var n=t("../lang/isObject"),r=t("../date/now"),o="Expected a function",a=Math.max;e.exports=s},{"../date/now":47,"../lang/isObject":132}],50:[function(t,e,i){function s(t,e){return n(t,e,arguments,2)}var n=t("../internal/baseDelay");e.exports=s},{"../internal/baseDelay":62}],51:[function(t,e,i){(function(i){function s(t){var e=t?t.length:0;for(this.data={hash:a(null),set:new o};e--;)this.push(t[e])}var n=t("./cachePush"),r=t("../lang/isNative"),o=r(o=i.Set)&&o,a=r(a=Object.create)&&a;s.prototype.push=n,e.exports=s}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../lang/isNative":130,"./cachePush":88}],52:[function(t,e,i){function s(t,e){var i=-1,s=t.length;for(e||(e=Array(s));++i<s;)e[i]=t[i];return e}e.exports=s},{}],53:[function(t,e,i){function s(t,e){for(var i=-1,s=t.length;++i<s&&e(t[i],i,t)!==!1;);return t}e.exports=s},{}],54:[function(t,e,i){function s(t,e){for(var i=-1,s=t.length,n=-1,r=[];++i<s;){var o=t[i];e(o,i,t)&&(r[++n]=o)}return r}e.exports=s},{}],55:[function(t,e,i){function s(t,e){for(var i=-1,s=t.length,n=Array(s);++i<s;)n[i]=e(t[i],i,t);return n}e.exports=s},{}],56:[function(t,e,i){function s(t,e,i){var s=r(e);if(!i)return n(e,t,s);for(var o=-1,a=s.length;++o<a;){var l=s[o],c=t[l],u=i(c,e[l],l,t,e);(u===u?u===c:c!==c)&&("undefined"!=typeof c||l in t)||(t[l]=u)}return t}var n=t("./baseCopy"),r=t("../object/keys");e.exports=s},{"../object/keys":137,"./baseCopy":60}],57:[function(t,e,i){function s(t,e,i){var s=typeof t;return"function"==s?"undefined"!=typeof e&&c(t)?a(t,e,i):t:null==t?l:"object"==s?n(t):"undefined"==typeof e?o(t+""):r(t+"",e)}var n=t("./baseMatches"),r=t("./baseMatchesProperty"),o=t("./baseProperty"),a=t("./bindCallback"),l=t("../utility/identity"),c=t("./isBindable");e.exports=s},{"../utility/identity":143,"./baseMatches":76,"./baseMatchesProperty":77,"./baseProperty":78,"./bindCallback":85,"./isBindable":108}],58:[function(t,e,i){function s(t,e,i,m,g,b,v){var _;if(i&&(_=g?i(t,m,g):i(t)),"undefined"!=typeof _)return _;if(!p(t))return t;var x=h(t);if(x){if(_=l(t),!e)return n(t,_)}else{var S=B.call(t),O=S==y;if(S!=w&&S!=d&&(!O||g))return M[S]?c(t,S,e):g?t:{};if(_=u(O?{}:t),!e)return o(t,_,f(t))}b||(b=[]),v||(v=[]);for(var T=b.length;T--;)if(b[T]==t)return v[T];return b.push(t),v.push(_),(x?r:a)(t,function(n,r){_[r]=s(n,e,i,r,t,b,v)}),_}var n=t("./arrayCopy"),r=t("./arrayEach"),o=t("./baseCopy"),a=t("./baseForOwn"),l=t("./initCloneArray"),c=t("./initCloneByTag"),u=t("./initCloneObject"),h=t("../lang/isArray"),p=t("../lang/isObject"),f=t("../object/keys"),d="[object Arguments]",m="[object Array]",g="[object Boolean]",b="[object Date]",v="[object Error]",y="[object Function]",_="[object Map]",x="[object Number]",w="[object Object]",S="[object RegExp]",O="[object Set]",T="[object String]",I="[object WeakMap]",N="[object ArrayBuffer]",E="[object Float32Array]",C="[object Float64Array]",A="[object Int8Array]",k="[object Int16Array]",R="[object Int32Array]",P="[object Uint8Array]",D="[object Uint8ClampedArray]",j="[object Uint16Array]",L="[object Uint32Array]",M={};M[d]=M[m]=M[N]=M[g]=M[b]=M[E]=M[C]=M[A]=M[k]=M[R]=M[x]=M[w]=M[S]=M[T]=M[P]=M[D]=M[j]=M[L]=!0,M[v]=M[y]=M[_]=M[O]=M[I]=!1;var U=Object.prototype,B=U.toString;e.exports=s},{"../lang/isArray":125,"../lang/isObject":132,"../object/keys":137,"./arrayCopy":52,"./arrayEach":53,"./baseCopy":60,"./baseForOwn":69,"./initCloneArray":105,"./initCloneByTag":106,"./initCloneObject":107}],59:[function(t,e,i){function s(t,e){if(t!==e){var i=t===t,s=e===e;if(t>e||!i||"undefined"==typeof t&&s)return 1;if(e>t||!s||"undefined"==typeof e&&i)return-1}return 0}e.exports=s},{}],60:[function(t,e,i){function s(t,e,i){i||(i=e,e={});for(var s=-1,n=i.length;++s<n;){var r=i[s];e[r]=t[r]}return e}e.exports=s},{}],61:[function(t,e,i){(function(i){var s=t("../lang/isObject"),n=function(){function t(){}return function(e){if(s(e)){t.prototype=e;var n=new t;t.prototype=null}return n||i.Object()}}();e.exports=n}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../lang/isObject":132}],62:[function(t,e,i){function s(t,e,i,s){if("function"!=typeof t)throw new TypeError(r);return setTimeout(function(){t.apply(void 0,n(i,s))},e)}var n=t("./baseSlice"),r="Expected a function";e.exports=s},{"./baseSlice":80}],63:[function(t,e,i){function s(t,e){var i=t?t.length:0,s=[];if(!i)return s;var a=-1,l=n,c=!0,u=c&&e.length>=200?o(e):null,h=e.length;u&&(l=r,c=!1,e=u);t:for(;++a<i;){var p=t[a];if(c&&p===p){for(var f=h;f--;)if(e[f]===p)continue t;s.push(p)}else l(e,p)<0&&s.push(p)}return s}var n=t("./baseIndexOf"),r=t("./cacheIndexOf"),o=t("./createCache");e.exports=s},{"./baseIndexOf":70,"./cacheIndexOf":87,"./createCache":95}],64:[function(t,e,i){function s(t,e){var i=t?t.length:0;if(!r(i))return n(t,e);for(var s=-1,a=o(t);++s<i&&e(a[s],s,a)!==!1;);return t}var n=t("./baseForOwn"),r=t("./isLength"),o=t("./toObject");e.exports=s},{"./baseForOwn":69,"./isLength":111,"./toObject":121}],65:[function(t,e,i){function s(t,e){var i=[];return n(t,function(t,s,n){e(t,s,n)&&i.push(t)}),i}var n=t("./baseEach");e.exports=s},{"./baseEach":64}],66:[function(t,e,i){function s(t,e,i,s){var n;return i(t,function(t,i,r){return e(t,i,r)?(n=s?i:t,!1):void 0}),n}e.exports=s},{}],67:[function(t,e,i){function s(t,e,i,l){for(var c=(l||0)-1,u=t.length,h=-1,p=[];++c<u;){var f=t[c];if(a(f)&&o(f.length)&&(r(f)||n(f))){e&&(f=s(f,e,i));var d=-1,m=f.length;for(p.length+=m;++d<m;)p[++h]=f[d]}else i||(p[++h]=f)}return p}var n=t("../lang/isArguments"),r=t("../lang/isArray"),o=t("./isLength"),a=t("./isObjectLike");e.exports=s},{"../lang/isArguments":124,"../lang/isArray":125,"./isLength":111,"./isObjectLike":112}],68:[function(t,e,i){function s(t,e,i){for(var s=-1,r=n(t),o=i(t),a=o.length;++s<a;){var l=o[s];if(e(r[l],l,r)===!1)break}return t}var n=t("./toObject");e.exports=s},{"./toObject":121}],69:[function(t,e,i){function s(t,e){return n(t,e,r)}var n=t("./baseFor"),r=t("../object/keys");e.exports=s},{"../object/keys":137,"./baseFor":68}],70:[function(t,e,i){function s(t,e,i){if(e!==e)return n(t,i);for(var s=(i||0)-1,r=t.length;++s<r;)if(t[s]===e)return s;return-1}var n=t("./indexOfNaN");e.exports=s},{"./indexOfNaN":104}],71:[function(t,e,i){function s(t,e,i,r,o,a){if(t===e)return 0!==t||1/t==1/e;var l=typeof t,c=typeof e;return"function"!=l&&"object"!=l&&"function"!=c&&"object"!=c||null==t||null==e?t!==t&&e!==e:n(t,e,s,i,r,o,a)}var n=t("./baseIsEqualDeep");e.exports=s},{"./baseIsEqualDeep":72}],72:[function(t,e,i){function s(t,e,i,s,p,m,g){var b=a(t),v=a(e),y=u,_=u;b||(y=d.call(t),y==c?y=h:y!=h&&(b=l(t))),v||(_=d.call(e),_==c?_=h:_!=h&&(v=l(e)));var x=y==h,w=_==h,S=y==_;if(S&&!b&&!x)return r(t,e,y);var O=x&&f.call(t,"__wrapped__"),T=w&&f.call(e,"__wrapped__");if(O||T)return i(O?t.value():t,T?e.value():e,s,p,m,g);if(!S)return!1;m||(m=[]),g||(g=[]);for(var I=m.length;I--;)if(m[I]==t)return g[I]==e;m.push(t),g.push(e);var N=(b?n:o)(t,e,i,s,p,m,g);return m.pop(),g.pop(),N}var n=t("./equalArrays"),r=t("./equalByTag"),o=t("./equalObjects"),a=t("../lang/isArray"),l=t("../lang/isTypedArray"),c="[object Arguments]",u="[object Array]",h="[object Object]",p=Object.prototype,f=p.hasOwnProperty,d=p.toString;e.exports=s},{"../lang/isArray":125,"../lang/isTypedArray":134,"./equalArrays":100,"./equalByTag":101,"./equalObjects":102}],73:[function(t,e,i){function s(t){return"function"==typeof t||!1}e.exports=s},{}],74:[function(t,e,i){function s(t,e,i,s,r){var a=e.length;if(null==t)return!a;for(var l=-1,c=!r;++l<a;)if(c&&s[l]?i[l]!==t[e[l]]:!o.call(t,e[l]))return!1;for(l=-1;++l<a;){var u=e[l];if(c&&s[l])var h=o.call(t,u);else{var p=t[u],f=i[l];h=r?r(p,f,u):void 0,"undefined"==typeof h&&(h=n(f,p,r,!0))}if(!h)return!1}return!0}var n=t("./baseIsEqual"),r=Object.prototype,o=r.hasOwnProperty;e.exports=s},{"./baseIsEqual":71}],75:[function(t,e,i){function s(t,e){var i=[];return n(t,function(t,s,n){i.push(e(t,s,n))}),i}var n=t("./baseEach");e.exports=s},{"./baseEach":64}],76:[function(t,e,i){function s(t){var e=o(t),i=e.length;if(1==i){var s=e[0],a=t[s];if(r(a))return function(t){return null!=t&&t[s]===a&&l.call(t,s)}}for(var c=Array(i),u=Array(i);i--;)a=t[e[i]],c[i]=a,u[i]=r(a);return function(t){return n(t,e,c,u)}}var n=t("./baseIsMatch"),r=t("./isStrictComparable"),o=t("../object/keys"),a=Object.prototype,l=a.hasOwnProperty;e.exports=s},{"../object/keys":137,"./baseIsMatch":74,"./isStrictComparable":113}],77:[function(t,e,i){function s(t,e){return r(e)?function(i){return null!=i&&i[t]===e}:function(i){return null!=i&&n(e,i[t],null,!0)}}var n=t("./baseIsEqual"),r=t("./isStrictComparable");e.exports=s},{"./baseIsEqual":71,"./isStrictComparable":113}],78:[function(t,e,i){function s(t){return function(e){return null==e?void 0:e[t]}}e.exports=s},{}],79:[function(t,e,i){var s=t("../utility/identity"),n=t("./metaMap"),r=n?function(t,e){return n.set(t,e),t}:s;e.exports=r},{"../utility/identity":143,"./metaMap":115}],80:[function(t,e,i){function s(t,e,i){var s=-1,n=t.length;e=null==e?0:+e||0,0>e&&(e=-e>n?0:n+e),i="undefined"==typeof i||i>n?n:+i||0,0>i&&(i+=n),n=e>i?0:i-e>>>0,e>>>=0;for(var r=Array(n);++s<n;)r[s]=t[s+e];return r}e.exports=s},{}],81:[function(t,e,i){function s(t,e){var i=t.length;for(t.sort(e);i--;)t[i]=t[i].value;return t}e.exports=s},{}],82:[function(t,e,i){function s(t){return"string"==typeof t?t:null==t?"":t+""}e.exports=s},{}],83:[function(t,e,i){function s(t,e){var i=-1,s=n,a=t.length,l=!0,c=l&&a>=200,u=c?o():null,h=[];u?(s=r,l=!1):(c=!1,u=e?[]:h);t:for(;++i<a;){var p=t[i],f=e?e(p,i,t):p;if(l&&p===p){for(var d=u.length;d--;)if(u[d]===f)continue t;e&&u.push(f),h.push(p)}else s(u,f)<0&&((e||c)&&u.push(f),h.push(p))}return h}var n=t("./baseIndexOf"),r=t("./cacheIndexOf"),o=t("./createCache");e.exports=s},{"./baseIndexOf":70,"./cacheIndexOf":87,"./createCache":95}],84:[function(t,e,i){function s(t,e){for(var i=-1,s=e.length,n=Array(s);++i<s;)n[i]=t[e[i]];return n}e.exports=s},{}],85:[function(t,e,i){function s(t,e,i){if("function"!=typeof t)return n;if("undefined"==typeof e)return t;switch(i){case 1:return function(i){return t.call(e,i)};case 3:return function(i,s,n){return t.call(e,i,s,n)};case 4:return function(i,s,n,r){return t.call(e,i,s,n,r)};case 5:return function(i,s,n,r,o){return t.call(e,i,s,n,r,o)}}return function(){return t.apply(e,arguments)}}var n=t("../utility/identity");e.exports=s},{"../utility/identity":143}],86:[function(t,e,i){(function(i){function s(t){return a.call(t,0)}var n=t("../utility/constant"),r=t("../lang/isNative"),o=r(o=i.ArrayBuffer)&&o,a=r(a=o&&new o(0).slice)&&a,l=Math.floor,c=r(c=i.Uint8Array)&&c,u=function(){try{var t=r(t=i.Float64Array)&&t,e=new t(new o(10),0,1)&&t}catch(s){}return e}(),h=u?u.BYTES_PER_ELEMENT:0;a||(s=o&&c?function(t){var e=t.byteLength,i=u?l(e/h):0,s=i*h,n=new o(e);if(i){var r=new u(n,0,i);r.set(new u(t,0,i))}return e!=s&&(r=new c(n,s),r.set(new c(t,s))),n}:n(null)),e.exports=s}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../lang/isNative":130,"../utility/constant":142}],87:[function(t,e,i){function s(t,e){var i=t.data,s="string"==typeof e||n(e)?i.set.has(e):i.hash[e];return s?0:-1}var n=t("../lang/isObject");e.exports=s},{"../lang/isObject":132}],88:[function(t,e,i){function s(t){var e=this.data;"string"==typeof t||n(t)?e.set.add(t):e.hash[t]=!0}var n=t("../lang/isObject");e.exports=s},{"../lang/isObject":132}],89:[function(t,e,i){function s(t,e){return n(t.criteria,e.criteria)||t.index-e.index}var n=t("./baseCompareAscending");e.exports=s},{"./baseCompareAscending":59}],90:[function(t,e,i){function s(t,e,i){for(var s=i.length,r=-1,o=n(t.length-s,0),a=-1,l=e.length,c=Array(o+l);++a<l;)c[a]=e[a];for(;++r<s;)c[i[r]]=t[r];for(;o--;)c[a++]=t[r++];return c}var n=Math.max;e.exports=s},{}],91:[function(t,e,i){function s(t,e,i){for(var s=-1,r=i.length,o=-1,a=n(t.length-r,0),l=-1,c=e.length,u=Array(a+c);++o<a;)u[o]=t[o];for(var h=o;++l<c;)u[h+l]=e[l];for(;++s<r;)u[h+i[s]]=t[o++];return u}var n=Math.max;e.exports=s},{}],92:[function(t,e,i){function s(t,e){return function(i,s,a){var l=e?e():{};if(s=n(s,a,3),o(i))for(var c=-1,u=i.length;++c<u;){var h=i[c];t(l,h,s(h,c,i),i)}else r(i,function(e,i,n){
t(l,e,s(e,i,n),n)});return l}}var n=t("./baseCallback"),r=t("./baseEach"),o=t("../lang/isArray");e.exports=s},{"../lang/isArray":125,"./baseCallback":57,"./baseEach":64}],93:[function(t,e,i){function s(t){return function(){var e=arguments.length,i=arguments[0];if(2>e||null==i)return i;if(e>3&&r(arguments[1],arguments[2],arguments[3])&&(e=2),e>3&&"function"==typeof arguments[e-2])var s=n(arguments[--e-1],arguments[e--],5);else e>2&&"function"==typeof arguments[e-1]&&(s=arguments[--e]);for(var o=0;++o<e;){var a=arguments[o];a&&t(i,a,s)}return i}}var n=t("./bindCallback"),r=t("./isIterateeCall");e.exports=s},{"./bindCallback":85,"./isIterateeCall":110}],94:[function(t,e,i){function s(t,e){function i(){return(this instanceof i?s:t).apply(e,arguments)}var s=n(t);return i}var n=t("./createCtorWrapper");e.exports=s},{"./createCtorWrapper":96}],95:[function(t,e,i){(function(i){var s=t("./SetCache"),n=t("../utility/constant"),r=t("../lang/isNative"),o=r(o=i.Set)&&o,a=r(a=Object.create)&&a,l=a&&o?function(t){return new s(t)}:n(null);e.exports=l}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../lang/isNative":130,"../utility/constant":142,"./SetCache":51}],96:[function(t,e,i){function s(t){return function(){var e=n(t.prototype),i=t.apply(e,arguments);return r(i)?i:e}}var n=t("./baseCreate"),r=t("../lang/isObject");e.exports=s},{"../lang/isObject":132,"./baseCreate":61}],97:[function(t,e,i){function s(t,e,i,y,_,x,w,S,O,T){function I(){for(var p=arguments.length,f=p,d=Array(p);f--;)d[f]=arguments[f];if(y&&(d=r(d,y,_)),x&&(d=o(d,x,w)),A||R){var b=I.placeholder,j=c(d,b);if(p-=j.length,T>p){var L=S?n(S):null,M=v(T-p,0),U=A?j:null,B=A?null:j,F=A?d:null,q=A?null:d;e|=A?m:g,e&=~(A?g:m),k||(e&=~(u|h));var $=s(t,e,i,F,U,q,B,L,O,M);return $.placeholder=b,$}}var H=E?i:this;return C&&(t=H[D]),S&&(d=l(d,S)),N&&O<d.length&&(d.length=O),(this instanceof I?P||a(t):t).apply(H,d)}var N=e&b,E=e&u,C=e&h,A=e&f,k=e&p,R=e&d,P=!C&&a(t),D=t;return I}var n=t("./arrayCopy"),r=t("./composeArgs"),o=t("./composeArgsRight"),a=t("./createCtorWrapper"),l=t("./reorder"),c=t("./replaceHolders"),u=1,h=2,p=4,f=8,d=16,m=32,g=64,b=256,v=Math.max;e.exports=s},{"./arrayCopy":52,"./composeArgs":90,"./composeArgsRight":91,"./createCtorWrapper":96,"./reorder":116,"./replaceHolders":117}],98:[function(t,e,i){function s(t,e,i,s){function o(){for(var e=-1,n=arguments.length,r=-1,c=s.length,u=Array(n+c);++r<c;)u[r]=s[r];for(;n--;)u[r++]=arguments[++e];return(this instanceof o?l:t).apply(a?i:this,u)}var a=e&r,l=n(t);return o}var n=t("./createCtorWrapper"),r=1;e.exports=s},{"./createCtorWrapper":96}],99:[function(t,e,i){function s(t,e,i,s,b,v,y,_){var x=e&p;if(!x&&"function"!=typeof t)throw new TypeError(m);var w=s?s.length:0;if(w||(e&=~(f|d),s=b=null),w-=b?b.length:0,e&d){var S=s,O=b;s=b=null}var T=!x&&l(t),I=[t,e,i,s,b,S,O,v,y,_];if(T&&T!==!0&&(c(I,T),e=I[1],_=I[9]),I[9]=null==_?x?0:t.length:g(_-w,0)||0,e==h)var N=r(I[0],I[2]);else N=e!=f&&e!=(h|f)||I[4].length?o.apply(void 0,I):a.apply(void 0,I);var E=T?n:u;return E(N,I)}var n=t("./baseSetData"),r=t("./createBindWrapper"),o=t("./createHybridWrapper"),a=t("./createPartialWrapper"),l=t("./getData"),c=t("./mergeData"),u=t("./setData"),h=1,p=2,f=32,d=64,m="Expected a function",g=Math.max;e.exports=s},{"./baseSetData":79,"./createBindWrapper":94,"./createHybridWrapper":97,"./createPartialWrapper":98,"./getData":103,"./mergeData":114,"./setData":118}],100:[function(t,e,i){function s(t,e,i,s,n,r,o){var a=-1,l=t.length,c=e.length,u=!0;if(l!=c&&!(n&&c>l))return!1;for(;u&&++a<l;){var h=t[a],p=e[a];if(u=void 0,s&&(u=n?s(p,h,a):s(h,p,a)),"undefined"==typeof u)if(n)for(var f=c;f--&&(p=e[f],!(u=h&&h===p||i(h,p,s,n,r,o))););else u=h&&h===p||i(h,p,s,n,r,o)}return!!u}e.exports=s},{}],101:[function(t,e,i){function s(t,e,i){switch(i){case n:case r:return+t==+e;case o:return t.name==e.name&&t.message==e.message;case a:return t!=+t?e!=+e:0==t?1/t==1/e:t==+e;case l:case c:return t==e+""}return!1}var n="[object Boolean]",r="[object Date]",o="[object Error]",a="[object Number]",l="[object RegExp]",c="[object String]";e.exports=s},{}],102:[function(t,e,i){function s(t,e,i,s,r,a,l){var c=n(t),u=c.length,h=n(e),p=h.length;if(u!=p&&!r)return!1;for(var f,d=-1;++d<u;){var m=c[d],g=o.call(e,m);if(g){var b=t[m],v=e[m];g=void 0,s&&(g=r?s(v,b,m):s(b,v,m)),"undefined"==typeof g&&(g=b&&b===v||i(b,v,s,r,a,l))}if(!g)return!1;f||(f="constructor"==m)}if(!f){var y=t.constructor,_=e.constructor;if(y!=_&&"constructor"in t&&"constructor"in e&&!("function"==typeof y&&y instanceof y&&"function"==typeof _&&_ instanceof _))return!1}return!0}var n=t("../object/keys"),r=Object.prototype,o=r.hasOwnProperty;e.exports=s},{"../object/keys":137}],103:[function(t,e,i){var s=t("./metaMap"),n=t("../utility/noop"),r=s?function(t){return s.get(t)}:n;e.exports=r},{"../utility/noop":144,"./metaMap":115}],104:[function(t,e,i){function s(t,e,i){for(var s=t.length,n=i?e||s:(e||0)-1;i?n--:++n<s;){var r=t[n];if(r!==r)return n}return-1}e.exports=s},{}],105:[function(t,e,i){function s(t){var e=t.length,i=new t.constructor(e);return e&&"string"==typeof t[0]&&r.call(t,"index")&&(i.index=t.index,i.input=t.input),i}var n=Object.prototype,r=n.hasOwnProperty;e.exports=s},{}],106:[function(t,e,i){function s(t,e,i){var s=t.constructor;switch(e){case u:return n(t);case r:case o:return new s(+t);case h:case p:case f:case d:case m:case g:case b:case v:case y:var x=t.buffer;return new s(i?n(x):x,t.byteOffset,t.length);case a:case c:return new s(t);case l:var w=new s(t.source,_.exec(t));w.lastIndex=t.lastIndex}return w}var n=t("./bufferClone"),r="[object Boolean]",o="[object Date]",a="[object Number]",l="[object RegExp]",c="[object String]",u="[object ArrayBuffer]",h="[object Float32Array]",p="[object Float64Array]",f="[object Int8Array]",d="[object Int16Array]",m="[object Int32Array]",g="[object Uint8Array]",b="[object Uint8ClampedArray]",v="[object Uint16Array]",y="[object Uint32Array]",_=/\w*$/;e.exports=s},{"./bufferClone":86}],107:[function(t,e,i){function s(t){var e=t.constructor;return"function"==typeof e&&e instanceof e||(e=Object),new e}e.exports=s},{}],108:[function(t,e,i){function s(t){var e=!(o.funcNames?t.name:o.funcDecomp);if(!e){var i=c.call(t);o.funcNames||(e=!a.test(i)),e||(e=l.test(i)||r(t),n(t,e))}return e}var n=t("./baseSetData"),r=t("../lang/isNative"),o=t("../support"),a=/^\s*function[ \n\r\t]+\w/,l=/\bthis\b/,c=Function.prototype.toString;e.exports=s},{"../lang/isNative":130,"../support":141,"./baseSetData":79}],109:[function(t,e,i){function s(t,e){return t=+t,e=null==e?n:e,t>-1&&t%1==0&&e>t}var n=Math.pow(2,53)-1;e.exports=s},{}],110:[function(t,e,i){function s(t,e,i){if(!o(i))return!1;var s=typeof e;if("number"==s)var a=i.length,l=r(a)&&n(e,a);else l="string"==s&&e in i;if(l){var c=i[e];return t===t?t===c:c!==c}return!1}var n=t("./isIndex"),r=t("./isLength"),o=t("../lang/isObject");e.exports=s},{"../lang/isObject":132,"./isIndex":109,"./isLength":111}],111:[function(t,e,i){function s(t){return"number"==typeof t&&t>-1&&t%1==0&&n>=t}var n=Math.pow(2,53)-1;e.exports=s},{}],112:[function(t,e,i){function s(t){return t&&"object"==typeof t||!1}e.exports=s},{}],113:[function(t,e,i){function s(t){return t===t&&(0===t?1/t>0:!n(t))}var n=t("../lang/isObject");e.exports=s},{"../lang/isObject":132}],114:[function(t,e,i){function s(t,e){var i=t[1],s=e[1],g=i|s,b=f|p,v=l|c,y=b|v|u|h,_=i&f&&!(s&f),x=i&p&&!(s&p),w=(x?t:e)[7],S=(_?t:e)[8],O=!(i>=p&&s>v||i>v&&s>=p),T=g>=b&&y>=g&&(p>i||(x||_)&&w.length<=S);if(!O&&!T)return t;s&l&&(t[2]=e[2],g|=i&l?0:u);var I=e[3];if(I){var N=t[3];t[3]=N?r(N,I,e[4]):n(I),t[4]=N?a(t[3],d):n(e[4])}return I=e[5],I&&(N=t[5],t[5]=N?o(N,I,e[6]):n(I),t[6]=N?a(t[5],d):n(e[6])),I=e[7],I&&(t[7]=n(I)),s&f&&(t[8]=null==t[8]?e[8]:m(t[8],e[8])),null==t[9]&&(t[9]=e[9]),t[0]=e[0],t[1]=g,t}var n=t("./arrayCopy"),r=t("./composeArgs"),o=t("./composeArgsRight"),a=t("./replaceHolders"),l=1,c=2,u=4,h=16,p=128,f=256,d="__lodash_placeholder__",m=Math.min;e.exports=s},{"./arrayCopy":52,"./composeArgs":90,"./composeArgsRight":91,"./replaceHolders":117}],115:[function(t,e,i){(function(i){var s=t("../lang/isNative"),n=s(n=i.WeakMap)&&n,r=n&&new n;e.exports=r}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../lang/isNative":130}],116:[function(t,e,i){function s(t,e){for(var i=t.length,s=o(e.length,i),a=n(t);s--;){var l=e[s];t[s]=r(l,i)?a[l]:void 0}return t}var n=t("./arrayCopy"),r=t("./isIndex"),o=Math.min;e.exports=s},{"./arrayCopy":52,"./isIndex":109}],117:[function(t,e,i){function s(t,e){for(var i=-1,s=t.length,r=-1,o=[];++i<s;)t[i]===e&&(t[i]=n,o[++r]=i);return o}var n="__lodash_placeholder__";e.exports=s},{}],118:[function(t,e,i){var s=t("./baseSetData"),n=t("../date/now"),r=150,o=16,a=function(){var t=0,e=0;return function(i,a){var l=n(),c=o-(l-e);if(e=l,c>0){if(++t>=r)return i}else t=0;return s(i,a)}}();e.exports=a},{"../date/now":47,"./baseSetData":79}],119:[function(t,e,i){function s(t){for(var e=l(t),i=e.length,s=i&&t.length,u=s&&a(s)&&(r(t)||c.nonEnumArgs&&n(t)),p=-1,f=[];++p<i;){var d=e[p];(u&&o(d,s)||h.call(t,d))&&f.push(d)}return f}var n=t("../lang/isArguments"),r=t("../lang/isArray"),o=t("./isIndex"),a=t("./isLength"),l=t("../object/keysIn"),c=t("../support"),u=Object.prototype,h=u.hasOwnProperty;e.exports=s},{"../lang/isArguments":124,"../lang/isArray":125,"../object/keysIn":138,"../support":141,"./isIndex":109,"./isLength":111}],120:[function(t,e,i){function s(t,e){for(var i,s=-1,n=t.length,r=-1,o=[];++s<n;){var a=t[s],l=e?e(a,s,t):a;s&&i===l||(i=l,o[++r]=a)}return o}e.exports=s},{}],121:[function(t,e,i){function s(t){return n(t)?t:Object(t)}var n=t("../lang/isObject");e.exports=s},{"../lang/isObject":132}],122:[function(t,e,i){function s(t,e,i,s){return e&&"boolean"!=typeof e&&o(t,e,i)?e=!1:"function"==typeof e&&(s=i,i=e,e=!1),i="function"==typeof i&&r(i,s,1),n(t,e,i)}var n=t("../internal/baseClone"),r=t("../internal/bindCallback"),o=t("../internal/isIterateeCall");e.exports=s},{"../internal/baseClone":58,"../internal/bindCallback":85,"../internal/isIterateeCall":110}],123:[function(t,e,i){function s(t,e,i){return e="function"==typeof e&&r(e,i,1),n(t,!0,e)}var n=t("../internal/baseClone"),r=t("../internal/bindCallback");e.exports=s},{"../internal/baseClone":58,"../internal/bindCallback":85}],124:[function(t,e,i){function s(t){var e=r(t)?t.length:void 0;return n(e)&&l.call(t)==o||!1}var n=t("../internal/isLength"),r=t("../internal/isObjectLike"),o="[object Arguments]",a=Object.prototype,l=a.toString;e.exports=s},{"../internal/isLength":111,"../internal/isObjectLike":112}],125:[function(t,e,i){var s=t("../internal/isLength"),n=t("./isNative"),r=t("../internal/isObjectLike"),o="[object Array]",a=Object.prototype,l=a.toString,c=n(c=Array.isArray)&&c,u=c||function(t){return r(t)&&s(t.length)&&l.call(t)==o||!1};e.exports=u},{"../internal/isLength":111,"../internal/isObjectLike":112,"./isNative":130}],126:[function(t,e,i){function s(t){return t===!0||t===!1||n(t)&&a.call(t)==r||!1}var n=t("../internal/isObjectLike"),r="[object Boolean]",o=Object.prototype,a=o.toString;e.exports=s},{"../internal/isObjectLike":112}],127:[function(t,e,i){function s(t){if(null==t)return!0;var e=t.length;return a(e)&&(r(t)||c(t)||n(t)||l(t)&&o(t.splice))?!e:!u(t).length}var n=t("./isArguments"),r=t("./isArray"),o=t("./isFunction"),a=t("../internal/isLength"),l=t("../internal/isObjectLike"),c=t("./isString"),u=t("../object/keys");e.exports=s},{"../internal/isLength":111,"../internal/isObjectLike":112,"../object/keys":137,"./isArguments":124,"./isArray":125,"./isFunction":129,"./isString":133}],128:[function(t,e,i){function s(t,e,i,s){if(i="function"==typeof i&&r(i,s,3),!i&&o(t)&&o(e))return t===e;var a=i?i(t,e):void 0;return"undefined"==typeof a?n(t,e,i):!!a}var n=t("../internal/baseIsEqual"),r=t("../internal/bindCallback"),o=t("../internal/isStrictComparable");e.exports=s},{"../internal/baseIsEqual":71,"../internal/bindCallback":85,"../internal/isStrictComparable":113}],129:[function(t,e,i){(function(i){var s=t("../internal/baseIsFunction"),n=t("./isNative"),r="[object Function]",o=Object.prototype,a=o.toString,l=n(l=i.Uint8Array)&&l,c=s(/x/)||l&&!s(l)?function(t){return a.call(t)==r}:s;e.exports=c}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../internal/baseIsFunction":73,"./isNative":130}],130:[function(t,e,i){function s(t){return null==t?!1:u.call(t)==o?h.test(c.call(t)):r(t)&&a.test(t)||!1}var n=t("../string/escapeRegExp"),r=t("../internal/isObjectLike"),o="[object Function]",a=/^\[object .+?Constructor\]$/,l=Object.prototype,c=Function.prototype.toString,u=l.toString,h=RegExp("^"+n(u).replace(/toString|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");e.exports=s},{"../internal/isObjectLike":112,"../string/escapeRegExp":140}],131:[function(t,e,i){function s(t){return"number"==typeof t||n(t)&&a.call(t)==r||!1}var n=t("../internal/isObjectLike"),r="[object Number]",o=Object.prototype,a=o.toString;e.exports=s},{"../internal/isObjectLike":112}],132:[function(t,e,i){function s(t){var e=typeof t;return"function"==e||t&&"object"==e||!1}e.exports=s},{}],133:[function(t,e,i){function s(t){return"string"==typeof t||n(t)&&a.call(t)==r||!1}var n=t("../internal/isObjectLike"),r="[object String]",o=Object.prototype,a=o.toString;e.exports=s},{"../internal/isObjectLike":112}],134:[function(t,e,i){function s(t){return r(t)&&n(t.length)&&C[k.call(t)]||!1}var n=t("../internal/isLength"),r=t("../internal/isObjectLike"),o="[object Arguments]",a="[object Array]",l="[object Boolean]",c="[object Date]",u="[object Error]",h="[object Function]",p="[object Map]",f="[object Number]",d="[object Object]",m="[object RegExp]",g="[object Set]",b="[object String]",v="[object WeakMap]",y="[object ArrayBuffer]",_="[object Float32Array]",x="[object Float64Array]",w="[object Int8Array]",S="[object Int16Array]",O="[object Int32Array]",T="[object Uint8Array]",I="[object Uint8ClampedArray]",N="[object Uint16Array]",E="[object Uint32Array]",C={};C[_]=C[x]=C[w]=C[S]=C[O]=C[T]=C[I]=C[N]=C[E]=!0,C[o]=C[a]=C[y]=C[l]=C[c]=C[u]=C[h]=C[p]=C[f]=C[d]=C[m]=C[g]=C[b]=C[v]=!1;var A=Object.prototype,k=A.toString;e.exports=s},{"../internal/isLength":111,"../internal/isObjectLike":112}],135:[function(t,e,i){var s=t("../internal/baseAssign"),n=t("../internal/createAssigner"),r=n(s);e.exports=r},{"../internal/baseAssign":56,"../internal/createAssigner":93}],136:[function(t,e,i){e.exports=t("./assign")},{"./assign":135}],137:[function(t,e,i){var s=t("../internal/isLength"),n=t("../lang/isNative"),r=t("../lang/isObject"),o=t("../internal/shimKeys"),a=n(a=Object.keys)&&a,l=a?function(t){if(t)var e=t.constructor,i=t.length;return"function"==typeof e&&e.prototype===t||"function"!=typeof t&&i&&s(i)?o(t):r(t)?a(t):[]}:o;e.exports=l},{"../internal/isLength":111,"../internal/shimKeys":119,"../lang/isNative":130,"../lang/isObject":132}],138:[function(t,e,i){function s(t){if(null==t)return[];l(t)||(t=Object(t));var e=t.length;e=e&&a(e)&&(r(t)||c.nonEnumArgs&&n(t))&&e||0;for(var i=t.constructor,s=-1,u="function"==typeof i&&i.prototype===t,p=Array(e),f=e>0;++s<e;)p[s]=s+"";for(var d in t)f&&o(d,e)||"constructor"==d&&(u||!h.call(t,d))||p.push(d);return p}var n=t("../lang/isArguments"),r=t("../lang/isArray"),o=t("../internal/isIndex"),a=t("../internal/isLength"),l=t("../lang/isObject"),c=t("../support"),u=Object.prototype,h=u.hasOwnProperty;e.exports=s},{"../internal/isIndex":109,"../internal/isLength":111,"../lang/isArguments":124,"../lang/isArray":125,"../lang/isObject":132,"../support":141}],139:[function(t,e,i){function s(t){return n(t,r(t))}var n=t("../internal/baseValues"),r=t("./keys");e.exports=s},{"../internal/baseValues":84,"./keys":137}],140:[function(t,e,i){function s(t){return t=n(t),t&&o.test(t)?t.replace(r,"\\$&"):t}var n=t("../internal/baseToString"),r=/[.*+?^${}()|[\]\/\\]/g,o=RegExp(r.source);e.exports=s},{"../internal/baseToString":82}],141:[function(t,e,i){(function(i){var s=t("./lang/isNative"),n=/\bthis\b/,r=Object.prototype,o=(o=i.window)&&o.document,a=r.propertyIsEnumerable,l={};!function(t){l.funcDecomp=!s(i.WinRTError)&&n.test(function(){return this}),l.funcNames="string"==typeof Function.name;try{l.dom=11===o.createDocumentFragment().nodeType}catch(e){l.dom=!1}try{l.nonEnumArgs=!a.call(arguments,1)}catch(e){l.nonEnumArgs=!0}}(0,0),e.exports=l}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./lang/isNative":130}],142:[function(t,e,i){function s(t){return function(){return t}}e.exports=s},{}],143:[function(t,e,i){function s(t){return t}e.exports=s},{}],144:[function(t,e,i){function s(){}e.exports=s},{}],145:[function(t,e,i){e.exports=t("./lib/polyglot")},{"./lib/polyglot":146}],146:[function(t,e,i){!function(t,s){"function"==typeof define&&define.amd?define([],function(){return s(t)}):"object"==typeof i?e.exports=s(t):t.Polyglot=s(t)}(this,function(t){"use strict";function e(t){t=t||{},this.phrases={},this.extend(t.phrases||{}),this.currentLocale=t.locale||"en",this.allowMissing=!!t.allowMissing,this.warn=t.warn||l}function i(t){var e,i,s,n={};for(e in t)if(t.hasOwnProperty(e)){i=t[e];for(s in i)n[i[s]]=e}return n}function s(t){var e=/^\s+|\s+$/g;return t.replace(e,"")}function n(t,e,i){var n,r,a;return null!=i&&t?(r=t.split(u),a=r[o(e,i)]||r[0],n=s(a)):n=t,n}function r(t){var e=i(p);return e[t]||e.en}function o(t,e){return h[r(t)](e)}function a(t,e){for(var i in e)"_"!==i&&e.hasOwnProperty(i)&&(t=t.replace(new RegExp("%\\{"+i+"\\}","g"),e[i]));return t}function l(e){t.console&&t.console.warn&&t.console.warn("WARNING: "+e)}function c(t){var e={};for(var i in t)e[i]=t[i];return e}e.VERSION="0.4.3",e.prototype.locale=function(t){return t&&(this.currentLocale=t),this.currentLocale},e.prototype.extend=function(t,e){var i;for(var s in t)t.hasOwnProperty(s)&&(i=t[s],e&&(s=e+"."+s),"object"==typeof i?this.extend(i,s):this.phrases[s]=i)},e.prototype.clear=function(){this.phrases={}},e.prototype.replace=function(t){this.clear(),this.extend(t)},e.prototype.t=function(t,e){var i,s;return e=null==e?{}:e,"number"==typeof e&&(e={smart_count:e}),"string"==typeof this.phrases[t]?i=this.phrases[t]:"string"==typeof e._?i=e._:this.allowMissing?i=t:(this.warn('Missing translation for key: "'+t+'"'),s=t),"string"==typeof i&&(e=c(e),s=n(i,this.currentLocale,e.smart_count),s=a(s,e)),s},e.prototype.has=function(t){return t in this.phrases};var u="||||",h={chinese:function(t){return 0},german:function(t){return 1!==t?1:0},french:function(t){return t>1?1:0},russian:function(t){return t%10===1&&t%100!==11?0:t%10>=2&&4>=t%10&&(10>t%100||t%100>=20)?1:2},czech:function(t){return 1===t?0:t>=2&&4>=t?1:2},polish:function(t){return 1===t?0:t%10>=2&&4>=t%10&&(10>t%100||t%100>=20)?1:2},icelandic:function(t){return t%10!==1||t%100===11?1:0}},p={chinese:["fa","id","ja","ko","lo","ms","th","tr","zh"],german:["da","de","en","es","fi","el","he","hu","it","nl","no","pt","sv"],french:["fr","tl","pt-br"],russian:["hr","ru"],czech:["cs"],polish:["pl"],icelandic:["is"]};return e})},{}],147:[function(t,e,i){var s=React.createElement,n=React.createClass({name:"annotation-component",displayName:"AnnotationComponent",getClassName:function(){var t=this.props.node.getClassNames();return this.props.classNames&&(t+=" "+this.props.classNames.join(" ")),t.replace(/_/g,"-")},render:function(){return s("span",{className:this.getClassName(),"data-id":this.props.node.id},this.props.children)}});e.exports=n},{}],148:[function(t,e,i){var s=React.createElement,n=t("substance"),r=t("substance/helpers"),o=t("./scrollbar"),a=t("./panel_mixin"),l=r.extend({},a,{contextTypes:{app:React.PropTypes.object.isRequired,componentRegistry:React.PropTypes.object.isRequired},getDefautlProps:function(){return{containerId:"content"}},componentDidMount:function(){var t=this.context.app;this.updateScrollbar(),$(window).on("resize",this.updateScrollbar);var e=t.doc;e.connect(this,{"document:changed":this.onDocumentChange,"app:toc-entry-selected":this.onTOCEntrySelected})},componentWillUnmount:function(){var t=this.context.app,e=t.doc;e.disconnect(this),$(window).off("resize")},onDocumentChange:function(){setTimeout(function(){this.updateScrollbar()}.bind(this),0)},onTOCEntrySelected:function(t){this.scrollToNode(t)},componentDidUpdate:function(){this.updateScrollbar()},updateScrollbar:function(){var t=this.refs.scrollbar,e=React.findDOMNode(this.refs.panelContent);n.delay(function(){t.update(e,this)}.bind(this),0),$(e).off("scroll"),$(e).on("scroll",this._onScroll)},_onScroll:function(t){var e=React.findDOMNode(this.refs.panelContent);this.refs.scrollbar.update(e,this),this.markActiveTOCEntry()},markActiveTOCEntry:function(){var t=React.findDOMNode(this.refs.panelContent),e=this.getContentHeight(),i=this.getPanelHeight(),s=this.getScrollPosition(),n=s+i,o=s,a=2*n-e,l=Math.max(o,a),c=$(t).find(".content-node.heading");if(0!==c.length){var u=r.first(c).dataset.id;c.each(function(){l>=$(this).position().top&&(u=this.dataset.id)});var h=this.getDocument();h.emit("app:toc-entry:changed",u)}},getContentEditor:function(){var t,e=this.context.app,i=e.doc,n=this.context.componentRegistry;return t=n.contains("content_container")?n.get("content_container"):n.get("content_editor"),s(t,{doc:i,node:i.get(this.props.containerId),ref:"contentEditor"})},render:function(){var t=this.context.app;return s("div",{className:"panel content-panel-component"},s(o,{id:"content-scrollbar",contextId:t.state.contextId,highlights:t.getHighlightedNodes,ref:"scrollbar"}),s("div",{className:"panel-content",ref:"panelContent"},this.getContentEditor()))}}),c=React.createClass({mixins:[l],displayName:"ContentPanel"});e.exports=c},{"./panel_mixin":155,"./scrollbar":156,substance:171,"substance/helpers":170}],149:[function(t,e,i){var s=React.createElement,n=React.createClass({contextTypes:{app:React.PropTypes.object.isRequired},displayName:"ContentTools",render:function(){var t=this.context.app,e=t.getTools(),i={doc:this.props.doc,switchContext:this.props.switchContext},n=e.map(function(t,e){return i.key=e,s(t,i)});return s("div",{className:"content-tools-component"},s("div",{className:"tools"},n))}});e.exports=n},{}],150:[function(t,e,i){var s=t("substance"),n=t("substance/helpers"),r=t("./text_property").Highlight,o=t("./extension_manager"),a=t("./modal"),l=s.Document,c=l.Selection,u=s.Surface,h=u.Clipboard,p=u.SurfaceManager,f=React.createElement,d={getDefaultProps:function(){return{contentContainer:"content"}},_initializeController:function(){this.__events__={};var t=this.getDocument();this.doc=t;var e=this.getConfig();this.surfaces={},t.connect(this,{"transaction:started":this._transactionStarted,"document:changed":this._onDocumentChanged}),this._onSelectionChangedDebounced=n.debounce(this._onSelectionChanged,100);var i={name:"_basics",components:e.components||{},stateHandlers:e.stateHandlers||{},tools:e.tools||[]},r=[i];e.extensions&&(r=r.concat(e.extensions)),this.extensionManager=new o(r,this);var a=new s.Registry;n.each(r,function(t){n.each(t.components,function(t,e){a.add(e,t)})}),this.componentRegistry=a;var l=new s.Surface.ToolRegistry;n.each(r,function(t){n.each(t.tools,function(t,e){var i=n.extend({},this.context,this.getChildContext());l.add(e,new t(i))},this)},this),this.toolRegistry=l,this.surfaceManager=new p(t),this.clipboard=new h(this.surfaceManager,this.doc.getClipboardImporter(),this.doc.getClipboardExporter())},_transactionStarted:function(t){t.before.state=this.state,t.before.selection=this.getSelection(),this.activeSurface&&(t.before.surfaceName=this.activeSurface.name)},_onDocumentChanged:function(t,e){this.doc.__dirty=!0;var i=this.context.notifications;i.addMessage({type:"info",message:"Unsaved changes"}),e.replay&&this.replaceState(t.after.state)},_onSelectionChanged:function(t,e){this.updateSurface(e),this.extensionManager.handleSelectionChange(t),this.toolRegistry.each(function(i){i.update(e,t)},this),this.emit("selection:changed",t)},requestSave:function(){var t=this.props.doc,e=this.context.backend,i=this.context.notifications;t.__dirty&&!t.__isSaving&&(i.addMessage({type:"info",message:"Saving ..."}),t.__isSaving=!0,e.saveDocument(t,function(e){t.__isSaving=!1,e?i.addMessage({type:"error",message:e.message||e.toString()}):(t.emit("document:saved"),i.addMessage({type:"info",message:"No changes"}),t.__dirty=!1)}))},registerSurface:function(t,e){e=e||{};var i=t.getName();this.surfaces[i]=t,t.enabledTools=e.enabledTools||[],t.connect(this,{"selection:changed":this._onSelectionChangedDebounced})},unregisterSurface:function(t){s.each(this.surfaces,function(e,i){t===e&&delete this.surfaces[i]},this),t.disconnect(this)},updateSurface:function(t){this.activeSurface=t},getSurface:function(){return this.activeSurface},getSelection:function(){return this.activeSurface?this.activeSurface.getSelection():l.nullSelection},isToolEnabled:function(t){var e=this.getSurface(),i=e.enabledTools;return n.includes(i,t)},executeAction:function(t){return this.extensionManager.handleAction(t)},closeModal:function(){var t=n.cloneDeep(this.state);delete t.modal,this.replaceState(t)},getActivePanelElement:function(){var t=this.componentRegistry.get(this.state.contextId);return t?f(t,{doc:this.doc,app:this}):void console.warn("Could not find component for contextId:",this.state.contextId)},getActiveModalPanelElement:function(){var t=this.state;if(t.modal){var e=this.componentRegistry.get(t.modal.contextId);if(e)return f(e,{doc:this.doc,app:this});console.warn("Could not find component for contextId:",t.modal.contextId)}},getActiveContainerAnnotations:function(){return this.extensionManager.getActiveContainerAnnotations()},getHighlightedNodes:function(){return this.extensionManager.getHighlightedNodes()},getHighlightsForTextProperty:function(t){var e=this.doc,i=t.getContainer(),o=new s.PathAdapter.Arrays;if(i){var a=this.getActiveContainerAnnotations();return n.each(a,function(t){var s=e.get(t);if(s){var a=i.getAnnotationFragments(s);n.each(a,function(t){o.add(t.path,new r(t.path,t.startOffset,t.endOffset,{id:s.id,classNames:s.getClassNames().replace(/_/g,"-")+" annotation-fragment"}))})}}),o.get(t.props.path)||[]}return[]},deleteAnnotation:function(t){var e=this.doc.get(t),i=this.doc.startTransaction({selection:this.getSelection()});i["delete"](t),i.save({selection:c.create(e.path,e.startOffset,e.endOffset)})},annotate:function(t){var e=this.getSelection(),i=t.path,n=t.startOffset,r=t.endOffset;if(!i){if(e.isNull())throw new Error("Selection is null");if(!e.isPropertySelection())throw new Error("Selection is not a PropertySelection");i=e.getPath(),n=e.getStartOffset(),r=e.getEndOffset()}var o=s.extend({},t);o.id=t.id||t.type+"_"+s.uuid(),o.path=i,o.startOffset=n,o.endOffset=r;var a=this.doc.startTransaction({selection:this.getSelection()});return o=a.create(o),a.save({selection:e}),o},undo:function(){this.doc.done.length>0&&this.doc.undo()},redo:function(){this.doc.undone.length>0&&this.doc.redo()},contextTypes:{backend:React.PropTypes.object.isRequired,notifications:React.PropTypes.object.isRequired},childContextTypes:{doc:React.PropTypes.object,app:React.PropTypes.object,getHighlightedNodes:React.PropTypes.func,getHighlightsForTextProperty:React.PropTypes.func,componentRegistry:React.PropTypes.object,toolRegistry:React.PropTypes.object,surfaceManager:React.PropTypes.object},getChildContext:function(){var t={app:this,doc:this.doc,getHighlightedNodes:this.getHighlightedNodes,getHighlightsForTextProperty:this.getHighlightsForTextProperty,componentRegistry:this.componentRegistry,toolRegistry:this.toolRegistry,surfaceManager:this.surfaceManager};return t},getInitialState:function(){return{contextId:"toc"}},getDocument:function(){return this.props.doc},getConfig:function(){return this.props.config},componentWillMount:function(){this._initializeController()},componentWillUnmount:function(){this.toolRegistry.dispose(),this.clipboard.detach(React.findDOMNode(this)),this.surfaceManager.dispose()},shouldComponentUpdate:function(t,e){var i=JSON.stringify(this.state),n=JSON.stringify(e);return s.isEqual(i,n)?!1:!0},componentDidMount:function(){var t=React.findDOMNode(this);this.clipboard.attach(t)},handleAction:function(t){this.extensionManager.handleAction(t)},handleContextSwitch:function(t){this.replaceState({contextId:t})},handleCloseDialog:function(t){t.preventDefault(),console.log("handling close"),this.replaceState(this.getInitialState())},handleContextToggle:function(t){t.preventDefault();var e=$(t.currentTarget).attr("data-id");this.handleContextSwitch(e)},createContextToggles:function(){return f("div",{className:"context-toggles"})},createModalPanel:function(){var t=this.getActiveModalPanelElement();return t?f(a,{panelElement:t}):f("div")},createContextPanel:function(){var t=this.getActivePanelElement();return t?t:f("div",null,"No panels are registered")}};e.exports=d},{"./extension_manager":152,"./modal":154,"./text_property":158,substance:171,"substance/helpers":170}],151:[function(t,e,i){var s=(t("substance/helpers"),React.createElement),n=React.createClass({handleClick:function(t){t.preventDefault()},handleDropdownToggle:function(t){t.preventDefault();var e=this.state.open,i=this;e||(this.setState({open:!this.state.open}),setTimeout(function(){$(window).one("mousedown",function(t){i.close()})},0))},close:function(){this.setState({open:!1})},getInitialState:function(){return{open:!1}},render:function(){var t=["dropdown"];return this.props.classNames&&(t=t.concat(this.props.classNames)),this.state.open&&t.push("open"),s("div",{className:t.join(" ")},s("button",{title:this.props.title,className:"toggle",onMouseDown:this.handleDropdownToggle,onClick:this.handleClick},this.props.label),s("div",{className:"options shadow border fill-white"},this.props.children))}});e.exports=n},{"substance/helpers":170}],152:[function(t,e,i){"use strict";var s=t("substance"),n=(t("substance/helpers"),function(t,e){this.extensions=t,this.writer=e});n.Prototype=function(){this.getExtensions=function(){return this.extensions},this.getTools=function(){for(var t=this.extensions,e=[],i=0;i<t.length;i++){var s=t[i];s.tools&&(e=e.concat(s.tools))}return e},this.handle=function(t){for(var e=null,i=this.extensions,s=0;s<i.length&&!e;s++){var n=i[s].stateHandlers;n&&n[t]&&(e=n[t](this.writer,arguments[1],arguments[2]))}return e},this.handleSelectionChange=function(t){return this.handle("handleSelectionChange",t)},this.handleAction=function(t){return this.handle("handleAction",t)},this.handleAnnotationToggle=function(t){return this.handle("handleAnnotationToggle",t)},this.getHighlightedNodes=function(){var t=this.handle("getHighlightedNodes");return t||[]},this.getActiveContainerAnnotations=function(){var t=this.handle("getActiveContainerAnnotations");return t||[]}},s.initClass(n),e.exports=n},{substance:171,"substance/helpers":170}],153:[function(t,e,i){var s=React.createElement,n=React.createClass({displayName:"FontAwesomeIcon",render:function(){return s("i",{className:"fa "+this.props.icon})}});e.exports=n},{}],154:[function(t,e,i){var s=(t("substance/helpers"),React.createElement),n=React.createClass({contextTypes:{app:React.PropTypes.object.isRequired},displayName:"ManageBibItemsPanel",componentDidMount:function(){var t=React.findDOMNode(this);$(t).on("click",".close-modal",this.handleCloseModal)},componentWillUnmount:function(){var t=React.findDOMNode(this);$(t).off("click",".close-modal",this.handleCloseModal)},handleCloseModal:function(t){this.context.app.closeModal(),t.preventDefault()},preventBubbling:function(t){t.stopPropagation(),t.preventDefault()},render:function(){return s("div",{className:"modal "+this.props.panelElement.type.modalSize,onClick:this.handleCloseModal},s("div",{className:"body",onClick:this.preventBubbling},this.props.panelElement))}});e.exports=n},{"substance/helpers":170}],155:[function(t,e,i){var s=(React.createElement,t("substance")),n=s.Surface.Panel,r=s.extend({},n.prototype,{
getDocument:function(){var t=this.context.app;return t.doc},getPanelContentElement:function(){return React.findDOMNode(this.refs.panelContent)},getScrollableContainer:function(){return React.findDOMNode(this.refs.panelContent)},getContentHeight:function(){var t=0,e=this.getPanelContentElement();return $(e).children().each(function(){t+=$(this).outerHeight()}),t},getPanelHeight:function(){var t=this.getPanelContentElement();return $(t).height()},getScrollPosition:function(){var t=this.getPanelContentElement();return $(t).scrollTop()}});e.exports=r},{substance:171}],156:[function(t,e,i){"use strict";var s=React.createElement,n=(t("substance/helpers"),7),r=React.createClass({displayName:"Scrollbar",getInitialState:function(){return{thumb:{top:0,height:20},highlights:[]}},componentDidMount:function(){$(window).mousemove(this.mouseMove),$(window).mouseup(this.mouseUp)},mouseDown:function(t){this._mouseDown=!0;var e=$(React.findDOMNode(this)).offset().top,i=t.pageY-e,s=this.refs.thumb.getDOMNode();return t.target!==s?(this.offset=$(s).height()/2,this.mouseMove(t)):this.offset=i-$(s).position().top,!1},mouseUp:function(){this._mouseDown=!1},mouseMove:function(t){if(this._mouseDown){var e=$(React.findDOMNode(this)).offset().top,i=t.pageY-e,s=(i-this.offset)*this.factor;this.scrollTop=$(this.panelContentEl).scrollTop(s)}},update:function(t,e){var i=this;this.panelContentEl=t;var s=e.getContentHeight(),n=e.getPanelHeight(),o=e.getScrollPosition();this.factor=s/n;var a=[];this.props.highlights().forEach(function(t){var e=$(i.panelContentEl).find("*[data-id="+t+"]");if(e.length){var s=e.position().top/i.factor,n=e.outerHeight(!0)/i.factor;n<r.overlayMinHeight&&(n=r.overlayMinHeight,s-=.5*r.overlayMinHeight);var o={id:t,top:s,height:n};a.push(o)}});var l={top:o/this.factor,height:n/this.factor};this.setState({thumb:l,highlights:a})},render:function(){var t=this.state.highlights.map(function(t){return s("div",{className:"highlight",key:t.id,style:{top:t.top,height:t.height}})}),e=s("div",{ref:"thumb",className:"thumb",style:{top:this.state.thumb.top,height:Math.max(this.state.thumb.height,n)}});return s("div",{className:"scrollbar-component "+this.props.contextId,onMouseDown:this.mouseDown},e,s("div",{className:"highlights"},t))}});r.overlayMinHeight=5,e.exports=r},{"substance/helpers":170}],157:[function(t,e,i){var s=React.createElement,n=React.createClass({displayName:"TableToolComponent",contextTypes:{toolRegistry:React.PropTypes.object.isRequired},componentWillMount:function(){var t=this.props.tool;if(!t)throw new Error('Prop "tool" is mandatory.');this.tool=this.context.toolRegistry.get(t),this.tool||console.error("No tool registered with name %s",t),this.tool.connect(this,{"toolstate:changed":this.onToolstateChanged})},getInitialState:function(){return{disabled:!0}},render:function(){var t=[];this.props.classNames&&(t=this.props.classNames.slice()),this.state.disabled&&t.push("disabled");var e,i,n,r;switch(this.props.tool){case"insert_columns":this.state.disabled?"before"===this.props.mode?e=i18n.t("insert_column_before"):"after"===this.props.mode&&(e=i18n.t("insert_column_after")):(i=this.tool.getToolState().sel,n=i.endCol-i.startCol+1,"before"===this.props.mode?e=i18n.t("insert_k_columns_before",{smart_count:n}):"after"===this.props.mode&&(e=i18n.t("insert_k_columns_after",{smart_count:n})));break;case"delete_columns":this.state.disabled?e=i18n.t("delete_column"):(i=this.tool.getToolState().sel,n=i.endCol-i.startCol+1,e=i18n.t("delete_k_columns",{smart_count:n}));break;case"insert_rows":this.state.disabled?"above"===this.props.mode?e=i18n.t("insert_row_above"):"below"===this.props.mode&&(e=i18n.t("insert_row_below")):(i=this.tool.getToolState().sel,r=i.endRow-i.startRow+1,"above"===this.props.mode?e=i18n.t("insert_k_rows_above",{smart_count:r}):"below"===this.props.mode&&(e=i18n.t("insert_k_rows_below",{smart_count:r})));break;case"delete_rows":this.state.disabled?e=i18n.t("delete_row"):(i=this.tool.getToolState().sel,r=i.endRow-i.startRow+1,e=i18n.t("delete_k_rows",{smart_count:r}))}return s("button",{className:t.join(" "),title:this.props.title,onMouseDown:this.handleMouseDown,onClick:this.handleClick},e)},onToolstateChanged:function(t){this.setState({disabled:t.disabled})},handleClick:function(t){t.preventDefault()},handleMouseDown:function(t){t.preventDefault(),this.state.disabled||this.tool.performAction(this.props)}});e.exports=n},{}],158:[function(t,e,i){var s=t("substance"),n=t("substance/helpers"),r=React.createElement,o=s.Surface.TextProperty,a=s.Document.Annotator,l=t("./annotation_component"),c=React.createClass(s.extend({},o.prototype,{displayName:"TextProperty",contextTypes:{surface:React.PropTypes.object.isRequired,componentRegistry:React.PropTypes.object.isRequired,getHighlightedNodes:React.PropTypes.func.isRequired,getHighlightsForTextProperty:React.PropTypes.func.isRequired},getInitialState:function(){return{highlights:[]}},shouldComponentUpdate:function(){var t=n.pluck(this.getAnnotations(),"id"),e=n.intersection(t,this.getHighlights()),i=!0;return this._prevTextAnnotations&&n.isEqual(t,this._prevTextAnnotations)&&n.isEqual(e,this._prevTextHighlights)&&(i=!1),this._prevTextAnnotations=t,this._prevTextHighlights=e,i},componentDidMount:function(){var t=this.props.doc;t.getEventProxy("path").add(this.props.path,this,this.textPropertyDidChange)},componentWillUnmount:function(){var t=this.props.doc;t.getEventProxy("path").remove(this.props.path,this)},render:function(){return r(this.props.tagName||"span",{className:"text-property "+(this.props.className||""),spellCheck:!1,style:{whiteSpace:"pre-wrap"},"data-path":this.props.path.join(".")},this.renderChildren())},renderChildren:function(){var t=this.context.componentRegistry,e=this.getDocument(),i=this.getPath(),s=e.get(i)||"",n=this.getAnnotations(),o=[];this.context.getHighlightedNodes&&this.context.getHighlightedNodes();var c=new a,u={};c.onText=function(t,e){t.children.push(e)},c.onEnter=function(i){var s=i.node,n=s.id;u[n]||(u[n]=0),u[n]=u[n]+1;var r,a=n+"_"+u[n],c=o.indexOf(s.id)>=0;r=t.contains(s.type)?t.get(s.type):l;var h=[];return c&&h.push("active"),{ViewClass:r,props:{key:a,doc:e,node:s,classNames:h},children:[]}},c.onExit=function(t,e,i){var s=[e.ViewClass,e.props].concat(e.children),n=r.apply(React,s);i.children.push(n)};var h={children:[]};return c.start(h,s,n),h.children.push(r("br",{key:"br"})),h.children},getAnnotations:function(){var t=this.props.doc,e=this.context.surface,i=this.props.path,s=t.getIndex("annotations").get(i),n=e.getContainerName();if(n){var r=t.getIndex("container-annotations").get(i,n);s=s.concat(r)}var o=this.context.getHighlightsForTextProperty(this);return s=s.concat(o)},getHighlights:function(){return this.context.getHighlightedNodes()},textPropertyDidChange:function(){this.forceUpdate()},getContainer:function(){return this.getSurface().getContainer()},getDocument:function(){return this.props.doc},getPath:function(){return this.props.path},getElement:function(){return React.findDOMNode(this)},getSurface:function(){return this.context.surface}}));c.Highlight=function(t,e,i,s){s=s||{},this.id=s.id,this.path=t,this.startOffset=e,this.endOffset=i,this.classNames=s.classNames},s.initClass(c.Highlight),c.Highlight.prototype.getClassNames=function(){return this.classNames},c.Highlight["static"].level=Number.MAX_VALUE,e.exports=c},{"./annotation_component":147,substance:171,"substance/helpers":170}],159:[function(t,e,i){var s=React.createElement,n=t("substance/helpers"),r=React.createClass({displayName:"TextToolComponent",contextTypes:{toolRegistry:React.PropTypes.object.isRequired},componentWillMount:function(){var t=this.props.tool;if(!t)throw new Error('Prop "tool" is mandatory.');this.tool=this.context.toolRegistry.get(t),this.tool||console.error("No tool registered with name %s",t),this.tool.connect(this,{"toolstate:changed":this.onToolstateChanged})},onToolstateChanged:function(t,e,i){this.replaceState(t)},handleClick:function(t){t.preventDefault()},handleSwitchTextType:function(t){t.preventDefault(),this.tool.switchTextType(t.currentTarget.dataset.type)},getInitialState:function(){return{disabled:!0,open:!1}},toggleAvailableTextTypes:function(t){t.preventDefault(),this.tool.isDisabled()||this.setState({open:!this.state.open})},render:function(){var t=["text-tool-component","select"],e=this.tool.getAvailableTextTypes();this.state.open&&t.push("open"),this.state.disabled&&t.push("disabled");var i,r=e[this.state.currentTextType];i=r?i18n.t(e[this.state.currentTextType].label):this.state.currentContext?i18n.t(this.state.currentContext):i18n.t("no_selection");var o=s("button",{href:"#",className:"toggle",onMouseDown:this.toggleAvailableTextTypes,onClick:this.handleClick},i),a=[];return a=n.map(e,function(t,e){return s("button",{key:e,className:"option "+e,"data-type":e,onMouseDown:this.handleSwitchTextType,onClick:this.handleClick},t.label)}.bind(this)),s("div",{className:t.join(" ")},o,s("div",{className:"options shadow border fill-white"},a))}});e.exports=r},{"substance/helpers":170}],160:[function(t,e,i){var s=React.createElement,n=t("substance/helpers"),r=t("substance-ui/panel_mixin"),o=n.extend({},r,{contextTypes:{app:React.PropTypes.object.isRequired},componentDidMount:function(){var t=this.getDocument();t.connect(this,{"app:toc-entry:changed":this.setActiveTOCEntry,"document:changed":this.handleDocumentChange})},componentWillUnmount:function(){var t=this.getDocument();t.disconnect(this)},getInitialState:function(){var t=this.props.doc,e=t.getTOCNodes();return{doc:t,tocNodes:e,activeNode:e.length>0?e[0].id:null}},handleDocumentChange:function(t){for(var e=this.getDocument(),i=!1,s=e.getSchema().getTocTypes(),r=0;r<t.ops.length;r++){var o,a=t.ops[r];if(a.isCreate()||a.isDelete()){var l=a.getValue();if(o=l.type,n.includes(s,o)){i=!0;break}}else{var c=a.path[0],u=e.get(c);if(u&&n.includes(s,u.type)){i=!0;break}}}return i?this.setState({tocNodes:e.getTOCNodes()}):void 0},setActiveTOCEntry:function(t){this.setState({activeNode:t})},handleClick:function(t){var e=t.currentTarget.dataset.id;console.log("clicked",e),t.preventDefault();var i=this.getDocument();i.emit("app:toc-entry-selected",e)},render:function(){var t=this.state,e=n.map(t.tocNodes,function(e){var i=e.level,n=["toc-entry","level-"+i];return t.activeNode===e.id&&n.push("active"),s("a",{className:n.join(" "),href:"#",key:e.id,"data-id":e.id,onClick:this.handleClick},e.content)},this);return s("div",{className:"panel toc-panel-component"},s("div",{className:"toc-entries"},e))}}),a=React.createClass({mixins:[o],displayName:"Contents"});a.contextId="toc",a.icon="fa-align-left",e.exports=a},{"substance-ui/panel_mixin":155,"substance/helpers":170}],161:[function(t,e,i){var s=React.createElement,n=t("substance"),r=React.createClass({displayName:"ToolComponent",contextTypes:{toolRegistry:React.PropTypes.object.isRequired,app:React.PropTypes.object.isRequired},componentWillMount:function(){var t=this.props.tool;if(!t)throw new Error('Prop "tool" is mandatory.');this.tool=this.context.toolRegistry.get(t),this.tool||(console.warn("No tool registered with name %s",t),this.tool=new r.StubTool(t)),this.state=this.tool.state,this.tool.connect(this,{"toolstate:changed":this.onToolstateChanged})},onToolstateChanged:function(t,e,i){this.replaceState(t)},handleClick:function(t){t.preventDefault()},handleMouseDown:function(t){t.preventDefault(),this.state.disabled||this.tool.performAction(this.context.app)},shouldComponentUpdate:function(t,e){return this.state.disabled!==e.disabled||this.state.active!==e.active},render:function(){var t=[];return this.props.classNames&&(t=this.props.classNames.slice()),this.state.disabled&&t.push("disabled"),this.state.active&&t.push("active"),s("button",{className:t.join(" "),title:this.props.title,onMouseDown:this.handleMouseDown,onClick:this.handleClick},this.props.children)}});r.StubTool=n.Surface.Tool.extend({init:function(t){this.name=t},performAction:function(){console.log("Stub-Tool %s",this.name)}}),e.exports=r},{substance:171}],162:[function(t,e,i){"use strict";e.exports=t("./writer")},{"./writer":168}],163:[function(t,e,i){var s=React.createElement,n={error:"fa-exclamation-circle",info:"fa-info",progress:"fa-exchange",success:"fa-check-circle"},r=React.createClass({contextTypes:{notifications:React.PropTypes.object.isRequired},displayName:"StatusBar",getInitialState:function(){return{message:null}},componentDidMount:function(){var t=this.context.notifications;t.connect(this,{"messages:updated":this.handleNotificationUpdate})},handleNotificationUpdate:function(t){var e=t.pop();this.setState({message:e})},render:function(){var t,e=this.state.message,i=["status-bar-component fill-light"];return e?(i.push(e.type),t=s("div",{className:"notifications"},s("div",{className:"icon",dangerouslySetInnerHTML:{__html:'<i class="fa '+n[e.type]+'"></i>'}}),s("div",{className:"message"},e.message))):t=s("div"),s("div",{className:i.join(" ")},s("div",{className:"document-status"},this.props.doc.getDocumentMeta().title),t)}});e.exports=r},{}],164:[function(t,e,i){e.exports={redo:t("./redo"),undo:t("./undo"),save:t("./save")}},{"./redo":165,"./save":166,"./undo":167}],165:[function(t,e,i){var s=t("substance"),n=s.Surface.Tool.extend({name:"redo",update:function(t){this.surface=t;var e=t.getDocument();t.isEnabled()&&0!==e.undone.length?this.setEnabled():this.setDisabled()},performAction:function(){var t=this.getDocument();this.isEnabled()&&t.undone.length>0&&t.redo()}});e.exports=n},{substance:171}],166:[function(t,e,i){var s=t("substance"),n=s.Surface.Tool.extend({name:"save",init:function(t){this.app=t.app,this.doc=t.doc,this.doc.connect(this,{"document:changed":this.handleDocumentChange,"document:saved":this.handleDocumentSaved})},dispose:function(){this.doc.disconnect(this)},handleDocumentChange:function(){this.setEnabled()},handleDocumentSaved:function(){this.setDisabled()},performAction:function(){this.app.requestSave()}});e.exports=n},{substance:171}],167:[function(t,e,i){var s=t("substance"),n=s.Surface.Tool.extend({name:"undo",update:function(t){this.surface=t;var e=t.getDocument();t.isEnabled()&&0!==e.done.length?this.setEnabled():this.setDisabled()},performAction:function(){var t=this.getDocument();this.isEnabled()&&t.done.length>0&&t.undo()}});e.exports=n},{substance:171}],168:[function(t,e,i){var s=React.createElement,n=t("substance"),r=t("substance/helpers"),o=t("../content_tools"),a=t("../content_panel"),l=t("./writer_controller_mixin"),c=t("./status_bar"),u=r.extend({},l,n.EventEmitter.prototype,{render:function(){var t=this.componentRegistry.get("content_toolbar")||o;return s("div",{className:"writer-component",onKeyDown:this.handleApplicationKeyCombos},s("div",{className:"main-container"},s(t),s(a,{containerId:this.props.contentContainer})),s("div",{className:"resource-container"},this.createContextToggles(),this.createContextPanel(this)),this.createModalPanel(),s(c,{doc:this.props.doc}),s("div",{className:"clipboard"}))},handleApplicationKeyCombos:function(t){var e=!1;90===t.keyCode&&(t.metaKey||t.ctrlKey)?(t.shiftKey?this.redo():this.undo(),e=!0):27===t.keyCode?(this.replaceState(this.getInitialState()),e=!0):83===t.keyCode&&(t.metaKey||t.ctrlKey)&&(this.requestSave(),e=!0),e&&(t.preventDefault(),t.stopPropagation())}}),h=React.createClass({mixins:[u],displayName:"Writer"});e.exports=h},{"../content_panel":148,"../content_tools":149,"./status_bar":163,"./writer_controller_mixin":169,substance:171,"substance/helpers":170}],169:[function(t,e,i){var s=t("substance"),n=(s.Document,t("substance/helpers")),r=(t("substance").Surface.ToolManager,t("../text_property").Highlight,t("../extension_manager"),t("../document_controller_mixin")),o=t("./tools"),a=n.extend({},r,{getTools:function(){return o.concat(this.extensionManager.getTools())}});e.exports=a},{"../document_controller_mixin":150,"../extension_manager":152,"../text_property":158,"./tools":164,substance:171,"substance/helpers":170}],170:[function(t,e,i){e.exports=t("./src/basics/helpers")},{"./src/basics/helpers":175}],171:[function(t,e,i){var s=t("./src/basics");s.Data=t("./src/data"),s.Document=t("./src/document"),s.Operator=t("./src/operator"),s.Surface=t("./src/surface"),s._=t("./src/basics/helpers"),e.exports=s},{"./src/basics":176,"./src/basics/helpers":175,"./src/data":182,"./src/document":204,"./src/operator":239,"./src/surface":248}],172:[function(t,e,i){"use strict";function s(){Error.apply(this,arguments)}var n=t("./oo");n.inherit(s,Error),e.exports=s},{"./oo":177}],173:[function(t,e,i){"use strict";function s(){this.__events__={}}var n=t("./oo");s.Prototype=function(){function t(t,e){if("string"==typeof t){if(void 0===e||null===e)throw new Error('Method name "'+t+'" has no context.');if(!(t in e))throw new Error('Method not found: "'+t+'"');if("function"!=typeof e[t])throw new Error('Property "'+t+'" is not a function')}else if("function"!=typeof t)throw new Error("Invalid callback. Function or method name expected.")}function e(t,e){return e.priority-t.priority}this._on=function(e,i,s,n){var r;return t(i,s),r=this.__events__.hasOwnProperty(e)?this.__events__[e]:this.__events__[e]=[],r.push({method:i,context:s||null,priority:n}),this},this._off=function(e,i,s){var n,r;if(1===arguments.length)return delete this.__events__[e],this;if(t(i,s),!(e in this.__events__&&this.__events__[e].length))return this;for(arguments.length<3&&(s=null),r=this.__events__[e],n=r.length;n--;)r[n].method===i&&r[n].context===s&&r.splice(n,1);return 0===r.length&&delete this.__events__[e],this},this.emit=function(t){if(t in this.__events__){for(var e=this.__events__[t].slice(),i=Array.prototype.slice.call(arguments,1),s=0,n=e.length;n>s;s++){var r=e[s];r.method.apply(r.context,i)}return!0}return!1},this.connect=function(t,i,s){var n=0;3===arguments.length&&(n=s.priority||n);for(var r in i){var o=i[r];this._on(r,o,t,n)}return this.__events__[r].sort(e),this},this.on=function(t,i,s,n){var r=0;3===arguments.length&&(r=n.priority||r),this._on(t,i,s,r),this.__events__[t].sort(e)},this.disconnect=function(t){var e,i,s;for(i in this.__events__)for(s=this.__events__[i],e=s.length;e--;)s[e]&&s[e].context===t&&this._off(i,s[e].method,t);return this}},n.initClass(s),e.exports=s},{"./oo":177}],174:[function(t,e,i){"use strict";function s(){s["super"].call(this)}var n=t("./oo"),r=t("./registry");s.Prototype=function(){this.create=function(t){var e=this.get(t);if(!e)throw new Error("No class registered by that name: "+t);var i=Array.prototype.slice.call(arguments,1),s=Object.create(e.prototype);return e.apply(s,i),s}},n.inherit(s,r),e.exports=s},{"./oo":177,"./registry":179}],175:[function(t,e,i){"use strict";var s={};s.isEqual=t("lodash/lang/isEqual"),s.isObject=t("lodash/lang/isObject"),s.isArray=t("lodash/lang/isArray"),s.isString=t("lodash/lang/isString"),s.isNumber=t("lodash/lang/isNumber"),s.isBoolean=t("lodash/lang/isBoolean"),s.isFunction=t("lodash/lang/isFunction"),s.cloneDeep=t("lodash/lang/cloneDeep"),s.clone=t("lodash/lang/clone"),s.isEmpty=t("lodash/lang/isEmpty"),s.bind=t("lodash/function/bind"),s.delay=t("lodash/function/delay"),s.debounce=t("lodash/function/debounce"),s.extend=t("lodash/object/extend"),s.last=t("lodash/array/last"),s.first=t("lodash/array/first"),s.compact=t("lodash/array/compact"),s.uniq=t("lodash/array/uniq"),s.intersection=t("lodash/array/intersection"),s.union=t("lodash/array/union"),s.without=t("lodash/array/without"),s.each=t("lodash/collection/forEach"),s.filter=t("lodash/collection/filter"),s.includes=t("lodash/collection/includes"),s.find=t("lodash/collection/find"),s.map=t("lodash/collection/map"),s.pluck=t("lodash/collection/pluck"),s.indexBy=t("lodash/collection/indexBy"),s.sortBy=t("lodash/collection/sortBy"),s.isArrayEqual=function(t,e){if(t===e)return!0;if(null===t||null===e)return!1;if(t.length!=e.length)return!1;for(var i=0;i<t.length;++i)if(t[i]!==e[i])return!1;return!0},s.deleteFromArray=function(t,e){for(var i=0;i<t.length;i++)t[i]===e&&(t.splice(i,1),i--)},s.deepclone=function(t){return null===t||void 0===t?t:s.isFunction(t.clone)?t.clone():s.deepclone(t)},s.deepclone=s.cloneDeep,s.getRelativeOffset=function(t,e){var i=t.offset(),s=e.offset();return i.left-=s.left,i.top-=s.top,i},s.uuid=function(t,e){t&&"_"!==t[t.length-1]&&(t=t.concat("_"));var i,s="0123456789abcdefghijklmnopqrstuvwxyz".split(""),n=[],r=16;if(e=e||32)for(i=0;e>i;i++)n[i]=s[0|Math.random()*r];else{var o;for(n[8]=n[13]=n[18]=n[23]="-",n[14]="4",i=0;36>i;i++)n[i]||(o=0|16*Math.random(),n[i]=s[19==i?3&o|8:o])}return(t?t:"")+n.join("")},e.exports=s},{"lodash/array/compact":31,"lodash/array/first":33,"lodash/array/intersection":34,"lodash/array/last":35,"lodash/array/union":36,"lodash/array/uniq":37,"lodash/array/without":38,"lodash/collection/filter":39,"lodash/collection/find":40,"lodash/collection/forEach":41,"lodash/collection/includes":42,"lodash/collection/indexBy":43,"lodash/collection/map":44,"lodash/collection/pluck":45,"lodash/collection/sortBy":46,"lodash/function/bind":48,"lodash/function/debounce":49,"lodash/function/delay":50,"lodash/lang/clone":122,"lodash/lang/cloneDeep":123,"lodash/lang/isArray":125,"lodash/lang/isBoolean":126,"lodash/lang/isEmpty":127,"lodash/lang/isEqual":128,"lodash/lang/isFunction":129,"lodash/lang/isNumber":131,"lodash/lang/isObject":132,"lodash/lang/isString":133,"lodash/object/extend":136}],176:[function(t,e,i){"use strict";var s=t("./helpers"),n={};s.extend(n,t("./helpers")),s.extend(n,t("./oo")),n.PathAdapter=t("./path_adapter"),n.EventEmitter=t("./event_emitter"),n.Error=t("./error"),n.Registry=t("./registry"),n.Factory=t("./factory"),e.exports=n},{"./error":172,"./event_emitter":173,"./factory":174,"./helpers":175,"./oo":177,"./path_adapter":178,"./registry":179}],177:[function(t,e,i){"use strict";var s=t("./helpers"),n={},r=function(t,e){var i=function(){t.apply(this,arguments),this.init&&this.init.apply(this,arguments)};n.inherit(i,t);for(var s in e)if(e.hasOwnProperty(s)){if("name"===s)continue;i.prototype[s]=e[s]}return i["static"].name=e.name,i};n.initClass=function(t){!t.Prototype||t.prototype instanceof t.Prototype||(t.prototype=new t.Prototype,t.prototype.constructor=t),t["static"]=t["static"]||{},t.extend=t.extend||s.bind(r,null,t)},n.inherit=function(t,e){if(t.prototype instanceof e)throw new Error("Target already inherits from origin");var i=t.prototype.constructor,o=t.Prototype;t["super"]=e,o?(o.prototype=e.prototype,t.prototype=new o,t.prototype.constructor=t):t.prototype=Object.create(e.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),t.prototype["super"]=e.prototype,n.initClass(e),t["static"]=Object.create(e["static"]),t.extend=s.bind(r,null,t)},n.mixin=function(t,e){var i,s=e.prototype;e.Prototype&&(s=new e.Prototype);for(i in s)"constructor"!==i&&s.hasOwnProperty(i)&&(t.prototype[i]=s[i]);if(n.initClass(t),e["static"])for(i in e["static"])e["static"].hasOwnProperty(i)&&(t["static"][i]=e["static"][i]);else n.initClass(e)},e.exports=n},{"./helpers":175}],178:[function(t,e,i){"use strict";function s(t){t&&(this.root=t)}var n=t("./helpers"),r=t("./oo");s.Prototype=function(){this.childrenScope=!1,this.getRoot=function(){return this.root||this},this._resolve=function(t,e){for(var i=t.length-1,s=this.getRoot(),n=0;i>n;n++){var r=t[n];if(void 0===s[r]){if(!e)return void 0;s[r]={},this.childrenScope&&(s[r].children={})}s=s[r],this.childrenScope&&(s=s.children)}return s},this.get=function(t){if(n.isString(t))return this[t];if(t&&0!==t.length){var e=t[t.length-1],i=this._resolve(t);return i?i[e]:void 0}return this.getRoot()},this.set=function(t,e){if(n.isString(t))this[t]=e;else{var i=t[t.length-1];this._resolve(t,!0)[i]=e}},this["delete"]=function(t,e){if(n.isString(t))delete this[t];else{var i=t[t.length-1],s=this._resolve(t);if(e&&!s||!s[i])throw new Error("Invalid path.");delete s[i]}},this.clear=function(){var t=this.getRoot();for(var e in t)t.hasOwnProperty(e)&&delete t[e]},this._traverse=function(t,e,i,s){for(var n in t)if(t.hasOwnProperty(n)&&"__values__"!==n){var r=e.concat([n]);i.call(s,r,t[n]),this._traverse(t[n],r,i,s)}},this.traverse=function(t,e){this._traverse(this.getRoot(),[],t,e)}},r.initClass(s),s.Arrays=function(){s.apply(this,arguments)},s.Arrays.Prototype=function(){this.get=function(t){if(n.isString(t))return this[t];if(t&&0!==t.length){var e=t[t.length-1],i=this._resolve(t);return i&&i[e]?i[e].__values__:void 0}return this.getRoot()},this.add=function(t,e){var i=t[t.length-1],s=this._resolve(t,!0);s[i]||(s[i]={__values__:[]});var n=s[i].__values__;n.push(e)},this.remove=function(t,e){var i=this.get(t);i?n.deleteFromArray(i,e):console.warn("Warning: trying to remove a value for an unknown path.",t,e)},this.removeAll=function(t){var e=this.get(t);e.splice(0,e.length)},this.set=function(){throw new Error("This method is not available for PathAdapter.Arrays")},this._traverse=function(t,e,i,s){for(var n in t)if(t.hasOwnProperty(n))if("__values__"===n)i.call(s,e,t.__values__);else{var r=e.concat([n]);this._traverse(t[n],r,i,s)}}},r.inherit(s.Arrays,s),e.exports=s},{"./helpers":175,"./oo":177}],179:[function(t,e,i){"use strict";function s(){this.entries={},this.names=[]}var n=t("./oo");s.Prototype=function(){this.contains=function(t){return!!this.entries[t]},this.add=function(t,e){this.contains(t)&&this.remove(t),this.entries[t]=e,this.names.push(t)},this.remove=function(t){var e=this.names.indexOf(t);e>=0&&this.names.splice(e,1),delete this.entries[t]},this.clear=function(){this.names=[],this.entries=[]},this.get=function(t){var e=this.entries[t];return e||console.error("No entry with name",t),e},this.each=function(t,e){for(var i=0;i<this.names.length;i++){var s=this.names[i],n=t.call(e,this.entries[s],s);if(n===!1)break}}},n.initClass(s),e.exports=s},{"./oo":177}],180:[function(t,e,i){"use strict";function s(t,e){a.call(this),this.schema=t,this.nodes=new o,this.indexes={},e=e||{},this.didCreateNode=e.didCreateNode||function(){},this.didDeleteNode=e.didDeleteNode||function(){}}var n=t("../basics/helpers"),r=t("../basics"),o=r.PathAdapter,a=r.EventEmitter;s.Prototype=function(){this.get=function(t){if(!t)throw new Error("Path or id required");return this.nodes.get(t)},this.getNodes=function(){return this.nodes},this.create=function(t){var e=this.schema.getNodeFactory().create(t.type,t);if(!e)throw new Error("Illegal argument: could not create node for data:",t);if(this.contains(e.id))throw new Error("Node already exists: "+e.id);if(!e.id||!e.type)throw new Error("Node id and type are mandatory.");return this.nodes[e.id]=e,n.each(this.indexes,function(t){t.select(e)&&t.create(e)}),this.didCreateNode(e),e},this["delete"]=function(t){var e=this.nodes[t];return delete this.nodes[t],this.didDeleteNode(e),n.each(this.indexes,function(t){t.select(e)&&t["delete"](e)}),e},this.set=function(t,e){var i=this.get(t[0]),s=this.nodes.get(t);return this.nodes.set(t,e),n.each(this.indexes,function(n){n.select(i)&&n.update(i,t,e,s)}),s},this.update=function(t,e){var i,s=this.nodes.get(t);if(e.isOperation)i=e.apply(s);else{var r,o,a,l;if(n.isString(s))if(e["delete"])r=e["delete"].start,o=e["delete"].end,i=s.split("").splice(r,o-r).join("");else{if(!e.insert)throw new Error("Diff is not supported:",JSON.stringify(e));a=e.insert.offset,l=e.insert.value,i=[s.substring(0,a),l,s.substring(a)].join("")}else{if(!n.isArray(s))throw new Error("Diff is not supported:",JSON.stringify(e));if(i=s.slice(0),e["delete"])a=e["delete"].offset,i.splice(a,1);else{if(!e.insert)throw new Error("Diff is not supported:",JSON.stringify(e));a=e.insert.offset,l=e.insert.value,i.splice(a,0,l)}}}this.nodes.set(t,i);var c=this.get(t[0]);return n.each(this.indexes,function(e){e.select(c)&&e.update(c,t,s,i)}),s},this.toJSON=function(){return{schema:[this.schema.id,this.schema.version],nodes:n.deepclone(this.nodes)}},this.contains=function(t){return!!this.nodes[t]},this.reset=function(){this.nodes=new o},this.addIndex=function(t,e){return this.indexes[t]&&console.error("Index with name %s already exists.",t),e.reset(this),this.indexes[t]=e,e},this.getIndex=function(t){return this.indexes[t]}},r.inherit(s,a),e.exports=s},{"../basics":176,"../basics/helpers":175}],181:[function(t,e,i){"use strict";var s=t("../basics/oo"),n=t("../basics/helpers"),r=t("./data"),o=t("../operator"),a=o.ObjectOperation,l=o.ArrayOperation,c=o.TextOperation,u=function(t,e){u["super"].call(this,t,e)};u.Prototype=function(){this.create=function(t){var e=a.Create([t.id],t);return this.apply(e),e},this["delete"]=function(t){var e=null,i=this.get(t);if(i){var s=i.toJSON();e=a.Delete([t],s),this.apply(e)}return e},this.update=function(t,e){var i=this._getDiffOp(t,e),s=a.Update(t,i);return this.apply(s),s},this.set=function(t,e){var i=this.get(t),s=a.Set(t,i,e);return this.apply(s),s},this.apply=function(t){if(t.type!==a.NOP){if(t.type===a.CREATE)this["super"].create.call(this,n.deepclone(t.val));else if(t.type===a.DELETE)this["super"]["delete"].call(this,t.val.id);else if(t.type===a.UPDATE){var e=this.get(t.path),i=t.diff;if("array"===t.propertyType)i instanceof l||(i=l.fromJSON(i)),i.apply(e);else{if("string"!==t.propertyType)throw new Error("Unsupported type for operational update.");i instanceof c||(i=c.fromJSON(i));var s=i.apply(e);this["super"].set.call(this,t.path,s)}}else{if(t.type!==a.SET)throw new Error("Illegal state.");this["super"].set.call(this,t.path,t.val)}this.emit("operation:applied",t,this)}},this._getDiffOp=function(t,e){var i=null;if(e.isOperation)i=e;else{var s,r,o,a,u=this.get(t);n.isString(u)?e["delete"]?(s=e["delete"].start,r=e["delete"].end,i=c.Delete(s,u.substring(s,r))):e.insert&&(o=e.insert.offset,a=e.insert.value,i=c.Insert(o,a)):n.isArray(u)&&(e["delete"]?(o=e["delete"].offset,i=l.Delete(o,u[o])):e.insert&&(o=e.insert.offset,a=e.insert.value,i=l.Insert(o,a)))}if(!i)throw new Error("Unsupported diff: "+JSON.stringify(e));return i}},s.inherit(u,r),e.exports=u},{"../basics/helpers":175,"../basics/oo":177,"../operator":239,"./data":180}],182:[function(t,e,i){"use strict";var s=t("./data");s.Incremental=t("./incremental_data"),s.Node=t("./node"),s.Schema=t("./schema"),s.Index=t("./node_index"),e.exports=s},{"./data":180,"./incremental_data":181,"./node":183,"./node_index":185,"./schema":186}],183:[function(t,e,i){"use strict";function s(t){r.call(this),this.properties=n.extend({},this.getDefaultProperties(),t),this.properties.type=this.constructor["static"].name,this.properties.id=this.properties.id||n.uuid(this.properties.type)}var n=t("../basics"),r=n.EventEmitter;s.Prototype=function(){this.toJSON=function(){return this.properties},this.getDefaultProperties=function(){},this.isInstanceOf=function(t){return s.isInstanceOf(this.constructor,t)},this.getClassNames=function(){for(var t=[],e=this.constructor["static"];e&&"node"!==e.name;)t.push(e.name),e=Object.getPrototypeOf(e);return t.join(" ")},this.getPropertyType=function(t){var e=this.constructor["static"].schema;return e[t]}},n.inherit(s,r),s["static"].name="node",s["static"].schema={type:"string",id:"string"},s["static"].readOnlyProperties=["type","id"],s.isInstanceOf=function(t,e){for(var i=t["static"];i&&"node"!==i.name;){if(i&&i.name===e)return!0;i=Object.getPrototypeOf(i)}return!1},s["static"].isInstanceOf=s.isInstanceOf;var o,a=function(t,e,i){var s,n;s=function(){return this.properties[e]},n=i?function(){throw new Error("Property "+e+" is readonly!")}:function(t){return this.properties[e]=t,this};var r={get:s,set:n};Object.defineProperty(t,e,r)},l=function(t){var e=t.prototype;if(t["static"].schema)for(var i=Object.keys(t["static"].schema),s=0;s<i.length;s++){var n=i[s];if(!e.hasOwnProperty(n)){var r=t["static"].readOnlyProperties&&t["static"].readOnlyProperties.indexOf(n)>0;a(e,n,r)}}},c=function(t){var e=t["static"].schema,i=Object.getPrototypeOf(t["static"]),s=i.schema;s&&(t["static"].schema=n.extend(Object.create(s),e))},u=function(t){t.extend=n.bind(o,null,t),l(t),c(t),t.type=t["static"].name};o=function(t,e){var i=function(){t.apply(this,arguments),this.init&&this.init.apply(this,arguments);
};n.inherit(i,t);for(var s in e)if(e.hasOwnProperty(s)){if("name"===s||"properties"===s)continue;i.prototype[s]=e[s]}return i["static"].name=e.name,i["static"].schema=e.properties,u(i),i},u(s),s.initNodeClass=u,e.exports=s},{"../basics":176}],184:[function(t,e,i){"use strict";function s(){o.call(this)}var n=t("../basics"),r=t("./node"),o=n.Factory;s.Prototype=function(){this.register=function(t){var e=t["static"]&&t["static"].name;if("string"!=typeof e||""===e)throw new Error("Node names must be strings and must not be empty");if(!(t.prototype instanceof r))throw new Error("Nodes must be subclasses of Substance.Data.Node");if(this.contains(e))throw new Error("Node class is already registered: "+e);this.add(e,t)}},n.inherit(s,o),e.exports=s},{"../basics":176,"./node":183}],185:[function(t,e,i){"use strict";var s=t("../basics"),n=s.PathAdapter,r=function(){this.index=new n};r.Prototype=function(){this.reset=function(t){this.index.clear(),this._initialize(t)},this._initialize=function(t){s.each(t.getNodes(),function(t){this.select(t)&&this.create(t)},this)},this.property="id",this.select=function(t){return this.type?t.isInstanceOf(this.type):!0},this.get=function(t){return t?this.index.get(t)||{}:this.getAll()},this.getAll=function(){var t={};return s.each(this.index,function(e){s.extend(t,e)}),t},this.create=function(t){var e=t[this.property];s.isArray(e)||(e=[e]),s.each(e,function(e){this.index.set([e,t.id],t)},this)},this["delete"]=function(t){var e=t[this.property];s.isArray(e)||(e=[e]),s.each(e,function(e){this.index["delete"]([e,t.id])},this)},this.update=function(t,e,i,n){if(this.select(t)&&e[1]===this.property){var r=n;s.isArray(r)||(r=[r]),s.each(r,function(e){this.index["delete"]([e,t.id])},this),r=i,s.isArray(r)||(r=[r]),s.each(r,function(e){this.index.set([e,t.id],t)},this)}},this.clone=function(){var t=this.constructor,e=new t;return e}},s.initClass(r),r.create=function(t){var e=s.extend(new r,t);return e.clone=function(){return r.create(t)},e},e.exports=r},{"../basics":176}],186:[function(t,e,i){"use strict";function s(t,e){this.name=t,this.version=e,this.nodeFactory=new a,this.tocTypes=[],this.addNodes(this.getBuiltIns())}var n=t("../basics/helpers"),r=t("../basics/oo"),o=t("./node"),a=t("./node_factory");s.Prototype=function(){function t(t){var e={};return t["static"].hasOwnProperty("schema")&&(e.properties=n.clone(t["static"].schema)),e}this.addNodes=function(t){if(t)for(var e=0;e<t.length;e++){var i=t[e];this.nodeFactory.register(i),i["static"].tocType&&this.tocTypes.push(i["static"].name)}},this.getNodeClass=function(t){return this.nodeFactory.get(t)},this.getNodeFactory=function(){return this.nodeFactory},this.toJSON=function(){var e={id:this.name,version:this.version,types:{}};return this.nodeFactory.each(function(i,s){e.types[s]=t(i)}),e},this.createNode=function(t,e){var i=this.nodeFactory.create(t,e);return i},this.getBuiltIns=function(){return[o]},this.isInstanceOf=function(t,e){var i=this.getNodeClass(t);return i?o["static"].isInstanceOf(i,e):!1},this.each=function(){this.nodeFactory.each.apply(this.nodeFactory,arguments)},this.getTocTypes=function(){return this.tocTypes},this.getDefaultTextType=function(){throw new Error("Schmema.prototype.getDefaultTextType() must be overridden.")}},r.initClass(s),e.exports=s},{"../basics/helpers":175,"../basics/oo":177,"./node":183,"./node_factory":184}],187:[function(t,e,i){"use strict";function s(t){r.EventEmitter.call(this),this.schema=t,this.AUTO_ATTACH=!0,this.FOR_CLIPBOARD=!1,this.data=new o.Incremental(t,{didCreateNode:n.bind(this._didCreateNode,this),didDeleteNode:n.bind(this._didDeleteNode,this)})}var n=t("../basics/helpers"),r=t("../basics"),o=t("../data"),a=t("./selection"),l=t("./property_selection"),c=t("./container_selection"),u=t("./table_selection");s.Prototype=function(){this.isTransaction=function(){return!1},this.isClipboard=function(){return this.FOR_CLIPBOARD},this.newInstance=function(){throw new Error("Must be implemented in subclass.")},this.initialize=function(){},this.addIndex=function(t,e){return this.data.addIndex(t,e)},this.getIndex=function(t){return this.data.getIndex(t)},this._setAutoAttach=function(t){this.AUTO_ATTACH=t},this._setForClipboard=function(t){this.FOR_CLIPBOARD=t},this._resetContainers=function(){var t=this.getIndex("type").get("container");r.each(t,function(t){t.reset()})},this._create=function(t){var e=this.data.create(t);return this._updateContainers(e),e},this._delete=function(t){var e=this.data["delete"](t);return this._updateContainers(e),e},this._update=function(t,e){var i=this.data.update(t,e);return this._updateContainers(i),i},this._set=function(t,e){var i=this.data.set(t,e);return this._updateContainers(i),i},this.documentDidLoad=function(){},this.getSchema=function(){return this.schema},this.get=function(t){return this.data.get(t)},this.getNodes=function(){return this.data.getNodes()},this.addIndex=function(t,e){return this.data.addIndex(t,e)},this.getIndex=function(t){return this.data.getIndex(t)},this.loadSeed=function(t){n.each(this.data.nodes,function(t){this["delete"](t.id)},this),this._setAutoAttach(!1),n.each(t.nodes,function(t){this.create(t)},this),this._setAutoAttach(!0),n.each(this.data.nodes,function(t){t.attach(this)},this),this.documentDidLoad()},this.getTextForSelection=function(t){var e,i=[];if(!t||t.isNull())return"";if(t.isPropertySelection())e=this.get(t.start.path),i.push(e.substring(t.start.offset,t.end.offset));else if(t.isContainerSelection())for(var s=this.get(t.containerId),n=s.getComponentsForRange(t.range),r=0;r<n.length;r++){var o=n[r];e=this.get(o.path),1===n.length?i.push(e.substring(t.start.offset,t.end.offset)):0===r?i.push(e.substring(t.start.offset)):r===n.length-1?i.push(e.substring(0,t.end.offset)):i.push(e)}return i.join("")},this.toJSON=function(){var t={};return n.each(this.getNodes(),function(e){t[e.id]=e.toJSON()}),{schema:[this.schema.name,this.schema.version],nodes:t}},this.create=function(t){throw new Error("Method is abstract.")},this["delete"]=function(t){throw new Error("Method is abstract.")},this.set=function(t,e){throw new Error("Method is abstract.")},this.update=function(t,e){throw new Error("Method is abstract.")},this.setText=function(t,e,i){var s,n=this.getIndex("annotations").get(t);for(s=0;s<n.length;s++)this["delete"](n[s].id);for(this.set(t,e),s=0;s<i.length;s++)this.create(i[s])},this.createSelection=function(t){if(!t)return a.nullSelection;switch(t.type){case"property":return new l(t).attach(this);case"container":return new c(t).attach(this);case"table":return new u(t).attach(this);default:throw new Error("Unsupported selection type",t.type)}},this._didCreateNode=function(t){this.AUTO_ATTACH&&t.attach(this)},this._didDeleteNode=function(t){t.detach(this)},this._updateContainers=function(t){var e=this.getIndex("type").get("container");n.each(e,function(e){e.update(t)})}},r.inherit(s,r.EventEmitter),e.exports=s},{"../basics":176,"../basics/helpers":175,"../data":182,"./container_selection":197,"./property_selection":220,"./selection":222,"./table_selection":223}],188:[function(t,e,i){"use strict";var s=t("../basics"),n=t("./node"),r=(t("./selection"),n.extend({name:"annotation",properties:{path:["array","string"],startOffset:"number",endOffset:"number"},canSplit:function(){return!0},getSelection:function(){return this.getDocument().createSelection({type:"property",path:this.path,startOffset:this.startOffset,endOffset:this.endOffset})},updateRange:function(t,e){if(!e.isPropertySelection())throw new Error("Cannot change to ContainerAnnotation.");s.isEqual(this.startPath,e.start.path)||t.set([this.id,"path"],e.start.path),this.startOffset!==e.start.offset&&t.set([this.id,"startOffset"],e.start.offset),this.endOffset!==e.end.offset&&t.set([this.id,"endOffset"],e.end.offset)},getText:function(){var t=this.getDocument();if(!t)return console.warn("Trying to use an Annotation which is not attached to the document."),"";var e=t.get(this.path);return e.substring(this.startOffset,this.endOffset)}}));r["static"].isInline=!0,r["static"].toHtml=function(t,e,i){var s=t.id,n=t.constructor["static"].tagName||"span",r=$("<"+n+">").attr("id",s).append(i);return r},Object.defineProperties(r.prototype,{startPath:{get:function(){return this.path}},endPath:{get:function(){return this.path}}}),e.exports=r},{"../basics":176,"./node":205,"./selection":222}],189:[function(t,e,i){"use strict";var s=t("../basics"),n=s.PathAdapter,r=t("../data"),o=t("./annotation"),a=function(){this.byPath=new n,this.byType=new n};a.Prototype=function(){this.property="path",this.select=function(t){return t instanceof o},this.reset=function(t){this.byPath.clear(),this.byType.clear(),this._initialize(t)},this.get=function(t,e,i,n){var r=this.byPath.get(t)||{};if(s.isString(t)||1===t.length){var o=r;r=[],s.each(o,function(t){r=r.concat(s.map(t,function(t){return t}))})}else r=s.map(r,function(t){return t});return null!=e&&(r=s.filter(r,a.filterByRange(e,i))),n&&(r=s.filter(r,a.filterByType(n))),r},this.create=function(t){this.byType.set([t.type,t.id],t),this.byPath.set(t.path.concat([t.id]),t)},this["delete"]=function(t){this.byType["delete"]([t.type,t.id]),this.byPath["delete"](t.path.concat([t.id]))},this.update=function(t,e,i,s){this.select(t)&&e[1]===this.property&&(this["delete"]({id:t.id,type:t.type,path:s}),this.create(t))}},s.inherit(a,r.Index),a.filterByRange=function(t,e){return function(i){var s=i.startOffset,n=i.endOffset,r=n>=t;return null!=e&&(r=r&&e>=s),r}},a.filterByType=function(t){return function(e){return e.isInstanceOf(t)}},e.exports=a},{"../basics":176,"../data":182,"./annotation":188}],190:[function(t,e,i){"use strict";var s=t("../basics/helpers"),n=function(t,e,i){if(i){var n=t.getIndex("annotations"),r=n.get(e.path);s.each(r,function(s){var n=e.offset,r=s.startOffset,o=s.endOffset,a=r,l=o;(r>n||n===r)&&(a+=i),(o>n||n===o&&!s.isExternal())&&(l+=i),a!==r&&t.set([s.id,"startOffset"],a),l!==o&&t.set([s.id,"endOffset"],l)}),n=t.getIndex("container-annotations");var o=n.get(e.path);s.each(o,function(s){var n=e.offset,r=s.offset,o=!1;if((r>n||n===r&&!e.after)&&(r+=i,o=!0),o){var a=s.isStart?"startOffset":"endOffset";t.set([s.id,a],r)}})}},r=function(t,e,i,n){if(i!==n){var r=t.getIndex("annotations"),o=r.get(e),a=n-i;s.each(o,function(e){var s=i,r=n,o=e.startOffset,l=e.endOffset,c=o,u=l;o>=r?(c-=a,u-=a,t.set([e.id,"startOffset"],c),t.set([e.id,"endOffset"],u)):(o>=s&&(c=o-Math.min(r-s,o-s)),l>=s&&(u=l-Math.min(r-s,l-s)),o!==l&&c===u?t["delete"](e.id):(o!==c&&t.set([e.id,"startOffset"],c),l!==u&&t.set([e.id,"endOffset"],u)))}),r=t.getIndex("container-annotations");var l=r.get(e),c=[];s.each(l,function(e){c.push(e.id);var s=i,r=n,o=e.offset,l=!1;if(o>=r)o-=a,l=!0;else if(o>=s){var u=o-Math.min(r-s,o-s);o!==u&&(o=u,l=!0)}if(l){var h=e.isStart?"startOffset":"endOffset";t.set([e.id,h],o)}}),s.each(s.uniq(c),function(e){var i=t.get(e),s=i.getSelection();s.isCollapsed()&&(console.log("...deleting container annotation because it has collapsed"+e),t["delete"](e))})}},o=function(t,e,i,n,r){var o=t.getIndex("annotations"),a=o.get(e,i);s.each(a,function(e){var o,a,l=i>e.startOffset&&i<e.endOffset,c=e.startOffset,u=e.endOffset;if(l){if(e.canSplit()){var h=s.clone(e.properties);h.id=s.uuid(e.type+"_"),h.startOffset=r,h.endOffset=r+e.endOffset-i,h.path=n,t.create(h)}o=e.startOffset,a=i,a===o?t["delete"](e.id):(o!==c&&t.set([e.id,"startOffset"],o),a!==u&&t.set([e.id,"endOffset"],a))}else e.startOffset>=i&&(o=r+e.startOffset-i,a=r+e.endOffset-i,t.set([e.id,"path"],n),t.set([e.id,"startOffset"],o),t.set([e.id,"endOffset"],a))}),o=t.getIndex("container-annotations");var l=o.get(e),c=[];s.each(l,function(e){c.push(e.id);var s=e.offset;if(s>=i){var o=e.isStart?"startPath":"endPath",a=e.isStart?"startOffset":"endOffset";t.set([e.id,o],n),t.set([e.id,a],r+e.offset-i)}}),s.each(s.uniq(c),function(e){var i=t.get(e),s=i.getSelection();s.isCollapsed()&&(console.log("...deleting container annotation because it has collapsed"+e),t["delete"](e))})};e.exports={insertedText:n,deletedText:r,transferAnnotations:o}},{"../basics/helpers":175}],191:[function(t,e,i){"use strict";var s=t("../basics"),n=1,r=-1,o=-2,a=function(t){s.extend(this,t)};a.Prototype=function(){var t=function(t,e){if(t.pos<e.pos)return-1;if(t.pos>e.pos)return 1;if(t.id===e.id)return e.mode-t.mode;if(t.mode<e.mode)return-1;if(t.mode>e.mode)return 1;if(t.mode===n){if(t.level<e.level)return-1;if(t.level>e.level)return 1}if(t.mode===r){if(t.level>e.level)return-1;if(t.level<e.level)return 1}return 0},e=function(t){var e=[];return s.each(t,function(t){if(t.zeroWidth)e.push({pos:t.offset,mode:o,id:t.id,level:Number.MAX_VALUE,type:"anchor",node:t});else{var i=t.constructor["static"].level||1e3;e.push({pos:t.startOffset,mode:n,level:i,id:t.id,type:t.type,node:t}),e.push({pos:t.endOffset,mode:r,level:i,id:t.id,type:t.type,node:t})}}),e};this.onText=function(){},this.onEnter=function(){return null},this.onExit=function(){},this.enter=function(t,e){return this.onEnter(t,e)},this.exit=function(t,e,i){this.onExit(t,e,i)},this.createText=function(t,e){e.length>0&&this.onText(t,e)},this.start=function(i,s,a){var l=this,c=e.call(this,a);c.sort(t.bind(this));for(var u=[{context:i,entry:null}],h=0,p=0;p<c.length;p++){var f=c[p];this.createText(u[u.length-1].context,s.substring(h,f.pos)),h=f.pos;var d,m;if(f.mode===n||f.mode===o){for(d=1;d<u.length&&!(f.level<u[d].entry.level);d++);for(m=u.length-1;m>=d;m--)this.exit(u[m].entry,u[m].context,u[m-1].context);for(u.splice(d,0,{entry:f}),m=d;m<u.length;m++)u[m].context=l.enter(u[m].entry,u[m-1].context)}if(f.mode===r||f.mode===o){for(d=1;d<u.length&&u[d].entry.node!==f.node;d++);for(m=u.length-1;m>=d;m--)this.exit(u[m].entry,u[m].context,u[m-1].context);for(u.splice(d,1),m=d;m<u.length;m++)u[m].context=l.enter(u[m].entry,u[m-1].context)}}this.createText(i,s.substring(h))}},s.initClass(a),e.exports=a},{"../basics":176}],192:[function(t,e,i){function s(){s["super"].call(this)}var n=t("../basics/oo"),r=t("./clipboard_importer"),o=t("./html_exporter");s.Prototype=function(){this.getNodeConverter=function(t){switch(t.type){case"emphasis":return r.Emphasis;case"strong":return r.Strong;default:return t.constructor}},this.convert=function(t,e){this.initialize(t,e);var i=this.createHtmlDocument(),s=t.get("content");return i.find("body").append(this.convertContainer(s)),i.find("html").html()}},n.inherit(s,o),e.exports=s},{"../basics/oo":177,"./clipboard_importer":193,"./html_exporter":202}],193:[function(t,e,i){function s(){s["super"].call(this,{trimWhitespaces:!0,REMOVE_INNER_WS:!0}),n.each(s.nodeClasses,function(t){this.defineNodeImporter(t)},this)}var n=t("../basics/helpers"),r=t("../basics/oo"),o=t("./html_importer"),a=t("./nodes/paragraph"),l=t("./nodes/heading"),c=t("./nodes/list"),u=t("./nodes/list_item"),h=t("./nodes/table"),p=t("./nodes/table_section"),f=t("./nodes/table_row"),d=t("./nodes/table_cell"),m=t("./nodes/emphasis"),g=t("./nodes/strong");s.Prototype=function(){this.convert=function(t,e){this.initialize(e,t);var i=t.find("body");i=this.sanitizeBody(i),this.convertContainer(i,"content"),this.finish()},this.sanitizeBody=function(t){var e=t.find("b > p");return e.length&&(t=$(e[0].parentNode)),t},this.checkQuality=function(t){var e=t.find("body");return e.children("b").children("p").length?!0:e.children("p").length?!0:e.find("* p").length?!1:e.children("a,b,i,strong,italic").length?!0:!1}},r.inherit(s,o),s.Emphasis=function(){s.Emphasis["super"].apply(this,arguments)},r.inherit(s.Emphasis,m),s.Emphasis["static"].matchElement=function(t){return t.is("em,i")||"italic"===t[0].style.fontStyle},s.Emphasis["static"].toHtml=function(t,e,i){return $("<i>").attr("id",t.id).append(i)},s.Strong=function(){s.Strong["super"].apply(this,arguments)},r.inherit(s.Strong,g),s.Strong["static"].matchElement=function(t){return t.is("strong,b")||"bold"===t[0].style.fontWeight},s.Strong["static"].toHtml=function(t,e,i){return $("<b>").attr("id",t.id).append(i)},s.nodeClasses=[a,l,c,u,h,p,f,d,s.Emphasis,s.Strong],e.exports=s},{"../basics/helpers":175,"../basics/oo":177,"./html_importer":203,"./nodes/emphasis":206,"./nodes/heading":207,"./nodes/list":210,"./nodes/list_item":211,"./nodes/paragraph":212,"./nodes/strong":213,"./nodes/table":214,"./nodes/table_cell":215,"./nodes/table_row":217,"./nodes/table_section":218}],194:[function(t,e,i){"use strict";function s(){a.apply(this,arguments),this.components=[],this.nodeComponents={},this.byPath=new o({})}var n=t("../basics/helpers"),r=t("../basics/oo"),o=t("../basics/path_adapter"),a=t("./node");s.Prototype=function(){this.didAttach=function(){this.reset()},this.getPosition=function(t){var e=this.nodes.indexOf(t);return e},this.show=function(t,e){var i=this.getDocument();null==e&&(e=this.nodes.length),i.update([this.id,"nodes"],{insert:{offset:e,value:t}})},this.hide=function(t){var e=this.getDocument(),i=this.nodes.indexOf(t);i>=0&&e.update([this.id,"nodes"],{"delete":{offset:i}})},this.getComponent=function(t){var e=this.byPath.get(t);return e},this.getComponentsForRange=function(t){var e=[],i=this.byPath.get(t.start.path),s=this.byPath.get(t.end.path),n=i.getIndex(),r=s.getIndex();e.push(i);for(var o=n+1;r>=o;o++)e.push(this.getComponentAt(o));return e},this.getComponentAt=function(t){return this.components[t]},this.getFirstComponent=function(){return this.components[0]},this.getLastComponent=function(){return n.last(this.components)},this.getComponentsForNode=function(t){var e=this.nodeComponents[t];return e?e.components.slice(0):void 0},this.getNodeForComponentPath=function(t){var e=this.getComponent(t);if(!e)return null;var i=e.rootId;return this.getDocument().get(i)},this.getAnnotationFragments=function(t){var e=[],i=t.getDocument(),s=t,r=s.getStartAnchor(),o=s.getEndAnchor();if(n.isEqual(r.path,o.path))e.push({id:s.id,path:r.path,startOffset:r.offset,endOffset:o.offset});else{var a=i.get(r.path),l=this.getComponent(r.path),c=this.getComponent(o.path);if(!l||!c)throw new Error("Could not find components of AbstractContainerAnnotation");e.push({path:r.path,id:s.id,startOffset:r.offset,endOffset:a.length});for(var u=l.idx+1;u<c.idx;u++){var h=this.getComponentAt(u);a=i.get(h.path),e.push({path:h.path,id:s.id,startOffset:0,endOffset:a.length})}e.push({path:o.path,id:s.id,startOffset:0,endOffset:o.offset})}return e},this.reset=function(){this.byPath=new o;var e=this.getDocument(),i=[];n.each(this.nodes,function(s){var n=e.get(s);i=i.concat(t(n))},this),this.components=[],this.nodeComponents={},this._insertComponentsAt(0,i),this._updateComponentPositions(0)},this.update=function(t){if("create"!==t.type&&"delete"!==t.type&&t.path[0]===this.id&&"nodes"===t.path[1])if("set"===t.type)this.reset();else{var e=t.diff;if(e.isInsert()){var i=this._handleInsert(e.getValue(),e.getOffset());this._updateComponentPositions(i)}else{if(!e.isDelete())throw new Error("Illegal state");var s=this._handleDelete(e.getValue());this._updateComponentPositions(s)}}},this.updateNode=function(e){var i=this.getDocument().get(e),s=this._handleDelete(e),n=t(i);this._insertComponentsAt(s,n),this._updateComponentPositions(s)},this._insertComponentsAt=function(t,e){for(var i=this.components[t-1],n=this.components[t],r=this.nodeComponents,o=this.byPath,a=0;a<e.length;a++){var l=e[a],c=l.rootId,u=r[c];u||(u=new s.NodeComponent(c),r[c]=u),l.parentNode=u,0===a&&i?(i.next=l,l.previous=i):a>0&&(l.previous=e[a-1],e[a-1].next=l),u.components.push(l),o.set(l.path,l)}n&&(e[e.length-1].next=n,n.previous=e[e.length-1]),this.components.splice.apply(this.components,[t,0].concat(e))},this._updateComponentPositions=function(t){for(var e=t;e<this.components.length;e++)this.components[e].idx=e},this._handleInsert=function(e,i){var s,n=this.getDocument(),r=n.get(e),o=this.nodes.length;if(i===o-1)s=this.components.length;else{var a=this.nodes[i+1],l=this.nodeComponents[a].components[0];s=l.getIndex()}var c=t(r);return this._insertComponentsAt(s,c),s},this._handleDelete=function(t){for(var e=this.nodeComponents[t],i=e.components,s=e.components[0].getIndex(),r=n.last(i).getIndex(),o=0;o<i.length;o++){var a=i[o];this.byPath["delete"](a.path)}return delete this.nodeComponents[t],this.components.splice(s,r-s+1),this.components.length>s&&(this.components[s].previous=this.components[s-1]),s>0&&(this.components[s-1].next=this.components[s]),s};var t=function(e,i){i=i||e;for(var r,o=[],a=e.getComponents(),l=0;l<a.length;l++){var c=a[l],u=e.getPropertyType(c);if("string"===u){var h=[e.id,c];o.push(new s.Component(h,i.id))}else if("id"===u){var p=e[c];r=e.getDocument().get(p),o=o.concat(t(r,i))}else{if(!n.isEqual(u,["array","id"]))throw new Error("Not yet implemented.");for(var f=e[c],d=0;d<f.length;d++)r=e.getDocument().get(f[d]),o=o.concat(t(r,i))}}return o}},r.inherit(s,a),s["static"].name="container",s["static"].schema={nodes:["array","string"]},a.initNodeClass(s),s.Component=function(t,e){this.path=t,this.rootId=e,this.idx=-1,this.parentNode=null,this.previous=null,this.next=null},s.Component.Prototype=function(){this.hasPrevious=function(){return!!this.previous},this.getPrevious=function(){return this.previous},this.hasNext=function(){return!!this.next},this.getNext=function(){return this.next},this.getIndex=function(){return this.idx},this.getParentNode=function(){return this.parentNode}},r.initClass(s.Component),s.NodeComponent=function(t){this.id=t,this.components=[]},r.initClass(s.NodeComponent),e.exports=s},{"../basics/helpers":175,"../basics/oo":177,"../basics/path_adapter":178,"./node":205}],195:[function(t,e,i){"use strict";var s=t("../basics"),n=t("./node"),r=t("./selection"),o=n.extend({name:"container_annotation",properties:{container:"string",startPath:["array","string"],startOffset:"number",endPath:["array","string"],endOffset:"number"},getStartAnchor:function(){return this._startAnchor||(this._startAnchor=new o.Anchor(this,"isStart")),this._startAnchor},getEndAnchor:function(){return this._endAnchor||(this._endAnchor=new o.Anchor(this)),this._endAnchor},getSelection:function(){var t=this.getDocument();return t?t.createSelection(this.toJSON()):(console.warn("Trying to use a ContainerAnnotation which is not attached to the document."),r.nullSelection())},getText:function(){var t=this.getDocument();return t?t.getTextForSelection(this.getSelection()):(console.warn("Trying to use a ContainerAnnotation which is not attached to the document."),"")},updateRange:function(t,e){if(!e.isContainerSelection())throw new Error("Cannot change to ContainerAnnotation.");s.isEqual(this.startPath,e.start.path)||t.set([this.id,"startPath"],e.start.path),this.startOffset!==e.start.offset&&t.set([this.id,"startOffset"],e.start.offset),s.isEqual(this.endPath,e.end.path)||t.set([this.id,"endPath"],e.end.path),this.endOffset!==e.end.offset&&t.set([this.id,"endOffset"],e.end.offset)}});o.Anchor=function(t,e){this.node=t,this.id=t.id,this.container=t.container,this.isStart=!!e,Object.freeze(this)},o.Anchor.Prototype=function(){this.zeroWidth=!0,this.getClassNames=function(){return this.node.getClassNames()+" anchor "+(this.isStart?"start-anchor":"end-anchor")}},s.initClass(o.Anchor),Object.defineProperties(o.Anchor.prototype,{path:{get:function(){return this.isStart?this.node.startPath:this.node.endPath},set:function(){throw new Error("Immutable!")}},offset:{get:function(){return this.isStart?this.node.startOffset:this.node.endOffset},set:function(){throw new Error("Immutable!")}}}),e.exports=o},{"../basics":176,"./node":205,"./selection":222}],196:[function(t,e,i){"use strict";var s=t("../basics"),n=s.PathAdapter,r=t("../data"),o=t("./container_annotation"),a=function(t){this.doc=t,this.byPath=new n.Arrays,this.byId={}};a.Prototype=function(){this.select=function(t){return t instanceof o},this.reset=function(t){this.byPath.clear(),this.byId={},this._initialize(t)},this.get=function(t,e){var i=this.byPath.get(t)||[];if(!s.isArray(i)){var n=[];this.byPath._traverse(i,[],function(t){n=n.concat(t)}),i=n}return e?s.filter(i,function(t){return t.container===e}):i.slice(0)},this.create=function(t){var e=t.getStartAnchor(),i=t.getEndAnchor();this.byPath.add(e.path,e),this.byPath.add(i.path,i),this.byId[t.id]=t},this["delete"]=function(t){var e=t.getStartAnchor(),i=t.getEndAnchor();this.byPath.remove(e.path,e),this.byPath.remove(i.path,i),delete this.byId[t.id]},this.update=function(t,e,i,s){if(this.select(t)){var n=null;if("startPath"===e[1])n=t.getStartAnchor();else{if("endPath"!==e[1])return;n=t.getEndAnchor()}this.byPath.remove(s,n),this.byPath.add(n.path,n)}}},s.inherit(a,r.Index),e.exports=a},{"../basics":176,"../data":182,"./container_annotation":195}],197:[function(t,e,i){"use strict";function s(t){var e=t.containerId,i=t.startPath,s=t.endPath||t.startPath,n=t.startOffset,o=t.endOffset||t.startOffset;if(!e||!i||!r.isNumber(n))throw new Error("Invalid arguments: `containerId`, `startPath` and `startOffset` are mandatory");this.containerId=e,this.range=new l(new c(i,n),new c(s,o)),this.reverse=t.reverse,this.collapsed=this.range.start.equals(this.range.end),this._internal={},Object.freeze(this)}var n=t("../basics/oo"),r=t("../basics/helpers"),o=t("./property_selection"),a=t("./selection"),l=t("./range"),c=t("./coordinate");s.Prototype=function(){this.toJSON=function(){return{type:"container",containerId:this.containerId,startPath:this.startPath,startOffset:this.startOffset,endPath:this.endPath,endOffset:this.endOffset,reverse:this.reverse}},this.attach=function(t){return this._internal.doc=t,this},this.isPropertySelection=function(){return!1},this.isContainerSelection=function(){return!0},this.toString=function(){return"ContainerSelection("+JSON.stringify(this.range.start.path)+":"+this.range.start.offset+" -> "+JSON.stringify(this.range.end.path)+":"+this.range.end.offset+(this.reverse?", reverse":"")+")"},this.getContainer=function(){var t=this._internal.doc;if(!t)throw new Error("Selection is not attached to a document.")},this.expand=function(e){var i=t(this),s=t(e),r=i.start,o=s.start,a=i.end,l=s.end,c={start:{pos:r.pos,offset:r.offset},end:{pos:a.pos,offset:a.offset}};return r.pos>o.pos?(c.start.pos=o.pos,c.start.offset=o.offset):r.pos===o.pos&&(c.start.offset=Math.min(r.offset,o.offset)),a.pos<l.pos?(c.end.pos=l.pos,c.end.offset=l.offset):a.pos===l.pos&&(c.end.offset=Math.max(a.offset,l.offset)),n(this,c)},this.truncate=function(s){var r=t(this),o=t(s),l={};if(e(o.start,r.start,"strict"))l.start=r.start,l.end=o.end;else if(e(r.end,o.end,"strict"))l.start=o.start,l.end=r.end;else if(i(r.start,o.start)){if(i(r.end,o.end))return a.nullSelection;l.start=o.end,l.end=r.end}else i(r.end,o.end)&&(l.start=r.start,l.end=o.start);return n(this,l)},this.isInsideOf=function(i,s){if(i.isNull())return!1;var n=t(this),r=t(i);return e(r.start,n.start,s)&&e(n.end,r.end,s)},this.contains=function(i){var s=t(this),n=t(i);return e(s.start,n.start)&&e(n.end,s.end)},this.includesWithOneBoundary=function(s){var n=t(this),r=t(s);return i(n.start,r.start)&&e(r.end,n.end)||i(n.end,r.end)&&e(n.start,r.start)},this.overlaps=function(i){var s=t(this),n=t(i);return!(e(s.end,n.start)||e(n.end,s.start))},this.isLeftAlignedWith=function(e){var s=t(this),n=t(e);return i(s.start,n.start)},this.isRightAlignedWith=function(e){var s=t(this),n=t(e);return i(s.end,n.end)},this.splitIntoPropertySelections=function(){for(var t=[],e=this.getContainer(),i=e.getComponentsForRange(this.range),s=e.getDocument(),n=0;n<i.length;n++){var r,o,a=i[n];r=0===n?this.startOffset:0,o=n===i.length-1?this.endOffset:s.get(a.path).length,t.push(s.createSelection({type:"property",path:a.path,startOffset:r,endOffset:o}))}return t};var t=function(t){if(t._internal.coor)return t._internal.coor;var e,i=this.getContainer(),s=t.getRange(),n=i.getComponent(s.start.path).getIndex();e=t.isCollapsed()?n:i.getComponent(s.end.path).getIndex();var r={start:{pos:n,offset:s.start.offset},end:{pos:e,offset:s.end.offset},collapsed:t.isCollapsed()};return t._internal.coor=r,r},e=function(t,e,i){return i?t.pos>=e.pos?!1:t.pos==e.pos&&t.offset>=e.offset?!1:!0:t.pos>e.pos?!1:t.pos==e.pos&&t.offset>e.offset?!1:!0},i=function(t,e){return t.pos===e.pos&&t.offset===e.offset},n=function(t,e){var i=t.getContainer();return e.start.path=i.getComponentAt(e.start.pos).path,e.end.path=i.getComponentAt(e.end.pos).path,new s({containerId:this.containerId,startPath:e.start.path,startOffset:e.start.offset,endPath:e.end.path,endOffset:e.end.offset})}},n.inherit(s,o),Object.defineProperties(s.prototype,{path:{get:function(){throw new Error("ContainerSelection has no path property. Use startPath and endPath instead")},set:function(){throw new Error("immutable.")}},startPath:{get:function(){return this.range.start.path},set:function(){throw new Error("immutable.")}},endPath:{get:function(){return this.range.end.path},set:function(){throw new Error("immutable.")}}}),e.exports=s},{"../basics/helpers":175,"../basics/oo":177,"./coordinate":198,"./property_selection":220,"./range":221,"./selection":222}],198:[function(t,e,i){"use strict";function s(t,e,i){if(this.path=t,this.offset=e,this.after=i,!r.isArray(t))throw new Error("Invalid arguments: path should be an array.");if(!r.isNumber(e)||0>e)throw new Error("Invalid arguments: offset must be a positive number.");Object.isFrozen(t)||Object.freeze(t),Object.freeze(this)}var n=t("../basics/oo"),r=t("../basics/helpers");s.Prototype=function(){this.equals=function(t){return t===this||r.isArrayEqual(t.path,this.path)&&t.offset===this.offset},this.withCharPos=function(t){return new s(this.path,t)},this.getNodeId=function(){return this.path[0]},this.getPath=function(){return this.path},this.getOffset=function(){return this.offset}},n.initClass(s),e.exports=s},{"../basics/helpers":175,"../basics/oo":177}],199:[function(t,e,i){"use strict";function s(t){a.call(this,t),this.__id__=m++,this.nodeIndex=this.addIndex("type",o.Index.create({property:"type"})),this.annotationIndex=this.addIndex("annotations",new l),this.containerAnnotationIndex=this.addIndex("container-annotations",new c),this.done=[],this.undone=[],this.eventProxies={path:new p(this)},this.initialize(),this.stage=new u(this),this.isTransacting=!1,this.FORCE_TRANSACTIONS=!1}var n=t("../basics/helpers"),r=t("../basics"),o=t("../data"),a=t("./abstract_document"),l=t("./annotation_index"),c=t("./container_annotation_index"),u=t("./transaction_document"),h=t("./document_change"),p=t("./path_event_proxy"),f=t("./clipboard_importer"),d=t("./clipboard_exporter"),m=0;s.Prototype=function(){this.isTransaction=function(){return!1},this.newInstance=function(){var t=this.constructor;return new t(this.schema)},this.fromSnapshot=function(t){var e=this.newInstance();return e.loadSeed(t),e},this.documentDidLoad=function(){this.stage.reset(),this.done=[]},this.getEventProxy=function(t){return this.eventProxies[t]},this.transaction=function(t,e,i){if(1===arguments.length&&(i=arguments[0],e={},t={}),2===arguments.length?(i=arguments[1],e={}):e=e||{},!n.isFunction(i))throw new Error("Document.transaction() requires a transformation function.");var s=this.startTransaction(n.clone(t));try{var r=i(s),o={};for(var a in t)r[a]?o[a]=r[a]:o[a]=t[a];this.isTransacting&&s.save(o,e)}finally{s.finish()}},this.startTransaction=function(t){if(this.isTransacting)throw new Error("Nested transactions are not supported.");return this.isTransacting=!0,this.stage.before=t||{},this.emit("transaction:started",this.stage),this.stage},this.create=function(t){if(this.FORCE_TRANSACTIONS)throw new Error("Use a transaction!");return this.isTransacting?this.stage.create(t):(this.stage&&this.stage.create(t),this._create(t)),this.data.get(t.id)},this["delete"]=function(t){if(this.FORCE_TRANSACTIONS)throw new Error("Use a transaction!");this.isTransacting?this.stage["delete"](t):(this.stage&&this.stage["delete"](t),this._delete(t))},this.set=function(t,e){if(this.FORCE_TRANSACTIONS)throw new Error("Use a transaction!");this.isTransacting?this.stage.set(t,e):(this.stage&&this.stage.set(t,e),this._set(t,e))},this.update=function(t,e){if(this.FORCE_TRANSACTIONS)throw new Error("Use a transaction!");
this.isTransacting?this.stage.update(t,e):(this._update(t,e),this.stage&&this.stage.update(t,e))},this.undo=function(){var t=this.done.pop();if(t){var e=t.invert();this._apply(e),this.undone.push(e),this._notifyChangeListeners(e,{replay:!0})}else console.error("No change can be undone.")},this.redo=function(){var t=this.undone.pop();if(t){var e=t.invert();this._apply(e),this.done.push(e),this._notifyChangeListeners(e,{replay:!0})}else console.error("No change can be redone.")},this.getAnnotationsForSelection=function(t,e){e=e||{};var i,s,r,o;return t.isPropertySelection()?(s=t.getPath(),r=t.getStartOffset(),o=t.getEndOffset(),i=this.annotationIndex.get(s,r,o),e.type&&(i=n.filter(i,l.filterByType(e.type))),i):[]},this.getContainerAnnotationsForSelection=function(t,e,i){if(!e)return[];var s;return s=i.type?this.getIndex("type").get(i.type):this.getIndex("container-annotations").byId,s=n.filter(s,function(e){var i=e.getSelection();return t.overlaps(i)})},this.getDocumentMeta=function(){return this.get("document")},this.getClipboardImporter=function(){return new f},this.getClipboardExporter=function(){return new d},this._setAutoAttach=function(t){s["super"].prototype._setAutoAttach.call(this,t),this.stage._setAutoAttach(t)},this._saveTransaction=function(t,e,i){if(!this.isTransacting)throw new Error("Not in a transaction.");this.isTransacting=!1;var s=this.stage.getOperations();if(s.length>0){var n=new h(s,t,e);this._apply(n,"skipStage"),this.done.push(n),this.undone=[],this._notifyChangeListeners(n,i)}},this._cancelTransaction=function(){if(!this.isTransacting)throw new Error("Not in a transaction.");this.isTransacting=!1},this._apply=function(t,e){if(this.isTransacting)throw new Error("Can not replay a document change during transaction.");"skipStage"!==e&&this.stage.apply(t),n.each(t.ops,function(t){this.data.apply(t),this._updateContainers(t),this.emit("operation:applied",t)},this)},this._notifyChangeListeners=function(t,e){e=e||{},n.each(this.eventProxies,function(i){i.onDocumentChanged(t,e,this)},this),this.emit("document:changed",t,e,this)}},r.inherit(s,a),Object.defineProperty(s.prototype,"id",{get:function(){return this.getDocumentMeta().guid},set:function(){throw new Error("Id is an immutable property.")}}),e.exports=s},{"../basics":176,"../basics/helpers":175,"../data":182,"./abstract_document":187,"./annotation_index":189,"./clipboard_exporter":192,"./clipboard_importer":193,"./container_annotation_index":196,"./document_change":200,"./path_event_proxy":219,"./transaction_document":225}],200:[function(t,e,i){"use strict";function s(t,e,i){this.id=n.uuid(),this.ops=t.slice(0),this.before=e,this.after=i,this.updated=null,this.created=null,this.deleted=null,this._init(),Object.freeze(this),Object.freeze(this.ops),Object.freeze(this.before),Object.freeze(this.after)}var n=t("../basics"),r=n.PathAdapter;s.Prototype=function(){this._init=function(){var t,e=this.ops,i={},s={},n=new r.Arrays;for(t=0;t<e.length;t++){var o=e[t];"create"===o.type&&(i[o.val.id]=o.val,delete s[o.val.id]),"delete"===o.type&&(delete i[o.val.id],delete n[o.val.id],s[o.val.id]=o.val),("set"===o.type||"update"===o.type)&&n.add(o.path,o)}this.created=i,this.deleted=s,this.updated=n},this.isAffected=function(t){return!!this.updated.get(t)},this.isUpdated=this.isAffected,this.invert=function(){for(var t=[],e=this.ops.length-1;e>=0;e--)t.push(this.ops[e].invert());var i=this.after,n=this.before;return new s(t,i,n)},this.traverse=function(t,e){this.updated.traverse(function(){t.apply(e,arguments)})},this.getUpdates=function(t){return this.updated.get(t)||[]},this.getCreated=function(){return this.created},this.getDeleted=function(){return this.deleted}},n.initClass(s),e.exports=s},{"../basics":176}],201:[function(t,e,i){"use strict";function s(t,e){s["super"].call(this,t,e)}var n=t("../basics"),r=t("../data"),o=t("./node"),a=t("./annotation"),l=t("./container"),c=t("./container_annotation"),u=t("./text_node");s.Prototype=function(){this.getDefaultTextType=function(){throw new Error("DocumentSchema.getDefaultTextType() is abstract and must be overridden.")},this.isAnnotationType=function(t){var e=this.getNodeClass(t);return e&&e.prototype instanceof a},this.getBuiltIns=function(){return[o,a,l,c,u]}},n.inherit(s,r.Schema),e.exports=s},{"../basics":176,"../data":182,"./annotation":188,"./container":194,"./container_annotation":195,"./node":205,"./text_node":224}],202:[function(t,e,i){"use strict";function s(t){this.config=t||{},this.state=null}var n=t("../basics"),r=t("./annotator"),o="undefined"!=typeof window;s.Prototype=function(){this.convert=function(t,e){throw new Error("Method is abstract.")},this.getNodeConverter=function(t){return t.constructor},this.convertProperty=function(t,e,i){this.initialize(t,i);var s=$("<div>").append(this.annotatedText(e));return s.html()},this.initialize=function(t,e){e={}||e,this.state={doc:t,options:e}},this.convertNode=function(t){var e=this.getNodeConverter(t);return e["static"].toHtml(t,this)},this.convertContainer=function(t){for(var e=this.state,i=t.nodes,s=[],n=0;n<i.length;n++){var r=e.doc.get(i[n]),o=this.convertNode(r);if(!o||!this.isElementNode(o[0]))throw new Error("Contract: Node.static.toHtml() must return a DOM element. NodeType: "+r.type);o.attr("id",r.id),s.push(o)}return s},this.annotatedText=function(t){var e=this,i=this.state.doc,s=i.getIndex("annotations").get(t),n=i.get(t),o=new r;o.onText=function(t,e){t.children.push(e)},o.onEnter=function(t){var e=t.node;return{annotation:e,children:[]}},o.onExit=function(t,i,s){var n=i.annotation,r=e.getNodeConverter(n),o=r["static"].toHtml(n,e,i.children);if(!o||!e.isElementNode(o[0]))throw new Error("Contract: Annotation.toHtml() must return a DOM element.");o.attr("id",n.id),s.children.push(o)};var a={children:[]};return o.start(a,n,s),a.children},this.isElementNode=function(t){return o?t.nodeType===window.Node.ELEMENT_NODE:"tag"===t.type},this.createHtmlDocument=function(){var t="<!DOCTYPE html><html><head></head><body></body></html>";if(o){var e=new window.DOMParser,i=e.parseFromString(t,"text/html");return $(i)}var s=$.load(t).root();return s},this.createXmlDocument=function(){var t='<article xmlns="http://www.w3.org/1999/xhtml"></article>';if(o){var e=new window.DOMParser,i=e.parseFromString(t,"text/xml");return $(i)}var s=$.load(t).root();return s}},n.initClass(s),e.exports=s},{"../basics":176,"./annotator":191}],203:[function(t,e,i){(function(i){function s(t){this.config=t||{},this.nodeTypesByName={},this.nodeTypes=[],this.blockTypes=[],this.inlineTypes=[],this.config.schema&&this.config.schema.each(function(t){this.defineNodeImporter(t)},this),this.$=i.$}var n=t("../basics"),r=n,o="undefined"!=typeof window;s.Prototype=function(){this.defineNodeImporter=function(t){t["static"].matchElement&&(this.nodeTypes.push(t),this.nodeTypesByName[t["static"].name]=t,t["static"].blockType?this.blockTypes.push(t):t["static"].isInline&&this.inlineTypes.push(t))},this.defaultConverter=function(t,e){console.warn("This element is not handled by the converters you provided. This is the default implementation which just skips conversion. Override HtmlImporter.defaultConverter(el, converter) to change this behavior.",this.$toStr(t));var i=this.state.doc.getSchema().getDefaultTextType(),s=this.nodeTypesByName[i];if(!s)throw new Error("Could not class for default text type",i);var n=s["static"].fromHtml(t,e);return n&&(n.type=i),n},this.initialize=function(t,e){var i={doc:t,$root:e,inlineNodes:[],trimWhitespaces:!!this.config.trimWhitespaces,stack:[],lastChar:"",skipTypes:{},ignoreAnnotations:!1};this.state=i},this.convert=function(t,e){throw new Error("This method is abstract.")},this.convertContainer=function(t,e){var i=this.state,r=i.doc,o=r.get(e);i.containerNode=o;for(var a=new s.ChildNodeIterator(t[0]);a.hasNext();){var l,c=a.next(),u=this.$(c),h=this._getBlockTypeForElement(u);if(h){if(l=h["static"].fromHtml(u,this),!l)throw new Error("Contract: a Node's fromHtml() method must return a node",this.$toStr(u));l.type=h["static"].name,l.id=l.id||u.attr("id")||n.uuid(l.type),r.create(l),o.show(l.id)}else if(this.isCommentNode(c));else if(this.isTextNode(c)){var p=u.text();if(/^\s*$/.exec(p))continue;a.back(),this.wrapInlineElementsIntoBlockElement(a)}else if(this.isElementNode(c)){var f=this._getInlineTypeForElement(u);f||"span"===this.getTagName(c)?(a.back(),this.wrapInlineElementsIntoBlockElement(a)):this.createDefaultBlockElement(u)}}},this.finish=function(){for(var t=this.state.doc,e=0;e<this.state.inlineNodes.length;e++)t.create(this.state.inlineNodes[e])},this.convertProperty=function(t,e,i){var s=this.$("<div>").html(i);this.initialize(t,s);var n=this.annotatedText(s,e);t.setText(e,n,this.state.inlineNodes)},this.convertElement=function(t,e){var i=this.state.doc,s=this._getNodeTypeForElement(t);if(!s)throw new Error("Could not find a node class associated to element:"+this.$toStr(t));var n=s["static"].fromHtml(t,this);return n.type=s["static"].name,n.id=n.id||this.defaultId(t,n.type),r.extend(n,e),i.create(n)},this.getDocument=function(){return this.state.doc},this.getTagName=function(t){return t.tagName?t.tagName.toLowerCase():""},this.isTextNode=function(t){return o?t.nodeType===window.Node.TEXT_NODE:"text"===t.type},this.isElementNode=function(t){return o?t.nodeType===window.Node.ELEMENT_NODE:"tag"===t.type},this.isCommentNode=function(t){return o?t.nodeType===window.Node.COMMENT_NODE:"comment"===t.type},this.wrapInlineElementsIntoBlockElement=function(t){for(var e=this.state,i=e.doc,s=e.containerNode,n=this.$("<div>");t.hasNext();){var r=t.next(),o=this.$(r),a=this._getBlockTypeForElement(o);if(a){t.back();break}n.append(o.clone())}var l=this.defaultConverter(n,this);if(l){if(!l.type)throw new Error("Contract: Html.defaultConverter() must return a node with type.");l.id=l.id||this.nextId(l.type),i.create(l),s.show(l.id)}},this.createDefaultBlockElement=function(t){var e=this.state,i=e.doc,s=e.containerNode,n=this.defaultConverter(t,this);if(n){if(!n.type)throw new Error("Contract: Html.defaultConverter() must return a node with type.",this.$toStr(t));n.id=n.id||this.defaultId(t,n.type),i.create(n),s.show(n.id)}},this.annotatedText=function(t,e){var i=this.state;if(e){if(i.stack.length>0)throw new Error("Contract: it is not allowed to bind a new call annotatedText to a path while the previous has not been completed.",this.$toStr(t));i.stack=[{path:e,offset:0,text:""}]}else if(0===i.stack.length)throw new Error("Contract: HtmlImporter.annotatedText() requires 'path' for non-reentrant call.",this.$toStr(t));var n=new s.ChildNodeIterator(t[0]),r=this._annotatedText(n);return e&&i.stack.pop(),r},this.plainText=function(t){var e=this.state,i=t.text();if(e.stack.length>0){var s=r.last(e.stack);s.offset+=i.length,s.text+=s.text.concat(i)}return i},this.customText=function(t){var e=this.state;if(e.stack.length>0){var i=r.last(e.stack);i.offset+=t.length,i.text+=i.text.concat(t)}return t},this.nextId=function(t){return n.uuid(t)},this.warning=function(t){console.warn("[HtmlImporter] "+t)},this.error=function(t){console.error("[HtmlImporter] "+t)},this.defaultId=function(t,e){for(var i=t.attr("id")||this.nextId(e);this.state.doc.get(i);)i=this.nextId(e);return i},this._annotatedText=function(t){var e=this.state,i=r.last(e.stack);if(!i)throw new Error("Illegal state: context is null.");for(;t.hasNext();){var s=t.next(),n=this.$(s),o="";if(this.isTextNode(s))o=this._prepareText(e,n.text()),o.length&&(i.text=i.text.concat(o),i.offset+=o.length);else{if(this.isCommentNode(s))continue;if(this.isElementNode(s)){var a=this._getInlineTypeForElement(n);if(!a){var l=this._getInlineTypeForElement(n);if(l)throw new Error("Expected inline element. Found block element:",this.$toStr(n));console.warn("Unsupported inline element. We will not create an annotation for it, but process its children to extract annotated text.",this.$toStr(n)),this.annotatedText(n);continue}var c,u=i.offset;if(a["static"].fromHtml){if(e.stack.push({path:i.path,offset:u,text:""}),c=a["static"].fromHtml(n,this),!c)throw new Error("Contract: a Node's fromHtml() method must return a node",this.$toStr(n));a["static"].external&&this.customText("​");var h=e.stack.pop();i.offset=h.offset,i.text=i.text.concat(h.text)}else c={},this.annotatedText(n);var p=i.offset;c.type=a["static"].name,c.id=a.id||this.nextId(c.type),c.startOffset=u,c.endOffset=p,c.path=i.path.slice(0),e.inlineNodes.push(c)}else console.warn("Unknown element type. Taking plain text.",this.$toStr(n)),o=this._prepareText(e,n.text()),i.text=i.text.concat(o),i.offset+=o.length}}return i.text},this._getBlockTypeForElement=function(t){if(!t[0].tagName)return null;for(var e=0;e<this.blockTypes.length;e++)if(this.blockTypes[e]["static"].matchElement(t))return this.blockTypes[e]},this._getInlineTypeForElement=function(t){for(var e=0;e<this.inlineTypes.length;e++)if(this.inlineTypes[e]["static"].matchElement(t))return this.inlineTypes[e]},this._getNodeTypeForElement=function(t){for(var e=0;e<this.nodeTypes.length;e++)if(this.nodeTypes[e]["static"].matchElement(t))return this.nodeTypes[e]},this._getDomNodeType=function(t){if(this.isTextNode(t))return"text";if(this.isCommentNode(t))return"comment";if(t.tagName)return t.tagName.toLowerCase();throw new Error("Unknown node type")};var t=/^\s+/g,e=/^\s*/g,i=/\s+$/g,a=/\s+/g,l=" ",c=/[\t\n\r]+/g;this._prepareText=function(s,n){return s.trimWhitespaces?(n=n.replace(c,l),n=s.lastChar===l?n.replace(e,l):n.replace(t,l),n=n.replace(i,l),this.config.REMOVE_INNER_WS&&(n=n.replace(a,l)),s.lastChar=n[n.length-1]||s.lastChar,n):n},this.$toStr=function(t){var e=t.clone();return e.empty(),$("<p>").append(e).html()}},s.prototype=new s.Prototype,s.ChildNodeIterator=function(t){this.nodes=t.childNodes,this.length=this.nodes.length,this.pos=-1},s.ChildNodeIterator.Prototype=function(){this.hasNext=function(){return this.pos<this.length-1},this.next=function(){return this.pos+=1,this.nodes[this.pos]},this.back=function(){return this.pos>=0&&(this.pos-=1),this}},s.ChildNodeIterator.prototype=new s.ChildNodeIterator.Prototype,e.exports=s}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../basics":176}],204:[function(t,e,i){"use strict";var s=t("./document");s.Schema=t("./document_schema"),s.Node=t("./node"),s.Annotation=t("./annotation"),s.Container=t("./container"),s.ContainerAnnotation=t("./container_annotation"),s.TextNode=t("./text_node"),s.Coordinate=t("./coordinate"),s.Range=t("./range"),s.Selection=t("./selection"),s.nullSelection=s.Selection.nullSelection,s.PropertySelection=t("./property_selection"),s.ContainerSelection=t("./container_selection"),s.TableSelection=t("./table_selection"),s.Annotator=t("./annotator"),s.AnnotationUpdates=t("./annotation_updates"),s.HtmlImporter=t("./html_importer"),s.HtmlExporter=t("./html_exporter"),s.ClipboardImporter=t("./clipboard_importer"),s.ClipboardExporter=t("./clipboard_exporter"),s.Include=t("./nodes/include"),s.Paragraph=t("./nodes/paragraph"),s.Heading=t("./nodes/heading"),s.Emphasis=t("./nodes/emphasis"),s.Strong=t("./nodes/strong"),s.Link=t("./nodes/link"),s.Table=t("./nodes/table"),s.TableSection=t("./nodes/table_section"),s.TableRow=t("./nodes/table_row"),s.TableCell=t("./nodes/table_cell"),s.List=t("./nodes/list"),s.ListItem=t("./nodes/list_item"),s.Transformations=t("./transformations"),e.exports=s},{"./annotation":188,"./annotation_updates":190,"./annotator":191,"./clipboard_exporter":192,"./clipboard_importer":193,"./container":194,"./container_annotation":195,"./container_selection":197,"./coordinate":198,"./document":199,"./document_schema":201,"./html_exporter":202,"./html_importer":203,"./node":205,"./nodes/emphasis":206,"./nodes/heading":207,"./nodes/include":208,"./nodes/link":209,"./nodes/list":210,"./nodes/list_item":211,"./nodes/paragraph":212,"./nodes/strong":213,"./nodes/table":214,"./nodes/table_cell":215,"./nodes/table_row":217,"./nodes/table_section":218,"./property_selection":220,"./range":221,"./selection":222,"./table_selection":223,"./text_node":224,"./transformations":231}],205:[function(t,e,i){"use strict";var s=t("../basics"),n=t("../data"),r=n.Node.extend({name:"node",attach:function(t){this.document=t,this.didAttach(t)},detach:function(){var t=this.document;this.document=null,this.didDetach(t)},didAttach:function(){},didDetach:function(){},isAttached:function(){return null!==this.document},getDocument:function(){return this.document},hasParent:function(){return!!this.parent},getParent:function(){return this.document.get(this.parent)},getRoot:function(){for(var t=this;t.hasParent();)t=t.getParent();return t},getComponents:function(){var t=this.constructor["static"].components||[];return 0===t.length&&console.warn("Contract: a node must define its editable properties.",this.constructor["static"].name),t},isExternal:function(){return this.constructor["static"].external},toHtml:function(t,e){return this.constructor["static"].toHtml(this,t,e)}});r.initNodeClass=n.Node.initNodeClass,r["static"].toHtml=function(t,e){var i=e.$,n=i("<div itemscope>").attr("data-id",t.id).attr("data-type",t.type);return s.each(t.properties,function(s,r){var o=i("<div").attr("itemprop",r);"string"===t.getPropertyType?o[0].appendChild(e.annotatedText([t.id,r])):o.text(s),n.append(o)}),n[0]},r["static"].external=!1,e.exports=r},{"../basics":176,"../data":182}],206:[function(t,e,i){var s=t("../annotation"),n=s.extend({name:"emphasis",splitContainerSelections:!0});n["static"].tagName="em",n["static"].matchElement=function(t){return t.is(n["static"].tagName)},e.exports=n},{"../annotation":188}],207:[function(t,e,i){var s=t("../text_node"),n=s.extend({name:"heading",properties:{level:"number"}});n["static"].blockType=!0,n["static"].tocType=!0,n["static"].matchElement=function(t){return/^h\d$/.exec(t[0].tagName.toLowerCase())},n["static"].fromHtml=function(t,e){var i=e.defaultId(t,"heading"),s={id:i,level:parseInt(""+t[0].tagName[1],10),content:""};return s.content=e.annotatedText(t,[i,"content"]),s},n["static"].toHtml=function(t,e){var i=t.id,s=$("<h"+t.level+">");return s.append(e.annotatedText([i,"content"])),s},e.exports=n},{"../text_node":224}],208:[function(t,e,i){var s=t("../node"),n=s.extend({name:"include",properties:{nodeType:"string",nodeId:"id"},getIncludedNode:function(){return this.getDocument().get(this.nodeId)}});n["static"].components=["nodeId"],n["static"].blockType=!0,n["static"].matchElement=function(t){return t.is("include")},n["static"].fromHtml=function(t,e){var i=e.defaultId(t,"include"),s={id:i,nodeId:t.attr("data-rid"),nodeType:t.attr("data-rtype")};return s},n["static"].toHtml=function(t,e){var i=t.id,s=$("<include>").attr("id",i).attr("data-rtype",t.nodeType).attr("data-rid",t.nodeId);return s},e.exports=n},{"../node":205}],209:[function(t,e,i){var s=t("../annotation"),n=s.extend({name:"link",properties:{url:"string"}});n["static"].tagName="a",n["static"].matchElement=function(t){return t.is("a")},n["static"].fromHtml=function(t,e){var i={url:t.attr("href")};return e.annotatedText(t),i},n["static"].toHtml=function(t,e,i){var n=s["static"].toHtml(t,e,i);return n.attr("href",t.url),n},e.exports=n},{"../annotation":188}],210:[function(t,e,i){"use strict";var s=t("../../basics/helpers"),n=t("../node"),r=n.extend({name:"list",properties:{ordered:"bool",items:["array","id"]},getItems:function(){var t=this.getDocument();return s.map(this.items,function(e){return t.get(e)},this)}});r["static"].components=["items"],r["static"].blockType=!0,r["static"].matchElement=function(t){return t.is("ul,ol")},r["static"].fromHtml=function(t,e){var i=e.defaultId(t,"list"),s={id:i,ordered:!1,items:[]};t.is("ol")&&(s.ordered=!0);var n=1;return t.children().each(function(){var t=$(this);if(t.is("li")){var r=e.convertElement(t,{parent:i,level:n});s.items.push(r.id)}else e.warning("List: unsupported child element. "+e.$toStr(t))}),s},r["static"].toHtml=function(t,e){var i=t.ordered?"ol":"ul",n=t.id,r=("<"+i+">").attr("id",n);return s.each(t.getItems(),function(t){r.append(t.toHtml(e))}),r},Object.defineProperties(r.prototype,{itemNodes:{get:function(){return this.getItems()}}}),e.exports=r},{"../../basics/helpers":175,"../node":205}],211:[function(t,e,i){var s=t("../node"),n=s.extend({name:"list-item",properties:{parent:"id",level:"number",content:"string"}});n["static"].components=["content"],n["static"].matchElement=function(t){return t.is("li")},n["static"].fromHtml=function(t,e){var i=t.data("level")||1,s=e.defaultId(t,"li"),n={id:s,level:i,content:""};return n.content=e.annotatedText(t,[s,"content"]),n},n["static"].toHtml=function(t,e){var i=t.id,s=$("<li>").attr("id",t.id).data("level",t.level).append(e.annotatedText([i,"content"]));return s},e.exports=n},{"../node":205}],212:[function(t,e,i){var s=t("../text_node"),n=s.extend({name:"paragraph"});n["static"].blockType=!0,n["static"].matchElement=function(t){return t.is("p")},n["static"].fromHtml=function(t,e){var i=e.defaultId(t,"p"),s={id:i,content:""};return s.content=e.annotatedText(t,[i,"content"]),s},n["static"].toHtml=function(t,e){var i=t.id,s=$("<p>").attr("id",i);return s.append(e.annotatedText([i,"content"])),s},e.exports=n},{"../text_node":224}],213:[function(t,e,i){var s=t("../annotation"),n=s.extend({name:"strong",splitContainerSelections:!0});n["static"].tagName="strong",n["static"].matchElement=function(t){return t.is(n["static"].tagName)},e.exports=n},{"../annotation":188}],214:[function(t,e,i){var s=t("../../basics/oo"),n=t("../../basics/helpers"),r=t("../node"),o=t("./table_matrix"),a=r.extend({name:"table",matrix:null,properties:{sections:["array","id"]},getSections:function(){var t=this.getDocument();return n.map(this.sections,function(e){return t.get(e)},this)},getSectionAt:function(t){var e=this.getDocument(),i=this.sections[t];return i?e.get(i):null},attach:function(){this["super"].attach.apply(this,arguments)},getMatrix:function(){return this.matrix||(this.matrix=new o(this),this.matrix.update()),this.matrix},getIterator:function(){return new a.CellIterator(this)},getSize:function(t){var e=this.matrix.getSize();return"row"===t?e[0]:"col"===t?e[1]:e}});a["static"].components=["sections"],a["static"].blockType=!0,a["static"].matchElement=function(t){return t.is("table")},a["static"].fromHtml=function(t,e){var i=e.defaultId(t,"table"),s={id:i,sections:[]};if(n.each(["thead","tbody","tfoot"],function(n){var r=t.find(n);if(r.length){var o=e.convertElement(r,{parent:i});s.sections.push(o.id)}}),0===s.sections.length){var r={id:e.nextId("tbody"),parent:i,type:"table-section",sectionType:"body",rows:[]};t.find("tr").each(function(){var t=$(this),s=e.convertElement(t,{parent:i});r.rows.push(s.id)}),e.getDocument().create(r),s.sections.push(r.id)}return s},a["static"].toHtml=function(t,e){var i=t.id,s=$("<table>").attr("id",i);return n.each(t.getSections(),function(t){s.append(t.toHtml(e))}),s},Object.defineProperties(a.prototype,{rowNodes:{get:function(){return this.getRows()}}}),a.CellIterator=function(t){this.table=t,this.__it={sectionIndex:-1,rowIndex:-1,rowNode:null,cellIndex:-1,cellNode:null,sectionNode:null,finished:!1},this.onNewSection=function(){},this.onNewRow=function(){}},a.CellIterator.Prototype=function(){this.next=function(){if(this.__it.finished)throw new Error("TableCellIterator has no more cells left.");return this.nextCell(this.__it),this.__it.finished?null:this.__it.cellNode},this.nextSection=function(t){t.sectionIndex++,t.sectionNode=this.table.getSectionAt(t.sectionIndex),t.sectionNode?(t.rowIndex=0,t.rowNode=t.sectionNode.getRowAt(0),this.onNewSection(t.sectionNode)):t.finished=!0},this.nextRow=function(t){for(t.rowIndex++,t.sectionNode&&(t.rowNode=t.sectionNode.getRowAt(t.rowIndex));!t.rowNode&&!t.finished;)this.nextSection(t);t.rowNode&&(t.cellIndex=0,t.cellNode=t.rowNode.getCellAt(0),this.onNewRow(t.rowNode))},this.nextCell=function(t){for(t.cellNode&&(t.cellIndex++,t.cellNode=t.rowNode.getCellAt(t.cellIndex));!t.cellNode&&!t.finished;)this.nextRow(t)}},s.initClass(a.CellIterator),e.exports=a},{"../../basics/helpers":175,"../../basics/oo":177,"../node":205,"./table_matrix":216}],215:[function(t,e,i){var s=t("../node"),n=s.extend({name:"table-cell",properties:{parent:"id",cellType:"string",colspan:"number",rowspan:"number",content:"string"},getSpan:function(t){return"col"===t?this.colspan||1:"row"===t?this.rowspan||1:void 0}});n["static"].components=["content"],n["static"].matchElement=function(t){return t.is("th, td")},n["static"].fromHtml=function(t,e){var i=e.defaultId(t,"tcell"),s={id:i,content:""};t.is("th")?s.cellType="head":s.cellType="data";var n=t.attr("colspan");n&&(s.colspan=parseInt(n,10));var r=t.attr("rowspan");return r&&(s.rowspan=parseInt(r,10)),s.content=e.annotatedText(t,[i,"content"]),s},n["static"].toHtml=function(t,e){var i=t.id,s="head"===t.cellType?"th":"td",n=$("<"+s+">").attr("id","id").append(e.annotatedText([i,"content"]));return n},Object.defineProperties(n.prototype,{isData:{get:function(){return"data"===this.cellType}}}),e.exports=n},{"../node":205}],216:[function(t,e,i){function s(t){this.tableNode=t,this._matrix=null,this._rowNodes=null}var n=t("../../basics/oo");s.Prototype=function(){this.invalidate=function(){this._matrix=null,this._rowNodes=null},this.update=function(){var t,e,i,n,r,o,a,l,c=[],u=[],h=this.tableNode.getIterator(),p=-1,f=-1;for(h.onNewRow=function(t){p++,f=-1,c[p]=c[p]||[],u.push(t)};null!==(t=h.next());){for(f++;c[p][f];)f++;if(e=new s.Cell(t,p,f),t.rowIdx=p,t.colIdx=f,c[p][f]=e,i=t.getSpan("row"),n=t.getSpan("col"),1!==i||1!==n)for(r=0;i>r;r++)for(o=0;n>o;o++)(0!==r||0!==o)&&(a=p+r,l=f+o,c[a]=c[a]||[],c[a][l]=new s.Placeholder(e,a,l))}this._matrix=c,this._rowNodes=u},this.getCell=function(t,e){var i=this.getMatrix();return i[t][e]},this.getColumn=function(t){var e,i,s=this.getMatrix();for(e=[],i=0;i<s.length;i++)e.push(s[i][t]);return e},this.getRow=function(t){var e=this.getMatrix();return e[t]},this.getRowNode=function(t){var e=this.getRowNodes();return e[t]},this.getMatrix=function(){return this._matrix||this.update(),this._matrix},this.getRowNodes=function(){return this._rowNodes||this.update(),this._rowNodes},this.getRectangle=function(t,e){var i,n,r,o,a,l;return(i=this.lookupCell(t))?(n=t===e?i:this.lookupCell(e),r=Math.min(i.row,n.row),o=Math.max(i.row,n.row),a=Math.min(i.col,n.col),l=Math.max(i.col,n.col),new s.Rectangle(r,a,o,l)):null},this.getCellsForRectangle=function(t){var e,i,s,n,r;for(s=[],n={},e=t.start.row;e<=t.end.row;e++)for(i=t.start.col;i<=t.end.col;i++)r=this.getCell(e,i),"placeholder"===r.type&&(r=r.owner),n[r.key]||(s.push(r),n[r.key]=!0);return s},this.getBoundingRectangle=function(t){var e,i,n;if(t=s.Rectangle.copy(t),e=this.getCellsForRectangle(t),!e||0===e.length)return null;for(n=0;n<e.length;n++)i=e[n],t.start.row=Math.min(t.start.row,i.row),t.start.col=Math.min(t.start.col,i.col),t.end.row=Math.max(t.end.row,i.row+i.node.getSpan("row")-1),t.end.col=Math.max(t.end.col,i.col+i.node.getSpan("col")-1);return t},this.getSize=function(){var t=this.getMatrix();return 0===t.length?{rows:0,cols:0}:{rows:t.length,cols:t[0].length}},this.lookupCell=function(t){var e,i,s,n,r=this.getMatrix(),o=this.getRowNodes();if(e=o.indexOf(t.parent),0>e)return null;for(s=null,n=r[e],i=0;i<n.length&&(s=n[i],s.node!==t);i++);return s},this.findClosestCell=function(t){var e,i,s=this.getMatrix();for(i=s[t.row],e=t.col;e>=0;e--)if("cell"===i[e].type)return i[e];for(e=t.col+1;e<i.length;e++)if("cell"===i[e].type)return i[e];return null}},n.initClass(s),s.Cell=function(t,e,i){this.type="cell",this.node=t,this.row=e,this.col=i,this.key=e+"_"+i},s.Cell.sortDescending=function(t,e){return t.row!==e.row?e.row-t.row:e.col-t.col},s.Placeholder=function(t,e,i){s.Cell.call(this,t.node,e,i),this.type="placeholder",this.owner=t},n.inherit(s.Placeholder,s.Cell),s.Rectangle=function(t,e,i,s){this.start={row:t,col:e},this.end={row:i,col:s}},s.Rectangle.copy=function(t){return new s.Rectangle(t.start.row,t.start.col,t.end.row,t.end.col)},e.exports=s},{"../../basics/oo":177}],217:[function(t,e,i){var s=t("../node"),n=t("../../basics/helpers"),r=s.extend({name:"table-row",properties:{parent:"id",cells:["array","id"]},getCells:function(){var t=this.getDocument();return n.map(this.cells,function(e){return t.get(e)},this)},getCellAt:function(t){var e=this.getDocument(),i=this.cells[t];return i?e.get(i):null}});r["static"].components=["cells"],r["static"].matchElement=function(t){return t.is("tr")},r["static"].fromHtml=function(t,e){var i=e.defaultId(t,"tr"),s={id:i,cells:[]};return t.find("th,td").each(function(){var t=$(this),n=e.convertElement(t,{parent:i});s.cells.push(n.id)}),s},r["static"].toHtml=function(t,e){var i=t.id,s=$("<tr>").attr("id",i);return n.each(t.getCells(),function(t){s.append(t.toHtml(e))}),s},Object.defineProperties(r.prototype,{cellNodes:{get:function(){return this.getCells()}}}),e.exports=r},{"../../basics/helpers":175,"../node":205}],218:[function(t,e,i){var s=t("../node"),n=t("../../basics/helpers"),r=s.extend({name:"table-section",properties:{parent:"id",rows:["array","id"],sectionType:"string"},getRows:function(){var t=this.getDocument();return n.map(this.rows,function(e){return t.get(e)},this)},getRowAt:function(t){var e=this.getDocument(),i=this.rows[t];return i?e.get(i):null}});r["static"].components=["rows"],r["static"].matchElement=function(t){return t.is("thead, tbody, tfoot")},r["static"].fromHtml=function(t,e){var i=t[0].tagName.toLowerCase(),s=i.substring(1),n=e.defaultId(t,i),r={id:n,sectionType:s,rows:[]};return t.find("tr").each(function(){var t=$(this),i=e.convertElement(t,{parent:n});r.rows.push(i.id)}),r},r["static"].toHtml=function(t,e){var i=t.id,s=$("<t"+t.sectionType+">").attr("id",i);return n.each(t.getRows(),function(t){s.append(t.toHtml(e))}),s},Object.defineProperties(r.prototype,{cellNodes:{get:function(){return this.getCells()}}}),e.exports=r},{"../../basics/helpers":175,"../node":205}],219:[function(t,e,i){"use strict";var s=t("../basics/helpers"),n=t("../basics/oo"),r=t("../basics/path_adapter"),o=function(t){this.listeners=new r,this._list=[],this.doc=t};o.Prototype=function(){this.onDocumentChanged=function(t,e,i){function n(e,i){t.deleted[e[0]]||o.add(e,i)}var r=this.listeners,o=t.updated;s.each(t.ops,function(t){if("create"!==t.type&&"delete"!==t.type||!t.val.path&&!t.val.startPath)if("set"!==t.type||"path"!==t.path[1]&&"startPath"!==t.path[1]&&"endPath"!==t.path[1]){if("set"===t.type&&("startOffset"===t.path[1]||"endOffset"===t.path[1])){var e=this.doc.get(t.path[0]);e&&(e.path?n(e.path,t):(n(e.startPath,t),n(e.endPath,t)))}}else n(t.val,t),n(t.original,t);else t.val.path?n(t.val.path,t):t.val.startPath&&(n(t.val.startPath,t),n(t.val.endPath,t))},this),t.traverse(function(n){var o=n.concat(["listeners"]),a=r.get(o);s.each(a,function(s){s.method.call(s.listener,t,e,i)})},this)},this.add=function(t,e,i){var s=t.concat(["listeners"]),n=this.listeners.get(s);if(n||(n=[],this.listeners.set(s,n)),!i)throw new Error("Invalid argument: expected function but got "+i);n.push({method:i,listener:e})},this.connect=function(t,e,i){this.add(e,t,i)},this.remove=function(t,e){var i=t.concat(["listeners"]),s=this.listeners.get(i);if(s)for(var n=0;n<s.length;n++)if(s[n].listener===e)return void s.splice(n,1)},this.disconnect=function(t,e){this.remove(e,t)}},n.initClass(o),e.exports=o},{"../basics/helpers":175,"../basics/oo":177,"../basics/path_adapter":178}],220:[function(t,e,i){"use strict";function s(t){var e=t.path,i=t.startOffset,s=t.endOffset||t.startOffset;if(!e||!n.isNumber(i))throw new Error("Invalid arguments: `path` and `startOffset` are mandatory");this.range=new l(new a(e,i),new a(e,s)),this.reverse=t.reverse,this._internal={},Object.freeze(this)}var n=t("../basics/helpers"),r=t("../basics/oo"),o=t("./selection"),a=t("./coordinate"),l=t("./range");s.Prototype=function(){n.extend(this,o.prototype),this.toJSON=function(){return{type:"property",path:this.path,startOffset:this.startOffset,endOffset:this.endOffset,
reverse:this.reverse}},this.attach=function(t){return this._internal.doc=t,this},this.isNull=function(){return!1},this.getRanges=function(){return[this.range]},this.getRange=function(){return this.range},this.isCollapsed=function(){return this.range.isCollapsed()},this.isReverse=function(){return this.reverse},this.isPropertySelection=function(){return!0},this.isMultiSeletion=function(){return!1},this.equals=function(t){return o.prototype.equals.call(this,t)&&!t.isTableSelection()&&this.range.equals(t.range)},this.collapse=function(t){var e;return e="left"===t?this.range.start:this.range.end,this.createWithNewRange(e.offset,e.offset)},this.getPath=function(){return this.range.start.path},this.getStartOffset=function(){return this.range.start.offset},this.getEndOffset=function(){return this.range.end.offset},this.toString=function(){return["PropertySelection(",JSON.stringify(this.range.start.path),", ",this.range.start.offset," -> ",this.range.end.offset,this.reverse?", reverse":"",this.range.start.after?", after":"",")"].join("")},this.isInsideOf=function(t,e){return t.isNull()?!1:t.isContainerSelection()?t.contains(this):e?n.isEqual(this.path,t.path)&&this.start.offset>t.start.offset&&this.end.offset<t.end.offset:n.isEqual(this.path,t.path)&&this.start.offset>=t.start.offset&&this.end.offset<=t.end.offset},this.contains=function(t,e){return t.isNull()?!1:t.isContainerSelection()?t.isInsideOf(this):e?n.isEqual(this.path,t.path)&&this.start.offset<t.start.offset&&this.end.offset>t.end.offset:n.isEqual(this.path,t.path)&&this.start.offset<=t.start.offset&&this.end.offset>=t.end.offset},this.overlaps=function(t,e){return t.isNull()?!1:t.isContainerSelection()?t.overlaps(this):n.isEqual(this.getPath(),t.getPath())?e?!(this.startOffset>=t.endOffset||this.endOffset<=t.startOffset):!(this.startOffset>t.endOffset||this.endOffset<t.startOffset):!1},this.isRightAlignedWith=function(t){return t.isNull()?!1:t.isContainerSelection()?t.isRightAlignedWith(this):n.isEqual(this.getPath(),t.getPath())&&this.getEndOffset()===t.getEndOffset()},this.isLeftAlignedWith=function(t){return t.isNull()?!1:t.isContainerSelection()?t.isLeftAlignedWith(this):n.isEqual(this.getPath(),t.getPath())&&this.getStartOffset()===t.getStartOffset()},this.expand=function(t){if(t.isNull())return this;if(t.isContainerSelection())return t.expand(this);if(!n.isEqual(this.path,t.path))throw new Error("Can not expand PropertySelection to a different property.");var e=Math.min(this.startOffset,t.startOffset),i=Math.max(this.endOffset,t.endOffset);return this.createWithNewRange(e,i)},this.createWithNewRange=function(t,e){return new s({path:this.path,startOffset:t,endOffset:e})},this.truncate=function(t){if(t.isNull())return this;if(!n.isEqual(this.start.path,t.start.path)||!n.isEqual(this.end.path,t.end.path))throw new Error("Can not expand PropertySelection to a different property.");var e,i;return this.startOffset===t.startOffset?(e=t.endOffset,i=this.endOffset):this.endOffset===t.endOffset&&(e=this.startOffset,i=t.startOffset),this.createWithNewRange(e,i)}},r.inherit(s,o),Object.defineProperties(s.prototype,{start:{get:function(){return this.range.start},set:function(){throw new Error("immutable.")}},end:{get:function(){return this.range.end},set:function(){throw new Error("immutable.")}},path:{get:function(){return this.range.start.path},set:function(){throw new Error("immutable.")}},startOffset:{get:function(){return this.range.start.offset},set:function(){throw new Error("immutable.")}},endOffset:{get:function(){return this.range.end.offset},set:function(){throw new Error("immutable.")}}}),e.exports=s},{"../basics/helpers":175,"../basics/oo":177,"./coordinate":198,"./range":221,"./selection":222}],221:[function(t,e,i){"use strict";var s=t("../basics"),n=function(t,e){this.start=t,this.end=e,Object.freeze(this)};n.Prototype=function(){this.isCollapsed=function(){return this.start.equals(this.end)},this.equals=function(t){return this===t?!0:this.start.equals(t.start)&&this.end.equals(t.end)}},s.initClass(n),e.exports=n},{"../basics":176}],222:[function(t,e,i){"use strict";function s(){}var n=t("../basics");s.Prototype=function(){this.getRanges=function(){return[]},this.isNull=function(){return!1},this.isMultiSeletion=function(){return!1},this.isPropertySelection=function(){return!1},this.isContainerSelection=function(){return!1},this.isTableSelection=function(){return!1},this.isCollapsed=function(){return!0},this.isReverse=function(){return!1},this.equals=function(t){return this===t?!0:t?this.isNull()!==t.isNull()?!1:!0:!1},this.toString=function(){return"null"}},n.initClass(s);var r=function(){};r.Prototype=function(){this.isNull=function(){return!0}},n.inherit(r,s),s.nullSelection=Object.freeze(new r),e.exports=s},{"../basics":176}],223:[function(t,e,i){"use strict";function s(t){if(this.tableId=t.tableId,t.rectangle?this.rectangle=t.rectangle:this.rectangle=new s.Rectangle(t.startRow,t.startCol,t.endRow,t.endCol),!this.tableId)throw new Error("Invalid arguments. `tableId` is mandatory.");this._internal={},Object.freeze(this)}var n=t("../basics"),r=(t("../basics/helpers"),t("./selection"));s.Prototype=function(){this.isPropertySelection=function(){return!1},this.isTableSelection=function(){return!0},this.isSingleCell=function(){return this.rectangle.isSingleCell()},this.getTableId=function(){return this.tableId},this.getRectangle=function(){return this.rectangle},this.equals=function(t){return r.prototype.equals.call(this,t)&&!t.isTableSelection()&&this.startRow===t.startRow&&this.endRow===t.endRow&&this.startCol===t.startCol&&this.ednCol===t.endCol},this.toString=function(){var t=this.rectangle;return"T[("+t.start.row+","+t.start.col+"), ("+t.end.row+", "+t.end.col+")]"},this.attach=function(t){return this._internal.doc=t,this}},n.inherit(s,r),Object.defineProperties(s.prototype,{startRow:{get:function(){return this.rectangle.start.row}},endRow:{get:function(){return this.rectangle.end.row}},startCol:{get:function(){return this.rectangle.start.col}},endCol:{get:function(){return this.rectangle.end.col}}}),s.Rectangle=function(t,e,i,s){var n=Math.min(t,i),r=Math.max(t,i),o=Math.min(e,s),a=Math.max(e,s);this.start={row:n,col:o},this.end={row:r,col:a},Object.freeze(this.start),Object.freeze(this.end),Object.freeze(this)},s.Rectangle.prototype.isSingleCell=function(){return this.start.row===this.end.row&&this.start.col===this.end.col},e.exports=s},{"../basics":176,"../basics/helpers":175,"./selection":222}],224:[function(t,e,i){"use strict";var s=t("./node"),n=s.extend({name:"text",properties:{content:"string"}});n["static"].components=["content"],e.exports=n},{"./node":205}],225:[function(t,e,i){"use strict";function s(t){o.call(this,t.schema),this.__id__="TX_"+a++,this.document=t,this.ops=[],this.before={},n.each(t.data.indexes,function(t,e){this.data.addIndex(e,t.clone())},this),this.loadSeed(t.toJSON())}var n=t("../basics/helpers"),r=t("../basics/oo"),o=t("./abstract_document"),a=0;s.Prototype=function(){this.isTransaction=function(){return!0},this.reset=function(){this.ops=[],this.before={},this._resetContainers()},this.create=function(t){var e=this.data.create(t);if(e)return this.document.isTransacting&&this.ops.push(e),this.data.get(t.id)},this["delete"]=function(t){var e=this.data["delete"](t);if(e)return this.document.isTransacting&&this.ops.push(e),e},this.set=function(t,e){var i=this.data.set(t,e);if(i)return this._updateContainers(i),this.document.isTransacting&&this.ops.push(i),i},this.update=function(t,e){var i=this.data.update(t,e);if(i)return this._updateContainers(i),this.document.isTransacting&&this.ops.push(i),i},this.save=function(t,e){var i=this.before,s=n.extend({},i,t);this.document._saveTransaction(i,s,e),this.reset()},this.cancel=function(){for(var t=this.ops.length-1;t>=0;t--)this.data.apply(this.ops[t].invert());this.document._cancelTransaction(),this.reset()},this.finish=function(){this.document.isTransacting&&this.cancel()},this.cleanup=this.finish,this.getOperations=function(){return this.ops},this.apply=function(t){n.each(t.ops,function(t){this.data.apply(t),this._updateContainers(t)},this)},this.getIndex=function(t){return this.data.getIndex(t)},this._didCreateNode=function(t){t.document=this},this._didDeleteNode=function(t){t.document=null},this.createSelection=function(){return this.document.createSelection.apply(this,arguments)},this.getSchema=function(){return this.schema}},r.inherit(s,o),e.exports=s},{"../basics/helpers":175,"../basics/oo":177,"./abstract_document":187}],226:[function(t,e,i){"use strict";function s(t,e){if(!e.selection)throw new Error("Argument 'selection' is mandatory.");if(!e.containerId)throw new Error("Argument 'containerId' is mandatory.");if(!e.selection.isCollapsed()){var i=o(t,e);e.selection=i.selection}var s=e.selection.getRange(),r=t.get(s.start.path[0]);return r.isInstanceOf("text")?n(t,e):(console.info("Breaking is not supported for node type %s.",r.type),e)}function n(t,e){var i=e.selection,s=e.containerId;if(!i.isPropertySelection())throw new Error("Expected property selection.");var n,o=i.getRange(),l=o.start.path,c=o.start.offset,u=t.get(l[0]),h=u.content,p=t.get(s),f=p.getPosition(u.id),d=r.uuid(u.type),m=[d,"content"];return 0===c?(n=t.create({id:d,type:u.type,content:""}),p.show(d,f),i=t.createSelection({type:"property",path:l,startOffset:0})):(n=t.create({id:d,type:t.getSchema().getDefaultTextType(),content:h.substring(c)}),c<h.length&&(a.transferAnnotations(t,l,c,[d,"content"],0),t.update(l,{"delete":{start:c,end:h.length}})),p.show(d,f+1),i=t.createSelection({type:"property",path:m,startOffset:0})),{selection:i,node:n}}var r=t("../../basics"),o=t("./delete_selection"),a=t("../annotation_updates");e.exports=s},{"../../basics":176,"../annotation_updates":190,"./delete_selection":230}],227:[function(t,e,i){var s=t("../../basics/helpers"),n=t("../annotation_updates"),r=function(t,e){var i=e.selection;return i.isNull()?e.doc=null:i.isPropertySelection()||s.isEqual(i.start.path,i.end.path)?e.doc=o(t,i):i.isContainerSelection()?e.doc=a(t,i):(console.error("Copy is not yet supported for selection type."),e.doc=null),e},o=function(t,e){var i=t.newInstance();i._setForClipboard(!0);var n=e.start.path,r=e.start.offset,o=e.end.offset,a=t.get(n),l=i.create({type:"container",id:"content",nodes:[]});i.create({type:t.schema.getDefaultTextType(),id:"text",content:a.substring(r,o)}),l.show("text");var c=t.getIndex("annotations").get(n,r,o);return s.each(c,function(t){var e=s.deepclone(t.toJSON());e.path=["text","content"],e.startOffset=Math.max(r,t.startOffset)-r,e.endOffset=Math.min(o,t.endOffset)-r,i.create(e)}),i},a=function(t,e){var i=t.newInstance();i._setForClipboard(!0);var r,o,a=t.getIndex("annotations"),l=t.get(e.containerId),c=l.getComponent(e.start.path),u=l.getComponent(e.end.path),h=i.create({type:"container",id:"content",nodes:[]}),p={};for(r=c.getIndex();r<=u.getIndex();r++){o=l.getComponentAt(r);var f=o.parentNode.id,d=t.get(f);p[f]||(p[f]=i.create(d.toJSON()),h.show(f));for(var m=a.get(o.path),g=0;g<m.length;g++)i.create(s.deepclone(m[g].toJSON()))}var b,v=c.parentNode;for(r=0;r<v.components.length;r++){if(o=v.components[r],o===c){e.start.offset>0&&(b=t.get(o.path),i.update(o.path,{"delete":{start:0,end:e.start.offset}}),n.deletedText(i,o.path,0,e.start.offset));break}i.set(o.path,"")}var y=u.parentNode;for(r=0;r<y.components.length;r++){if(o=y.components[r],o===u){b=t.get(o.path),e.end.offset<b.length&&(i.update(o.path,{"delete":{start:e.end.offset,end:b.length}}),n.deletedText(i,o.path,e.end.offset,b.length));break}i.set(o.path,"")}return i};e.exports=r},{"../../basics/helpers":175,"../annotation_updates":190}],228:[function(t,e,i){"use strict";var s=t("../annotation_updates"),n=t("./merge"),r=function(t,e){var i,r,o=e.selection,a=e.direction,l=o.getRange();if(!o.isCollapsed())throw new Error('Selection must be collapsed for transformation "deleteCharacter"');var c=t.get(l.start.path);if(0===l.start.offset&&"left"===a||l.start.offset===c.length&&"right"===a){var u=n(t,{selection:o,containerId:e.containerId,path:l.start.path,direction:a});o=u.selection}else i="left"===a?l.start.offset-1:l.start.offset,r=i+1,t.update(l.start.path,{"delete":{start:i,end:r}}),s.deletedText(t,l.start.path,i,r),o=t.createSelection({type:"property",path:l.start.path,startOffset:i});return{selection:o}};e.exports=r},{"../annotation_updates":190,"./merge":234}],229:[function(t,e,i){"use strict";function s(t,e){if(!e.nodeId)throw new Error("Parameter `nodeId` is mandatory.");var i,s=e.nodeId,r=t.getIndex("annotations").get(s);for(i=0;i<r.length;i++)t["delete"](r[i].id);var o=t.getIndex("container-annotations").get(s);for(i=0;i<o.length;i++){var a=o[i],l=t.get(a.container);if(t.get(a.id)){var c=l.getComponent(a.path);if(a.isStart)c.hasNext()?(t.set([a.id,"startPath"],c.next.path),t.set([a.id,"startOffset"],0)):t["delete"](a.id);else if(c.hasPrevious()){var u=t.get(c.previous.path).length;t.set([a.id,"endPath"],c.previous.path),t.set([a.id,"endOffset"],u)}else t["delete"](a.id)}}n.each(t.getIndex("type").get("container"),function(t){t.hide(s)}),t["delete"](s)}var n=t("../../basics/helpers");e.exports=s},{"../../basics/helpers":175}],230:[function(t,e,i){"use strict";function s(t,e){var i,s=e.selection;return i=s.isCollapsed()?l(t,e):s.isPropertySelection()?n(t,e):r(t,e)}function n(t,e){var i=e.selection.getRange(),s=i.start.path,n=i.start.offset,r=i.end.offset;return t.update(s,{"delete":{start:n,end:r}}),h.deletedText(t,s,n,r),{selection:t.createSelection({type:"property",path:s,startOffset:n})}}function r(t,e){for(var i,s,n=e.selection,r=n.containerId,l=n.getRange(),h=a(t,n),f={selection:null},d=h.length-1;d>=0;d--)i=h[d],s=i.node,i.isFully?c(t,{nodeId:s.id}):o(t,i);if(h[0].isFully){f.selection=null;for(var m=1;m<h.length;m++)if(i=h[m],!i.isFully){f.selection=t.createSelection({type:"property",path:i.components[0].path,startOffset:0});break}}else f.selection=t.createSelection({type:"property",path:l.start.path,startOffset:l.start.offset});if(h.length>1){var g=h[0],b=h[h.length-1];if(g.isFully||b.isFully);else{var v=p.last(b.components);f=u(t,{selection:f.selection,containerId:r,path:v.path,direction:"left"})}}var y=t.get(r);if(0===y.nodes.length){var _=t.getSchema().getDefaultTextType();s={type:_,id:p.uuid(_),content:""},t.create(s),y.show(s.id,0),f.selection=t.createSelection({type:"property",path:[s.id,"content"],startOffset:0})}return f}function o(t,e){for(var i=e.components,s=i.length,r=0;s>r;r++){var o=i[r],a=0,l=t.get(o.path).length;0===r&&(a=e.startOffset),r===s-1&&(l=e.endOffset),n(t,{selection:t.createSelection({type:"property",path:o.path,startOffset:a,endOffset:l})})}}function a(t,e){for(var i=[],s={},n=e.getRange(),r=t.get(e.containerId),o=r.getComponentsForRange(n),a=0;a<o.length;a++){var l=o[a],c=t.get(l.rootId);if(!c)throw new Error("Illegal state: expecting a component to have a proper root node id set.");var u,h=c.id;s[h]||(u={node:c,isFully:!0,components:[]},s[h]=u,i.push(u)),u=s[h],u.components.push(l)}var p=o[0],f=o[o.length-1],d=i[0],m=i[i.length-1],g=t.get(p.path).length,b=t.get(f.path).length;return(n.start.offset>0||p.hasPrevious()&&p.getPrevious().rootId===p.rootId)&&(d.isFully=!1,d.startOffset=n.start.offset,1===i.length?d.endOffset=n.end.offset:d.endOffset=g),i.length>1&&(n.end.offset<b||f.hasNext()&&f.getNext().rootId===f.rootId)&&(m.isFully=!1,m.startOffset=0,m.endOffset=n.end.offset),i}var l=t("./delete_character"),c=t("./delete_node"),u=t("./merge"),h=t("../annotation_updates"),p=t("../../basics/helpers");e.exports=s},{"../../basics/helpers":175,"../annotation_updates":190,"./delete_character":228,"./delete_node":229,"./merge":234}],231:[function(t,e,i){e.exports={breakNode:t("./break_node"),copySelection:t("./copy_selection"),deleteCharacter:t("./delete_character"),deleteNode:t("./delete_node"),deleteSelection:t("./delete_selection"),insertNode:t("./insert_node"),insertText:t("./insert_text"),merge:t("./merge"),paste:t("./paste"),switchTextType:t("./switch_text_type")}},{"./break_node":226,"./copy_selection":227,"./delete_character":228,"./delete_node":229,"./delete_selection":230,"./insert_node":232,"./insert_text":233,"./merge":234,"./paste":235,"./switch_text_type":236}],232:[function(t,e,i){"use strict";function s(t,e){var i=e.selection,s=e.node;if(!e.containerId)throw new Error("containerId is mandatory");if(!e.selection)throw new Error("selection is mandatory");if(!e.node)throw new Error("node is mandatory");var o,a=e.containerId,l=t.get(a);i.isCollapsed()||(o=n(t,e),i=o.selection),o=r(t,e),i=o.selection,t.get(s.id)||(s=t.create(s));var c=l.getComponent(i.start.path),u=l.getPosition(c.rootId);return l.show(s.id,u),{selection:null}}var n=t("./delete_selection"),r=t("./break_node");e.exports=s},{"./break_node":226,"./delete_selection":230}],233:[function(t,e,i){"use strict";var s=t("./delete_selection"),n=t("../annotation_updates"),r=function(t,e){var i=e.selection,r=e.text;if(!i)throw new Error("Argument `selection` is mandatory for transformation `insertText`.");if(!r)throw new Error("Argument `text` is mandatory for transformation `insertText`.");if(!i.isPropertySelection()&&!i.isContainerSelection())throw new Error("Selection must be property or container selection.");var o;i.isCollapsed()||(o=s(t,{selection:i,direction:"right"}),i=o.selection);var a=i.getRange();return t.update(a.start.path,{insert:{offset:a.start.offset,value:r}}),n.insertedText(t,a.start,r.length),{selection:t.createSelection({type:"property",path:a.start.path,startOffset:a.start.offset+r.length})}};e.exports=r},{"../annotation_updates":190,"./delete_selection":230}],234:[function(t,e,i){"use strict";var s=t("../annotation_updates"),n=function(t,e){var i=e.containerId,s=e.path,n=e.direction;if(!i||!s||!n)throw new Error("Insufficient arguments! mandatory fields: `containerId`, `path`, `direction`");var o=t.get(i),a=o.getComponent(s);return"right"===n&&a.next?r(t,i,a,a.next):"left"===n&&a.previous?r(t,i,a.previous,a):void 0},r=function(t,e,i,s){var n=t.get(i.parentNode.id),r=t.get(s.parentNode.id),a=o(n,r);return a?a.call(this,t,e,i,s):void 0},o=function(t,e){var i=null;return t.isInstanceOf("text")&&e.isInstanceOf("text")&&(i=a),i||console.info("No merge behavior defined for %s <- %s",t.type,e.type),i},a=function(t,e,i,n){var r,o=i.path,a=t.get(o),l=a.length,c=n.path,u=t.get(c),h=t.get(e);return 0===l?(h.hide(o[0]),t["delete"](o[0]),r=t.createSelection({type:"property",path:c,startOffset:0})):(t.update(o,{insert:{offset:l,value:u}}),s.transferAnnotations(t,c,0,o,l),h.hide(c[0]),t["delete"](c[0]),r=t.createSelection({type:"property",path:o,startOffset:l})),{selection:r}};e.exports=n},{"../annotation_updates":190}],235:[function(t,e,i){var s=t("../../basics/helpers"),n=t("../annotation_updates"),r=t("./delete_selection"),o=t("./insert_text"),a=t("./break_node"),l=function(t,e){if(e.selection.isNull())return console.error("Can not paste, without selection."),e;if(e.text&&!e.doc)return o(t,e);var i=e.doc;if(!e.selection.isCollapsed()){var s=r(t,e);e.selection=s.selection}var n=i.get("content").nodes;if(n.length>0){var a=i.get(n[0]);return 1===n.length&&a.isInstanceOf("text")?c(t,e):u(t,e)}return e},c=function(t,e){var i=e.doc,r=e.selection,o=i.get("content").nodes,a=[o[0],"content"],l=i.get(a),c=i.getIndex("annotations").get(a),u=r.start.path,h=r.start.offset;return t.update(u,{insert:{offset:h,value:l}}),n.insertedText(t,r.start,l.length),r=t.createSelection({type:"property",path:r.start.path,startOffset:r.start.offset+l.length}),s.each(c,function(e){var i=e.toJSON();i.path=u.slice(0),i.startOffset+=h,i.endOffset+=h,t.get(i.id)&&(i.id=s.uuid(i.type)),t.create(i)}),{selection:r}},u=function(t,e){var i,n=e.doc,r=e.containerId,o=e.selection,l=t.get(r),c=l.getComponent(o.start.path),u=c.parentNode;if(c===s.last(u.components)&&t.get(c.path).length===o.start.offset)i=l.getPosition(o.start.path[0])+1;else{var h=a(t,e);o=h.selection,i=l.getPosition(o.start.path[0])}0>i&&console.error("Could not find insertion position in ContainerNode.");for(var p=n.get("content").nodes,f=n.getIndex("annotations"),d=[],m=0;m<p.length;m++){var g=p[m],b=n.get(g).toJSON();t.get(g)&&(b.id=s.uuid(b.type)),t.create(b),l.show(b.id,i++),d.push(b);for(var v=f.get(g),y=0;y<v.length;y++){var _=v[y].toJSON();b.id!==g&&(_.path[0]=b.id),t.get(_.id)&&(_.id=s.uuid(_.type)),t.create(_)}}if(0!==d.length){var x=s.last(d).id,w=s.last(l.getComponentsForNode(x)),S=t.get(w.path).length;return o=t.createSelection({type:"property",path:w.path,startOffset:S}),{selection:o}}};e.exports=l},{"../../basics/helpers":175,"../annotation_updates":190,"./break_node":226,"./delete_selection":230,"./insert_text":233}],236:[function(t,e,i){"use strict";function s(t,e){var i=e.selection;if(!i.isPropertySelection())return void console.error("Selection must be a PropertySelection.");var s=i.getPath()[0],a=e.data,l=t.get(s),c=i.path;if(!l.isInstanceOf("text"))return void console.warn("Trying to use switchTextType on a non text node. Skipping.");var u=n.extend({id:n.uuid(a.type),type:a.type,content:l.content},a),h=[u.id,"content"];t.create(u);r.transferAnnotations(t,c,0,h,0);var p=t.get(e.containerId),f=p.getPosition(s);return f>=0&&(p.hide(s),p.show(u.id,f)),o(t,{nodeId:l.id}),{selection:t.createSelection({type:"property",path:h,startOffset:i.startOffset,endOffset:i.endOffset})}}var n=t("../../basics/helpers"),r=t("../annotation_updates"),o=t("./delete_node");e.exports=s},{"../../basics/helpers":175,"../annotation_updates":190,"./delete_node":229}],237:[function(t,e,i){"use strict";function s(t,e){t.pos===e.pos?e.pos+=1:t.pos<e.pos?e.pos+=1:t.pos+=1}function n(t,e){return t.pos===e.pos?(e.type=u,void(t.type=u)):void(t.pos<e.pos?e.pos-=1:t.pos-=1)}function r(t,e){if(t.type===h){var i=t;t=e,e=i}t.pos<=e.pos?e.pos+=1:t.pos-=1}var o=t("../basics/helpers"),a=t("../basics/oo"),l=t("./operation"),c=t("./conflict"),u="NOP",h="delete",p="insert",f=function(t){if(l.call(this),!t||null==t.type)throw new Error("Illegal argument: insufficient data.");if(this.type=t.type,this.type!==u){if(this.type!==p&&this.type!==h)throw new Error("Illegal type.");if(this.pos=t.pos,this.val=t.val,!o.isNumber(this.pos)||this.pos<0)throw new Error("Illegal argument: expecting positive number as pos.")}};f.fromJSON=function(t){return new f(t)},f.Prototype=function(){this.apply=function(t){if(this.type===u)return t;if(this.type===p){if(t.length<this.pos)throw new Error("Provided array is too small.");return t.splice(this.pos,0,this.val),t}if(t.length<this.pos)throw new Error("Provided array is too small.");if(!o.isEqual(t[this.pos],this.val))throw Error("Unexpected value at position "+this.pos+". Expected "+this.val+", found "+t[this.pos]);return t.splice(this.pos,1),t},this.clone=function(){var t={type:this.type,pos:this.pos,val:o.deepclone(this.val)};return new f(t)},this.invert=function(){var t=this.toJSON();return this.type===u?t.type=u:this.type===p?t.type=h:t.type=p,new f(t)},this.hasConflict=function(t){return f.hasConflict(this,t)},this.toJSON=function(){var t={type:this.type};return this.type===u?t:(t.pos=this.pos,t.val=o.deepclone(this.val),t)},this.isInsert=function(){return this.type===p},this.isDelete=function(){return this.type===h},this.getOffset=function(){return this.pos},this.getValue=function(){return this.val},this.isNOP=function(){return this.type===u},this.toString=function(){return["(",this.isInsert()?"+":"-",",",this.getOffset(),",'",this.getValue(),"')"].join("")}},a.inherit(f,l);var d=function(t,e){return t.type===u||e.type===u?!1:t.type===p&&e.type===p?t.pos===e.pos:!1},m=function(t,e,i){if(i=i||{},i["no-conflict"]&&d(t,e))throw new c(t,e);return i.inplace||(t=t.clone(),e=e.clone()),t.type===u||e.type===u||(t.type===p&&e.type===p?s(t,e):t.type===h&&e.type===h?n(t,e):r(t,e)),[t,e]};f.transform=m,f.hasConflict=d,f.Insert=function(t,e){return new f({type:p,pos:t,val:e})},f.Delete=function(t,e){return new f({type:h,pos:t,val:e})},f.NOP=u,f.DELETE=h,f.INSERT=p,e.exports=f},{"../basics/helpers":175,"../basics/oo":177,"./conflict":238,"./operation":241}],238:[function(t,e,i){"use strict";function s(t,e){Error.call(this,"Conflict: "+JSON.stringify(t)+" vs "+JSON.stringify(e)),this.a=t,this.b=e}s.prototype=Error.prototype,e.exports=s},{}],239:[function(t,e,i){"use strict";e.exports={Operation:t("./operation"),TextOperation:t("./text_operation"),ArrayOperation:t("./array_operation"),ObjectOperation:t("./object_operation")}},{"./array_operation":237,"./object_operation":240,"./operation":241,"./text_operation":242}],240:[function(t,e,i){"use strict";var s=t("../basics/helpers"),n=t("../basics/oo"),r=t("../basics"),o=r.PathAdapter,a=t("./operation"),l=t("./text_operation"),c=t("./array_operation"),u=t("./conflict"),h="NOP",p="create",f="delete",d="update",m="set",g=function(t){if(a.call(this),!t)throw new Error("Data of ObjectOperation is missing.");if(!t.type)throw new Error("Invalid data: type is mandatory.");if(this.type=t.type,t.type!==h){if(this.path=t.path,!t.path)throw new Error("Invalid data: path is mandatory.");if(this.type===p||this.type===f){if(!t.val)throw new Error("Invalid data: value is missing.");this.val=t.val}else if(this.type===d){if(!t.diff)throw new Error("Invalid data: diff is mandatory for update operation.");if(this.diff=t.diff,t.diff instanceof l)this.propertyType="string";else{if(!(t.diff instanceof c))throw new Error("Invalid data: diff must be a TextOperation or an ArrayOperation.");this.propertyType="array"}}else{if(this.type!==m)throw new Error("Invalid type: "+t.type);this.val=t.val,this.original=t.original}}};g.fromJSON=function(t){if(t=s.deepclone(t),"update"===t.type)switch(t.propertyType){case"string":t.diff=l.fromJSON(t.diff);break;case"array":t.diff=c.fromJSON(t.diff);break;default:throw new Error("Unsupported update diff:"+JSON.stringify(t.diff))}var e=new g(t);return e},g.Prototype=function(){this.apply=function(t){if(this.type===h)return t;var e;if(e=t instanceof o?t:new o(t),this.type===p)return e.set(this.path,s.deepclone(this.val)),t;if(this.type===f)e["delete"](this.path,"strict");else if(this.type===d){var i,n=this.diff,r=e.get(this.path);i=n instanceof c?n.apply(r):n.apply(r),e.set(this.path,i)}else e.set(this.path,s.deepclone(this.val));return t},this.clone=function(){var t={type:this.type,path:this.path};return this.val&&(t.val=s.deepclone(this.val)),this.diff&&(t.diff=this.diff.clone()),new g(t)},this.isNOP=function(){return this.type===h?!0:this.type===d?this.diff.isNOP():void 0},this.isCreate=function(){return this.type===p},this.isDelete=function(){return this.type===f},this.isUpdate=function(){return this.type===d},this.isSet=function(){return this.type===m},this.invert=function(){if(this.type===h)return new g({type:h});var t=new g(this);if(this.type===p)t.type=f;else if(this.type===f)t.type=p;else if(this.type===d){var e;e=this.diff instanceof l?l.fromJSON(this.diff.toJSON()).invert():c.fromJSON(this.diff.toJSON()).invert(),t.diff=e}else t.val=this.original,t.original=this.val;return t},this.hasConflict=function(t){return g.hasConflict(this,t)},this.toJSON=function(){if(this.type===h)return{type:h};var t={type:this.type,path:this.path};return this.type===p||this.type===f?t.val=this.val:this.type===d?(this.diff instanceof c?t.propertyType="array":t.propertyType="string",t.diff=this.diff.toJSON()):(t.val=this.val,t.original=this.original),t},this.getType=function(){return this.type},this.getPath=function(){return this.path},this.getValue=function(){return this.val},this.toString=function(){switch(this.type){case p:return["(+,",JSON.stringify(this.path),JSON.stringify(this.val),")"].join("");case f:return["(-,",JSON.stringify(this.path),JSON.stringify(this.val),")"].join("");case d:return["(>>,",JSON.stringify(this.path),this.propertyType,this.diff.toString(),")"].join("");case m:return["(=,",JSON.stringify(this.path),this.val,this.original,")"].join("")}}},n.inherit(g,a);var b=function(t,e){return t.type===h||e.type===h?!1:s.isEqual(t.path,e.path)},v=function(t,e){t.type=h,e.type=h},y=function(){throw new Error("Can not transform two concurring creates of the same property")},_=function(){throw new Error("Illegal state: can not create and delete a value at the same time.")},x=function(t,e,i){if(t.type!==f)return x(e,t,!0);var s;s="string"===e.propertyType?l.fromJSON(e.diff):c.fromJSON(e.diff),i?(t.val=s.apply(t.val),e.type=h):(t.type=h,e.type=p,e.val=s.apply(t.val))},w=function(){throw new Error("Can not transform a concurring create and update of the same property")},S=function(t,e){var i,s,n;"string"===e.propertyType?(i=l.fromJSON(t.diff),s=l.fromJSON(e.diff),n=l.transform(i,s,{inplace:!0})):(i=c.fromJSON(t.diff),s=c.fromJSON(e.diff),n=c.transform(i,s,{inplace:!0})),t.diff=n[0],e.diff=n[1]},O=function(){throw new Error("Illegal state: can not create and set a value at the same time.")},T=function(t,e,i){return t.type!==f?T(e,t,!0):void(i?(t.val=e.val,e.type=h):(t.type=h,e.type=p,e.original=void 0))},I=function(){throw new Error("Unresolvable conflict: update + set.")},N=function(t,e){t.type=h,e.original=t.val},E=0,C=1,A=2,k=4,R=8,P={};P[h]=E,P[p]=C,P[f]=A,P[d]=k,P[m]=R;var D=[];D[A|A]=v,D[A|C]=_,D[A|k]=x,D[C|C]=y,D[C|k]=w,D[k|k]=S,D[C|R]=O,D[A|R]=T,D[k|R]=I,D[R|R]=N;var j=function(t,e,i){if(i=i||{},i["no-conflict"]&&b(t,e))throw new u(t,e);if(i.inplace||(t=t.clone(),e=e.clone()),t.isNOP()||e.isNOP())return[t,e];var n=s.isEqual(t.path,e.path);return n&&D[P[t.type]|P[e.type]](t,e),[t,e]};g.transform=j,g.hasConflict=b,g.Create=function(t,e){var i;return i=s.isString(t)?[t]:t,new g({type:p,path:i,val:e})},g.Delete=function(t,e){var i;return i=s.isString(t)?[t]:t,new g({type:f,path:i,val:e})},g.Update=function(t,e){var i;if(e instanceof l)i="string";else{if(!(e instanceof c))throw new Error("Unsupported type for operational changes");i="array"}return new g({type:d,path:t,diff:e})},g.Set=function(t,e,i){return new g({type:m,path:t,val:s.deepclone(i),original:s.deepclone(e)})},g.NOP=h,g.CREATE=p,g.DELETE=f,g.UPDATE=d,g.SET=m,e.exports=g},{"../basics":176,"../basics/helpers":175,"../basics/oo":177,"./array_operation":237,"./conflict":238,"./operation":241,"./text_operation":242}],241:[function(t,e,i){"use strict";function s(){}var n=t("../basics");s.Prototype=function(){this.isOperation=!0},n.initClass(s),e.exports=s},{"../basics":176}],242:[function(t,e,i){"use strict";function s(t){if(u.call(this),!t||void 0===t.type||void 0===t.pos||void 0===t.str)throw new Error("Illegal argument: insufficient data.");if(this.type=t.type,this.pos=t.pos,this.str=t.str,!this.isInsert()&&!this.isDelete())throw new Error("Illegal type.");if(!l.isString(this.str))throw new Error("Illegal argument: expecting string.");if(!l.isNumber(this.pos)||this.pos<0)throw new Error("Illegal argument: expecting positive number as pos.")}function n(t,e){t.pos===e.pos?e.pos+=t.str.length:t.pos<e.pos?e.pos+=t.str.length:t.pos+=e.str.length}function r(t,e,i){if(t.pos>e.pos)return r(e,t,!i);if(t.pos===e.pos&&t.str.length>e.str.length)return r(e,t,!i);if(e.pos<t.pos+t.str.length){var s=e.pos-t.pos,n=t.str.length-s,o=s+e.str.length;t.str=t.str.slice(0,s)+t.str.slice(o),e.str=e.str.slice(n),e.pos-=s}else e.pos-=t.str.length}function o(t,e){if(t.type===f)return o(e,t);if(t.pos<=e.pos)e.pos+=t.str.length;else if(t.pos>=e.pos+e.str.length)t.pos-=e.str.length;else{var i=t.pos-e.pos;e.str=e.str.slice(0,i)+t.str+e.str.slice(i),t.str=""}}var a,l=t("../basics/helpers"),c=t("../basics/oo"),u=t("./operation"),h=t("./conflict"),p="+",f="-";s.fromJSON=function(t){return new s(t)},s.Prototype=function(){this.apply=function(t){if(this.isEmpty())return t;if(this.type===p){if(t.length<this.pos)throw new Error("Provided string is too short.");return t.splice?t.splice(this.pos,0,this.str):t.slice(0,this.pos).concat(this.str).concat(t.slice(this.pos))}if(t.length<this.pos+this.str.length)throw new Error("Provided string is too short.");return t.splice?t.splice(this.pos,this.str.length):t.slice(0,this.pos).concat(t.slice(this.pos+this.str.length))},this.clone=function(){
return new s(this)},this.isNOP=function(){return"NOP"===this.type||0===this.str.length},this.isInsert=function(){return this.type===p},this.isDelete=function(){return this.type===f},this.getLength=function(){return this.str.length},this.invert=function(){var t={type:this.isInsert()?"-":"+",pos:this.pos,str:this.str};return new s(t)},this.hasConflict=function(t){return a(this,t)},this.isEmpty=function(){return 0===this.str.length},this.toJSON=function(){return{type:this.type,pos:this.pos,str:this.str}},this.toString=function(){return["(",this.isInsert()?"+":"-",",",this.pos,",'",this.str,"')"].join("")}},c.inherit(s,u),a=function(t,e){if(t.type===p&&e.type===p)return t.pos===e.pos;if(t.type===f&&e.type===f)return!(t.pos>=e.pos+e.str.length||e.pos>=t.pos+t.str.length);var i,s;return t.type===f?(i=t,s=e):(i=e,s=t),s.pos>=i.pos&&s.pos<i.pos+i.str.length};var d=function(t,e,i){if(i=i||{},i["no-conflict"]&&a(t,e))throw new h(t,e);return i.inplace||(t=t.clone(),e=e.clone()),t.type===p&&e.type===p?n(t,e):t.type===f&&e.type===f?r(t,e,!0):o(t,e),[t,e]};s.transform=function(){return d.apply(null,arguments)},s.Insert=function(t,e){return new s({type:p,pos:t,str:e})},s.Delete=function(t,e){return new s({type:f,pos:t,str:e})},s.INSERT=p,s.DELETE=f,e.exports=s},{"../basics/helpers":175,"../basics/oo":177,"./conflict":238,"./operation":241}],243:[function(t,e,i){function s(){o.call(this)}var n=t("../basics/helpers"),r=t("../basics/oo"),o=t("./tool");s.Prototype=function(){this.disabledModes=[],this.splitContainerSelections=!1,this.getAnnotationType=function(){if(this.constructor["static"].name)return this.constructor["static"].name;throw new Error("Contract: AnnotationTool.static.name should be associated to a document annotation type.")},this.afterCreate=function(){},this.afterFusion=function(){},this.afterRemove=function(){},this.afterTruncate=function(){},this.afterExpand=function(){},this.canCreate=function(t,e){return 0===t.length&&!e.isCollapsed()},this.canFusion=function(t){return t.length>=2},this.canRemove=function(t,e){if(1!==t.length)return!1;var i=t[0].getSelection();return e.isInsideOf(i)},this.canExpand=function(t,e){if(1!==t.length)return!1;var i=t[0].getSelection();return e.overlaps(i)&&!e.isInsideOf(i)},this.canTruncate=function(t,e){if(1!==t.length)return!1;var i=t[0].getSelection();return(e.isLeftAlignedWith(i)||e.isRightAlignedWith(i))&&!e.equals(i)},this.update=function(t,e){if(this.surface=t,this.needsEnabledSurface&&!t.isEnabled()||e.isNull())return this.setDisabled();var i,s=this.getDocument(),r=this.getAnnotationType(),o=this.isContainerAnno();if(o)i=s.getContainerAnnotationsForSelection(e,this.getContainer(),{type:r});else{if(!e.isPropertySelection()&&!this.splitContainerSelections)return this.setDisabled();i=s.getAnnotationsForSelection(e,{type:r})}var a={surface:t,disabled:!1,active:!1,mode:null,sel:e,annos:i};return this.canCreate(i,e)?a.mode="create":this.canFusion(i,e)?a.mode="fusion":this.canTruncate(i,e)?(a.active=!0,a.mode="truncate"):this.canRemove(i,e)?(a.active=!0,a.mode="remove"):this.canExpand(i,e)&&(a.mode="expand"),!a.mode||n.includes(this.disabledModes,a.mode)?this.setDisabled():void this.setToolState(a)},this.performAction=function(){var t=this.getToolState();if(t.sel&&t.mode&&!t.sel.isNull())switch(t.mode){case"create":return this.handleCreate(t);case"fusion":return this.handleFusion(t);case"remove":return this.handleRemove(t);case"truncate":return this.handleTruncate(t);case"expand":return this.handleExpand(t)}},this.handleCreate=function(t){var e=t.sel;e.isNull()||this.surface.transaction({selection:e},function(t,i){return this.createAnnotationForSelection(t,e),i},this)},this.getAnnotationData=function(){return{}},this.isContainerAnno=function(){var t=this.getDocument(),e=t.getSchema();return e.isInstanceOf(this.getAnnotationType(),"container_annotation")},this._createPropertyAnnotations=function(t,e){var i,s=this.getAnnotationType();e.isPropertySelection()?i=[]:e.isContainerSelection()&&(i=e.splitIntoPropertySelections());for(var r=0;r<i.length;r++){var o={id:n.uuid(s),type:s};n.extend(o,this.getAnnotationData()),o.path=i[r].getPath(),o.startOffset=i[r].getStartOffset(),o.endOffset=i[r].getEndOffset(),t.create(o)}},this.createAnnotationForSelection=function(t,e){if(this.splitContainerSelections&&e.isContainerSelection())return this._createPropertyAnnotations(t,e);var i=this.getAnnotationType(),s={id:n.uuid(i),type:i};if(n.extend(s,this.getAnnotationData()),this.isContainerAnno())s.startPath=e.start.path,s.endPath=e.end.path,s.container="content";else{if(!e.isPropertySelection())throw new Error("Illegal state: can not apply ContainerSelection");s.path=e.getPath()}return s.startOffset=e.getStartOffset(),s.endOffset=e.getEndOffset(),t.create(s)},this.handleFusion=function(t){var e=t.sel;this.surface.transaction({selection:e},function(i,s){return n.each(t.annos,function(t){e=e.expand(t.getSelection())}),n.each(t.annos,function(t){i["delete"](t.id)}),this.createAnnotationForSelection(i,e),this.afterFusion(),s},this)},this.handleRemove=function(t){var e=t.sel;this.surface.transaction({selection:e},function(e,i){var s=t.annos[0].id;return e["delete"](s),this.afterRemove(),i},this)},this.handleTruncate=function(t){var e=t.sel;this.surface.transaction({selection:e},function(i,s){var n=t.annos[0],r=n.getSelection(),o=r.truncate(e);return n.updateRange(i,o),this.afterTruncate(),s},this)},this.handleExpand=function(t){var e=t.sel;this.surface.transaction({selection:e},function(i,s){var n=t.annos[0],r=n.getSelection(),o=r.expand(e);return n.updateRange(i,o),this.afterExpand(),s},this)}},r.inherit(s,o),e.exports=s},{"../basics/helpers":175,"../basics/oo":177,"./tool":256}],244:[function(t,e,i){"use strict";var s=t("./node_view"),n=s.extend({name:"annotation",tagName:"span",getClassNames:function(){var t=this.node.getClassNames();return this.props.classNames&&(t+=" "+this.props.classNames.join(" ")),t.replace(/_/g,"-")}});e.exports=n},{"./node_view":249}],245:[function(t,e,i){"use strict";var s=t("../basics/helpers"),n=t("../basics/oo"),r=function(t,e,i){this.surfaceManager=t,this.htmlImporter=e,this.htmlExporter=i,this._contentDoc=null,this._contentText="",this._onKeyDown=s.bind(this.onKeyDown,this),this._onCopy=s.bind(this.onCopy,this),this._onCut=s.bind(this.onCut,this),this.isIe=-1!=window.navigator.userAgent.toLowerCase().indexOf("msie")||-1!=window.navigator.userAgent.toLowerCase().indexOf("trident"),this.isFF=window.navigator.userAgent.toLowerCase().indexOf("firefox")>-1,this.isIe?(this._beforePasteShim=s.bind(this.beforePasteShim,this),this._pasteShim=s.bind(this.pasteShim,this)):this._onPaste=s.bind(this.onPaste,this)};r.Prototype=function(){this.getSurface=function(){return this.surfaceManager.getFocussedSurface()},this.attach=function(t){this.el=window.document.createElement("div"),this.$el=$(this.el),this.$el.prop("contentEditable","true").addClass("clipboard"),t.appendChild(this.el),t.addEventListener("keydown",this._onKeyDown,!1),t.addEventListener("copy",this._onCopy,!1),t.addEventListener("cut",this._onCut,!1),this.isIe?(t.addEventListener("beforepaste",this._beforePasteShim,!1),t.addEventListener("paste",this._pasteShim,!1)):t.addEventListener("paste",this._onPaste,!1)},this.detach=function(t){this.$el.remove(),t.removeEventListener("keydown",this._onKeyDown,!1),t.removeEventListener("copy",this._onCopy,!1),t.removeEventListener("cut",this._onCut,!1),this.isIe?(t.removeEventListener("beforepaste",this._beforePasteShim,!1),t.removeEventListener("paste",this._pasteShim,!1)):t.removeEventListener("paste",this._onPaste,!1)},this.onCopy=function(t){if(console.log("Clipboard.onCopy",arguments),this._copySelection(),t.clipboardData&&this._contentDoc){var e=this.htmlExporter.convert(this._contentDoc);console.log("Stored HTML in clipboard",e),this._contentDoc.__id__=s.uuid();var i=this._contentDoc.toJSON();i.__id__=this._contentDoc.__id__,t.clipboardData.setData("application/substance",JSON.stringify(i)),t.clipboardData.setData("text/plain",$(e).text()),t.clipboardData.setData("text/html",e),t.preventDefault()}},this.onCut=function(t){t.preventDefault(),console.log("Clipboard.onCut",arguments),this.onCopy(t);var e=this.getSurface();if(e){var i=e.getEditor();e.transaction(function(t,e){return i["delete"](t,e)})}},this.pasteSubstanceData=function(t){var e=this.getSurface();if(e){var i=e.getEditor(),s=e.getDocument(),n=s.newInstance();n._setForClipboard(!0),n.loadSeed(JSON.parse(t));var r="",o=n.get("content");if(o.nodes.length>0){var a=o.getFirstComponent(),l=o.getLastComponent(),c=n.get(l.path).length,u=s.createSelection({type:"container",containerId:"content",startPath:a.path,startOffset:0,endPath:l.path,endOffset:c});r=n.getTextForSelection(u)}e.transaction(function(t,e){return e.text=r,e.doc=n,i.paste(t,e)})}},this.pasteHtml=function(t){var e=this.getSurface();if(e){var i=e.getEditor(),s=e.getLogger(),n=e.getDocument();try{var r=n.newInstance();r._setForClipboard(!0),r.get("content")||r.create({id:"content",type:"container",nodes:[]}),this.htmlImporter.convert($(t),r),e.transaction(function(e,s){return s.text=t.body.textContent,s.doc=r,i.paste(e,s)})}catch(o){console.error(o),s.error(o)}}},this.onPaste=function(t){var e=t.clipboardData,i=this.getSurface();if(i){for(var n=i.getEditor(),r=(i.getLogger(),{}),o=0;o<e.types.length;o++)r[e.types[o]]=!0;if(this.isFF&&!r["application/substance"]&&!r["text/html"])return this.beforePasteShim(),i.rerenderSelection(),void this.pasteShim();if(t.preventDefault(),t.stopPropagation(),console.log("Available types",r),r["application/substance"])return this.pasteSubstanceData(e.getData("application/substance"));if(r["text/html"]){var a=e.getData("text/html"),l=(new window.DOMParser).parseFromString(a,"text/html");if(this.htmlImporter.checkQuality($(l)))return this.pasteHtml(l)}var c=e.getData("text/plain");if(i.getEditor().isContainerEditor()){var u=i.getDocument(),h=u.getSchema().getDefaultTextType();i.transaction(function(t,e){var i=c.split(/\s*\n\s*\n/),r=u.newInstance();r._setForClipboard(!0);for(var o=r.create({type:"container",id:"content",nodes:[]}),a=0;a<i.length;a++){var l=r.create({id:s.uuid(h),type:h,content:i[a]});o.show(l.id)}return e.doc=r,n.paste(t,e)})}else i.transaction(function(t,e){return e.text=c.split("").join(""),n.insertText(t,e)})}},this.beforePasteShim=function(){var t=this.getSurface();if(t){console.log("Paste before..."),this.$el.focus();var e=document.createRange();e.selectNodeContents(this.el);var i=window.getSelection();i.removeAllRanges(),i.addRange(e)}},this.pasteShim=function(){this.$el.empty();var t=this,e=this.getSurface();if(e){var i=e.getSelection();setTimeout(function(){e.selection=i;var s=t.$el.html();s=["<html><head></head><body>",s,"</body></html>"].join(""),t.$el.empty();var n=(new window.DOMParser).parseFromString(s,"text/html");return t.pasteHtml(n)},0)}},this.onKeyDown=function(t){88===t.keyCode&&(t.metaKey||t.ctrlKey)||(86===t.keyCode&&(t.metaKey||t.ctrlKey)?this.handlePaste():67===t.keyCode&&(t.metaKey||t.ctrlKey))},this.handleCut=function(){console.log("Cutting into Clipboard...");var t=window.getSelection(),e=t.getRangeAt(0),i=e.cloneContents();this.el.innerHTML="",this.el.appendChild(i),this._copySelection();var s=this.getSurface();if(s){try{console.log("...selection before deletion",s.getSelection().toString()),s.getEditor()["delete"]()}catch(n){return console.error(n),void this.logger.error(n)}var r=window.document.createRange();r.selectNodeContents(this.el),t.removeAllRanges(),t.addRange(r),window.setTimeout(function(){s.rerenderDomSelection()},10)}},this.handlePaste=function(){},this.handleCopy=function(){},this._copySelection=function(){var t=window.getSelection();this._contentText="",this._contentDoc=null;var e=this.getSurface(),i=e.getSelection(),s=e.getEditor(),n=e.getDocument();if(t.rangeCount>0&&!i.isCollapsed()){var r=t.getRangeAt(0);this._contentText=r.toString(),this._contentDoc=s.copy(n,i),console.log("Clipboard._copySelection(): created a copy",this._contentDoc)}else this._contentDoc=null,this._contentText=""}},n.initClass(r),e.exports=r},{"../basics/helpers":175,"../basics/oo":177}],246:[function(t,e,i){"use strict";function s(t){o.call(this),this.containerId=t}var n=(t("../basics/helpers"),t("../basics/oo")),r=t("../document"),o=t("./form_editor"),a=(r.AnnotationUpdates,r.Transformations);s.Prototype=function(){this.isContainerEditor=function(){return!0},this.getContainerId=function(){return this.containerId},this["delete"]=function(t,e){return e.containerId=this.containerId,a.deleteSelection(t,e)},this["break"]=function(t,e){return e.containerId=this.containerId,e.selection.isPropertySelection()||e.selection.isContainerSelection()?a.breakNode(t,e):void 0},this.insertNode=function(t,e){return e.containerId=this.containerId,e.selection.isPropertySelection()||e.selection.isContainerSelection()?a.insertNode(t,e):void 0},this.switchType=function(t,e){return e.containerId=this.containerId,e.selection.isPropertySelection()?a.switchTextType(t,e):void 0},this.selectAll=function(t){var e=t.get(this.containerId),i=e.getFirstComponent(),s=e.getLastComponent(),n=t.get(s.path);return t.createSelection({type:"container",containerId:this.containerId,startPath:i.path,startOffset:0,endPath:s.path,endOffset:n.length})},this.paste=function(t,e){return e.containerId=this.containerId,e.selection.isPropertySelection()||e.selection.isContainerSelection()?a.paste(t,e):void 0}},n.inherit(s,o),e.exports=s},{"../basics/helpers":175,"../basics/oo":177,"../document":204,"./form_editor":247}],247:[function(t,e,i){"use strict";function s(){}var n=t("../basics"),r=t("../document"),o=(r.Selection,r.AnnotationUpdates,r.Transformations);s.Prototype=function(){this.isContainerEditor=function(){return!1},this.selectAll=function(t,e){var i=e;if(!i.isNull()&&i.isPropertySelection()){var s=i.start.path,n=t.get(s);return t.createSelection({type:"property",path:s,startOffset:0,endOffset:n.length})}},this.insertText=function(t,e){return e.selection.isPropertySelection()||e.selection.isContainerSelection()?o.insertText(t,e):void 0},this["delete"]=function(t,e){return o.deleteSelection(t,e)},this["break"]=function(t,e){return this.softBreak(t,e)},this.softBreak=function(t,e){return e.text="\n",this.insertText(t,e)},this.copy=function(t,e){var i=o.copySelection(t,{selection:e});return i.doc},this.paste=function(t,e){return e.text?this.insertText(t,e):void 0}},n.initClass(s),e.exports=s},{"../basics":176,"../document":204}],248:[function(t,e,i){var s=t("./surface");s.SurfaceManager=t("./surface_manager"),s.SurfaceSelection=t("./surface_selection"),s.FormEditor=t("./form_editor"),s.ContainerEditor=t("./container_editor"),s.Clipboard=t("./clipboard"),s.NodeView=t("./node_view"),s.AnnotationView=t("./annotation_view"),s.TextProperty=t("./text_property"),s.Tool=t("./tool"),s.AnnotationTool=t("./annotation_tool"),s.SwitchTypeTool=t("./switch_type_tool"),s.ToolRegistry=t("./tool_registry"),s.Panel=t("./panel"),s.Tools=t("./tools"),e.exports=s},{"./annotation_tool":243,"./annotation_view":244,"./clipboard":245,"./container_editor":246,"./form_editor":247,"./node_view":249,"./panel":250,"./surface":251,"./surface_manager":252,"./surface_selection":253,"./switch_type_tool":254,"./text_property":255,"./tool":256,"./tool_registry":257,"./tools":261}],249:[function(t,e,i){"use strict";function s(t){this.props=t,this.doc=t.doc,this.node=t.node}var n=t("../basics");s.Prototype=function(){this.tagName="div",this.createElement=function(){var t=document.createElement(this.getTagName()),e=this.getClassNames();return $(t).addClass(e),t.dataset.id=this.node.id,t},this.getTagName=function(){return this.node.constructor["static"].tagName||this.tagName},this.getClassNames=function(){return[]},this.render=function(){var t=this.createElement(),e=this.props.children;if(e)for(var i=0;i<e.length;i++){var r=e[i];if(n.isString(r))t.appendChild(document.createTextNode(r));else if(r instanceof s){var o=r.render();t.appendChild(o)}else r instanceof window.Node&&t.appendChild(r)}return t}},n.initClass(s),e.exports=s},{"../basics":176}],250:[function(t,e,i){"use strict";function s(){}var n=t("../basics");s.Prototype=function(){this.getPanelOffsetForElement=function(t){var e=$(t).position().top;return e},this.scrollToNode=function(t){var e=this.getScrollableContainer(),i=$(e).find("*[data-id="+t+"]")[0];i?$(e).scrollTop(this.getPanelOffsetForElement(i)):console.warn(t,"not found in scrollable container")}},n.initClass(s),e.exports=s},{"../basics":176}],251:[function(t,e,i){"use strict";function s(t,e,i,r){o.EventEmitter.call(this),r=r||{},this.__id__=u++,this.name=r.name||u,this.doc=e,this.surfaceManager=t,this.selection=l.nullSelection,this.element=null,this.$element=null,this.editor=i,this.surfaceSelection=null,this.logger=r.logger||window.console,this.$=$,this.$window=this.$(window),this.$document=this.$(window.document),this.dragging=!1,this._onMouseUp=n.bind(this.onMouseUp,this),this._onMouseDown=n.bind(this.onMouseDown,this),this._onMouseMove=n.bind(this.onMouseMove,this),this._onKeyDown=n.bind(this.onKeyDown,this),this._onTextInput=n.bind(this.onTextInput,this),this._onTextInputShim=n.bind(this.onTextInputShim,this),this._onCompositionStart=n.bind(this.onCompositionStart,this),this._onDomMutations=n.bind(this.onDomMutations,this),this.domObserver=new window.MutationObserver(this._onDomMutations),this.domObserverConfig={subtree:!0,characterData:!0},this.skipNextObservation=!1,this.enabled=!0,this.frozen=!1,this.$caret=$("<span>").addClass("surface-caret"),this.isIE=s.detectIE(),this.isFF=window.navigator.userAgent.toLowerCase().indexOf("firefox")>-1,this.undoEnabled=!0,null!=r.undoEnabled&&(this.undoEnabled=r.undoEnabled),null!=r.contentEditable?this.enableContentEditable=r.contentEditable:this.enableContentEditable=!0,this.surfaceManager.registerSurface(this)}var n=t("../basics/helpers"),r=t("../basics/oo"),o=t("../basics"),a=t("./surface_selection"),l=t("../document"),c=l.Selection,u=0;s.Prototype=function(){this.getName=function(){return this.name},this.getElement=function(){return this.element},this.getContainerName=function(){return this.editor.isContainerEditor()?this.editor.getContainerId():void 0},this.getContainer=function(){return this.editor.isContainerEditor()?this.doc.get(this.editor.getContainerId()):void 0},this.getEditor=function(){return this.editor},this.getDocument=function(){return this.doc},this.dispose=function(){this.setSelection(null),this.detach(),this.surfaceManager.unregisterSurface(this)},this.attach=function(t){if(!t)throw new Error("Illegal argument: Surface element is required. was "+t);var e=this.getDocument();this.element=t,this.$element=$(t),this.surfaceSelection=new a(t,e,this.getContainer()),this.$element.addClass("surface"),this.attachKeyboard(),this.$element.on("mousedown",this._onMouseDown),this.domObserver.observe(t,this.domObserverConfig),this.attached=!0},this.attachKeyboard=function(){this.$element.on("keydown",this._onKeyDown),this.element.addEventListener&&this.element.addEventListener("compositionstart",this._onCompositionStart,!1),window.TextEvent&&!this.isIE?this.element.addEventListener("textInput",this._onTextInput,!1):this.$element.on("keypress",this._onTextInputShim)},this.detach=function(){var t=this.getDocument();this.domObserver.disconnect(),t.disconnect(this),this.$element.off("mousedown",this._onMouseDown),this.detachKeyboard(),this.$element.removeClass("surface"),this.element=null,this.$element=null,this.surfaceSelection=null,this.attached=!1},this.detachKeyboard=function(){this.$element.off("keydown",this._onKeyDown),this.element.addEventListener&&this.element.removeEventListener("compositionstart",this._onCompositionStart,!1),window.TextEvent&&!this.isIE?this.element.removeEventListener("textInput",this._onTextInput,!1):this.$element.off("keypress",this._onTextInputShim)},this.isAttached=function(){return this.attached},this.enable=function(){this.enableContentEditable&&this.$element.prop("contentEditable","true"),this.enabled=!0},this.isEnabled=function(){return this.enabled},this.disable=function(){this.enableContentEditable&&this.$element.removeAttr("contentEditable"),this.enabled=!1},this.freeze=function(){console.log("Freezing surface..."),this.enableContentEditable&&this.$element.removeAttr("contentEditable"),this.$element.addClass("frozen"),this.domObserver.disconnect(),this.frozen=!0},this.unfreeze=function(){this.frozen&&(console.log("Unfreezing surface..."),this.enableContentEditable&&this.$element.prop("contentEditable","true"),this.$element.removeClass("frozen"),this.domObserver.observe(this.element,this.domObserverConfig),this.frozen=!1)},this.onKeyDown=function(t){if(!this.frozen&&229!==t.which){switch(t.keyCode){case s.Keys.LEFT:case s.Keys.RIGHT:return this.handleLeftOrRightArrowKey(t);case s.Keys.UP:case s.Keys.DOWN:return this.handleUpOrDownArrowKey(t);case s.Keys.ENTER:return this.handleEnterKey(t);case s.Keys.SPACE:return this.handleSpaceKey(t);case s.Keys.BACKSPACE:case s.Keys.DELETE:return this.handleDeleteKey(t)}var e=!1;if((t.ctrlKey||t.metaKey)&&65===t.keyCode){var i=this.editor.selectAll(this.getDocument(),this.getSelection());this.setSelection(i),this.surfaceSelection.setSelection(i),this.emit("selection:changed",i,this),e=!0}else this.undoEnabled&&90===t.keyCode&&(t.metaKey||t.ctrlKey)&&(t.shiftKey?this.redo():this.undo(),e=!0);e&&(t.preventDefault(),t.stopPropagation())}},this.undo=function(){console.log("UNDO!");var t=this.getDocument();t.done.length>0&&t.undo()},this.redo=function(){var t=this.getDocument();t.undone.length>0&&t.redo()},this.transaction=function(t,e){var i={surfaceId:this.getName(),selection:this.getSelection()};if(!n.isFunction(arguments[0])&&arguments.length>=2){var s=arguments[0];i=n.extend(i,s),t=arguments[1],e=arguments[2]}var r;this.getDocument().transaction(i,function(s){var n=t.call(e,s,{selection:i.selection});return r=n||{},r.selection||(r.selection=i.selection),r.surfaceId=i.surfaceId,r}),this.setSelection(r.selection)},this.onTextInput=function(t){this.frozen||t.data&&(t.preventDefault(),t.stopPropagation(),this.skipNextObservation=!0,this.transaction(function(e,i){return this.editor.insertText(e,{selection:i.selection,text:t.data})},this),this.rerenderDomSelection())},this.onCompositionStart=function(){this.skipNextObservation=!0},this.onTextInputShim=function(t){if(!this.frozen&&!(0===t.which||0===t.charCode||t.keyCode===s.Keys.TAB||t.keyCode===s.Keys.ESCAPE||t.metaKey||!!t.ctrlKey^!!t.altKey)){var e=String.fromCharCode(t.which);return this.skipNextObservation=!0,t.shiftKey||(e=e.toLowerCase()),e.length>0?(this.transaction(function(t,i){return this.editor.insertText(t,{selection:i.selection,text:e})},this),this.rerenderDomSelection(),t.preventDefault(),void t.stopPropagation()):(t.preventDefault(),void t.stopPropagation())}},this.handleLeftOrRightArrowKey=function(t){var e=this;window.setTimeout(function(){var i={direction:t.keyCode===s.Keys.LEFT?"left":"right"};e._updateModelSelection(i)})},this.handleUpOrDownArrowKey=function(t){var e=this;window.setTimeout(function(){var i={direction:t.keyCode===s.Keys.UP?"left":"right"};e._updateModelSelection(i)})},this.handleSpaceKey=function(t){t.preventDefault(),t.stopPropagation(),this.transaction(function(t,e){return this.editor.insertText(t,{selection:e.selection,text:" "})},this),this.rerenderDomSelection()},this.handleEnterKey=function(t){t.preventDefault(),t.shiftKey?this.transaction(function(t,e){return this.editor.softBreak(t,e)},this):this.transaction(function(t,e){return this.editor["break"](t,e)},this),this.rerenderDomSelection()},this.handleDeleteKey=function(t){t.preventDefault();var e=t.keyCode===s.Keys.BACKSPACE?"left":"right";this.transaction(function(t,i){return this.editor["delete"](t,{selection:i.selection,direction:e})},this),this.rerenderDomSelection()},this.onMouseDown=function(t){this.frozen&&this.unfreeze(),1===t.which&&(this.dragging=!0,this.$document.one("mouseup",this._onMouseUp))},this.onMouseUp=function(){this.dragging=!1,this.setFocused(!0);var t=this;setTimeout(function(){if(t.surfaceSelection){var e=t.surfaceSelection.getSelection();t.setSelection(e)}})},this.setFocused=function(t){this.isFocused=t,this.isFocused&&this.surfaceManager.didFocus(this)},this.onMouseMove=function(){this.dragging},this.onDomMutations=function(){return this.skipNextObservation?void(this.skipNextObservation=!1):void console.info("We want to enable a DOM MutationObserver which catches all changes made by native interfaces (such as spell corrections, etc). Lookout for this message and try to set Surface.skipNextObservation=true when you know that you will mutate the DOM.")},this.getSelection=function(){return this.selection},this.setSelection=function(t){t?!n.isObject(t)||t instanceof c||(t=this.getDocument().createSelection(t)):t=c.nullSelection,this._setModelSelection(t)&&this.rerenderDomSelection()},this.rerenderDomSelection=function(){if(this.surfaceSelection){var t=this.surfaceSelection,e=this.getSelection();setTimeout(function(){t.setSelection(e)})}},this.getDomNodeForId=function(t){return this.element.querySelector("*[data-id="+t+"]")},this._updateModelSelection=function(t){this._setModelSelection(this.surfaceSelection.getSelection(t))},this._setModelSelection=function(t){return t=t||o.Document.nullSelection,this.selection=t,this.emit("selection:changed",t,this),!0},this.getLogger=function(){return this.logger},this.placeCaretElement=function(){var t=this.getSelection();if(t.isNull())throw new Error("Selection is null.");var e=this.$caret;e.empty().remove();var i=this.surfaceSelection._findDomPosition(t.start.path,t.start.offset);if(i.node.nodeType===window.Node.TEXT_NODE){var s=i.node;if(s.length===i.offset)e.insertAfter(s);else{var n=window.getSelection(),r=window.document.createRange(),o=s.textContent,a=window.document.createDocumentFragment(),l=window.document.createTextNode(o.substring(0,i.offset));a.appendChild(l),a.appendChild(e[0]),a.appendChild(document.createTextNode(o.substring(i.offset))),$(s).replaceWith(a),r.setStart(l,i.offset),n.removeAllRanges(),n.addRange(r)}}else i.node.appendChild(e[0]);return e},this.removeCaretElement=function(){this.$caret.remove()},this.updateCaretElement=function(){this.$caret.remove(),this.placeCaretElement()}},r.inherit(s,o.EventEmitter),s.Keys={UNDEFINED:0,BACKSPACE:8,DELETE:46,LEFT:37,RIGHT:39,UP:38,DOWN:40,ENTER:13,END:35,HOME:36,TAB:9,PAGEUP:33,PAGEDOWN:34,ESCAPE:27,SHIFT:16,SPACE:32},s.detectIE=function(){var t=window.navigator.userAgent,e=t.indexOf("MSIE ");if(e>0)return parseInt(t.substring(e+5,t.indexOf(".",e)),10);var i=t.indexOf("Trident/");if(i>0){var s=t.indexOf("rv:");return parseInt(t.substring(s+3,t.indexOf(".",s)),10)}var n=t.indexOf("Edge/");return n>0?parseInt(t.substring(n+5,t.indexOf(".",n)),10):!1},e.exports=s},{"../basics":176,"../basics/helpers":175,"../basics/oo":177,"../document":204,"./surface_selection":253}],252:[function(t,e,i){"use strict";var s=t("../basics/oo"),n=(t("../basics/helpers"),t("./surface")),r=function(t){this.doc=t,this.surfaces={},this.focussedSurface=null,this.stack=[],t.connect(this,{"document:changed":this.onDocumentChange},{priority:-1})};r.Prototype=function(){this.dispose=function(){this.doc.disconnect(this),this.surfaces={}},this.createSurface=function(t,e){return new n(this,t,e)},this.registerSurface=function(t){this.surfaces[t.getName()]=t},this.unregisterSurface=function(t){delete this.surfaces[t.getName()],t&&this.focussedSurface===t&&(this.focussedSurface=null)},this.hasSurfaces=function(){return Object.keys(this.surfaces).length>0},this.didFocus=function(t){this.focussedSurface&&t!==this.focussedSurface&&this.focussedSurface.setFocused(!1),this.focussedSurface=t},this.getFocussedSurface=function(){return this.focussedSurface},this.onDocumentChange=function(t,e){if(e.replay){var i=t.after.selection,s=t.after.surfaceId,n=this.surfaces[s];n?(this.focussedSurface!==n&&this.didFocus(n),n.setSelection(i)):console.warn("No surface with name",s)}},this.pushState=function(){var t={surface:this.focussedSurface,selection:null};this.focussedSurface&&(t.selection=this.focussedSurface.getSelection()),this.focussedSurface=null,this.stack.push(t)},this.popState=function(){var t=this.stack.pop();t&&t.surface&&(t.surface.setFocused(!0),t.surface.setSelection(t.selection))}},s.initClass(r),e.exports=r},{"../basics/helpers":175,"../basics/oo":177,"./surface":251}],253:[function(t,e,i){function s(t,e,i){this.element=t,this.doc=e,this.container=i,this.state=new s.State}var n=t("../basics/oo"),r=t("../document"),o=t("../basics/helpers"),a=r.Range,l=r.Coordinate;s.Prototype=function(){function t(t,e){var i=t.compareDocumentPosition(e);return i&window.document.DOCUMENT_POSITION_FOLLOWING?-1:i&window.document.DOCUMENT_POSITION_PRECEDING?1:0}this._pullState=function(e,i,n,r,o,a){if(a=a||{},!n||!e)return void(this.state=null);var l,c;o?(l=this.getModelCoordinate(e,i,a),c=l):(l=this.getModelCoordinate(e,i,a),c=this.getModelCoordinate(n,r,a));var u=!1;if(!o&&n&&e){var h=t(c.el,l.el);u=0>h||0===h&&c.offset<l.offset}if(u){var p=c;c=l,l=p}this.state=new s.State(o,u,l,c)},this.getModelCoordinate=function(t,e,i){for(var n=t,r=null;n;){if(n.dataset&&n.dataset.path){r=n;break}if($(n).is(".content-node")&&0===e){var o=$(n).find("[data-path]");if(o.length)return new s.Coordinate(o[0],0)}n=n.parentNode}if(!r)return this.searchForCoordinate(t,e,i);var a=this._computeCharPosition(r,t,e);return new s.Coordinate(r,a)},this._computeCharPosition=function(t,e,i){function s(t){if(e===t)return r+=i,!0;if(t.nodeType===window.Node.TEXT_NODE)r+=t.textContent.length;else if(t.nodeType===window.Node.ELEMENT_NODE){if($(t).data("external"))return r+=1,!1;for(var n=t.firstChild;n;n=n.nextSibling)if(s(n))return!0}return!1}function n(t){var e=t.nodeType;if(e===window.Node.TEXT_NODE)return t.textContent.length;if(e===window.Node.ELEMENT_NODE){if($(t).data("external"))return 1;for(var i=0,s=t.firstChild;s;s=s.nextSibling)i+=n(s);return i}return 0}var r=0,o=!1;if(e===t){for(var a=t.firstChild,l=0;i>l&&a;l++)r+=n(a),a=a.nextSibling;o=!0}else o=s(t);return o?r:(console.error("Could not find char position."),0)},this.searchForCoordinate=function(e,i,n){var r,o,a,l,c,u=this.element.querySelectorAll("*[data-path]");for(o=0,a=u.length-1,l=t(u[o],e),c=t(u[a],e);;){var h=a-o+1;if(0>c){r=a;break}if(l>0){r=o;break}if(2>=h){r=a;break}var p=o+Math.floor(h/2),f=t(u[p],e);0>f?(o=p,l=f):(a=p,c=f)}var d;return"left"===n.direction?(r=Math.max(0,r-1),d=u[r].textContent.length):d=0>c?u[r].textContent.length:0,new s.Coordinate(u[r],d)},this._getSelection=function(t,e,i,s,n){if(this._pullState(t,e,i,s,n),!this.state)return r.nullSelection;var c,u,h,p,f,d,m,g,b=this.doc,v=this.state.start,y=this.state.end,_=new a(new l(v.path,v.offset),new l(y.path,y.offset));return o.isEqual(v.path,y.path)?b.createSelection({type:"property",path:v.path,startOffset:v.offset,endOffset:y.offset,reverse:this.state.reverse}):(c=b.get(v.path[0]),u=b.get(y.path[0]),h=c.getRoot(),p=u.getRoot(),"table"===h.type&&h.id===p.id?(h.getMatrix(),f=c.rowIdx,d=c.colIdx,m=u.rowIdx,g=u.colIdx,b.createSelection({type:"table",tableId:h.id,startRow:f,startCol:d,endRow:m,endCol:g})):b.createSelection({type:"container",containerId:this.container.id,startPath:_.start.path,startOffset:_.start.offset,endPath:_.end.path,endOffset:_.end.offset,reverse:this.state.reverse}))},this.getSelection=function(){var t=window.getSelection(),e=this._getSelection(t.anchorNode,t.anchorOffset,t.focusNode,t.focusOffset,t.collapsed);return e};var e=function(t,i){if(t.nodeType===document.TEXT_NODE){var s=t.textContent.length;return i>s?{node:null,offset:i-s}:{node:t,offset:i,boundary:s===i}}if(t.nodeType===document.ELEMENT_NODE){if($(t).data("external"))return{node:null,offset:i-1};if(!t.firstChild&&0===i)return{node:t,offset:0};for(var n=t.firstChild;n;n=n.nextSibling){var r=e(n,i);if(r.node)return r;i=r.offset}}return{node:null,offset:i}};this._getDomPosition=function(t,i){var s='*[data-path="'+t.join(".")+'"]',n=this.element.querySelector(s);
if(!n)return console.warn("Could not find DOM element for path",t),null;var r=e(n,i);return r.node?r:null},this.setSelection=function(t){var e=window.getSelection();if(t.isNull()||t.isTableSelection())return this.clear();var i=t.getRange(),n=this._getDomPosition(i.start.path,i.start.offset);if(!n)return this.clear();var r;return(r=i.isCollapsed()?n:this._getDomPosition(i.end.path,i.end.offset))?(e.removeAllRanges(),i=window.document.createRange(),t.isReverse()?(i.setStart(r.node,r.offset),e.addRange(i),e.extend(n.node,n.offset)):(i.setStart(n.node,n.offset),i.setEnd(r.node,r.offset),e.addRange(i)),void(this.state=new s.State(t.isCollapsed(),t.isReverse(),i.start,i.end))):this.clear()},this.clear=function(){var t=window.getSelection();t.removeAllRanges(),this.state=null}},n.initClass(s),s.State=function(t,e,i,s){this.collapsed=t,this.reverse=e,this.start=i,this.end=s,Object.freeze(this)},s.Coordinate=function(t,e){this.el=t,this.offset=e,this.path=t.dataset.path.split(".")},e.exports=s},{"../basics/helpers":175,"../basics/oo":177,"../document":204}],254:[function(t,e,i){function s(){r.call(this)}var n=t("../basics"),r=t("./tool");s.Prototype=function(){this.getNodeType=function(){if(this.constructor["static"].name)return this.constructor["static"].name;throw new Error("Contract: SwitchTypeTool.static.name should be associated to a document annotation type.")},this.getData=function(){return{}},this.matchNode=function(t){return t.type===this.getNodeType()},this.update=function(t,e){if(this.surface=t,!t.isEnabled()||e.isNull()||e.isContainerSelection()||!t.getEditor().isContainerEditor())return this.setDisabled();var i=t.getEditor().getContainer(),s=i.getNodeForComponentPath(e.start.path);return this.matchNode(s)?this.setToolState({enabled:!0,selected:!0}):s.isInstanceOf("text")?this.setToolState({enabled:!0,selected:!0,sel:e,node:s,mode:"switch"}):void 0},this.performAction=function(){var t=this.getToolState();"switch"===t.mode&&this.surface.getEditor().switchType(t.sel,this.getNodeType(),this.getData())}},n.inherit(s,r),e.exports=s},{"../basics":176,"./tool":256}],255:[function(t,e,i){function s(){}var n=t("../basics"),r=t("../document"),o=t("./node_view"),a=t("./annotation_view"),l=r.Annotator;s.Prototype=function(){this.getSurface=function(){throw new Error("This is abstract")},this.getDocument=function(){var t=this.getSurface();return t?t.getDocument():null},this.getPath=function(){throw new Error("This is abstract")},this.getElement=function(){throw new Error("This is abstract")},this.getAnnotations=function(){var t=this.getDocument(),e=this.getPath();return t.getIndex("annotations").get(e)},this.attach=function(){var t=this.getDocument(),e=this.getPath();t.getEventProxy("path").add(e,this,this.propertyDidChange)},this.detach=function(){var t=this.getDocument(),e=this.getPath();t.getEventProxy("path").remove(e,this)},this.renderContent=function(){var t=this.getDocument(),e=this.getElement();if(e){var i=new s.ContentView({doc:t,children:this.renderChildren()}),n=i.render();n.appendChild(document.createElement("br")),e.innerHTML="",e.appendChild(n)}},this.renderChildren=function(){var t=this.getDocument(),e=this.getPath(),i=t.get(e)||"",s=this.getAnnotations(),n=new l;n.onText=function(t,e){t.children.push(e)},n.onEnter=function(e){var i=e.node,s=a,n=[];return{ViewClass:s,props:{doc:t,node:i,classNames:n},children:[]}},n.onExit=function(t,e,i){var s=e.props;s.children=e.children;var n=new e.ViewClass(s);i.children.push(n)};var r={children:[]};return n.start(r,i,s),r.children},this.propertyDidChange=function(t,e){if(e.source===this.getElement()&&(console.log("Skipping update..."),e.surface&&e.typing)){if(!this._debouncedRerender){var i=200,s=this;this._debouncedRerender=n.debounce(function(){var t=this.getDocument();t&&(s.renderContent(),e.surface.rerenderDomSelection())},i)}return void this._debouncedRerender()}this.renderContent(),e.source===this.getElement()&&e.surface&&setTimeout(function(){e.surface.rerenderDomSelection()})}},n.initClass(s),s.ContentView=o.extend({createElement:function(){return document.createDocumentFragment()}}),e.exports=s},{"../basics":176,"../document":204,"./annotation_view":244,"./node_view":249}],256:[function(t,e,i){function s(t){n.EventEmitter.call(this),this.context=t,this.state={disabled:!0,active:!1}}var n=t("../basics");s.Prototype=function(){this.needsEnabledSurface=!0,this.getName=function(){return this.constructor["static"].name},this.getSurface=function(){return this.surface},this.getDocument=function(){var t=this.getSurface();return t?t.getDocument():void 0},this.getContainer=function(){var t=this.getSurface();return t?t.getContainer():void 0},this.setToolState=function(t){var e=this.state;this.state=t,this.emit("toolstate:changed",t,this,e)},this.getToolState=function(){return this.state},this.isEnabled=function(){return!this.state.disabled},this.isDisabled=function(){return this.state.disabled},this.setEnabled=function(){this.setToolState({disabled:!1,active:!1})},this.setDisabled=function(){this.setToolState({disabled:!0,active:!1})},this.disableTool=function(){console.error("DEPRECATED: use tool.setDisabled()"),this.setDisabled()},this.setSelected=function(){this.setToolState({disabled:!1,active:!0})},this.update=function(t,e){return this.surface=t,this.needsEnabledSurface&&!t.isEnabled()?this.setDisabled():void 0},this.updateToolState=function(t,e){return this.update(e,t)}},n.inherit(s,n.EventEmitter),e.exports=s},{"../basics":176}],257:[function(t,e,i){"use strict";var s=t("../basics"),n=(s._,function(){s.Registry.call(this)});n.Prototype=function(){this.dispose=function(){this.each(function(t){t.dispose&&t.dispose()}),this.clear()}},s.inherit(n,s.Registry),e.exports=n},{"../basics":176}],258:[function(t,e,i){"use strict";var s=t("../tool"),n=s.extend({name:"delete_columns",update:function(t,e){return this.surface=t,t.isEnabled()&&!e.isNull()&&e.isTableSelection()?void this.setToolState({surface:t,sel:e,disabled:!1}):this.setDisabled()},performAction:function(t){this.surface.transaction(function(e,i){return console.log("TODO: delete columns",t),i})}});e.exports=n},{"../tool":256}],259:[function(t,e,i){"use strict";var s=t("../tool"),n=s.extend({name:"delete_rows",update:function(t,e){return this.surface=t,t.isEnabled()&&!e.isNull()&&e.isTableSelection()?void this.setToolState({surface:t,sel:e,disabled:!1}):this.setDisabled()},performAction:function(t){this.surface.transaction(function(e,i){return console.log("TODO: delete rows",t),i})}});e.exports=n},{"../tool":256}],260:[function(t,e,i){"use strict";var s=t("../annotation_tool"),n=s.extend({name:"emphasis"});e.exports=n},{"../annotation_tool":243}],261:[function(t,e,i){e.exports={Emphasis:t("./emphasis_tool"),Strong:t("./strong_tool"),Link:t("./link_tool"),SwitchTextType:t("./switch_text_type_tool"),InsertRows:t("./insert_rows"),DeleteRows:t("./delete_rows"),InsertColumns:t("./insert_columns"),DeleteColumns:t("./delete_columns")}},{"./delete_columns":258,"./delete_rows":259,"./emphasis_tool":260,"./insert_columns":262,"./insert_rows":263,"./link_tool":264,"./strong_tool":265,"./switch_text_type_tool":266}],262:[function(t,e,i){"use strict";var s=t("../tool"),n=s.extend({name:"insert_columns",update:function(t,e){return this.surface=t,t.isEnabled()&&!e.isNull()&&e.isTableSelection()?void this.setToolState({surface:t,sel:e,disabled:!1}):this.setDisabled()},performAction:function(t){this.surface.transaction(function(e,i){return console.log("TODO: insert columns",t),i})}});e.exports=n},{"../tool":256}],263:[function(t,e,i){"use strict";var s=t("../tool"),n=s.extend({name:"insert_rows",update:function(t,e){return this.surface=t,t.isEnabled()&&!e.isNull()&&e.isTableSelection()?void this.setToolState({surface:t,sel:e,disabled:!1}):this.setDisabled()},performAction:function(t){this.surface.transaction(function(e,i){return console.log("TODO: insert rows",t),i})}});e.exports=n},{"../tool":256}],264:[function(t,e,i){"use strict";var s=t("../annotation_tool"),n=s.extend({name:"link",getAnnotationData:function(){return{url:"http://"}},update:function(t,e){if(this.surface=t,!t.isEnabled()||e.isNull()||e.isContainerSelection())return this.setDisabled();var i=this.getDocument(),s=i.getAnnotationsForSelection(e,{type:"link"}),n=(this.getToolState(),{surface:t,disabled:!1,active:!1,mode:null,sel:e,annos:s});if(this.canCreate(s,e))n.mode="create";else if(this.canTruncate(s,e))n.mode="truncate",n.active=!0;else if(this.canExpand(s,e))n.mode="expand";else{if(1!==s.length)return this.setDisabled();n.mode="edit",n.active=!0,n.showPopup=!0}this.setToolState(n)},performAction:function(){var t=this.getToolState();"edit"===t.mode?this.emit("edit",this):s.prototype.performAction.call(this)}});e.exports=n},{"../annotation_tool":243}],265:[function(t,e,i){"use strict";var s=t("../annotation_tool"),n=s.extend({name:"strong"});e.exports=n},{"../annotation_tool":243}],266:[function(t,e,i){"use strict";var s=t("../tool"),n=["paragraph","heading"],r={paragraph:{label:"Paragraph",data:{type:"paragraph"}},heading1:{label:"Heading 1",data:{type:"heading",level:1}},heading2:{label:"Heading 2",data:{type:"heading",level:2}},heading3:{label:"Heading 3",data:{type:"heading",level:3}}},o=s.extend({name:"text",update:function(t,e){if(this.surface=t,!t.isEnabled()||e.isNull())return this.setDisabled();if(e.isTableSelection())return this.setToolState({disabled:!0,currentContext:"table"});if(e.isContainerSelection())return this.setToolState({disabled:!0,currentContext:"container"});var i=this.getDocument(),s=e.getPath(),n=i.get(s[0]),r=this.getTextType(n),o=n.getRoot(),a=this.getContext(o,s),l={surface:t,sel:e,disabled:!r,currentTextType:r,currentContext:a};this.setToolState(l)},getAvailableTextTypes:function(){return r},isTextType:function(t){return n.indexOf(t)>=0},getTextType:function(t){if(this.isTextType(t.type)){var e=t.type;return"heading"===e&&(e+=t.level),e}},switchTextType:function(t){var e=this.getToolState();if(!this.isDisabled()){var i=r[t],s=e.surface,n=s.getEditor();s.transaction(function(t,e){return e.data=i.data,n.switchType(t,e)})}},getContext:function(t,e){return t.id===e[0]?e[1]:t.type}});e.exports=o},{"../tool":256}],267:[function(t,e,i){"use strict";var s=React.createElement,n=(t("substance"),t("substance/helpers")),r=React.createClass({displayName:"BibliographyComponent",componentWillMount:function(){var t=this.props.doc;this.bibliography=t.getCollection("bib_item"),this.bibliography.connect(this,{"bibliography:updated":this.update})},update:function(){console.log("bibliography:updated");var t=(this.props.doc,this.bibliography.getItems());this.setState({bibItems:t})},getInitialState:function(){return{}},render:function(){var t=(this.props.doc,this.state);if(t.bibItems){var e=[s("div",{className:"content-node heading level-1"},"References")];return n.each(t.bibItems,function(t){t.label&&e.push(s("div",{className:"bib-item clearfix",key:t.id},s("div",{className:"label csl-left-margin"},t.label),s("div",{className:"text csl-right-inline"},t.text)))}),s("div",{className:"bibliography-component bib-items"},e)}return s("div",null,"")}});e.exports=r},{substance:171,"substance/helpers":170}],268:[function(t,e,i){"use strict";var s=t("substance"),n=React.createElement,r=t("./title_editor"),o=t("./bibliography_component"),a=t("./nodes/unsupported_node"),l=s.Surface,c=l.ContainerEditor,u=["strong","emphasis","comment","text"],h=React.createClass({displayName:"ContentEditor",contextTypes:{app:React.PropTypes.object.isRequired,componentRegistry:React.PropTypes.object.isRequired,notifications:React.PropTypes.object.isRequired,surfaceManager:React.PropTypes.object.isRequired},childContextTypes:{surface:React.PropTypes.object},getChildContext:function(){return{surface:this.surface}},getInitialState:function(){var t=this.props.doc,e=this.props.node.id,i=new c(e);i.defaultTextType="paragraph";var s={name:this.props.node.id,logger:this.context.notifications};return this.surface=new l(this.context.surfaceManager,t,i,s),{}},render:function(){var t=this.props.node,e=this.props.doc,i=this.context.componentRegistry,s=[];return s=s.concat(t.nodes.map(function(t){var s=e.get(t),r=i.get(s.type);return r||(console.error("Could not resolve a component for type: "+s.type),r=a),n(r,{key:s.id,doc:e,node:s})})),n("div",{className:"panel-content-inner"},n(r,{doc:e}),n("div",{ref:"documentContent",className:"document-content",contentEditable:!0,"data-id":this.props.node.id},n("div",{className:"container-node "+this.props.node.id,spellCheck:!1,"data-id":this.props.node.id},n("div",{className:"nodes"},s))),n(o,{doc:e}))},componentDidMount:function(){var t=this.surface,e=this.context.app,i=this.props.doc;i.connect(this,{"document:changed":this.onDocumentChange}),e.registerSurface(t,{enabledTools:u}),t.attach(React.findDOMNode(this.refs.documentContent)),i.connect(this,{"container-annotation-update":this.handleContainerAnnotationUpdate});var s=this;this.forceUpdate(function(){s.surface.rerenderDomSelection()})},handleContainerAnnotationUpdate:function(){},componentDidUpdate:function(){var t=this;setTimeout(function(){t.surface.rerenderDomSelection()})},componentWillUnmount:function(){var t=this.context.app,e=this.surface,i=this.props.doc;i.disconnect(this),t.unregisterSurface(e),e.detach()},onDocumentChange:function(t){t.isAffected([this.props.node.id,"nodes"])&&this.forceUpdate()}});e.exports=h},{"./bibliography_component":267,"./nodes/unsupported_node":279,"./title_editor":287,substance:171}],269:[function(t,e,i){"use strict";var s=t("substance-ui/tool_component"),n=t("./tools/cite_tool_component"),r=t("substance-ui/text_tool_component"),o=t("substance-ui/dropdown_component"),a=t("substance-ui/table_tool_component"),l=t("./tools/navigate_tool_component"),c=t("substance-ui/font_awesome_icon"),u=(t("substance/helpers"),React.createElement),h=React.createClass({displayName:"ContentToolbarComponent",handleToggleDialog:function(t){t.preventDefault(),$(".modal").toggleClass("active")},handleDropdownToggle:function(t){t.preventDefault();var e=$(t.currentTarget).parents(".dropdown");e.is(".active")&&e.toggleClass("open")},render:function(){return u("div",{className:"content-tools-component toolbar small fill-white"},u("div",{className:"tool-group text clearfix"},u(r,{tool:"text",title:i18n.t("menu.text_tool")})),u("div",{className:"tool-group document clearfix"},u(s,{tool:"undo",title:i18n.t("menu.undo"),classNames:["button","tool"]},u(c,{icon:"fa-undo"})),u(s,{tool:"redo",title:i18n.t("menu.redo"),classNames:["button","tool"]},u(c,{icon:"fa-repeat"})),u(s,{tool:"export",title:i18n.t("menu.export"),classNames:["button","tool"]},u(c,{icon:"fa-download"}))),u("div",{className:"tool-group actions clearfix"},u(o,{label:u(c,{icon:"fa-image"}),title:i18n.t("figure")},u(s,{tool:"insert_figure",classNames:["option"]},"Insert"),u(n,{citationType:"image_figure",classNames:["option"]},"Cite"),u(l,{newState:{modal:{contextId:"manageCollection",itemType:"image_figure"}},title:i18n.t("menu.manage")})),u(o,{label:u(c,{icon:"fa-table"}),title:i18n.t("table"),classNames:["table-dropdown"]},u(s,{tool:"insert_table",classNames:["option"]},"Insert"),u(n,{citationType:"table_figure",classNames:["option"]},"Cite"),u(l,{newState:{modal:{contextId:"manageCollection",itemType:"table_figure"}},title:i18n.t("menu.manage")}),u("hr"),u(a,{tool:"insert_columns",classNames:["option"],mode:"before"}),u(a,{tool:"delete_columns",classNames:["option"]}),u(a,{tool:"insert_columns",classNames:["option"],mode:"after"}),u("hr"),u(a,{tool:"insert_rows",classNames:["option"],mode:"above"}),u(a,{tool:"delete_rows",classNames:["option"]}),u(a,{tool:"insert_rows",classNames:["option"],mode:"below"})),u(o,{label:u(c,{icon:"fa-book"}),title:i18n.t("bibitem")},u(n,{citationType:"bib_item",classNames:["option"]},"Cite"),u(l,{newState:{modal:{contextId:"manageBibItems"}},title:i18n.t("menu.manage")}))),u("div",{className:"tool-group formatting clearfix float-right"},u(s,{tool:"emphasis",title:i18n.t("menu.emphasis"),classNames:["button","tool"]},u(c,{icon:"fa-italic"})),u(s,{tool:"strong",title:i18n.t("menu.strong"),classNames:["button","tool"]},u(c,{icon:"fa-bold"}))))}});e.exports=h},{"./tools/cite_tool_component":288,"./tools/navigate_tool_component":289,"substance-ui/dropdown_component":151,"substance-ui/font_awesome_icon":153,"substance-ui/table_tool_component":157,"substance-ui/text_tool_component":159,"substance-ui/tool_component":161,"substance/helpers":170}],270:[function(t,e,i){"use strict";var s=t("substance/helpers"),n=t("./nodes"),r=t("./panels");e.exports=s.extend({content_toolbar:t("./content_toolbar"),content_editor:t("./content_editor")},n,r)},{"./content_editor":268,"./content_toolbar":269,"./nodes":276,"./panels":284,"substance/helpers":170}],271:[function(t,e,i){"use strict";function s(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var r=function(){function t(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}return function(e,i,s){return i&&t(e.prototype,i),s&&t(e,s),e}}(),o=function(t,e,i){for(var s=!0;s;){var n=t,r=e,o=i;a=c=l=void 0,s=!1,null===n&&(n=Function.prototype);var a=Object.getOwnPropertyDescriptor(n,r);if(void 0!==a){if("value"in a)return a.value;var l=a.get;return void 0===l?void 0:l.call(o)}var c=Object.getPrototypeOf(n);if(null===c)return void 0;t=c,e=r,i=o,s=!0}},a=React.createElement,l=function(t){function e(t){s(this,e),o(Object.getPrototypeOf(e.prototype),"constructor",this).call(this,t),this.onMouseDown=this.onMouseDown.bind(this),this.onClick=this.onClick.bind(this)}return n(e,t),r(e,[{key:"componentDidMount",value:function(){this.props.node.connect(this,{"label:changed":this.onLabelChanged})}},{key:"componentWillUnmount",value:function(){this.props.node.disconnect(this)}},{key:"render",value:function(){return a("span",{className:this.getClassName(),"data-id":this.props.node.id,"data-external":1,contentEditable:!1,onClick:this.onClick,onMouseDown:this.onMouseDown},this.props.node.label||"")}},{key:"onMouseDown",value:function(t){t.preventDefault();var e=this.props.node,i=this.context.surface;i.setSelection(e.getSelection()),i.rerenderDomSelection()}},{key:"onClick",value:function(t){t.preventDefault(),t.stopPropagation()}},{key:"onLabelChanged",value:function(){this.forceUpdate()}},{key:"getClassName",value:function(){var t=this.props.node.getClassNames();return this.props.classNames&&(t+=" "+this.props.classNames.join(" ")),t.replace(/_/g,"-")}}]),e}(React.Component);l.displayName="CitationComponent",l.contextTypes={surface:React.PropTypes.object.isRequired,app:React.PropTypes.object.isRequired},e.exports=l},{}],272:[function(t,e,i){"use strict";function s(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var r=function(){function t(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}return function(e,i,s){return i&&t(e.prototype,i),s&&t(e,s),e}}(),o=function(t,e,i){for(var s=!0;s;){var n=t,r=e,o=i;a=c=l=void 0,s=!1,null===n&&(n=Function.prototype);var a=Object.getOwnPropertyDescriptor(n,r);if(void 0!==a){if("value"in a)return a.value;var l=a.get;return void 0===l?void 0:l.call(o)}var c=Object.getPrototypeOf(n);if(null===c)return void 0;t=c,e=r,i=o,s=!0}},a=t("substance-ui/text_property"),l=React.createElement,c=function(t){function e(){s(this,e),o(Object.getPrototypeOf(e.prototype),"constructor",this).apply(this,arguments)}return n(e,t),r(e,[{key:"render",value:function(){var t=this.context.componentRegistry,e=this.props.node.getContentNode(),i=t.get(e.type),s=this.props.node.type;return l("div",{className:"content-node figure clearfix "+s,"data-id":this.props.node.id},l("div",{className:"label",contentEditable:!1},this.props.node.label),l(a,{tagName:"div",className:"title",doc:this.props.doc,path:[this.props.node.id,"title"]}),l("div",{className:"figure-content"},l(i,{doc:this.props.doc,node:e})),l("div",{className:"description small"},l(a,{tagName:"div",className:"caption",ref:"textProp",doc:this.props.doc,path:[this.props.node.id,"caption"]})))}}]),e}(React.Component);c.displayName="FigureComponent",c.contextTypes={componentRegistry:React.PropTypes.object.isRequired},e.exports=c},{"substance-ui/text_property":158}],273:[function(t,e,i){"use strict";function s(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var r=function(){function t(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}return function(e,i,s){return i&&t(e.prototype,i),s&&t(e,s),e}}(),o=function(t,e,i){for(var s=!0;s;){var n=t,r=e,o=i;a=c=l=void 0,s=!1,null===n&&(n=Function.prototype);var a=Object.getOwnPropertyDescriptor(n,r);if(void 0!==a){if("value"in a)return a.value;var l=a.get;return void 0===l?void 0:l.call(o)}var c=Object.getPrototypeOf(n);if(null===c)return void 0;t=c,e=r,i=o,s=!0}},a=t("substance-ui/text_property"),l=React.createElement,c=function(t){function e(){s(this,e),o(Object.getPrototypeOf(e.prototype),"constructor",this).apply(this,arguments)}return n(e,t),r(e,[{key:"render",value:function(){var t=this.props.node.level;return l("div",{className:"content-node heading level-"+t,"data-id":this.props.node.id},l(a,{ref:"textProp",doc:this.props.doc,path:[this.props.node.id,"content"]}))}}]),e}(React.Component);c.displayName="HeadingComponent",e.exports=c},{"substance-ui/text_property":158}],274:[function(t,e,i){"use strict";function s(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var r=function(){function t(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}return function(e,i,s){return i&&t(e.prototype,i),s&&t(e,s),e}}(),o=function(t,e,i){for(var s=!0;s;){var n=t,r=e,o=i;a=c=l=void 0,s=!1,null===n&&(n=Function.prototype);var a=Object.getOwnPropertyDescriptor(n,r);if(void 0!==a){if("value"in a)return a.value;var l=a.get;return void 0===l?void 0:l.call(o)}var c=Object.getPrototypeOf(n);if(null===c)return void 0;t=c,e=r,i=o,s=!0}},a=React.createElement,l=function(t){function e(){s(this,e),o(Object.getPrototypeOf(e.prototype),"constructor",this).apply(this,arguments)}return n(e,t),r(e,[{key:"componentWillMount",value:function(){var t=this.props.doc;t.connect(this,{"document:changed":this.handleDocumentChange})}},{key:"componentWillUnmount",value:function(){var t=this.props.doc;t.disconnect(this)}},{key:"render",value:function(){return a("div",{className:"image",contentEditable:!1,"data-id":this.props.node.id},a("img",{src:this.props.node.src}))}},{key:"handleDocumentChange",value:function(t){t.isAffected([this.props.node.id,"src"])&&this.forceUpdate()}}]),e}(React.Component);l.displayName="ImageComponent",e.exports=l},{}],275:[function(t,e,i){"use strict";function s(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var r=function(){function t(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}return function(e,i,s){return i&&t(e.prototype,i),s&&t(e,s),e}}(),o=function(t,e,i){for(var s=!0;s;){var n=t,r=e,o=i;a=c=l=void 0,s=!1,null===n&&(n=Function.prototype);var a=Object.getOwnPropertyDescriptor(n,r);if(void 0!==a){if("value"in a)return a.value;var l=a.get;return void 0===l?void 0:l.call(o)}var c=Object.getPrototypeOf(n);if(null===c)return void 0;t=c,e=r,i=o,s=!0}},a=(t("substance-ui/text_property"),React.createElement),l=(t("./unsupported_node"),function(t){function e(){s(this,e),o(Object.getPrototypeOf(e.prototype),"constructor",this).apply(this,arguments)}return n(e,t),r(e,[{key:"render",value:function(){var t=this.props.doc,e=t.get(this.props.node.nodeId),i=this.context.componentRegistry,s=i.get(e.type);return s||(console.error("Could not resolve a component for type: "+e.type),s=UnsupporedNode),a(s,{key:e.id,doc:t,node:e})}}]),e}(React.Component));l.displayName="IncludeComponent",l.contextTypes={app:React.PropTypes.object.isRequired,componentRegistry:React.PropTypes.object.isRequired},e.exports=l},{"./unsupported_node":279,"substance-ui/text_property":158}],276:[function(t,e,i){"use strict";e.exports={paragraph:t("./paragraph_component"),heading:t("./heading_component"),image:t("./image_component"),table:t("./table_component"),image_figure:t("./figure_component"),table_figure:t("./figure_component"),bib_item_citation:t("./citation_component"),image_figure_citation:t("./citation_component"),table_figure_citation:t("./citation_component"),include:t("./include_component"),unsupported_node:t("./unsupported_node")}},{"./citation_component":271,"./figure_component":272,"./heading_component":273,"./image_component":274,"./include_component":275,"./paragraph_component":277,"./table_component":278,"./unsupported_node":279}],277:[function(t,e,i){"use strict";function s(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var r=function(){function t(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}return function(e,i,s){return i&&t(e.prototype,i),s&&t(e,s),e}}(),o=function(t,e,i){for(var s=!0;s;){var n=t,r=e,o=i;a=c=l=void 0,s=!1,null===n&&(n=Function.prototype);var a=Object.getOwnPropertyDescriptor(n,r);if(void 0!==a){if("value"in a)return a.value;var l=a.get;return void 0===l?void 0:l.call(o)}var c=Object.getPrototypeOf(n);if(null===c)return void 0;t=c,e=r,i=o,s=!0}},a=t("substance-ui/text_property"),l=React.createElement,c=function(t){function e(){s(this,e),o(Object.getPrototypeOf(e.prototype),"constructor",this).apply(this,arguments)}return n(e,t),r(e,[{key:"render",value:function(){return l("div",{className:"content-node paragraph","data-id":this.props.node.id},l(a,{ref:"textProp",doc:this.props.doc,path:[this.props.node.id,"content"]}))}}]),e}(React.Component);c.displayName="ParagraphComponent",e.exports=c},{"substance-ui/text_property":158}],278:[function(t,e,i){"use strict";function s(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var r=function(){function t(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}return function(e,i,s){return i&&t(e.prototype,i),s&&t(e,s),e}}(),o=function(t,e,i){for(var s=!0;s;){var n=t,r=e,o=i;a=c=l=void 0,s=!1,null===n&&(n=Function.prototype);var a=Object.getOwnPropertyDescriptor(n,r);if(void 0!==a){if("value"in a)return a.value;var l=a.get;return void 0===l?void 0:l.call(o)}var c=Object.getPrototypeOf(n);if(null===c)return void 0;t=c,e=r,i=o,s=!0}},a=t("substance-ui/text_property"),l=React.createElement,c=t("substance/helpers"),u=t("substance"),h=u.Document.TableSelection,p=function(t){function e(t){s(this,e),o(Object.getPrototypeOf(e.prototype),"constructor",this).call(this,t),this.state={mode:"table"},this.onDoubleClick=c.bind(this.onDoubleClick,this),this.onMouseDown=c.bind(this.onMouseDown,this)}return n(e,t),r(e,[{key:"componentDidMount",value:function(){this.context.surface.connect(this,{"selection:changed":this.onSelectionChange});var t=React.findDOMNode(this);$(t).on("mousedown","th,td",this.onMouseDown)}},{key:"componentWillUnmount",value:function(){this.context.surface.disconnect(this)}},{key:"render",value:function(){var t=this.props.node;t.getMatrix();var e=[],i=t.getSections();c.each(i,function(t){var i=[],s=t.getRows();c.each(s,function(t){i.push(this._renderRow(t))},this),e.push(l("t"+t.sectionType,{key:t.id},i))},this);var s=["content-node","table"];"table"===this.state.mode?s.push("table-editing-mode"):"cell"===this.state.mode&&s.push("cell-editing-mode");var n={className:s.join(" "),"data-id":this.props.node.id,contentEditable:!1};return l("table",n,e)}},{key:"_renderRow",value:function(t){var e=this.props.doc,i=[],s=t.getCells();return c.each(s,function(t){var s="head"===t.cellType?"th":"td",n={key:t.id,"data-id":t.id,"data-row":t.rowIdx,"data-col":t.colIdx,onDoubleClick:this.onDoubleClick};t.colspan&&(n.colSpan=t.colspan),t.rowspan&&(n.rowSpan=t.rowspan),"cell"===this.state.mode&&t.rowIdx===this.state.row&&t.colIdx===this.state.col&&(n.contentEditable="true"),i.push(l(s,n,l(a,{key:t.id+".content",doc:e,path:[t.id,"content"]})))},this),l("tr",{key:t.id,"data-id":t.id,contentEditable:!1},i)}},{key:"onDoubleClick",value:function(t){t.preventDefault(),t.stopPropagation();var e=this.context.surface,i=$(t.currentTarget),s=i.data("id");this.setState({mode:"cell",cellId:s,row:i.data("row"),col:i.data("col")},function(){var t=e.getDocument(),i=[s,"content"],n=t.get(i);e.setSelection({type:"property",path:i,startOffset:n.length})})}},{key:"onMouseDown",value:function(t){var e=React.findDOMNode(this),i=$(e),s=this.context.surface,n=s.getDocument(),r=this.props.node.id,o=this,a=$(t.currentTarget);if("cell"!==this.state.mode||this.state.cellId!==a.data("id")){t.preventDefault(),t.stopPropagation();var l=a,c=a,u=new h.Rectangle(l.data("row"),l.data("col"),c.data("row"),c.data("col")),p=function(t){c=$(t.currentTarget),u=new h.Rectangle(l.data("row"),l.data("col"),c.data("row"),c.data("col")),o._updateSelection(u)};i.on("mouseenter","th,td",p),$(window).one("mouseup",function(t){t.stopPropagation(),t.preventDefault(),i.off("mouseenter","th,td",p);var e=n.createSelection({type:"table",tableId:r,rectangle:u});s.setSelection(e)})}}},{key:"onSelectionChange",value:function(t){var e=this.props.node,i=e.id;if(this.hasSelection&&this._clearSelection(),
"cell"===this.state.mode){if(!t.isPropertySelection()||t.start.path[0]!==this.state.cellId){var s=this;this.setState({mode:"table"},function(){t.isTableSelection()&&t.getTableId()===i&&s._updateSelection(t.rectangle)})}}else t.isTableSelection()&&t.getTableId()===i&&this._updateSelection(t.rectangle)}},{key:"_updateSelection",value:function(t){var e=React.findDOMNode(this),i=$(e),s=i.find("th,td");s.each(function(){var e=$(this),i=e.data("row"),s=e.data("col");i>=t.start.row&&i<=t.end.row&&s>=t.start.col&&s<=t.end.col?e.addClass("selected"):e.removeClass("selected")}),this.hasSelection=!0}},{key:"_clearSelection",value:function(){var t=React.findDOMNode(this),e=$(t),i=e.find("th,td");i.removeClass("selected"),this.hasSelection=!1}}]),e}(React.Component);p.displayName="TableComponent",p.contextTypes={surface:React.PropTypes.object.isRequired},e.exports=p},{substance:171,"substance-ui/text_property":158,"substance/helpers":170}],279:[function(t,e,i){"use strict";function s(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var r=function(){function t(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}return function(e,i,s){return i&&t(e.prototype,i),s&&t(e,s),e}}(),o=function(t,e,i){for(var s=!0;s;){var n=t,r=e,o=i;a=c=l=void 0,s=!1,null===n&&(n=Function.prototype);var a=Object.getOwnPropertyDescriptor(n,r);if(void 0!==a){if("value"in a)return a.value;var l=a.get;return void 0===l?void 0:l.call(o)}var c=Object.getPrototypeOf(n);if(null===c)return void 0;t=c,e=r,i=o,s=!0}},a=React.createElement,l=function(t){function e(){s(this,e),o(Object.getPrototypeOf(e.prototype),"constructor",this).apply(this,arguments)}return n(e,t),r(e,[{key:"render",value:function(){var t=JSON.stringify(this.props.node.properties,null,2);return a("pre",{className:"content-node unsupported","data-id":this.props.node.id,contentEditable:!1},t)}}]),e}(React.Component);l.displayName="UnsupportedNodeComponent",e.exports=l},{}],280:[function(t,e,i){"use strict";var s=React.createElement,n=(t("substance/helpers"),React.createClass({displayName:"CiteBibItem",onClick:function(t){t.preventDefault(),t.stopPropagation()},onMouseDown:function(t){t.preventDefault(),this.props.handleSelection(this.props.node.id)},onLabeChanged:function(){this.forceUpdate()},componentWillMount:function(){this.props.node.connect(this,{label:this.onLabeChanged})},componentWillUnmount:function(){this.props.node.disconnect(this)},render:function(){var t=["bib-item border-bottom pad item small clearfix"];this.props.active&&t.push("active");var e=[s("div",{className:"text"},this.props.node.text)];return this.props.node.label&&e.unshift(s("div",{className:"label"},this.props.node.label)),s("div",{className:t.join(" "),onClick:this.onClick,onMouseDown:this.onMouseDown},e)}}));e.exports=n},{"substance/helpers":170}],281:[function(t,e,i){"use strict";var s=React.createElement,n=(t("substance/helpers"),React.createClass({displayName:"CiteImageFigure",onClick:function(t){t.preventDefault(),t.stopPropagation()},onMouseDown:function(t){t.preventDefault(),this.props.handleSelection(this.props.node.id)},render:function(){var t=["figure border-bottom item pad clearfix small"];return this.props.active&&t.push("active"),s("div",{className:t.join(" "),onClick:this.onClick,onMouseDown:this.onMouseDown},s("img",{className:"image",src:this.props.node.getContentNode().src}),s("div",{className:"title"},[this.props.node.label,this.props.node.title].join(" ")),s("div",{className:"caption truncate"},this.props.node.caption))}}));e.exports=n},{"substance/helpers":170}],282:[function(t,e,i){"use strict";var s=React.createElement,n=(t("substance/helpers"),React.createClass({displayName:"CiteTableFigure",onClick:function(t){t.preventDefault(),t.stopPropagation()},onMouseDown:function(t){t.preventDefault(),this.props.handleSelection(this.props.node.id)},render:function(){var t=["figure border-bottom item pad clearfix small"];return this.props.active&&t.push("active"),s("div",{className:t.join(" "),onClick:this.onClick,onMouseDown:this.onMouseDown},s("div",{className:"title"},[this.props.node.label,this.props.node.title].join(" ")),s("div",{className:"caption truncate"},this.props.node.caption))}}));e.exports=n},{"substance/helpers":170}],283:[function(t,e,i){"use strict";function s(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var r=function(){function t(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}return function(e,i,s){return i&&t(e.prototype,i),s&&t(e,s),e}}(),o=function(t,e,i){for(var s=!0;s;){var n=t,r=e,o=i;a=c=l=void 0,s=!1,null===n&&(n=Function.prototype);var a=Object.getOwnPropertyDescriptor(n,r);if(void 0!==a){if("value"in a)return a.value;var l=a.get;return void 0===l?void 0:l.call(o)}var c=Object.getPrototypeOf(n);if(null===c)return void 0;t=c,e=r,i=o,s=!0}},a=React.createElement,l=t("substance/helpers"),c=t("substance-ui/font_awesome_icon"),u=function(t){function e(t){s(this,e),o(Object.getPrototypeOf(e.prototype),"constructor",this).call(this,t)}return n(e,t),r(e,[{key:"handleCancel",value:function(t){var e=this.context.app;t.preventDefault(),e.replaceState({contextId:"toc"})}},{key:"getItems",value:function(t){var e=this.props.doc,i=e.getCollection(t);return i.getItems()}},{key:"stateFromAppState",value:function(){var t=this.context.app;this.state={citationType:t.state.citationType,items:this.getItems(t.state.citationType),citationId:t.state.citationId}}},{key:"componentWillMount",value:function(){if(this.stateFromAppState(),this.tool=this.context.toolRegistry.get("cite"),!this.tool)throw new Error("cite tool not found in registry")}},{key:"componentWillReceiveProps",value:function(){this.stateFromAppState()}},{key:"componentWillUnmount",value:function(){this.tool.disconnect(this)}},{key:"isItemActive",value:function(t){if(!this.state.citationId)return!1;var e=this.props.doc,i=e.get(this.state.citationId);return l.includes(i.targets,t)}},{key:"render",value:function(){var t,e=this,i=this.context.componentRegistry,s=this.state.items;return t=s.length>0?s.map(function(t){var s=i.get("_cite_"+this.state.citationType);return a(s,{key:t.id,node:t,active:this.isItemActive(t.id),handleSelection:e.handleSelection.bind(this)})}.bind(this)):[a("div",{className:"no-results",text:"Nothing to reference."})],a("div",{className:"panel dialog cite-panel-component"},a("div",{className:"dialog-header"},a("a",{href:"#",className:"back",onClick:this.handleCancel.bind(this)},a(c,{icon:"fa-chevron-left"})),a("div",{className:"label"},"Choose referenced items")),a("div",{className:"panel-content"},a("div",{className:"bib-items"},t)))}},{key:"handleSelection",value:function(t){var e=this.state.citationId;this.tool.toggleTarget(e,t),this.forceUpdate()}}]),e}(React.Component);u.contextTypes={app:React.PropTypes.object.isRequired,backend:React.PropTypes.object.isRequired,toolRegistry:React.PropTypes.object.isRequired,componentRegistry:React.PropTypes.object.isRequired},u.displayName="CitePanel",u.icon="fa-bullseye",u.isDialog=!0,e.exports=u},{"substance-ui/font_awesome_icon":153,"substance/helpers":170}],284:[function(t,e,i){"use strict";var s=t("substance-ui/toc_panel"),n=t("./cite_panel"),r=t("./manage_bib_items_panel"),o=t("./_cite_bib_item"),a=t("./_cite_image_figure"),l=t("./_cite_table_figure"),c=t("./manage_collection");e.exports={toc:s,cite:n,cite_bib_item:n,cite_image_figure:n,cite_table_figure:n,_cite_bib_item:o,_cite_image_figure:a,_cite_table_figure:l,manageBibItems:r,manageCollection:c}},{"./_cite_bib_item":280,"./_cite_image_figure":281,"./_cite_table_figure":282,"./cite_panel":283,"./manage_bib_items_panel":285,"./manage_collection":286,"substance-ui/toc_panel":160}],285:[function(t,e,i){"use strict";var s=t("substance"),n=t("substance/helpers"),r=React.createElement,o=t("substance-ui/font_awesome_icon"),a=[{contextId:"list",label:"Manage",icon:"fa-list"},{contextId:"add",label:"Add references",icon:"fa-plus"}],l=React.createClass({displayName:"ListBibItems",contextTypes:{app:React.PropTypes.object.isRequired},handleDeleteBibItem:function(t){t.preventDefault();var e=t.currentTarget.dataset.id,i=this.context.app.doc;i.deleteBibItem(e);var s=i.getBibliography();s.compile();var n=s.getCompiledItems();this.setState({bibItems:n})},getInitialState:function(){var t=this.props.doc,e=t.getBibliography();return e.compile(),{bibItems:e.getCompiledItems()}},render:function(){var t=(this.props.doc,n.map(this.state.bibItems,function(t){return r("div",{className:"csl-entry clearfix border-bottom"},r("div",{className:"csl-left-margin"},t.label),r("button",{"data-id":t.id,className:"button float-right small plain",onClick:this.handleDeleteBibItem},"Delete"),r("div",{className:"csl-right-inline"},t.text))},this));return r("div",{className:"content bib-items"},t)}}),c=React.createClass({displayName:"AddBibItems",contextTypes:{app:React.PropTypes.object.isRequired,bibSearchEngines:React.PropTypes.object.isRequired,surfaceManager:React.PropTypes.object.isRequired},componentDidMount:function(){this.context.surfaceManager.pushState();var t=$(React.findDOMNode(this)).find("input");t.val(this.state.searchResult.searchStr).focus()},componentWillUnmount:function(){this.context.surfaceManager.popState()},getInitialState:function(){return{searchResult:this.props.searchResult,runningQueries:[],addedItems:{}}},onClick:function(t){t.preventDefault();var e=t.currentTarget.dataset.id;this.toggleItem(e)},getBibItemIdByGuid:function(t){return Object.keys(doc.bibItemByGuidIndex.get(t))[0]},toggleItem:function(t){this.getBibItemIdByGuid(t)?this.removeItem(t):this.addItem(t)},getItem:function(t){return n.find(this.state.searchResult.items,function(e){return e.data.DOI===t})},addItem:function(t){var e=(this.state.addedItems,this.context.app,this.getItem(t));doc.transaction({},{},function(t,i){var n={id:s.uuid("bib"),type:"bib_item",source:JSON.stringify(e.data),format:"citeproc"};t.create(n)}),this.forceUpdate()},removeItem:function(t){var e=(this.state.addedItems,this.context.app),i=(e.getSelection(),this.getBibItemIdByGuid(t));doc.transaction({},{},function(t,e){t["delete"](i)}),this.forceUpdate()},render:function(){var t=this.props.doc,e=(t.getCiteprocCompiler(),n.map(this.state.searchResult.items,function(t){var e=t.label,i=this.getBibItemIdByGuid(t.data.DOI),s=t.text;return r("div",{className:"csl-entry clearfix border-bottom"},r("div",{className:"csl-left-margin"},e),r("button",{"data-id":t.data.DOI,className:"button float-right small"+(i?" plain":" loud"),onClick:this.onClick},i?"Remove":"Add"),r("div",{className:"csl-right-inline"},s))},this));return r("div",{className:"content"},r("div",{className:"toolbar tall border-bottom"},r("input",{className:"float-left",type:"text",placeholder:"Enter search term",onKeyPress:this.onKeyPress}),r("button",{className:"button float-right"},"Search")),r("div",{className:"bib-items"},e))},onKeyPress:function(t){13==t.which&&this.startSearch($(t.currentTarget).val())},startSearch:function(t){console.log("Start search",t);var e=this,i=this.props.doc,s=i.getCiteprocCompiler(),r=this.state.runningQueries;n.each(r,function(t){t.reject()}),r=[],n.each(this.context.bibSearchEngines,function(i){var n=i.find(t);n.progress(function(t){console.log("data",t),e.state.searchResult.items.push({data:t,label:"",text:s.renderReference(t)}),e.forceUpdate()}),n.done(function(){var t=r.indexOf(n);t>=0&&r.splice(t,1)}),r.push(n)});var o=this.props.searchResult;o.searchStr=t,o.items=[],this.setState({searchResult:o,runningQueries:r})}}),u=React.createClass({displayName:"ManageBibItemsPanel",getInitialState:function(){return{contextId:"list",searchResult:{query:"",items:[]}}},handleContextSwitch:function(t){t.preventDefault();var e=t.currentTarget.dataset.id;this.setState({contextId:e})},getContextElement:function(){return"list"===this.state.contextId?r(l,{doc:this.props.doc}):r(c,{doc:this.props.doc,searchResult:this.state.searchResult})},render:function(){var t=this.props.doc,e=(t.getCiteprocCompiler(),t.getBibliography(),this.state),i=n.map(a,function(t){var i=["pill"];return t.contextId===e.contextId&&i.push("active"),r("button",{"data-id":t.contextId,className:i.join(" "),onClick:this.handleContextSwitch},r(o,{icon:t.icon})," "+t.label)}.bind(this));return r("div",null,r("div",{className:"header toolbar clearfix menubar fill-light"},r("div",{className:"title float-left large"},"References"),r("div",{className:"menu-group small"},i),r("button",{className:"button close-modal float-right",onClick:this.handleCloseModal},r(o,{icon:"fa-close"}))),this.getContextElement())}});u.contextId="manageBibItems",u.icon="fa-align-left",e.exports=u},{substance:171,"substance-ui/font_awesome_icon":153,"substance/helpers":170}],286:[function(t,e,i){"use strict";function s(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var r=function(){function t(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}return function(e,i,s){return i&&t(e.prototype,i),s&&t(e,s),e}}(),o=function(t,e,i){for(var s=!0;s;){var n=t,r=e,o=i;a=c=l=void 0,s=!1,null===n&&(n=Function.prototype);var a=Object.getOwnPropertyDescriptor(n,r);if(void 0!==a){if("value"in a)return a.value;var l=a.get;return void 0===l?void 0:l.call(o)}var c=Object.getPrototypeOf(n);if(null===c)return void 0;t=c,e=r,i=o,s=!0}},a=t("substance/helpers"),l=React.createElement,c=t("substance-ui/font_awesome_icon"),u=t("substance"),h=u.Surface,p=(h.ContainerEditor,["strong","emphasis","comment"]),f=[],d=function(t){function e(t){s(this,e),o(Object.getPrototypeOf(e.prototype),"constructor",this).call(this,t)}return n(e,t),r(e,[{key:"getChildContext",value:function(){return{surface:this.surface}}},{key:"stateFromAppState",value:function(){var t=this.context.app,e=this.context.app.doc,i=t.state.modal.itemType,s=e.getCollection(i);this.state={itemType:i,collection:s,items:s.getItems()}}},{key:"getPanelLabel",value:function(){var t=this.state.collection;return[this.state.items.length,t.labelPrefix+"s"].join(" ")}},{key:"componentWillMount",value:function(){this.stateFromAppState();var t=this.context.app.doc,e={name:"collection",logger:this.context.notifications};this.surface=new h(this.context.surfaceManager,t,new h.FormEditor,e)}},{key:"componentDidMount",value:function(){var t=this.surface,e=this.context.app;this.context.surfaceManager.pushState(),e.registerSurface(t,{enabledTools:[p]}),t.attach(React.findDOMNode(this.refs.collection));var i=this;this.forceUpdate(function(){i.surface.rerenderDomSelection()})}},{key:"componentDidUpdate",value:function(){var t=this;setTimeout(function(){t.surface.rerenderDomSelection()})}},{key:"componentWillUnmount",value:function(){var t=this.context.app,e=this.surface;t.unregisterSurface(e),e.dispose(),this.context.surfaceManager.popState()}},{key:"handleItemDeletion",value:function(t){console.log("handling item deletion",t)}},{key:"render",value:function(){var t,e=this.state,i=this.context.app.doc,s=a.map(f,function(t){var e=["pill"];return l("button",{"data-id":t.contextId,className:e.join(" "),onClick:this.handleContextSwitch},l(c,{icon:t.icon})," "+t.label)}.bind(this)),n=this.context.componentRegistry,r=n.get(this.state.itemType);return t=e.items.length>0?a.map(e.items,function(t){return l(r,{node:t,key:t.id,doc:i})},this):[l("div",null,"No items found.")],l("div",{className:"manage-collection-component"},l("div",{className:"header toolbar clearfix menubar fill-light"},l("div",{className:"title float-left large"},this.getPanelLabel()),l("div",{className:"menu-group small"},s),l("button",{className:"button close-modal float-right"},l(c,{icon:"fa-close"}))),l("div",{className:"content collection",ref:"collection",contentEditable:!0},t))}}]),e}(React.Component);d.displayName="ManageCollection",d.contextTypes={app:React.PropTypes.object.isRequired,componentRegistry:React.PropTypes.object.isRequired,surfaceManager:React.PropTypes.object.isRequired},d.childContextTypes={surface:React.PropTypes.object},d.contextId="manageCollection",e.exports=d},{substance:171,"substance-ui/font_awesome_icon":153,"substance/helpers":170}],287:[function(t,e,i){"use strict";var s=React.createElement,n=t("substance"),r=t("substance-ui/text_property"),o=n.Surface,a=o.FormEditor,l=React.createClass({displayName:"TitleEditor",contextTypes:{app:React.PropTypes.object.isRequired,surfaceManager:React.PropTypes.object.isRequired},childContextTypes:{surface:React.PropTypes.object},getChildContext:function(){return{surface:this.surface}},componentWillMount:function(){var t=this.props.doc,e=new a;return this.surface=new o(this.context.surfaceManager,t,e,{name:"title"}),{}},componentDidMount:function(){var t=this.context.app;t.registerSurface(this.surface),this.surface.attach(React.findDOMNode(this))},componentWillUnmount:function(){var t=this.context.app;t.unregisterSurface(this.surface),this.surface.detach()},render:function(){var t=this.context.app,e=t.doc,i=e.getDocumentMeta();return s("div",{className:"document-title",contentEditable:!0,"data-id":"title-editor"},s(r,{doc:t.doc,tagName:"div",className:"title",path:[i.id,"title"]}))}});e.exports=l},{substance:171,"substance-ui/text_property":158}],288:[function(t,e,i){"use strict";function s(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var r=function(){function t(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}return function(e,i,s){return i&&t(e.prototype,i),s&&t(e,s),e}}(),o=function(t,e,i){for(var s=!0;s;){var n=t,r=e,o=i;a=c=l=void 0,s=!1,null===n&&(n=Function.prototype);var a=Object.getOwnPropertyDescriptor(n,r);if(void 0!==a){if("value"in a)return a.value;var l=a.get;return void 0===l?void 0:l.call(o)}var c=Object.getPrototypeOf(n);if(null===c)return void 0;t=c,e=r,i=o,s=!0}},a=React.createElement,l=function(t){function e(t){s(this,e),o(Object.getPrototypeOf(e.prototype),"constructor",this).call(this,t),this.state={disabled:!0},this.onMouseDown=this.onMouseDown.bind(this),this.onClick=this.onClick.bind(this)}return n(e,t),r(e,[{key:"componentWillMount",value:function(){if(this.tool=this.context.toolRegistry.get("cite"),!this.tool)throw new Error("No tool registered with name"+toolName);this.tool.connect(this,{"toolstate:changed":this.onToolstateChanged})}},{key:"onToolstateChanged",value:function(t){this.setState({disabled:t.disabled})}},{key:"onClick",value:function(t){t.preventDefault()}},{key:"onMouseDown",value:function(t){if(t.preventDefault(),!this.state.disabled){var e=this.tool.createCitation(this.props.citationType);this.context.app.replaceState({contextId:"cite",citationType:this.props.citationType,citationId:e.id})}}},{key:"shouldComponentUpdate",value:function(t,e){return this.state.disabled!==e.disabled}},{key:"render",value:function(){var t=[];return this.props.classNames&&(t=this.props.classNames.slice()),this.state.disabled&&t.push("disabled"),a("button",{className:t.join(" "),title:this.props.title,onMouseDown:this.onMouseDown,onClick:this.onClick},this.props.children)}}]),e}(React.Component);l.displayName="CiteToolComponent",l.contextTypes={toolRegistry:React.PropTypes.object.isRequired,app:React.PropTypes.object.isRequired},e.exports=l},{}],289:[function(t,e,i){"use strict";var s=React.createElement,n=(t("substance/helpers"),React.createClass({displayName:"NavigateTool",contextTypes:{app:React.PropTypes.object.isRequired},handleClick:function(t){t.preventDefault()},getInitialState:function(){return{disabled:!0}},handleMouseDown:function(t){t.preventDefault(),this.props.replace?this.context.app.replaceState(this.props.newState):this.context.app.setState(this.props.newState)},render:function(){var t=["option"];return s("button",{className:t.join(" "),title:this.props.title,onMouseDown:this.handleMouseDown,onClick:this.handleClick},this.props.title)}}));e.exports=n},{"substance/helpers":170}],290:[function(t,e,i){"use strict";function s(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var r=function(){function t(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}return function(e,i,s){return i&&t(e.prototype,i),s&&t(e,s),e}}(),o=function(t,e,i){for(var s=!0;s;){var n=t,r=e,o=i;a=c=l=void 0,s=!1,null===n&&(n=Function.prototype);var a=Object.getOwnPropertyDescriptor(n,r);if(void 0!==a){if("value"in a)return a.value;var l=a.get;return void 0===l?void 0:l.call(o)}var c=Object.getPrototypeOf(n);if(null===c)return void 0;t=c,e=r,i=o,s=!0}},a=React.createElement,l=t("substance-ui/writer"),c=t("./tools"),u=t("./components"),h=t("./state_handlers"),p=function(t){function e(t){s(this,e),o(Object.getPrototypeOf(e.prototype),"constructor",this).call(this,t),this.state={doc:null}}return n(e,t),r(e,[{key:"componentDidMount",value:function(){var t=this.context.backend;t.getDocument(this.props.documentId||"example_document",function(t,e){e.FORCE_TRANSACTIONS=!0,this.setState({doc:e})}.bind(this))}},{key:"componentWillReceiveProps",value:function(){var t=this.context.backend;this.setState({doc:null}),t.getDocument(this.props.documentId||"example_document",function(t,e){this.setState({doc:e})}.bind(this))}},{key:"render",value:function(){return this.state.doc?a(l,{config:{components:u,tools:c,stateHandlers:h},doc:this.state.doc,id:"writer",contentContainer:"main"}):a("div",null,"")}}]),e}(React.Component);p.displayName="ScienceWriter",p.contextTypes={backend:React.PropTypes.object.isRequired},e.exports=p},{"./components":270,"./state_handlers":291,"./tools":294,"substance-ui/writer":162}],291:[function(t,e,i){"use strict";var s,n=(React.createElement,{handleSelectionChange:function(t,e){var i=t.getSurface();if("main"===i.name&&!e.isNull()&&e.isPropertySelection()&&!e.equals(s)){s=e;var n=t.doc.annotationIndex.get(e.getPath(),e.getStartOffset(),e.getEndOffset(),"citation");if(1===n.length){var r=n[0];if(r.getSelection().equals(e)){var o=r.type.replace("_citation","");return t.replaceState({contextId:"cite_"+o,citationType:o,citationId:r.id}),!0}}"toc"!==t.state.contextId&&t.replaceState({contextId:"toc"})}},getHighlightedNodes:function(t){var e=t.doc,i=t.state,s=[];if(i.citationId){var n=e.get(i.citationId);n&&(s.push(i.citationId),s=s.concat(n.targets))}return s.length>0?s:void 0}});e.exports=n},{}],292:[function(t,e,i){"use strict";var s=t("substance"),n=s.Surface.Tool,r=t("substance/helpers"),o=n.extend({name:"cite",update:function(t,e){if(this.surface=t,!t.isEnabled()||e.isNull()||!e.isPropertySelection())return this.setDisabled();var i={surface:t,sel:e,disabled:!1};this.setToolState(i)},createCitation:function(t){var e,i=this.context.doc,n=i.getSchema().getNodeClass(t)["static"].citationType,r=this.surface,o=r.getEditor();return console.log("citationType",n),r.transaction(function(t,i){var r=i.selection,a=r.start.path,l=r.start.offset;if(!r.isCollapsed){var c=o["delete"](t,i);i.selection=c.selection}return i.text="$",o.insertText(t,i),e=t.create({id:s.uuid(n),type:n,targets:[],path:a,startOffset:l,endOffset:l+1}),e.label="???",i.selection=e.getSelection(),i}),e},toggleTarget:function(t,e){var i=this.context.doc,s=i.get(t),n=s.targets.slice();r.includes(n,e)?n=r.without(n,e):n.push(e),this.surface.transaction(function(t,e){return t.set([s.id,"targets"],n),e})}});e.exports=o},{substance:171,"substance/helpers":170}],293:[function(t,e,i){"use strict";function s(t){t=t.replace(/^\s+|\s+$/g,""),t=t.toLowerCase();for(var e="àáäâèéëêìíïîòóöôùúüûñç·/_,:;",i="aaaaeeeeiiiioooouuuunc------",s=0,n=e.length;n>s;s++)t=t.replace(new RegExp(e.charAt(s),"g"),i.charAt(s));return t=t.replace(/[^a-z0-9 -]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-")}var n=t("substance"),r=n.Surface.Tool,o=r.extend({name:"export",init:function(){this.state.disabled=!1},performAction:function(t){var e=this.context.doc,i=window.document.createElement("a");i.href=window.URL.createObjectURL(new Blob([e.toXml()],{type:"text/xml"})),i.download=s(e.getTitle())+".xml",document.body.appendChild(i),i.click(),document.body.removeChild(i)}});e.exports=o},{substance:171}],294:[function(t,e,i){"use strict";var s=t("substance/helpers"),n=t("substance-ui/writer/tools"),r=t("substance").Surface.Tools;delete n.save,e.exports=s.extend({},n,{"export":t("./export_tool"),text:r.SwitchTextType,emphasis:r.Emphasis,strong:r.Strong,link:r.Link,cite:t("./cite_tool"),insert_figure:t("./insert_figure_tool"),insert_table:t("./insert_table_tool"),insert_columns:r.InsertColumns,delete_columns:r.DeleteColumns,insert_rows:r.InsertRows,delete_rows:r.DeleteRows})},{"./cite_tool":292,"./export_tool":293,"./insert_figure_tool":295,"./insert_table_tool":296,substance:171,"substance-ui/writer/tools":164,"substance/helpers":170}],295:[function(t,e,i){"use strict";var s=t("substance"),n=s.Surface.Tool,r=n.extend({name:"insert_figure",update:function(t,e){if(this.surface=t,!t.isEnabled()||e.isNull()||!e.isPropertySelection())return this.setDisabled();var i={surface:t,sel:e,disabled:!1};this.setToolState(i)},performAction:function(t){var e=this.getToolState();this.context.doc,t.getSelection();if(!e.disabled){var i=e.surface,n=e.surface.$element,r=$('<input type="file" id="file_input" style="opacity: 0;">');n.append(r),r.click(),r.on("change",function(t){var n=r[0].files[0];r.remove(),this.context.backend.uploadFigure(n,function(t,n){var r={selection:e.sel};i.transaction(r,function(t,e){var r=t.create({id:s.uuid("image"),type:"image",src:n,previewSrc:n}),o=t.create({id:s.uuid("image_figure"),type:"image_figure",content:r.id,title:"Enter title",caption:"Enter caption"}),a={id:s.uuid("include"),type:"include",nodeId:o.id},l=i.getEditor();return l.insertNode(t,{selection:e.selection,node:a})})})}.bind(this))}}});e.exports=r},{substance:171}],296:[function(t,e,i){"use strict";var s=t("substance"),n=s.Surface.Tool,r=t("../../lib/article"),o=["<table-figure>","<title>Enter title.</title>","<table>","<thead>","<tr><th>A</th><th>B</th><th>C</th><th>D</th><th>E</th><th>F</th></tr>","</thead>","<tbody>","<tr><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td></tr>","<tr><td>7</td><td>8</td><td>9</td><td>10</td><td>11</td><td>2</td></tr>","<tr><td>13</td><td>14</td><td>15</td><td>16</td><td>17</td><td>18</td></tr>","<tr><td>19</td><td>20</td><td>21</td><td>22</td><td>23</td><td>24</td></tr>","<tr><td>25</td><td>26</td><td>27</td><td>28</td><td>29</td><td>30</td></tr>","</tbody>","</table>","<caption>Enter caption</caption>","</table-figure>"].join(""),a=n.extend({name:"insert_table",update:function(t,e){if(this.surface=t,!t.isEnabled()||e.isNull()||!e.isPropertySelection())return this.setDisabled();var i={surface:t,sel:e,disabled:!1};this.setToolState(i)},performAction:function(t){var e=this.getToolState(),i=t.getSelection();if(!e.disabled){var s=this.surface,n=s.getEditor(),a=new DOMParser,l=a.parseFromString(o,"text/xml"),c=$(l).find("table-figure");s.transaction({selection:i},function(t,e){var i=new r.ArticleHtmlImporter;i.initialize(t,c);var s=i.convertElement(c);return n.insertNode(t,{selection:e.selection,node:s})})}}});e.exports=a},{"../../lib/article":20,substance:171}]},{},[1]);